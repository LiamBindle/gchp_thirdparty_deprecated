!                           DISCLAIMER
!
!   This file was generated by TAF version 1.9.28
!
!   FASTOPT DISCLAIMS  ALL  WARRANTIES,  EXPRESS  OR  IMPLIED,
!   INCLUDING (WITHOUT LIMITATION) ALL IMPLIED  WARRANTIES  OF
!   MERCHANTABILITY  OR FITNESS FOR A PARTICULAR PURPOSE, WITH
!   RESPECT TO THE SOFTWARE AND USER PROGRAMS.   IN  NO  EVENT
!   SHALL  FASTOPT BE LIABLE FOR ANY LOST OR ANTICIPATED PROF-
!   ITS, OR ANY INDIRECT, INCIDENTAL, EXEMPLARY,  SPECIAL,  OR
!   CONSEQUENTIAL  DAMAGES, WHETHER OR NOT FASTOPT WAS ADVISED
!   OF THE POSSIBILITY OF SUCH DAMAGES.
!
!                           Haftungsbeschraenkung
!   FastOpt gibt ausdruecklich keine Gewaehr, explizit oder indirekt,
!   bezueglich der Brauchbarkeit  der Software  fuer einen bestimmten
!   Zweck.   Unter  keinen  Umstaenden   ist  FastOpt   haftbar  fuer
!   irgendeinen Verlust oder nicht eintretenden erwarteten Gewinn und
!   allen indirekten,  zufaelligen,  exemplarischen  oder  speziellen
!   Schaeden  oder  Folgeschaeden  unabhaengig  von einer eventuellen
!   Mitteilung darueber an FastOpt.
!
module     adc_sw_store
!******************************************************************
!******************************************************************
!** This routine was generated by Automatic differentiation.     **
!** FastOpt: Transformation of Algorithm in Fortran, TAF 1.9.50  **
!******************************************************************
!******************************************************************
!==============================================
! all entries are defined explicitly
!==============================================
implicit none

!==============================================
! declare local variables
!==============================================
integer :: tp_csw_c_sw
real, allocatable :: tp_csw_delp_23h(:,:,:)
real, allocatable :: tp_csw_delp_39h(:,:,:)
real, allocatable :: tp_csw_delp_50h(:,:,:)
real, allocatable :: tp_csw_delp_57h(:,:,:)
real, allocatable :: tp_csw_delp_76h(:,:,:)
real, allocatable :: tp_csw_fx1_124h(:,:,:)
real, allocatable :: tp_csw_fx1_61h(:,:,:)
real, allocatable :: tp_csw_fx1_86h(:,:,:)
real, allocatable :: tp_csw_fx2_87h(:,:,:)
real, allocatable :: tp_csw_fx_123h(:,:,:)
real, allocatable :: tp_csw_fx_62h(:,:,:)
real, allocatable :: tp_csw_fx_88h(:,:,:)
real, allocatable :: tp_csw_fy1_121h(:,:,:)
real, allocatable :: tp_csw_fy1_63h(:,:,:)
real, allocatable :: tp_csw_fy_122h(:,:,:)
real, allocatable :: tp_csw_fy_64h(:,:,:)
real, allocatable :: tp_csw_ke_95h(:,:,:)
real, allocatable :: tp_csw_pt_24h(:,:,:)
real, allocatable :: tp_csw_pt_40h(:,:,:)
real, allocatable :: tp_csw_pt_52h(:,:,:)
real, allocatable :: tp_csw_pt_58h(:,:,:)
real, allocatable :: tp_csw_pt_77h(:,:,:)
real, allocatable :: tp_csw_u_115h(:,:,:)
real, allocatable :: tp_csw_ua_11h(:,:,:)
real, allocatable :: tp_csw_ua_96h(:,:,:)
real, allocatable :: tp_csw_uc_111h(:,:,:)
real, allocatable :: tp_csw_ut_27h(:,:,:)
real, allocatable :: tp_csw_ut_35h(:,:,:)
real, allocatable :: tp_csw_v_110h(:,:,:)
real, allocatable :: tp_csw_va_12h(:,:,:)
real, allocatable :: tp_csw_va_97h(:,:,:)
real, allocatable :: tp_csw_vc_116h(:,:,:)
real, allocatable :: tp_csw_vort_98h(:,:,:)
real, allocatable :: tp_csw_vt_18h(:,:,:)
real, allocatable :: tp_csw_vt_81h(:,:,:)
real, allocatable :: tp_csw_w_41h(:,:,:)
real, allocatable :: tp_csw_w_82h(:,:,:)

end module     adc_sw_store


module     add_sw_store
!******************************************************************
!******************************************************************
!** This routine was generated by Automatic differentiation.     **
!** FastOpt: Transformation of Algorithm in Fortran, TAF 1.9.50  **
!******************************************************************
!******************************************************************
!==============================================
! all entries are defined explicitly
!==============================================
implicit none

!==============================================
! declare local variables
!==============================================
real, allocatable :: tp_dsw_crx_adv_150h(:,:,:)
real, allocatable :: tp_dsw_crx_adv_195h(:,:,:)
real, allocatable :: tp_dsw_crx_adv_221h(:,:,:)
real, allocatable :: tp_dsw_crx_adv_332h(:,:,:)
real, allocatable :: tp_dsw_cry_adv_151h(:,:,:)
real, allocatable :: tp_dsw_cry_adv_196h(:,:,:)
real, allocatable :: tp_dsw_cry_adv_222h(:,:,:)
real, allocatable :: tp_dsw_cry_adv_333h(:,:,:)
integer :: tp_dsw_d_sw
real, allocatable :: tp_dsw_delp_149h(:,:,:)
real, allocatable :: tp_dsw_delp_217h(:,:,:)
real, allocatable :: tp_dsw_delp_254h(:,:,:)
real, allocatable :: tp_dsw_delp_255h(:,:,:)
real, allocatable :: tp_dsw_fx_152h(:,:,:)
real, allocatable :: tp_dsw_fx_203h(:,:,:)
real, allocatable :: tp_dsw_fx_229h(:,:,:)
real, allocatable :: tp_dsw_fx_251h(:,:,:)
real, allocatable :: tp_dsw_fx_334h(:,:,:)
real, allocatable :: tp_dsw_fy_153h(:,:,:)
real, allocatable :: tp_dsw_fy_204h(:,:,:)
real, allocatable :: tp_dsw_fy_230h(:,:,:)
real, allocatable :: tp_dsw_fy_252h(:,:,:)
real, allocatable :: tp_dsw_fy_335h(:,:,:)
real, allocatable :: tp_dsw_gy_198h(:,:,:)
real, allocatable :: tp_dsw_gy_224h(:,:,:)
real, allocatable :: tp_dsw_gy_246h(:,:,:)
real, allocatable :: tp_dsw_pt_220h(:,:,:)
real, allocatable :: tp_dsw_pt_253h(:,:,:)
real, allocatable :: tp_dsw_ra_x_156h(:,:,:)
real, allocatable :: tp_dsw_ra_x_201h(:,:,:)
real, allocatable :: tp_dsw_ra_x_227h(:,:,:)
real, allocatable :: tp_dsw_ra_x_338h(:,:,:)
real, allocatable :: tp_dsw_ra_y_157h(:,:,:)
real, allocatable :: tp_dsw_ra_y_202h(:,:,:)
real, allocatable :: tp_dsw_ra_y_228h(:,:,:)
real, allocatable :: tp_dsw_ra_y_339h(:,:,:)
real, allocatable :: tp_dsw_u_287h(:,:,:)
real, allocatable :: tp_dsw_u_303h(:,:,:)
real, allocatable :: tp_dsw_ub_197h(:,:,:)
real, allocatable :: tp_dsw_ub_223h(:,:,:)
real, allocatable :: tp_dsw_ub_245h(:,:,:)
real, allocatable :: tp_dsw_ub_274h(:,:,:)
real, allocatable :: tp_dsw_ub_286h(:,:,:)
real, allocatable :: tp_dsw_ub_295h(:,:,:)
real, allocatable :: tp_dsw_ut_301h(:,:,:)
real, allocatable :: tp_dsw_v_266h(:,:,:)
real, allocatable :: tp_dsw_v_304h(:,:,:)
real, allocatable :: tp_dsw_vb_264h(:,:,:)
real, allocatable :: tp_dsw_vb_273h(:,:,:)
real, allocatable :: tp_dsw_vb_296h(:,:,:)
real, allocatable :: tp_dsw_vort_331h(:,:,:)
real, allocatable :: tp_dsw_vt_302h(:,:,:)
real, allocatable :: tp_dsw_w_194h(:,:,:)
real, allocatable :: tp_dsw_w_216h(:,:,:)
real, allocatable :: tp_dsw_w_256h(:,:,:)
real, allocatable :: tp_dsw_xfx_adv_125h(:,:,:)
real, allocatable :: tp_dsw_xfx_adv_154h(:,:,:)
real, allocatable :: tp_dsw_xfx_adv_199h(:,:,:)
real, allocatable :: tp_dsw_xfx_adv_225h(:,:,:)
real, allocatable :: tp_dsw_xfx_adv_336h(:,:,:)
real, allocatable :: tp_dsw_yfx_adv_134h(:,:,:)
real, allocatable :: tp_dsw_yfx_adv_155h(:,:,:)
real, allocatable :: tp_dsw_yfx_adv_200h(:,:,:)
real, allocatable :: tp_dsw_yfx_adv_226h(:,:,:)
real, allocatable :: tp_dsw_yfx_adv_337h(:,:,:)

end module     add_sw_store

module     adsw_core_mod
!******************************************************************
!******************************************************************
!** This routine was generated by Automatic differentiation.     **
!** FastOpt: Transformation of Algorithm in Fortran, TAF 1.9.30  **
!******************************************************************
!******************************************************************
!==============================================
! referencing used modules
!==============================================
use fv_mp_mod, only : domain,ie,ied,is,isd,je,jed,js,jsd,ng,mp_corner_comm
use fv_grid_tools_mod, only : area,cosa,dx,dxa,dxc,dy,dya,dyc,npx=>npx_g,npy=>npy_g,rarea,rarea_c,rdx,rdxa,rdxc,rdy,rdya,rdyc,sina
use fv_grid_tools_mod, only : grid_type
use tp_core_mod, only : copy_corners, fv_tp_2d, pert_ppm
use fv_grid_utils_mod, only : big_number,cosa_s,cosa_u,cosa_v,da_min_c,ec1,ec2,edge_vect_e,edge_vect_n,edge_vect_s,edge_vect_w,es,&
&ew,f0,fc,gnomonic_grid,ne_corner,nw_corner,rsin2,rsin_u,rsin_v,rsina,se_corner,sina_s,sina_u,sina_v,sw_corner
use sw_core_mod


!==============================================
! all entries are defined explicitly
!==============================================
implicit none

contains
subroutine adc_sw( addelpc, addelp, adptc, adpt, adu, adv, adw, aduc, advc, adua, adva, adwc, adut, advt, dt2, hydrostatic, dord4, &
&taf_rec_npz )
!******************************************************************
!******************************************************************
!** This routine was generated by Automatic differentiation.     **
!** FastOpt: Transformation of Algorithm in Fortran, TAF 1.9.50  **
!******************************************************************
!******************************************************************
!==============================================
! referencing used modules
!==============================================
use adc_sw_store, only : tp_csw_c_sw,tp_csw_delp_23h,tp_csw_delp_39h,tp_csw_delp_50h,tp_csw_delp_57h,tp_csw_delp_76h,&
&tp_csw_fx1_124h,tp_csw_fx1_61h,tp_csw_fx1_86h,tp_csw_fx2_87h,tp_csw_fx_123h,tp_csw_fx_62h,tp_csw_fx_88h,tp_csw_fy1_121h,&
&tp_csw_fy1_63h,tp_csw_fy_122h,tp_csw_fy_64h,tp_csw_ke_95h,tp_csw_pt_24h,tp_csw_pt_40h,tp_csw_pt_52h,tp_csw_pt_58h,tp_csw_pt_77h,&
&tp_csw_u_115h,tp_csw_ua_11h,tp_csw_ua_96h,tp_csw_uc_111h,tp_csw_ut_27h,tp_csw_ut_35h,tp_csw_v_110h,tp_csw_va_12h,tp_csw_va_97h,&
&tp_csw_vc_116h,tp_csw_vort_98h,tp_csw_vt_18h,tp_csw_vt_81h,tp_csw_w_41h,tp_csw_w_82h

!==============================================
! all entries are defined explicitly
!==============================================
implicit none

!==============================================
! declare arguments
!==============================================
real, intent(inout) :: addelp(isd:ied,jsd:jed)
real, intent(inout) :: addelpc(isd:ied,jsd:jed)
real, intent(inout) :: adpt(isd:ied,jsd:jed)
real, intent(inout) :: adptc(isd:ied,jsd:jed)
real, intent(inout) :: adu(isd:ied,jsd:jed+1)
real, intent(inout) :: adua(isd:ied,jsd:jed)
real, intent(inout) :: aduc(isd:ied+1,jsd:jed)
real, intent(inout) :: adut(isd:ied,jsd:jed)
real, intent(inout) :: adv(isd:ied+1,jsd:jed)
real, intent(inout) :: adva(isd:ied,jsd:jed)
real, intent(inout) :: advc(isd:ied,jsd:jed+1)
real, intent(inout) :: advt(isd:ied,jsd:jed)
real, intent(inout) :: adw(isd:ied,jsd:jed)
real, intent(inout) :: adwc(isd:ied,jsd:jed)
logical, intent(in) :: dord4
real, intent(in) :: dt2
logical, intent(in) :: hydrostatic
integer :: taf_rec_npz

!==============================================
! declare local variables
!==============================================
real :: adfx(is-1:ie+2,js-1:je+1)
real :: adfx1(is-1:ie+2,js-1:je+1)
real :: adfx2(is-1:ie+2,js-1:je+1)
real :: adfy(is-1:ie+1,js-1:je+2)
real :: adfy1(is-1:ie+1,js-1:je+2)
real :: adfy2(is-1:ie+1,js-1:je+2)
real :: adke(is-1:ie+1,js-1:je+1)
real :: advort(is-1:ie+1,js-1:je+1)
real :: delp(isd:ied,jsd:jed)
real :: delpc(isd:ied,jsd:jed)
real :: dt4
real :: fx(is-1:ie+2,js-1:je+1)
real :: fx1(is-1:ie+2,js-1:je+1)
real :: fx2(is-1:ie+2,js-1:je+1)
real :: fy(is-1:ie+1,js-1:je+2)
real :: fy1(is-1:ie+1,js-1:je+2)
real :: fy2(is-1:ie+1,js-1:je+2)
integer :: i
integer :: ie1
integer :: iep1
integer :: is2
integer :: j
integer :: jep1
real :: ke(is-1:ie+1,js-1:je+1)
real :: pt(isd:ied,jsd:jed)
real :: u(isd:ied,jsd:jed+1)
real :: ua(isd:ied,jsd:jed)
real :: uc(isd:ied+1,jsd:jed)
real :: ut(isd:ied,jsd:jed)
real :: v(isd:ied+1,jsd:jed)
real :: va(isd:ied,jsd:jed)
real :: vc(isd:ied,jsd:jed+1)
real :: vort(is-1:ie+1,js-1:je+1)
real :: vt(isd:ied,jsd:jed)
real :: w(isd:ied,jsd:jed)

!----------------------------------------------
! RESET LOCAL ADJOINT VARIABLES
!----------------------------------------------
adfx(:,:) = 0.
adfx1(:,:) = 0.
adfx2(:,:) = 0.
adfy(:,:) = 0.
adfy1(:,:) = 0.
adfy2(:,:) = 0.
adke(:,:) = 0.
advort(:,:) = 0.

!----------------------------------------------
! ROUTINE BODY
!----------------------------------------------
iep1 = ie+1
jep1 = je+1
vt = tp_csw_vt_18h(:,:,taf_rec_npz)
do j = js-1, jep1+1
  do i = is-1, iep1
    vt(i,j) = dt2*vt(i,j)*dx(i,j)*sina_v(i,j)
  end do
end do
ke = tp_csw_ke_95h(:,:,taf_rec_npz)
ua = tp_csw_ua_96h(:,:,taf_rec_npz)
va = tp_csw_va_97h(:,:,taf_rec_npz)
vort = tp_csw_vort_98h(:,:,taf_rec_npz)
dt4 = 0.5*dt2
is2 = max(2,is)
ie1 = min(npx-1,ie+1)
v = tp_csw_v_110h(:,:,taf_rec_npz)
uc = tp_csw_uc_111h(:,:,taf_rec_npz)
u = tp_csw_u_115h(:,:,taf_rec_npz)
vc = tp_csw_vc_116h(:,:,taf_rec_npz)
fy1 = tp_csw_fy1_121h(:,:,taf_rec_npz)
fy = tp_csw_fy_122h(:,:,taf_rec_npz)
fx = tp_csw_fx_123h(:,:,taf_rec_npz)
fx1 = tp_csw_fx1_124h(:,:,taf_rec_npz)
do j = js, jep1
  do i = is, ie
    adfx(i,j) = adfx(i,j)-advc(i,j)*fx1(i,j)
    adfx1(i,j) = adfx1(i,j)-advc(i,j)*fx(i,j)
    adke(i,j-1) = adke(i,j-1)+advc(i,j)*rdyc(i,j)
    adke(i,j) = adke(i,j)-advc(i,j)*rdyc(i,j)
  end do
end do
do j = js, je
  do i = is, iep1
    adfy(i,j) = adfy(i,j)+aduc(i,j)*fy1(i,j)
    adfy1(i,j) = adfy1(i,j)+aduc(i,j)*fy(i,j)
    adke(i-1,j) = adke(i-1,j)+aduc(i,j)*rdxc(i,j)
    adke(i,j) = adke(i,j)-aduc(i,j)*rdxc(i,j)
  end do
end do
do j = js, jep1
  if (j .eq. 1 .or. j .eq. npy) then
    do i = is, ie
      fx1(i,j) = dt2*u(i,j)*sina_v(i,j)
      if (fx1(i,j) .gt. 0.) then
        advort(i,j) = advort(i,j)+adfx(i,j)
        adfx(i,j) = 0.
      else
        advort(i+1,j) = advort(i+1,j)+adfx(i,j)
        adfx(i,j) = 0.
      endif
      adu(i,j) = adu(i,j)+adfx1(i,j)*dt2*sina_v(i,j)
      adfx1(i,j) = 0.
    end do
  else
    do i = is, ie
      fx1(i,j) = dt2*(u(i,j)-vc(i,j)*cosa_v(i,j))/sina_v(i,j)
      if (fx1(i,j) .gt. 0.) then
        advort(i,j) = advort(i,j)+adfx(i,j)
        adfx(i,j) = 0.
      else
        advort(i+1,j) = advort(i+1,j)+adfx(i,j)
        adfx(i,j) = 0.
      endif
      adu(i,j) = adu(i,j)+adfx1(i,j)*(dt2/sina_v(i,j))
      advc(i,j) = advc(i,j)-adfx1(i,j)*(dt2*cosa_v(i,j)/sina_v(i,j))
      adfx1(i,j) = 0.
    end do
  endif
end do
do j = js, je
  do i = is, iep1
    if (i .eq. 1 .or. i .eq. npx) then
      fy1(i,j) = dt2*v(i,j)*sina_u(i,j)
    else
      fy1(i,j) = dt2*(v(i,j)-uc(i,j)*cosa_u(i,j))/sina_u(i,j)
    endif
    if (fy1(i,j) .gt. 0.) then
      advort(i,j) = advort(i,j)+adfy(i,j)
      adfy(i,j) = 0.
    else
      advort(i,j+1) = advort(i,j+1)+adfy(i,j)
      adfy(i,j) = 0.
    endif
    if (i .eq. 1 .or. i .eq. npx) then
      adv(i,j) = adv(i,j)+adfy1(i,j)*dt2*sina_u(i,j)
      adfy1(i,j) = 0.
    else
      aduc(i,j) = aduc(i,j)-adfy1(i,j)*(dt2*cosa_u(i,j)/sina_u(i,j))
      adv(i,j) = adv(i,j)+adfy1(i,j)*(dt2/sina_u(i,j))
      adfy1(i,j) = 0.
    endif
  end do
end do
do j = js, je+1
  do i = is, ie+1
    advort(i,j) = advort(i,j)*rarea_c(i,j)
  end do
end do
if (nw_corner) then
  adfy(0,npy) = adfy(0,npy)+advort(1,npy)
endif
if (ne_corner) then
  adfy(npx,npy) = adfy(npx,npy)-advort(npx,npy)
endif
if (se_corner) then
  adfy(npx,1) = adfy(npx,1)-advort(npx,1)
endif
if (sw_corner) then
  adfy(0,1) = adfy(0,1)+advort(1,1)
endif
do j = js, je+1
  do i = is, ie+1
    adfx(i,j-1) = adfx(i,j-1)+advort(i,j)
    adfx(i,j) = adfx(i,j)-advort(i,j)
    adfy(i-1,j) = adfy(i-1,j)-advort(i,j)
    adfy(i,j) = adfy(i,j)+advort(i,j)
    advort(i,j) = 0.
  end do
end do
do j = js, je+1
  if (j .eq. 1 .or. j .eq. npy) then
    do i = is-1, ie+1
      advc(i,j) = advc(i,j)+adfy(i,j)*sina_v(i,j)*dyc(i,j)
      adfy(i,j) = 0.
    end do
  else
    do i = is-1, ie+1
      advc(i,j) = advc(i,j)+adfy(i,j)*dyc(i,j)
      adfy(i,j) = 0.
    end do
  endif
end do
do j = js-1, je+1
  if (ie+1 .eq. npx) then
    aduc(npx,j) = aduc(npx,j)+adfx(npx,j)*sina_u(npx,j)*dxc(npx,j)
    adfx(npx,j) = 0.
  endif
  if (is .eq. 1) then
    aduc(1,j) = aduc(1,j)+adfx(1,j)*sina_u(1,j)*dxc(1,j)
    adfx(1,j) = 0.
  endif
  do i = is2, ie1
    aduc(i,j) = aduc(i,j)+adfx(i,j)*dxc(i,j)
    adfx(i,j) = 0.
  end do
end do
do j = js-1, jep1
  do i = is-1, iep1
    adua(i,j) = adua(i,j)+adke(i,j)*dt4*ke(i,j)
    adva(i,j) = adva(i,j)+adke(i,j)*dt4*vort(i,j)
    advort(i,j) = advort(i,j)+adke(i,j)*dt4*va(i,j)
    adke(i,j) = adke(i,j)*dt4*ua(i,j)
  end do
end do
va = tp_csw_va_12h(:,:,taf_rec_npz)
do j = jep1, js-1, -1
  do i = is-1, iep1
    if (va(i,j) .gt. 0.) then
      if (j .eq. 1) then
        adu(i,1) = adu(i,1)+advort(i,1)*cosa_v(i,1)
        advc(i,1) = advc(i,1)+advort(i,1)*sina_v(i,1)
        advort(i,1) = 0.
      else if (j .eq. npy) then
        adu(i,npy) = adu(i,npy)-advort(i,j)*cosa_v(i,npy)
        advc(i,npy) = advc(i,npy)+advort(i,j)*sina_v(i,npy)
        advort(i,j) = 0.
      else
        advc(i,j) = advc(i,j)+advort(i,j)
        advort(i,j) = 0.
      endif
    else
      if (j .eq. 0) then
        adu(i,1) = adu(i,1)-advort(i,0)*cosa_v(i,1)
        advc(i,1) = advc(i,1)+advort(i,0)*sina_v(i,1)
        advort(i,0) = 0.
      else if (j .eq. npy-1) then
        adu(i,npy) = adu(i,npy)+advort(i,j)*cosa_v(i,npy)
        advc(i,npy) = advc(i,npy)+advort(i,j)*sina_v(i,npy)
        advort(i,j) = 0.
      else
        advc(i,j+1) = advc(i,j+1)+advort(i,j)
        advort(i,j) = 0.
      endif
    endif
  end do
end do
ua = tp_csw_ua_11h(:,:,taf_rec_npz)
do j = js-1, jep1
  do i = iep1, is-1, -1
    if (ua(i,j) .gt. 0.) then
      if (i .eq. 1) then
        aduc(1,j) = aduc(1,j)+adke(1,j)*sina_u(1,j)
        adv(1,j) = adv(1,j)+adke(1,j)*cosa_u(1,j)
        adke(1,j) = 0.
      else if (i .eq. npx) then
        aduc(npx,j) = aduc(npx,j)+adke(i,j)*sina_u(npx,j)
        adv(npx,j) = adv(npx,j)-adke(i,j)*cosa_u(npx,j)
        adke(i,j) = 0.
      else
        aduc(i,j) = aduc(i,j)+adke(i,j)
        adke(i,j) = 0.
      endif
    else
      if (i .eq. 0) then
        aduc(1,j) = aduc(1,j)+adke(0,j)*sina_u(1,j)
        adv(1,j) = adv(1,j)-adke(0,j)*cosa_u(1,j)
        adke(0,j) = 0.
      else if (i .eq. npx-1) then
        aduc(npx,j) = aduc(npx,j)+adke(i,j)*sina_u(npx,j)
        adv(npx,j) = adv(npx,j)+adke(i,j)*cosa_u(npx,j)
        adke(i,j) = 0.
      else
        aduc(i+1,j) = aduc(i+1,j)+adke(i,j)
        adke(i,j) = 0.
      endif
    endif
  end do
end do
if (hydrostatic) then
  delp = tp_csw_delp_57h(:,:,taf_rec_npz)
  pt = tp_csw_pt_58h(:,:,taf_rec_npz)
  fx1 = tp_csw_fx1_61h(:,:,taf_rec_npz)
  fx = tp_csw_fx_62h(:,:,taf_rec_npz)
  fy1 = tp_csw_fy1_63h(:,:,taf_rec_npz)
  fy = tp_csw_fy_64h(:,:,taf_rec_npz)
  do j = js-1, jep1
    do i = is-1, iep1
      delpc(i,j) = delp(i,j)+(fx1(i,j)-fx1(i+1,j)+fy1(i,j)-fy1(i,j+1))*rarea(i,j)
      addelp(i,j) = addelp(i,j)+adptc(i,j)*(pt(i,j)/delpc(i,j))
      addelpc(i,j) = addelpc(i,j)-adptc(i,j)*((pt(i,j)*delp(i,j)+(fx(i,j)-fx(i+1,j)+fy(i,j)-fy(i,j+1))*rarea(i,j))/(delpc(i,j)*&
&delpc(i,j)))
      adfx(i+1,j) = adfx(i+1,j)-adptc(i,j)*(rarea(i,j)/delpc(i,j))
      adfx(i,j) = adfx(i,j)+adptc(i,j)*(rarea(i,j)/delpc(i,j))
      adfy(i,j+1) = adfy(i,j+1)-adptc(i,j)*(rarea(i,j)/delpc(i,j))
      adfy(i,j) = adfy(i,j)+adptc(i,j)*(rarea(i,j)/delpc(i,j))
      adpt(i,j) = adpt(i,j)+adptc(i,j)*(delp(i,j)/delpc(i,j))
      adptc(i,j) = 0.
      addelp(i,j) = addelp(i,j)+addelpc(i,j)
      adfx1(i+1,j) = adfx1(i+1,j)-addelpc(i,j)*rarea(i,j)
      adfx1(i,j) = adfx1(i,j)+addelpc(i,j)*rarea(i,j)
      adfy1(i,j+1) = adfy1(i,j+1)-addelpc(i,j)*rarea(i,j)
      adfy1(i,j) = adfy1(i,j)+addelpc(i,j)*rarea(i,j)
      addelpc(i,j) = 0.
    end do
  end do
  delp = tp_csw_delp_50h(:,:,taf_rec_npz)
  pt = tp_csw_pt_52h(:,:,taf_rec_npz)
  do j = js-1, jep1+1
    do i = is-1, iep1
      if (vt(i,j) .gt. 0.) then
        fy1(i,j) = delp(i,j-1)
        fy(i,j) = pt(i,j-1)
      else
        fy1(i,j) = delp(i,j)
        fy(i,j) = pt(i,j)
      endif
      fy1(i,j) = vt(i,j)*fy1(i,j)
      adfy1(i,j) = adfy1(i,j)+adfy(i,j)*fy(i,j)
      adfy(i,j) = adfy(i,j)*fy1(i,j)
      if (vt(i,j) .gt. 0.) then
        fy1(i,j) = delp(i,j-1)
      else
        fy1(i,j) = delp(i,j)
      endif
      advt(i,j) = advt(i,j)+adfy1(i,j)*fy1(i,j)
      adfy1(i,j) = adfy1(i,j)*vt(i,j)
      if (vt(i,j) .gt. 0.) then
        adpt(i,j-1) = adpt(i,j-1)+adfy(i,j)
        adfy(i,j) = 0.
        addelp(i,j-1) = addelp(i,j-1)+adfy1(i,j)
        adfy1(i,j) = 0.
      else
        adpt(i,j) = adpt(i,j)+adfy(i,j)
        adfy(i,j) = 0.
        addelp(i,j) = addelp(i,j)+adfy1(i,j)
        adfy1(i,j) = 0.
      endif
    end do
  end do
else
  delp = tp_csw_delp_76h(:,:,taf_rec_npz)
  pt = tp_csw_pt_77h(:,:,taf_rec_npz)
  vt = tp_csw_vt_81h(:,:,taf_rec_npz)
  w = tp_csw_w_82h(:,:,taf_rec_npz)
  fx1 = tp_csw_fx1_86h(:,:,taf_rec_npz)
  fx2 = tp_csw_fx2_87h(:,:,taf_rec_npz)
  fx = tp_csw_fx_88h(:,:,taf_rec_npz)
  do j = js-1, je+2
    do i = is-1, ie+1
      if (vt(i,j) .gt. 0.) then
        fy1(i,j) = delp(i,j-1)
        fy(i,j) = pt(i,j-1)
        fy2(i,j) = w(i,j-1)
      else
        fy1(i,j) = delp(i,j)
        fy(i,j) = pt(i,j)
        fy2(i,j) = w(i,j)
      endif
      fy1(i,j) = vt(i,j)*fy1(i,j)
      fy(i,j) = fy1(i,j)*fy(i,j)
      fy2(i,j) = fy1(i,j)*fy2(i,j)
    end do
  end do
  do j = js-1, je+1
    do i = is-1, ie+1
      delpc(i,j) = delp(i,j)+(fx1(i,j)-fx1(i+1,j)+fy1(i,j)-fy1(i,j+1))*rarea(i,j)
      addelp(i,j) = addelp(i,j)+adwc(i,j)*(w(i,j)/delpc(i,j))
      addelpc(i,j) = addelpc(i,j)-adwc(i,j)*((w(i,j)*delp(i,j)+(fx2(i,j)-fx2(i+1,j)+fy2(i,j)-fy2(i,j+1))*rarea(i,j))/(delpc(i,j)*&
&delpc(i,j)))
      adfx2(i+1,j) = adfx2(i+1,j)-adwc(i,j)*(rarea(i,j)/delpc(i,j))
      adfx2(i,j) = adfx2(i,j)+adwc(i,j)*(rarea(i,j)/delpc(i,j))
      adfy2(i,j+1) = adfy2(i,j+1)-adwc(i,j)*(rarea(i,j)/delpc(i,j))
      adfy2(i,j) = adfy2(i,j)+adwc(i,j)*(rarea(i,j)/delpc(i,j))
      adw(i,j) = adw(i,j)+adwc(i,j)*(delp(i,j)/delpc(i,j))
      adwc(i,j) = 0.
      addelp(i,j) = addelp(i,j)+adptc(i,j)*(pt(i,j)/delpc(i,j))
      addelpc(i,j) = addelpc(i,j)-adptc(i,j)*((pt(i,j)*delp(i,j)+(fx(i,j)-fx(i+1,j)+fy(i,j)-fy(i,j+1))*rarea(i,j))/(delpc(i,j)*&
&delpc(i,j)))
      adfx(i+1,j) = adfx(i+1,j)-adptc(i,j)*(rarea(i,j)/delpc(i,j))
      adfx(i,j) = adfx(i,j)+adptc(i,j)*(rarea(i,j)/delpc(i,j))
      adfy(i,j+1) = adfy(i,j+1)-adptc(i,j)*(rarea(i,j)/delpc(i,j))
      adfy(i,j) = adfy(i,j)+adptc(i,j)*(rarea(i,j)/delpc(i,j))
      adpt(i,j) = adpt(i,j)+adptc(i,j)*(delp(i,j)/delpc(i,j))
      adptc(i,j) = 0.
      addelp(i,j) = addelp(i,j)+addelpc(i,j)
      adfx1(i+1,j) = adfx1(i+1,j)-addelpc(i,j)*rarea(i,j)
      adfx1(i,j) = adfx1(i,j)+addelpc(i,j)*rarea(i,j)
      adfy1(i,j+1) = adfy1(i,j+1)-addelpc(i,j)*rarea(i,j)
      adfy1(i,j) = adfy1(i,j)+addelpc(i,j)*rarea(i,j)
      addelpc(i,j) = 0.
    end do
  end do
  do j = js-1, je+2
    do i = is-1, ie+1
      if (vt(i,j) .gt. 0.) then
        fy1(i,j) = delp(i,j-1)
        fy(i,j) = pt(i,j-1)
        fy2(i,j) = w(i,j-1)
      else
        fy1(i,j) = delp(i,j)
        fy(i,j) = pt(i,j)
        fy2(i,j) = w(i,j)
      endif
      fy1(i,j) = vt(i,j)*fy1(i,j)
      adfy1(i,j) = adfy1(i,j)+adfy2(i,j)*fy2(i,j)
      adfy2(i,j) = adfy2(i,j)*fy1(i,j)
      adfy1(i,j) = adfy1(i,j)+adfy(i,j)*fy(i,j)
      adfy(i,j) = adfy(i,j)*fy1(i,j)
      if (vt(i,j) .gt. 0.) then
        fy1(i,j) = delp(i,j-1)
      else
        fy1(i,j) = delp(i,j)
      endif
      advt(i,j) = advt(i,j)+adfy1(i,j)*fy1(i,j)
      adfy1(i,j) = adfy1(i,j)*vt(i,j)
      if (vt(i,j) .gt. 0.) then
        adw(i,j-1) = adw(i,j-1)+adfy2(i,j)
        adfy2(i,j) = 0.
        adpt(i,j-1) = adpt(i,j-1)+adfy(i,j)
        adfy(i,j) = 0.
        addelp(i,j-1) = addelp(i,j-1)+adfy1(i,j)
        adfy1(i,j) = 0.
      else
        adw(i,j) = adw(i,j)+adfy2(i,j)
        adfy2(i,j) = 0.
        adpt(i,j) = adpt(i,j)+adfy(i,j)
        adfy(i,j) = 0.
        addelp(i,j) = addelp(i,j)+adfy1(i,j)
        adfy1(i,j) = 0.
      endif
    end do
  end do
  if (grid_type .lt. 3) then
    call adfill_4corners( adw,2 )
  endif
endif
if (grid_type .lt. 3) then
  call adfill2_4corners( addelp,adpt,2 )
endif
if (hydrostatic) then
  delp = tp_csw_delp_23h(:,:,taf_rec_npz)
  pt = tp_csw_pt_24h(:,:,taf_rec_npz)
  ut = tp_csw_ut_27h(:,:,taf_rec_npz)
  do j = js-1, jep1
    do i = is-1, iep1+1
      if (ut(i,j) .gt. 0.) then
        fx1(i,j) = delp(i-1,j)
        fx(i,j) = pt(i-1,j)
      else
        fx1(i,j) = delp(i,j)
        fx(i,j) = pt(i,j)
      endif
      fx1(i,j) = ut(i,j)*fx1(i,j)
      adfx1(i,j) = adfx1(i,j)+adfx(i,j)*fx(i,j)
      adfx(i,j) = adfx(i,j)*fx1(i,j)
      if (ut(i,j) .gt. 0.) then
        fx1(i,j) = delp(i-1,j)
      else
        fx1(i,j) = delp(i,j)
      endif
      adut(i,j) = adut(i,j)+adfx1(i,j)*fx1(i,j)
      adfx1(i,j) = adfx1(i,j)*ut(i,j)
      if (ut(i,j) .gt. 0.) then
        adpt(i-1,j) = adpt(i-1,j)+adfx(i,j)
        adfx(i,j) = 0.
        addelp(i-1,j) = addelp(i-1,j)+adfx1(i,j)
        adfx1(i,j) = 0.
      else
        adpt(i,j) = adpt(i,j)+adfx(i,j)
        adfx(i,j) = 0.
        addelp(i,j) = addelp(i,j)+adfx1(i,j)
        adfx1(i,j) = 0.
      endif
    end do
  end do
else
  ut = tp_csw_ut_35h(:,:,taf_rec_npz)
  delp = tp_csw_delp_39h(:,:,taf_rec_npz)
  pt = tp_csw_pt_40h(:,:,taf_rec_npz)
  w = tp_csw_w_41h(:,:,taf_rec_npz)
  do j = js-1, je+1
    do i = is-1, ie+2
      if (ut(i,j) .gt. 0.) then
        fx1(i,j) = delp(i-1,j)
        fx(i,j) = pt(i-1,j)
        fx2(i,j) = w(i-1,j)
      else
        fx1(i,j) = delp(i,j)
        fx(i,j) = pt(i,j)
        fx2(i,j) = w(i,j)
      endif
      fx1(i,j) = ut(i,j)*fx1(i,j)
      adfx1(i,j) = adfx1(i,j)+adfx2(i,j)*fx2(i,j)
      adfx2(i,j) = adfx2(i,j)*fx1(i,j)
      adfx1(i,j) = adfx1(i,j)+adfx(i,j)*fx(i,j)
      adfx(i,j) = adfx(i,j)*fx1(i,j)
      if (ut(i,j) .gt. 0.) then
        fx1(i,j) = delp(i-1,j)
      else
        fx1(i,j) = delp(i,j)
      endif
      adut(i,j) = adut(i,j)+adfx1(i,j)*fx1(i,j)
      adfx1(i,j) = adfx1(i,j)*ut(i,j)
      if (ut(i,j) .gt. 0.) then
        adw(i-1,j) = adw(i-1,j)+adfx2(i,j)
        adfx2(i,j) = 0.
        adpt(i-1,j) = adpt(i-1,j)+adfx(i,j)
        adfx(i,j) = 0.
        addelp(i-1,j) = addelp(i-1,j)+adfx1(i,j)
        adfx1(i,j) = 0.
      else
        adw(i,j) = adw(i,j)+adfx2(i,j)
        adfx2(i,j) = 0.
        adpt(i,j) = adpt(i,j)+adfx(i,j)
        adfx(i,j) = 0.
        addelp(i,j) = addelp(i,j)+adfx1(i,j)
        adfx1(i,j) = 0.
      endif
    end do
  end do
  if (grid_type .lt. 3) then
    call adfill_4corners( adw,1 )
  endif
endif
if (grid_type .lt. 3) then
  call adfill2_4corners( addelp,adpt,1 )
endif
do j = js-1, jep1+1
  do i = is-1, iep1
    advt(i,j) = advt(i,j)*dt2*dx(i,j)*sina_v(i,j)
  end do
end do
do j = js-1, jep1
  do i = is-1, iep1+1
    adut(i,j) = adut(i,j)*dt2*dy(i,j)*sina_u(i,j)
  end do
end do
call add2a2c_vect( adu,adv,adua,adva,aduc,advc,adut,advt,dord4 )

end subroutine adc_sw


subroutine add2a2c_vect( adu, adv, adua, adva, aduc, advc, adut, advt, dord4 )
!******************************************************************
!******************************************************************
!** This routine was generated by Automatic differentiation.     **
!** FastOpt: Transformation of Algorithm in Fortran, TAF 1.9.50  **
!******************************************************************
!******************************************************************
!==============================================
! all entries are defined explicitly
!==============================================
implicit none

!==============================================
! declare parameters
!==============================================
real, parameter :: a1 = 0.5625
real, parameter :: a2 = -0.0625
real, parameter :: b1 = 7./12.
real, parameter :: b2 = -(1./12.)
real, parameter :: c1 = -0.125
real, parameter :: c2 = 0.75
real, parameter :: c3 = 0.375
real, parameter :: t12 = -(13./28.)
real, parameter :: t14 = 6./7.
real, parameter :: t15 = 3./28.

!==============================================
! declare arguments
!==============================================
real, intent(inout) :: adu(isd:ied,jsd:jed+1)
real, intent(inout) :: adua(isd:ied,jsd:jed)
real, intent(inout) :: aduc(isd:ied+1,jsd:jed)
real, intent(inout) :: adut(isd:ied,jsd:jed)
real, intent(inout) :: adv(isd:ied+1,jsd:jed)
real, intent(inout) :: adva(isd:ied,jsd:jed)
real, intent(inout) :: advc(isd:ied,jsd:jed+1)
real, intent(inout) :: advt(isd:ied,jsd:jed)
logical, intent(in) :: dord4

!==============================================
! declare local variables
!==============================================
real :: adutmp(isd:ied,jsd:jed)
real :: advtmp(isd:ied,jsd:jed)
integer :: i
integer :: id
integer :: ifirst
integer :: ilast
integer :: j
integer :: npt

!----------------------------------------------
! RESET LOCAL ADJOINT VARIABLES
!----------------------------------------------
adutmp(:,:) = 0.
advtmp(:,:) = 0.

!----------------------------------------------
! ROUTINE BODY
!----------------------------------------------
if (dord4) then
  id = 1
else
  id = 0
endif
if (grid_type .lt. 3) then
  npt = 4
else
  npt = -2
endif
if (grid_type .lt. 3) then
  ifirst = max(3,is-1)
  ilast = min(npx-2,ie+2)
else
  ifirst = is-1
  ilast = ie+2
endif
if (grid_type .lt. 3) then
  do j = je+2, js-1, -1
    if (j .eq. 1) then
      do i = is-1, ie+1
        advc(i,1) = advc(i,1)+advt(i,1)*rsin_v(i,1)
        advt(i,1) = 0.
        advtmp(i,-2) = advtmp(i,-2)+advc(i,1)*t15*rsin_v(i,1)
        advtmp(i,-1) = advtmp(i,-1)+advc(i,1)*t12*rsin_v(i,1)
        advtmp(i,3) = advtmp(i,3)+advc(i,1)*t15*rsin_v(i,1)
        advtmp(i,2) = advtmp(i,2)+advc(i,1)*t12*rsin_v(i,1)
        advtmp(i,1) = advtmp(i,1)+advc(i,1)*t14*rsin_v(i,1)
        advtmp(i,0) = advtmp(i,0)+advc(i,1)*t14*rsin_v(i,1)
        advc(i,1) = 0.
      end do
    else if (j .eq. 0 .or. j .eq. npy-1) then
      do i = is-1, ie+1
        adu(i,j) = adu(i,j)-advt(i,j)*cosa_v(i,j)*rsin_v(i,j)
        advc(i,j) = advc(i,j)+advt(i,j)*rsin_v(i,j)
        advt(i,j) = 0.
        advtmp(i,j-2) = advtmp(i,j-2)+advc(i,j)*c1
        advtmp(i,j-1) = advtmp(i,j-1)+advc(i,j)*c2
        advtmp(i,j) = advtmp(i,j)+advc(i,j)*c3
        advc(i,j) = 0.
      end do
    else if (j .eq. 2 .or. j .eq. npy+1) then
      do i = is-1, ie+1
        adu(i,j) = adu(i,j)-advt(i,j)*cosa_v(i,j)*rsin_v(i,j)
        advc(i,j) = advc(i,j)+advt(i,j)*rsin_v(i,j)
        advt(i,j) = 0.
        advtmp(i,j-1) = advtmp(i,j-1)+advc(i,j)*c3
        advtmp(i,j+1) = advtmp(i,j+1)+advc(i,j)*c1
        advtmp(i,j) = advtmp(i,j)+advc(i,j)*c2
        advc(i,j) = 0.
      end do
    else if (j .eq. npy) then
      do i = is-1, ie+1
        advc(i,npy) = advc(i,npy)+advt(i,npy)*rsin_v(i,npy)
        advt(i,npy) = 0.
        advtmp(i,npy-3) = advtmp(i,npy-3)+advc(i,npy)*t15*rsin_v(i,npy)
        advtmp(i,npy-2) = advtmp(i,npy-2)+advc(i,npy)*t12*rsin_v(i,npy)
        advtmp(i,npy-1) = advtmp(i,npy-1)+advc(i,npy)*t14*rsin_v(i,npy)
        advtmp(i,npy+2) = advtmp(i,npy+2)+advc(i,npy)*t15*rsin_v(i,npy)
        advtmp(i,npy+1) = advtmp(i,npy+1)+advc(i,npy)*t12*rsin_v(i,npy)
        advtmp(i,npy) = advtmp(i,npy)+advc(i,npy)*t14*rsin_v(i,npy)
        advc(i,npy) = 0.
      end do
    else
      do i = is-1, ie+1
        adu(i,j) = adu(i,j)-advt(i,j)*cosa_v(i,j)*rsin_v(i,j)
        advc(i,j) = advc(i,j)+advt(i,j)*rsin_v(i,j)
        advt(i,j) = 0.
        advtmp(i,j-2) = advtmp(i,j-2)+advc(i,j)*a2
        advtmp(i,j-1) = advtmp(i,j-1)+advc(i,j)*a1
        advtmp(i,j+1) = advtmp(i,j+1)+advc(i,j)*a2
        advtmp(i,j) = advtmp(i,j)+advc(i,j)*a1
        advc(i,j) = 0.
      end do
    endif
  end do
else
  do j = js-1, je+2
    do i = is-1, ie+1
      advc(i,j) = advc(i,j)+advt(i,j)
      advt(i,j) = 0.
      advtmp(i,j-2) = advtmp(i,j-2)+advc(i,j)*b2
      advtmp(i,j-1) = advtmp(i,j-1)+advc(i,j)*b1
      advtmp(i,j+1) = advtmp(i,j+1)+advc(i,j)*b2
      advtmp(i,j) = advtmp(i,j)+advc(i,j)*b1
      advc(i,j) = 0.
    end do
  end do
endif
if (ne_corner) then
  do j = 0, 2
    adutmp(ie-j,npy) = adutmp(ie-j,npy)-advtmp(npx,npy+j)
    advtmp(npx,npy+j) = 0.
  end do
endif
if (se_corner) then
  do j = -2, 0
    adutmp(ie+j,0) = adutmp(ie+j,0)+advtmp(npx,j)
    advtmp(npx,j) = 0.
  end do
endif
if (nw_corner) then
  do j = 0, 2
    adutmp(j+1,npy) = adutmp(j+1,npy)+advtmp(0,npy+j)
    advtmp(0,npy+j) = 0.
  end do
endif
if (sw_corner) then
  do j = -2, 0
    adutmp(1-j,0) = adutmp(1-j,0)-advtmp(0,j)
    advtmp(0,j) = 0.
  end do
endif
if (grid_type .lt. 3) then
  if (ie+1 .eq. npx) then
    do j = js-1, je+1
      aduc(npx+1,j) = aduc(npx+1,j)+adut(npx+1,j)*rsin_u(npx+1,j)
      adv(npx+1,j) = adv(npx+1,j)-adut(npx+1,j)*cosa_u(npx+1,j)*rsin_u(npx+1,j)
      adut(npx+1,j) = 0.
      aduc(npx,j) = aduc(npx,j)+adut(npx,j)*rsin_u(npx,j)
      adut(npx,j) = 0.
      aduc(npx-1,j) = aduc(npx-1,j)+adut(npx-1,j)*rsin_u(npx-1,j)
      adv(npx-1,j) = adv(npx-1,j)-adut(npx-1,j)*cosa_u(npx-1,j)*rsin_u(npx-1,j)
      adut(npx-1,j) = 0.
      adutmp(npx+2,j) = adutmp(npx+2,j)+aduc(npx+1,j)*c1
      adutmp(npx+1,j) = adutmp(npx+1,j)+aduc(npx+1,j)*c2
      adutmp(npx,j) = adutmp(npx,j)+aduc(npx+1,j)*c3
      aduc(npx+1,j) = 0.
      adutmp(npx-3,j) = adutmp(npx-3,j)+aduc(npx,j)*t15*rsin_u(npx,j)
      adutmp(npx-2,j) = adutmp(npx-2,j)+aduc(npx,j)*t12*rsin_u(npx,j)
      adutmp(npx-1,j) = adutmp(npx-1,j)+aduc(npx,j)*t14*rsin_u(npx,j)
      adutmp(npx+2,j) = adutmp(npx+2,j)+aduc(npx,j)*t15*rsin_u(npx,j)
      adutmp(npx+1,j) = adutmp(npx+1,j)+aduc(npx,j)*t12*rsin_u(npx,j)
      adutmp(npx,j) = adutmp(npx,j)+aduc(npx,j)*t14*rsin_u(npx,j)
      aduc(npx,j) = 0.
      adutmp(npx-3,j) = adutmp(npx-3,j)+aduc(npx-1,j)*c1
      adutmp(npx-2,j) = adutmp(npx-2,j)+aduc(npx-1,j)*c2
      adutmp(npx-1,j) = adutmp(npx-1,j)+aduc(npx-1,j)*c3
      aduc(npx-1,j) = 0.
    end do
  endif
  if (is .eq. 1) then
    do j = js-1, je+1
      aduc(2,j) = aduc(2,j)+adut(2,j)*rsin_u(2,j)
      adv(2,j) = adv(2,j)-adut(2,j)*cosa_u(2,j)*rsin_u(2,j)
      adut(2,j) = 0.
      aduc(1,j) = aduc(1,j)+adut(1,j)*rsin_u(1,j)
      adut(1,j) = 0.
      aduc(0,j) = aduc(0,j)+adut(0,j)*rsin_u(0,j)
      adv(0,j) = adv(0,j)-adut(0,j)*cosa_u(0,j)*rsin_u(0,j)
      adut(0,j) = 0.
      adutmp(3,j) = adutmp(3,j)+aduc(2,j)*c1
      adutmp(2,j) = adutmp(2,j)+aduc(2,j)*c2
      adutmp(1,j) = adutmp(1,j)+aduc(2,j)*c3
      aduc(2,j) = 0.
      adutmp(-2,j) = adutmp(-2,j)+aduc(1,j)*t15*rsin_u(1,j)
      adutmp(-1,j) = adutmp(-1,j)+aduc(1,j)*t12*rsin_u(1,j)
      adutmp(3,j) = adutmp(3,j)+aduc(1,j)*t15*rsin_u(1,j)
      adutmp(2,j) = adutmp(2,j)+aduc(1,j)*t12*rsin_u(1,j)
      adutmp(1,j) = adutmp(1,j)+aduc(1,j)*t14*rsin_u(1,j)
      adutmp(0,j) = adutmp(0,j)+aduc(1,j)*t14*rsin_u(1,j)
      aduc(1,j) = 0.
      adutmp(-2,j) = adutmp(-2,j)+aduc(0,j)*c1
      adutmp(-1,j) = adutmp(-1,j)+aduc(0,j)*c2
      adutmp(0,j) = adutmp(0,j)+aduc(0,j)*c3
      aduc(0,j) = 0.
    end do
  endif
endif
do j = js-1, je+1
  do i = ifirst, ilast
    aduc(i,j) = aduc(i,j)+adut(i,j)*rsin_u(i,j)
    adv(i,j) = adv(i,j)-adut(i,j)*cosa_u(i,j)*rsin_u(i,j)
    adut(i,j) = 0.
    adutmp(i-2,j) = adutmp(i-2,j)+aduc(i,j)*a2
    adutmp(i-1,j) = adutmp(i-1,j)+aduc(i,j)*a1
    adutmp(i+1,j) = adutmp(i+1,j)+aduc(i,j)*a2
    adutmp(i,j) = adutmp(i,j)+aduc(i,j)*a1
    aduc(i,j) = 0.
  end do
end do
if (nw_corner) then
  do i = -2, 0
    advtmp(0,je+i) = advtmp(0,je+i)+adutmp(i,npy)
    adutmp(i,npy) = 0.
  end do
endif
if (ne_corner) then
  do i = 0, 2
    advtmp(npx,je-i) = advtmp(npx,je-i)-adutmp(npx+i,npy)
    adutmp(npx+i,npy) = 0.
  end do
endif
if (se_corner) then
  do i = 0, 2
    advtmp(npx,i+1) = advtmp(npx,i+1)+adutmp(npx+i,0)
    adutmp(npx+i,0) = 0.
  end do
endif
if (sw_corner) then
  do i = -2, 0
    advtmp(0,1-i) = advtmp(0,1-i)-adutmp(i,0)
    adutmp(i,0) = 0.
  end do
endif
do j = js-1-id, je+1+id
  do i = is-1-id, ie+1+id
    adutmp(i,j) = adutmp(i,j)-adva(i,j)*cosa_s(i,j)*rsin2(i,j)
    advtmp(i,j) = advtmp(i,j)+adva(i,j)*rsin2(i,j)
    adva(i,j) = 0.
    adutmp(i,j) = adutmp(i,j)+adua(i,j)*rsin2(i,j)
    advtmp(i,j) = advtmp(i,j)-adua(i,j)*cosa_s(i,j)*rsin2(i,j)
    adua(i,j) = 0.
  end do
end do
if (grid_type .lt. 3) then
  if (ie+1 .eq. npx .or. ied .ge. npx-npt) then
    do j = max(npt,jsd), min(npy-npt,jed)
      do i = npx-npt+1, ied
        adv(i+1,j) = adv(i+1,j)+0.5*advtmp(i,j)
        adv(i,j) = adv(i,j)+0.5*advtmp(i,j)
        advtmp(i,j) = 0.
        adu(i,j+1) = adu(i,j+1)+0.5*adutmp(i,j)
        adu(i,j) = adu(i,j)+0.5*adutmp(i,j)
        adutmp(i,j) = 0.
      end do
    end do
  endif
  if (is .eq. 1 .or. isd .lt. npt) then
    do j = max(npt,jsd), min(npy-npt,jed)
      do i = isd, npt-1
        adv(i+1,j) = adv(i+1,j)+0.5*advtmp(i,j)
        adv(i,j) = adv(i,j)+0.5*advtmp(i,j)
        advtmp(i,j) = 0.
        adu(i,j+1) = adu(i,j+1)+0.5*adutmp(i,j)
        adu(i,j) = adu(i,j)+0.5*adutmp(i,j)
        adutmp(i,j) = 0.
      end do
    end do
  endif
  if (je+1 .eq. npy .or. jed .ge. npy-npt) then
    do j = npy-npt+1, jed
      do i = isd, ied
        adv(i+1,j) = adv(i+1,j)+0.5*advtmp(i,j)
        adv(i,j) = adv(i,j)+0.5*advtmp(i,j)
        advtmp(i,j) = 0.
        adu(i,j+1) = adu(i,j+1)+0.5*adutmp(i,j)
        adu(i,j) = adu(i,j)+0.5*adutmp(i,j)
        adutmp(i,j) = 0.
      end do
    end do
  endif
  if (js .eq. 1 .or. jsd .lt. npt) then
    do j = jsd, npt-1
      do i = isd, ied
        adv(i+1,j) = adv(i+1,j)+0.5*advtmp(i,j)
        adv(i,j) = adv(i,j)+0.5*advtmp(i,j)
        advtmp(i,j) = 0.
        adu(i,j+1) = adu(i,j+1)+0.5*adutmp(i,j)
        adu(i,j) = adu(i,j)+0.5*adutmp(i,j)
        adutmp(i,j) = 0.
      end do
    end do
  endif
endif
do j = max(npt,jsd), min(npy-npt,jed)
  do i = max(npt,is-1), min(npx-npt,ie+1)
    adv(i-1,j) = adv(i-1,j)+advtmp(i,j)*a2
    adv(i+2,j) = adv(i+2,j)+advtmp(i,j)*a2
    adv(i+1,j) = adv(i+1,j)+advtmp(i,j)*a1
    adv(i,j) = adv(i,j)+advtmp(i,j)*a1
    advtmp(i,j) = 0.
  end do
end do
do j = max(npt,js-1), min(npy-npt,je+1)
  do i = max(npt,isd), min(npx-npt,ied)
    adu(i,j-1) = adu(i,j-1)+adutmp(i,j)*a2
    adu(i,j+2) = adu(i,j+2)+adutmp(i,j)*a2
    adu(i,j+1) = adu(i,j+1)+adutmp(i,j)*a1
    adu(i,j) = adu(i,j)+adutmp(i,j)*a1
    adutmp(i,j) = 0.
  end do
end do

end subroutine add2a2c_vect


subroutine add_sw( addelpc, addelp, adptc, adpt, adu, adv, adw, aduc, advc, adua, adva, addivg_d, adxflux, adyflux, adcx, adcy, &
&adcrx_adv, adcry_adv, adxfx_adv, adyfx_adv, dt, hord_mt, hord_vt, hord_tm, dddmp, dddm4, hydrostatic, uniform_ppm, taf_rec_npz )
!******************************************************************
!******************************************************************
!** This routine was generated by Automatic differentiation.     **
!** FastOpt: Transformation of Algorithm in Fortran, TAF 1.9.50  **
!******************************************************************
!******************************************************************
!==============================================
! referencing used modules
!==============================================
use adtp_core_mod, only : adfv_tp_2d
use add_sw_store, only : tp_dsw_crx_adv_150h,tp_dsw_crx_adv_195h,tp_dsw_crx_adv_221h,tp_dsw_crx_adv_332h,tp_dsw_cry_adv_151h,&
&tp_dsw_cry_adv_196h,tp_dsw_cry_adv_222h,tp_dsw_cry_adv_333h,tp_dsw_d_sw,tp_dsw_delp_149h,tp_dsw_delp_217h,tp_dsw_delp_254h,&
&tp_dsw_delp_255h,tp_dsw_fx_152h,tp_dsw_fx_203h,tp_dsw_fx_229h,tp_dsw_fx_251h,tp_dsw_fx_334h,tp_dsw_fy_153h,tp_dsw_fy_204h,&
&tp_dsw_fy_230h,tp_dsw_fy_252h,tp_dsw_fy_335h,tp_dsw_gy_198h,tp_dsw_gy_224h,tp_dsw_gy_246h,tp_dsw_pt_220h,tp_dsw_pt_253h,&
&tp_dsw_ra_x_156h,tp_dsw_ra_x_201h,tp_dsw_ra_x_227h,tp_dsw_ra_x_338h,tp_dsw_ra_y_157h,tp_dsw_ra_y_202h,tp_dsw_ra_y_228h,&
&tp_dsw_ra_y_339h,tp_dsw_u_287h,tp_dsw_u_303h,tp_dsw_ub_197h,tp_dsw_ub_223h,tp_dsw_ub_245h,tp_dsw_ub_274h,tp_dsw_ub_286h,&
&tp_dsw_ub_295h,tp_dsw_ut_301h,tp_dsw_v_266h,tp_dsw_v_304h,tp_dsw_vb_264h,tp_dsw_vb_273h,tp_dsw_vb_296h,tp_dsw_vort_331h,&
&tp_dsw_vt_302h,tp_dsw_w_194h,tp_dsw_w_216h,tp_dsw_w_256h,tp_dsw_xfx_adv_125h,tp_dsw_xfx_adv_154h,tp_dsw_xfx_adv_199h,&
&tp_dsw_xfx_adv_225h,tp_dsw_xfx_adv_336h,tp_dsw_yfx_adv_134h,tp_dsw_yfx_adv_155h,tp_dsw_yfx_adv_200h,tp_dsw_yfx_adv_226h,&
&tp_dsw_yfx_adv_337h
use fv_mp_mod, only : mp_corner_comm_ad

!==============================================
! all entries are defined explicitly
!==============================================
implicit none

!==============================================
! declare parameters
!==============================================
real, parameter :: r3 = 1./3.

!==============================================
! declare arguments
!==============================================
real, intent(inout) :: adcrx_adv(is:ie+1,jsd:jed)
real, intent(inout) :: adcry_adv(isd:ied,js:je+1)
real, intent(inout) :: adcx(is:ie+1,jsd:jed)
real, intent(inout) :: adcy(isd:ied,js:je+1)
real, intent(inout) :: addelp(isd:ied,jsd:jed)
real, intent(inout) :: addelpc(isd:ied,jsd:jed)
real, intent(inout) :: addivg_d(isd:ied+1,jsd:jed+1)
real, intent(inout) :: adpt(isd:ied,jsd:jed)
real, intent(inout) :: adptc(isd:ied,jsd:jed)
real, intent(inout) :: adu(isd:ied,jsd:jed+1)
real, intent(inout) :: adua(isd:ied,jsd:jed)
real, intent(inout) :: aduc(isd:ied+1,jsd:jed)
real, intent(inout) :: adv(isd:ied+1,jsd:jed)
real, intent(inout) :: adva(isd:ied,jsd:jed)
real, intent(inout) :: advc(isd:ied,jsd:jed+1)
real, intent(inout) :: adw(isd:ied,jsd:jed)
real, intent(inout) :: adxflux(is:ie+1,js:je)
real, intent(inout) :: adxfx_adv(is:ie+1,jsd:jed)
real, intent(inout) :: adyflux(is:ie,js:je+1)
real, intent(inout) :: adyfx_adv(isd:ied,js:je+1)
real, intent(in) :: dddm4
real, intent(in) :: dddmp
real, intent(in) :: dt
integer, intent(in) :: hord_mt
integer, intent(in) :: hord_tm
integer, intent(in) :: hord_vt
logical, intent(in) :: hydrostatic
integer :: taf_rec_npz
logical, intent(in) :: uniform_ppm

!==============================================
! declare local variables
!==============================================
real :: adfx(is:ie+1,js:je)
real, allocatable :: adfx_killh(:,:)
real, allocatable :: adfx_killi(:,:)
real :: adfy(is:ie,js:je+1)
real, allocatable :: adfy_killh(:,:)
real, allocatable :: adfy_killi(:,:)
real :: adgy(is:ie,js:je+1)
real :: adke(isd:ied+1,jsd:jed+1)
real :: adke_ub(isd:ied+1,jsd:jed+1)
real :: adke_vb(isd:ied+1,jsd:jed+1)
real :: adra_x(is:ie,jsd:jed)
real :: adra_y(isd:ied,js:je)
real :: adub(is:ie+1,js:je+1)
real :: adut(is-1:ie+2,jsd:jed)
real :: advb(is:ie+1,js:je+1)
real :: advort(isd:ied,jsd:jed)
real :: advt(isd:ied,js-1:je+2)
real :: adwk(isd:ied+1,jsd:jed+1)
real :: crx_adv(is:ie+1,jsd:jed)
real :: cry_adv(isd:ied,js:je+1)
real :: damp
real :: damp4
real :: damp_divg
real :: delp(isd:ied,jsd:jed)
real :: dt4
real :: dt5
real :: dt6
real :: fx(is:ie+1,js:je)
real :: fx_kill(is:ie+1,js:je)
real :: fy(is:ie,js:je+1)
real :: fy_kill(is:ie,js:je+1)
real :: gy(is:ie,js:je+1)
integer :: i
integer :: ie1
integer :: is2
integer :: j
integer :: je1
integer :: js2
real :: pt(isd:ied,jsd:jed)
real :: ra_x(is:ie,jsd:jed)
real :: ra_y(isd:ied,js:je)
real :: u(isd:ied,jsd:jed+1)
real :: ub(is:ie+1,js:je+1)
real :: ut(is-1:ie+2,jsd:jed)
real :: v(isd:ied+1,jsd:jed)
real :: vb(is:ie+1,js:je+1)
real :: vort(isd:ied,jsd:jed)
real :: vt(isd:ied,js-1:je+2)
real :: w(isd:ied,jsd:jed)
real :: xfx_adv(is:ie+1,jsd:jed)
real :: yfx_adv(isd:ied,js:je+1)

!----------------------------------------------
! RESET LOCAL ADJOINT VARIABLES
!----------------------------------------------
adfx(:,:) = 0.
adfy(:,:) = 0.
adgy(:,:) = 0.
adke(:,:) = 0.
adke_ub(:,:) = 0.
adke_vb(:,:) = 0.
adra_x(:,:) = 0.
adra_y(:,:) = 0.
adub(:,:) = 0.
adut(:,:) = 0.
advb(:,:) = 0.
advort(:,:) = 0.
advt(:,:) = 0.
adwk(:,:) = 0.

!----------------------------------------------
! ROUTINE BODY
!----------------------------------------------
fx_kill = 0.
fy_kill = 0.
gy = tp_dsw_gy_246h(:,:,taf_rec_npz)
pt = tp_dsw_pt_253h(:,:,taf_rec_npz)
dt5 = 0.5*dt
dt4 = 0.25*dt
is2 = max(2,is)
ie1 = min(npx-1,ie+1)
js2 = max(2,js)
je1 = min(npy-1,je+1)
ub = tp_dsw_ub_295h(:,:,taf_rec_npz)
vb = tp_dsw_vb_296h(:,:,taf_rec_npz)
damp_divg = dddmp*da_min_c
vort = tp_dsw_vort_331h(:,:,taf_rec_npz)
crx_adv = tp_dsw_crx_adv_332h(:,:,taf_rec_npz)
cry_adv = tp_dsw_cry_adv_333h(:,:,taf_rec_npz)
fx = tp_dsw_fx_334h(:,:,taf_rec_npz)
fy = tp_dsw_fy_335h(:,:,taf_rec_npz)
xfx_adv = tp_dsw_xfx_adv_336h(:,:,taf_rec_npz)
yfx_adv = tp_dsw_yfx_adv_337h(:,:,taf_rec_npz)
ra_x = tp_dsw_ra_x_338h(:,:,taf_rec_npz)
ra_y = tp_dsw_ra_y_339h(:,:,taf_rec_npz)
do j = js, je
  do i = is, ie+1
    adfx(i,j) = adfx(i,j)-adv(i,j)
    adke(i,j+1) = adke(i,j+1)-adv(i,j)
    adke(i,j) = adke(i,j)+adv(i,j)
  end do
end do
do j = js, je+1
  do i = is, ie
    adfy(i,j) = adfy(i,j)+adu(i,j)
    adke(i+1,j) = adke(i+1,j)-adu(i,j)
    adke(i,j) = adke(i,j)+adu(i,j)
  end do
end do
allocate( adfy_killh(is:ie,js:je+1) )
adfy_killh(:,:) = 0.
allocate( adfx_killh(is:ie+1,js:je) )
adfx_killh(:,:) = 0.
call adfv_tp_2d( vort,advort,crx_adv,adcrx_adv,cry_adv,adcry_adv,npx,npy,hord_vt,fx,adfx,fy,adfy,xfx_adv,adxfx_adv,yfx_adv,&
&adyfx_adv,area,ra_x,adra_x,ra_y,adra_y,uniform_ppm,fx_kill,adfx_killh,fy_kill,adfy_killh, .false.  )
deallocate( adfx_killh )
deallocate( adfy_killh )
do j = jsd, jed
  do i = isd, ied
    adu(i,j+1) = adu(i,j+1)-advort(i,j)*rarea(i,j)
    adu(i,j) = adu(i,j)+advort(i,j)*rarea(i,j)
    adv(i+1,j) = adv(i+1,j)+advort(i,j)*rarea(i,j)
    adv(i,j) = adv(i,j)-advort(i,j)*rarea(i,j)
    advort(i,j) = 0.
  end do
end do
do j = jsd, jed
  do i = isd, ied+1
    adv(i,j) = adv(i,j)*dy(i,j)
  end do
end do
do j = jsd, jed+1
  do i = isd, ied
    adu(i,j) = adu(i,j)*dx(i,j)
  end do
end do
if (dddm4 .gt. 0.) then
  damp4 = (dddm4*da_min_c)**2
  do j = js, je+1
    do i = is, ie+1
      addivg_d(i,j) = addivg_d(i,j)+adke(i,j)*damp_divg
      adwk(i,j) = adwk(i,j)+adke(i,j)*damp4*rarea_c(i,j)
    end do
  end do
  if (nw_corner) then
    advort(1,npy) = advort(1,npy)+adwk(1,npy)
  endif
  if (ne_corner) then
    advort(npx,npy) = advort(npx,npy)+adwk(npx,npy)
  endif
  if (se_corner) then
    advort(npx,0) = advort(npx,0)-adwk(npx,1)
  endif
  if (sw_corner) then
    advort(1,0) = advort(1,0)-adwk(1,1)
  endif
  do j = js, je+1
    do i = is, ie+1
      adptc(i-1,j) = adptc(i-1,j)+adwk(i,j)
      adptc(i,j) = adptc(i,j)-adwk(i,j)
      advort(i,j-1) = advort(i,j-1)+adwk(i,j)
      advort(i,j) = advort(i,j)-adwk(i,j)
      adwk(i,j) = 0.
    end do
  end do
  do j = js-1, je+1
    do i = is, ie+1
      adwk(i,j+1) = adwk(i,j+1)+advort(i,j)*sina_u(i,j)*dxc(i,j)*rdy(i,j)
      adwk(i,j) = adwk(i,j)-advort(i,j)*sina_u(i,j)*dxc(i,j)*rdy(i,j)
      advort(i,j) = 0.
    end do
  end do
  do j = js, je+1
    do i = is-1, ie+1
      adwk(i+1,j) = adwk(i+1,j)+adptc(i,j)*sina_v(i,j)*dyc(i,j)*rdx(i,j)
      adwk(i,j) = adwk(i,j)-adptc(i,j)*sina_v(i,j)*dyc(i,j)*rdx(i,j)
      adptc(i,j) = 0.
    end do
  end do
  do j = js-1, je+2
    do i = is-1, ie+2
      addivg_d(i,j) = addivg_d(i,j)+adwk(i,j)
      adwk(i,j) = 0.
      addivg_d(i,j) = addivg_d(i,j)+addelpc(i,j)
      addelpc(i,j) = 0.
    end do
  end do
else
  do j = js, je+1
    do i = is, ie+1
      addelpc(i,j) = addelpc(i,j)+adke(i,j)*damp_divg
      addelpc(i,j) = addelpc(i,j)*rarea_c(i,j)
    end do
  end do
  if (nw_corner) then
    advort(1,npy) = advort(1,npy)+addelpc(1,npy)
  endif
  if (ne_corner) then
    advort(npx,npy) = advort(npx,npy)+addelpc(npx,npy)
  endif
  if (se_corner) then
    advort(npx,0) = advort(npx,0)-addelpc(npx,1)
  endif
  if (sw_corner) then
    advort(1,0) = advort(1,0)-addelpc(1,1)
  endif
  do j = js, je+1
    do i = is, ie+1
      adptc(i-1,j) = adptc(i-1,j)+addelpc(i,j)
      adptc(i,j) = adptc(i,j)-addelpc(i,j)
      advort(i,j-1) = advort(i,j-1)+addelpc(i,j)
      advort(i,j) = advort(i,j)-addelpc(i,j)
      addelpc(i,j) = 0.
    end do
  end do
  do j = js-1, je+1
    if (ie+1 .eq. npx) then
      adv(npx,j) = adv(npx,j)+advort(npx,j)*dxc(npx,j)*sina_u(npx,j)
      advort(npx,j) = 0.
    endif
    if (is .eq. 1) then
      adv(1,j) = adv(1,j)+advort(1,j)*dxc(1,j)*sina_u(1,j)
      advort(1,j) = 0.
    endif
    do i = is2, ie1
      adua(i-1,j) = adua(i-1,j)-0.5*advort(i,j)*cosa_u(i,j)*dxc(i,j)*sina_u(i,j)
      adua(i,j) = adua(i,j)-0.5*advort(i,j)*cosa_u(i,j)*dxc(i,j)*sina_u(i,j)
      adv(i,j) = adv(i,j)+advort(i,j)*dxc(i,j)*sina_u(i,j)
      advort(i,j) = 0.
    end do
  end do
  do j = js, je+1
    if (j .eq. 1 .or. j .eq. npy) then
      do i = is-1, ie+1
        adu(i,j) = adu(i,j)+adptc(i,j)*dyc(i,j)*sina_v(i,j)
        adptc(i,j) = 0.
      end do
    else
      do i = is-1, ie+1
        adu(i,j) = adu(i,j)+adptc(i,j)*dyc(i,j)*sina_v(i,j)
        adva(i,j-1) = adva(i,j-1)-0.5*adptc(i,j)*cosa_v(i,j)*dyc(i,j)*sina_v(i,j)
        adva(i,j) = adva(i,j)-0.5*adptc(i,j)*cosa_v(i,j)*dyc(i,j)*sina_v(i,j)
        adptc(i,j) = 0.
      end do
    endif
  end do
endif
if (gnomonic_grid) then
  ut = tp_dsw_ut_301h(:,:,taf_rec_npz)
  vt = tp_dsw_vt_302h(:,:,taf_rec_npz)
  u = tp_dsw_u_303h(:,:,taf_rec_npz)
  v = tp_dsw_v_304h(:,:,taf_rec_npz)
  dt6 = dt/6.
  if (nw_corner) then
    j = npy
    adu(1,j) = adu(1,j)+adke(1,j)*dt6*(ut(1,j)+ut(1,j-1))
    adu(0,j) = adu(0,j)+adke(1,j)*dt6*(ut(1,j-1)-vt(1,j))
    adut(1,j-1) = adut(1,j-1)+adke(1,j)*dt6*(u(1,j)+u(0,j))
    adut(1,j) = adut(1,j)+adke(1,j)*dt6*u(1,j)
    adv(1,j-1) = adv(1,j-1)+adke(1,j)*dt6*(vt(1,j)+vt(0,j))
    advt(1,j) = advt(1,j)+adke(1,j)*dt6*(v(1,j-1)-u(0,j))
    advt(0,j) = advt(0,j)+adke(1,j)*dt6*v(1,j-1)
    adke(1,j) = 0.
  endif
  if (ne_corner) then
    i = npx
    j = npy
    adu(i-1,j) = adu(i-1,j)+adke(i,j)*dt6*(ut(i,j)+ut(i,j-1))
    adu(i,j) = adu(i,j)+adke(i,j)*dt6*(ut(i,j-1)+vt(i-1,j))
    adut(i,j-1) = adut(i,j-1)+adke(i,j)*dt6*(u(i-1,j)+u(i,j))
    adut(i,j) = adut(i,j)+adke(i,j)*dt6*u(i-1,j)
    adv(i,j-1) = adv(i,j-1)+adke(i,j)*dt6*(vt(i,j)+vt(i-1,j))
    advt(i-1,j) = advt(i-1,j)+adke(i,j)*dt6*(v(i,j-1)+u(i,j))
    advt(i,j) = advt(i,j)+adke(i,j)*dt6*v(i,j-1)
    adke(i,j) = 0.
  endif
  if (se_corner) then
    i = npx
    adu(i-1,1) = adu(i-1,1)+adke(i,1)*dt6*(ut(i,1)+ut(i,0))
    adu(i,1) = adu(i,1)+adke(i,1)*dt6*(ut(i,1)-vt(i-1,1))
    adut(i,1) = adut(i,1)+adke(i,1)*dt6*(u(i-1,1)+u(i,1))
    adut(i,0) = adut(i,0)+adke(i,1)*dt6*u(i-1,1)
    adv(i,1) = adv(i,1)+adke(i,1)*dt6*(vt(i,1)+vt(i-1,1))
    advt(i-1,1) = advt(i-1,1)+adke(i,1)*dt6*(v(i,1)-u(i,1))
    advt(i,1) = advt(i,1)+adke(i,1)*dt6*v(i,1)
    adke(i,1) = 0.
  endif
  if (sw_corner) then
    adu(1,1) = adu(1,1)+adke(1,1)*dt6*(ut(1,1)+ut(1,0))
    adu(0,1) = adu(0,1)+adke(1,1)*dt6*(ut(1,1)+vt(1,1))
    adut(1,1) = adut(1,1)+adke(1,1)*dt6*(u(1,1)+u(0,1))
    adut(1,0) = adut(1,0)+adke(1,1)*dt6*u(1,1)
    adv(1,1) = adv(1,1)+adke(1,1)*dt6*(vt(1,1)+vt(0,1))
    advt(1,1) = advt(1,1)+adke(1,1)*dt6*(v(1,1)+u(0,1))
    advt(0,1) = advt(0,1)+adke(1,1)*dt6*v(1,1)
    adke(1,1) = 0.
  endif
else if (grid_type .lt. 3) then
  if (nw_corner) then
    adke(1,npy-1) = adke(1,npy-1)+adke(1,npy)*r3
    adke(2,npy) = adke(2,npy)+adke(1,npy)*r3
    adke(0,npy) = adke(0,npy)+adke(1,npy)*r3
    adke(1,npy) = 0.
  endif
  if (ne_corner) then
    adke(npx,npy-1) = adke(npx,npy-1)+adke(npx,npy)*r3
    adke(npx-1,npy) = adke(npx-1,npy)+adke(npx,npy)*r3
    adke(npx+1,npy) = adke(npx+1,npy)+adke(npx,npy)*r3
    adke(npx,npy) = 0.
  endif
  if (se_corner) then
    adke(npx,2) = adke(npx,2)+adke(npx,1)*r3
    adke(npx-1,1) = adke(npx-1,1)+adke(npx,1)*r3
    adke(npx+1,1) = adke(npx+1,1)+adke(npx,1)*r3
    adke(npx,1) = 0.
  endif
  if (sw_corner) then
    adke(1,2) = adke(1,2)+adke(1,1)*r3
    adke(2,1) = adke(2,1)+adke(1,1)*r3
    adke(0,1) = adke(0,1)+adke(1,1)*r3
    adke(1,1) = 0.
  endif
  call mp_corner_comm_ad( adke,npx,npy )
endif
do j = js, je+1
  do i = is, ie+1
    adke_ub(i,j) = adke_ub(i,j)+adke(i,j)
    adke_vb(i,j) = adke_vb(i,j)+adke(i,j)
    adke(i,j) = 0.
  end do
end do
do j = js, je+1
  do i = is, ie+1
    adub(i,j) = adub(i,j)+0.5*adke_vb(i,j)*vb(i,j)
    advb(i,j) = advb(i,j)+0.5*adke_vb(i,j)*ub(i,j)
    adke_vb(i,j) = 0.
  end do
end do
ub = tp_dsw_ub_286h(:,:,taf_rec_npz)
u = tp_dsw_u_287h(:,:,taf_rec_npz)
call adxtp_u( ub,adub,u,adu,advb,hord_mt )
if (grid_type .lt. 3) then
  if (ie+1 .eq. npx) then
    do j = js, je+1
      adut(npx,j-1) = adut(npx,j-1)+adub(npx,j)*dt5
      adut(npx,j) = adut(npx,j)+adub(npx,j)*dt5
      adub(npx,j) = 0.
    end do
  endif
  do j = js, je+1
    if (j .eq. 1 .or. j .eq. npy) then
      do i = is2, ie1
        adut(i,j-2) = adut(i,j-2)-adub(i,j)*dt4
        adut(i,j-1) = adut(i,j-1)+3*adub(i,j)*dt4
        adut(i,j+1) = adut(i,j+1)-adub(i,j)*dt4
        adut(i,j) = adut(i,j)+3*adub(i,j)*dt4
        adub(i,j) = 0.
      end do
    else
      do i = is2, ie1
        aduc(i,j-1) = aduc(i,j-1)+adub(i,j)*dt5*rsina(i,j)
        aduc(i,j) = aduc(i,j)+adub(i,j)*dt5*rsina(i,j)
        advc(i-1,j) = advc(i-1,j)-adub(i,j)*dt5*cosa(i,j)*rsina(i,j)
        advc(i,j) = advc(i,j)-adub(i,j)*dt5*cosa(i,j)*rsina(i,j)
        adub(i,j) = 0.
      end do
    endif
  end do
  if (is .eq. 1) then
    do j = js, je+1
      adut(1,j-1) = adut(1,j-1)+adub(1,j)*dt5
      adut(1,j) = adut(1,j)+adub(1,j)*dt5
      adub(1,j) = 0.
    end do
  endif
else
  do j = js, je+1
    do i = is, ie+1
      aduc(i,j-1) = aduc(i,j-1)+adub(i,j)*dt5
      aduc(i,j) = aduc(i,j)+adub(i,j)*dt5
      adub(i,j) = 0.
    end do
  end do
endif
vb = tp_dsw_vb_273h(:,:,taf_rec_npz)
ub = tp_dsw_ub_274h(:,:,taf_rec_npz)
do j = js, je+1
  do i = is, ie+1
    adub(i,j) = adub(i,j)+0.5*adke_ub(i,j)*vb(i,j)
    advb(i,j) = advb(i,j)+0.5*adke_ub(i,j)*ub(i,j)
    adke_ub(i,j) = 0.
  end do
end do
vb = tp_dsw_vb_264h(:,:,taf_rec_npz)
v = tp_dsw_v_266h(:,:,taf_rec_npz)
call adytp_v( vb,advb,v,adv,adub,hord_mt )
if (grid_type .lt. 3) then
  if (je+1 .eq. npy) then
    do i = is, ie+1
      advt(i-1,npy) = advt(i-1,npy)+advb(i,npy)*dt5
      advt(i,npy) = advt(i,npy)+advb(i,npy)*dt5
      advb(i,npy) = 0.
    end do
  endif
  do j = js2, je1
    if (ie+1 .eq. npx) then
      advt(npx-2,j) = advt(npx-2,j)-advb(npx,j)*dt4
      advt(npx-1,j) = advt(npx-1,j)+3*advb(npx,j)*dt4
      advt(npx+1,j) = advt(npx+1,j)-advb(npx,j)*dt4
      advt(npx,j) = advt(npx,j)+3*advb(npx,j)*dt4
      advb(npx,j) = 0.
    endif
    if (is .eq. 1) then
      advt(-1,j) = advt(-1,j)-advb(1,j)*dt4
      advt(2,j) = advt(2,j)-advb(1,j)*dt4
      advt(1,j) = advt(1,j)+3*advb(1,j)*dt4
      advt(0,j) = advt(0,j)+3*advb(1,j)*dt4
      advb(1,j) = 0.
    endif
    do i = is2, ie1
      aduc(i,j-1) = aduc(i,j-1)-advb(i,j)*dt5*cosa(i,j)*rsina(i,j)
      aduc(i,j) = aduc(i,j)-advb(i,j)*dt5*cosa(i,j)*rsina(i,j)
      advc(i-1,j) = advc(i-1,j)+advb(i,j)*dt5*rsina(i,j)
      advc(i,j) = advc(i,j)+advb(i,j)*dt5*rsina(i,j)
      advb(i,j) = 0.
    end do
  end do
  if (js .eq. 1) then
    do i = is, ie+1
      advt(i-1,1) = advt(i-1,1)+advb(i,1)*dt5
      advt(i,1) = advt(i,1)+advb(i,1)*dt5
      advb(i,1) = 0.
    end do
  endif
else
  do j = js, je+1
    do i = is, ie+1
      advc(i-1,j) = advc(i-1,j)+advb(i,j)*dt5
      advc(i,j) = advc(i,j)+advb(i,j)*dt5
      advb(i,j) = 0.
    end do
  end do
endif
if ( .not. hydrostatic) then
  delp = tp_dsw_delp_255h(:,:,taf_rec_npz)
  w = tp_dsw_w_256h(:,:,taf_rec_npz)
  do j = js, je
    do i = is, ie
      addelp(i,j) = addelp(i,j)-adw(i,j)*(w(i,j)/(delp(i,j)*delp(i,j)))
      adw(i,j) = adw(i,j)/delp(i,j)
    end do
  end do
endif
ub = tp_dsw_ub_245h(:,:,taf_rec_npz)
fx = tp_dsw_fx_251h(:,:,taf_rec_npz)
fy = tp_dsw_fy_252h(:,:,taf_rec_npz)
delp = tp_dsw_delp_254h(:,:,taf_rec_npz)
do j = js, je
  do i = is, ie
    pt(i,j) = pt(i,j)*delp(i,j)+(ub(i,j)-ub(i+1,j)+gy(i,j)-gy(i,j+1))*rarea(i,j)
    delp(i,j) = delp(i,j)+(fx(i,j)-fx(i+1,j)+fy(i,j)-fy(i,j+1))*rarea(i,j)
    addelp(i,j) = addelp(i,j)-adpt(i,j)*(pt(i,j)/(delp(i,j)*delp(i,j)))
    adpt(i,j) = adpt(i,j)/delp(i,j)
    adfx(i+1,j) = adfx(i+1,j)-addelp(i,j)*rarea(i,j)
    adfx(i,j) = adfx(i,j)+addelp(i,j)*rarea(i,j)
    adfy(i,j+1) = adfy(i,j+1)-addelp(i,j)*rarea(i,j)
    adfy(i,j) = adfy(i,j)+addelp(i,j)*rarea(i,j)
    pt = tp_dsw_pt_253h(:,:,taf_rec_npz)
    delp = tp_dsw_delp_254h(:,:,taf_rec_npz)
    addelp(i,j) = addelp(i,j)+adpt(i,j)*pt(i,j)
    adgy(i,j+1) = adgy(i,j+1)-adpt(i,j)*rarea(i,j)
    adgy(i,j) = adgy(i,j)+adpt(i,j)*rarea(i,j)
    adub(i+1,j) = adub(i+1,j)-adpt(i,j)*rarea(i,j)
    adub(i,j) = adub(i,j)+adpt(i,j)*rarea(i,j)
    adpt(i,j) = adpt(i,j)*delp(i,j)
  end do
end do
pt = tp_dsw_pt_220h(:,:,taf_rec_npz)
crx_adv = tp_dsw_crx_adv_221h(:,:,taf_rec_npz)
cry_adv = tp_dsw_cry_adv_222h(:,:,taf_rec_npz)
ub = tp_dsw_ub_223h(:,:,taf_rec_npz)
gy = tp_dsw_gy_224h(:,:,taf_rec_npz)
xfx_adv = tp_dsw_xfx_adv_225h(:,:,taf_rec_npz)
yfx_adv = tp_dsw_yfx_adv_226h(:,:,taf_rec_npz)
ra_x = tp_dsw_ra_x_227h(:,:,taf_rec_npz)
ra_y = tp_dsw_ra_y_228h(:,:,taf_rec_npz)
fx = tp_dsw_fx_229h(:,:,taf_rec_npz)
fy = tp_dsw_fy_230h(:,:,taf_rec_npz)
call adfv_tp_2d( pt,adpt,crx_adv,adcrx_adv,cry_adv,adcry_adv,npx,npy,hord_tm,ub,adub,gy,adgy,xfx_adv,adxfx_adv,yfx_adv,adyfx_adv,&
&area,ra_x,adra_x,ra_y,adra_y,uniform_ppm,fx,adfx,fy,adfy, .true.  )
if ( .not. hydrostatic) then
  crx_adv = tp_dsw_crx_adv_195h(:,:,taf_rec_npz)
  cry_adv = tp_dsw_cry_adv_196h(:,:,taf_rec_npz)
  ub = tp_dsw_ub_197h(:,:,taf_rec_npz)
  gy = tp_dsw_gy_198h(:,:,taf_rec_npz)
  xfx_adv = tp_dsw_xfx_adv_199h(:,:,taf_rec_npz)
  yfx_adv = tp_dsw_yfx_adv_200h(:,:,taf_rec_npz)
  ra_x = tp_dsw_ra_x_201h(:,:,taf_rec_npz)
  ra_y = tp_dsw_ra_y_202h(:,:,taf_rec_npz)
  fx = tp_dsw_fx_203h(:,:,taf_rec_npz)
  fy = tp_dsw_fy_204h(:,:,taf_rec_npz)
  w = tp_dsw_w_216h(:,:,taf_rec_npz)
  delp = tp_dsw_delp_217h(:,:,taf_rec_npz)
  do j = js, je
    do i = is, ie
      addelp(i,j) = addelp(i,j)+adw(i,j)*w(i,j)
      adgy(i,j+1) = adgy(i,j+1)-adw(i,j)*rarea(i,j)
      adgy(i,j) = adgy(i,j)+adw(i,j)*rarea(i,j)
      adub(i+1,j) = adub(i+1,j)-adw(i,j)*rarea(i,j)
      adub(i,j) = adub(i,j)+adw(i,j)*rarea(i,j)
      adw(i,j) = adw(i,j)*delp(i,j)
    end do
  end do
  w = tp_dsw_w_194h(:,:,taf_rec_npz)
  call adfv_tp_2d( w,adw,crx_adv,adcrx_adv,cry_adv,adcry_adv,npx,npy,hord_vt,ub,adub,gy,adgy,xfx_adv,adxfx_adv,yfx_adv,adyfx_adv,&
&area,ra_x,adra_x,ra_y,adra_y,uniform_ppm,fx,adfx,fy,adfy, .true.  )
endif
do j = js, je+1
  do i = is, ie
    adfy(i,j) = adfy(i,j)+adyflux(i,j)
  end do
  do i = isd, ied
    adcry_adv(i,j) = adcry_adv(i,j)+adcy(i,j)
  end do
end do
do j = js, je
  do i = is, ie+1
    adfx(i,j) = adfx(i,j)+adxflux(i,j)
  end do
end do
do j = jsd, jed
  do i = is, ie+1
    adcrx_adv(i,j) = adcrx_adv(i,j)+adcx(i,j)
  end do
end do
delp = tp_dsw_delp_149h(:,:,taf_rec_npz)
crx_adv = tp_dsw_crx_adv_150h(:,:,taf_rec_npz)
cry_adv = tp_dsw_cry_adv_151h(:,:,taf_rec_npz)
fx = tp_dsw_fx_152h(:,:,taf_rec_npz)
fy = tp_dsw_fy_153h(:,:,taf_rec_npz)
xfx_adv = tp_dsw_xfx_adv_154h(:,:,taf_rec_npz)
yfx_adv = tp_dsw_yfx_adv_155h(:,:,taf_rec_npz)
ra_x = tp_dsw_ra_x_156h(:,:,taf_rec_npz)
ra_y = tp_dsw_ra_y_157h(:,:,taf_rec_npz)
allocate( adfy_killi(is:ie,js:je+1) )
adfy_killi(:,:) = 0.
allocate( adfx_killi(is:ie+1,js:je) )
adfx_killi(:,:) = 0.
call adfv_tp_2d( delp,addelp,crx_adv,adcrx_adv,cry_adv,adcry_adv,npx,npy,hord_tm,fx,adfx,fy,adfy,xfx_adv,adxfx_adv,yfx_adv,&
&adyfx_adv,area,ra_x,adra_x,ra_y,adra_y,uniform_ppm,fx_kill,adfx_killi,fy_kill,adfy_killi, .false.  )
deallocate( adfx_killi )
deallocate( adfy_killi )
do j = js, je
  do i = isd, ied
    adyfx_adv(i,j+1) = adyfx_adv(i,j+1)-adra_y(i,j)
    adyfx_adv(i,j) = adyfx_adv(i,j)+adra_y(i,j)
    adra_y(i,j) = 0.
  end do
end do
do j = jsd, jed
  do i = is, ie
    adxfx_adv(i+1,j) = adxfx_adv(i+1,j)-adra_x(i,j)
    adxfx_adv(i,j) = adxfx_adv(i,j)+adra_x(i,j)
    adra_x(i,j) = 0.
  end do
end do
do j = js, je+1
  do i = isd, ied
    adyfx_adv(i,j) = adyfx_adv(i,j)*dx(i,j)*sina_v(i,j)
  end do
end do
yfx_adv = tp_dsw_yfx_adv_134h(:,:,taf_rec_npz)
do j = js, je+1
  do i = isd, ied
    if (yfx_adv(i,j) .gt. 0.) then
      adyfx_adv(i,j) = adyfx_adv(i,j)+adcry_adv(i,j)*rdya(i,j-1)
      adcry_adv(i,j) = 0.
    else
      adyfx_adv(i,j) = adyfx_adv(i,j)+adcry_adv(i,j)*rdya(i,j)
      adcry_adv(i,j) = 0.
    endif
  end do
end do
do j = jsd, jed
  do i = is, ie+1
    adxfx_adv(i,j) = adxfx_adv(i,j)*dy(i,j)*sina_u(i,j)
  end do
end do
xfx_adv = tp_dsw_xfx_adv_125h(:,:,taf_rec_npz)
do j = jsd, jed
  do i = is, ie+1
    if (xfx_adv(i,j) .gt. 0.) then
      adxfx_adv(i,j) = adxfx_adv(i,j)+adcrx_adv(i,j)*rdxa(i-1,j)
      adcrx_adv(i,j) = 0.
    else
      adxfx_adv(i,j) = adxfx_adv(i,j)+adcrx_adv(i,j)*rdxa(i,j)
      adcrx_adv(i,j) = 0.
    endif
  end do
end do
do j = js, je+1
  do i = isd, ied
    advt(i,j) = advt(i,j)+adyfx_adv(i,j)*dt
    adyfx_adv(i,j) = 0.
  end do
end do
do j = jsd, jed
  do i = is, ie+1
    adut(i,j) = adut(i,j)+adxfx_adv(i,j)*dt
    adxfx_adv(i,j) = 0.
  end do
end do
if (grid_type .lt. 3) then
  if (nw_corner) then
    damp = 1./(1.-0.0625*cosa_u(2,npy-1)*cosa_v(1,npy-1))
    aduc(0,npy-1) = aduc(0,npy-1)+0.25*advt(0,npy-1)*cosa_v(1,npy-1)*damp
    adut(1,npy-2) = adut(1,npy-2)+0.25*advt(0,npy-1)*cosa_v(1,npy-1)*damp
    adut(0,npy-2) = adut(0,npy-2)+0.25*advt(0,npy-1)*cosa_v(1,npy-1)*damp
    adut(1,npy-1) = adut(1,npy-1)+0.25*advt(0,npy-1)*cosa_v(1,npy-1)*damp
    advc(0,npy-1) = advc(0,npy-1)+advt(0,npy-1)*damp
    advt(-1,npy-1) = advt(-1,npy-1)+0.25*0.25*advt(0,npy-1)*cosa_v(1,npy-1)*cosa_u(2,npy-1)*damp
    advt(-1,npy) = advt(-1,npy)+0.25*0.25*advt(0,npy-1)*cosa_v(1,npy-1)*cosa_u(2,npy-1)*damp
    advt(0,npy) = advt(0,npy)+0.25*0.25*advt(0,npy-1)*cosa_v(1,npy-1)*cosa_u(2,npy-1)*damp
    advt(0,npy-1) = 0.
    aduc(2,npy-1) = aduc(2,npy-1)-0.25*advt(1,npy-1)*cosa_v(1,npy-1)*damp
    adut(2,npy-2) = adut(2,npy-2)-0.25*advt(1,npy-1)*cosa_v(1,npy-1)*damp
    adut(1,npy-2) = adut(1,npy-2)-0.25*advt(1,npy-1)*cosa_v(1,npy-1)*damp
    adut(1,npy-1) = adut(1,npy-1)-0.25*advt(1,npy-1)*cosa_v(1,npy-1)*damp
    advc(1,npy-1) = advc(1,npy-1)+advt(1,npy-1)*damp
    advt(2,npy-1) = advt(2,npy-1)+0.25*0.25*advt(1,npy-1)*cosa_v(1,npy-1)*cosa_u(2,npy-1)*damp
    advt(2,npy) = advt(2,npy)+0.25*0.25*advt(1,npy-1)*cosa_v(1,npy-1)*cosa_u(2,npy-1)*damp
    advt(1,npy) = advt(1,npy)+0.25*0.25*advt(1,npy-1)*cosa_v(1,npy-1)*cosa_u(2,npy-1)*damp
    advt(1,npy-1) = 0.
    aduc(2,npy-1) = aduc(2,npy-1)+adut(2,npy-1)*damp
    adut(2,npy-2) = adut(2,npy-2)+0.25*0.25*adut(2,npy-1)*cosa_u(2,npy-1)*cosa_v(1,npy-1)*damp
    adut(1,npy-2) = adut(1,npy-2)+0.25*0.25*adut(2,npy-1)*cosa_u(2,npy-1)*cosa_v(1,npy-1)*damp
    adut(1,npy-1) = adut(1,npy-1)+0.25*0.25*adut(2,npy-1)*cosa_u(2,npy-1)*cosa_v(1,npy-1)*damp
    advc(1,npy-1) = advc(1,npy-1)-0.25*adut(2,npy-1)*cosa_u(2,npy-1)*damp
    advt(2,npy-1) = advt(2,npy-1)-0.25*adut(2,npy-1)*cosa_u(2,npy-1)*damp
    advt(2,npy) = advt(2,npy)-0.25*adut(2,npy-1)*cosa_u(2,npy-1)*damp
    advt(1,npy) = advt(1,npy)-0.25*adut(2,npy-1)*cosa_u(2,npy-1)*damp
    adut(2,npy-1) = 0.
    aduc(2,npy) = aduc(2,npy)+adut(2,npy)*damp
    adut(2,npy+1) = adut(2,npy+1)+0.25*0.25*adut(2,npy)*cosa_u(2,npy-1)*cosa_v(1,npy-1)*damp
    adut(1,npy+1) = adut(1,npy+1)+0.25*0.25*adut(2,npy)*cosa_u(2,npy-1)*cosa_v(1,npy-1)*damp
    adut(1,npy) = adut(1,npy)+0.25*0.25*adut(2,npy)*cosa_u(2,npy-1)*cosa_v(1,npy-1)*damp
    advc(1,npy+1) = advc(1,npy+1)+0.25*adut(2,npy)*cosa_u(2,npy-1)*damp
    advt(2,npy+1) = advt(2,npy+1)+0.25*adut(2,npy)*cosa_u(2,npy-1)*damp
    advt(2,npy) = advt(2,npy)+0.25*adut(2,npy)*cosa_u(2,npy-1)*damp
    advt(1,npy) = advt(1,npy)+0.25*adut(2,npy)*cosa_u(2,npy-1)*damp
    adut(2,npy) = 0.
  endif
  if (ne_corner) then
    damp = 1./(1.-0.0625*cosa_u(npx-1,npy-1)*cosa_v(npx-1,npy-1))
    aduc(npx+1,npy-1) = aduc(npx+1,npy-1)+0.25*advt(npx,npy-1)*cosa_v(npx-1,npy-1)*damp
    adut(npx+1,npy-2) = adut(npx+1,npy-2)+0.25*advt(npx,npy-1)*cosa_v(npx-1,npy-1)*damp
    adut(npx,npy-2) = adut(npx,npy-2)+0.25*advt(npx,npy-1)*cosa_v(npx-1,npy-1)*damp
    adut(npx,npy-1) = adut(npx,npy-1)+0.25*advt(npx,npy-1)*cosa_v(npx-1,npy-1)*damp
    advc(npx,npy-1) = advc(npx,npy-1)+advt(npx,npy-1)*damp
    advt(npx+1,npy-1) = advt(npx+1,npy-1)+0.25*0.25*advt(npx,npy-1)*cosa_v(npx-1,npy-1)*cosa_u(npx-1,npy-1)*damp
    advt(npx+1,npy) = advt(npx+1,npy)+0.25*0.25*advt(npx,npy-1)*cosa_v(npx-1,npy-1)*cosa_u(npx-1,npy-1)*damp
    advt(npx,npy) = advt(npx,npy)+0.25*0.25*advt(npx,npy-1)*cosa_v(npx-1,npy-1)*cosa_u(npx-1,npy-1)*damp
    advt(npx,npy-1) = 0.
    aduc(npx-1,npy-1) = aduc(npx-1,npy-1)-0.25*advt(npx-1,npy-1)*cosa_v(npx-1,npy-1)*damp
    adut(npx-1,npy-2) = adut(npx-1,npy-2)-0.25*advt(npx-1,npy-1)*cosa_v(npx-1,npy-1)*damp
    adut(npx,npy-2) = adut(npx,npy-2)-0.25*advt(npx-1,npy-1)*cosa_v(npx-1,npy-1)*damp
    adut(npx,npy-1) = adut(npx,npy-1)-0.25*advt(npx-1,npy-1)*cosa_v(npx-1,npy-1)*damp
    advc(npx-1,npy-1) = advc(npx-1,npy-1)+advt(npx-1,npy-1)*damp
    advt(npx-2,npy-1) = advt(npx-2,npy-1)+0.25*0.25*advt(npx-1,npy-1)*cosa_v(npx-1,npy-1)*cosa_u(npx-1,npy-1)*damp
    advt(npx-2,npy) = advt(npx-2,npy)+0.25*0.25*advt(npx-1,npy-1)*cosa_v(npx-1,npy-1)*cosa_u(npx-1,npy-1)*damp
    advt(npx-1,npy) = advt(npx-1,npy)+0.25*0.25*advt(npx-1,npy-1)*cosa_v(npx-1,npy-1)*cosa_u(npx-1,npy-1)*damp
    advt(npx-1,npy-1) = 0.
    aduc(npx-1,npy-1) = aduc(npx-1,npy-1)+adut(npx-1,npy-1)*damp
    adut(npx-1,npy-2) = adut(npx-1,npy-2)+0.25*0.25*adut(npx-1,npy-1)*cosa_u(npx-1,npy-1)*cosa_v(npx-1,npy-1)*damp
    adut(npx,npy-2) = adut(npx,npy-2)+0.25*0.25*adut(npx-1,npy-1)*cosa_u(npx-1,npy-1)*cosa_v(npx-1,npy-1)*damp
    adut(npx,npy-1) = adut(npx,npy-1)+0.25*0.25*adut(npx-1,npy-1)*cosa_u(npx-1,npy-1)*cosa_v(npx-1,npy-1)*damp
    advc(npx-1,npy-1) = advc(npx-1,npy-1)-0.25*adut(npx-1,npy-1)*cosa_u(npx-1,npy-1)*damp
    advt(npx-2,npy-1) = advt(npx-2,npy-1)-0.25*adut(npx-1,npy-1)*cosa_u(npx-1,npy-1)*damp
    advt(npx-2,npy) = advt(npx-2,npy)-0.25*adut(npx-1,npy-1)*cosa_u(npx-1,npy-1)*damp
    advt(npx-1,npy) = advt(npx-1,npy)-0.25*adut(npx-1,npy-1)*cosa_u(npx-1,npy-1)*damp
    adut(npx-1,npy-1) = 0.
    aduc(npx-1,npy) = aduc(npx-1,npy)+adut(npx-1,npy)*damp
    adut(npx-1,npy+1) = adut(npx-1,npy+1)+0.25*0.25*adut(npx-1,npy)*cosa_u(npx-1,npy-1)*cosa_v(npx-1,npy-1)*damp
    adut(npx,npy+1) = adut(npx,npy+1)+0.25*0.25*adut(npx-1,npy)*cosa_u(npx-1,npy-1)*cosa_v(npx-1,npy-1)*damp
    adut(npx,npy) = adut(npx,npy)+0.25*0.25*adut(npx-1,npy)*cosa_u(npx-1,npy-1)*cosa_v(npx-1,npy-1)*damp
    advc(npx-1,npy+1) = advc(npx-1,npy+1)+0.25*adut(npx-1,npy)*cosa_u(npx-1,npy-1)*damp
    advt(npx-2,npy+1) = advt(npx-2,npy+1)+0.25*adut(npx-1,npy)*cosa_u(npx-1,npy-1)*damp
    advt(npx-2,npy) = advt(npx-2,npy)+0.25*adut(npx-1,npy)*cosa_u(npx-1,npy-1)*damp
    advt(npx-1,npy) = advt(npx-1,npy)+0.25*adut(npx-1,npy)*cosa_u(npx-1,npy-1)*damp
    adut(npx-1,npy) = 0.
  endif
  if (se_corner) then
    damp = 1./(1.-0.0625*cosa_u(npx-1,1)*cosa_v(npx-1,2))
    aduc(npx+1,1) = aduc(npx+1,1)+0.25*advt(npx,2)*cosa_v(npx-1,2)*damp
    adut(npx+1,2) = adut(npx+1,2)+0.25*advt(npx,2)*cosa_v(npx-1,2)*damp
    adut(npx,2) = adut(npx,2)+0.25*advt(npx,2)*cosa_v(npx-1,2)*damp
    adut(npx,1) = adut(npx,1)+0.25*advt(npx,2)*cosa_v(npx-1,2)*damp
    advc(npx,2) = advc(npx,2)+advt(npx,2)*damp
    advt(npx+1,2) = advt(npx+1,2)+0.25*0.25*advt(npx,2)*cosa_v(npx-1,2)*cosa_u(npx-1,1)*damp
    advt(npx+1,1) = advt(npx+1,1)+0.25*0.25*advt(npx,2)*cosa_v(npx-1,2)*cosa_u(npx-1,1)*damp
    advt(npx,1) = advt(npx,1)+0.25*0.25*advt(npx,2)*cosa_v(npx-1,2)*cosa_u(npx-1,1)*damp
    advt(npx,2) = 0.
    aduc(npx-1,1) = aduc(npx-1,1)-0.25*advt(npx-1,2)*cosa_v(npx-1,2)*damp
    adut(npx-1,2) = adut(npx-1,2)-0.25*advt(npx-1,2)*cosa_v(npx-1,2)*damp
    adut(npx,2) = adut(npx,2)-0.25*advt(npx-1,2)*cosa_v(npx-1,2)*damp
    adut(npx,1) = adut(npx,1)-0.25*advt(npx-1,2)*cosa_v(npx-1,2)*damp
    advc(npx-1,2) = advc(npx-1,2)+advt(npx-1,2)*damp
    advt(npx-2,2) = advt(npx-2,2)+0.25*0.25*advt(npx-1,2)*cosa_v(npx-1,2)*cosa_u(npx-1,1)*damp
    advt(npx-2,1) = advt(npx-2,1)+0.25*0.25*advt(npx-1,2)*cosa_v(npx-1,2)*cosa_u(npx-1,1)*damp
    advt(npx-1,1) = advt(npx-1,1)+0.25*0.25*advt(npx-1,2)*cosa_v(npx-1,2)*cosa_u(npx-1,1)*damp
    advt(npx-1,2) = 0.
    aduc(npx-1,1) = aduc(npx-1,1)+adut(npx-1,1)*damp
    adut(npx-1,2) = adut(npx-1,2)+0.25*0.25*adut(npx-1,1)*cosa_u(npx-1,1)*cosa_v(npx-1,2)*damp
    adut(npx,2) = adut(npx,2)+0.25*0.25*adut(npx-1,1)*cosa_u(npx-1,1)*cosa_v(npx-1,2)*damp
    adut(npx,1) = adut(npx,1)+0.25*0.25*adut(npx-1,1)*cosa_u(npx-1,1)*cosa_v(npx-1,2)*damp
    advc(npx-1,2) = advc(npx-1,2)-0.25*adut(npx-1,1)*cosa_u(npx-1,1)*damp
    advt(npx-2,2) = advt(npx-2,2)-0.25*adut(npx-1,1)*cosa_u(npx-1,1)*damp
    advt(npx-2,1) = advt(npx-2,1)-0.25*adut(npx-1,1)*cosa_u(npx-1,1)*damp
    advt(npx-1,1) = advt(npx-1,1)-0.25*adut(npx-1,1)*cosa_u(npx-1,1)*damp
    adut(npx-1,1) = 0.
    aduc(npx-1,0) = aduc(npx-1,0)+adut(npx-1,0)*damp
    adut(npx-1,-1) = adut(npx-1,-1)+0.25*0.25*adut(npx-1,0)*cosa_u(npx-1,1)*cosa_v(npx-1,2)*damp
    adut(npx,-1) = adut(npx,-1)+0.25*0.25*adut(npx-1,0)*cosa_u(npx-1,1)*cosa_v(npx-1,2)*damp
    adut(npx,0) = adut(npx,0)+0.25*0.25*adut(npx-1,0)*cosa_u(npx-1,1)*cosa_v(npx-1,2)*damp
    advc(npx-1,0) = advc(npx-1,0)+0.25*adut(npx-1,0)*cosa_u(npx-1,1)*damp
    advt(npx-2,1) = advt(npx-2,1)+0.25*adut(npx-1,0)*cosa_u(npx-1,1)*damp
    advt(npx-1,1) = advt(npx-1,1)+0.25*adut(npx-1,0)*cosa_u(npx-1,1)*damp
    advt(npx-2,0) = advt(npx-2,0)+0.25*adut(npx-1,0)*cosa_u(npx-1,1)*damp
    adut(npx-1,0) = 0.
  endif
  if (sw_corner) then
    damp = 1./(1.-0.0625*cosa_u(2,1)*cosa_v(1,2))
    aduc(0,1) = aduc(0,1)-0.25*advt(0,2)*cosa_v(0,2)*damp
    adut(1,2) = adut(1,2)-0.25*advt(0,2)*cosa_v(0,2)*damp
    adut(0,2) = adut(0,2)-0.25*advt(0,2)*cosa_v(0,2)*damp
    adut(1,1) = adut(1,1)-0.25*advt(0,2)*cosa_v(0,2)*damp
    advc(0,2) = advc(0,2)+advt(0,2)*damp
    advt(-1,2) = advt(-1,2)+0.25*0.25*advt(0,2)*cosa_v(0,2)*cosa_u(0,1)*damp
    advt(-1,1) = advt(-1,1)+0.25*0.25*advt(0,2)*cosa_v(0,2)*cosa_u(0,1)*damp
    advt(0,1) = advt(0,1)+0.25*0.25*advt(0,2)*cosa_v(0,2)*cosa_u(0,1)*damp
    advt(0,2) = 0.
    aduc(2,1) = aduc(2,1)-0.25*advt(1,2)*cosa_v(1,2)*damp
    adut(2,2) = adut(2,2)-0.25*advt(1,2)*cosa_v(1,2)*damp
    adut(1,2) = adut(1,2)-0.25*advt(1,2)*cosa_v(1,2)*damp
    adut(1,1) = adut(1,1)-0.25*advt(1,2)*cosa_v(1,2)*damp
    advc(1,2) = advc(1,2)+advt(1,2)*damp
    advt(2,2) = advt(2,2)+0.25*0.25*advt(1,2)*cosa_v(1,2)*cosa_u(2,1)*damp
    advt(2,1) = advt(2,1)+0.25*0.25*advt(1,2)*cosa_v(1,2)*cosa_u(2,1)*damp
    advt(1,1) = advt(1,1)+0.25*0.25*advt(1,2)*cosa_v(1,2)*cosa_u(2,1)*damp
    advt(1,2) = 0.
    aduc(2,1) = aduc(2,1)+adut(2,1)*damp
    adut(2,2) = adut(2,2)+0.25*0.25*adut(2,1)*cosa_u(2,1)*cosa_v(1,2)*damp
    adut(1,2) = adut(1,2)+0.25*0.25*adut(2,1)*cosa_u(2,1)*cosa_v(1,2)*damp
    adut(1,1) = adut(1,1)+0.25*0.25*adut(2,1)*cosa_u(2,1)*cosa_v(1,2)*damp
    advc(1,2) = advc(1,2)-0.25*adut(2,1)*cosa_u(2,1)*damp
    advt(2,2) = advt(2,2)-0.25*adut(2,1)*cosa_u(2,1)*damp
    advt(2,1) = advt(2,1)-0.25*adut(2,1)*cosa_u(2,1)*damp
    advt(1,1) = advt(1,1)-0.25*adut(2,1)*cosa_u(2,1)*damp
    adut(2,1) = 0.
    aduc(2,0) = aduc(2,0)+adut(2,0)*damp
    adut(2,-1) = adut(2,-1)+0.25*0.25*adut(2,0)*cosa_u(2,0)*cosa_v(1,0)*damp
    adut(1,-1) = adut(1,-1)+0.25*0.25*adut(2,0)*cosa_u(2,0)*cosa_v(1,0)*damp
    adut(1,0) = adut(1,0)+0.25*0.25*adut(2,0)*cosa_u(2,0)*cosa_v(1,0)*damp
    advc(1,0) = advc(1,0)-0.25*adut(2,0)*cosa_u(2,0)*damp
    advt(2,1) = advt(2,1)-0.25*adut(2,0)*cosa_u(2,0)*damp
    advt(1,1) = advt(1,1)-0.25*adut(2,0)*cosa_u(2,0)*damp
    advt(2,0) = advt(2,0)-0.25*adut(2,0)*cosa_u(2,0)*damp
    adut(2,0) = 0.
  endif
  if (je+1 .eq. npy) then
    do i = max(3,is), min(npx-2,ie+1)
      aduc(i,npy) = aduc(i,npy)+adut(i,npy)
      advt(i-1,npy+1) = advt(i-1,npy+1)+0.25*adut(i,npy)*cosa_u(i,npy-1)
      advt(i,npy+1) = advt(i,npy+1)+0.25*adut(i,npy)*cosa_u(i,npy-1)
      advt(i-1,npy) = advt(i-1,npy)+0.25*adut(i,npy)*cosa_u(i,npy-1)
      advt(i,npy) = advt(i,npy)+0.25*adut(i,npy)*cosa_u(i,npy-1)
      adut(i,npy) = 0.
      aduc(i,npy-1) = aduc(i,npy-1)+adut(i,npy-1)
      advt(i-1,npy-1) = advt(i-1,npy-1)-0.25*adut(i,npy-1)*cosa_u(i,npy-1)
      advt(i,npy-1) = advt(i,npy-1)-0.25*adut(i,npy-1)*cosa_u(i,npy-1)
      advt(i-1,npy) = advt(i-1,npy)-0.25*adut(i,npy-1)*cosa_u(i,npy-1)
      advt(i,npy) = advt(i,npy)-0.25*adut(i,npy-1)*cosa_u(i,npy-1)
      adut(i,npy-1) = 0.
    end do
    do i = isd, ied
      advc(i,npy) = advc(i,npy)+advt(i,npy)*rsin_v(i,npy)
      advt(i,npy) = 0.
    end do
  endif
  if (js .eq. 1) then
    do i = max(3,is), min(npx-2,ie+1)
      aduc(i,1) = aduc(i,1)+adut(i,1)
      advt(i-1,2) = advt(i-1,2)-0.25*adut(i,1)*cosa_u(i,1)
      advt(i,2) = advt(i,2)-0.25*adut(i,1)*cosa_u(i,1)
      advt(i-1,1) = advt(i-1,1)-0.25*adut(i,1)*cosa_u(i,1)
      advt(i,1) = advt(i,1)-0.25*adut(i,1)*cosa_u(i,1)
      adut(i,1) = 0.
      aduc(i,0) = aduc(i,0)+adut(i,0)
      advt(i-1,1) = advt(i-1,1)+0.25*adut(i,0)*cosa_u(i,1)
      advt(i,1) = advt(i,1)+0.25*adut(i,0)*cosa_u(i,1)
      advt(i-1,0) = advt(i-1,0)+0.25*adut(i,0)*cosa_u(i,1)
      advt(i,0) = advt(i,0)+0.25*adut(i,0)*cosa_u(i,1)
      adut(i,0) = 0.
    end do
    do i = isd, ied
      advc(i,1) = advc(i,1)+advt(i,1)*rsin_v(i,1)
      advt(i,1) = 0.
    end do
  endif
  if (ie+1 .eq. npx) then
    do j = max(3,js), min(npy-2,je+1)
      adut(npx+1,j-1) = adut(npx+1,j-1)+0.25*advt(npx,j)*cosa_v(npx-1,j)
      adut(npx,j-1) = adut(npx,j-1)+0.25*advt(npx,j)*cosa_v(npx-1,j)
      adut(npx+1,j) = adut(npx+1,j)+0.25*advt(npx,j)*cosa_v(npx-1,j)
      adut(npx,j) = adut(npx,j)+0.25*advt(npx,j)*cosa_v(npx-1,j)
      advc(npx,j) = advc(npx,j)+advt(npx,j)
      advt(npx,j) = 0.
      adut(npx-1,j-1) = adut(npx-1,j-1)-0.25*advt(npx-1,j)*cosa_v(npx-1,j)
      adut(npx,j-1) = adut(npx,j-1)-0.25*advt(npx-1,j)*cosa_v(npx-1,j)
      adut(npx-1,j) = adut(npx-1,j)-0.25*advt(npx-1,j)*cosa_v(npx-1,j)
      adut(npx,j) = adut(npx,j)-0.25*advt(npx-1,j)*cosa_v(npx-1,j)
      advc(npx-1,j) = advc(npx-1,j)+advt(npx-1,j)
      advt(npx-1,j) = 0.
    end do
    do j = jsd, jed
      aduc(npx,j) = aduc(npx,j)+adut(npx,j)*rsin_u(npx,j)
      adut(npx,j) = 0.
    end do
  endif
  if (is .eq. 1) then
    do j = max(3,js), min(npy-2,je+1)
      adut(2,j-1) = adut(2,j-1)-0.25*advt(1,j)*cosa_v(1,j)
      adut(1,j-1) = adut(1,j-1)-0.25*advt(1,j)*cosa_v(1,j)
      adut(2,j) = adut(2,j)-0.25*advt(1,j)*cosa_v(1,j)
      adut(1,j) = adut(1,j)-0.25*advt(1,j)*cosa_v(1,j)
      advc(1,j) = advc(1,j)+advt(1,j)
      advt(1,j) = 0.
      adut(1,j-1) = adut(1,j-1)+0.25*advt(0,j)*cosa_v(1,j)
      adut(0,j-1) = adut(0,j-1)+0.25*advt(0,j)*cosa_v(1,j)
      adut(1,j) = adut(1,j)+0.25*advt(0,j)*cosa_v(1,j)
      adut(0,j) = adut(0,j)+0.25*advt(0,j)*cosa_v(1,j)
      advc(0,j) = advc(0,j)+advt(0,j)
      advt(0,j) = 0.
    end do
    do j = jsd, jed
      aduc(1,j) = aduc(1,j)+adut(1,j)*rsin_u(1,j)
      adut(1,j) = 0.
    end do
  endif
  do j = js-1, je+2
    if (j .ne. 1 .and. j .ne. npy) then
      do i = isd, ied
        aduc(i+1,j-1) = aduc(i+1,j-1)-0.25*advt(i,j)*cosa_v(i,j)*rsin_v(i,j)
        aduc(i,j-1) = aduc(i,j-1)-0.25*advt(i,j)*cosa_v(i,j)*rsin_v(i,j)
        aduc(i+1,j) = aduc(i+1,j)-0.25*advt(i,j)*cosa_v(i,j)*rsin_v(i,j)
        aduc(i,j) = aduc(i,j)-0.25*advt(i,j)*cosa_v(i,j)*rsin_v(i,j)
        advc(i,j) = advc(i,j)+advt(i,j)*rsin_v(i,j)
        advt(i,j) = 0.
      end do
    endif
  end do
  do j = jsd, jed
    if (j .ne. 0 .and. j .ne. 1 .and. j .ne. npy-1 .and. j .ne. npy) then
      do i = is-1, ie+2
        aduc(i,j) = aduc(i,j)+adut(i,j)*rsin_u(i,j)
        advc(i-1,j+1) = advc(i-1,j+1)-0.25*adut(i,j)*cosa_u(i,j)*rsin_u(i,j)
        advc(i,j+1) = advc(i,j+1)-0.25*adut(i,j)*cosa_u(i,j)*rsin_u(i,j)
        advc(i-1,j) = advc(i-1,j)-0.25*adut(i,j)*cosa_u(i,j)*rsin_u(i,j)
        advc(i,j) = advc(i,j)-0.25*adut(i,j)*cosa_u(i,j)*rsin_u(i,j)
        adut(i,j) = 0.
      end do
    endif
  end do
else
  do j = js-1, je+2
    do i = isd, ied
      advc(i,j) = advc(i,j)+advt(i,j)
      advt(i,j) = 0.
    end do
  end do
  do j = jsd, jed
    do i = is-1, ie+2
      aduc(i,j) = aduc(i,j)+adut(i,j)
      adut(i,j) = 0.
    end do
  end do
endif

end subroutine add_sw


subroutine addivergence_corner( adu, adv, adua, adva, addivg_d, km )
!******************************************************************
!******************************************************************
!** This routine was generated by Automatic differentiation.     **
!** FastOpt: Transformation of Algorithm in Fortran, TAF 1.9.50  **
!******************************************************************
!******************************************************************
!==============================================
! all entries are defined explicitly
!==============================================
implicit none

!==============================================
! declare arguments
!==============================================
integer, intent(in) :: km
real, intent(inout) :: addivg_d(isd:ied+1,jsd:jed+1,km)
real, intent(inout) :: adu(isd:ied,jsd:jed+1,km)
real, intent(inout) :: adua(isd:ied,jsd:jed,km)
real, intent(inout) :: adv(isd:ied+1,jsd:jed,km)
real, intent(inout) :: adva(isd:ied,jsd:jed,km)

!==============================================
! declare local variables
!==============================================
real :: aduf(is-2:ie+2,js-1:je+2)
real :: advf(is-1:ie+2,js-2:je+2)
integer :: i
integer :: ie1
integer :: is2
integer :: j
integer :: k

!----------------------------------------------
! RESET LOCAL ADJOINT VARIABLES
!----------------------------------------------
aduf(:,:) = 0.
advf(:,:) = 0.

!----------------------------------------------
! ROUTINE BODY
!----------------------------------------------
is2 = max(2,is)
ie1 = min(npx-1,ie+1)
do k = km, 1, -1
  if (grid_type .eq. 4) then
    do j = js-1, je+2
      do i = is-1, ie+2
        aduf(i-1,j) = aduf(i-1,j)+addivg_d(i,j,k)*rarea_c(i,j)
        aduf(i,j) = aduf(i,j)-addivg_d(i,j,k)*rarea_c(i,j)
        advf(i,j-1) = advf(i,j-1)+addivg_d(i,j,k)*rarea_c(i,j)
        advf(i,j) = advf(i,j)-addivg_d(i,j,k)*rarea_c(i,j)
        addivg_d(i,j,k) = 0.
      end do
    end do
    do j = js-2, je+2
      do i = is-1, ie+2
        adv(i,j,k) = adv(i,j,k)+advf(i,j)*dxc(i,j)
        advf(i,j) = 0.
      end do
    end do
    do j = js-1, je+2
      do i = is-2, ie+2
        adu(i,j,k) = adu(i,j,k)+aduf(i,j)*dyc(i,j)
        aduf(i,j) = 0.
      end do
    end do
  else
    do j = js, je+1
      do i = is, ie+1
        addivg_d(i,j,k) = addivg_d(i,j,k)*rarea_c(i,j)
      end do
    end do
    if (nw_corner) then
      advf(1,npy) = advf(1,npy)+addivg_d(1,npy,k)
    endif
    if (ne_corner) then
      advf(npx,npy) = advf(npx,npy)+addivg_d(npx,npy,k)
    endif
    if (se_corner) then
      advf(npx,0) = advf(npx,0)-addivg_d(npx,1,k)
    endif
    if (sw_corner) then
      advf(1,0) = advf(1,0)-addivg_d(1,1,k)
    endif
    do j = js, je+1
      do i = is, ie+1
        aduf(i-1,j) = aduf(i-1,j)+addivg_d(i,j,k)
        aduf(i,j) = aduf(i,j)-addivg_d(i,j,k)
        advf(i,j-1) = advf(i,j-1)+addivg_d(i,j,k)
        advf(i,j) = advf(i,j)-addivg_d(i,j,k)
        addivg_d(i,j,k) = 0.
      end do
    end do
    do j = js-1, je+1
      if (ie+1 .eq. npx) then
        adv(npx,j,k) = adv(npx,j,k)+advf(npx,j)*dxc(npx,j)*sina_u(npx,j)
        advf(npx,j) = 0.
      endif
      if (is .eq. 1) then
        adv(1,j,k) = adv(1,j,k)+advf(1,j)*dxc(1,j)*sina_u(1,j)
        advf(1,j) = 0.
      endif
      do i = is2, ie1
        adua(i-1,j,k) = adua(i-1,j,k)-0.5*advf(i,j)*cosa_u(i,j)*dxc(i,j)*sina_u(i,j)
        adua(i,j,k) = adua(i,j,k)-0.5*advf(i,j)*cosa_u(i,j)*dxc(i,j)*sina_u(i,j)
        adv(i,j,k) = adv(i,j,k)+advf(i,j)*dxc(i,j)*sina_u(i,j)
        advf(i,j) = 0.
      end do
    end do
    do j = js, je+1
      if (j .eq. 1 .or. j .eq. npy) then
        do i = is-1, ie+1
          adu(i,j,k) = adu(i,j,k)+aduf(i,j)*dyc(i,j)*sina_v(i,j)
          aduf(i,j) = 0.
        end do
      else
        do i = is-1, ie+1
          adu(i,j,k) = adu(i,j,k)+aduf(i,j)*dyc(i,j)*sina_v(i,j)
          adva(i,j-1,k) = adva(i,j-1,k)-0.5*aduf(i,j)*cosa_v(i,j)*dyc(i,j)*sina_v(i,j)
          adva(i,j,k) = adva(i,j,k)-0.5*aduf(i,j)*cosa_v(i,j)*dyc(i,j)*sina_v(i,j)
          aduf(i,j) = 0.
        end do
      endif
    end do
  endif
end do

end subroutine addivergence_corner


subroutine adfill2_4corners( adq1, adq2, dir )
!******************************************************************
!******************************************************************
!** This routine was generated by Automatic differentiation.     **
!** FastOpt: Transformation of Algorithm in Fortran, TAF 1.9.50  **
!******************************************************************
!******************************************************************
!==============================================
! all entries are defined explicitly
!==============================================
implicit none

!==============================================
! declare arguments
!==============================================
real, intent(inout) :: adq1(isd:ied,jsd:jed)
real, intent(inout) :: adq2(isd:ied,jsd:jed)
integer, intent(in) :: dir

!----------------------------------------------
! ROUTINE BODY
!----------------------------------------------
if (dir .eq. 2) then
  if (ne_corner) then
    adq2(npx-2,npy) = adq2(npx-2,npy)+adq2(npx,npy+1)
    adq2(npx,npy+1) = 0.
    adq2(npx-1,npy) = adq2(npx-1,npy)+adq2(npx,npy)
    adq2(npx,npy) = 0.
    adq1(npx-2,npy) = adq1(npx-2,npy)+adq1(npx,npy+1)
    adq1(npx,npy+1) = 0.
    adq1(npx-1,npy) = adq1(npx-1,npy)+adq1(npx,npy)
    adq1(npx,npy) = 0.
  endif
  if (nw_corner) then
    adq2(2,npy) = adq2(2,npy)+adq2(0,npy+1)
    adq2(0,npy+1) = 0.
    adq2(1,npy) = adq2(1,npy)+adq2(0,npy)
    adq2(0,npy) = 0.
    adq1(2,npy) = adq1(2,npy)+adq1(0,npy+1)
    adq1(0,npy+1) = 0.
    adq1(1,npy) = adq1(1,npy)+adq1(0,npy)
    adq1(0,npy) = 0.
  endif
  if (se_corner) then
    adq2(npx-2,0) = adq2(npx-2,0)+adq2(npx,-1)
    adq2(npx,-1) = 0.
    adq2(npx-1,0) = adq2(npx-1,0)+adq2(npx,0)
    adq2(npx,0) = 0.
    adq1(npx-2,0) = adq1(npx-2,0)+adq1(npx,-1)
    adq1(npx,-1) = 0.
    adq1(npx-1,0) = adq1(npx-1,0)+adq1(npx,0)
    adq1(npx,0) = 0.
  endif
  if (sw_corner) then
    adq2(2,0) = adq2(2,0)+adq2(0,-1)
    adq2(0,-1) = 0.
    adq2(1,0) = adq2(1,0)+adq2(0,0)
    adq2(0,0) = 0.
    adq1(2,0) = adq1(2,0)+adq1(0,-1)
    adq1(0,-1) = 0.
    adq1(1,0) = adq1(1,0)+adq1(0,0)
    adq1(0,0) = 0.
  endif
endif
if (dir .eq. 1) then
  if (ne_corner) then
    adq2(npx,npy-2) = adq2(npx,npy-2)+adq2(npx+1,npy)
    adq2(npx+1,npy) = 0.
    adq2(npx,npy-1) = adq2(npx,npy-1)+adq2(npx,npy)
    adq2(npx,npy) = 0.
    adq1(npx,npy-2) = adq1(npx,npy-2)+adq1(npx+1,npy)
    adq1(npx+1,npy) = 0.
    adq1(npx,npy-1) = adq1(npx,npy-1)+adq1(npx,npy)
    adq1(npx,npy) = 0.
  endif
  if (nw_corner) then
    adq2(0,npy-2) = adq2(0,npy-2)+adq2(-1,npy)
    adq2(-1,npy) = 0.
    adq2(0,npy-1) = adq2(0,npy-1)+adq2(0,npy)
    adq2(0,npy) = 0.
    adq1(0,npy-2) = adq1(0,npy-2)+adq1(-1,npy)
    adq1(-1,npy) = 0.
    adq1(0,npy-1) = adq1(0,npy-1)+adq1(0,npy)
    adq1(0,npy) = 0.
  endif
  if (se_corner) then
    adq2(npx,1) = adq2(npx,1)+adq2(npx,0)
    adq2(npx,0) = 0.
    adq2(npx,2) = adq2(npx,2)+adq2(npx+1,0)
    adq2(npx+1,0) = 0.
    adq1(npx,1) = adq1(npx,1)+adq1(npx,0)
    adq1(npx,0) = 0.
    adq1(npx,2) = adq1(npx,2)+adq1(npx+1,0)
    adq1(npx+1,0) = 0.
  endif
  if (sw_corner) then
    adq2(0,1) = adq2(0,1)+adq2(0,0)
    adq2(0,0) = 0.
    adq2(0,2) = adq2(0,2)+adq2(-1,0)
    adq2(-1,0) = 0.
    adq1(0,1) = adq1(0,1)+adq1(0,0)
    adq1(0,0) = 0.
    adq1(0,2) = adq1(0,2)+adq1(-1,0)
    adq1(-1,0) = 0.
  endif
endif

end subroutine adfill2_4corners


subroutine adfill_4corners( adq, dir )
!******************************************************************
!******************************************************************
!** This routine was generated by Automatic differentiation.     **
!** FastOpt: Transformation of Algorithm in Fortran, TAF 1.9.50  **
!******************************************************************
!******************************************************************
!==============================================
! all entries are defined explicitly
!==============================================
implicit none

!==============================================
! declare arguments
!==============================================
real, intent(inout) :: adq(isd:ied,jsd:jed)
integer, intent(in) :: dir

!----------------------------------------------
! ROUTINE BODY
!----------------------------------------------
if (dir .eq. 2) then
  if (ne_corner) then
    adq(npx-2,npy) = adq(npx-2,npy)+adq(npx,npy+1)
    adq(npx,npy+1) = 0.
    adq(npx-1,npy) = adq(npx-1,npy)+adq(npx,npy)
    adq(npx,npy) = 0.
  endif
  if (nw_corner) then
    adq(2,npy) = adq(2,npy)+adq(0,npy+1)
    adq(0,npy+1) = 0.
    adq(1,npy) = adq(1,npy)+adq(0,npy)
    adq(0,npy) = 0.
  endif
  if (se_corner) then
    adq(npx-2,0) = adq(npx-2,0)+adq(npx,-1)
    adq(npx,-1) = 0.
    adq(npx-1,0) = adq(npx-1,0)+adq(npx,0)
    adq(npx,0) = 0.
  endif
  if (sw_corner) then
    adq(2,0) = adq(2,0)+adq(0,-1)
    adq(0,-1) = 0.
    adq(1,0) = adq(1,0)+adq(0,0)
    adq(0,0) = 0.
  endif
endif
if (dir .eq. 1) then
  if (ne_corner) then
    adq(npx,npy-2) = adq(npx,npy-2)+adq(npx+1,npy)
    adq(npx+1,npy) = 0.
    adq(npx,npy-1) = adq(npx,npy-1)+adq(npx,npy)
    adq(npx,npy) = 0.
  endif
  if (nw_corner) then
    adq(0,npy-2) = adq(0,npy-2)+adq(-1,npy)
    adq(-1,npy) = 0.
    adq(0,npy-1) = adq(0,npy-1)+adq(0,npy)
    adq(0,npy) = 0.
  endif
  if (se_corner) then
    adq(npx,1) = adq(npx,1)+adq(npx,0)
    adq(npx,0) = 0.
    adq(npx,2) = adq(npx,2)+adq(npx+1,0)
    adq(npx+1,0) = 0.
  endif
  if (sw_corner) then
    adq(0,1) = adq(0,1)+adq(0,0)
    adq(0,0) = 0.
    adq(0,2) = adq(0,2)+adq(-1,0)
    adq(-1,0) = 0.
  endif
endif

end subroutine adfill_4corners


subroutine adxtp_u( c, adc, u, adu, adflux, iord )
!******************************************************************
!******************************************************************
!** This routine was generated by Automatic differentiation.     **
!** FastOpt: Transformation of Algorithm in Fortran, TAF 1.9.50  **
!******************************************************************
!******************************************************************
!==============================================
! referencing used modules
!==============================================
use adtp_core_mod, only : adpert_ppm

!==============================================
! all entries are defined explicitly
!==============================================
implicit none

!==============================================
! declare parameters
!==============================================
real, parameter :: r3 = 1./3.
real, parameter :: s11 = 11./14.
real, parameter :: s14 = 4./7.
real, parameter :: s15 = 3./14.

!==============================================
! declare arguments
!==============================================
real, intent(inout) :: adc(is:ie+1,js:je+1)
real, intent(inout) :: adflux(is:ie+1,js:je+1)
real, intent(inout) :: adu(isd:ied,jsd:jed+1)
real, intent(in) :: c(is:ie+1,js:je+1)
integer, intent(in) :: iord
real, intent(in) :: u(isd:ied,jsd:jed+1)

!==============================================
! declare local variables
!==============================================
real :: adal(is-1:ie+2)
real :: adbl(is-1:ie+1)
real :: adbl0
real :: adblr
real :: adbls
real :: adblt
real :: adblu
real :: adblv
real :: adblw
real :: adblx
real :: adbly
real :: adblz
real :: adbr(is-1:ie+1)
real :: adbr0
real :: adbrr
real :: adbrs
real :: adbrt
real :: adbru
real :: adbrv
real :: adbrw
real :: adbrx
real :: adbry
real :: adbrz
real :: adcfl
real :: addl
real :: addlh
real :: addli
real :: addlj
real :: addlk
real :: addm(is-2:ie+2)
real :: addm0
real :: addm1
real :: addm2
real :: addm3
real :: addm4
real :: addm5
real :: addmj
real :: addmq
real :: addmr
real :: addms
real :: addmt
real :: addmu
real :: addmv
real :: addmw
real :: addmx
real :: addmy
real :: addq(is-3:ie+2)
real :: addr
real :: addrh
real :: addri
real :: addrj
real :: addrk
real :: adlac
real :: adpmp
real :: adxt
real :: al(is-1:ie+2)
real :: bl(is-1:ie+1)
real :: bl0
real :: blr
real :: bls
real :: blt
real :: blu
real :: blv
real :: blw
real :: blx
real :: bly
real :: blz
real :: br(is-1:ie+1)
real :: br0
real :: brr
real :: brs
real :: brt
real :: bru
real :: brv
real :: brw
real :: brx
real :: bry
real :: brz
real :: cfl
real :: dl
real :: dli
real :: dlj
real :: dm(is-2:ie+2)
real :: dm0
real :: dmj
real :: dmm
real :: dmp
real :: dmq
real :: dmr
real :: dms
real :: dmt
real :: dmu
real :: dmw
real :: dmx
real :: dmz
real :: dq(is-3:ie+2)
real :: dr
real :: dri
real :: drj
integer :: help_h
integer :: help_i
integer :: i
integer :: j
real :: lac
real :: pmp
real, allocatable :: tape_xtp_u_bl_1h(:,:)
real, allocatable :: tape_xtp_u_br_2h(:,:)
integer :: tape_xtp_u_xtp_u
real :: xt
real :: xti

!----------------------------------------------
! RESET LOCAL ADJOINT VARIABLES
!----------------------------------------------
adal(:) = 0.
adbl(:) = 0.
adbr(:) = 0.
adcfl = 0.
addl = 0.
addm(:) = 0.
addq(:) = 0.
addr = 0.
adlac = 0.
adpmp = 0.
adxt = 0.

!----------------------------------------------
! ROUTINE BODY
!----------------------------------------------
if (iord .eq. 1) then
  do j = js, je+1
    do i = is, ie+1
      if (c(i,j) .gt. 0.) then
        adu(i-1,j) = adu(i-1,j)+adflux(i,j)
        adflux(i,j) = 0.
      else
        adu(i,j) = adu(i,j)+adflux(i,j)
        adflux(i,j) = 0.
      endif
    end do
  end do
else if (iord .le. 4) then
  do j = je+1, js, -1
    adcfl = 0.
    addl = 0.
    addr = 0.
    adxt = 0.
    do i = is-2, ie+2
      xt = 0.25*(u(i+1,j)-u(i-1,j))
      dm(i) = sign(min(abs(xt),max(u(i-1,j),u(i,j),u(i+1,j))-u(i,j),u(i,j)-min(u(i-1,j),u(i,j),u(i+1,j))),xt)
    end do
    if (j .eq. 1 .or. j .eq. npy) then
      if (is .eq. 1) then
        dm(1) = 0.
      endif
      if (ie+1 .eq. npx) then
        dm(ie) = 0.
      endif
    endif
    do i = is-1, ie+2
      al(i) = 0.5*(u(i-1,j)+u(i,j))+r3*(dm(i-1)-dm(i))
    end do
    do i = ie+1, is, -1
      adcfl = 0.
      addl = 0.
      addr = 0.
      adxt = 0.
      if (c(i,j) .gt. 0.) then
        xt = 2.*dm(i-1)
        dl = sign(min(abs(xt),abs(al(i-1)-u(i-1,j))),xt)
        dr = sign(min(abs(xt),abs(al(i)-u(i-1,j))),xt)
        cfl = c(i,j)*rdx(i-1,j)
        adcfl = adcfl+adflux(i,j)*((1.-cfl)*(dl-dr)-(dr+cfl*(dl-dr)))
        addl = addl+adflux(i,j)*(1.-cfl)*cfl
        addr = addr+adflux(i,j)*(1.-cfl)*(1-cfl)
        adu(i-1,j) = adu(i-1,j)+adflux(i,j)
        adflux(i,j) = 0.
        adc(i,j) = adc(i,j)+adcfl*rdx(i-1,j)
        adcfl = 0.
        drj = al(i)-u(i-1,j)
        addrj = addr*sign(1.,min(abs(xt),abs(drj)))*sign(1.,xt)
        addrk = addrj*(0.5-sign(0.5,abs(drj)-abs(xt)))*sign(1.,drj)
        adxt = adxt+addrj*(0.5+sign(0.5,abs(drj)-abs(xt)))*sign(1.,xt)
        adal(i) = adal(i)+addrk
        adu(i-1,j) = adu(i-1,j)-addrk
        addr = 0.
        dlj = al(i-1)-u(i-1,j)
        addlj = addl*sign(1.,min(abs(xt),abs(dlj)))*sign(1.,xt)
        addlk = addlj*(0.5-sign(0.5,abs(dlj)-abs(xt)))*sign(1.,dlj)
        adxt = adxt+addlj*(0.5+sign(0.5,abs(dlj)-abs(xt)))*sign(1.,xt)
        adal(i-1) = adal(i-1)+addlk
        adu(i-1,j) = adu(i-1,j)-addlk
        addl = 0.
        addm(i-1) = addm(i-1)+2*adxt
        adxt = 0.
      else
        xt = 2.*dm(i)
        dl = sign(min(abs(xt),abs(al(i)-u(i,j))),xt)
        dr = sign(min(abs(xt),abs(al(i+1)-u(i,j))),xt)
        cfl = c(i,j)*rdx(i,j)
        adcfl = adcfl-adflux(i,j)*((1.+cfl)*(dl-dr)+dl+cfl*(dl-dr))
        addl = addl-adflux(i,j)*(1.+cfl)*(1+cfl)
        addr = addr+adflux(i,j)*(1.+cfl)*cfl
        adu(i,j) = adu(i,j)+adflux(i,j)
        adflux(i,j) = 0.
        adc(i,j) = adc(i,j)+adcfl*rdx(i,j)
        adcfl = 0.
        dri = al(i+1)-u(i,j)
        addrh = addr*sign(1.,min(abs(xt),abs(dri)))*sign(1.,xt)
        addri = addrh*(0.5-sign(0.5,abs(dri)-abs(xt)))*sign(1.,dri)
        adxt = adxt+addrh*(0.5+sign(0.5,abs(dri)-abs(xt)))*sign(1.,xt)
        adal(i+1) = adal(i+1)+addri
        adu(i,j) = adu(i,j)-addri
        addr = 0.
        dli = al(i)-u(i,j)
        addlh = addl*sign(1.,min(abs(xt),abs(dli)))*sign(1.,xt)
        addli = addlh*(0.5-sign(0.5,abs(dli)-abs(xt)))*sign(1.,dli)
        adxt = adxt+addlh*(0.5+sign(0.5,abs(dli)-abs(xt)))*sign(1.,xt)
        adal(i) = adal(i)+addli
        adu(i,j) = adu(i,j)-addli
        addl = 0.
        addm(i) = addm(i)+2*adxt
        adxt = 0.
      endif
    end do
    do i = is-1, ie+2
      addm(i-1) = addm(i-1)+adal(i)*r3
      addm(i) = addm(i)-adal(i)*r3
      adu(i-1,j) = adu(i-1,j)+0.5*adal(i)
      adu(i,j) = adu(i,j)+0.5*adal(i)
      adal(i) = 0.
    end do
    if (j .eq. 1 .or. j .eq. npy) then
      if (ie+1 .eq. npx) then
        addm(ie) = 0.
      endif
      if (is .eq. 1) then
        addm(1) = 0.
      endif
    endif
    do i = ie+2, is-2, -1
      adxt = 0.
      xt = 0.25*(u(i+1,j)-u(i-1,j))
      dmp = abs(xt)
      dms = max(u(i-1,j),u(i,j))
      dmw = max(dms,u(i+1,j))-u(i,j)
      dmx = min(u(i-1,j),u(i,j))
      dmz = u(i,j)-min(dmx,u(i+1,j))
      dm0 = min(dmp,dmw)
      addm5 = addm(i)*sign(1.,min(dm0,dmz))*sign(1.,xt)
      addm4 = addm5*(0.5+sign(0.5,dmz-dm0))
      addm3 = addm5*(0.5-sign(0.5,dmz-dm0))
      addmr = addm4*(0.5+sign(0.5,dmw-dmp))
      addm0 = addm4*(0.5-sign(0.5,dmw-dmp))
      addm2 = -addm3
      adu(i,j) = adu(i,j)+addm3
      addm1 = addm2*(0.5+sign(0.5,u(i+1,j)-dmx))
      adu(i+1,j) = adu(i+1,j)+addm2*(0.5-sign(0.5,u(i+1,j)-dmx))
      adu(i-1,j) = adu(i-1,j)+addm1*(0.5+sign(0.5,u(i,j)-u(i-1,j)))
      adu(i,j) = adu(i,j)+addm1*(0.5-sign(0.5,u(i,j)-u(i-1,j)))
      adu(i,j) = adu(i,j)-addm0
      addmy = addm0*(0.5+sign(0.5,dms-u(i+1,j)))
      adu(i+1,j) = adu(i+1,j)+addm0*(0.5-sign(0.5,dms-u(i+1,j)))
      adu(i-1,j) = adu(i-1,j)+addmy*(0.5+sign(0.5,u(i-1,j)-u(i,j)))
      adu(i,j) = adu(i,j)+addmy*(0.5-sign(0.5,u(i-1,j)-u(i,j)))
      adxt = adxt+addmr*sign(1.,xt)
      addm(i) = 0.
      adu(i-1,j) = adu(i-1,j)-0.25*adxt
      adu(i+1,j) = adu(i+1,j)+0.25*adxt
      adxt = 0.
    end do
  end do
else
!----------------------------------------------
! OPEN TAPE tape_xtp_u
!----------------------------------------------
  tape_xtp_u_xtp_u = je+1-js+1

!----------------------------------------------
! TAPE COMPUTATIONS
!----------------------------------------------
  do j = js, je
    if ( .not. allocated(tape_xtp_u_bl_1h)) then
      allocate( tape_xtp_u_bl_1h(is-1:ie+1,tape_xtp_u_xtp_u) )
    endif
    tape_xtp_u_bl_1h(:,j-js+1) = bl
    if ( .not. allocated(tape_xtp_u_br_2h)) then
      allocate( tape_xtp_u_br_2h(is-1:ie+1,tape_xtp_u_xtp_u) )
    endif
    tape_xtp_u_br_2h(:,j-js+1) = br
    do i = is-2, ie+2
      xt = 0.25*(u(i+1,j)-u(i-1,j))
      dm(i) = sign(min(abs(xt),max(u(i-1,j),u(i,j),u(i+1,j))-u(i,j),u(i,j)-min(u(i-1,j),u(i,j),u(i+1,j))),xt)
    end do
    do i = is-3, ie+2
      dq(i) = u(i+1,j)-u(i,j)
    end do
    if (grid_type .lt. 3) then
      do i = max(3,is-1), min(npx-2,ie+2)
        al(i) = 0.5*(u(i-1,j)+u(i,j))+r3*(dm(i-1)-dm(i))
      end do
      if (iord .lt. 10) then
        do i = max(3,is-1), min(npx-3,ie+1)
          pmp = 2.*dq(i-1)
          lac = pmp-1.5*dq(i-2)
          br(i) = min(max(0.,pmp,lac),max(al(i+1)-u(i,j),min(0.,pmp,lac)))
          pmp = -(2.*dq(i))
          lac = pmp+1.5*dq(i+1)
          bl(i) = min(max(0.,pmp,lac),max(al(i)-u(i,j),min(0.,pmp,lac)))
        end do
      else
        do i = max(3,is-1), min(npx-3,ie+1)
          bl(i) = al(i)-u(i,j)
          br(i) = al(i+1)-u(i,j)
        end do
      endif
      if (is .eq. 1) then
        br(2) = al(3)-u(2,j)
        xt = s15*u(1,j)+s11*u(2,j)-s14*dm(2)
        bl(2) = xt-u(2,j)
        br(1) = xt-u(1,j)
        if (j .eq. 1 .or. j .eq. npy) then
          bl(0) = 0.
          br(0) = 0.
          bl(1) = 0.
          br(1) = 0.
        else
          bl(0) = s14*dm(-1)-s11*dq(-1)
          xt = 0.5*((2.*dx(1,j)+dx(2,j))*(u(0,j)+u(1,j))-dx(1,j)*(u(-1,j)+u(2,j)))/(dx(1,j)+dx(2,j))
          br(0) = xt-u(0,j)
          bl(1) = xt-u(1,j)
        endif
        if (iord .lt. 10) then
          help_h = -1
          call pert_ppm( 1,u(2,j),bl(2),br(2),help_h )
        endif
      endif
      if (ie+1 .eq. npx) then
        bl(npx-2) = al(npx-2)-u(npx-2,j)
        xt = s15*u(npx-1,j)+s11*u(npx-2,j)+s14*dm(npx-2)
        br(npx-2) = xt-u(npx-2,j)
        bl(npx-1) = xt-u(npx-1,j)
        if (j .eq. 1 .or. j .eq. npy) then
          bl(npx-1) = 0.
          br(npx-1) = 0.
          bl(npx) = 0.
          br(npx) = 0.
        else
          br(npx) = s11*dq(npx)-s14*dm(npx+1)
          xt = 0.5*((2.*dx(npx-1,j)+dx(npx-2,j))*(u(npx-1,j)+u(npx,j))-dx(npx-1,j)*(u(npx-2,j)+u(npx+1,j)))/(dx(npx-1,j)+dx(npx-2,&
&j))
          br(npx-1) = xt-u(npx-1,j)
          bl(npx) = xt-u(npx,j)
        endif
        if (iord .lt. 10) then
          help_i = -1
          call pert_ppm( 1,u(npx-2,j),bl(npx-2),br(npx-2),help_i )
        endif
      endif
    else
      do i = is-1, ie+2
        al(i) = 0.5*(u(i-1,j)+u(i,j))+r3*(dm(i-1)-dm(i))
      end do
      do i = is-1, ie+1
        pmp = -(2.*dq(i))
        lac = pmp+1.5*dq(i+1)
        bl(i) = min(max(0.,pmp,lac),max(al(i)-u(i,j),min(0.,pmp,lac)))
        pmp = 2.*dq(i-1)
        lac = pmp-1.5*dq(i-2)
        br(i) = min(max(0.,pmp,lac),max(al(i+1)-u(i,j),min(0.,pmp,lac)))
      end do
    endif
  end do
  j = je+1
  if ( .not. allocated(tape_xtp_u_bl_1h)) then
    allocate( tape_xtp_u_bl_1h(is-1:ie+1,tape_xtp_u_xtp_u) )
  endif
  tape_xtp_u_bl_1h(:,j-js+1) = bl
  if ( .not. allocated(tape_xtp_u_br_2h)) then
    allocate( tape_xtp_u_br_2h(is-1:ie+1,tape_xtp_u_xtp_u) )
  endif
  tape_xtp_u_br_2h(:,j-js+1) = br

!----------------------------------------------
! ADJOINT COMPUTATIONS
!----------------------------------------------
  do j = je+1, js, -1
    do i = is-2, ie+2
      xt = 0.25*(u(i+1,j)-u(i-1,j))
      dm(i) = sign(min(abs(xt),max(u(i-1,j),u(i,j),u(i+1,j))-u(i,j),u(i,j)-min(u(i-1,j),u(i,j),u(i+1,j))),xt)
    end do
    do i = is-3, ie+2
      dq(i) = u(i+1,j)-u(i,j)
    end do
    if (grid_type .lt. 3) then
      do i = max(3,is-1), min(npx-2,ie+2)
        al(i) = 0.5*(u(i-1,j)+u(i,j))+r3*(dm(i-1)-dm(i))
      end do
      if (iord .lt. 10) then
        do i = max(3,is-1), min(npx-3,ie+1)
          pmp = 2.*dq(i-1)
          lac = pmp-1.5*dq(i-2)
          br(i) = min(max(0.,pmp,lac),max(al(i+1)-u(i,j),min(0.,pmp,lac)))
          pmp = -(2.*dq(i))
          lac = pmp+1.5*dq(i+1)
          bl(i) = min(max(0.,pmp,lac),max(al(i)-u(i,j),min(0.,pmp,lac)))
        end do
      else
        do i = max(3,is-1), min(npx-3,ie+1)
          bl(i) = al(i)-u(i,j)
          br(i) = al(i+1)-u(i,j)
        end do
      endif
      if (is .eq. 1) then
        br(2) = al(3)-u(2,j)
        xt = s15*u(1,j)+s11*u(2,j)-s14*dm(2)
        bl(2) = xt-u(2,j)
        br(1) = xt-u(1,j)
        if (j .eq. 1 .or. j .eq. npy) then
          bl(0) = 0.
          br(0) = 0.
          bl(1) = 0.
          br(1) = 0.
        else
          bl(0) = s14*dm(-1)-s11*dq(-1)
          xt = 0.5*((2.*dx(1,j)+dx(2,j))*(u(0,j)+u(1,j))-dx(1,j)*(u(-1,j)+u(2,j)))/(dx(1,j)+dx(2,j))
          br(0) = xt-u(0,j)
          bl(1) = xt-u(1,j)
        endif
        if (iord .lt. 10) then
          help_h = -1
          call pert_ppm( 1,u(2,j),bl(2),br(2),help_h )
        endif
      endif
      if (ie+1 .eq. npx) then
        bl(npx-2) = al(npx-2)-u(npx-2,j)
        xt = s15*u(npx-1,j)+s11*u(npx-2,j)+s14*dm(npx-2)
        br(npx-2) = xt-u(npx-2,j)
        bl(npx-1) = xt-u(npx-1,j)
        if (j .eq. 1 .or. j .eq. npy) then
          bl(npx-1) = 0.
          br(npx-1) = 0.
          bl(npx) = 0.
          br(npx) = 0.
        else
          br(npx) = s11*dq(npx)-s14*dm(npx+1)
          xt = 0.5*((2.*dx(npx-1,j)+dx(npx-2,j))*(u(npx-1,j)+u(npx,j))-dx(npx-1,j)*(u(npx-2,j)+u(npx+1,j)))/(dx(npx-1,j)+dx(npx-2,&
&j))
          br(npx-1) = xt-u(npx-1,j)
          bl(npx) = xt-u(npx,j)
        endif
        if (iord .lt. 10) then
          help_i = -1
          call pert_ppm( 1,u(npx-2,j),bl(npx-2),br(npx-2),help_i )
        endif
      endif
    else
      do i = is-1, ie+2
        al(i) = 0.5*(u(i-1,j)+u(i,j))+r3*(dm(i-1)-dm(i))
      end do
      do i = is-1, ie+1
        pmp = -(2.*dq(i))
        lac = pmp+1.5*dq(i+1)
        bl(i) = min(max(0.,pmp,lac),max(al(i)-u(i,j),min(0.,pmp,lac)))
        pmp = 2.*dq(i-1)
        lac = pmp-1.5*dq(i-2)
        br(i) = min(max(0.,pmp,lac),max(al(i+1)-u(i,j),min(0.,pmp,lac)))
      end do
    endif
    do i = ie+1, is, -1
      adcfl = 0.
      if (c(i,j) .gt. 0.) then
        cfl = c(i,j)*rdx(i-1,j)
        adbl(i-1) = adbl(i-1)-adflux(i,j)*(1.-cfl)*cfl
        adbr(i-1) = adbr(i-1)+adflux(i,j)*(1.-cfl)*(1-cfl)
        adcfl = adcfl+adflux(i,j)*((-((1.-cfl)*(bl(i-1)+br(i-1))))-(br(i-1)-cfl*(bl(i-1)+br(i-1))))
        adu(i-1,j) = adu(i-1,j)+adflux(i,j)
        adflux(i,j) = 0.
        adc(i,j) = adc(i,j)+adcfl*rdx(i-1,j)
        adcfl = 0.
      else
        cfl = c(i,j)*rdx(i,j)
        adbl(i) = adbl(i)+adflux(i,j)*(1.+cfl)*(1+cfl)
        adbr(i) = adbr(i)+adflux(i,j)*(1.+cfl)*cfl
        adcfl = adcfl+adflux(i,j)*((1.+cfl)*(bl(i)+br(i))+bl(i)+cfl*(bl(i)+br(i)))
        adu(i,j) = adu(i,j)+adflux(i,j)
        adflux(i,j) = 0.
        adc(i,j) = adc(i,j)+adcfl*rdx(i,j)
        adcfl = 0.
      endif
    end do
    bl = tape_xtp_u_bl_1h(:,j-js+1)
    br = tape_xtp_u_br_2h(:,j-js+1)
    if (grid_type .lt. 3) then
      if (iord .lt. 10) then
        do i = max(3,is-1), min(npx-3,ie+1)
          pmp = 2.*dq(i-1)
          lac = pmp-1.5*dq(i-2)
          br(i) = min(max(0.,pmp,lac),max(al(i+1)-u(i,j),min(0.,pmp,lac)))
          pmp = -(2.*dq(i))
          lac = pmp+1.5*dq(i+1)
          bl(i) = min(max(0.,pmp,lac),max(al(i)-u(i,j),min(0.,pmp,lac)))
        end do
      else
        do i = max(3,is-1), min(npx-3,ie+1)
          bl(i) = al(i)-u(i,j)
          br(i) = al(i+1)-u(i,j)
        end do
      endif
      if (is .eq. 1) then
        br(2) = al(3)-u(2,j)
        xt = s15*u(1,j)+s11*u(2,j)-s14*dm(2)
        bl(2) = xt-u(2,j)
        br(1) = xt-u(1,j)
        if (j .eq. 1 .or. j .eq. npy) then
          bl(0) = 0.
          br(0) = 0.
          bl(1) = 0.
          br(1) = 0.
        else
          bl(0) = s14*dm(-1)-s11*dq(-1)
          xt = 0.5*((2.*dx(1,j)+dx(2,j))*(u(0,j)+u(1,j))-dx(1,j)*(u(-1,j)+u(2,j)))/(dx(1,j)+dx(2,j))
          br(0) = xt-u(0,j)
          bl(1) = xt-u(1,j)
        endif
        if (iord .lt. 10) then
          call pert_ppm( 1,u(2,j),bl(2),br(2),help_h )
        endif
      endif
      if (ie+1 .eq. npx) then
        xti = xt
        bl(npx-2) = al(npx-2)-u(npx-2,j)
        xt = s15*u(npx-1,j)+s11*u(npx-2,j)+s14*dm(npx-2)
        br(npx-2) = xt-u(npx-2,j)
        bl(npx-1) = xt-u(npx-1,j)
        xt = xti
        if (j .eq. 1 .or. j .eq. npy) then
          bl(npx-1) = 0.
          br(npx-1) = 0.
          bl(npx) = 0.
          br(npx) = 0.
        else
          br(npx) = s11*dq(npx)-s14*dm(npx+1)
          br(npx-1) = xt-u(npx-1,j)
          bl(npx) = xt-u(npx,j)
        endif
        if (iord .lt. 10) then
          call adpert_ppm( 1,u(npx-2,j),adu(npx-2,j),bl(npx-2),adbl(npx-2),br(npx-2),adbr(npx-2),help_i )
        endif
        if (j .eq. 1 .or. j .eq. npy) then
          adbr(npx) = 0.
          adbl(npx) = 0.
          adbr(npx-1) = 0.
          adbl(npx-1) = 0.
        else
          adu(npx,j) = adu(npx,j)-adbl(npx)
          adxt = adxt+adbl(npx)
          adbl(npx) = 0.
          adu(npx-1,j) = adu(npx-1,j)-adbr(npx-1)
          adxt = adxt+adbr(npx-1)
          adbr(npx-1) = 0.
          adu(npx-2,j) = adu(npx-2,j)-adxt*(0.5*dx(npx-1,j)/(dx(npx-1,j)+dx(npx-2,j)))
          adu(npx-1,j) = adu(npx-1,j)+adxt*(0.5*(2.*dx(npx-1,j)+dx(npx-2,j))/(dx(npx-1,j)+dx(npx-2,j)))
          adu(npx+1,j) = adu(npx+1,j)-adxt*(0.5*dx(npx-1,j)/(dx(npx-1,j)+dx(npx-2,j)))
          adu(npx,j) = adu(npx,j)+adxt*(0.5*(2.*dx(npx-1,j)+dx(npx-2,j))/(dx(npx-1,j)+dx(npx-2,j)))
          adxt = 0.
          addm(npx+1) = addm(npx+1)-adbr(npx)*s14
          addq(npx) = addq(npx)+adbr(npx)*s11
          adbr(npx) = 0.
        endif
        adu(npx-1,j) = adu(npx-1,j)-adbl(npx-1)
        adxt = adxt+adbl(npx-1)
        adbl(npx-1) = 0.
        adu(npx-2,j) = adu(npx-2,j)-adbr(npx-2)
        adxt = adxt+adbr(npx-2)
        adbr(npx-2) = 0.
        addm(npx-2) = addm(npx-2)+adxt*s14
        adu(npx-2,j) = adu(npx-2,j)+adxt*s11
        adu(npx-1,j) = adu(npx-1,j)+adxt*s15
        adxt = 0.
        adal(npx-2) = adal(npx-2)+adbl(npx-2)
        adu(npx-2,j) = adu(npx-2,j)-adbl(npx-2)
        adbl(npx-2) = 0.
      endif
      if (iord .lt. 10) then
        do i = max(3,is-1), min(npx-3,ie+1)
          pmp = 2.*dq(i-1)
          lac = pmp-1.5*dq(i-2)
          br(i) = min(max(0.,pmp,lac),max(al(i+1)-u(i,j),min(0.,pmp,lac)))
          pmp = -(2.*dq(i))
          lac = pmp+1.5*dq(i+1)
          bl(i) = min(max(0.,pmp,lac),max(al(i)-u(i,j),min(0.,pmp,lac)))
        end do
      else
        do i = max(3,is-1), min(npx-3,ie+1)
          bl(i) = al(i)-u(i,j)
          br(i) = al(i+1)-u(i,j)
        end do
      endif
      if (is .eq. 1) then
        br(2) = al(3)-u(2,j)
        xt = s15*u(1,j)+s11*u(2,j)-s14*dm(2)
        bl(2) = xt-u(2,j)
        br(1) = xt-u(1,j)
        if (j .eq. 1 .or. j .eq. npy) then
          bl(0) = 0.
          br(0) = 0.
          bl(1) = 0.
          br(1) = 0.
        else
          bl(0) = s14*dm(-1)-s11*dq(-1)
          xt = 0.5*((2.*dx(1,j)+dx(2,j))*(u(0,j)+u(1,j))-dx(1,j)*(u(-1,j)+u(2,j)))/(dx(1,j)+dx(2,j))
          br(0) = xt-u(0,j)
          bl(1) = xt-u(1,j)
        endif
        if (iord .lt. 10) then
          call adpert_ppm( 1,u(2,j),adu(2,j),bl(2),adbl(2),br(2),adbr(2),help_h )
        endif
        if (j .eq. 1 .or. j .eq. npy) then
          adbr(1) = 0.
          adbl(1) = 0.
          adbr(0) = 0.
          adbl(0) = 0.
        else
          adu(1,j) = adu(1,j)-adbl(1)
          adxt = adxt+adbl(1)
          adbl(1) = 0.
          adu(0,j) = adu(0,j)-adbr(0)
          adxt = adxt+adbr(0)
          adbr(0) = 0.
          adu(-1,j) = adu(-1,j)-adxt*(0.5*dx(1,j)/(dx(1,j)+dx(2,j)))
          adu(2,j) = adu(2,j)-adxt*(0.5*dx(1,j)/(dx(1,j)+dx(2,j)))
          adu(1,j) = adu(1,j)+adxt*(0.5*(2.*dx(1,j)+dx(2,j))/(dx(1,j)+dx(2,j)))
          adu(0,j) = adu(0,j)+adxt*(0.5*(2.*dx(1,j)+dx(2,j))/(dx(1,j)+dx(2,j)))
          adxt = 0.
          addm(-1) = addm(-1)+adbl(0)*s14
          addq(-1) = addq(-1)-adbl(0)*s11
          adbl(0) = 0.
        endif
        adu(1,j) = adu(1,j)-adbr(1)
        adxt = adxt+adbr(1)
        adbr(1) = 0.
        adu(2,j) = adu(2,j)-adbl(2)
        adxt = adxt+adbl(2)
        adbl(2) = 0.
        addm(2) = addm(2)-adxt*s14
        adu(2,j) = adu(2,j)+adxt*s11
        adu(1,j) = adu(1,j)+adxt*s15
        adxt = 0.
        adal(3) = adal(3)+adbr(2)
        adu(2,j) = adu(2,j)-adbr(2)
        adbr(2) = 0.
      endif
      if (iord .lt. 10) then
        do i = min(npx-3,ie+1), max(3,is-1), -1
          adlac = 0.
          adpmp = 0.
          pmp = -(2.*dq(i))
          lac = pmp+1.5*dq(i+1)
          blw = max(0.,pmp)
          blx = max(blw,lac)
          blz = min(0.,pmp)
          bl0 = min(blz,lac)
          bly = max(al(i)-u(i,j),bl0)
          adblx = adbl(i)*(0.5+sign(0.5,bly-blx))
          adbly = adbl(i)*(0.5-sign(0.5,bly-blx))
          adal(i) = adal(i)+adbly*(0.5+sign(0.5,al(i)-u(i,j)-bl0))
          adbl0 = adbly*(0.5-sign(0.5,al(i)-u(i,j)-bl0))
          adu(i,j) = adu(i,j)-adbly*(0.5+sign(0.5,al(i)-u(i,j)-bl0))
          adblz = adbl0*(0.5+sign(0.5,lac-blz))
          adlac = adlac+adbl0*(0.5-sign(0.5,lac-blz))
          adpmp = adpmp+adblz*(0.5-sign(0.5,pmp-0.))
          adblw = adblx*(0.5+sign(0.5,blw-lac))
          adlac = adlac+adblx*(0.5-sign(0.5,blw-lac))
          adpmp = adpmp+adblw*(0.5-sign(0.5,0.-pmp))
          adbl(i) = 0.
          addq(i+1) = addq(i+1)+1.5*adlac
          adpmp = adpmp+adlac
          adlac = 0.
          addq(i) = addq(i)-2*adpmp
          adpmp = 0.
          pmp = 2.*dq(i-1)
          lac = pmp-1.5*dq(i-2)
          brw = max(0.,pmp)
          brx = max(brw,lac)
          brz = min(0.,pmp)
          br0 = min(brz,lac)
          bry = max(al(i+1)-u(i,j),br0)
          adbrx = adbr(i)*(0.5+sign(0.5,bry-brx))
          adbry = adbr(i)*(0.5-sign(0.5,bry-brx))
          adal(i+1) = adal(i+1)+adbry*(0.5+sign(0.5,al(i+1)-u(i,j)-br0))
          adbr0 = adbry*(0.5-sign(0.5,al(i+1)-u(i,j)-br0))
          adu(i,j) = adu(i,j)-adbry*(0.5+sign(0.5,al(i+1)-u(i,j)-br0))
          adbrz = adbr0*(0.5+sign(0.5,lac-brz))
          adlac = adlac+adbr0*(0.5-sign(0.5,lac-brz))
          adpmp = adpmp+adbrz*(0.5-sign(0.5,pmp-0.))
          adbrw = adbrx*(0.5+sign(0.5,brw-lac))
          adlac = adlac+adbrx*(0.5-sign(0.5,brw-lac))
          adpmp = adpmp+adbrw*(0.5-sign(0.5,0.-pmp))
          adbr(i) = 0.
          addq(i-2) = addq(i-2)-1.5*adlac
          adpmp = adpmp+adlac
          adlac = 0.
          addq(i-1) = addq(i-1)+2*adpmp
          adpmp = 0.
        end do
      else
        do i = max(3,is-1), min(npx-3,ie+1)
          adal(i+1) = adal(i+1)+adbr(i)
          adu(i,j) = adu(i,j)-adbr(i)
          adbr(i) = 0.
          adal(i) = adal(i)+adbl(i)
          adu(i,j) = adu(i,j)-adbl(i)
          adbl(i) = 0.
        end do
      endif
      do i = max(3,is-1), min(npx-2,ie+2)
        addm(i-1) = addm(i-1)+adal(i)*r3
        addm(i) = addm(i)-adal(i)*r3
        adu(i-1,j) = adu(i-1,j)+0.5*adal(i)
        adu(i,j) = adu(i,j)+0.5*adal(i)
        adal(i) = 0.
      end do
    else
      do i = ie+1, is-1, -1
        adlac = 0.
        adpmp = 0.
        pmp = 2.*dq(i-1)
        lac = pmp-1.5*dq(i-2)
        brr = max(0.,pmp)
        brs = max(brr,lac)
        bru = min(0.,pmp)
        brv = min(bru,lac)
        brt = max(al(i+1)-u(i,j),brv)
        adbrs = adbr(i)*(0.5+sign(0.5,brt-brs))
        adbrt = adbr(i)*(0.5-sign(0.5,brt-brs))
        adal(i+1) = adal(i+1)+adbrt*(0.5+sign(0.5,al(i+1)-u(i,j)-brv))
        adbrv = adbrt*(0.5-sign(0.5,al(i+1)-u(i,j)-brv))
        adu(i,j) = adu(i,j)-adbrt*(0.5+sign(0.5,al(i+1)-u(i,j)-brv))
        adbru = adbrv*(0.5+sign(0.5,lac-bru))
        adlac = adlac+adbrv*(0.5-sign(0.5,lac-bru))
        adpmp = adpmp+adbru*(0.5-sign(0.5,pmp-0.))
        adbrr = adbrs*(0.5+sign(0.5,brr-lac))
        adlac = adlac+adbrs*(0.5-sign(0.5,brr-lac))
        adpmp = adpmp+adbrr*(0.5-sign(0.5,0.-pmp))
        adbr(i) = 0.
        addq(i-2) = addq(i-2)-1.5*adlac
        adpmp = adpmp+adlac
        adlac = 0.
        addq(i-1) = addq(i-1)+2*adpmp
        adpmp = 0.
        pmp = -(2.*dq(i))
        lac = pmp+1.5*dq(i+1)
        blr = max(0.,pmp)
        bls = max(blr,lac)
        blu = min(0.,pmp)
        blv = min(blu,lac)
        blt = max(al(i)-u(i,j),blv)
        adbls = adbl(i)*(0.5+sign(0.5,blt-bls))
        adblt = adbl(i)*(0.5-sign(0.5,blt-bls))
        adal(i) = adal(i)+adblt*(0.5+sign(0.5,al(i)-u(i,j)-blv))
        adblv = adblt*(0.5-sign(0.5,al(i)-u(i,j)-blv))
        adu(i,j) = adu(i,j)-adblt*(0.5+sign(0.5,al(i)-u(i,j)-blv))
        adblu = adblv*(0.5+sign(0.5,lac-blu))
        adlac = adlac+adblv*(0.5-sign(0.5,lac-blu))
        adpmp = adpmp+adblu*(0.5-sign(0.5,pmp-0.))
        adblr = adbls*(0.5+sign(0.5,blr-lac))
        adlac = adlac+adbls*(0.5-sign(0.5,blr-lac))
        adpmp = adpmp+adblr*(0.5-sign(0.5,0.-pmp))
        adbl(i) = 0.
        addq(i+1) = addq(i+1)+1.5*adlac
        adpmp = adpmp+adlac
        adlac = 0.
        addq(i) = addq(i)-2*adpmp
        adpmp = 0.
      end do
      do i = is-1, ie+2
        addm(i-1) = addm(i-1)+adal(i)*r3
        addm(i) = addm(i)-adal(i)*r3
        adu(i-1,j) = adu(i-1,j)+0.5*adal(i)
        adu(i,j) = adu(i,j)+0.5*adal(i)
        adal(i) = 0.
      end do
    endif
    do i = is-3, ie+2
      adu(i+1,j) = adu(i+1,j)+addq(i)
      adu(i,j) = adu(i,j)-addq(i)
      addq(i) = 0.
    end do
    do i = ie+2, is-2, -1
      adxt = 0.
      xt = 0.25*(u(i+1,j)-u(i-1,j))
      dmj = abs(xt)
      dmm = max(u(i-1,j),u(i,j))
      dmq = max(dmm,u(i+1,j))-u(i,j)
      dmr = min(u(i-1,j),u(i,j))
      dmt = u(i,j)-min(dmr,u(i+1,j))
      dmu = min(dmj,dmq)
      addmx = addm(i)*sign(1.,min(dmu,dmt))*sign(1.,xt)
      addmv = addmx*(0.5-sign(0.5,dmt-dmu))
      addmw = addmx*(0.5+sign(0.5,dmt-dmu))
      addmj = addmw*(0.5+sign(0.5,dmq-dmj))
      addms = addmw*(0.5-sign(0.5,dmq-dmj))
      addmu = -addmv
      adu(i,j) = adu(i,j)+addmv
      addmt = addmu*(0.5+sign(0.5,u(i+1,j)-dmr))
      adu(i+1,j) = adu(i+1,j)+addmu*(0.5-sign(0.5,u(i+1,j)-dmr))
      adu(i-1,j) = adu(i-1,j)+addmt*(0.5+sign(0.5,u(i,j)-u(i-1,j)))
      adu(i,j) = adu(i,j)+addmt*(0.5-sign(0.5,u(i,j)-u(i-1,j)))
      adu(i,j) = adu(i,j)-addms
      addmq = addms*(0.5+sign(0.5,dmm-u(i+1,j)))
      adu(i+1,j) = adu(i+1,j)+addms*(0.5-sign(0.5,dmm-u(i+1,j)))
      adu(i-1,j) = adu(i-1,j)+addmq*(0.5+sign(0.5,u(i-1,j)-u(i,j)))
      adu(i,j) = adu(i,j)+addmq*(0.5-sign(0.5,u(i-1,j)-u(i,j)))
      adxt = adxt+addmj*sign(1.,xt)
      addm(i) = 0.
      adu(i-1,j) = adu(i-1,j)-0.25*adxt
      adu(i+1,j) = adu(i+1,j)+0.25*adxt
      adxt = 0.
    end do
  end do

!----------------------------------------------
! CLOSE TAPE tape_xtp_u
!----------------------------------------------
  if (allocated(tape_xtp_u_bl_1h)) then
    deallocate( tape_xtp_u_bl_1h )
  endif
  if (allocated(tape_xtp_u_br_2h)) then
    deallocate( tape_xtp_u_br_2h )
  endif

endif

end subroutine adxtp_u


subroutine adytp_v( c, adc, v, adv, adflux, jord )
!******************************************************************
!******************************************************************
!** This routine was generated by Automatic differentiation.     **
!** FastOpt: Transformation of Algorithm in Fortran, TAF 1.9.50  **
!******************************************************************
!******************************************************************
!==============================================
! all entries are defined explicitly
!==============================================
implicit none

!==============================================
! declare parameters
!==============================================
real, parameter :: r3 = 1./3.
real, parameter :: s11 = 11./14.
real, parameter :: s14 = 4./7.
real, parameter :: s15 = 3./14.

!==============================================
! declare arguments
!==============================================
real, intent(inout) :: adc(is:ie+1,js:je+1)
real, intent(inout) :: adflux(is:ie+1,js:je+1)
real, intent(inout) :: adv(isd:ied+1,jsd:jed)
real, intent(in) :: c(is:ie+1,js:je+1)
integer, intent(in) :: jord
real, intent(in) :: v(isd:ied+1,jsd:jed)

!==============================================
! declare local variables
!==============================================
real :: a6da
real :: ada6da
real :: adal(is:ie+1,js-1:je+2)
real :: adbl(is:ie+1,js-1:je+1)
real :: adblh
real :: adbli
real :: adblj
real :: adblk
real :: adbll
real :: adblm
real :: adbln
real :: adblo
real :: adblp
real :: adblq
real :: adbr(is:ie+1,js-1:je+1)
real :: adbrh
real :: adbri
real :: adbrj
real :: adbrk
real :: adbrl
real :: adbrm
real :: adbrn
real :: adbro
real :: adbrp
real :: adbrq
real :: adcfl
real :: adda1
real :: adda2
real :: addl
real :: addlh
real :: addli
real :: addlj
real :: addlk
real :: addm(is:ie+1,js-2:je+2)
real :: addmh
real :: addmi
real :: addmj
real :: addmk
real :: addml
real :: addmm
real :: addmn
real :: addmo
real :: addmp
real :: addmq
real :: addms
real :: addmt
real :: addmu
real :: addmv
real :: addmw
real :: addmx
real :: addq(is:ie+1,js-3:je+2)
real :: addr
real :: addrh
real :: addri
real :: addrj
real :: addrk
real :: adlac
real :: adpmp
real :: adxt
real :: al(is:ie+1,js-1:je+2)
real :: bl(is:ie+1,js-1:je+1)
real :: blh
real :: bli
real :: blj
real :: blk
real :: bll
real :: blm
real :: bln
real :: blo
real :: blp
real :: blq
real :: br(is:ie+1,js-1:je+1)
real :: brh
real :: bri
real :: brj
real :: brk
real :: brl
real :: brm
real :: brn
real :: bro
real :: brp
real :: brq
real :: cfl
real :: da1
real :: da2
real :: dl
real :: dli
real :: dlj
real :: dm(is:ie+1,js-2:je+2)
real :: dmh
real :: dmi
real :: dmj
real :: dmk
real :: dml
real :: dmm
real :: dmn
real :: dmo
real :: dmq
real :: dmr
real :: dmt
real :: dmu
real :: dq(is:ie+1,js-3:je+2)
real :: dr
real :: dri
real :: drj
integer :: i
integer :: j
real :: lac
real :: pmp
real :: xt

!----------------------------------------------
! RESET LOCAL ADJOINT VARIABLES
!----------------------------------------------
ada6da = 0.
adal(:,:) = 0.
adbl(:,:) = 0.
adbr(:,:) = 0.
adcfl = 0.
adda1 = 0.
adda2 = 0.
addl = 0.
addm(:,:) = 0.
addq(:,:) = 0.
addr = 0.
adlac = 0.
adpmp = 0.
adxt = 0.

!----------------------------------------------
! ROUTINE BODY
!----------------------------------------------
if (jord .eq. 1) then
  do j = js, je+1
    do i = is, ie+1
      if (c(i,j) .gt. 0.) then
        adv(i,j-1) = adv(i,j-1)+adflux(i,j)
        adflux(i,j) = 0.
      else
        adv(i,j) = adv(i,j)+adflux(i,j)
        adflux(i,j) = 0.
      endif
    end do
  end do
else if (jord .le. 4) then
  do j = js-2, je+2
    do i = is, ie+1
      xt = 0.25*(v(i,j+1)-v(i,j-1))
      dm(i,j) = sign(min(abs(xt),max(v(i,j-1),v(i,j),v(i,j+1))-v(i,j),v(i,j)-min(v(i,j-1),v(i,j),v(i,j+1))),xt)
    end do
  end do
  if (is .eq. 1) then
    if (js .eq. 1) then
      dm(1,1) = 0.
    endif
    if (je+1 .eq. npy) then
      dm(1,je) = 0.
    endif
  endif
  if (ie+1 .eq. npx) then
    if (js .eq. 1) then
      dm(npx,1) = 0.
    endif
    if (je+1 .eq. npy) then
      dm(npx,je) = 0.
    endif
  endif
  do j = js-1, je+2
    do i = is, ie+1
      al(i,j) = 0.5*(v(i,j-1)+v(i,j))+r3*(dm(i,j-1)-dm(i,j))
    end do
  end do
  do j = je+1, js, -1
    adcfl = 0.
    addl = 0.
    addr = 0.
    adxt = 0.
    do i = ie+1, is, -1
      adcfl = 0.
      addl = 0.
      addr = 0.
      adxt = 0.
      if (c(i,j) .gt. 0.) then
        xt = 2.*dm(i,j-1)
        dl = sign(min(abs(xt),abs(al(i,j-1)-v(i,j-1))),xt)
        dr = sign(min(abs(xt),abs(al(i,j)-v(i,j-1))),xt)
        cfl = c(i,j)*rdy(i,j-1)
        adcfl = adcfl+adflux(i,j)*((1.-cfl)*(dl-dr)-(dr+cfl*(dl-dr)))
        addl = addl+adflux(i,j)*(1.-cfl)*cfl
        addr = addr+adflux(i,j)*(1.-cfl)*(1-cfl)
        adv(i,j-1) = adv(i,j-1)+adflux(i,j)
        adflux(i,j) = 0.
        adc(i,j) = adc(i,j)+adcfl*rdy(i,j-1)
        adcfl = 0.
        drj = al(i,j)-v(i,j-1)
        addrj = addr*sign(1.,min(abs(xt),abs(drj)))*sign(1.,xt)
        addrk = addrj*(0.5-sign(0.5,abs(drj)-abs(xt)))*sign(1.,drj)
        adxt = adxt+addrj*(0.5+sign(0.5,abs(drj)-abs(xt)))*sign(1.,xt)
        adal(i,j) = adal(i,j)+addrk
        adv(i,j-1) = adv(i,j-1)-addrk
        addr = 0.
        dlj = al(i,j-1)-v(i,j-1)
        addlj = addl*sign(1.,min(abs(xt),abs(dlj)))*sign(1.,xt)
        addlk = addlj*(0.5-sign(0.5,abs(dlj)-abs(xt)))*sign(1.,dlj)
        adxt = adxt+addlj*(0.5+sign(0.5,abs(dlj)-abs(xt)))*sign(1.,xt)
        adal(i,j-1) = adal(i,j-1)+addlk
        adv(i,j-1) = adv(i,j-1)-addlk
        addl = 0.
        addm(i,j-1) = addm(i,j-1)+2*adxt
        adxt = 0.
      else
        xt = 2.*dm(i,j)
        dl = sign(min(abs(xt),abs(al(i,j)-v(i,j))),xt)
        dr = sign(min(abs(xt),abs(al(i,j+1)-v(i,j))),xt)
        cfl = c(i,j)*rdy(i,j)
        adcfl = adcfl-adflux(i,j)*((1.+cfl)*(dl-dr)+dl+cfl*(dl-dr))
        addl = addl-adflux(i,j)*(1.+cfl)*(1+cfl)
        addr = addr+adflux(i,j)*(1.+cfl)*cfl
        adv(i,j) = adv(i,j)+adflux(i,j)
        adflux(i,j) = 0.
        adc(i,j) = adc(i,j)+adcfl*rdy(i,j)
        adcfl = 0.
        dri = al(i,j+1)-v(i,j)
        addrh = addr*sign(1.,min(abs(xt),abs(dri)))*sign(1.,xt)
        addri = addrh*(0.5-sign(0.5,abs(dri)-abs(xt)))*sign(1.,dri)
        adxt = adxt+addrh*(0.5+sign(0.5,abs(dri)-abs(xt)))*sign(1.,xt)
        adal(i,j+1) = adal(i,j+1)+addri
        adv(i,j) = adv(i,j)-addri
        addr = 0.
        dli = al(i,j)-v(i,j)
        addlh = addl*sign(1.,min(abs(xt),abs(dli)))*sign(1.,xt)
        addli = addlh*(0.5-sign(0.5,abs(dli)-abs(xt)))*sign(1.,dli)
        adxt = adxt+addlh*(0.5+sign(0.5,abs(dli)-abs(xt)))*sign(1.,xt)
        adal(i,j) = adal(i,j)+addli
        adv(i,j) = adv(i,j)-addli
        addl = 0.
        addm(i,j) = addm(i,j)+2*adxt
        adxt = 0.
      endif
    end do
  end do
  do j = js-1, je+2
    do i = is, ie+1
      addm(i,j-1) = addm(i,j-1)+adal(i,j)*r3
      addm(i,j) = addm(i,j)-adal(i,j)*r3
      adv(i,j-1) = adv(i,j-1)+0.5*adal(i,j)
      adv(i,j) = adv(i,j)+0.5*adal(i,j)
      adal(i,j) = 0.
    end do
  end do
  if (ie+1 .eq. npx) then
    if (je+1 .eq. npy) then
      addm(npx,je) = 0.
    endif
    if (js .eq. 1) then
      addm(npx,1) = 0.
    endif
  endif
  if (is .eq. 1) then
    if (je+1 .eq. npy) then
      addm(1,je) = 0.
    endif
    if (js .eq. 1) then
      addm(1,1) = 0.
    endif
  endif
  do j = je+2, js-2, -1
    adxt = 0.
    do i = ie+1, is, -1
      adxt = 0.
      xt = 0.25*(v(i,j+1)-v(i,j-1))
      dmj = abs(xt)
      dmm = max(v(i,j-1),v(i,j))
      dmq = max(dmm,v(i,j+1))-v(i,j)
      dmr = min(v(i,j-1),v(i,j))
      dmt = v(i,j)-min(dmr,v(i,j+1))
      dmu = min(dmj,dmq)
      addmx = addm(i,j)*sign(1.,min(dmu,dmt))*sign(1.,xt)
      addmv = addmx*(0.5-sign(0.5,dmt-dmu))
      addmw = addmx*(0.5+sign(0.5,dmt-dmu))
      addmj = addmw*(0.5+sign(0.5,dmq-dmj))
      addms = addmw*(0.5-sign(0.5,dmq-dmj))
      addmu = -addmv
      adv(i,j) = adv(i,j)+addmv
      addmt = addmu*(0.5+sign(0.5,v(i,j+1)-dmr))
      adv(i,j+1) = adv(i,j+1)+addmu*(0.5-sign(0.5,v(i,j+1)-dmr))
      adv(i,j-1) = adv(i,j-1)+addmt*(0.5+sign(0.5,v(i,j)-v(i,j-1)))
      adv(i,j) = adv(i,j)+addmt*(0.5-sign(0.5,v(i,j)-v(i,j-1)))
      adv(i,j) = adv(i,j)-addms
      addmq = addms*(0.5+sign(0.5,dmm-v(i,j+1)))
      adv(i,j+1) = adv(i,j+1)+addms*(0.5-sign(0.5,dmm-v(i,j+1)))
      adv(i,j-1) = adv(i,j-1)+addmq*(0.5+sign(0.5,v(i,j-1)-v(i,j)))
      adv(i,j) = adv(i,j)+addmq*(0.5-sign(0.5,v(i,j-1)-v(i,j)))
      adxt = adxt+addmj*sign(1.,xt)
      addm(i,j) = 0.
      adv(i,j-1) = adv(i,j-1)-0.25*adxt
      adv(i,j+1) = adv(i,j+1)+0.25*adxt
      adxt = 0.
    end do
  end do
else
  do j = js-2, je+2
    do i = is, ie+1
      xt = 0.25*(v(i,j+1)-v(i,j-1))
      dm(i,j) = sign(min(abs(xt),max(v(i,j-1),v(i,j),v(i,j+1))-v(i,j),v(i,j)-min(v(i,j-1),v(i,j),v(i,j+1))),xt)
    end do
  end do
  do j = js-3, je+2
    do i = is, ie+1
      dq(i,j) = v(i,j+1)-v(i,j)
    end do
  end do
  if (grid_type .lt. 3) then
    do j = max(3,js-1), min(npy-2,je+2)
      do i = is, ie+1
        al(i,j) = 0.5*(v(i,j-1)+v(i,j))+r3*(dm(i,j-1)-dm(i,j))
      end do
    end do
    if (jord .lt. 10) then
      do j = max(3,js-1), min(npy-3,je+1)
        do i = is, ie+1
          pmp = 2.*dq(i,j-1)
          lac = pmp-1.5*dq(i,j-2)
          br(i,j) = min(max(0.,pmp,lac),max(al(i,j+1)-v(i,j),min(0.,pmp,lac)))
          pmp = -(2.*dq(i,j))
          lac = pmp+1.5*dq(i,j+1)
          bl(i,j) = min(max(0.,pmp,lac),max(al(i,j)-v(i,j),min(0.,pmp,lac)))
        end do
      end do
    else
      do j = max(3,js-1), min(npy-3,je+1)
        do i = is, ie+1
          bl(i,j) = al(i,j)-v(i,j)
          br(i,j) = al(i,j+1)-v(i,j)
        end do
      end do
    endif
    if (js .eq. 1) then
      do i = is, ie+1
        br(i,2) = al(i,3)-v(i,2)
        xt = s15*v(i,1)+s11*v(i,2)-s14*dm(i,2)
        br(i,1) = xt-v(i,1)
        bl(i,2) = xt-v(i,2)
        bl(i,0) = s14*dm(i,-1)-s11*dq(i,-1)
        xt = 0.5*((2.*dy(i,1)+dy(i,2))*(v(i,0)+v(i,1))-dy(i,1)*(v(i,-1)+v(i,2)))/(dy(i,1)+dy(i,2))
        bl(i,1) = xt-v(i,1)
        br(i,0) = xt-v(i,0)
      end do
      if (is .eq. 1) then
        bl(1,0) = 0.
        br(1,0) = 0.
        bl(1,1) = 0.
        br(1,1) = 0.
      endif
      if (ie+1 .eq. npx) then
        bl(npx,0) = 0.
        br(npx,0) = 0.
        bl(npx,1) = 0.
        br(npx,1) = 0.
      endif
      if (jord .lt. 10) then
        do i = is, ie+1
          if (bl(i,2)*br(i,2) .lt. 0.) then
            da1 = bl(i,2)-br(i,2)
            da2 = da1**2
            a6da = 3.*(bl(i,2)+br(i,2))*da1
            if (a6da .lt. (-da2)) then
              br(i,2) = -(2.*bl(i,2))
            else if (a6da .gt. da2) then
              bl(i,2) = -(2.*br(i,2))
            endif
          else
            bl(i,2) = 0.
            br(i,2) = 0.
          endif
        end do
      endif
    endif
    if (je+1 .eq. npy) then
      do i = is, ie+1
        bl(i,npy-2) = al(i,npy-2)-v(i,npy-2)
        xt = s15*v(i,npy-1)+s11*v(i,npy-2)+s14*dm(i,npy-2)
        br(i,npy-2) = xt-v(i,npy-2)
        bl(i,npy-1) = xt-v(i,npy-1)
        br(i,npy) = s11*dq(i,npy)-s14*dm(i,npy+1)
        xt = 0.5*((2.*dy(i,npy-1)+dy(i,npy-2))*(v(i,npy-1)+v(i,npy))-dy(i,npy-1)*(v(i,npy-2)+v(i,npy+1)))/(dy(i,npy-1)+dy(i,npy-2))
        br(i,npy-1) = xt-v(i,npy-1)
        bl(i,npy) = xt-v(i,npy)
      end do
      if (is .eq. 1) then
        bl(1,npy-1) = 0.
        br(1,npy-1) = 0.
        bl(1,npy) = 0.
        br(1,npy) = 0.
      endif
      if (ie+1 .eq. npx) then
        bl(npx,npy-1) = 0.
        br(npx,npy-1) = 0.
        bl(npx,npy) = 0.
        br(npx,npy) = 0.
      endif
      if (jord .lt. 10) then
        do i = is, ie+1
          if (bl(i,npy-2)*br(i,npy-2) .lt. 0.) then
            da1 = bl(i,npy-2)-br(i,npy-2)
            da2 = da1**2
            a6da = 3.*(bl(i,npy-2)+br(i,npy-2))*da1
            if (a6da .lt. (-da2)) then
              br(i,npy-2) = -(2.*bl(i,npy-2))
            else if (a6da .gt. da2) then
              bl(i,npy-2) = -(2.*br(i,npy-2))
            endif
          else
            bl(i,npy-2) = 0.
            br(i,npy-2) = 0.
          endif
        end do
      endif
    endif
  else
    do j = js-1, je+2
      do i = is, ie+1
        al(i,j) = 0.5*(v(i,j-1)+v(i,j))+r3*(dm(i,j-1)-dm(i,j))
      end do
    end do
    do j = js-1, je+1
      do i = is, ie+1
        pmp = 2.*dq(i,j-1)
        lac = pmp-1.5*dq(i,j-2)
        br(i,j) = min(max(0.,pmp,lac),max(al(i,j+1)-v(i,j),min(0.,pmp,lac)))
        pmp = -(2.*dq(i,j))
        lac = pmp+1.5*dq(i,j+1)
        bl(i,j) = min(max(0.,pmp,lac),max(al(i,j)-v(i,j),min(0.,pmp,lac)))
      end do
    end do
  endif
  do j = je+1, js, -1
    adcfl = 0.
    do i = ie+1, is, -1
      adcfl = 0.
      if (c(i,j) .gt. 0.) then
        cfl = c(i,j)*rdy(i,j-1)
        adbl(i,j-1) = adbl(i,j-1)-adflux(i,j)*(1.-cfl)*cfl
        adbr(i,j-1) = adbr(i,j-1)+adflux(i,j)*(1.-cfl)*(1-cfl)
        adcfl = adcfl+adflux(i,j)*((-((1.-cfl)*(bl(i,j-1)+br(i,j-1))))-(br(i,j-1)-cfl*(bl(i,j-1)+br(i,j-1))))
        adv(i,j-1) = adv(i,j-1)+adflux(i,j)
        adflux(i,j) = 0.
        adc(i,j) = adc(i,j)+adcfl*rdy(i,j-1)
        adcfl = 0.
      else
        cfl = c(i,j)*rdy(i,j)
        adbl(i,j) = adbl(i,j)+adflux(i,j)*(1.+cfl)*(1+cfl)
        adbr(i,j) = adbr(i,j)+adflux(i,j)*(1.+cfl)*cfl
        adcfl = adcfl+adflux(i,j)*((1.+cfl)*(bl(i,j)+br(i,j))+bl(i,j)+cfl*(bl(i,j)+br(i,j)))
        adv(i,j) = adv(i,j)+adflux(i,j)
        adflux(i,j) = 0.
        adc(i,j) = adc(i,j)+adcfl*rdy(i,j)
        adcfl = 0.
      endif
    end do
  end do
  if (grid_type .lt. 3) then
    if (jord .lt. 10) then
      do j = max(3,js-1), min(npy-3,je+1)
        do i = is, ie+1
          pmp = 2.*dq(i,j-1)
          lac = pmp-1.5*dq(i,j-2)
          br(i,j) = min(max(0.,pmp,lac),max(al(i,j+1)-v(i,j),min(0.,pmp,lac)))
          pmp = -(2.*dq(i,j))
          lac = pmp+1.5*dq(i,j+1)
          bl(i,j) = min(max(0.,pmp,lac),max(al(i,j)-v(i,j),min(0.,pmp,lac)))
        end do
      end do
    else
      do j = max(3,js-1), min(npy-3,je+1)
        do i = is, ie+1
          bl(i,j) = al(i,j)-v(i,j)
          br(i,j) = al(i,j+1)-v(i,j)
        end do
      end do
    endif
    if (js .eq. 1) then
      do i = is, ie+1
        br(i,2) = al(i,3)-v(i,2)
        xt = s15*v(i,1)+s11*v(i,2)-s14*dm(i,2)
        br(i,1) = xt-v(i,1)
        bl(i,2) = xt-v(i,2)
        bl(i,0) = s14*dm(i,-1)-s11*dq(i,-1)
        xt = 0.5*((2.*dy(i,1)+dy(i,2))*(v(i,0)+v(i,1))-dy(i,1)*(v(i,-1)+v(i,2)))/(dy(i,1)+dy(i,2))
        bl(i,1) = xt-v(i,1)
        br(i,0) = xt-v(i,0)
      end do
      if (is .eq. 1) then
        bl(1,0) = 0.
        br(1,0) = 0.
        bl(1,1) = 0.
        br(1,1) = 0.
      endif
      if (ie+1 .eq. npx) then
        bl(npx,0) = 0.
        br(npx,0) = 0.
        bl(npx,1) = 0.
        br(npx,1) = 0.
      endif
      if (jord .lt. 10) then
        do i = is, ie+1
          if (bl(i,2)*br(i,2) .lt. 0.) then
            da1 = bl(i,2)-br(i,2)
            da2 = da1**2
            a6da = 3.*(bl(i,2)+br(i,2))*da1
            if (a6da .lt. (-da2)) then
              br(i,2) = -(2.*bl(i,2))
            else if (a6da .gt. da2) then
              bl(i,2) = -(2.*br(i,2))
            endif
          else
            bl(i,2) = 0.
            br(i,2) = 0.
          endif
        end do
      endif
    endif
    if (je+1 .eq. npy) then
      do i = is, ie+1
        bl(i,npy-2) = al(i,npy-2)-v(i,npy-2)
        xt = s15*v(i,npy-1)+s11*v(i,npy-2)+s14*dm(i,npy-2)
        br(i,npy-2) = xt-v(i,npy-2)
        bl(i,npy-1) = xt-v(i,npy-1)
        br(i,npy) = s11*dq(i,npy)-s14*dm(i,npy+1)
        xt = 0.5*((2.*dy(i,npy-1)+dy(i,npy-2))*(v(i,npy-1)+v(i,npy))-dy(i,npy-1)*(v(i,npy-2)+v(i,npy+1)))/(dy(i,npy-1)+dy(i,npy-2))
        br(i,npy-1) = xt-v(i,npy-1)
        bl(i,npy) = xt-v(i,npy)
      end do
      if (is .eq. 1) then
        bl(1,npy-1) = 0.
        br(1,npy-1) = 0.
        bl(1,npy) = 0.
        br(1,npy) = 0.
      endif
      if (ie+1 .eq. npx) then
        bl(npx,npy-1) = 0.
        br(npx,npy-1) = 0.
        bl(npx,npy) = 0.
        br(npx,npy) = 0.
      endif
      if (jord .lt. 10) then
        do i = ie+1, is, -1
          ada6da = 0.
          adda1 = 0.
          adda2 = 0.
          if (bl(i,npy-2)*br(i,npy-2) .lt. 0.) then
            da1 = bl(i,npy-2)-br(i,npy-2)
            da2 = da1**2
            a6da = 3.*(bl(i,npy-2)+br(i,npy-2))*da1
            if (a6da .lt. (-da2)) then
              adbl(i,npy-2) = adbl(i,npy-2)-2*adbr(i,npy-2)
              adbr(i,npy-2) = 0.
            else if (a6da .gt. da2) then
              adbr(i,npy-2) = adbr(i,npy-2)-2*adbl(i,npy-2)
              adbl(i,npy-2) = 0.
            endif
            adbl(i,npy-2) = adbl(i,npy-2)+3*ada6da*da1
            adbr(i,npy-2) = adbr(i,npy-2)+3*ada6da*da1
            adda1 = adda1+3*ada6da*(bl(i,npy-2)+br(i,npy-2))
            ada6da = 0.
            adda1 = adda1+2*adda2*da1
            adda2 = 0.
            adbl(i,npy-2) = adbl(i,npy-2)+adda1
            adbr(i,npy-2) = adbr(i,npy-2)-adda1
            adda1 = 0.
          else
            adbr(i,npy-2) = 0.
            adbl(i,npy-2) = 0.
          endif
        end do
      endif
      if (ie+1 .eq. npx) then
        adbr(npx,npy) = 0.
        adbl(npx,npy) = 0.
        adbr(npx,npy-1) = 0.
        adbl(npx,npy-1) = 0.
      endif
      if (is .eq. 1) then
        adbr(1,npy) = 0.
        adbl(1,npy) = 0.
        adbr(1,npy-1) = 0.
        adbl(1,npy-1) = 0.
      endif
      do i = ie+1, is, -1
        adxt = 0.
        adv(i,npy) = adv(i,npy)-adbl(i,npy)
        adxt = adxt+adbl(i,npy)
        adbl(i,npy) = 0.
        adv(i,npy-1) = adv(i,npy-1)-adbr(i,npy-1)
        adxt = adxt+adbr(i,npy-1)
        adbr(i,npy-1) = 0.
        adv(i,npy-2) = adv(i,npy-2)-adxt*(0.5*dy(i,npy-1)/(dy(i,npy-1)+dy(i,npy-2)))
        adv(i,npy-1) = adv(i,npy-1)+adxt*(0.5*(2.*dy(i,npy-1)+dy(i,npy-2))/(dy(i,npy-1)+dy(i,npy-2)))
        adv(i,npy+1) = adv(i,npy+1)-adxt*(0.5*dy(i,npy-1)/(dy(i,npy-1)+dy(i,npy-2)))
        adv(i,npy) = adv(i,npy)+adxt*(0.5*(2.*dy(i,npy-1)+dy(i,npy-2))/(dy(i,npy-1)+dy(i,npy-2)))
        adxt = 0.
        addm(i,npy+1) = addm(i,npy+1)-adbr(i,npy)*s14
        addq(i,npy) = addq(i,npy)+adbr(i,npy)*s11
        adbr(i,npy) = 0.
        adv(i,npy-1) = adv(i,npy-1)-adbl(i,npy-1)
        adxt = adxt+adbl(i,npy-1)
        adbl(i,npy-1) = 0.
        adv(i,npy-2) = adv(i,npy-2)-adbr(i,npy-2)
        adxt = adxt+adbr(i,npy-2)
        adbr(i,npy-2) = 0.
        addm(i,npy-2) = addm(i,npy-2)+adxt*s14
        adv(i,npy-2) = adv(i,npy-2)+adxt*s11
        adv(i,npy-1) = adv(i,npy-1)+adxt*s15
        adxt = 0.
        adal(i,npy-2) = adal(i,npy-2)+adbl(i,npy-2)
        adv(i,npy-2) = adv(i,npy-2)-adbl(i,npy-2)
        adbl(i,npy-2) = 0.
      end do
    endif
    if (jord .lt. 10) then
      do j = max(3,js-1), min(npy-3,je+1)
        do i = is, ie+1
          pmp = 2.*dq(i,j-1)
          lac = pmp-1.5*dq(i,j-2)
          br(i,j) = min(max(0.,pmp,lac),max(al(i,j+1)-v(i,j),min(0.,pmp,lac)))
          pmp = -(2.*dq(i,j))
          lac = pmp+1.5*dq(i,j+1)
          bl(i,j) = min(max(0.,pmp,lac),max(al(i,j)-v(i,j),min(0.,pmp,lac)))
        end do
      end do
    else
      do j = max(3,js-1), min(npy-3,je+1)
        do i = is, ie+1
          bl(i,j) = al(i,j)-v(i,j)
          br(i,j) = al(i,j+1)-v(i,j)
        end do
      end do
    endif
    if (js .eq. 1) then
      do i = is, ie+1
        br(i,2) = al(i,3)-v(i,2)
        xt = s15*v(i,1)+s11*v(i,2)-s14*dm(i,2)
        br(i,1) = xt-v(i,1)
        bl(i,2) = xt-v(i,2)
        bl(i,0) = s14*dm(i,-1)-s11*dq(i,-1)
        xt = 0.5*((2.*dy(i,1)+dy(i,2))*(v(i,0)+v(i,1))-dy(i,1)*(v(i,-1)+v(i,2)))/(dy(i,1)+dy(i,2))
        bl(i,1) = xt-v(i,1)
        br(i,0) = xt-v(i,0)
      end do
      if (is .eq. 1) then
        bl(1,0) = 0.
        br(1,0) = 0.
        bl(1,1) = 0.
        br(1,1) = 0.
      endif
      if (ie+1 .eq. npx) then
        bl(npx,0) = 0.
        br(npx,0) = 0.
        bl(npx,1) = 0.
        br(npx,1) = 0.
      endif
      if (jord .lt. 10) then
        do i = ie+1, is, -1
          ada6da = 0.
          adda1 = 0.
          adda2 = 0.
          if (bl(i,2)*br(i,2) .lt. 0.) then
            da1 = bl(i,2)-br(i,2)
            da2 = da1**2
            a6da = 3.*(bl(i,2)+br(i,2))*da1
            if (a6da .lt. (-da2)) then
              adbl(i,2) = adbl(i,2)-2*adbr(i,2)
              adbr(i,2) = 0.
            else if (a6da .gt. da2) then
              adbr(i,2) = adbr(i,2)-2*adbl(i,2)
              adbl(i,2) = 0.
            endif
            adbl(i,2) = adbl(i,2)+3*ada6da*da1
            adbr(i,2) = adbr(i,2)+3*ada6da*da1
            adda1 = adda1+3*ada6da*(bl(i,2)+br(i,2))
            ada6da = 0.
            adda1 = adda1+2*adda2*da1
            adda2 = 0.
            adbl(i,2) = adbl(i,2)+adda1
            adbr(i,2) = adbr(i,2)-adda1
            adda1 = 0.
          else
            adbr(i,2) = 0.
            adbl(i,2) = 0.
          endif
        end do
      endif
      if (ie+1 .eq. npx) then
        adbr(npx,1) = 0.
        adbl(npx,1) = 0.
        adbr(npx,0) = 0.
        adbl(npx,0) = 0.
      endif
      if (is .eq. 1) then
        adbr(1,1) = 0.
        adbl(1,1) = 0.
        adbr(1,0) = 0.
        adbl(1,0) = 0.
      endif
      do i = ie+1, is, -1
        adxt = 0.
        adv(i,0) = adv(i,0)-adbr(i,0)
        adxt = adxt+adbr(i,0)
        adbr(i,0) = 0.
        adv(i,1) = adv(i,1)-adbl(i,1)
        adxt = adxt+adbl(i,1)
        adbl(i,1) = 0.
        adv(i,-1) = adv(i,-1)-adxt*(0.5*dy(i,1)/(dy(i,1)+dy(i,2)))
        adv(i,2) = adv(i,2)-adxt*(0.5*dy(i,1)/(dy(i,1)+dy(i,2)))
        adv(i,1) = adv(i,1)+adxt*(0.5*(2.*dy(i,1)+dy(i,2))/(dy(i,1)+dy(i,2)))
        adv(i,0) = adv(i,0)+adxt*(0.5*(2.*dy(i,1)+dy(i,2))/(dy(i,1)+dy(i,2)))
        adxt = 0.
        addm(i,-1) = addm(i,-1)+adbl(i,0)*s14
        addq(i,-1) = addq(i,-1)-adbl(i,0)*s11
        adbl(i,0) = 0.
        adv(i,2) = adv(i,2)-adbl(i,2)
        adxt = adxt+adbl(i,2)
        adbl(i,2) = 0.
        adv(i,1) = adv(i,1)-adbr(i,1)
        adxt = adxt+adbr(i,1)
        adbr(i,1) = 0.
        addm(i,2) = addm(i,2)-adxt*s14
        adv(i,2) = adv(i,2)+adxt*s11
        adv(i,1) = adv(i,1)+adxt*s15
        adxt = 0.
        adal(i,3) = adal(i,3)+adbr(i,2)
        adv(i,2) = adv(i,2)-adbr(i,2)
        adbr(i,2) = 0.
      end do
    endif
    if (jord .lt. 10) then
      do j = min(npy-3,je+1), max(3,js-1), -1
        adlac = 0.
        adpmp = 0.
        do i = ie+1, is, -1
          adlac = 0.
          adpmp = 0.
          pmp = -(2.*dq(i,j))
          lac = pmp+1.5*dq(i,j+1)
          blm = max(0.,pmp)
          bln = max(blm,lac)
          blp = min(0.,pmp)
          blq = min(blp,lac)
          blo = max(al(i,j)-v(i,j),blq)
          adbln = adbl(i,j)*(0.5+sign(0.5,blo-bln))
          adblo = adbl(i,j)*(0.5-sign(0.5,blo-bln))
          adal(i,j) = adal(i,j)+adblo*(0.5+sign(0.5,al(i,j)-v(i,j)-blq))
          adblq = adblo*(0.5-sign(0.5,al(i,j)-v(i,j)-blq))
          adv(i,j) = adv(i,j)-adblo*(0.5+sign(0.5,al(i,j)-v(i,j)-blq))
          adblp = adblq*(0.5+sign(0.5,lac-blp))
          adlac = adlac+adblq*(0.5-sign(0.5,lac-blp))
          adpmp = adpmp+adblp*(0.5-sign(0.5,pmp-0.))
          adblm = adbln*(0.5+sign(0.5,blm-lac))
          adlac = adlac+adbln*(0.5-sign(0.5,blm-lac))
          adpmp = adpmp+adblm*(0.5-sign(0.5,0.-pmp))
          adbl(i,j) = 0.
          addq(i,j+1) = addq(i,j+1)+1.5*adlac
          adpmp = adpmp+adlac
          adlac = 0.
          addq(i,j) = addq(i,j)-2*adpmp
          adpmp = 0.
          pmp = 2.*dq(i,j-1)
          lac = pmp-1.5*dq(i,j-2)
          brm = max(0.,pmp)
          brn = max(brm,lac)
          brp = min(0.,pmp)
          brq = min(brp,lac)
          bro = max(al(i,j+1)-v(i,j),brq)
          adbrn = adbr(i,j)*(0.5+sign(0.5,bro-brn))
          adbro = adbr(i,j)*(0.5-sign(0.5,bro-brn))
          adal(i,j+1) = adal(i,j+1)+adbro*(0.5+sign(0.5,al(i,j+1)-v(i,j)-brq))
          adbrq = adbro*(0.5-sign(0.5,al(i,j+1)-v(i,j)-brq))
          adv(i,j) = adv(i,j)-adbro*(0.5+sign(0.5,al(i,j+1)-v(i,j)-brq))
          adbrp = adbrq*(0.5+sign(0.5,lac-brp))
          adlac = adlac+adbrq*(0.5-sign(0.5,lac-brp))
          adpmp = adpmp+adbrp*(0.5-sign(0.5,pmp-0.))
          adbrm = adbrn*(0.5+sign(0.5,brm-lac))
          adlac = adlac+adbrn*(0.5-sign(0.5,brm-lac))
          adpmp = adpmp+adbrm*(0.5-sign(0.5,0.-pmp))
          adbr(i,j) = 0.
          addq(i,j-2) = addq(i,j-2)-1.5*adlac
          adpmp = adpmp+adlac
          adlac = 0.
          addq(i,j-1) = addq(i,j-1)+2*adpmp
          adpmp = 0.
        end do
      end do
    else
      do j = max(3,js-1), min(npy-3,je+1)
        do i = is, ie+1
          adal(i,j+1) = adal(i,j+1)+adbr(i,j)
          adv(i,j) = adv(i,j)-adbr(i,j)
          adbr(i,j) = 0.
          adal(i,j) = adal(i,j)+adbl(i,j)
          adv(i,j) = adv(i,j)-adbl(i,j)
          adbl(i,j) = 0.
        end do
      end do
    endif
    do j = max(3,js-1), min(npy-2,je+2)
      do i = is, ie+1
        addm(i,j-1) = addm(i,j-1)+adal(i,j)*r3
        addm(i,j) = addm(i,j)-adal(i,j)*r3
        adv(i,j-1) = adv(i,j-1)+0.5*adal(i,j)
        adv(i,j) = adv(i,j)+0.5*adal(i,j)
        adal(i,j) = 0.
      end do
    end do
  else
    do j = je+1, js-1, -1
      adlac = 0.
      adpmp = 0.
      do i = ie+1, is, -1
        adlac = 0.
        adpmp = 0.
        pmp = -(2.*dq(i,j))
        lac = pmp+1.5*dq(i,j+1)
        blh = max(0.,pmp)
        bli = max(blh,lac)
        blk = min(0.,pmp)
        bll = min(blk,lac)
        blj = max(al(i,j)-v(i,j),bll)
        adbli = adbl(i,j)*(0.5+sign(0.5,blj-bli))
        adblj = adbl(i,j)*(0.5-sign(0.5,blj-bli))
        adal(i,j) = adal(i,j)+adblj*(0.5+sign(0.5,al(i,j)-v(i,j)-bll))
        adbll = adblj*(0.5-sign(0.5,al(i,j)-v(i,j)-bll))
        adv(i,j) = adv(i,j)-adblj*(0.5+sign(0.5,al(i,j)-v(i,j)-bll))
        adblk = adbll*(0.5+sign(0.5,lac-blk))
        adlac = adlac+adbll*(0.5-sign(0.5,lac-blk))
        adpmp = adpmp+adblk*(0.5-sign(0.5,pmp-0.))
        adblh = adbli*(0.5+sign(0.5,blh-lac))
        adlac = adlac+adbli*(0.5-sign(0.5,blh-lac))
        adpmp = adpmp+adblh*(0.5-sign(0.5,0.-pmp))
        adbl(i,j) = 0.
        addq(i,j+1) = addq(i,j+1)+1.5*adlac
        adpmp = adpmp+adlac
        adlac = 0.
        addq(i,j) = addq(i,j)-2*adpmp
        adpmp = 0.
        pmp = 2.*dq(i,j-1)
        lac = pmp-1.5*dq(i,j-2)
        brh = max(0.,pmp)
        bri = max(brh,lac)
        brk = min(0.,pmp)
        brl = min(brk,lac)
        brj = max(al(i,j+1)-v(i,j),brl)
        adbri = adbr(i,j)*(0.5+sign(0.5,brj-bri))
        adbrj = adbr(i,j)*(0.5-sign(0.5,brj-bri))
        adal(i,j+1) = adal(i,j+1)+adbrj*(0.5+sign(0.5,al(i,j+1)-v(i,j)-brl))
        adbrl = adbrj*(0.5-sign(0.5,al(i,j+1)-v(i,j)-brl))
        adv(i,j) = adv(i,j)-adbrj*(0.5+sign(0.5,al(i,j+1)-v(i,j)-brl))
        adbrk = adbrl*(0.5+sign(0.5,lac-brk))
        adlac = adlac+adbrl*(0.5-sign(0.5,lac-brk))
        adpmp = adpmp+adbrk*(0.5-sign(0.5,pmp-0.))
        adbrh = adbri*(0.5+sign(0.5,brh-lac))
        adlac = adlac+adbri*(0.5-sign(0.5,brh-lac))
        adpmp = adpmp+adbrh*(0.5-sign(0.5,0.-pmp))
        adbr(i,j) = 0.
        addq(i,j-2) = addq(i,j-2)-1.5*adlac
        adpmp = adpmp+adlac
        adlac = 0.
        addq(i,j-1) = addq(i,j-1)+2*adpmp
        adpmp = 0.
      end do
    end do
    do j = js-1, je+2
      do i = is, ie+1
        addm(i,j-1) = addm(i,j-1)+adal(i,j)*r3
        addm(i,j) = addm(i,j)-adal(i,j)*r3
        adv(i,j-1) = adv(i,j-1)+0.5*adal(i,j)
        adv(i,j) = adv(i,j)+0.5*adal(i,j)
        adal(i,j) = 0.
      end do
    end do
  endif
  do j = js-3, je+2
    do i = is, ie+1
      adv(i,j+1) = adv(i,j+1)+addq(i,j)
      adv(i,j) = adv(i,j)-addq(i,j)
      addq(i,j) = 0.
    end do
  end do
  do j = je+2, js-2, -1
    adxt = 0.
    do i = ie+1, is, -1
      adxt = 0.
      xt = 0.25*(v(i,j+1)-v(i,j-1))
      dmh = abs(xt)
      dmi = max(v(i,j-1),v(i,j))
      dmk = max(dmi,v(i,j+1))-v(i,j)
      dml = min(v(i,j-1),v(i,j))
      dmn = v(i,j)-min(dml,v(i,j+1))
      dmo = min(dmh,dmk)
      addmp = addm(i,j)*sign(1.,min(dmo,dmn))*sign(1.,xt)
      addmn = addmp*(0.5-sign(0.5,dmn-dmo))
      addmo = addmp*(0.5+sign(0.5,dmn-dmo))
      addmh = addmo*(0.5+sign(0.5,dmk-dmh))
      addmk = addmo*(0.5-sign(0.5,dmk-dmh))
      addmm = -addmn
      adv(i,j) = adv(i,j)+addmn
      addml = addmm*(0.5+sign(0.5,v(i,j+1)-dml))
      adv(i,j+1) = adv(i,j+1)+addmm*(0.5-sign(0.5,v(i,j+1)-dml))
      adv(i,j-1) = adv(i,j-1)+addml*(0.5+sign(0.5,v(i,j)-v(i,j-1)))
      adv(i,j) = adv(i,j)+addml*(0.5-sign(0.5,v(i,j)-v(i,j-1)))
      adv(i,j) = adv(i,j)-addmk
      addmi = addmk*(0.5+sign(0.5,dmi-v(i,j+1)))
      adv(i,j+1) = adv(i,j+1)+addmk*(0.5-sign(0.5,dmi-v(i,j+1)))
      adv(i,j-1) = adv(i,j-1)+addmi*(0.5+sign(0.5,v(i,j-1)-v(i,j)))
      adv(i,j) = adv(i,j)+addmi*(0.5-sign(0.5,v(i,j-1)-v(i,j)))
      adxt = adxt+addmh*sign(1.,xt)
      addm(i,j) = 0.
      adv(i,j-1) = adv(i,j-1)-0.25*adxt
      adv(i,j+1) = adv(i,j+1)+0.25*adxt
      adxt = 0.
    end do
  end do
endif

end subroutine adytp_v


subroutine mdc_sw( delpc, delp, ptc, pt, u, v, w, uc, vc, ua, va, wc, ut, vt, dt2, hydrostatic, dord4, taf_rec_npz )
!******************************************************************
!******************************************************************
!** This routine was generated by Automatic differentiation.     **
!** FastOpt: Transformation of Algorithm in Fortran, TAF 1.9.50  **
!******************************************************************
!******************************************************************
!==============================================
! referencing used modules
!==============================================
use adc_sw_store, only : tp_csw_c_sw,tp_csw_delp_23h,tp_csw_delp_39h,tp_csw_delp_50h,tp_csw_delp_57h,tp_csw_delp_76h,&
&tp_csw_fx1_124h,tp_csw_fx1_61h,tp_csw_fx1_86h,tp_csw_fx2_87h,tp_csw_fx_123h,tp_csw_fx_62h,tp_csw_fx_88h,tp_csw_fy1_121h,&
&tp_csw_fy1_63h,tp_csw_fy_122h,tp_csw_fy_64h,tp_csw_ke_95h,tp_csw_pt_24h,tp_csw_pt_40h,tp_csw_pt_52h,tp_csw_pt_58h,tp_csw_pt_77h,&
&tp_csw_u_115h,tp_csw_ua_11h,tp_csw_ua_96h,tp_csw_uc_111h,tp_csw_ut_27h,tp_csw_ut_35h,tp_csw_v_110h,tp_csw_va_12h,tp_csw_va_97h,&
&tp_csw_vc_116h,tp_csw_vort_98h,tp_csw_vt_18h,tp_csw_vt_81h,tp_csw_w_41h,tp_csw_w_82h

!==============================================
! all entries are defined explicitly
!==============================================
implicit none

!==============================================
! declare arguments
!==============================================
real, intent(inout) :: delp(isd:ied,jsd:jed)
real, intent(out) :: delpc(isd:ied,jsd:jed)
logical, intent(in) :: dord4
real, intent(in) :: dt2
logical, intent(in) :: hydrostatic
real, intent(inout) :: pt(isd:ied,jsd:jed)
real, intent(out) :: ptc(isd:ied,jsd:jed)
integer :: taf_rec_npz
real, intent(inout) :: u(isd:ied,jsd:jed+1)
real, intent(inout) :: ua(isd:ied,jsd:jed)
real, intent(inout) :: uc(isd:ied+1,jsd:jed)
real, intent(out) :: ut(isd:ied,jsd:jed)
real, intent(inout) :: v(isd:ied+1,jsd:jed)
real, intent(inout) :: va(isd:ied,jsd:jed)
real, intent(inout) :: vc(isd:ied,jsd:jed+1)
real, intent(out) :: vt(isd:ied,jsd:jed)
real, intent(inout) :: w(isd:ied,jsd:jed)
real, intent(out) :: wc(isd:ied,jsd:jed)

!==============================================
! declare local variables
!==============================================
real :: dt4
real :: fx(is-1:ie+2,js-1:je+1)
real :: fx1(is-1:ie+2,js-1:je+1)
real :: fx2(is-1:ie+2,js-1:je+1)
real :: fy(is-1:ie+1,js-1:je+2)
real :: fy1(is-1:ie+1,js-1:je+2)
real :: fy2(is-1:ie+1,js-1:je+2)
integer :: i
integer :: ie1
integer :: iep1
integer :: is2
integer :: j
integer :: jep1
real :: ke(is-1:ie+1,js-1:je+1)
real :: vort(is-1:ie+1,js-1:je+1)

!**********************************************
! executable statements of routine
!**********************************************
vort(is-1,js-1) = 0.
vort(ie+1,je+1) = 0.
ke(is-1,js-1) = 0.
ke(ie+1,je+1) = 0.
fx(is-1,js-1) = 0.
fx(ie+1:ie+2,je+1) = 0.
fx1(is-1,js-1) = 0.
fx1(ie+1:ie+2,je+1) = 0.
fx2(is-1,js-1) = 0.
fx2(ie+1:ie+2,je+1) = 0.
fy(is-1,js-1) = 0.
fy(ie+1,je+1:je+2) = 0.
fy1(is-1,js-1) = 0.
fy1(ie+1,je+1:je+2) = 0.
fy2(is-1,js-1) = 0.
fy2(ie+1,je+1:je+2) = 0.
iep1 = ie+1
jep1 = je+1
call d2a2c_vect( u,v,ua,va,uc,vc,ut,vt,dord4 )
if ( .not. allocated(tp_csw_ua_11h)) then
  allocate( tp_csw_ua_11h(isd:ied,jsd:jed,tp_csw_c_sw) )
endif
tp_csw_ua_11h(:,:,taf_rec_npz) = ua
if ( .not. allocated(tp_csw_va_12h)) then
  allocate( tp_csw_va_12h(isd:ied,jsd:jed,tp_csw_c_sw) )
endif
tp_csw_va_12h(:,:,taf_rec_npz) = va
if ( .not. allocated(tp_csw_vt_18h)) then
  allocate( tp_csw_vt_18h(isd:ied,jsd:jed,tp_csw_c_sw) )
endif
tp_csw_vt_18h(:,:,taf_rec_npz) = vt
do j = js-1, jep1
  do i = is-1, iep1+1
    ut(i,j) = dt2*ut(i,j)*dy(i,j)*sina_u(i,j)
  end do
end do
do j = js-1, jep1+1
  do i = is-1, iep1
    vt(i,j) = dt2*vt(i,j)*dx(i,j)*sina_v(i,j)
  end do
end do
if (grid_type .lt. 3) then
  call fill2_4corners( delp,pt,1 )
endif
if (hydrostatic) then
  if ( .not. allocated(tp_csw_delp_23h)) then
    allocate( tp_csw_delp_23h(isd:ied,jsd:jed,tp_csw_c_sw) )
  endif
  tp_csw_delp_23h(:,:,taf_rec_npz) = delp
  if ( .not. allocated(tp_csw_pt_24h)) then
    allocate( tp_csw_pt_24h(isd:ied,jsd:jed,tp_csw_c_sw) )
  endif
  tp_csw_pt_24h(:,:,taf_rec_npz) = pt
  if ( .not. allocated(tp_csw_ut_27h)) then
    allocate( tp_csw_ut_27h(isd:ied,jsd:jed,tp_csw_c_sw) )
  endif
  tp_csw_ut_27h(:,:,taf_rec_npz) = ut
  do j = js-1, jep1
    do i = is-1, iep1+1
      if (ut(i,j) .gt. 0.) then
        fx1(i,j) = delp(i-1,j)
        fx(i,j) = pt(i-1,j)
      else
        fx1(i,j) = delp(i,j)
        fx(i,j) = pt(i,j)
      endif
      fx1(i,j) = ut(i,j)*fx1(i,j)
      fx(i,j) = fx1(i,j)*fx(i,j)
    end do
  end do
else
  if (grid_type .lt. 3) then
    call fill_4corners( w,1 )
  endif
  if ( .not. allocated(tp_csw_ut_35h)) then
    allocate( tp_csw_ut_35h(isd:ied,jsd:jed,tp_csw_c_sw) )
  endif
  tp_csw_ut_35h(:,:,taf_rec_npz) = ut
  if ( .not. allocated(tp_csw_delp_39h)) then
    allocate( tp_csw_delp_39h(isd:ied,jsd:jed,tp_csw_c_sw) )
  endif
  tp_csw_delp_39h(:,:,taf_rec_npz) = delp
  if ( .not. allocated(tp_csw_pt_40h)) then
    allocate( tp_csw_pt_40h(isd:ied,jsd:jed,tp_csw_c_sw) )
  endif
  tp_csw_pt_40h(:,:,taf_rec_npz) = pt
  if ( .not. allocated(tp_csw_w_41h)) then
    allocate( tp_csw_w_41h(isd:ied,jsd:jed,tp_csw_c_sw) )
  endif
  tp_csw_w_41h(:,:,taf_rec_npz) = w
  do j = js-1, je+1
    do i = is-1, ie+2
      if (ut(i,j) .gt. 0.) then
        fx1(i,j) = delp(i-1,j)
        fx(i,j) = pt(i-1,j)
        fx2(i,j) = w(i-1,j)
      else
        fx1(i,j) = delp(i,j)
        fx(i,j) = pt(i,j)
        fx2(i,j) = w(i,j)
      endif
      fx1(i,j) = ut(i,j)*fx1(i,j)
      fx(i,j) = fx1(i,j)*fx(i,j)
      fx2(i,j) = fx1(i,j)*fx2(i,j)
    end do
  end do
endif
if (grid_type .lt. 3) then
  call fill2_4corners( delp,pt,2 )
endif
if (hydrostatic) then
  if ( .not. allocated(tp_csw_delp_50h)) then
    allocate( tp_csw_delp_50h(isd:ied,jsd:jed,tp_csw_c_sw) )
  endif
  tp_csw_delp_50h(:,:,taf_rec_npz) = delp
  if ( .not. allocated(tp_csw_pt_52h)) then
    allocate( tp_csw_pt_52h(isd:ied,jsd:jed,tp_csw_c_sw) )
  endif
  tp_csw_pt_52h(:,:,taf_rec_npz) = pt
  do j = js-1, jep1+1
    do i = is-1, iep1
      if (vt(i,j) .gt. 0.) then
        fy1(i,j) = delp(i,j-1)
        fy(i,j) = pt(i,j-1)
      else
        fy1(i,j) = delp(i,j)
        fy(i,j) = pt(i,j)
      endif
      fy1(i,j) = vt(i,j)*fy1(i,j)
      fy(i,j) = fy1(i,j)*fy(i,j)
    end do
  end do
  if ( .not. allocated(tp_csw_delp_57h)) then
    allocate( tp_csw_delp_57h(isd:ied,jsd:jed,tp_csw_c_sw) )
  endif
  tp_csw_delp_57h(:,:,taf_rec_npz) = delp
  if ( .not. allocated(tp_csw_pt_58h)) then
    allocate( tp_csw_pt_58h(isd:ied,jsd:jed,tp_csw_c_sw) )
  endif
  tp_csw_pt_58h(:,:,taf_rec_npz) = pt
  if ( .not. allocated(tp_csw_fx1_61h)) then
    allocate( tp_csw_fx1_61h(is-1:ie+2,js-1:je+1,tp_csw_c_sw) )
  endif
  tp_csw_fx1_61h(:,:,taf_rec_npz) = fx1
  if ( .not. allocated(tp_csw_fx_62h)) then
    allocate( tp_csw_fx_62h(is-1:ie+2,js-1:je+1,tp_csw_c_sw) )
  endif
  tp_csw_fx_62h(:,:,taf_rec_npz) = fx
  if ( .not. allocated(tp_csw_fy1_63h)) then
    allocate( tp_csw_fy1_63h(is-1:ie+1,js-1:je+2,tp_csw_c_sw) )
  endif
  tp_csw_fy1_63h(:,:,taf_rec_npz) = fy1
  if ( .not. allocated(tp_csw_fy_64h)) then
    allocate( tp_csw_fy_64h(is-1:ie+1,js-1:je+2,tp_csw_c_sw) )
  endif
  tp_csw_fy_64h(:,:,taf_rec_npz) = fy
  do j = js-1, jep1
    do i = is-1, iep1
      delpc(i,j) = delp(i,j)+(fx1(i,j)-fx1(i+1,j)+fy1(i,j)-fy1(i,j+1))*rarea(i,j)
      ptc(i,j) = (pt(i,j)*delp(i,j)+(fx(i,j)-fx(i+1,j)+fy(i,j)-fy(i,j+1))*rarea(i,j))/delpc(i,j)
    end do
  end do
else
  if (grid_type .lt. 3) then
    call fill_4corners( w,2 )
  endif
  if ( .not. allocated(tp_csw_delp_76h)) then
    allocate( tp_csw_delp_76h(isd:ied,jsd:jed,tp_csw_c_sw) )
  endif
  tp_csw_delp_76h(:,:,taf_rec_npz) = delp
  if ( .not. allocated(tp_csw_pt_77h)) then
    allocate( tp_csw_pt_77h(isd:ied,jsd:jed,tp_csw_c_sw) )
  endif
  tp_csw_pt_77h(:,:,taf_rec_npz) = pt
  if ( .not. allocated(tp_csw_vt_81h)) then
    allocate( tp_csw_vt_81h(isd:ied,jsd:jed,tp_csw_c_sw) )
  endif
  tp_csw_vt_81h(:,:,taf_rec_npz) = vt
  if ( .not. allocated(tp_csw_w_82h)) then
    allocate( tp_csw_w_82h(isd:ied,jsd:jed,tp_csw_c_sw) )
  endif
  tp_csw_w_82h(:,:,taf_rec_npz) = w
  if ( .not. allocated(tp_csw_fx1_86h)) then
    allocate( tp_csw_fx1_86h(is-1:ie+2,js-1:je+1,tp_csw_c_sw) )
  endif
  tp_csw_fx1_86h(:,:,taf_rec_npz) = fx1
  if ( .not. allocated(tp_csw_fx2_87h)) then
    allocate( tp_csw_fx2_87h(is-1:ie+2,js-1:je+1,tp_csw_c_sw) )
  endif
  tp_csw_fx2_87h(:,:,taf_rec_npz) = fx2
  if ( .not. allocated(tp_csw_fx_88h)) then
    allocate( tp_csw_fx_88h(is-1:ie+2,js-1:je+1,tp_csw_c_sw) )
  endif
  tp_csw_fx_88h(:,:,taf_rec_npz) = fx
  do j = js-1, je+2
    do i = is-1, ie+1
      if (vt(i,j) .gt. 0.) then
        fy1(i,j) = delp(i,j-1)
        fy(i,j) = pt(i,j-1)
        fy2(i,j) = w(i,j-1)
      else
        fy1(i,j) = delp(i,j)
        fy(i,j) = pt(i,j)
        fy2(i,j) = w(i,j)
      endif
      fy1(i,j) = vt(i,j)*fy1(i,j)
      fy(i,j) = fy1(i,j)*fy(i,j)
      fy2(i,j) = fy1(i,j)*fy2(i,j)
    end do
  end do
  do j = js-1, je+1
    do i = is-1, ie+1
      delpc(i,j) = delp(i,j)+(fx1(i,j)-fx1(i+1,j)+fy1(i,j)-fy1(i,j+1))*rarea(i,j)
      ptc(i,j) = (pt(i,j)*delp(i,j)+(fx(i,j)-fx(i+1,j)+fy(i,j)-fy(i,j+1))*rarea(i,j))/delpc(i,j)
      wc(i,j) = (w(i,j)*delp(i,j)+(fx2(i,j)-fx2(i+1,j)+fy2(i,j)-fy2(i,j+1))*rarea(i,j))/delpc(i,j)
    end do
  end do
endif
do j = js-1, jep1
  do i = is-1, iep1
    if (ua(i,j) .gt. 0.) then
      if (i .eq. 1) then
        ke(1,j) = uc(1,j)*sina_u(1,j)+v(1,j)*cosa_u(1,j)
      else if (i .eq. npx) then
        ke(i,j) = uc(npx,j)*sina_u(npx,j)-v(npx,j)*cosa_u(npx,j)
      else
        ke(i,j) = uc(i,j)
      endif
    else
      if (i .eq. 0) then
        ke(0,j) = uc(1,j)*sina_u(1,j)-v(1,j)*cosa_u(1,j)
      else if (i .eq. npx-1) then
        ke(i,j) = uc(npx,j)*sina_u(npx,j)+v(npx,j)*cosa_u(npx,j)
      else
        ke(i,j) = uc(i+1,j)
      endif
    endif
  end do
end do
do j = js-1, jep1
  do i = is-1, iep1
    if (va(i,j) .gt. 0.) then
      if (j .eq. 1) then
        vort(i,1) = vc(i,1)*sina_v(i,1)+u(i,1)*cosa_v(i,1)
      else if (j .eq. npy) then
        vort(i,j) = vc(i,npy)*sina_v(i,npy)-u(i,npy)*cosa_v(i,npy)
      else
        vort(i,j) = vc(i,j)
      endif
    else
      if (j .eq. 0) then
        vort(i,0) = vc(i,1)*sina_v(i,1)-u(i,1)*cosa_v(i,1)
      else if (j .eq. npy-1) then
        vort(i,j) = vc(i,npy)*sina_v(i,npy)+u(i,npy)*cosa_v(i,npy)
      else
        vort(i,j) = vc(i,j+1)
      endif
    endif
  end do
end do
if ( .not. allocated(tp_csw_ke_95h)) then
  allocate( tp_csw_ke_95h(is-1:ie+1,js-1:je+1,tp_csw_c_sw) )
endif
tp_csw_ke_95h(:,:,taf_rec_npz) = ke
if ( .not. allocated(tp_csw_ua_96h)) then
  allocate( tp_csw_ua_96h(isd:ied,jsd:jed,tp_csw_c_sw) )
endif
tp_csw_ua_96h(:,:,taf_rec_npz) = ua
if ( .not. allocated(tp_csw_va_97h)) then
  allocate( tp_csw_va_97h(isd:ied,jsd:jed,tp_csw_c_sw) )
endif
tp_csw_va_97h(:,:,taf_rec_npz) = va
if ( .not. allocated(tp_csw_vort_98h)) then
  allocate( tp_csw_vort_98h(is-1:ie+1,js-1:je+1,tp_csw_c_sw) )
endif
tp_csw_vort_98h(:,:,taf_rec_npz) = vort
dt4 = 0.5*dt2
do j = js-1, jep1
  do i = is-1, iep1
    ke(i,j) = dt4*(ua(i,j)*ke(i,j)+va(i,j)*vort(i,j))
  end do
end do
is2 = max(2,is)
ie1 = min(npx-1,ie+1)
do j = js-1, je+1
  do i = is2, ie1
    fx(i,j) = uc(i,j)*dxc(i,j)
  end do
  if (is .eq. 1) then
    fx(1,j) = uc(1,j)*sina_u(1,j)*dxc(1,j)
  endif
  if (ie+1 .eq. npx) then
    fx(npx,j) = uc(npx,j)*sina_u(npx,j)*dxc(npx,j)
  endif
end do
do j = js, je+1
  if (j .eq. 1 .or. j .eq. npy) then
    do i = is-1, ie+1
      fy(i,j) = vc(i,j)*sina_v(i,j)*dyc(i,j)
    end do
  else
    do i = is-1, ie+1
      fy(i,j) = vc(i,j)*dyc(i,j)
    end do
  endif
end do
do j = js, je+1
  do i = is, ie+1
    vort(i,j) = fx(i,j-1)-fx(i,j)-fy(i-1,j)+fy(i,j)
  end do
end do
if (sw_corner) then
  vort(1,1) = vort(1,1)+fy(0,1)
endif
if (se_corner) then
  vort(npx,1) = vort(npx,1)-fy(npx,1)
endif
if (ne_corner) then
  vort(npx,npy) = vort(npx,npy)-fy(npx,npy)
endif
if (nw_corner) then
  vort(1,npy) = vort(1,npy)+fy(0,npy)
endif
do j = js, je+1
  do i = is, ie+1
    vort(i,j) = fc(i,j)+rarea_c(i,j)*vort(i,j)
  end do
end do
if ( .not. allocated(tp_csw_v_110h)) then
  allocate( tp_csw_v_110h(isd:ied+1,jsd:jed,tp_csw_c_sw) )
endif
tp_csw_v_110h(:,:,taf_rec_npz) = v
if ( .not. allocated(tp_csw_uc_111h)) then
  allocate( tp_csw_uc_111h(isd:ied+1,jsd:jed,tp_csw_c_sw) )
endif
tp_csw_uc_111h(:,:,taf_rec_npz) = uc
do j = js, je
  do i = is, iep1
    if (i .eq. 1 .or. i .eq. npx) then
      fy1(i,j) = dt2*v(i,j)*sina_u(i,j)
    else
      fy1(i,j) = dt2*(v(i,j)-uc(i,j)*cosa_u(i,j))/sina_u(i,j)
    endif
    if (fy1(i,j) .gt. 0.) then
      fy(i,j) = vort(i,j)
    else
      fy(i,j) = vort(i,j+1)
    endif
  end do
end do
if ( .not. allocated(tp_csw_u_115h)) then
  allocate( tp_csw_u_115h(isd:ied,jsd:jed+1,tp_csw_c_sw) )
endif
tp_csw_u_115h(:,:,taf_rec_npz) = u
if ( .not. allocated(tp_csw_vc_116h)) then
  allocate( tp_csw_vc_116h(isd:ied,jsd:jed+1,tp_csw_c_sw) )
endif
tp_csw_vc_116h(:,:,taf_rec_npz) = vc
do j = js, jep1
  if (j .eq. 1 .or. j .eq. npy) then
    do i = is, ie
      fx1(i,j) = dt2*u(i,j)*sina_v(i,j)
      if (fx1(i,j) .gt. 0.) then
        fx(i,j) = vort(i,j)
      else
        fx(i,j) = vort(i+1,j)
      endif
    end do
  else
    do i = is, ie
      fx1(i,j) = dt2*(u(i,j)-vc(i,j)*cosa_v(i,j))/sina_v(i,j)
      if (fx1(i,j) .gt. 0.) then
        fx(i,j) = vort(i,j)
      else
        fx(i,j) = vort(i+1,j)
      endif
    end do
  endif
end do
if ( .not. allocated(tp_csw_fy1_121h)) then
  allocate( tp_csw_fy1_121h(is-1:ie+1,js-1:je+2,tp_csw_c_sw) )
endif
tp_csw_fy1_121h(:,:,taf_rec_npz) = fy1
if ( .not. allocated(tp_csw_fy_122h)) then
  allocate( tp_csw_fy_122h(is-1:ie+1,js-1:je+2,tp_csw_c_sw) )
endif
tp_csw_fy_122h(:,:,taf_rec_npz) = fy
if ( .not. allocated(tp_csw_fx_123h)) then
  allocate( tp_csw_fx_123h(is-1:ie+2,js-1:je+1,tp_csw_c_sw) )
endif
tp_csw_fx_123h(:,:,taf_rec_npz) = fx
if ( .not. allocated(tp_csw_fx1_124h)) then
  allocate( tp_csw_fx1_124h(is-1:ie+2,js-1:je+1,tp_csw_c_sw) )
endif
tp_csw_fx1_124h(:,:,taf_rec_npz) = fx1
do j = js, je
  do i = is, iep1
    uc(i,j) = uc(i,j)+fy1(i,j)*fy(i,j)+rdxc(i,j)*(ke(i-1,j)-ke(i,j))
  end do
end do
do j = js, jep1
  do i = is, ie
    vc(i,j) = vc(i,j)-fx1(i,j)*fx(i,j)+rdyc(i,j)*(ke(i,j-1)-ke(i,j))
  end do
end do
end subroutine mdc_sw


subroutine mdd_sw( delpc, delp, ptc, pt, u, v, w, uc, vc, ua, va, divg_d, xflux, yflux, cx, cy, crx_adv, cry_adv, xfx_adv, yfx_adv,&
& dt, hord_mt, hord_vt, hord_tm, dddmp, dddm4, hydrostatic, uniform_ppm, taf_rec_npz )
!******************************************************************
!******************************************************************
!** This routine was generated by Automatic differentiation.     **
!** FastOpt: Transformation of Algorithm in Fortran, TAF 1.9.50  **
!******************************************************************
!******************************************************************
!==============================================
! referencing used modules
!==============================================
use add_sw_store, only : tp_dsw_crx_adv_150h,tp_dsw_crx_adv_195h,tp_dsw_crx_adv_221h,tp_dsw_crx_adv_332h,tp_dsw_cry_adv_151h,&
&tp_dsw_cry_adv_196h,tp_dsw_cry_adv_222h,tp_dsw_cry_adv_333h,tp_dsw_d_sw,tp_dsw_delp_149h,tp_dsw_delp_217h,tp_dsw_delp_254h,&
&tp_dsw_delp_255h,tp_dsw_fx_152h,tp_dsw_fx_203h,tp_dsw_fx_229h,tp_dsw_fx_251h,tp_dsw_fx_334h,tp_dsw_fy_153h,tp_dsw_fy_204h,&
&tp_dsw_fy_230h,tp_dsw_fy_252h,tp_dsw_fy_335h,tp_dsw_gy_198h,tp_dsw_gy_224h,tp_dsw_gy_246h,tp_dsw_pt_220h,tp_dsw_pt_253h,&
&tp_dsw_ra_x_156h,tp_dsw_ra_x_201h,tp_dsw_ra_x_227h,tp_dsw_ra_x_338h,tp_dsw_ra_y_157h,tp_dsw_ra_y_202h,tp_dsw_ra_y_228h,&
&tp_dsw_ra_y_339h,tp_dsw_u_287h,tp_dsw_u_303h,tp_dsw_ub_197h,tp_dsw_ub_223h,tp_dsw_ub_245h,tp_dsw_ub_274h,tp_dsw_ub_286h,&
&tp_dsw_ub_295h,tp_dsw_ut_301h,tp_dsw_v_266h,tp_dsw_v_304h,tp_dsw_vb_264h,tp_dsw_vb_273h,tp_dsw_vb_296h,tp_dsw_vort_331h,&
&tp_dsw_vt_302h,tp_dsw_w_194h,tp_dsw_w_216h,tp_dsw_w_256h,tp_dsw_xfx_adv_125h,tp_dsw_xfx_adv_154h,tp_dsw_xfx_adv_199h,&
&tp_dsw_xfx_adv_225h,tp_dsw_xfx_adv_336h,tp_dsw_yfx_adv_134h,tp_dsw_yfx_adv_155h,tp_dsw_yfx_adv_200h,tp_dsw_yfx_adv_226h,&
&tp_dsw_yfx_adv_337h

!==============================================
! all entries are defined explicitly
!==============================================
implicit none

!==============================================
! declare parameters
!==============================================
real, parameter :: r3 = 1./3.

!==============================================
! declare arguments
!==============================================
real, intent(out) :: crx_adv(is:ie+1,jsd:jed)
real, intent(out) :: cry_adv(isd:ied,js:je+1)
real, intent(inout) :: cx(is:ie+1,jsd:jed)
real, intent(inout) :: cy(isd:ied,js:je+1)
real, intent(in) :: dddm4
real, intent(in) :: dddmp
real, intent(inout) :: delp(isd:ied,jsd:jed)
real, intent(out) :: delpc(isd:ied,jsd:jed)
real, intent(in) :: divg_d(isd:ied+1,jsd:jed+1)
real, intent(in) :: dt
integer, intent(in) :: hord_mt
integer, intent(in) :: hord_tm
integer, intent(in) :: hord_vt
logical, intent(in) :: hydrostatic
real, intent(inout) :: pt(isd:ied,jsd:jed)
real, intent(out) :: ptc(isd:ied,jsd:jed)
integer :: taf_rec_npz
real, intent(inout) :: u(isd:ied,jsd:jed+1)
real, intent(inout) :: ua(isd:ied,jsd:jed)
real, intent(inout) :: uc(isd:ied+1,jsd:jed)
logical, intent(in) :: uniform_ppm
real, intent(inout) :: v(isd:ied+1,jsd:jed)
real, intent(inout) :: va(isd:ied,jsd:jed)
real, intent(inout) :: vc(isd:ied,jsd:jed+1)
real, intent(inout) :: w(isd:ied,jsd:jed)
real, intent(inout) :: xflux(is:ie+1,js:je)
real, intent(out) :: xfx_adv(is:ie+1,jsd:jed)
real, intent(inout) :: yflux(is:ie,js:je+1)
real, intent(out) :: yfx_adv(isd:ied,js:je+1)

!==============================================
! declare local variables
!==============================================
real :: damp
real :: damp4
real :: damp_divg
real :: dt4
real :: dt5
real :: dt6
real :: fx(is:ie+1,js:je)
real :: fx_kill(is:ie+1,js:je)
real :: fy(is:ie,js:je+1)
real :: fy_kill(is:ie,js:je+1)
real :: gy(is:ie,js:je+1)
integer :: i
integer :: ie1
integer :: is2
integer :: j
integer :: je1
integer :: js2
real :: ke(isd:ied+1,jsd:jed+1)
real :: ke_ub(isd:ied+1,jsd:jed+1)
real :: ke_vb(isd:ied+1,jsd:jed+1)
real :: ra_x(is:ie,jsd:jed)
real :: ra_y(isd:ied,js:je)
real :: ub(is:ie+1,js:je+1)
real :: ut(is-1:ie+2,jsd:jed)
real :: vb(is:ie+1,js:je+1)
real :: vort(isd:ied,jsd:jed)
real :: vt(isd:ied,js-1:je+2)
real :: wk(isd:ied+1,jsd:jed+1)

!**********************************************
! executable statements of routine
!**********************************************
ub = 0.
vb = 0.
ut = 0.
vt = 0.
wk = 0.
ke = 0.
ke_ub = 0.
ke_vb = 0.
vort = 0.
fx = 0.
fy = 0.
gy = 0.
ra_x = 0.
ra_y = 0.
fx_kill = 0.
fy_kill = 0.
if (grid_type .lt. 3) then
  do j = jsd, jed
    if (j .ne. 0 .and. j .ne. 1 .and. j .ne. npy-1 .and. j .ne. npy) then
      do i = is-1, ie+2
        ut(i,j) = (uc(i,j)-0.25*cosa_u(i,j)*(vc(i-1,j)+vc(i,j)+vc(i-1,j+1)+vc(i,j+1)))*rsin_u(i,j)
      end do
    endif
  end do
  do j = js-1, je+2
    if (j .ne. 1 .and. j .ne. npy) then
      do i = isd, ied
        vt(i,j) = (vc(i,j)-0.25*cosa_v(i,j)*(uc(i,j-1)+uc(i+1,j-1)+uc(i,j)+uc(i+1,j)))*rsin_v(i,j)
      end do
    endif
  end do
  if (is .eq. 1) then
    do j = jsd, jed
      ut(1,j) = uc(1,j)*rsin_u(1,j)
    end do
    do j = max(3,js), min(npy-2,je+1)
      vt(0,j) = vc(0,j)+0.25*cosa_v(1,j)*(ut(0,j-1)+ut(1,j-1)+ut(0,j)+ut(1,j))
      vt(1,j) = vc(1,j)-0.25*cosa_v(1,j)*(ut(1,j-1)+ut(2,j-1)+ut(1,j)+ut(2,j))
    end do
  endif
  if (ie+1 .eq. npx) then
    do j = jsd, jed
      ut(npx,j) = uc(npx,j)*rsin_u(npx,j)
    end do
    do j = max(3,js), min(npy-2,je+1)
      vt(npx-1,j) = vc(npx-1,j)-0.25*cosa_v(npx-1,j)*(ut(npx-1,j-1)+ut(npx,j-1)+ut(npx-1,j)+ut(npx,j))
      vt(npx,j) = vc(npx,j)+0.25*cosa_v(npx-1,j)*(ut(npx,j-1)+ut(npx+1,j-1)+ut(npx,j)+ut(npx+1,j))
    end do
  endif
  if (js .eq. 1) then
    do i = isd, ied
      vt(i,1) = vc(i,1)*rsin_v(i,1)
    end do
    do i = max(3,is), min(npx-2,ie+1)
      ut(i,0) = uc(i,0)+0.25*cosa_u(i,1)*(vt(i-1,0)+vt(i,0)+vt(i-1,1)+vt(i,1))
      ut(i,1) = uc(i,1)-0.25*cosa_u(i,1)*(vt(i-1,1)+vt(i,1)+vt(i-1,2)+vt(i,2))
    end do
  endif
  if (je+1 .eq. npy) then
    do i = isd, ied
      vt(i,npy) = vc(i,npy)*rsin_v(i,npy)
    end do
    do i = max(3,is), min(npx-2,ie+1)
      ut(i,npy-1) = uc(i,npy-1)-0.25*cosa_u(i,npy-1)*(vt(i-1,npy-1)+vt(i,npy-1)+vt(i-1,npy)+vt(i,npy))
      ut(i,npy) = uc(i,npy)+0.25*cosa_u(i,npy-1)*(vt(i-1,npy)+vt(i,npy)+vt(i-1,npy+1)+vt(i,npy+1))
    end do
  endif
  if (sw_corner) then
    damp = 1./(1.-0.0625*cosa_u(2,1)*cosa_v(1,2))
    ut(2,0) = (uc(2,0)-0.25*cosa_u(2,0)*(vt(1,1)+vt(2,1)+vt(2,0)+vc(1,0)-0.25*cosa_v(1,0)*(ut(1,0)+ut(1,-1)+ut(2,-1))))*damp
    ut(2,1) = (uc(2,1)-0.25*cosa_u(2,1)*(vt(1,1)+vt(2,1)+vt(2,2)+vc(1,2)-0.25*cosa_v(1,2)*(ut(1,1)+ut(1,2)+ut(2,2))))*damp
    vt(1,2) = (vc(1,2)-0.25*cosa_v(1,2)*(ut(1,1)+ut(1,2)+ut(2,2)+uc(2,1)-0.25*cosa_u(2,1)*(vt(1,1)+vt(2,1)+vt(2,2))))*damp
    vt(0,2) = (vc(0,2)-0.25*cosa_v(0,2)*(ut(1,1)+ut(1,2)+ut(0,2)+uc(0,1)-0.25*cosa_u(0,1)*(vt(0,1)+vt(-1,1)+vt(-1,2))))*damp
  endif
  if (se_corner) then
    damp = 1./(1.-0.0625*cosa_u(npx-1,1)*cosa_v(npx-1,2))
    ut(npx-1,0) = (uc(npx-1,0)+0.25*cosa_u(npx-1,1)*(vt(npx-1,1)+vt(npx-2,1)+vt(npx-2,0)+vc(npx-1,0)+0.25*cosa_v(npx-1,2)*(ut(npx,&
&0)+ut(npx,-1)+ut(npx-1,-1))))*damp
    ut(npx-1,1) = (uc(npx-1,1)-0.25*cosa_u(npx-1,1)*(vt(npx-1,1)+vt(npx-2,1)+vt(npx-2,2)+vc(npx-1,2)-0.25*cosa_v(npx-1,2)*(ut(npx,&
&1)+ut(npx,2)+ut(npx-1,2))))*damp
    vt(npx-1,2) = (vc(npx-1,2)-0.25*cosa_v(npx-1,2)*(ut(npx,1)+ut(npx,2)+ut(npx-1,2)+uc(npx-1,1)-0.25*cosa_u(npx-1,1)*(vt(npx-1,1)+&
&vt(npx-2,1)+vt(npx-2,2))))*damp
    vt(npx,2) = (vc(npx,2)+0.25*cosa_v(npx-1,2)*(ut(npx,1)+ut(npx,2)+ut(npx+1,2)+uc(npx+1,1)+0.25*cosa_u(npx-1,1)*(vt(npx,1)+&
&vt(npx+1,1)+vt(npx+1,2))))*damp
  endif
  if (ne_corner) then
    damp = 1./(1.-0.0625*cosa_u(npx-1,npy-1)*cosa_v(npx-1,npy-1))
    ut(npx-1,npy) = (uc(npx-1,npy)+0.25*cosa_u(npx-1,npy-1)*(vt(npx-1,npy)+vt(npx-2,npy)+vt(npx-2,npy+1)+vc(npx-1,npy+1)+0.25*&
&cosa_v(npx-1,npy-1)*(ut(npx,npy)+ut(npx,npy+1)+ut(npx-1,npy+1))))*damp
    ut(npx-1,npy-1) = (uc(npx-1,npy-1)-0.25*cosa_u(npx-1,npy-1)*(vt(npx-1,npy)+vt(npx-2,npy)+vt(npx-2,npy-1)+vc(npx-1,npy-1)-0.25*&
&cosa_v(npx-1,npy-1)*(ut(npx,npy-1)+ut(npx,npy-2)+ut(npx-1,npy-2))))*damp
    vt(npx-1,npy-1) = (vc(npx-1,npy-1)-0.25*cosa_v(npx-1,npy-1)*(ut(npx,npy-1)+ut(npx,npy-2)+ut(npx-1,npy-2)+uc(npx-1,npy-1)-0.25*&
&cosa_u(npx-1,npy-1)*(vt(npx-1,npy)+vt(npx-2,npy)+vt(npx-2,npy-1))))*damp
    vt(npx,npy-1) = (vc(npx,npy-1)+0.25*cosa_v(npx-1,npy-1)*(ut(npx,npy-1)+ut(npx,npy-2)+ut(npx+1,npy-2)+uc(npx+1,npy-1)+0.25*&
&cosa_u(npx-1,npy-1)*(vt(npx,npy)+vt(npx+1,npy)+vt(npx+1,npy-1))))*damp
  endif
  if (nw_corner) then
    damp = 1./(1.-0.0625*cosa_u(2,npy-1)*cosa_v(1,npy-1))
    ut(2,npy) = (uc(2,npy)+0.25*cosa_u(2,npy-1)*(vt(1,npy)+vt(2,npy)+vt(2,npy+1)+vc(1,npy+1)+0.25*cosa_v(1,npy-1)*(ut(1,npy)+ut(1,&
&npy+1)+ut(2,npy+1))))*damp
    ut(2,npy-1) = (uc(2,npy-1)-0.25*cosa_u(2,npy-1)*(vt(1,npy)+vt(2,npy)+vt(2,npy-1)+vc(1,npy-1)-0.25*cosa_v(1,npy-1)*(ut(1,npy-1)+&
&ut(1,npy-2)+ut(2,npy-2))))*damp
    vt(1,npy-1) = (vc(1,npy-1)-0.25*cosa_v(1,npy-1)*(ut(1,npy-1)+ut(1,npy-2)+ut(2,npy-2)+uc(2,npy-1)-0.25*cosa_u(2,npy-1)*(vt(1,&
&npy)+vt(2,npy)+vt(2,npy-1))))*damp
    vt(0,npy-1) = (vc(0,npy-1)+0.25*cosa_v(1,npy-1)*(ut(1,npy-1)+ut(1,npy-2)+ut(0,npy-2)+uc(0,npy-1)+0.25*cosa_u(2,npy-1)*(vt(0,&
&npy)+vt(-1,npy)+vt(-1,npy-1))))*damp
  endif
else
  do j = jsd, jed
    do i = is-1, ie+2
      ut(i,j) = uc(i,j)
    end do
  end do
  do j = js-1, je+2
    do i = isd, ied
      vt(i,j) = vc(i,j)
    end do
  end do
endif
do j = jsd, jed
  do i = is, ie+1
    xfx_adv(i,j) = dt*ut(i,j)
  end do
end do
do j = js, je+1
  do i = isd, ied
    yfx_adv(i,j) = dt*vt(i,j)
  end do
end do
if ( .not. allocated(tp_dsw_xfx_adv_125h)) then
  allocate( tp_dsw_xfx_adv_125h(is:ie+1,jsd:jed,tp_dsw_d_sw) )
endif
tp_dsw_xfx_adv_125h(:,:,taf_rec_npz) = xfx_adv
do j = jsd, jed
  do i = is, ie+1
    if (xfx_adv(i,j) .gt. 0.) then
      crx_adv(i,j) = xfx_adv(i,j)*rdxa(i-1,j)
    else
      crx_adv(i,j) = xfx_adv(i,j)*rdxa(i,j)
    endif
  end do
end do
do j = jsd, jed
  do i = is, ie+1
    xfx_adv(i,j) = dy(i,j)*xfx_adv(i,j)*sina_u(i,j)
  end do
end do
if ( .not. allocated(tp_dsw_yfx_adv_134h)) then
  allocate( tp_dsw_yfx_adv_134h(isd:ied,js:je+1,tp_dsw_d_sw) )
endif
tp_dsw_yfx_adv_134h(:,:,taf_rec_npz) = yfx_adv
do j = js, je+1
  do i = isd, ied
    if (yfx_adv(i,j) .gt. 0.) then
      cry_adv(i,j) = yfx_adv(i,j)*rdya(i,j-1)
    else
      cry_adv(i,j) = yfx_adv(i,j)*rdya(i,j)
    endif
  end do
end do
do j = js, je+1
  do i = isd, ied
    yfx_adv(i,j) = dx(i,j)*yfx_adv(i,j)*sina_v(i,j)
  end do
end do
do j = jsd, jed
  do i = is, ie
    ra_x(i,j) = area(i,j)+xfx_adv(i,j)-xfx_adv(i+1,j)
  end do
end do
do j = js, je
  do i = isd, ied
    ra_y(i,j) = area(i,j)+yfx_adv(i,j)-yfx_adv(i,j+1)
  end do
end do
if ( .not. allocated(tp_dsw_delp_149h)) then
  allocate( tp_dsw_delp_149h(isd:ied,jsd:jed,tp_dsw_d_sw) )
endif
tp_dsw_delp_149h(:,:,taf_rec_npz) = delp
if ( .not. allocated(tp_dsw_crx_adv_150h)) then
  allocate( tp_dsw_crx_adv_150h(is:ie+1,jsd:jed,tp_dsw_d_sw) )
endif
tp_dsw_crx_adv_150h(:,:,taf_rec_npz) = crx_adv
if ( .not. allocated(tp_dsw_cry_adv_151h)) then
  allocate( tp_dsw_cry_adv_151h(isd:ied,js:je+1,tp_dsw_d_sw) )
endif
tp_dsw_cry_adv_151h(:,:,taf_rec_npz) = cry_adv
if ( .not. allocated(tp_dsw_fx_152h)) then
  allocate( tp_dsw_fx_152h(is:ie+1,js:je,tp_dsw_d_sw) )
endif
tp_dsw_fx_152h(:,:,taf_rec_npz) = fx
if ( .not. allocated(tp_dsw_fy_153h)) then
  allocate( tp_dsw_fy_153h(is:ie,js:je+1,tp_dsw_d_sw) )
endif
tp_dsw_fy_153h(:,:,taf_rec_npz) = fy
if ( .not. allocated(tp_dsw_xfx_adv_154h)) then
  allocate( tp_dsw_xfx_adv_154h(is:ie+1,jsd:jed,tp_dsw_d_sw) )
endif
tp_dsw_xfx_adv_154h(:,:,taf_rec_npz) = xfx_adv
if ( .not. allocated(tp_dsw_yfx_adv_155h)) then
  allocate( tp_dsw_yfx_adv_155h(isd:ied,js:je+1,tp_dsw_d_sw) )
endif
tp_dsw_yfx_adv_155h(:,:,taf_rec_npz) = yfx_adv
if ( .not. allocated(tp_dsw_ra_x_156h)) then
  allocate( tp_dsw_ra_x_156h(is:ie,jsd:jed,tp_dsw_d_sw) )
endif
tp_dsw_ra_x_156h(:,:,taf_rec_npz) = ra_x
if ( .not. allocated(tp_dsw_ra_y_157h)) then
  allocate( tp_dsw_ra_y_157h(isd:ied,js:je,tp_dsw_d_sw) )
endif
tp_dsw_ra_y_157h(:,:,taf_rec_npz) = ra_y
call fv_tp_2d( delp,crx_adv,cry_adv,npx,npy,hord_tm,fx,fy,xfx_adv,yfx_adv,area,ra_x,ra_y,uniform_ppm,fx_kill,fy_kill, .false. ,&
&taf_rec_npz )
do j = jsd, jed
  do i = is, ie+1
    cx(i,j) = cx(i,j)+crx_adv(i,j)
  end do
end do
do j = js, je
  do i = is, ie+1
    xflux(i,j) = xflux(i,j)+fx(i,j)
  end do
end do
do j = js, je+1
  do i = isd, ied
    cy(i,j) = cy(i,j)+cry_adv(i,j)
  end do
  do i = is, ie
    yflux(i,j) = yflux(i,j)+fy(i,j)
  end do
end do
if ( .not. hydrostatic) then
  if ( .not. allocated(tp_dsw_w_194h)) then
    allocate( tp_dsw_w_194h(isd:ied,jsd:jed,tp_dsw_d_sw) )
  endif
  tp_dsw_w_194h(:,:,taf_rec_npz) = w
  if ( .not. allocated(tp_dsw_crx_adv_195h)) then
    allocate( tp_dsw_crx_adv_195h(is:ie+1,jsd:jed,tp_dsw_d_sw) )
  endif
  tp_dsw_crx_adv_195h(:,:,taf_rec_npz) = crx_adv
  if ( .not. allocated(tp_dsw_cry_adv_196h)) then
    allocate( tp_dsw_cry_adv_196h(isd:ied,js:je+1,tp_dsw_d_sw) )
  endif
  tp_dsw_cry_adv_196h(:,:,taf_rec_npz) = cry_adv
  if ( .not. allocated(tp_dsw_ub_197h)) then
    allocate( tp_dsw_ub_197h(is:ie+1,js:je+1,tp_dsw_d_sw) )
  endif
  tp_dsw_ub_197h(:,:,taf_rec_npz) = ub
  if ( .not. allocated(tp_dsw_gy_198h)) then
    allocate( tp_dsw_gy_198h(is:ie,js:je+1,tp_dsw_d_sw) )
  endif
  tp_dsw_gy_198h(:,:,taf_rec_npz) = gy
  if ( .not. allocated(tp_dsw_xfx_adv_199h)) then
    allocate( tp_dsw_xfx_adv_199h(is:ie+1,jsd:jed,tp_dsw_d_sw) )
  endif
  tp_dsw_xfx_adv_199h(:,:,taf_rec_npz) = xfx_adv
  if ( .not. allocated(tp_dsw_yfx_adv_200h)) then
    allocate( tp_dsw_yfx_adv_200h(isd:ied,js:je+1,tp_dsw_d_sw) )
  endif
  tp_dsw_yfx_adv_200h(:,:,taf_rec_npz) = yfx_adv
  if ( .not. allocated(tp_dsw_ra_x_201h)) then
    allocate( tp_dsw_ra_x_201h(is:ie,jsd:jed,tp_dsw_d_sw) )
  endif
  tp_dsw_ra_x_201h(:,:,taf_rec_npz) = ra_x
  if ( .not. allocated(tp_dsw_ra_y_202h)) then
    allocate( tp_dsw_ra_y_202h(isd:ied,js:je,tp_dsw_d_sw) )
  endif
  tp_dsw_ra_y_202h(:,:,taf_rec_npz) = ra_y
  if ( .not. allocated(tp_dsw_fx_203h)) then
    allocate( tp_dsw_fx_203h(is:ie+1,js:je,tp_dsw_d_sw) )
  endif
  tp_dsw_fx_203h(:,:,taf_rec_npz) = fx
  if ( .not. allocated(tp_dsw_fy_204h)) then
    allocate( tp_dsw_fy_204h(is:ie,js:je+1,tp_dsw_d_sw) )
  endif
  tp_dsw_fy_204h(:,:,taf_rec_npz) = fy
  call fv_tp_2d( w,crx_adv,cry_adv,npx,npy,hord_vt,ub,gy,xfx_adv,yfx_adv,area,ra_x,ra_y,uniform_ppm,fx,fy, .true. ,taf_rec_npz )
  if ( .not. allocated(tp_dsw_w_216h)) then
    allocate( tp_dsw_w_216h(isd:ied,jsd:jed,tp_dsw_d_sw) )
  endif
  tp_dsw_w_216h(:,:,taf_rec_npz) = w
  if ( .not. allocated(tp_dsw_delp_217h)) then
    allocate( tp_dsw_delp_217h(isd:ied,jsd:jed,tp_dsw_d_sw) )
  endif
  tp_dsw_delp_217h(:,:,taf_rec_npz) = delp
  do j = js, je
    do i = is, ie
      w(i,j) = w(i,j)*delp(i,j)+(ub(i,j)-ub(i+1,j)+gy(i,j)-gy(i,j+1))*rarea(i,j)
    end do
  end do
endif
if ( .not. allocated(tp_dsw_pt_220h)) then
  allocate( tp_dsw_pt_220h(isd:ied,jsd:jed,tp_dsw_d_sw) )
endif
tp_dsw_pt_220h(:,:,taf_rec_npz) = pt
if ( .not. allocated(tp_dsw_crx_adv_221h)) then
  allocate( tp_dsw_crx_adv_221h(is:ie+1,jsd:jed,tp_dsw_d_sw) )
endif
tp_dsw_crx_adv_221h(:,:,taf_rec_npz) = crx_adv
if ( .not. allocated(tp_dsw_cry_adv_222h)) then
  allocate( tp_dsw_cry_adv_222h(isd:ied,js:je+1,tp_dsw_d_sw) )
endif
tp_dsw_cry_adv_222h(:,:,taf_rec_npz) = cry_adv
if ( .not. allocated(tp_dsw_ub_223h)) then
  allocate( tp_dsw_ub_223h(is:ie+1,js:je+1,tp_dsw_d_sw) )
endif
tp_dsw_ub_223h(:,:,taf_rec_npz) = ub
if ( .not. allocated(tp_dsw_gy_224h)) then
  allocate( tp_dsw_gy_224h(is:ie,js:je+1,tp_dsw_d_sw) )
endif
tp_dsw_gy_224h(:,:,taf_rec_npz) = gy
if ( .not. allocated(tp_dsw_xfx_adv_225h)) then
  allocate( tp_dsw_xfx_adv_225h(is:ie+1,jsd:jed,tp_dsw_d_sw) )
endif
tp_dsw_xfx_adv_225h(:,:,taf_rec_npz) = xfx_adv
if ( .not. allocated(tp_dsw_yfx_adv_226h)) then
  allocate( tp_dsw_yfx_adv_226h(isd:ied,js:je+1,tp_dsw_d_sw) )
endif
tp_dsw_yfx_adv_226h(:,:,taf_rec_npz) = yfx_adv
if ( .not. allocated(tp_dsw_ra_x_227h)) then
  allocate( tp_dsw_ra_x_227h(is:ie,jsd:jed,tp_dsw_d_sw) )
endif
tp_dsw_ra_x_227h(:,:,taf_rec_npz) = ra_x
if ( .not. allocated(tp_dsw_ra_y_228h)) then
  allocate( tp_dsw_ra_y_228h(isd:ied,js:je,tp_dsw_d_sw) )
endif
tp_dsw_ra_y_228h(:,:,taf_rec_npz) = ra_y
if ( .not. allocated(tp_dsw_fx_229h)) then
  allocate( tp_dsw_fx_229h(is:ie+1,js:je,tp_dsw_d_sw) )
endif
tp_dsw_fx_229h(:,:,taf_rec_npz) = fx
if ( .not. allocated(tp_dsw_fy_230h)) then
  allocate( tp_dsw_fy_230h(is:ie,js:je+1,tp_dsw_d_sw) )
endif
tp_dsw_fy_230h(:,:,taf_rec_npz) = fy
call fv_tp_2d( pt,crx_adv,cry_adv,npx,npy,hord_tm,ub,gy,xfx_adv,yfx_adv,area,ra_x,ra_y,uniform_ppm,fx,fy, .true. ,taf_rec_npz )
if ( .not. allocated(tp_dsw_ub_245h)) then
  allocate( tp_dsw_ub_245h(is:ie+1,js:je+1,tp_dsw_d_sw) )
endif
tp_dsw_ub_245h(:,:,taf_rec_npz) = ub
if ( .not. allocated(tp_dsw_gy_246h)) then
  allocate( tp_dsw_gy_246h(is:ie,js:je+1,tp_dsw_d_sw) )
endif
tp_dsw_gy_246h(:,:,taf_rec_npz) = gy
if ( .not. allocated(tp_dsw_fx_251h)) then
  allocate( tp_dsw_fx_251h(is:ie+1,js:je,tp_dsw_d_sw) )
endif
tp_dsw_fx_251h(:,:,taf_rec_npz) = fx
if ( .not. allocated(tp_dsw_fy_252h)) then
  allocate( tp_dsw_fy_252h(is:ie,js:je+1,tp_dsw_d_sw) )
endif
tp_dsw_fy_252h(:,:,taf_rec_npz) = fy
if ( .not. allocated(tp_dsw_pt_253h)) then
  allocate( tp_dsw_pt_253h(isd:ied,jsd:jed,tp_dsw_d_sw) )
endif
tp_dsw_pt_253h(:,:,taf_rec_npz) = pt
if ( .not. allocated(tp_dsw_delp_254h)) then
  allocate( tp_dsw_delp_254h(isd:ied,jsd:jed,tp_dsw_d_sw) )
endif
tp_dsw_delp_254h(:,:,taf_rec_npz) = delp
do j = js, je
  do i = is, ie
    pt(i,j) = pt(i,j)*delp(i,j)+(ub(i,j)-ub(i+1,j)+gy(i,j)-gy(i,j+1))*rarea(i,j)
    delp(i,j) = delp(i,j)+(fx(i,j)-fx(i+1,j)+fy(i,j)-fy(i,j+1))*rarea(i,j)
    pt(i,j) = pt(i,j)/delp(i,j)
  end do
end do
if ( .not. hydrostatic) then
  if ( .not. allocated(tp_dsw_delp_255h)) then
    allocate( tp_dsw_delp_255h(isd:ied,jsd:jed,tp_dsw_d_sw) )
  endif
  tp_dsw_delp_255h(:,:,taf_rec_npz) = delp
  if ( .not. allocated(tp_dsw_w_256h)) then
    allocate( tp_dsw_w_256h(isd:ied,jsd:jed,tp_dsw_d_sw) )
  endif
  tp_dsw_w_256h(:,:,taf_rec_npz) = w
  do j = js, je
    do i = is, ie
      w(i,j) = w(i,j)/delp(i,j)
    end do
  end do
endif
dt5 = 0.5*dt
dt4 = 0.25*dt
is2 = max(2,is)
ie1 = min(npx-1,ie+1)
js2 = max(2,js)
je1 = min(npy-1,je+1)
if (grid_type .lt. 3) then
  if (js .eq. 1) then
    do i = is, ie+1
      vb(i,1) = dt5*(vt(i-1,1)+vt(i,1))
    end do
  endif
  do j = js2, je1
    do i = is2, ie1
      vb(i,j) = dt5*(vc(i-1,j)+vc(i,j)-(uc(i,j-1)+uc(i,j))*cosa(i,j))*rsina(i,j)
    end do
    if (is .eq. 1) then
      vb(1,j) = dt4*((-vt(-1,j))+3.*(vt(0,j)+vt(1,j))-vt(2,j))
    endif
    if (ie+1 .eq. npx) then
      vb(npx,j) = dt4*((-vt(npx-2,j))+3.*(vt(npx-1,j)+vt(npx,j))-vt(npx+1,j))
    endif
  end do
  if (je+1 .eq. npy) then
    do i = is, ie+1
      vb(i,npy) = dt5*(vt(i-1,npy)+vt(i,npy))
    end do
  endif
else
  do j = js, je+1
    do i = is, ie+1
      vb(i,j) = dt5*(vc(i-1,j)+vc(i,j))
    end do
  end do
endif
if ( .not. allocated(tp_dsw_vb_264h)) then
  allocate( tp_dsw_vb_264h(is:ie+1,js:je+1,tp_dsw_d_sw) )
endif
tp_dsw_vb_264h(:,:,taf_rec_npz) = vb
if ( .not. allocated(tp_dsw_v_266h)) then
  allocate( tp_dsw_v_266h(isd:ied+1,jsd:jed,tp_dsw_d_sw) )
endif
tp_dsw_v_266h(:,:,taf_rec_npz) = v
call ytp_v( vb,u,v,ub,hord_mt )
if ( .not. allocated(tp_dsw_vb_273h)) then
  allocate( tp_dsw_vb_273h(is:ie+1,js:je+1,tp_dsw_d_sw) )
endif
tp_dsw_vb_273h(:,:,taf_rec_npz) = vb
if ( .not. allocated(tp_dsw_ub_274h)) then
  allocate( tp_dsw_ub_274h(is:ie+1,js:je+1,tp_dsw_d_sw) )
endif
tp_dsw_ub_274h(:,:,taf_rec_npz) = ub
do j = js, je+1
  do i = is, ie+1
    ke_ub(i,j) = 0.5*vb(i,j)*ub(i,j)
  end do
end do
if (grid_type .lt. 3) then
  if (is .eq. 1) then
    do j = js, je+1
      ub(1,j) = dt5*(ut(1,j-1)+ut(1,j))
    end do
  endif
  do j = js, je+1
    if (j .eq. 1 .or. j .eq. npy) then
      do i = is2, ie1
        ub(i,j) = dt4*((-ut(i,j-2))+3.*(ut(i,j-1)+ut(i,j))-ut(i,j+1))
      end do
    else
      do i = is2, ie1
        ub(i,j) = dt5*(uc(i,j-1)+uc(i,j)-(vc(i-1,j)+vc(i,j))*cosa(i,j))*rsina(i,j)
      end do
    endif
  end do
  if (ie+1 .eq. npx) then
    do j = js, je+1
      ub(npx,j) = dt5*(ut(npx,j-1)+ut(npx,j))
    end do
  endif
else
  do j = js, je+1
    do i = is, ie+1
      ub(i,j) = dt5*(uc(i,j-1)+uc(i,j))
    end do
  end do
endif
if ( .not. allocated(tp_dsw_ub_286h)) then
  allocate( tp_dsw_ub_286h(is:ie+1,js:je+1,tp_dsw_d_sw) )
endif
tp_dsw_ub_286h(:,:,taf_rec_npz) = ub
if ( .not. allocated(tp_dsw_u_287h)) then
  allocate( tp_dsw_u_287h(isd:ied,jsd:jed+1,tp_dsw_d_sw) )
endif
tp_dsw_u_287h(:,:,taf_rec_npz) = u
call xtp_u( ub,u,v,vb,hord_mt )
if ( .not. allocated(tp_dsw_ub_295h)) then
  allocate( tp_dsw_ub_295h(is:ie+1,js:je+1,tp_dsw_d_sw) )
endif
tp_dsw_ub_295h(:,:,taf_rec_npz) = ub
if ( .not. allocated(tp_dsw_vb_296h)) then
  allocate( tp_dsw_vb_296h(is:ie+1,js:je+1,tp_dsw_d_sw) )
endif
tp_dsw_vb_296h(:,:,taf_rec_npz) = vb
do j = js, je+1
  do i = is, ie+1
    ke_vb(i,j) = 0.5*ub(i,j)*vb(i,j)
  end do
end do
do j = js, je+1
  do i = is, ie+1
    ke(i,j) = ke_ub(i,j)+ke_vb(i,j)
  end do
end do
if (gnomonic_grid) then
  if ( .not. allocated(tp_dsw_ut_301h)) then
    allocate( tp_dsw_ut_301h(is-1:ie+2,jsd:jed,tp_dsw_d_sw) )
  endif
  tp_dsw_ut_301h(:,:,taf_rec_npz) = ut
  if ( .not. allocated(tp_dsw_vt_302h)) then
    allocate( tp_dsw_vt_302h(isd:ied,js-1:je+2,tp_dsw_d_sw) )
  endif
  tp_dsw_vt_302h(:,:,taf_rec_npz) = vt
  if ( .not. allocated(tp_dsw_u_303h)) then
    allocate( tp_dsw_u_303h(isd:ied,jsd:jed+1,tp_dsw_d_sw) )
  endif
  tp_dsw_u_303h(:,:,taf_rec_npz) = u
  if ( .not. allocated(tp_dsw_v_304h)) then
    allocate( tp_dsw_v_304h(isd:ied+1,jsd:jed,tp_dsw_d_sw) )
  endif
  tp_dsw_v_304h(:,:,taf_rec_npz) = v
  dt6 = dt/6.
  if (sw_corner) then
    ke(1,1) = dt6*((ut(1,1)+ut(1,0))*u(1,1)+(vt(1,1)+vt(0,1))*v(1,1)+(ut(1,1)+vt(1,1))*u(0,1))
  endif
  if (se_corner) then
    i = npx
    ke(i,1) = dt6*((ut(i,1)+ut(i,0))*u(i-1,1)+(vt(i,1)+vt(i-1,1))*v(i,1)+(ut(i,1)-vt(i-1,1))*u(i,1))
  endif
  if (ne_corner) then
    i = npx
    j = npy
    ke(i,j) = dt6*((ut(i,j)+ut(i,j-1))*u(i-1,j)+(vt(i,j)+vt(i-1,j))*v(i,j-1)+(ut(i,j-1)+vt(i-1,j))*u(i,j))
  endif
  if (nw_corner) then
    j = npy
    ke(1,j) = dt6*((ut(1,j)+ut(1,j-1))*u(1,j)+(vt(1,j)+vt(0,j))*v(1,j-1)+(ut(1,j-1)-vt(1,j))*u(0,j))
  endif
else if (grid_type .lt. 3) then
  call mp_corner_comm( ke,npx,npy )
  if (sw_corner) then
    ke(1,1) = r3*(ke(2,1)+ke(1,2)+ke(0,1))
  endif
  if (se_corner) then
    ke(npx,1) = r3*(ke(npx+1,1)+ke(npx,2)+ke(npx-1,1))
  endif
  if (ne_corner) then
    ke(npx,npy) = r3*(ke(npx+1,npy)+ke(npx,npy-1)+ke(npx-1,npy))
  endif
  if (nw_corner) then
    ke(1,npy) = r3*(ke(2,npy)+ke(1,npy-1)+ke(0,npy))
  endif
endif
damp_divg = dddmp*da_min_c
if (dddm4 .gt. 0.) then
  do j = js-1, je+2
    do i = is-1, ie+2
      delpc(i,j) = divg_d(i,j)
      wk(i,j) = divg_d(i,j)
    end do
  end do
  do j = js, je+1
    do i = is-1, ie+1
      ptc(i,j) = sina_v(i,j)*dyc(i,j)*(wk(i+1,j)-wk(i,j))*rdx(i,j)
    end do
  end do
  do j = js-1, je+1
    do i = is, ie+1
      vort(i,j) = sina_u(i,j)*dxc(i,j)*(wk(i,j+1)-wk(i,j))*rdy(i,j)
    end do
  end do
  do j = js, je+1
    do i = is, ie+1
      wk(i,j) = vort(i,j-1)-vort(i,j)+ptc(i-1,j)-ptc(i,j)
    end do
  end do
  if (sw_corner) then
    wk(1,1) = wk(1,1)-vort(1,0)
  endif
  if (se_corner) then
    wk(npx,1) = wk(npx,1)-vort(npx,0)
  endif
  if (ne_corner) then
    wk(npx,npy) = wk(npx,npy)+vort(npx,npy)
  endif
  if (nw_corner) then
    wk(1,npy) = wk(1,npy)+vort(1,npy)
  endif
  damp4 = (dddm4*da_min_c)**2
  do j = js, je+1
    do i = is, ie+1
      ke(i,j) = ke(i,j)+damp_divg*divg_d(i,j)+damp4*rarea_c(i,j)*wk(i,j)
    end do
  end do
else
  do j = js, je+1
    if (j .eq. 1 .or. j .eq. npy) then
      do i = is-1, ie+1
        ptc(i,j) = u(i,j)*dyc(i,j)*sina_v(i,j)
      end do
    else
      do i = is-1, ie+1
        ptc(i,j) = (u(i,j)-0.5*(va(i,j-1)+va(i,j))*cosa_v(i,j))*dyc(i,j)*sina_v(i,j)
      end do
    endif
  end do
  do j = js-1, je+1
    do i = is2, ie1
      vort(i,j) = (v(i,j)-0.5*(ua(i-1,j)+ua(i,j))*cosa_u(i,j))*dxc(i,j)*sina_u(i,j)
    end do
    if (is .eq. 1) then
      vort(1,j) = v(1,j)*dxc(1,j)*sina_u(1,j)
    endif
    if (ie+1 .eq. npx) then
      vort(npx,j) = v(npx,j)*dxc(npx,j)*sina_u(npx,j)
    endif
  end do
  do j = js, je+1
    do i = is, ie+1
      delpc(i,j) = vort(i,j-1)-vort(i,j)+ptc(i-1,j)-ptc(i,j)
    end do
  end do
  if (sw_corner) then
    delpc(1,1) = delpc(1,1)-vort(1,0)
  endif
  if (se_corner) then
    delpc(npx,1) = delpc(npx,1)-vort(npx,0)
  endif
  if (ne_corner) then
    delpc(npx,npy) = delpc(npx,npy)+vort(npx,npy)
  endif
  if (nw_corner) then
    delpc(1,npy) = delpc(1,npy)+vort(1,npy)
  endif
  do j = js, je+1
    do i = is, ie+1
      delpc(i,j) = rarea_c(i,j)*delpc(i,j)
      ke(i,j) = ke(i,j)+damp_divg*delpc(i,j)
    end do
  end do
endif
do j = jsd, jed+1
  do i = isd, ied
    u(i,j) = u(i,j)*dx(i,j)
  end do
end do
do j = jsd, jed
  do i = isd, ied+1
    v(i,j) = v(i,j)*dy(i,j)
  end do
end do
do j = jsd, jed
  do i = isd, ied
    vort(i,j) = f0(i,j)+rarea(i,j)*(u(i,j)-u(i,j+1)-v(i,j)+v(i+1,j))
  end do
end do
if ( .not. allocated(tp_dsw_vort_331h)) then
  allocate( tp_dsw_vort_331h(isd:ied,jsd:jed,tp_dsw_d_sw) )
endif
tp_dsw_vort_331h(:,:,taf_rec_npz) = vort
if ( .not. allocated(tp_dsw_crx_adv_332h)) then
  allocate( tp_dsw_crx_adv_332h(is:ie+1,jsd:jed,tp_dsw_d_sw) )
endif
tp_dsw_crx_adv_332h(:,:,taf_rec_npz) = crx_adv
if ( .not. allocated(tp_dsw_cry_adv_333h)) then
  allocate( tp_dsw_cry_adv_333h(isd:ied,js:je+1,tp_dsw_d_sw) )
endif
tp_dsw_cry_adv_333h(:,:,taf_rec_npz) = cry_adv
if ( .not. allocated(tp_dsw_fx_334h)) then
  allocate( tp_dsw_fx_334h(is:ie+1,js:je,tp_dsw_d_sw) )
endif
tp_dsw_fx_334h(:,:,taf_rec_npz) = fx
if ( .not. allocated(tp_dsw_fy_335h)) then
  allocate( tp_dsw_fy_335h(is:ie,js:je+1,tp_dsw_d_sw) )
endif
tp_dsw_fy_335h(:,:,taf_rec_npz) = fy
if ( .not. allocated(tp_dsw_xfx_adv_336h)) then
  allocate( tp_dsw_xfx_adv_336h(is:ie+1,jsd:jed,tp_dsw_d_sw) )
endif
tp_dsw_xfx_adv_336h(:,:,taf_rec_npz) = xfx_adv
if ( .not. allocated(tp_dsw_yfx_adv_337h)) then
  allocate( tp_dsw_yfx_adv_337h(isd:ied,js:je+1,tp_dsw_d_sw) )
endif
tp_dsw_yfx_adv_337h(:,:,taf_rec_npz) = yfx_adv
if ( .not. allocated(tp_dsw_ra_x_338h)) then
  allocate( tp_dsw_ra_x_338h(is:ie,jsd:jed,tp_dsw_d_sw) )
endif
tp_dsw_ra_x_338h(:,:,taf_rec_npz) = ra_x
if ( .not. allocated(tp_dsw_ra_y_339h)) then
  allocate( tp_dsw_ra_y_339h(isd:ied,js:je,tp_dsw_d_sw) )
endif
tp_dsw_ra_y_339h(:,:,taf_rec_npz) = ra_y
call fv_tp_2d( vort,crx_adv,cry_adv,npx,npy,hord_vt,fx,fy,xfx_adv,yfx_adv,area,ra_x,ra_y,uniform_ppm,fx_kill,fy_kill, .false. ,&
&taf_rec_npz )
do j = js, je+1
  do i = is, ie
    u(i,j) = u(i,j)+ke(i,j)-ke(i+1,j)+fy(i,j)
  end do
end do
do j = js, je
  do i = is, ie+1
    v(i,j) = v(i,j)+ke(i,j)-ke(i,j+1)-fx(i,j)
  end do
end do
end subroutine mdd_sw


end module     adsw_core_mod





