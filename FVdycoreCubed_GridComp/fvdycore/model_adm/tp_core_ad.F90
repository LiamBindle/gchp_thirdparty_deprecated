!                           DISCLAIMER
!
!   This file was generated by TAF version 1.9.30
!
!   FASTOPT DISCLAIMS  ALL  WARRANTIES,  EXPRESS  OR  IMPLIED,
!   INCLUDING (WITHOUT LIMITATION) ALL IMPLIED  WARRANTIES  OF
!   MERCHANTABILITY  OR FITNESS FOR A PARTICULAR PURPOSE, WITH
!   RESPECT TO THE SOFTWARE AND USER PROGRAMS.   IN  NO  EVENT
!   SHALL  FASTOPT BE LIABLE FOR ANY LOST OR ANTICIPATED PROF-
!   ITS, OR ANY INDIRECT, INCIDENTAL, EXEMPLARY,  SPECIAL,  OR
!   CONSEQUENTIAL  DAMAGES, WHETHER OR NOT FASTOPT WAS ADVISED
!   OF THE POSSIBILITY OF SUCH DAMAGES.
!
!                           Haftungsbeschraenkung
!   FastOpt gibt ausdruecklich keine Gewaehr, explizit oder indirekt,
!   bezueglich der Brauchbarkeit  der Software  fuer einen bestimmten
!   Zweck.   Unter  keinen  Umstaenden   ist  FastOpt   haftbar  fuer
!   irgendeinen Verlust oder nicht eintretenden erwarteten Gewinn und
!   allen indirekten,  zufaelligen,  exemplarischen  oder  speziellen
!   Schaeden  oder  Folgeschaeden  unabhaengig  von einer eventuellen
!   Mitteilung darueber an FastOpt.
!
module     adtp_core_mod
!******************************************************************
!******************************************************************
!** This routine was generated by Automatic differentiation.     **
!** FastOpt: Transformation of Algorithm in Fortran, TAF 1.9.30  **
!******************************************************************
!******************************************************************
!==============================================
! referencing used modules
!==============================================
use pre_direct_new
use fv_mp_mod, only : ie,ied,is,isd,je,jed,js,jsd,ng
use fv_grid_utils_mod, only : cx1,cx2,cy1,cy2,ne_corner,nw_corner,se_corner,sw_corner
use fv_grid_tools_mod, only : dxa,dya,grid_type
use tp_core_mod

!==============================================
! all entries are defined explicitly
!==============================================
implicit none
contains

subroutine adcopy_corners( adq, npx, npy, dir )
!******************************************************************
!******************************************************************
!** This routine was generated by Automatic differentiation.     **
!** FastOpt: Transformation of Algorithm in Fortran, TAF 1.9.43  **
!******************************************************************
!******************************************************************
!==============================================
! all entries are defined explicitly
!==============================================
implicit none

!==============================================
! declare arguments
!==============================================
real, intent(inout) :: adq(isd:ied,jsd:jed)
integer, intent(in) :: dir
integer, intent(in) :: npx
integer, intent(in) :: npy

!==============================================
! declare local variables
!==============================================
real :: adqh
real :: adqi
real :: adqj
real :: adqk
real :: adql
real :: adqm
real :: adqn
real :: adqo
integer :: i
integer :: j

!----------------------------------------------
! ROUTINE BODY
!----------------------------------------------
if (dir .eq. 1) then
  if (nw_corner) then
    do j = npy+ng-1, npy, -1
      do i = 0, 1-ng, -1
        adql = adq(i,j)
        adq(i,j) = 0.
        adq(npy-j,i-1+npx) = adq(npy-j,i-1+npx)+adql
      end do
    end do
  endif
  if (ne_corner) then
    do j = npy+ng-1, npy, -1
      do i = npx+ng-1, npx, -1
        adqm = adq(i,j)
        adq(i,j) = 0.
        adq(j,2*npx-1-i) = adq(j,2*npx-1-i)+adqm
      end do
    end do
  endif
  if (se_corner) then
    do j = 0, 1-ng, -1
      do i = npx+ng-1, npx, -1
        adqn = adq(i,j)
        adq(i,j) = 0.
        adq(npy-j,i-npx+1) = adq(npy-j,i-npx+1)+adqn
      end do
    end do
  endif
  if (sw_corner) then
    do j = 1-ng, 0
      do i = 0, 1-ng, -1
        adqo = adq(i,j)
        adq(i,j) = 0.
        adq(j,1-i) = adq(j,1-i)+adqo
      end do
    end do
  endif
else if (dir .eq. 2) then
  if (nw_corner) then
    do j = npy+ng-1, npy, -1
      do i = 0, 1-ng, -1
        adqh = adq(i,j)
        adq(i,j) = 0.
        adq(j+1-npx,npy-i) = adq(j+1-npx,npy-i)+adqh
      end do
    end do
  endif
  if (ne_corner) then
    do j = npy+ng-1, npy, -1
      do i = npx+ng-1, npx, -1
        adqi = adq(i,j)
        adq(i,j) = 0.
        adq(2*npy-1-j,i) = adq(2*npy-1-j,i)+adqi
      end do
    end do
  endif
  if (se_corner) then
    do j = 0, 1-ng, -1
      do i = npx+ng-1, npx, -1
        adqj = adq(i,j)
        adq(i,j) = 0.
        adq(npy+j-1,npx-i) = adq(npy+j-1,npx-i)+adqj
      end do
    end do
  endif
  if (sw_corner) then
    do j = 1-ng, 0
      do i = 0, 1-ng, -1
        adqk = adq(i,j)
        adq(i,j) = 0.
        adq(1-j,i) = adq(1-j,i)+adqk
      end do
    end do
  endif
endif

end subroutine adcopy_corners


subroutine adfv_tp_2d( q, adq, crx, adcrx, cry, adcry, npx, npy, hord, fx, adfx, fy, adfy, xfx, adxfx, yfx, adyfx, area, ra_x, &
&adra_x, ra_y, adra_y, uni_ppm, mfx, admfx, mfy, admfy, taf_tp_core )
!******************************************************************
!******************************************************************
!** This routine was generated by Automatic differentiation.     **
!** FastOpt: Transformation of Algorithm in Fortran, TAF 1.9.43  **
!******************************************************************
!******************************************************************
!==============================================
! all entries are defined explicitly
!==============================================
implicit none

!==============================================
! declare arguments
!==============================================
real, intent(inout) :: adcrx(is:ie+1,jsd:jed)
real, intent(inout) :: adcry(isd:ied,js:je+1)
real, intent(inout) :: adfx(is:ie+1,js:je)
real, intent(inout) :: adfy(is:ie,js:je+1)
real, intent(inout) :: admfx(is:ie+1,js:je)
real, intent(inout) :: admfy(is:ie,js:je+1)
real, intent(inout) :: adq(isd:ied,jsd:jed)
real, intent(inout) :: adra_x(is:ie,jsd:jed)
real, intent(inout) :: adra_y(isd:ied,js:je)
real, intent(inout) :: adxfx(is:ie+1,jsd:jed)
real, intent(inout) :: adyfx(isd:ied,js:je+1)
real, intent(in) :: area(isd:ied,jsd:jed)
real, intent(inout) :: crx(is:ie+1,jsd:jed)
real, intent(inout) :: cry(isd:ied,js:je+1)
real, intent(out) :: fx(is:ie+1,js:je)
real, intent(out) :: fy(is:ie,js:je+1)
integer, intent(in) :: hord
real, intent(inout) :: mfx(is:ie+1,js:je)
real, intent(inout) :: mfy(is:ie,js:je+1)
integer, intent(in) :: npx
integer, intent(in) :: npy
real, intent(inout) :: q(isd:ied,jsd:jed)
real, intent(in) :: ra_x(is:ie,jsd:jed)
real, intent(in) :: ra_y(isd:ied,js:je)
logical :: taf_tp_core
logical, intent(in) :: uni_ppm
real, intent(inout) :: xfx(is:ie+1,jsd:jed)
real, intent(inout) :: yfx(isd:ied,js:je+1)

!==============================================
! declare local variables
!==============================================
real :: adfx1(is:ie+1)
real :: adfx2(is:ie+1,jsd:jed)
real :: adfy2(isd:ied,js:je+1)
real :: adfyy(isd:ied,js:je+1)
real :: adq_i(isd:ied,js:je)
real :: adq_j(is:ie,jsd:jed)
real :: fx1(is:ie+1)
real :: fx2(is:ie+1,jsd:jed)
real :: fy2(isd:ied,js:je+1)
real :: fyy(isd:ied,js:je+1)
integer :: i
integer :: j
real :: q_i(isd:ied,js:je)
real :: q_j(is:ie,jsd:jed)
real, allocatable :: tp_fvtp2d_crx_31h(:,:,:)
real, allocatable :: tp_fvtp2d_crx_35h(:,:,:)
real, allocatable :: tp_fvtp2d_cry_10h(:,:,:)
real, allocatable :: tp_fvtp2d_cry_44h(:,:,:)
integer :: tp_fvtp2d_fv_tp_2d
real, allocatable :: tp_fvtp2d_fx2_38h(:,:,:)
real, allocatable :: tp_fvtp2d_fx2_48h(:,:,:)
real, allocatable :: tp_fvtp2d_fx2_54h(:,:,:)
real, allocatable :: tp_fvtp2d_fx_47h(:,:,:)
real, allocatable :: tp_fvtp2d_fx_53h(:,:,:)
real, allocatable :: tp_fvtp2d_fy2_16h(:,:,:)
real, allocatable :: tp_fvtp2d_fy2_21h(:,:,:)
real, allocatable :: tp_fvtp2d_fy2_51h(:,:,:)
real, allocatable :: tp_fvtp2d_fy2_57h(:,:,:)
real, allocatable :: tp_fvtp2d_fy_50h(:,:,:)
real, allocatable :: tp_fvtp2d_fy_56h(:,:,:)
real, allocatable :: tp_fvtp2d_fyy_25h(:,:,:)
real, allocatable :: tp_fvtp2d_mfx_49h(:,:,:)
real, allocatable :: tp_fvtp2d_mfy_52h(:,:,:)
real, allocatable :: tp_fvtp2d_q_22h(:,:,:)
real, allocatable :: tp_fvtp2d_q_34h(:,:,:)
real, allocatable :: tp_fvtp2d_q_40h(:,:,:)
real, allocatable :: tp_fvtp2d_q_8h(:,:,:)
real, allocatable :: tp_fvtp2d_q_i_30h(:,:,:)
real, allocatable :: tp_fvtp2d_q_j_43h(:,:,:)
real, allocatable :: tp_fvtp2d_xfx_37h(:,:,:)
real, allocatable :: tp_fvtp2d_xfx_55h(:,:,:)
real, allocatable :: tp_fvtp2d_yfx_20h(:,:,:)
real, allocatable :: tp_fvtp2d_yfx_58h(:,:,:)

!----------------------------------------------
! RESET LOCAL ADJOINT VARIABLES
!----------------------------------------------
adfx1(:) = 0.
adfx2(:,:) = 0.
adfy2(:,:) = 0.
adfyy(:,:) = 0.
adq_i(:,:) = 0.
adq_j(:,:) = 0.

!----------------------------------------------
! ROUTINE BODY
!----------------------------------------------
!----------------------------------------------
! OPEN TAPE tp_fvtp2d
!----------------------------------------------
tp_fvtp2d_fv_tp_2d = 1

!----------------------------------------------
! TAPE COMPUTATIONS
!----------------------------------------------
call copy_corners( q,npx,npy,2 )
if ( .not. allocated(tp_fvtp2d_q_8h)) then
  allocate( tp_fvtp2d_q_8h(isd:ied,jsd:jed,tp_fvtp2d_fv_tp_2d) )
endif
tp_fvtp2d_q_8h(:,:,1) = q
if ( .not. allocated(tp_fvtp2d_cry_10h)) then
  allocate( tp_fvtp2d_cry_10h(isd:ied,js:je+1,tp_fvtp2d_fv_tp_2d) )
endif
tp_fvtp2d_cry_10h(:,:,1) = cry
call ytp( fy2,q,cry,hord,isd,ied,js,je,npx,npy,uni_ppm )
if ( .not. allocated(tp_fvtp2d_fy2_16h)) then
  allocate( tp_fvtp2d_fy2_16h(isd:ied,js:je+1,tp_fvtp2d_fv_tp_2d) )
endif
tp_fvtp2d_fy2_16h(:,:,1) = fy2
if ( .not. allocated(tp_fvtp2d_yfx_20h)) then
  allocate( tp_fvtp2d_yfx_20h(isd:ied,js:je+1,tp_fvtp2d_fv_tp_2d) )
endif
tp_fvtp2d_yfx_20h(:,:,1) = yfx
if ( .not. allocated(tp_fvtp2d_fy2_21h)) then
  allocate( tp_fvtp2d_fy2_21h(isd:ied,js:je+1,tp_fvtp2d_fv_tp_2d) )
endif
tp_fvtp2d_fy2_21h(:,:,1) = fy2
do j = js, je+1
  do i = isd, ied
    fyy(i,j) = yfx(i,j)*fy2(i,j)
  end do
end do
if ( .not. allocated(tp_fvtp2d_q_22h)) then
  allocate( tp_fvtp2d_q_22h(isd:ied,jsd:jed,tp_fvtp2d_fv_tp_2d) )
endif
tp_fvtp2d_q_22h(:,:,1) = q
if ( .not. allocated(tp_fvtp2d_fyy_25h)) then
  allocate( tp_fvtp2d_fyy_25h(isd:ied,js:je+1,tp_fvtp2d_fv_tp_2d) )
endif
tp_fvtp2d_fyy_25h(:,:,1) = fyy
do j = js, je
  do i = isd, ied
    q_i(i,j) = (q(i,j)*area(i,j)+fyy(i,j)-fyy(i,j+1))/ra_y(i,j)
  end do
end do
if ( .not. allocated(tp_fvtp2d_q_i_30h)) then
  allocate( tp_fvtp2d_q_i_30h(isd:ied,js:je,tp_fvtp2d_fv_tp_2d) )
endif
tp_fvtp2d_q_i_30h(:,:,1) = q_i
if ( .not. allocated(tp_fvtp2d_crx_31h)) then
  allocate( tp_fvtp2d_crx_31h(is:ie+1,jsd:jed,tp_fvtp2d_fv_tp_2d) )
endif
tp_fvtp2d_crx_31h(:,:,1) = crx
call xtp( fx,q_i,crx(is,js),hord,is,ie,js,je,npx,npy,uni_ppm )
call copy_corners( q,npx,npy,1 )
if ( .not. allocated(tp_fvtp2d_q_34h)) then
  allocate( tp_fvtp2d_q_34h(isd:ied,jsd:jed,tp_fvtp2d_fv_tp_2d) )
endif
tp_fvtp2d_q_34h(:,:,1) = q
if ( .not. allocated(tp_fvtp2d_crx_35h)) then
  allocate( tp_fvtp2d_crx_35h(is:ie+1,jsd:jed,tp_fvtp2d_fv_tp_2d) )
endif
tp_fvtp2d_crx_35h(:,:,1) = crx
call xtp( fx2,q,crx,hord,is,ie,jsd,jed,npx,npy,uni_ppm )
if ( .not. allocated(tp_fvtp2d_xfx_37h)) then
  allocate( tp_fvtp2d_xfx_37h(is:ie+1,jsd:jed,tp_fvtp2d_fv_tp_2d) )
endif
tp_fvtp2d_xfx_37h(:,:,1) = xfx
if ( .not. allocated(tp_fvtp2d_fx2_38h)) then
  allocate( tp_fvtp2d_fx2_38h(is:ie+1,jsd:jed,tp_fvtp2d_fv_tp_2d) )
endif
tp_fvtp2d_fx2_38h(:,:,1) = fx2
if ( .not. allocated(tp_fvtp2d_q_40h)) then
  allocate( tp_fvtp2d_q_40h(isd:ied,jsd:jed,tp_fvtp2d_fv_tp_2d) )
endif
tp_fvtp2d_q_40h(:,:,1) = q
do j = jsd, jed
  do i = is, ie+1
    fx1(i) = xfx(i,j)*fx2(i,j)
  end do
  do i = is, ie
    q_j(i,j) = (q(i,j)*area(i,j)+fx1(i)-fx1(i+1))/ra_x(i,j)
  end do
end do
if ( .not. allocated(tp_fvtp2d_q_j_43h)) then
  allocate( tp_fvtp2d_q_j_43h(is:ie,jsd:jed,tp_fvtp2d_fv_tp_2d) )
endif
tp_fvtp2d_q_j_43h(:,:,1) = q_j
if ( .not. allocated(tp_fvtp2d_cry_44h)) then
  allocate( tp_fvtp2d_cry_44h(isd:ied,js:je+1,tp_fvtp2d_fv_tp_2d) )
endif
tp_fvtp2d_cry_44h(:,:,1) = cry
call ytp( fy,q_j,cry,hord,is,ie,js,je,npx,npy,uni_ppm )
if (taf_tp_core .eq. ( .true. )) then
  if ( .not. allocated(tp_fvtp2d_fx_47h)) then
    allocate( tp_fvtp2d_fx_47h(is:ie+1,js:je,tp_fvtp2d_fv_tp_2d) )
  endif
  tp_fvtp2d_fx_47h(:,:,1) = fx
  if ( .not. allocated(tp_fvtp2d_fx2_48h)) then
    allocate( tp_fvtp2d_fx2_48h(is:ie+1,jsd:jed,tp_fvtp2d_fv_tp_2d) )
  endif
  tp_fvtp2d_fx2_48h(:,:,1) = fx2
  if ( .not. allocated(tp_fvtp2d_mfx_49h)) then
    allocate( tp_fvtp2d_mfx_49h(is:ie+1,js:je,tp_fvtp2d_fv_tp_2d) )
  endif
  tp_fvtp2d_mfx_49h(:,:,1) = mfx
  if ( .not. allocated(tp_fvtp2d_fy_50h)) then
    allocate( tp_fvtp2d_fy_50h(is:ie,js:je+1,tp_fvtp2d_fv_tp_2d) )
  endif
  tp_fvtp2d_fy_50h(:,:,1) = fy
  if ( .not. allocated(tp_fvtp2d_fy2_51h)) then
    allocate( tp_fvtp2d_fy2_51h(isd:ied,js:je+1,tp_fvtp2d_fv_tp_2d) )
  endif
  tp_fvtp2d_fy2_51h(:,:,1) = fy2
  if ( .not. allocated(tp_fvtp2d_mfy_52h)) then
    allocate( tp_fvtp2d_mfy_52h(is:ie,js:je+1,tp_fvtp2d_fv_tp_2d) )
  endif
  tp_fvtp2d_mfy_52h(:,:,1) = mfy
else
  if ( .not. allocated(tp_fvtp2d_fx_53h)) then
    allocate( tp_fvtp2d_fx_53h(is:ie+1,js:je,tp_fvtp2d_fv_tp_2d) )
  endif
  tp_fvtp2d_fx_53h(:,:,1) = fx
  if ( .not. allocated(tp_fvtp2d_fx2_54h)) then
    allocate( tp_fvtp2d_fx2_54h(is:ie+1,jsd:jed,tp_fvtp2d_fv_tp_2d) )
  endif
  tp_fvtp2d_fx2_54h(:,:,1) = fx2
  if ( .not. allocated(tp_fvtp2d_xfx_55h)) then
    allocate( tp_fvtp2d_xfx_55h(is:ie+1,jsd:jed,tp_fvtp2d_fv_tp_2d) )
  endif
  tp_fvtp2d_xfx_55h(:,:,1) = xfx
  if ( .not. allocated(tp_fvtp2d_fy_56h)) then
    allocate( tp_fvtp2d_fy_56h(is:ie,js:je+1,tp_fvtp2d_fv_tp_2d) )
  endif
  tp_fvtp2d_fy_56h(:,:,1) = fy
  if ( .not. allocated(tp_fvtp2d_fy2_57h)) then
    allocate( tp_fvtp2d_fy2_57h(isd:ied,js:je+1,tp_fvtp2d_fv_tp_2d) )
  endif
  tp_fvtp2d_fy2_57h(:,:,1) = fy2
  if ( .not. allocated(tp_fvtp2d_yfx_58h)) then
    allocate( tp_fvtp2d_yfx_58h(isd:ied,js:je+1,tp_fvtp2d_fv_tp_2d) )
  endif
  tp_fvtp2d_yfx_58h(:,:,1) = yfx
endif

!----------------------------------------------
! ADJOINT COMPUTATIONS
!----------------------------------------------
fyy = tp_fvtp2d_fyy_25h(:,:,1)
q_i = tp_fvtp2d_q_i_30h(:,:,1)
crx = tp_fvtp2d_crx_35h(:,:,1)
q = tp_fvtp2d_q_40h(:,:,1)
q_j = tp_fvtp2d_q_j_43h(:,:,1)
cry = tp_fvtp2d_cry_44h(:,:,1)
if (taf_tp_core .eq. ( .true. )) then
  fx = tp_fvtp2d_fx_47h(:,:,1)
  fx2 = tp_fvtp2d_fx2_48h(:,:,1)
  mfx = tp_fvtp2d_mfx_49h(:,:,1)
  fy = tp_fvtp2d_fy_50h(:,:,1)
  fy2 = tp_fvtp2d_fy2_51h(:,:,1)
  mfy = tp_fvtp2d_mfy_52h(:,:,1)
  do j = js, je+1
    do i = is, ie
      adfy2(i,j) = adfy2(i,j)+0.5*adfy(i,j)*mfy(i,j)
      admfy(i,j) = admfy(i,j)+0.5*adfy(i,j)*(fy(i,j)+fy2(i,j))
      adfy(i,j) = 0.5*adfy(i,j)*mfy(i,j)
    end do
  end do
  do j = js, je
    do i = is, ie+1
      adfx2(i,j) = adfx2(i,j)+0.5*adfx(i,j)*mfx(i,j)
      admfx(i,j) = admfx(i,j)+0.5*adfx(i,j)*(fx(i,j)+fx2(i,j))
      adfx(i,j) = 0.5*adfx(i,j)*mfx(i,j)
    end do
  end do
else
  fx = tp_fvtp2d_fx_53h(:,:,1)
  fx2 = tp_fvtp2d_fx2_54h(:,:,1)
  xfx = tp_fvtp2d_xfx_55h(:,:,1)
  fy = tp_fvtp2d_fy_56h(:,:,1)
  fy2 = tp_fvtp2d_fy2_57h(:,:,1)
  yfx = tp_fvtp2d_yfx_58h(:,:,1)
  do j = js, je+1
    do i = is, ie
      adfy2(i,j) = adfy2(i,j)+0.5*adfy(i,j)*yfx(i,j)
      adyfx(i,j) = adyfx(i,j)+0.5*adfy(i,j)*(fy(i,j)+fy2(i,j))
      adfy(i,j) = 0.5*adfy(i,j)*yfx(i,j)
    end do
  end do
  do j = js, je
    do i = is, ie+1
      adfx2(i,j) = adfx2(i,j)+0.5*adfx(i,j)*xfx(i,j)
      adxfx(i,j) = adxfx(i,j)+0.5*adfx(i,j)*(fx(i,j)+fx2(i,j))
      adfx(i,j) = 0.5*adfx(i,j)*xfx(i,j)
    end do
  end do
endif
call adytp( adfy,q_j,adq_j,cry,adcry,hord,is,ie,js,je,npy,uni_ppm )
xfx = tp_fvtp2d_xfx_37h(:,:,1)
fx2 = tp_fvtp2d_fx2_38h(:,:,1)
do j = jsd, jed
  do i = is, ie+1
    fx1(i) = xfx(i,j)*fx2(i,j)
  end do
  do i = is, ie
    adfx1(i+1) = adfx1(i+1)-adq_j(i,j)/ra_x(i,j)
    adfx1(i) = adfx1(i)+adq_j(i,j)/ra_x(i,j)
    adq(i,j) = adq(i,j)+adq_j(i,j)*(area(i,j)/ra_x(i,j))
    adra_x(i,j) = adra_x(i,j)-adq_j(i,j)*((q(i,j)*area(i,j)+fx1(i)-fx1(i+1))/(ra_x(i,j)*ra_x(i,j)))
    adq_j(i,j) = 0.
  end do
  do i = is, ie+1
    adfx2(i,j) = adfx2(i,j)+adfx1(i)*xfx(i,j)
    adxfx(i,j) = adxfx(i,j)+adfx1(i)*fx2(i,j)
    adfx1(i) = 0.
  end do
end do
q = tp_fvtp2d_q_34h(:,:,1)
call adxtp( adfx2,q,adq,crx,adcrx,hord,is,ie,jsd,jed,npx,uni_ppm )
call adcopy_corners( adq,npx,npy,1 )
crx = tp_fvtp2d_crx_31h(:,:,1)
call adxtp( adfx,q_i,adq_i,crx(is,js),adcrx(is,js),hord,is,ie,js,je,npx,uni_ppm )
q = tp_fvtp2d_q_22h(:,:,1)
do j = js, je
  do i = isd, ied
    adfyy(i,j+1) = adfyy(i,j+1)-adq_i(i,j)/ra_y(i,j)
    adfyy(i,j) = adfyy(i,j)+adq_i(i,j)/ra_y(i,j)
    adq(i,j) = adq(i,j)+adq_i(i,j)*(area(i,j)/ra_y(i,j))
    adra_y(i,j) = adra_y(i,j)-adq_i(i,j)*((q(i,j)*area(i,j)+fyy(i,j)-fyy(i,j+1))/(ra_y(i,j)*ra_y(i,j)))
    adq_i(i,j) = 0.
  end do
end do
fy2 = tp_fvtp2d_fy2_16h(:,:,1)
yfx = tp_fvtp2d_yfx_20h(:,:,1)
fy2 = tp_fvtp2d_fy2_21h(:,:,1)
do j = js, je+1
  do i = isd, ied
    adfy2(i,j) = adfy2(i,j)+adfyy(i,j)*yfx(i,j)
    adyfx(i,j) = adyfx(i,j)+adfyy(i,j)*fy2(i,j)
    adfyy(i,j) = 0.
  end do
end do
q = tp_fvtp2d_q_8h(:,:,1)
cry = tp_fvtp2d_cry_10h(:,:,1)
call adytp( adfy2,q,adq,cry,adcry,hord,isd,ied,js,je,npy,uni_ppm )
call adcopy_corners( adq,npx,npy,2 )

!----------------------------------------------
! CLOSE TAPE tp_fvtp2d
!----------------------------------------------
if (allocated(tp_fvtp2d_q_8h)) then
  deallocate( tp_fvtp2d_q_8h )
endif
if (allocated(tp_fvtp2d_cry_10h)) then
  deallocate( tp_fvtp2d_cry_10h )
endif
if (allocated(tp_fvtp2d_fy2_16h)) then
  deallocate( tp_fvtp2d_fy2_16h )
endif
if (allocated(tp_fvtp2d_yfx_20h)) then
  deallocate( tp_fvtp2d_yfx_20h )
endif
if (allocated(tp_fvtp2d_fy2_21h)) then
  deallocate( tp_fvtp2d_fy2_21h )
endif
if (allocated(tp_fvtp2d_q_22h)) then
  deallocate( tp_fvtp2d_q_22h )
endif
if (allocated(tp_fvtp2d_fyy_25h)) then
  deallocate( tp_fvtp2d_fyy_25h )
endif
if (allocated(tp_fvtp2d_q_i_30h)) then
  deallocate( tp_fvtp2d_q_i_30h )
endif
if (allocated(tp_fvtp2d_crx_31h)) then
  deallocate( tp_fvtp2d_crx_31h )
endif
if (allocated(tp_fvtp2d_q_34h)) then
  deallocate( tp_fvtp2d_q_34h )
endif
if (allocated(tp_fvtp2d_crx_35h)) then
  deallocate( tp_fvtp2d_crx_35h )
endif
if (allocated(tp_fvtp2d_xfx_37h)) then
  deallocate( tp_fvtp2d_xfx_37h )
endif
if (allocated(tp_fvtp2d_fx2_38h)) then
  deallocate( tp_fvtp2d_fx2_38h )
endif
if (allocated(tp_fvtp2d_q_40h)) then
  deallocate( tp_fvtp2d_q_40h )
endif
if (allocated(tp_fvtp2d_q_j_43h)) then
  deallocate( tp_fvtp2d_q_j_43h )
endif
if (allocated(tp_fvtp2d_cry_44h)) then
  deallocate( tp_fvtp2d_cry_44h )
endif
if (allocated(tp_fvtp2d_fx_47h)) then
  deallocate( tp_fvtp2d_fx_47h )
endif
if (allocated(tp_fvtp2d_fx2_48h)) then
  deallocate( tp_fvtp2d_fx2_48h )
endif
if (allocated(tp_fvtp2d_mfx_49h)) then
  deallocate( tp_fvtp2d_mfx_49h )
endif
if (allocated(tp_fvtp2d_fy_50h)) then
  deallocate( tp_fvtp2d_fy_50h )
endif
if (allocated(tp_fvtp2d_fy2_51h)) then
  deallocate( tp_fvtp2d_fy2_51h )
endif
if (allocated(tp_fvtp2d_mfy_52h)) then
  deallocate( tp_fvtp2d_mfy_52h )
endif
if (allocated(tp_fvtp2d_fx_53h)) then
  deallocate( tp_fvtp2d_fx_53h )
endif
if (allocated(tp_fvtp2d_fx2_54h)) then
  deallocate( tp_fvtp2d_fx2_54h )
endif
if (allocated(tp_fvtp2d_xfx_55h)) then
  deallocate( tp_fvtp2d_xfx_55h )
endif
if (allocated(tp_fvtp2d_fy_56h)) then
  deallocate( tp_fvtp2d_fy_56h )
endif
if (allocated(tp_fvtp2d_fy2_57h)) then
  deallocate( tp_fvtp2d_fy2_57h )
endif
if (allocated(tp_fvtp2d_yfx_58h)) then
  deallocate( tp_fvtp2d_yfx_58h )
endif


end subroutine adfv_tp_2d


subroutine adfxppm( c, adc, q, adq, adflux, iord, ifirst, ilast, jfirst, jlast, npx, uniform_ppm )
!******************************************************************
!******************************************************************
!** This routine was generated by Automatic differentiation.     **
!** FastOpt: Transformation of Algorithm in Fortran, TAF 1.9.43  **
!******************************************************************
!******************************************************************
!==============================================
! all entries are defined explicitly
!==============================================
implicit none

!==============================================
! declare parameters
!==============================================
real, parameter :: b1 = 1./30.
real, parameter :: b2 = -(13./60.)
real, parameter :: b3 = -(13./60.)
real, parameter :: b4 = 0.45
real, parameter :: b5 = -0.05
real, parameter :: r3 = 1./3.
real, parameter :: s11 = 11./14.
real, parameter :: s14 = 4./7.
real, parameter :: s15 = 3./14.

!==============================================
! declare arguments
!==============================================
integer, intent(in) :: ifirst
integer, intent(in) :: ilast
integer, intent(in) :: jfirst
integer, intent(in) :: jlast
real, intent(inout) :: adc(ifirst:ilast+1,jfirst:jlast)
real, intent(inout) :: adflux(ifirst:ilast+1,jfirst:jlast)
real, intent(inout) :: adq(ifirst-ng:ilast+ng,jfirst:jlast)
real, intent(in) :: c(ifirst:ilast+1,jfirst:jlast)
integer, intent(in) :: iord
integer, intent(in) :: npx
real, intent(in) :: q(ifirst-ng:ilast+ng,jfirst:jlast)
logical, intent(in) :: uniform_ppm

!==============================================
! declare local variables
!==============================================
real :: adal(ifirst-1:ilast+2)
real :: adbl(ifirst-1:ilast+1)
real :: adbl0
real :: adbl1
real :: adbl2
real :: adbl3
real :: adbl4
real :: adbl5
real :: adbl6
real :: adbl7
real :: adbl8
real :: adbla0
real :: adbla1
real :: adbla2
real :: adblaj
real :: adblak
real :: adblal
real :: adblam
real :: adblan
real :: adblao
real :: adblap
real :: adblaq
real :: adblar
real :: adblas
real :: adblat
real :: adblau
real :: adblav
real :: adblaw
real :: adblax
real :: adblay
real :: adblaz
real :: adblv
real :: adblw
real :: adblx
real :: adbly
real :: adblz
real :: adbr(ifirst-1:ilast+1)
real :: adbr0
real :: adbr1
real :: adbr2
real :: adbr3
real :: adbr4
real :: adbr5
real :: adbr6
real :: adbr7
real :: adbr8
real :: adbra0
real :: adbra1
real :: adbra2
real :: adbraj
real :: adbrak
real :: adbral
real :: adbram
real :: adbran
real :: adbrao
real :: adbrap
real :: adbraq
real :: adbrar
real :: adbras
real :: adbrat
real :: adbrau
real :: adbrav
real :: adbraw
real :: adbrax
real :: adbray
real :: adbraz
real :: adbrv
real :: adbrw
real :: adbrx
real :: adbry
real :: adbrz
real :: adc1
real :: addl
real :: addlh
real :: addli
real :: addlj
real :: addlk
real :: addll
real :: addm1(ifirst-2:ilast+2)
real :: addm17
real :: addm1a0
real :: addm1a1
real :: addm1a2
real :: addm1a3
real :: addm1a4
real :: addm1a5
real :: addm1a6
real :: addm1a7
real :: addm1a8
real :: addm1a9
real :: addm1aaa
real :: addm1aab
real :: addm1aac
real :: addm1aae
real :: addm1aaf
real :: addm1aag
real :: addm1aah
real :: addm1aai
real :: addm1aaj
real :: addm1ae
real :: addm1af
real :: addm1ag
real :: addm1ah
real :: addm1ai
real :: addm1aj
real :: addm1ak
real :: addm1al
real :: addm1am
real :: addm1an
real :: addm1ao
real :: addm1ap
real :: addm1aq
real :: addm1ar
real :: addm1as
real :: addm1at
real :: addm1au
real :: addm1av
real :: addm1aw
real :: addm1ax
real :: addm1ay
real :: addm1az
real :: addm1j
real :: addm1q
real :: addm1s
real :: addm1t
real :: addm1u
real :: addm1v
real :: addm1w
real :: addm1x
real :: addq(ifirst-3:ilast+2)
real :: addr
real :: addrh
real :: addri
real :: addrj
real :: addrk
real :: addrl
real :: adlac
real :: adpmp
real :: adqe
real :: adxt
real :: al(ifirst-1:ilast+2)
real :: bl(ifirst-1:ilast+1)
real :: bl0
real :: bl1
real :: bl2
real :: bl3
real :: bl5
real :: blaf
real :: blag
real :: blah
real :: blai
real :: blaj
real :: blak
real :: blal
real :: blam
real :: blan
real :: blao
real :: blap
real :: blaq
real :: blar
real :: blas
real :: blat
real :: blau
real :: blav
real :: blaw
real :: blax
real :: blay
real :: bls
real :: blu
real :: blv
real :: blw
real :: blx
real :: bly
real :: blz
real :: br(ifirst-1:ilast+1)
real :: br0
real :: br1
real :: br2
real :: br3
real :: br5
real :: braf
real :: brag
real :: brah
real :: brai
real :: braj
real :: brak
real :: bral
real :: bram
real :: bran
real :: brao
real :: brap
real :: braq
real :: brar
real :: bras
real :: brat
real :: brau
real :: brav
real :: braw
real :: brax
real :: bray
real :: brs
real :: bru
real :: brv
real :: brw
real :: brx
real :: bry
real :: brz
real :: c1
real :: dl
real :: dli
real :: dlj
real :: dm1(ifirst-2:ilast+2)
real :: dm11
real :: dm14
real :: dm17
real :: dm18
real :: dm19
real :: dm1a1
real :: dm1a2
real :: dm1aa
real :: dm1ab
real :: dm1ac
real :: dm1ad
real :: dm1ae
real :: dm1af
real :: dm1ag
real :: dm1ah
real :: dm1ai
real :: dm1aj
real :: dm1ak
real :: dm1al
real :: dm1am
real :: dm1an
real :: dm1ao
real :: dm1ap
real :: dm1aq
real :: dm1ar
real :: dm1as
real :: dm1at
real :: dm1au
real :: dm1av
real :: dm1aw
real :: dm1ay
real :: dm1az
real :: dm1j
real :: dm1m
real :: dm1q
real :: dm1r
real :: dm1t
real :: dm1u
real :: dq(ifirst-3:ilast+2)
real :: dr
real :: dri
real :: drj
integer :: help_h
integer :: help_i
integer :: i
integer :: ie3
integer :: is3
integer :: it
integer :: j
real :: lac
real :: pmp
real :: qe
real, allocatable :: tape_fxppm_1_bl_1h(:,:)
real, allocatable :: tape_fxppm_1_br_2h(:,:)
integer :: tape_fxppm_1_fxppm
real, allocatable :: tape_fxppm_2_bl_1h(:,:)
real, allocatable :: tape_fxppm_2_br_2h(:,:)
integer :: tape_fxppm_2_fxppm
real :: xt
real :: xtj
real :: xtk
real :: xtn
real :: xto

!----------------------------------------------
! RESET LOCAL ADJOINT VARIABLES
!----------------------------------------------
adal(:) = 0.
adbl(:) = 0.
adbr(:) = 0.
adc1 = 0.
addl = 0.
addm1(:) = 0.
addq(:) = 0.
addr = 0.
adlac = 0.
adpmp = 0.
adqe = 0.
adxt = 0.

!----------------------------------------------
! ROUTINE BODY
!----------------------------------------------
if (iord .le. 4) then
  do j = jlast, jfirst, -1
    if (uniform_ppm) then
      do i = ifirst-2, ilast+2
        xt = 0.25*(q(i+1,j)-q(i-1,j))
        dm1(i) = sign(min(abs(xt),max(q(i-1,j),q(i,j),q(i+1,j))-q(i,j),q(i,j)-min(q(i-1,j),q(i,j),q(i+1,j))),xt)
      end do
    else
      do i = ifirst-3, ilast+2
        dq(i) = q(i+1,j)-q(i,j)
      end do
      do i = ifirst-2, ilast+2
        xt = cx1(i,j)*dq(i-1)+cx2(i,j)*dq(i)
        dm1(i) = sign(min(abs(xt),abs(dq(i-1)),abs(dq(i))),xt)
      end do
    endif
    do i = ifirst-1, ilast+2
      al(i) = 0.5*(q(i-1,j)+q(i,j))+r3*(dm1(i-1)-dm1(i))
    end do
    do i = ifirst, ilast+1
      addl = 0.
      addr = 0.
      adxt = 0.
      if (c(i,j) .gt. 0.) then
        xt = 2.*dm1(i-1)
        dl = sign(min(abs(xt),abs(al(i-1)-q(i-1,j))),xt)
        dr = sign(min(abs(xt),abs(al(i)-q(i-1,j))),xt)
        adc(i,j) = adc(i,j)+adflux(i,j)*((1.-c(i,j))*(dl-dr)-(c(i,j)*(dl-dr)+dr))
        addl = addl+adflux(i,j)*(1.-c(i,j))*c(i,j)
        addr = addr+adflux(i,j)*(1.-c(i,j))*(1+(-c(i,j)))
        adq(i-1,j) = adq(i-1,j)+adflux(i,j)
        adflux(i,j) = 0.
        drj = al(i)-q(i-1,j)
        addrk = addr*sign(1.,min(abs(xt),abs(drj)))*sign(1.,xt)
        addrl = addrk*(0.5-sign(0.5,abs(drj)-abs(xt)))*sign(1.,drj)
        adxt = adxt+addrk*(0.5+sign(0.5,abs(drj)-abs(xt)))*sign(1.,xt)
        adal(i) = adal(i)+addrl
        adq(i-1,j) = adq(i-1,j)-addrl
        addr = 0.
        dlj = al(i-1)-q(i-1,j)
        addlk = addl*sign(1.,min(abs(xt),abs(dlj)))*sign(1.,xt)
        addll = addlk*(0.5-sign(0.5,abs(dlj)-abs(xt)))*sign(1.,dlj)
        adxt = adxt+addlk*(0.5+sign(0.5,abs(dlj)-abs(xt)))*sign(1.,xt)
        adal(i-1) = adal(i-1)+addll
        adq(i-1,j) = adq(i-1,j)-addll
        addl = 0.
        addm1(i-1) = addm1(i-1)+2*adxt
        adxt = 0.
      else
        xt = 2.*dm1(i)
        dl = sign(min(abs(xt),abs(al(i)-q(i,j))),xt)
        dr = sign(min(abs(xt),abs(al(i+1)-q(i,j))),xt)
        adc(i,j) = adc(i,j)-adflux(i,j)*((1.+2*c(i,j))*(dl-dr)+dl)
        addl = addl-adflux(i,j)*(1.+c(i,j))*(1+c(i,j))
        addr = addr+adflux(i,j)*(1.+c(i,j))*c(i,j)
        adq(i,j) = adq(i,j)+adflux(i,j)
        adflux(i,j) = 0.
        dri = al(i+1)-q(i,j)
        addri = addr*sign(1.,min(abs(xt),abs(dri)))*sign(1.,xt)
        addrj = addri*(0.5-sign(0.5,abs(dri)-abs(xt)))*sign(1.,dri)
        adxt = adxt+addri*(0.5+sign(0.5,abs(dri)-abs(xt)))*sign(1.,xt)
        adal(i+1) = adal(i+1)+addrj
        adq(i,j) = adq(i,j)-addrj
        addr = 0.
        dli = al(i)-q(i,j)
        addli = addl*sign(1.,min(abs(xt),abs(dli)))*sign(1.,xt)
        addlj = addli*(0.5-sign(0.5,abs(dli)-abs(xt)))*sign(1.,dli)
        adxt = adxt+addli*(0.5+sign(0.5,abs(dli)-abs(xt)))*sign(1.,xt)
        adal(i) = adal(i)+addlj
        adq(i,j) = adq(i,j)-addlj
        addl = 0.
        addm1(i) = addm1(i)+2*adxt
        adxt = 0.
      endif
    end do
    do i = ifirst-1, ilast+2
      addm1(i-1) = addm1(i-1)+adal(i)*r3
      addm1(i) = addm1(i)-adal(i)*r3
      adq(i-1,j) = adq(i-1,j)+0.5*adal(i)
      adq(i,j) = adq(i,j)+0.5*adal(i)
      adal(i) = 0.
    end do
    if (uniform_ppm) then
      do i = ifirst-2, ilast+2
        adxt = 0.
        xt = 0.25*(q(i+1,j)-q(i-1,j))
        dm1av = abs(xt)
        dm1aw = max(q(i-1,j),q(i,j))
        dm1ay = max(dm1aw,q(i+1,j))-q(i,j)
        dm1az = min(q(i-1,j),q(i,j))
        dm1a1 = q(i,j)-min(dm1az,q(i+1,j))
        dm1a2 = min(dm1av,dm1ay)
        addm1aaj = addm1(i)*sign(1.,min(dm1a2,dm1a1))*sign(1.,xt)
        addm1aah = addm1aaj*(0.5-sign(0.5,dm1a1-dm1a2))
        addm1aai = addm1aaj*(0.5+sign(0.5,dm1a1-dm1a2))
        addm1aab = addm1aai*(0.5+sign(0.5,dm1ay-dm1av))
        addm1aae = addm1aai*(0.5-sign(0.5,dm1ay-dm1av))
        addm1aag = -addm1aah
        adq(i,j) = adq(i,j)+addm1aah
        addm1aaf = addm1aag*(0.5+sign(0.5,q(i+1,j)-dm1az))
        adq(i+1,j) = adq(i+1,j)+addm1aag*(0.5-sign(0.5,q(i+1,j)-dm1az))
        adq(i-1,j) = adq(i-1,j)+addm1aaf*(0.5+sign(0.5,q(i,j)-q(i-1,j)))
        adq(i,j) = adq(i,j)+addm1aaf*(0.5-sign(0.5,q(i,j)-q(i-1,j)))
        adq(i,j) = adq(i,j)-addm1aae
        addm1aac = addm1aae*(0.5+sign(0.5,dm1aw-q(i+1,j)))
        adq(i+1,j) = adq(i+1,j)+addm1aae*(0.5-sign(0.5,dm1aw-q(i+1,j)))
        adq(i-1,j) = adq(i-1,j)+addm1aac*(0.5+sign(0.5,q(i-1,j)-q(i,j)))
        adq(i,j) = adq(i,j)+addm1aac*(0.5-sign(0.5,q(i-1,j)-q(i,j)))
        adxt = adxt+addm1aab*sign(1.,xt)
        addm1(i) = 0.
        adq(i-1,j) = adq(i-1,j)-0.25*adxt
        adq(i+1,j) = adq(i+1,j)+0.25*adxt
        adxt = 0.
      end do
    else
      do i = ifirst-2, ilast+2
        adxt = 0.
        xt = cx1(i,j)*dq(i-1)+cx2(i,j)*dq(i)
        dm1an = abs(xt)
        dm1aq = abs(dq(i-1))
        dm1at = abs(dq(i))
        dm1au = min(dm1an,dm1aq)
        addm1aaa = addm1(i)*sign(1.,min(dm1au,dm1at))*sign(1.,xt)
        addm1a8 = addm1aaa*(0.5-sign(0.5,dm1at-dm1au))
        addm1a9 = addm1aaa*(0.5+sign(0.5,dm1at-dm1au))
        addm1a0 = addm1a9*(0.5+sign(0.5,dm1aq-dm1an))
        addm1a7 = addm1a9*(0.5-sign(0.5,dm1aq-dm1an))
        addq(i) = addq(i)+addm1a8*sign(1.,dq(i))
        addq(i-1) = addq(i-1)+addm1a7*sign(1.,dq(i-1))
        adxt = adxt+addm1a0*sign(1.,xt)
        addm1(i) = 0.
        addq(i-1) = addq(i-1)+adxt*cx1(i,j)
        addq(i) = addq(i)+adxt*cx2(i,j)
        adxt = 0.
      end do
      do i = ifirst-3, ilast+2
        adq(i+1,j) = adq(i+1,j)+addq(i)
        adq(i,j) = adq(i,j)-addq(i)
        addq(i) = 0.
      end do
    endif
  end do
else if (iord .eq. 5) then
  do j = jfirst, jlast
    adlac = 0.
    adpmp = 0.
    adxt = 0.
    do i = ifirst-3, ilast+2
      dq(i) = q(i+1,j)-q(i,j)
    end do
    if (uniform_ppm) then
      do i = ifirst-2, ilast+2
        xt = 0.25*(q(i+1,j)-q(i-1,j))
        dm1(i) = sign(min(abs(xt),max(q(i-1,j),q(i,j),q(i+1,j))-q(i,j),q(i,j)-min(q(i-1,j),q(i,j),q(i+1,j))),xt)
      end do
    else
      do i = ifirst-2, ilast+2
        xt = cx1(i,j)*dq(i-1)+cx2(i,j)*dq(i)
        dm1(i) = sign(min(abs(xt),abs(dq(i-1)),abs(dq(i))),xt)
      end do
    endif
    do i = ifirst-1, ilast+2
      al(i) = 0.5*(q(i-1,j)+q(i,j))+r3*(dm1(i-1)-dm1(i))
    end do
    do i = ifirst-1, ilast+1
      pmp = -(2.*dq(i))
      lac = pmp+1.5*dq(i+1)
      bl(i) = min(max(0.,pmp,lac),max(al(i)-q(i,j),min(0.,pmp,lac)))
      pmp = 2.*dq(i-1)
      lac = pmp-1.5*dq(i-2)
      br(i) = min(max(0.,pmp,lac),max(al(i+1)-q(i,j),min(0.,pmp,lac)))
    end do
    do i = ifirst, ilast+1
      if (c(i,j) .gt. 0.) then
        adbl(i-1) = adbl(i-1)-adflux(i,j)*(1.-c(i,j))*c(i,j)
        adbr(i-1) = adbr(i-1)+adflux(i,j)*(1.-c(i,j))*(1-c(i,j))
        adc(i,j) = adc(i,j)+adflux(i,j)*((-((1.-c(i,j))*(bl(i-1)+br(i-1))))-(br(i-1)-c(i,j)*(bl(i-1)+br(i-1))))
        adq(i-1,j) = adq(i-1,j)+adflux(i,j)
        adflux(i,j) = 0.
      else
        adbl(i) = adbl(i)+adflux(i,j)*(1.+c(i,j))*(1+c(i,j))
        adbr(i) = adbr(i)+adflux(i,j)*(1.+c(i,j))*c(i,j)
        adc(i,j) = adc(i,j)+adflux(i,j)*((1.+c(i,j))*(bl(i)+br(i))+bl(i)+c(i,j)*(bl(i)+br(i)))
        adq(i,j) = adq(i,j)+adflux(i,j)
        adflux(i,j) = 0.
      endif
    end do
    do i = ifirst-1, ilast+1
      adlac = 0.
      adpmp = 0.
      pmp = 2.*dq(i-1)
      lac = pmp-1.5*dq(i-2)
      brau = max(0.,pmp)
      brav = max(brau,lac)
      brax = min(0.,pmp)
      bray = min(brax,lac)
      braw = max(al(i+1)-q(i,j),bray)
      adbraz = adbr(i)*(0.5+sign(0.5,braw-brav))
      adbra0 = adbr(i)*(0.5-sign(0.5,braw-brav))
      adal(i+1) = adal(i+1)+adbra0*(0.5+sign(0.5,al(i+1)-q(i,j)-bray))
      adbra2 = adbra0*(0.5-sign(0.5,al(i+1)-q(i,j)-bray))
      adq(i,j) = adq(i,j)-adbra0*(0.5+sign(0.5,al(i+1)-q(i,j)-bray))
      adbra1 = adbra2*(0.5+sign(0.5,lac-brax))
      adlac = adlac+adbra2*(0.5-sign(0.5,lac-brax))
      adpmp = adpmp+adbra1*(0.5-sign(0.5,pmp-0.))
      adbray = adbraz*(0.5+sign(0.5,brau-lac))
      adlac = adlac+adbraz*(0.5-sign(0.5,brau-lac))
      adpmp = adpmp+adbray*(0.5-sign(0.5,0.-pmp))
      adbr(i) = 0.
      addq(i-2) = addq(i-2)-1.5*adlac
      adpmp = adpmp+adlac
      adlac = 0.
      addq(i-1) = addq(i-1)+2*adpmp
      adpmp = 0.
      pmp = -(2.*dq(i))
      lac = pmp+1.5*dq(i+1)
      blau = max(0.,pmp)
      blav = max(blau,lac)
      blax = min(0.,pmp)
      blay = min(blax,lac)
      blaw = max(al(i)-q(i,j),blay)
      adblaz = adbl(i)*(0.5+sign(0.5,blaw-blav))
      adbla0 = adbl(i)*(0.5-sign(0.5,blaw-blav))
      adal(i) = adal(i)+adbla0*(0.5+sign(0.5,al(i)-q(i,j)-blay))
      adbla2 = adbla0*(0.5-sign(0.5,al(i)-q(i,j)-blay))
      adq(i,j) = adq(i,j)-adbla0*(0.5+sign(0.5,al(i)-q(i,j)-blay))
      adbla1 = adbla2*(0.5+sign(0.5,lac-blax))
      adlac = adlac+adbla2*(0.5-sign(0.5,lac-blax))
      adpmp = adpmp+adbla1*(0.5-sign(0.5,pmp-0.))
      adblay = adblaz*(0.5+sign(0.5,blau-lac))
      adlac = adlac+adblaz*(0.5-sign(0.5,blau-lac))
      adpmp = adpmp+adblay*(0.5-sign(0.5,0.-pmp))
      adbl(i) = 0.
      addq(i+1) = addq(i+1)+1.5*adlac
      adpmp = adpmp+adlac
      adlac = 0.
      addq(i) = addq(i)-2*adpmp
      adpmp = 0.
    end do
    do i = ifirst-1, ilast+2
      addm1(i-1) = addm1(i-1)+adal(i)*r3
      addm1(i) = addm1(i)-adal(i)*r3
      adq(i-1,j) = adq(i-1,j)+0.5*adal(i)
      adq(i,j) = adq(i,j)+0.5*adal(i)
      adal(i) = 0.
    end do
    if (uniform_ppm) then
      do i = ifirst-2, ilast+2
        adxt = 0.
        xt = 0.25*(q(i+1,j)-q(i-1,j))
        dm1al = abs(xt)
        dm1am = max(q(i-1,j),q(i,j))
        dm1ao = max(dm1am,q(i+1,j))-q(i,j)
        dm1ap = min(q(i-1,j),q(i,j))
        dm1ar = q(i,j)-min(dm1ap,q(i+1,j))
        dm1as = min(dm1al,dm1ao)
        addm1a6 = addm1(i)*sign(1.,min(dm1as,dm1ar))*sign(1.,xt)
        addm1a4 = addm1a6*(0.5-sign(0.5,dm1ar-dm1as))
        addm1a5 = addm1a6*(0.5+sign(0.5,dm1ar-dm1as))
        addm1ay = addm1a5*(0.5+sign(0.5,dm1ao-dm1al))
        addm1a1 = addm1a5*(0.5-sign(0.5,dm1ao-dm1al))
        addm1a3 = -addm1a4
        adq(i,j) = adq(i,j)+addm1a4
        addm1a2 = addm1a3*(0.5+sign(0.5,q(i+1,j)-dm1ap))
        adq(i+1,j) = adq(i+1,j)+addm1a3*(0.5-sign(0.5,q(i+1,j)-dm1ap))
        adq(i-1,j) = adq(i-1,j)+addm1a2*(0.5+sign(0.5,q(i,j)-q(i-1,j)))
        adq(i,j) = adq(i,j)+addm1a2*(0.5-sign(0.5,q(i,j)-q(i-1,j)))
        adq(i,j) = adq(i,j)-addm1a1
        addm1az = addm1a1*(0.5+sign(0.5,dm1am-q(i+1,j)))
        adq(i+1,j) = adq(i+1,j)+addm1a1*(0.5-sign(0.5,dm1am-q(i+1,j)))
        adq(i-1,j) = adq(i-1,j)+addm1az*(0.5+sign(0.5,q(i-1,j)-q(i,j)))
        adq(i,j) = adq(i,j)+addm1az*(0.5-sign(0.5,q(i-1,j)-q(i,j)))
        adxt = adxt+addm1ay*sign(1.,xt)
        addm1(i) = 0.
        adq(i-1,j) = adq(i-1,j)-0.25*adxt
        adq(i+1,j) = adq(i+1,j)+0.25*adxt
        adxt = 0.
      end do
    else
      do i = ifirst-2, ilast+2
        adxt = 0.
        xt = cx1(i,j)*dq(i-1)+cx2(i,j)*dq(i)
        dm1ad = abs(xt)
        dm1ag = abs(dq(i-1))
        dm1aj = abs(dq(i))
        dm1ak = min(dm1ad,dm1ag)
        addm1ax = addm1(i)*sign(1.,min(dm1ak,dm1aj))*sign(1.,xt)
        addm1av = addm1ax*(0.5-sign(0.5,dm1aj-dm1ak))
        addm1aw = addm1ax*(0.5+sign(0.5,dm1aj-dm1ak))
        addm1an = addm1aw*(0.5+sign(0.5,dm1ag-dm1ad))
        addm1au = addm1aw*(0.5-sign(0.5,dm1ag-dm1ad))
        addq(i) = addq(i)+addm1av*sign(1.,dq(i))
        addq(i-1) = addq(i-1)+addm1au*sign(1.,dq(i-1))
        adxt = adxt+addm1an*sign(1.,xt)
        addm1(i) = 0.
        addq(i-1) = addq(i-1)+adxt*cx1(i,j)
        addq(i) = addq(i)+adxt*cx2(i,j)
        adxt = 0.
      end do
    endif
    do i = ifirst-3, ilast+2
      adq(i+1,j) = adq(i+1,j)+addq(i)
      adq(i,j) = adq(i,j)-addq(i)
      addq(i) = 0.
    end do
  end do
else if (iord .eq. 6 .or. iord .eq. 7) then
  do j = jfirst, jlast
    addl = 0.
    addr = 0.
    adlac = 0.
    adpmp = 0.
    adxt = 0.
    do i = ifirst-1, ilast+1
      xt = b3*q(i,j)
      bl(i) = b5*q(i-2,j)+b4*q(i-1,j)+xt+b2*q(i+1,j)+b1*q(i+2,j)
      br(i) = b1*q(i-2,j)+b2*q(i-1,j)+xt+b4*q(i+1,j)+b5*q(i+2,j)
    end do
    if (iord .eq. 7) then
      do i = ifirst-2, ilast+3
        dq(i) = q(i,j)-q(i-1,j)
      end do
      do i = ifirst-1, ilast+1
        dl = -sign(min(abs(bl(i)),abs(dq(i))),dq(i))
        pmp = -(2.*dq(i+1))
        lac = pmp+1.5*dq(i+2)
        bl(i) = min(max(0.,pmp,lac),max(dl,min(0.,pmp,lac)))
        dr = sign(min(abs(br(i)),abs(dq(i+1))),dq(i+1))
        pmp = 2.*dq(i)
        lac = pmp-1.5*dq(i-1)
        br(i) = min(max(0.,pmp,lac),max(dr,min(0.,pmp,lac)))
      end do
    endif
    do i = ifirst, ilast+1
      if (c(i,j) .gt. 0.) then
        adbl(i-1) = adbl(i-1)-adflux(i,j)*(1.-c(i,j))*c(i,j)
        adbr(i-1) = adbr(i-1)+adflux(i,j)*(1.-c(i,j))*(1-c(i,j))
        adc(i,j) = adc(i,j)+adflux(i,j)*((-((1.-c(i,j))*(bl(i-1)+br(i-1))))-(br(i-1)-c(i,j)*(bl(i-1)+br(i-1))))
        adq(i-1,j) = adq(i-1,j)+adflux(i,j)
        adflux(i,j) = 0.
      else
        adbl(i) = adbl(i)+adflux(i,j)*(1.+c(i,j))*(1+c(i,j))
        adbr(i) = adbr(i)+adflux(i,j)*(1.+c(i,j))*c(i,j)
        adc(i,j) = adc(i,j)+adflux(i,j)*((1.+c(i,j))*(bl(i)+br(i))+bl(i)+c(i,j)*(bl(i)+br(i)))
        adq(i,j) = adq(i,j)+adflux(i,j)
        adflux(i,j) = 0.
      endif
    end do
    do i = ifirst-1, ilast+1
      xt = b3*q(i,j)
      bl(i) = b5*q(i-2,j)+b4*q(i-1,j)+xt+b2*q(i+1,j)+b1*q(i+2,j)
      br(i) = b1*q(i-2,j)+b2*q(i-1,j)+xt+b4*q(i+1,j)+b5*q(i+2,j)
    end do
    if (iord .eq. 7) then
      do i = ifirst-1, ilast+1
        addl = 0.
        addr = 0.
        adlac = 0.
        adpmp = 0.
        dl = -sign(min(abs(bl(i)),abs(dq(i))),dq(i))
        dr = sign(min(abs(br(i)),abs(dq(i+1))),dq(i+1))
        pmp = 2.*dq(i)
        lac = pmp-1.5*dq(i-1)
        brap = max(0.,pmp)
        braq = max(brap,lac)
        bras = min(0.,pmp)
        brat = min(bras,lac)
        brar = max(dr,brat)
        adbrau = adbr(i)*(0.5+sign(0.5,brar-braq))
        adbrav = adbr(i)*(0.5-sign(0.5,brar-braq))
        adbrax = adbrav*(0.5-sign(0.5,dr-brat))
        addr = addr+adbrav*(0.5+sign(0.5,dr-brat))
        adbraw = adbrax*(0.5+sign(0.5,lac-bras))
        adlac = adlac+adbrax*(0.5-sign(0.5,lac-bras))
        adpmp = adpmp+adbraw*(0.5-sign(0.5,pmp-0.))
        adbrat = adbrau*(0.5+sign(0.5,brap-lac))
        adlac = adlac+adbrau*(0.5-sign(0.5,brap-lac))
        adpmp = adpmp+adbrat*(0.5-sign(0.5,0.-pmp))
        adbr(i) = 0.
        addq(i-1) = addq(i-1)-1.5*adlac
        adpmp = adpmp+adlac
        adlac = 0.
        addq(i) = addq(i)+2*adpmp
        adpmp = 0.
        addrh = addr*sign(1.,min(abs(br(i)),abs(dq(i+1))))*sign(1.,dq(i+1))
        adbr(i) = adbr(i)+addrh*(0.5+sign(0.5,abs(dq(i+1))-abs(br(i))))*sign(1.,br(i))
        addq(i+1) = addq(i+1)+addrh*(0.5-sign(0.5,abs(dq(i+1))-abs(br(i))))*sign(1.,dq(i+1))
        addr = 0.
        pmp = -(2.*dq(i+1))
        lac = pmp+1.5*dq(i+2)
        blap = max(0.,pmp)
        blaq = max(blap,lac)
        blas = min(0.,pmp)
        blat = min(blas,lac)
        blar = max(dl,blat)
        adblau = adbl(i)*(0.5+sign(0.5,blar-blaq))
        adblav = adbl(i)*(0.5-sign(0.5,blar-blaq))
        adblax = adblav*(0.5-sign(0.5,dl-blat))
        addl = addl+adblav*(0.5+sign(0.5,dl-blat))
        adblaw = adblax*(0.5+sign(0.5,lac-blas))
        adlac = adlac+adblax*(0.5-sign(0.5,lac-blas))
        adpmp = adpmp+adblaw*(0.5-sign(0.5,pmp-0.))
        adblat = adblau*(0.5+sign(0.5,blap-lac))
        adlac = adlac+adblau*(0.5-sign(0.5,blap-lac))
        adpmp = adpmp+adblat*(0.5-sign(0.5,0.-pmp))
        adbl(i) = 0.
        addq(i+2) = addq(i+2)+1.5*adlac
        adpmp = adpmp+adlac
        adlac = 0.
        addq(i+1) = addq(i+1)-2*adpmp
        adpmp = 0.
        addlh = -(addl*sign(1.,min(abs(bl(i)),abs(dq(i))))*sign(1.,dq(i)))
        adbl(i) = adbl(i)+addlh*(0.5+sign(0.5,abs(dq(i))-abs(bl(i))))*sign(1.,bl(i))
        addq(i) = addq(i)+addlh*(0.5-sign(0.5,abs(dq(i))-abs(bl(i))))*sign(1.,dq(i))
        addl = 0.
      end do
      do i = ifirst-2, ilast+3
        adq(i-1,j) = adq(i-1,j)-addq(i)
        adq(i,j) = adq(i,j)+addq(i)
        addq(i) = 0.
      end do
    endif
    do i = ifirst-1, ilast+1
      adxt = 0.
      adq(i-2,j) = adq(i-2,j)+adbr(i)*b1
      adq(i-1,j) = adq(i-1,j)+adbr(i)*b2
      adq(i+2,j) = adq(i+2,j)+adbr(i)*b5
      adq(i+1,j) = adq(i+1,j)+adbr(i)*b4
      adxt = adxt+adbr(i)
      adbr(i) = 0.
      adq(i-2,j) = adq(i-2,j)+adbl(i)*b5
      adq(i-1,j) = adq(i-1,j)+adbl(i)*b4
      adq(i+2,j) = adq(i+2,j)+adbl(i)*b1
      adq(i+1,j) = adq(i+1,j)+adbl(i)*b2
      adxt = adxt+adbl(i)
      adbl(i) = 0.
      adq(i,j) = adq(i,j)+adxt*b3
      adxt = 0.
    end do
  end do
else if (iord .le. 10) then
  is3 = max(3,is-1)
  ie3 = min(npx-3,ie+1)
!----------------------------------------------
! OPEN TAPE tape_fxppm_1
!----------------------------------------------
  tape_fxppm_1_fxppm = jlast-jfirst+1

!----------------------------------------------
! TAPE COMPUTATIONS
!----------------------------------------------
  do j = jfirst, jlast-1
    if ( .not. allocated(tape_fxppm_1_bl_1h)) then
      allocate( tape_fxppm_1_bl_1h(ifirst-1:ilast+1,tape_fxppm_1_fxppm) )
    endif
    tape_fxppm_1_bl_1h(:,j-jfirst+1) = bl
    if ( .not. allocated(tape_fxppm_1_br_2h)) then
      allocate( tape_fxppm_1_br_2h(ifirst-1:ilast+1,tape_fxppm_1_fxppm) )
    endif
    tape_fxppm_1_br_2h(:,j-jfirst+1) = br
    if (grid_type .lt. 3) then
      do i = is-3, ie+2
        dq(i) = q(i+1,j)-q(i,j)
      end do
      do i = is-2, ie+2
        xt = 0.25*(q(i+1,j)-q(i-1,j))
        dm1(i) = sign(min(abs(xt),max(q(i-1,j),q(i,j),q(i+1,j))-q(i,j),q(i,j)-min(q(i-1,j),q(i,j),q(i+1,j))),xt)
      end do
      do i = is3, min(npx-2,ie+2)
        al(i) = 0.5*(q(i-1,j)+q(i,j))+r3*(dm1(i-1)-dm1(i))
      end do
      do i = is3, ie3
        pmp = -(2.*dq(i))
        lac = pmp+1.5*dq(i+1)
        bl(i) = min(max(0.,pmp,lac),max(al(i)-q(i,j),min(0.,pmp,lac)))
        pmp = 2.*dq(i-1)
        lac = pmp-1.5*dq(i-2)
        br(i) = min(max(0.,pmp,lac),max(al(i+1)-q(i,j),min(0.,pmp,lac)))
      end do
      if (is .eq. 1) then
        br(2) = al(3)-q(2,j)
        xt = 0.5*((2.*dxa(1,j)+dxa(2,j))*(q(0,j)+q(1,j))-dxa(1,j)*(q(-1,j)+q(2,j)))/(dxa(1,j)+dxa(2,j))
        bl(1) = xt-q(1,j)
        br(0) = xt-q(0,j)
        xt = s14*dm1(-1)-s11*dq(-1)+q(0,j)
        bl(0) = xt-q(0,j)
        xt = s15*q(1,j)+s11*q(2,j)-s14*dm1(2)
        br(1) = xt-q(1,j)
        bl(2) = xt-q(2,j)
        if (iord .eq. 9) then
          call pert_ppm( 3,q(0:2,j),bl(0:2),br(0:2),1 )
        endif
      endif
      if (ie+1 .eq. npx) then
        bl(npx-2) = al(npx-2)-q(npx-2,j)
        xt = 0.5*((2.*dxa(npx-1,j)+dxa(npx-2,j))*(q(npx-1,j)+q(npx,j))-dxa(npx-1,j)*(q(npx-2,j)+q(npx+1,j)))/(dxa(npx-1,j)+dxa(npx-&
&2,j))
        br(npx-1) = xt-q(npx-1,j)
        bl(npx) = xt-q(npx,j)
        xt = s11*dq(npx)-s14*dm1(npx+1)+q(npx,j)
        br(npx) = xt-q(npx,j)
        xt = s15*q(npx-1,j)+s11*q(npx-2,j)+s14*dm1(npx-2)
        br(npx-2) = xt-q(npx-2,j)
        bl(npx-1) = xt-q(npx-1,j)
        if (iord .eq. 9) then
          call pert_ppm( 3,q(npx-2:npx,j),bl(npx-2:npx),br(npx-2:npx),1 )
        endif
      endif
    else
      do i = ifirst-2, ilast+2
        xt = 0.25*(q(i+1,j)-q(i-1,j))
        dm1(i) = sign(min(abs(xt),max(q(i-1,j),q(i,j),q(i+1,j))-q(i,j),q(i,j)-min(q(i-1,j),q(i,j),q(i+1,j))),xt)
      end do
      do i = ifirst-1, ilast+2
        al(i) = 0.5*(q(i-1,j)+q(i,j))+r3*(dm1(i-1)-dm1(i))
      end do
      do i = ifirst-3, ilast+2
        dq(i) = q(i+1,j)-q(i,j)
      end do
      do i = ifirst-1, ilast+1
        pmp = -(2.*dq(i))
        lac = pmp+1.5*dq(i+1)
        bl(i) = min(max(0.,pmp,lac),max(al(i)-q(i,j),min(0.,pmp,lac)))
        pmp = 2.*dq(i-1)
        lac = pmp-1.5*dq(i-2)
        br(i) = min(max(0.,pmp,lac),max(al(i+1)-q(i,j),min(0.,pmp,lac)))
      end do
    endif
  end do
  j = jlast
  if ( .not. allocated(tape_fxppm_1_bl_1h)) then
    allocate( tape_fxppm_1_bl_1h(ifirst-1:ilast+1,tape_fxppm_1_fxppm) )
  endif
  tape_fxppm_1_bl_1h(:,j-jfirst+1) = bl
  if ( .not. allocated(tape_fxppm_1_br_2h)) then
    allocate( tape_fxppm_1_br_2h(ifirst-1:ilast+1,tape_fxppm_1_fxppm) )
  endif
  tape_fxppm_1_br_2h(:,j-jfirst+1) = br

!----------------------------------------------
! ADJOINT COMPUTATIONS
!----------------------------------------------
  do j = jlast, jfirst, -1
    if (grid_type .lt. 3) then
      do i = is-3, ie+2
        dq(i) = q(i+1,j)-q(i,j)
      end do
      do i = is-2, ie+2
        xt = 0.25*(q(i+1,j)-q(i-1,j))
        dm1(i) = sign(min(abs(xt),max(q(i-1,j),q(i,j),q(i+1,j))-q(i,j),q(i,j)-min(q(i-1,j),q(i,j),q(i+1,j))),xt)
      end do
      do i = is3, min(npx-2,ie+2)
        al(i) = 0.5*(q(i-1,j)+q(i,j))+r3*(dm1(i-1)-dm1(i))
      end do
      do i = is3, ie3
        pmp = -(2.*dq(i))
        lac = pmp+1.5*dq(i+1)
        bl(i) = min(max(0.,pmp,lac),max(al(i)-q(i,j),min(0.,pmp,lac)))
        pmp = 2.*dq(i-1)
        lac = pmp-1.5*dq(i-2)
        br(i) = min(max(0.,pmp,lac),max(al(i+1)-q(i,j),min(0.,pmp,lac)))
      end do
      if (is .eq. 1) then
        br(2) = al(3)-q(2,j)
        xt = 0.5*((2.*dxa(1,j)+dxa(2,j))*(q(0,j)+q(1,j))-dxa(1,j)*(q(-1,j)+q(2,j)))/(dxa(1,j)+dxa(2,j))
        bl(1) = xt-q(1,j)
        br(0) = xt-q(0,j)
        xt = s14*dm1(-1)-s11*dq(-1)+q(0,j)
        bl(0) = xt-q(0,j)
        xt = s15*q(1,j)+s11*q(2,j)-s14*dm1(2)
        br(1) = xt-q(1,j)
        bl(2) = xt-q(2,j)
        if (iord .eq. 9) then
          call pert_ppm( 3,q(0:2,j),bl(0:2),br(0:2),1 )
        endif
      endif
      if (ie+1 .eq. npx) then
        bl(npx-2) = al(npx-2)-q(npx-2,j)
        xt = 0.5*((2.*dxa(npx-1,j)+dxa(npx-2,j))*(q(npx-1,j)+q(npx,j))-dxa(npx-1,j)*(q(npx-2,j)+q(npx+1,j)))/(dxa(npx-1,j)+dxa(npx-&
&2,j))
        br(npx-1) = xt-q(npx-1,j)
        bl(npx) = xt-q(npx,j)
        xt = s11*dq(npx)-s14*dm1(npx+1)+q(npx,j)
        br(npx) = xt-q(npx,j)
        xt = s15*q(npx-1,j)+s11*q(npx-2,j)+s14*dm1(npx-2)
        br(npx-2) = xt-q(npx-2,j)
        bl(npx-1) = xt-q(npx-1,j)
        if (iord .eq. 9) then
          call pert_ppm( 3,q(npx-2:npx,j),bl(npx-2:npx),br(npx-2:npx),1 )
        endif
      endif
    else
      do i = ifirst-2, ilast+2
        xt = 0.25*(q(i+1,j)-q(i-1,j))
        dm1(i) = sign(min(abs(xt),max(q(i-1,j),q(i,j),q(i+1,j))-q(i,j),q(i,j)-min(q(i-1,j),q(i,j),q(i+1,j))),xt)
      end do
      do i = ifirst-1, ilast+2
        al(i) = 0.5*(q(i-1,j)+q(i,j))+r3*(dm1(i-1)-dm1(i))
      end do
      do i = ifirst-3, ilast+2
        dq(i) = q(i+1,j)-q(i,j)
      end do
      do i = ifirst-1, ilast+1
        pmp = -(2.*dq(i))
        lac = pmp+1.5*dq(i+1)
        bl(i) = min(max(0.,pmp,lac),max(al(i)-q(i,j),min(0.,pmp,lac)))
        pmp = 2.*dq(i-1)
        lac = pmp-1.5*dq(i-2)
        br(i) = min(max(0.,pmp,lac),max(al(i+1)-q(i,j),min(0.,pmp,lac)))
      end do
    endif
    do i = ifirst, ilast+1
      adc1 = 0.
      adqe = 0.
      if (intel_opt_kim) then
        c1 = c(i,j)
        if (c1 .gt. 0.) then
          it = i-1
          qe = br(i-1)
        else
          it = i
          qe = bl(i)
        endif
        c1 = -abs(c1)
        adbl(it) = adbl(it)+adflux(i,j)*(1.+c1)*c1
        adbr(it) = adbr(it)+adflux(i,j)*(1.+c1)*c1
        adc1 = adc1+adflux(i,j)*((1.+c1)*(bl(it)+br(it))+qe+c1*(bl(it)+br(it)))
        adq(it,j) = adq(it,j)+adflux(i,j)
        adqe = adqe+adflux(i,j)*(1+c1)
        adflux(i,j) = 0.
        c1 = c(i,j)
        adc1 = -(adc1*sign(1.,c1))
        c1 = c(i,j)
        if (c1 .gt. 0.) then
          adbr(i-1) = adbr(i-1)+adqe
          adqe = 0.
        else
          adbl(i) = adbl(i)+adqe
          adqe = 0.
        endif
        adc(i,j) = adc(i,j)+adc1
        adc1 = 0.
      else
        if (c(i,j) .gt. 0.) then
          adbl(i-1) = adbl(i-1)-adflux(i,j)*(1.-c(i,j))*c(i,j)
          adbr(i-1) = adbr(i-1)+adflux(i,j)*(1.-c(i,j))*(1-c(i,j))
          adc(i,j) = adc(i,j)+adflux(i,j)*((-((1.-c(i,j))*(bl(i-1)+br(i-1))))-(br(i-1)-c(i,j)*(bl(i-1)+br(i-1))))
          adq(i-1,j) = adq(i-1,j)+adflux(i,j)
          adflux(i,j) = 0.
        else
          adbl(i) = adbl(i)+adflux(i,j)*(1.+c(i,j))*(1+c(i,j))
          adbr(i) = adbr(i)+adflux(i,j)*(1.+c(i,j))*c(i,j)
          adc(i,j) = adc(i,j)+adflux(i,j)*((1.+c(i,j))*(bl(i)+br(i))+bl(i)+c(i,j)*(bl(i)+br(i)))
          adq(i,j) = adq(i,j)+adflux(i,j)
          adflux(i,j) = 0.
        endif
      endif
    end do
    bl = tape_fxppm_1_bl_1h(:,j-jfirst+1)
    br = tape_fxppm_1_br_2h(:,j-jfirst+1)
    if (grid_type .lt. 3) then
      do i = is3, ie3
        pmp = -(2.*dq(i))
        lac = pmp+1.5*dq(i+1)
        bl(i) = min(max(0.,pmp,lac),max(al(i)-q(i,j),min(0.,pmp,lac)))
        pmp = 2.*dq(i-1)
        lac = pmp-1.5*dq(i-2)
        br(i) = min(max(0.,pmp,lac),max(al(i+1)-q(i,j),min(0.,pmp,lac)))
      end do
      if (is .eq. 1) then
        br(2) = al(3)-q(2,j)
        xt = 0.5*((2.*dxa(1,j)+dxa(2,j))*(q(0,j)+q(1,j))-dxa(1,j)*(q(-1,j)+q(2,j)))/(dxa(1,j)+dxa(2,j))
        bl(1) = xt-q(1,j)
        br(0) = xt-q(0,j)
        xt = s14*dm1(-1)-s11*dq(-1)+q(0,j)
        bl(0) = xt-q(0,j)
        xt = s15*q(1,j)+s11*q(2,j)-s14*dm1(2)
        br(1) = xt-q(1,j)
        bl(2) = xt-q(2,j)
        if (iord .eq. 9) then
          call pert_ppm( 3,q(0:2,j),bl(0:2),br(0:2),1 )
        endif
      endif
      if (ie+1 .eq. npx) then
        xtn = xt
        xto = xt
        bl(npx-2) = al(npx-2)-q(npx-2,j)
        xt = 0.5*((2.*dxa(npx-1,j)+dxa(npx-2,j))*(q(npx-1,j)+q(npx,j))-dxa(npx-1,j)*(q(npx-2,j)+q(npx+1,j)))/(dxa(npx-1,j)+dxa(npx-&
&2,j))
        br(npx-1) = xt-q(npx-1,j)
        bl(npx) = xt-q(npx,j)
        xt = xto
        xt = s11*dq(npx)-s14*dm1(npx+1)+q(npx,j)
        br(npx) = xt-q(npx,j)
        xt = xtn
        br(npx-2) = xt-q(npx-2,j)
        bl(npx-1) = xt-q(npx-1,j)
        if (iord .eq. 9) then
          call adpert_ppm( 3,q(npx-2:npx,j),adq(npx-2:npx,j),bl(npx-2:npx),adbl(npx-2:npx),br(npx-2:npx),adbr(npx-2:npx),1 )
        endif
        adq(npx-1,j) = adq(npx-1,j)-adbl(npx-1)
        adxt = adxt+adbl(npx-1)
        adbl(npx-1) = 0.
        adq(npx-2,j) = adq(npx-2,j)-adbr(npx-2)
        adxt = adxt+adbr(npx-2)
        adbr(npx-2) = 0.
        addm1(npx-2) = addm1(npx-2)+adxt*s14
        adq(npx-2,j) = adq(npx-2,j)+adxt*s11
        adq(npx-1,j) = adq(npx-1,j)+adxt*s15
        adxt = 0.
        adq(npx,j) = adq(npx,j)-adbr(npx)
        adxt = adxt+adbr(npx)
        adbr(npx) = 0.
        addm1(npx+1) = addm1(npx+1)-adxt*s14
        addq(npx) = addq(npx)+adxt*s11
        adq(npx,j) = adq(npx,j)+adxt
        adxt = 0.
        adq(npx,j) = adq(npx,j)-adbl(npx)
        adxt = adxt+adbl(npx)
        adbl(npx) = 0.
        adq(npx-1,j) = adq(npx-1,j)-adbr(npx-1)
        adxt = adxt+adbr(npx-1)
        adbr(npx-1) = 0.
        adq(npx-2,j) = adq(npx-2,j)-adxt*(0.5*dxa(npx-1,j)/(dxa(npx-1,j)+dxa(npx-2,j)))
        adq(npx-1,j) = adq(npx-1,j)+adxt*(0.5*(2.*dxa(npx-1,j)+dxa(npx-2,j))/(dxa(npx-1,j)+dxa(npx-2,j)))
        adq(npx+1,j) = adq(npx+1,j)-adxt*(0.5*dxa(npx-1,j)/(dxa(npx-1,j)+dxa(npx-2,j)))
        adq(npx,j) = adq(npx,j)+adxt*(0.5*(2.*dxa(npx-1,j)+dxa(npx-2,j))/(dxa(npx-1,j)+dxa(npx-2,j)))
        adxt = 0.
        adal(npx-2) = adal(npx-2)+adbl(npx-2)
        adq(npx-2,j) = adq(npx-2,j)-adbl(npx-2)
        adbl(npx-2) = 0.
      endif
      do i = is3, ie3
        pmp = -(2.*dq(i))
        lac = pmp+1.5*dq(i+1)
        bl(i) = min(max(0.,pmp,lac),max(al(i)-q(i,j),min(0.,pmp,lac)))
        pmp = 2.*dq(i-1)
        lac = pmp-1.5*dq(i-2)
        br(i) = min(max(0.,pmp,lac),max(al(i+1)-q(i,j),min(0.,pmp,lac)))
      end do
      if (is .eq. 1) then
        br(2) = al(3)-q(2,j)
        xt = 0.5*((2.*dxa(1,j)+dxa(2,j))*(q(0,j)+q(1,j))-dxa(1,j)*(q(-1,j)+q(2,j)))/(dxa(1,j)+dxa(2,j))
        bl(1) = xt-q(1,j)
        br(0) = xt-q(0,j)
        xt = s14*dm1(-1)-s11*dq(-1)+q(0,j)
        bl(0) = xt-q(0,j)
        xt = s15*q(1,j)+s11*q(2,j)-s14*dm1(2)
        br(1) = xt-q(1,j)
        bl(2) = xt-q(2,j)
        if (iord .eq. 9) then
          call adpert_ppm( 3,q(0:2,j),adq(0:2,j),bl(0:2),adbl(0:2),br(0:2),adbr(0:2),1 )
        endif
        adq(2,j) = adq(2,j)-adbl(2)
        adxt = adxt+adbl(2)
        adbl(2) = 0.
        adq(1,j) = adq(1,j)-adbr(1)
        adxt = adxt+adbr(1)
        adbr(1) = 0.
        addm1(2) = addm1(2)-adxt*s14
        adq(2,j) = adq(2,j)+adxt*s11
        adq(1,j) = adq(1,j)+adxt*s15
        adxt = 0.
        adq(0,j) = adq(0,j)-adbl(0)
        adxt = adxt+adbl(0)
        adbl(0) = 0.
        addm1(-1) = addm1(-1)+adxt*s14
        addq(-1) = addq(-1)-adxt*s11
        adq(0,j) = adq(0,j)+adxt
        adxt = 0.
        adq(0,j) = adq(0,j)-adbr(0)
        adxt = adxt+adbr(0)
        adbr(0) = 0.
        adq(1,j) = adq(1,j)-adbl(1)
        adxt = adxt+adbl(1)
        adbl(1) = 0.
        adq(-1,j) = adq(-1,j)-adxt*(0.5*dxa(1,j)/(dxa(1,j)+dxa(2,j)))
        adq(2,j) = adq(2,j)-adxt*(0.5*dxa(1,j)/(dxa(1,j)+dxa(2,j)))
        adq(1,j) = adq(1,j)+adxt*(0.5*(2.*dxa(1,j)+dxa(2,j))/(dxa(1,j)+dxa(2,j)))
        adq(0,j) = adq(0,j)+adxt*(0.5*(2.*dxa(1,j)+dxa(2,j))/(dxa(1,j)+dxa(2,j)))
        adxt = 0.
        adal(3) = adal(3)+adbr(2)
        adq(2,j) = adq(2,j)-adbr(2)
        adbr(2) = 0.
      endif
      do i = is3, ie3
        adlac = 0.
        adpmp = 0.
        pmp = 2.*dq(i-1)
        lac = pmp-1.5*dq(i-2)
        brak = max(0.,pmp)
        bral = max(brak,lac)
        bran = min(0.,pmp)
        brao = min(bran,lac)
        bram = max(al(i+1)-q(i,j),brao)
        adbrap = adbr(i)*(0.5+sign(0.5,bram-bral))
        adbraq = adbr(i)*(0.5-sign(0.5,bram-bral))
        adal(i+1) = adal(i+1)+adbraq*(0.5+sign(0.5,al(i+1)-q(i,j)-brao))
        adbras = adbraq*(0.5-sign(0.5,al(i+1)-q(i,j)-brao))
        adq(i,j) = adq(i,j)-adbraq*(0.5+sign(0.5,al(i+1)-q(i,j)-brao))
        adbrar = adbras*(0.5+sign(0.5,lac-bran))
        adlac = adlac+adbras*(0.5-sign(0.5,lac-bran))
        adpmp = adpmp+adbrar*(0.5-sign(0.5,pmp-0.))
        adbrao = adbrap*(0.5+sign(0.5,brak-lac))
        adlac = adlac+adbrap*(0.5-sign(0.5,brak-lac))
        adpmp = adpmp+adbrao*(0.5-sign(0.5,0.-pmp))
        adbr(i) = 0.
        addq(i-2) = addq(i-2)-1.5*adlac
        adpmp = adpmp+adlac
        adlac = 0.
        addq(i-1) = addq(i-1)+2*adpmp
        adpmp = 0.
        pmp = -(2.*dq(i))
        lac = pmp+1.5*dq(i+1)
        blak = max(0.,pmp)
        blal = max(blak,lac)
        blan = min(0.,pmp)
        blao = min(blan,lac)
        blam = max(al(i)-q(i,j),blao)
        adblap = adbl(i)*(0.5+sign(0.5,blam-blal))
        adblaq = adbl(i)*(0.5-sign(0.5,blam-blal))
        adal(i) = adal(i)+adblaq*(0.5+sign(0.5,al(i)-q(i,j)-blao))
        adblas = adblaq*(0.5-sign(0.5,al(i)-q(i,j)-blao))
        adq(i,j) = adq(i,j)-adblaq*(0.5+sign(0.5,al(i)-q(i,j)-blao))
        adblar = adblas*(0.5+sign(0.5,lac-blan))
        adlac = adlac+adblas*(0.5-sign(0.5,lac-blan))
        adpmp = adpmp+adblar*(0.5-sign(0.5,pmp-0.))
        adblao = adblap*(0.5+sign(0.5,blak-lac))
        adlac = adlac+adblap*(0.5-sign(0.5,blak-lac))
        adpmp = adpmp+adblao*(0.5-sign(0.5,0.-pmp))
        adbl(i) = 0.
        addq(i+1) = addq(i+1)+1.5*adlac
        adpmp = adpmp+adlac
        adlac = 0.
        addq(i) = addq(i)-2*adpmp
        adpmp = 0.
      end do
      do i = is3, min(npx-2,ie+2)
        addm1(i-1) = addm1(i-1)+adal(i)*r3
        addm1(i) = addm1(i)-adal(i)*r3
        adq(i-1,j) = adq(i-1,j)+0.5*adal(i)
        adq(i,j) = adq(i,j)+0.5*adal(i)
        adal(i) = 0.
      end do
      do i = is-2, ie+2
        adxt = 0.
        xt = 0.25*(q(i+1,j)-q(i-1,j))
        dm17 = abs(xt)
        dm1aa = max(q(i-1,j),q(i,j))
        dm1ae = max(dm1aa,q(i+1,j))-q(i,j)
        dm1af = min(q(i-1,j),q(i,j))
        dm1ah = q(i,j)-min(dm1af,q(i+1,j))
        dm1ai = min(dm17,dm1ae)
        addm1at = addm1(i)*sign(1.,min(dm1ai,dm1ah))*sign(1.,xt)
        addm1ar = addm1at*(0.5-sign(0.5,dm1ah-dm1ai))
        addm1as = addm1at*(0.5+sign(0.5,dm1ah-dm1ai))
        addm1af = addm1as*(0.5+sign(0.5,dm1ae-dm17))
        addm1ao = addm1as*(0.5-sign(0.5,dm1ae-dm17))
        addm1aq = -addm1ar
        adq(i,j) = adq(i,j)+addm1ar
        addm1ap = addm1aq*(0.5+sign(0.5,q(i+1,j)-dm1af))
        adq(i+1,j) = adq(i+1,j)+addm1aq*(0.5-sign(0.5,q(i+1,j)-dm1af))
        adq(i-1,j) = adq(i-1,j)+addm1ap*(0.5+sign(0.5,q(i,j)-q(i-1,j)))
        adq(i,j) = adq(i,j)+addm1ap*(0.5-sign(0.5,q(i,j)-q(i-1,j)))
        adq(i,j) = adq(i,j)-addm1ao
        addm1am = addm1ao*(0.5+sign(0.5,dm1aa-q(i+1,j)))
        adq(i+1,j) = adq(i+1,j)+addm1ao*(0.5-sign(0.5,dm1aa-q(i+1,j)))
        adq(i-1,j) = adq(i-1,j)+addm1am*(0.5+sign(0.5,q(i-1,j)-q(i,j)))
        adq(i,j) = adq(i,j)+addm1am*(0.5-sign(0.5,q(i-1,j)-q(i,j)))
        adxt = adxt+addm1af*sign(1.,xt)
        addm1(i) = 0.
        adq(i-1,j) = adq(i-1,j)-0.25*adxt
        adq(i+1,j) = adq(i+1,j)+0.25*adxt
        adxt = 0.
      end do
      do i = is-3, ie+2
        adq(i+1,j) = adq(i+1,j)+addq(i)
        adq(i,j) = adq(i,j)-addq(i)
        addq(i) = 0.
      end do
    else
      do i = ifirst-1, ilast+1
        adlac = 0.
        adpmp = 0.
        pmp = 2.*dq(i-1)
        lac = pmp-1.5*dq(i-2)
        braf = max(0.,pmp)
        brag = max(braf,lac)
        brai = min(0.,pmp)
        braj = min(brai,lac)
        brah = max(al(i+1)-q(i,j),braj)
        adbrak = adbr(i)*(0.5+sign(0.5,brah-brag))
        adbral = adbr(i)*(0.5-sign(0.5,brah-brag))
        adal(i+1) = adal(i+1)+adbral*(0.5+sign(0.5,al(i+1)-q(i,j)-braj))
        adbran = adbral*(0.5-sign(0.5,al(i+1)-q(i,j)-braj))
        adq(i,j) = adq(i,j)-adbral*(0.5+sign(0.5,al(i+1)-q(i,j)-braj))
        adbram = adbran*(0.5+sign(0.5,lac-brai))
        adlac = adlac+adbran*(0.5-sign(0.5,lac-brai))
        adpmp = adpmp+adbram*(0.5-sign(0.5,pmp-0.))
        adbraj = adbrak*(0.5+sign(0.5,braf-lac))
        adlac = adlac+adbrak*(0.5-sign(0.5,braf-lac))
        adpmp = adpmp+adbraj*(0.5-sign(0.5,0.-pmp))
        adbr(i) = 0.
        addq(i-2) = addq(i-2)-1.5*adlac
        adpmp = adpmp+adlac
        adlac = 0.
        addq(i-1) = addq(i-1)+2*adpmp
        adpmp = 0.
        pmp = -(2.*dq(i))
        lac = pmp+1.5*dq(i+1)
        blaf = max(0.,pmp)
        blag = max(blaf,lac)
        blai = min(0.,pmp)
        blaj = min(blai,lac)
        blah = max(al(i)-q(i,j),blaj)
        adblak = adbl(i)*(0.5+sign(0.5,blah-blag))
        adblal = adbl(i)*(0.5-sign(0.5,blah-blag))
        adal(i) = adal(i)+adblal*(0.5+sign(0.5,al(i)-q(i,j)-blaj))
        adblan = adblal*(0.5-sign(0.5,al(i)-q(i,j)-blaj))
        adq(i,j) = adq(i,j)-adblal*(0.5+sign(0.5,al(i)-q(i,j)-blaj))
        adblam = adblan*(0.5+sign(0.5,lac-blai))
        adlac = adlac+adblan*(0.5-sign(0.5,lac-blai))
        adpmp = adpmp+adblam*(0.5-sign(0.5,pmp-0.))
        adblaj = adblak*(0.5+sign(0.5,blaf-lac))
        adlac = adlac+adblak*(0.5-sign(0.5,blaf-lac))
        adpmp = adpmp+adblaj*(0.5-sign(0.5,0.-pmp))
        adbl(i) = 0.
        addq(i+1) = addq(i+1)+1.5*adlac
        adpmp = adpmp+adlac
        adlac = 0.
        addq(i) = addq(i)-2*adpmp
        adpmp = 0.
      end do
      do i = ifirst-3, ilast+2
        adq(i+1,j) = adq(i+1,j)+addq(i)
        adq(i,j) = adq(i,j)-addq(i)
        addq(i) = 0.
      end do
      do i = ifirst-1, ilast+2
        addm1(i-1) = addm1(i-1)+adal(i)*r3
        addm1(i) = addm1(i)-adal(i)*r3
        adq(i-1,j) = adq(i-1,j)+0.5*adal(i)
        adq(i,j) = adq(i,j)+0.5*adal(i)
        adal(i) = 0.
      end do
      do i = ifirst-2, ilast+2
        adxt = 0.
        xt = 0.25*(q(i+1,j)-q(i-1,j))
        dm11 = abs(xt)
        dm14 = max(q(i-1,j),q(i,j))
        dm18 = max(dm14,q(i+1,j))-q(i,j)
        dm19 = min(q(i-1,j),q(i,j))
        dm1ab = q(i,j)-min(dm19,q(i+1,j))
        dm1ac = min(dm11,dm18)
        addm1al = addm1(i)*sign(1.,min(dm1ac,dm1ab))*sign(1.,xt)
        addm1aj = addm1al*(0.5-sign(0.5,dm1ab-dm1ac))
        addm1ak = addm1al*(0.5+sign(0.5,dm1ab-dm1ac))
        addm17 = addm1ak*(0.5+sign(0.5,dm18-dm11))
        addm1ag = addm1ak*(0.5-sign(0.5,dm18-dm11))
        addm1ai = -addm1aj
        adq(i,j) = adq(i,j)+addm1aj
        addm1ah = addm1ai*(0.5+sign(0.5,q(i+1,j)-dm19))
        adq(i+1,j) = adq(i+1,j)+addm1ai*(0.5-sign(0.5,q(i+1,j)-dm19))
        adq(i-1,j) = adq(i-1,j)+addm1ah*(0.5+sign(0.5,q(i,j)-q(i-1,j)))
        adq(i,j) = adq(i,j)+addm1ah*(0.5-sign(0.5,q(i,j)-q(i-1,j)))
        adq(i,j) = adq(i,j)-addm1ag
        addm1ae = addm1ag*(0.5+sign(0.5,dm14-q(i+1,j)))
        adq(i+1,j) = adq(i+1,j)+addm1ag*(0.5-sign(0.5,dm14-q(i+1,j)))
        adq(i-1,j) = adq(i-1,j)+addm1ae*(0.5+sign(0.5,q(i-1,j)-q(i,j)))
        adq(i,j) = adq(i,j)+addm1ae*(0.5-sign(0.5,q(i-1,j)-q(i,j)))
        adxt = adxt+addm17*sign(1.,xt)
        addm1(i) = 0.
        adq(i-1,j) = adq(i-1,j)-0.25*adxt
        adq(i+1,j) = adq(i+1,j)+0.25*adxt
        adxt = 0.
      end do
    endif
  end do

!----------------------------------------------
! CLOSE TAPE tape_fxppm_1
!----------------------------------------------
  if (allocated(tape_fxppm_1_bl_1h)) then
    deallocate( tape_fxppm_1_bl_1h )
  endif
  if (allocated(tape_fxppm_1_br_2h)) then
    deallocate( tape_fxppm_1_br_2h )
  endif

else
!----------------------------------------------
! OPEN TAPE tape_fxppm_2
!----------------------------------------------
  tape_fxppm_2_fxppm = jlast-jfirst+1

!----------------------------------------------
! TAPE COMPUTATIONS
!----------------------------------------------
  do j = jfirst, jlast-1
    if ( .not. allocated(tape_fxppm_2_bl_1h)) then
      allocate( tape_fxppm_2_bl_1h(ifirst-1:ilast+1,tape_fxppm_2_fxppm) )
    endif
    tape_fxppm_2_bl_1h(:,j-jfirst+1) = bl
    if ( .not. allocated(tape_fxppm_2_br_2h)) then
      allocate( tape_fxppm_2_br_2h(ifirst-1:ilast+1,tape_fxppm_2_fxppm) )
    endif
    tape_fxppm_2_br_2h(:,j-jfirst+1) = br
    do i = is-2, ie+2
      xt = 0.25*(q(i+1,j)-q(i-1,j))
      dm1(i) = sign(min(abs(xt),max(q(i-1,j),q(i,j),q(i+1,j))-q(i,j),q(i,j)-min(q(i-1,j),q(i,j),q(i+1,j))),xt)
    end do
    if (grid_type .lt. 3) then
      is3 = max(3,is-1)
      ie3 = min(npx-3,ie+1)
      do i = is3, min(npx-2,ie+2)
        al(i) = 0.5*(q(i-1,j)+q(i,j))+r3*(dm1(i-1)-dm1(i))
      end do
      if (iord .eq. 11) then
        do i = is3, ie3
          xt = 2.*dm1(i)
          bl(i) = -sign(min(abs(xt),abs(al(i)-q(i,j))),xt)
          br(i) = sign(min(abs(xt),abs(al(i+1)-q(i,j))),xt)
        end do
      else if (iord .eq. 12) then
        do i = is-3, ie+2
          dq(i) = q(i+1,j)-q(i,j)
        end do
        do i = is3, ie3
          pmp = -(2.*dq(i))
          lac = pmp+1.5*dq(i+1)
          bl(i) = min(max(0.,pmp,lac),max(al(i)-q(i,j),min(0.,pmp,lac)))
          pmp = 2.*dq(i-1)
          lac = pmp-1.5*dq(i-2)
          br(i) = min(max(0.,pmp,lac),max(al(i+1)-q(i,j),min(0.,pmp,lac)))
        end do
      else
        do i = is3, ie3
          bl(i) = al(i)-q(i,j)
          br(i) = al(i+1)-q(i,j)
        end do
      endif
      if (iord .ne. 11) then
        help_h = ie3-is3+1
        call pert_ppm( help_h,q(is3:is3+ie3-is3,j),bl(is3:is3+ie3-is3),br(is3:is3+ie3-is3),0 )
      endif
      if (is .eq. 1) then
        br(2) = al(3)-q(2,j)
        xt = 0.5*((2.*dxa(1,j)+dxa(2,j))*(q(0,j)+q(1,j))-dxa(1,j)*(q(-1,j)+q(2,j)))/(dxa(1,j)+dxa(2,j))
        xt = max(0.,xt)
        bl(1) = xt-q(1,j)
        br(0) = xt-q(0,j)
        xt = 4./7.*dm1(-1)+11./14.*q(-1,j)+3./14.*q(0,j)
        xt = max(0.,xt)
        bl(0) = xt-q(0,j)
        xt = 3./14.*q(1,j)+11./14.*q(2,j)-4./7.*dm1(2)
        xt = max(0.,xt)
        br(1) = xt-q(1,j)
        bl(2) = xt-q(2,j)
        call pert_ppm( 3,q(0:2,j),bl(0:2),br(0:2),1 )
      endif
      if (ie+1 .eq. npx) then
        bl(npx-2) = al(npx-2)-q(npx-2,j)
        xt = 0.5*((2.*dxa(npx-1,j)+dxa(npx-2,j))*(q(npx-1,j)+q(npx,j))-dxa(npx-1,j)*(q(npx-2,j)+q(npx+1,j)))/(dxa(npx-1,j)+dxa(npx-&
&2,j))
        xt = max(0.,xt)
        br(npx-1) = xt-q(npx-1,j)
        bl(npx) = xt-q(npx,j)
        xt = 11./14.*q(npx+1,j)+3./14.*q(npx,j)-4./7.*dm1(npx+1)
        xt = max(0.,xt)
        br(npx) = xt-q(npx,j)
        xt = 3./14.*q(npx-1,j)+11./14.*q(npx-2,j)+4./7.*dm1(npx-2)
        xt = max(0.,xt)
        br(npx-2) = xt-q(npx-2,j)
        bl(npx-1) = xt-q(npx-1,j)
        call pert_ppm( 3,q(npx-2:npx,j),bl(npx-2:npx),br(npx-2:npx),1 )
      endif
    else
      do i = ifirst-1, ilast+2
        al(i) = 0.5*(q(i-1,j)+q(i,j))+r3*(dm1(i-1)-dm1(i))
      end do
      if (iord .eq. 11) then
        do i = ifirst-1, ilast+1
          xt = 2.*dm1(i)
          bl(i) = -sign(min(abs(xt),abs(al(i)-q(i,j))),xt)
          br(i) = sign(min(abs(xt),abs(al(i+1)-q(i,j))),xt)
        end do
      else if (iord .eq. 12) then
        do i = ifirst-3, ilast+2
          dq(i) = q(i+1,j)-q(i,j)
        end do
        do i = ifirst-1, ilast+1
          pmp = -(2.*dq(i))
          lac = pmp+1.5*dq(i+1)
          bl(i) = min(max(0.,pmp,lac),max(al(i)-q(i,j),min(0.,pmp,lac)))
          pmp = 2.*dq(i-1)
          lac = pmp-1.5*dq(i-2)
          br(i) = min(max(0.,pmp,lac),max(al(i+1)-q(i,j),min(0.,pmp,lac)))
        end do
      else
        do i = is-1, ie+1
          bl(i) = al(i)-q(i,j)
          br(i) = al(i+1)-q(i,j)
        end do
      endif
      if (iord .ne. 11) then
        help_i = ie-is+3
        call pert_ppm( help_i,q(is-1:ie+1,j),bl(is-1:ie+1),br(is-1:ie+1),0 )
      endif
    endif
  end do
  j = jlast
  if ( .not. allocated(tape_fxppm_2_bl_1h)) then
    allocate( tape_fxppm_2_bl_1h(ifirst-1:ilast+1,tape_fxppm_2_fxppm) )
  endif
  tape_fxppm_2_bl_1h(:,j-jfirst+1) = bl
  if ( .not. allocated(tape_fxppm_2_br_2h)) then
    allocate( tape_fxppm_2_br_2h(ifirst-1:ilast+1,tape_fxppm_2_fxppm) )
  endif
  tape_fxppm_2_br_2h(:,j-jfirst+1) = br

!----------------------------------------------
! ADJOINT COMPUTATIONS
!----------------------------------------------
  do j = jlast, jfirst, -1
    do i = is-2, ie+2
      xt = 0.25*(q(i+1,j)-q(i-1,j))
      dm1(i) = sign(min(abs(xt),max(q(i-1,j),q(i,j),q(i+1,j))-q(i,j),q(i,j)-min(q(i-1,j),q(i,j),q(i+1,j))),xt)
    end do
    if (grid_type .lt. 3) then
      is3 = max(3,is-1)
      ie3 = min(npx-3,ie+1)
      do i = is3, min(npx-2,ie+2)
        al(i) = 0.5*(q(i-1,j)+q(i,j))+r3*(dm1(i-1)-dm1(i))
      end do
      if (iord .eq. 11) then
        do i = is3, ie3
          xt = 2.*dm1(i)
          bl(i) = -sign(min(abs(xt),abs(al(i)-q(i,j))),xt)
          br(i) = sign(min(abs(xt),abs(al(i+1)-q(i,j))),xt)
        end do
      else if (iord .eq. 12) then
        do i = is-3, ie+2
          dq(i) = q(i+1,j)-q(i,j)
        end do
        do i = is3, ie3
          pmp = -(2.*dq(i))
          lac = pmp+1.5*dq(i+1)
          bl(i) = min(max(0.,pmp,lac),max(al(i)-q(i,j),min(0.,pmp,lac)))
          pmp = 2.*dq(i-1)
          lac = pmp-1.5*dq(i-2)
          br(i) = min(max(0.,pmp,lac),max(al(i+1)-q(i,j),min(0.,pmp,lac)))
        end do
      else
        do i = is3, ie3
          bl(i) = al(i)-q(i,j)
          br(i) = al(i+1)-q(i,j)
        end do
      endif
      if (iord .ne. 11) then
        help_h = ie3-is3+1
        call pert_ppm( help_h,q(is3:is3+ie3-is3,j),bl(is3:is3+ie3-is3),br(is3:is3+ie3-is3),0 )
      endif
      if (is .eq. 1) then
        br(2) = al(3)-q(2,j)
        xt = 0.5*((2.*dxa(1,j)+dxa(2,j))*(q(0,j)+q(1,j))-dxa(1,j)*(q(-1,j)+q(2,j)))/(dxa(1,j)+dxa(2,j))
        xt = max(0.,xt)
        bl(1) = xt-q(1,j)
        br(0) = xt-q(0,j)
        xt = 4./7.*dm1(-1)+11./14.*q(-1,j)+3./14.*q(0,j)
        xt = max(0.,xt)
        bl(0) = xt-q(0,j)
        xt = 3./14.*q(1,j)+11./14.*q(2,j)-4./7.*dm1(2)
        xt = max(0.,xt)
        br(1) = xt-q(1,j)
        bl(2) = xt-q(2,j)
        call pert_ppm( 3,q(0:2,j),bl(0:2),br(0:2),1 )
      endif
      if (ie+1 .eq. npx) then
        bl(npx-2) = al(npx-2)-q(npx-2,j)
        xt = 0.5*((2.*dxa(npx-1,j)+dxa(npx-2,j))*(q(npx-1,j)+q(npx,j))-dxa(npx-1,j)*(q(npx-2,j)+q(npx+1,j)))/(dxa(npx-1,j)+dxa(npx-&
&2,j))
        xt = max(0.,xt)
        br(npx-1) = xt-q(npx-1,j)
        bl(npx) = xt-q(npx,j)
        xt = 11./14.*q(npx+1,j)+3./14.*q(npx,j)-4./7.*dm1(npx+1)
        xt = max(0.,xt)
        br(npx) = xt-q(npx,j)
        xt = 3./14.*q(npx-1,j)+11./14.*q(npx-2,j)+4./7.*dm1(npx-2)
        xt = max(0.,xt)
        br(npx-2) = xt-q(npx-2,j)
        bl(npx-1) = xt-q(npx-1,j)
        call pert_ppm( 3,q(npx-2:npx,j),bl(npx-2:npx),br(npx-2:npx),1 )
      endif
    else
      do i = ifirst-1, ilast+2
        al(i) = 0.5*(q(i-1,j)+q(i,j))+r3*(dm1(i-1)-dm1(i))
      end do
      if (iord .eq. 11) then
        do i = ifirst-1, ilast+1
          xt = 2.*dm1(i)
          bl(i) = -sign(min(abs(xt),abs(al(i)-q(i,j))),xt)
          br(i) = sign(min(abs(xt),abs(al(i+1)-q(i,j))),xt)
        end do
      else if (iord .eq. 12) then
        do i = ifirst-3, ilast+2
          dq(i) = q(i+1,j)-q(i,j)
        end do
        do i = ifirst-1, ilast+1
          pmp = -(2.*dq(i))
          lac = pmp+1.5*dq(i+1)
          bl(i) = min(max(0.,pmp,lac),max(al(i)-q(i,j),min(0.,pmp,lac)))
          pmp = 2.*dq(i-1)
          lac = pmp-1.5*dq(i-2)
          br(i) = min(max(0.,pmp,lac),max(al(i+1)-q(i,j),min(0.,pmp,lac)))
        end do
      else
        do i = is-1, ie+1
          bl(i) = al(i)-q(i,j)
          br(i) = al(i+1)-q(i,j)
        end do
      endif
      if (iord .ne. 11) then
        help_i = ie-is+3
        call pert_ppm( help_i,q(is-1:ie+1,j),bl(is-1:ie+1),br(is-1:ie+1),0 )
      endif
    endif
    do i = ifirst, ilast+1
      if (c(i,j) .gt. 0.) then
        adbl(i-1) = adbl(i-1)-adflux(i,j)*(1.-c(i,j))*c(i,j)
        adbr(i-1) = adbr(i-1)+adflux(i,j)*(1.-c(i,j))*(1-c(i,j))
        adc(i,j) = adc(i,j)+adflux(i,j)*((-((1.-c(i,j))*(bl(i-1)+br(i-1))))-(br(i-1)-c(i,j)*(bl(i-1)+br(i-1))))
        adq(i-1,j) = adq(i-1,j)+adflux(i,j)
        adflux(i,j) = 0.
      else
        adbl(i) = adbl(i)+adflux(i,j)*(1.+c(i,j))*(1+c(i,j))
        adbr(i) = adbr(i)+adflux(i,j)*(1.+c(i,j))*c(i,j)
        adc(i,j) = adc(i,j)+adflux(i,j)*((1.+c(i,j))*(bl(i)+br(i))+bl(i)+c(i,j)*(bl(i)+br(i)))
        adq(i,j) = adq(i,j)+adflux(i,j)
        adflux(i,j) = 0.
      endif
    end do
    bl = tape_fxppm_2_bl_1h(:,j-jfirst+1)
    br = tape_fxppm_2_br_2h(:,j-jfirst+1)
    if (grid_type .lt. 3) then
      if (iord .eq. 11) then
        do i = is3, ie3
          xt = 2.*dm1(i)
          bl(i) = -sign(min(abs(xt),abs(al(i)-q(i,j))),xt)
          br(i) = sign(min(abs(xt),abs(al(i+1)-q(i,j))),xt)
        end do
      else if (iord .eq. 12) then
        do i = is3, ie3
          pmp = -(2.*dq(i))
          lac = pmp+1.5*dq(i+1)
          bl(i) = min(max(0.,pmp,lac),max(al(i)-q(i,j),min(0.,pmp,lac)))
          pmp = 2.*dq(i-1)
          lac = pmp-1.5*dq(i-2)
          br(i) = min(max(0.,pmp,lac),max(al(i+1)-q(i,j),min(0.,pmp,lac)))
        end do
      else
        do i = is3, ie3
          bl(i) = al(i)-q(i,j)
          br(i) = al(i+1)-q(i,j)
        end do
      endif
      if (iord .ne. 11) then
        call pert_ppm( help_h,q(is3:is3+ie3-is3,j),bl(is3:is3+ie3-is3),br(is3:is3+ie3-is3),0 )
      endif
      if (is .eq. 1) then
        br(2) = al(3)-q(2,j)
        xt = 0.5*((2.*dxa(1,j)+dxa(2,j))*(q(0,j)+q(1,j))-dxa(1,j)*(q(-1,j)+q(2,j)))/(dxa(1,j)+dxa(2,j))
        xt = max(0.,xt)
        bl(1) = xt-q(1,j)
        br(0) = xt-q(0,j)
        xt = 4./7.*dm1(-1)+11./14.*q(-1,j)+3./14.*q(0,j)
        xt = max(0.,xt)
        bl(0) = xt-q(0,j)
        xt = 3./14.*q(1,j)+11./14.*q(2,j)-4./7.*dm1(2)
        xt = max(0.,xt)
        br(1) = xt-q(1,j)
        bl(2) = xt-q(2,j)
        call pert_ppm( 3,q(0:2,j),bl(0:2),br(0:2),1 )
      endif
      if (ie+1 .eq. npx) then
        xtj = xt
        xtk = xt
        bl(npx-2) = al(npx-2)-q(npx-2,j)
        xt = 0.5*((2.*dxa(npx-1,j)+dxa(npx-2,j))*(q(npx-1,j)+q(npx,j))-dxa(npx-1,j)*(q(npx-2,j)+q(npx+1,j)))/(dxa(npx-1,j)+dxa(npx-&
&2,j))
        xt = max(0.,xt)
        br(npx-1) = xt-q(npx-1,j)
        bl(npx) = xt-q(npx,j)
        xt = xtk
        xt = 11./14.*q(npx+1,j)+3./14.*q(npx,j)-4./7.*dm1(npx+1)
        xt = max(0.,xt)
        br(npx) = xt-q(npx,j)
        xt = xtj
        br(npx-2) = xt-q(npx-2,j)
        bl(npx-1) = xt-q(npx-1,j)
        call adpert_ppm( 3,q(npx-2:npx,j),adq(npx-2:npx,j),bl(npx-2:npx),adbl(npx-2:npx),br(npx-2:npx),adbr(npx-2:npx),1 )
        adq(npx-1,j) = adq(npx-1,j)-adbl(npx-1)
        adxt = adxt+adbl(npx-1)
        adbl(npx-1) = 0.
        adq(npx-2,j) = adq(npx-2,j)-adbr(npx-2)
        adxt = adxt+adbr(npx-2)
        adbr(npx-2) = 0.
        xt = 3./14.*q(npx-1,j)+11./14.*q(npx-2,j)+4./7.*dm1(npx-2)
        adxt = adxt*(0.5-sign(0.5,0.-xt))
        addm1(npx-2) = addm1(npx-2)+0.57142857*adxt
        adq(npx-2,j) = adq(npx-2,j)+0.78571429*adxt
        adq(npx-1,j) = adq(npx-1,j)+0.21428571*adxt
        adxt = 0.
        adq(npx,j) = adq(npx,j)-adbr(npx)
        adxt = adxt+adbr(npx)
        adbr(npx) = 0.
        xt = 11./14.*q(npx+1,j)+3./14.*q(npx,j)-4./7.*dm1(npx+1)
        adxt = adxt*(0.5-sign(0.5,0.-xt))
        addm1(npx+1) = addm1(npx+1)-0.57142857*adxt
        adq(npx+1,j) = adq(npx+1,j)+0.78571429*adxt
        adq(npx,j) = adq(npx,j)+0.21428571*adxt
        adxt = 0.
        adq(npx,j) = adq(npx,j)-adbl(npx)
        adxt = adxt+adbl(npx)
        adbl(npx) = 0.
        adq(npx-1,j) = adq(npx-1,j)-adbr(npx-1)
        adxt = adxt+adbr(npx-1)
        adbr(npx-1) = 0.
        xt = 0.5*((2.*dxa(npx-1,j)+dxa(npx-2,j))*(q(npx-1,j)+q(npx,j))-dxa(npx-1,j)*(q(npx-2,j)+q(npx+1,j)))/(dxa(npx-1,j)+dxa(npx-&
&2,j))
        adxt = adxt*(0.5-sign(0.5,0.-xt))
        adq(npx-2,j) = adq(npx-2,j)-adxt*(0.5*dxa(npx-1,j)/(dxa(npx-1,j)+dxa(npx-2,j)))
        adq(npx-1,j) = adq(npx-1,j)+adxt*(0.5*(2.*dxa(npx-1,j)+dxa(npx-2,j))/(dxa(npx-1,j)+dxa(npx-2,j)))
        adq(npx+1,j) = adq(npx+1,j)-adxt*(0.5*dxa(npx-1,j)/(dxa(npx-1,j)+dxa(npx-2,j)))
        adq(npx,j) = adq(npx,j)+adxt*(0.5*(2.*dxa(npx-1,j)+dxa(npx-2,j))/(dxa(npx-1,j)+dxa(npx-2,j)))
        adxt = 0.
        adal(npx-2) = adal(npx-2)+adbl(npx-2)
        adq(npx-2,j) = adq(npx-2,j)-adbl(npx-2)
        adbl(npx-2) = 0.
      endif
      if (iord .eq. 11) then
        do i = is3, ie3
          xt = 2.*dm1(i)
          bl(i) = -sign(min(abs(xt),abs(al(i)-q(i,j))),xt)
          br(i) = sign(min(abs(xt),abs(al(i+1)-q(i,j))),xt)
        end do
      else if (iord .eq. 12) then
        do i = is3, ie3
          pmp = -(2.*dq(i))
          lac = pmp+1.5*dq(i+1)
          bl(i) = min(max(0.,pmp,lac),max(al(i)-q(i,j),min(0.,pmp,lac)))
          pmp = 2.*dq(i-1)
          lac = pmp-1.5*dq(i-2)
          br(i) = min(max(0.,pmp,lac),max(al(i+1)-q(i,j),min(0.,pmp,lac)))
        end do
      else
        do i = is3, ie3
          bl(i) = al(i)-q(i,j)
          br(i) = al(i+1)-q(i,j)
        end do
      endif
      if (iord .ne. 11) then
        call pert_ppm( help_h,q(is3:is3+ie3-is3,j),bl(is3:is3+ie3-is3),br(is3:is3+ie3-is3),0 )
      endif
      if (is .eq. 1) then
        br(2) = al(3)-q(2,j)
        xt = 0.5*((2.*dxa(1,j)+dxa(2,j))*(q(0,j)+q(1,j))-dxa(1,j)*(q(-1,j)+q(2,j)))/(dxa(1,j)+dxa(2,j))
        xt = max(0.,xt)
        bl(1) = xt-q(1,j)
        br(0) = xt-q(0,j)
        xt = 4./7.*dm1(-1)+11./14.*q(-1,j)+3./14.*q(0,j)
        xt = max(0.,xt)
        bl(0) = xt-q(0,j)
        xt = 3./14.*q(1,j)+11./14.*q(2,j)-4./7.*dm1(2)
        xt = max(0.,xt)
        br(1) = xt-q(1,j)
        bl(2) = xt-q(2,j)
        call adpert_ppm( 3,q(0:2,j),adq(0:2,j),bl(0:2),adbl(0:2),br(0:2),adbr(0:2),1 )
        adq(2,j) = adq(2,j)-adbl(2)
        adxt = adxt+adbl(2)
        adbl(2) = 0.
        adq(1,j) = adq(1,j)-adbr(1)
        adxt = adxt+adbr(1)
        adbr(1) = 0.
        xt = 3./14.*q(1,j)+11./14.*q(2,j)-4./7.*dm1(2)
        adxt = adxt*(0.5-sign(0.5,0.-xt))
        addm1(2) = addm1(2)-0.57142857*adxt
        adq(2,j) = adq(2,j)+0.78571429*adxt
        adq(1,j) = adq(1,j)+0.21428571*adxt
        adxt = 0.
        adq(0,j) = adq(0,j)-adbl(0)
        adxt = adxt+adbl(0)
        adbl(0) = 0.
        xt = 4./7.*dm1(-1)+11./14.*q(-1,j)+3./14.*q(0,j)
        adxt = adxt*(0.5-sign(0.5,0.-xt))
        addm1(-1) = addm1(-1)+0.57142857*adxt
        adq(-1,j) = adq(-1,j)+0.78571429*adxt
        adq(0,j) = adq(0,j)+0.21428571*adxt
        adxt = 0.
        adq(0,j) = adq(0,j)-adbr(0)
        adxt = adxt+adbr(0)
        adbr(0) = 0.
        adq(1,j) = adq(1,j)-adbl(1)
        adxt = adxt+adbl(1)
        adbl(1) = 0.
        xt = 0.5*((2.*dxa(1,j)+dxa(2,j))*(q(0,j)+q(1,j))-dxa(1,j)*(q(-1,j)+q(2,j)))/(dxa(1,j)+dxa(2,j))
        adxt = adxt*(0.5-sign(0.5,0.-xt))
        adq(-1,j) = adq(-1,j)-adxt*(0.5*dxa(1,j)/(dxa(1,j)+dxa(2,j)))
        adq(2,j) = adq(2,j)-adxt*(0.5*dxa(1,j)/(dxa(1,j)+dxa(2,j)))
        adq(1,j) = adq(1,j)+adxt*(0.5*(2.*dxa(1,j)+dxa(2,j))/(dxa(1,j)+dxa(2,j)))
        adq(0,j) = adq(0,j)+adxt*(0.5*(2.*dxa(1,j)+dxa(2,j))/(dxa(1,j)+dxa(2,j)))
        adxt = 0.
        adal(3) = adal(3)+adbr(2)
        adq(2,j) = adq(2,j)-adbr(2)
        adbr(2) = 0.
      endif
      if (iord .eq. 11) then
        do i = is3, ie3
          xt = 2.*dm1(i)
          bl(i) = -sign(min(abs(xt),abs(al(i)-q(i,j))),xt)
          br(i) = sign(min(abs(xt),abs(al(i+1)-q(i,j))),xt)
        end do
      else if (iord .eq. 12) then
        do i = is3, ie3
          pmp = -(2.*dq(i))
          lac = pmp+1.5*dq(i+1)
          bl(i) = min(max(0.,pmp,lac),max(al(i)-q(i,j),min(0.,pmp,lac)))
          pmp = 2.*dq(i-1)
          lac = pmp-1.5*dq(i-2)
          br(i) = min(max(0.,pmp,lac),max(al(i+1)-q(i,j),min(0.,pmp,lac)))
        end do
      else
        do i = is3, ie3
          bl(i) = al(i)-q(i,j)
          br(i) = al(i+1)-q(i,j)
        end do
      endif
      if (iord .ne. 11) then
        call adpert_ppm( help_h,q(is3:is3+ie3-is3,j),adq(is3:is3+ie3-is3,j),bl(is3:is3+ie3-is3),adbl(is3:is3+ie3-is3),br(is3:is3+&
&ie3-is3),adbr(is3:is3+ie3-is3),0 )
      endif
      if (iord .eq. 11) then
        do i = is3, ie3
          adxt = 0.
          xt = 2.*dm1(i)
          br5 = al(i+1)-q(i,j)
          adbr7 = adbr(i)*sign(1.,min(abs(xt),abs(br5)))*sign(1.,xt)
          adbr8 = adbr7*(0.5-sign(0.5,abs(br5)-abs(xt)))*sign(1.,br5)
          adxt = adxt+adbr7*(0.5+sign(0.5,abs(br5)-abs(xt)))*sign(1.,xt)
          adal(i+1) = adal(i+1)+adbr8
          adq(i,j) = adq(i,j)-adbr8
          adbr(i) = 0.
          bl5 = al(i)-q(i,j)
          adbl7 = -(adbl(i)*sign(1.,min(abs(xt),abs(bl5)))*sign(1.,xt))
          adbl8 = adbl7*(0.5-sign(0.5,abs(bl5)-abs(xt)))*sign(1.,bl5)
          adxt = adxt+adbl7*(0.5+sign(0.5,abs(bl5)-abs(xt)))*sign(1.,xt)
          adal(i) = adal(i)+adbl8
          adq(i,j) = adq(i,j)-adbl8
          adbl(i) = 0.
          addm1(i) = addm1(i)+2*adxt
          adxt = 0.
        end do
      else if (iord .eq. 12) then
        do i = is3, ie3
          adlac = 0.
          adpmp = 0.
          pmp = 2.*dq(i-1)
          lac = pmp-1.5*dq(i-2)
          bry = max(0.,pmp)
          br0 = max(bry,lac)
          br2 = min(0.,pmp)
          br3 = min(br2,lac)
          br1 = max(al(i+1)-q(i,j),br3)
          adbr3 = adbr(i)*(0.5+sign(0.5,br1-br0))
          adbr4 = adbr(i)*(0.5-sign(0.5,br1-br0))
          adal(i+1) = adal(i+1)+adbr4*(0.5+sign(0.5,al(i+1)-q(i,j)-br3))
          adbr6 = adbr4*(0.5-sign(0.5,al(i+1)-q(i,j)-br3))
          adq(i,j) = adq(i,j)-adbr4*(0.5+sign(0.5,al(i+1)-q(i,j)-br3))
          adbr5 = adbr6*(0.5+sign(0.5,lac-br2))
          adlac = adlac+adbr6*(0.5-sign(0.5,lac-br2))
          adpmp = adpmp+adbr5*(0.5-sign(0.5,pmp-0.))
          adbr2 = adbr3*(0.5+sign(0.5,bry-lac))
          adlac = adlac+adbr3*(0.5-sign(0.5,bry-lac))
          adpmp = adpmp+adbr2*(0.5-sign(0.5,0.-pmp))
          adbr(i) = 0.
          addq(i-2) = addq(i-2)-1.5*adlac
          adpmp = adpmp+adlac
          adlac = 0.
          addq(i-1) = addq(i-1)+2*adpmp
          adpmp = 0.
          pmp = -(2.*dq(i))
          lac = pmp+1.5*dq(i+1)
          bly = max(0.,pmp)
          bl0 = max(bly,lac)
          bl2 = min(0.,pmp)
          bl3 = min(bl2,lac)
          bl1 = max(al(i)-q(i,j),bl3)
          adbl3 = adbl(i)*(0.5+sign(0.5,bl1-bl0))
          adbl4 = adbl(i)*(0.5-sign(0.5,bl1-bl0))
          adal(i) = adal(i)+adbl4*(0.5+sign(0.5,al(i)-q(i,j)-bl3))
          adbl6 = adbl4*(0.5-sign(0.5,al(i)-q(i,j)-bl3))
          adq(i,j) = adq(i,j)-adbl4*(0.5+sign(0.5,al(i)-q(i,j)-bl3))
          adbl5 = adbl6*(0.5+sign(0.5,lac-bl2))
          adlac = adlac+adbl6*(0.5-sign(0.5,lac-bl2))
          adpmp = adpmp+adbl5*(0.5-sign(0.5,pmp-0.))
          adbl2 = adbl3*(0.5+sign(0.5,bly-lac))
          adlac = adlac+adbl3*(0.5-sign(0.5,bly-lac))
          adpmp = adpmp+adbl2*(0.5-sign(0.5,0.-pmp))
          adbl(i) = 0.
          addq(i+1) = addq(i+1)+1.5*adlac
          adpmp = adpmp+adlac
          adlac = 0.
          addq(i) = addq(i)-2*adpmp
          adpmp = 0.
        end do
        do i = is-3, ie+2
          adq(i+1,j) = adq(i+1,j)+addq(i)
          adq(i,j) = adq(i,j)-addq(i)
          addq(i) = 0.
        end do
      else
        do i = is3, ie3
          adal(i+1) = adal(i+1)+adbr(i)
          adq(i,j) = adq(i,j)-adbr(i)
          adbr(i) = 0.
          adal(i) = adal(i)+adbl(i)
          adq(i,j) = adq(i,j)-adbl(i)
          adbl(i) = 0.
        end do
      endif
      do i = is3, min(npx-2,ie+2)
        addm1(i-1) = addm1(i-1)+adal(i)*r3
        addm1(i) = addm1(i)-adal(i)*r3
        adq(i-1,j) = adq(i-1,j)+0.5*adal(i)
        adq(i,j) = adq(i,j)+0.5*adal(i)
        adal(i) = 0.
      end do
    else
      if (iord .eq. 11) then
        do i = ifirst-1, ilast+1
          xt = 2.*dm1(i)
          bl(i) = -sign(min(abs(xt),abs(al(i)-q(i,j))),xt)
          br(i) = sign(min(abs(xt),abs(al(i+1)-q(i,j))),xt)
        end do
      else if (iord .eq. 12) then
        do i = ifirst-1, ilast+1
          pmp = -(2.*dq(i))
          lac = pmp+1.5*dq(i+1)
          bl(i) = min(max(0.,pmp,lac),max(al(i)-q(i,j),min(0.,pmp,lac)))
          pmp = 2.*dq(i-1)
          lac = pmp-1.5*dq(i-2)
          br(i) = min(max(0.,pmp,lac),max(al(i+1)-q(i,j),min(0.,pmp,lac)))
        end do
      else
        do i = is-1, ie+1
          bl(i) = al(i)-q(i,j)
          br(i) = al(i+1)-q(i,j)
        end do
      endif
      if (iord .ne. 11) then
        call adpert_ppm( help_i,q(is-1:ie+1,j),adq(is-1:ie+1,j),bl(is-1:ie+1),adbl(is-1:ie+1),br(is-1:ie+1),adbr(is-1:ie+1),0 )
      endif
      if (iord .eq. 11) then
        do i = ifirst-1, ilast+1
          adxt = 0.
          xt = 2.*dm1(i)
          brz = al(i+1)-q(i,j)
          adbr0 = adbr(i)*sign(1.,min(abs(xt),abs(brz)))*sign(1.,xt)
          adbr1 = adbr0*(0.5-sign(0.5,abs(brz)-abs(xt)))*sign(1.,brz)
          adxt = adxt+adbr0*(0.5+sign(0.5,abs(brz)-abs(xt)))*sign(1.,xt)
          adal(i+1) = adal(i+1)+adbr1
          adq(i,j) = adq(i,j)-adbr1
          adbr(i) = 0.
          blz = al(i)-q(i,j)
          adbl0 = -(adbl(i)*sign(1.,min(abs(xt),abs(blz)))*sign(1.,xt))
          adbl1 = adbl0*(0.5-sign(0.5,abs(blz)-abs(xt)))*sign(1.,blz)
          adxt = adxt+adbl0*(0.5+sign(0.5,abs(blz)-abs(xt)))*sign(1.,xt)
          adal(i) = adal(i)+adbl1
          adq(i,j) = adq(i,j)-adbl1
          adbl(i) = 0.
          addm1(i) = addm1(i)+2*adxt
          adxt = 0.
        end do
      else if (iord .eq. 12) then
        do i = ifirst-1, ilast+1
          adlac = 0.
          adpmp = 0.
          pmp = 2.*dq(i-1)
          lac = pmp-1.5*dq(i-2)
          brs = max(0.,pmp)
          bru = max(brs,lac)
          brw = min(0.,pmp)
          brx = min(brw,lac)
          brv = max(al(i+1)-q(i,j),brx)
          adbrw = adbr(i)*(0.5+sign(0.5,brv-bru))
          adbrx = adbr(i)*(0.5-sign(0.5,brv-bru))
          adal(i+1) = adal(i+1)+adbrx*(0.5+sign(0.5,al(i+1)-q(i,j)-brx))
          adbrz = adbrx*(0.5-sign(0.5,al(i+1)-q(i,j)-brx))
          adq(i,j) = adq(i,j)-adbrx*(0.5+sign(0.5,al(i+1)-q(i,j)-brx))
          adbry = adbrz*(0.5+sign(0.5,lac-brw))
          adlac = adlac+adbrz*(0.5-sign(0.5,lac-brw))
          adpmp = adpmp+adbry*(0.5-sign(0.5,pmp-0.))
          adbrv = adbrw*(0.5+sign(0.5,brs-lac))
          adlac = adlac+adbrw*(0.5-sign(0.5,brs-lac))
          adpmp = adpmp+adbrv*(0.5-sign(0.5,0.-pmp))
          adbr(i) = 0.
          addq(i-2) = addq(i-2)-1.5*adlac
          adpmp = adpmp+adlac
          adlac = 0.
          addq(i-1) = addq(i-1)+2*adpmp
          adpmp = 0.
          pmp = -(2.*dq(i))
          lac = pmp+1.5*dq(i+1)
          bls = max(0.,pmp)
          blu = max(bls,lac)
          blw = min(0.,pmp)
          blx = min(blw,lac)
          blv = max(al(i)-q(i,j),blx)
          adblw = adbl(i)*(0.5+sign(0.5,blv-blu))
          adblx = adbl(i)*(0.5-sign(0.5,blv-blu))
          adal(i) = adal(i)+adblx*(0.5+sign(0.5,al(i)-q(i,j)-blx))
          adblz = adblx*(0.5-sign(0.5,al(i)-q(i,j)-blx))
          adq(i,j) = adq(i,j)-adblx*(0.5+sign(0.5,al(i)-q(i,j)-blx))
          adbly = adblz*(0.5+sign(0.5,lac-blw))
          adlac = adlac+adblz*(0.5-sign(0.5,lac-blw))
          adpmp = adpmp+adbly*(0.5-sign(0.5,pmp-0.))
          adblv = adblw*(0.5+sign(0.5,bls-lac))
          adlac = adlac+adblw*(0.5-sign(0.5,bls-lac))
          adpmp = adpmp+adblv*(0.5-sign(0.5,0.-pmp))
          adbl(i) = 0.
          addq(i+1) = addq(i+1)+1.5*adlac
          adpmp = adpmp+adlac
          adlac = 0.
          addq(i) = addq(i)-2*adpmp
          adpmp = 0.
        end do
        do i = ifirst-3, ilast+2
          adq(i+1,j) = adq(i+1,j)+addq(i)
          adq(i,j) = adq(i,j)-addq(i)
          addq(i) = 0.
        end do
      else
        do i = is-1, ie+1
          adal(i+1) = adal(i+1)+adbr(i)
          adq(i,j) = adq(i,j)-adbr(i)
          adbr(i) = 0.
          adal(i) = adal(i)+adbl(i)
          adq(i,j) = adq(i,j)-adbl(i)
          adbl(i) = 0.
        end do
      endif
      do i = ifirst-1, ilast+2
        addm1(i-1) = addm1(i-1)+adal(i)*r3
        addm1(i) = addm1(i)-adal(i)*r3
        adq(i-1,j) = adq(i-1,j)+0.5*adal(i)
        adq(i,j) = adq(i,j)+0.5*adal(i)
        adal(i) = 0.
      end do
    endif
    do i = is-2, ie+2
      adxt = 0.
      xt = 0.25*(q(i+1,j)-q(i-1,j))
      dm1j = abs(xt)
      dm1m = max(q(i-1,j),q(i,j))
      dm1q = max(dm1m,q(i+1,j))-q(i,j)
      dm1r = min(q(i-1,j),q(i,j))
      dm1t = q(i,j)-min(dm1r,q(i+1,j))
      dm1u = min(dm1j,dm1q)
      addm1x = addm1(i)*sign(1.,min(dm1u,dm1t))*sign(1.,xt)
      addm1v = addm1x*(0.5-sign(0.5,dm1t-dm1u))
      addm1w = addm1x*(0.5+sign(0.5,dm1t-dm1u))
      addm1j = addm1w*(0.5+sign(0.5,dm1q-dm1j))
      addm1s = addm1w*(0.5-sign(0.5,dm1q-dm1j))
      addm1u = -addm1v
      adq(i,j) = adq(i,j)+addm1v
      addm1t = addm1u*(0.5+sign(0.5,q(i+1,j)-dm1r))
      adq(i+1,j) = adq(i+1,j)+addm1u*(0.5-sign(0.5,q(i+1,j)-dm1r))
      adq(i-1,j) = adq(i-1,j)+addm1t*(0.5+sign(0.5,q(i,j)-q(i-1,j)))
      adq(i,j) = adq(i,j)+addm1t*(0.5-sign(0.5,q(i,j)-q(i-1,j)))
      adq(i,j) = adq(i,j)-addm1s
      addm1q = addm1s*(0.5+sign(0.5,dm1m-q(i+1,j)))
      adq(i+1,j) = adq(i+1,j)+addm1s*(0.5-sign(0.5,dm1m-q(i+1,j)))
      adq(i-1,j) = adq(i-1,j)+addm1q*(0.5+sign(0.5,q(i-1,j)-q(i,j)))
      adq(i,j) = adq(i,j)+addm1q*(0.5-sign(0.5,q(i-1,j)-q(i,j)))
      adxt = adxt+addm1j*sign(1.,xt)
      addm1(i) = 0.
      adq(i-1,j) = adq(i-1,j)-0.25*adxt
      adq(i+1,j) = adq(i+1,j)+0.25*adxt
      adxt = 0.
    end do
  end do

!----------------------------------------------
! CLOSE TAPE tape_fxppm_2
!----------------------------------------------
  if (allocated(tape_fxppm_2_bl_1h)) then
    deallocate( tape_fxppm_2_bl_1h )
  endif
  if (allocated(tape_fxppm_2_br_2h)) then
    deallocate( tape_fxppm_2_br_2h )
  endif

endif

end subroutine adfxppm


subroutine adfyppm( c, adc, q, adq, adflux, jord, ifirst, ilast, jfirst, jlast, npy, uniform_ppm, dm, addm )
!******************************************************************
!******************************************************************
!** This routine was generated by Automatic differentiation.     **
!** FastOpt: Transformation of Algorithm in Fortran, TAF 1.9.43  **
!******************************************************************
!******************************************************************
!==============================================
! all entries are defined explicitly
!==============================================
implicit none

!==============================================
! declare parameters
!==============================================
real, parameter :: b1 = 1./30.
real, parameter :: b2 = -(13./60.)
real, parameter :: b3 = -(13./60.)
real, parameter :: b4 = 0.45
real, parameter :: b5 = -0.05
real, parameter :: r3 = 1./3.
real, parameter :: s11 = 11./14.
real, parameter :: s14 = 4./7.
real, parameter :: s15 = 3./14.

!==============================================
! declare arguments
!==============================================
real, intent(inout) :: adc(isd:ied,js:je+1)
integer, intent(in) :: ifirst
integer, intent(in) :: ilast
integer, intent(in) :: jfirst
integer, intent(in) :: jlast
real, intent(inout) :: addm(ifirst:ilast,jfirst-ng:jlast+ng)
real, intent(inout) :: adflux(ifirst:ilast,jfirst:jlast+1)
real, intent(inout) :: adq(ifirst:ilast,jfirst-ng:jlast+ng)
real, intent(in) :: c(isd:ied,js:je+1)
real, intent(out) :: dm(ifirst:ilast,jfirst-ng:jlast+ng)
integer, intent(in) :: jord
integer, intent(in) :: npy
real, intent(in) :: q(ifirst:ilast,jfirst-ng:jlast+ng)
logical, intent(in) :: uniform_ppm

!==============================================
! declare local variables
!==============================================
real :: adal(ifirst:ilast,jfirst-1:jlast+2)
real :: adbl(ifirst:ilast,jfirst-1:jlast+1)
real :: adbl0
real :: adbl1
real :: adbl2
real :: adbl3
real :: adbl4
real :: adbl5
real :: adbl6
real :: adbl7
real :: adbl8
real :: adbl9
real :: adblaa
real :: adblab
real :: adblac
real :: adblad
real :: adblae
real :: adblh
real :: adbli
real :: adblj
real :: adblk
real :: adbll
real :: adblm
real :: adbln
real :: adblo
real :: adblp
real :: adblq
real :: adblr
real :: adbls
real :: adblt
real :: adblu
real :: adblv
real :: adblw
real :: adblx
real :: adbly
real :: adblz
real :: adbr(ifirst:ilast,jfirst-1:jlast+1)
real :: adbr0
real :: adbr1
real :: adbr2
real :: adbr3
real :: adbr4
real :: adbr5
real :: adbr6
real :: adbr7
real :: adbr8
real :: adbr9
real :: adbraa
real :: adbrab
real :: adbrac
real :: adbrad
real :: adbrae
real :: adbrh
real :: adbri
real :: adbrj
real :: adbrk
real :: adbrl
real :: adbrm
real :: adbrn
real :: adbro
real :: adbrp
real :: adbrq
real :: adbrr
real :: adbrs
real :: adbrt
real :: adbru
real :: adbrv
real :: adbrw
real :: adbrx
real :: adbry
real :: adbrz
real :: adc1
real :: addl
real :: addlh
real :: addli
real :: addlj
real :: addlk
real :: addll
real :: addm0
real :: addm1
real :: addm2
real :: addm3
real :: addm4
real :: addm5
real :: addm6
real :: addm7
real :: addm8
real :: addm9
real :: addmaa
real :: addmab
real :: addmac
real :: addmad
real :: addmae
real :: addmaf
real :: addmag
real :: addmai
real :: addmaj
real :: addmak
real :: addmal
real :: addmam
real :: addman
real :: addmh
real :: addmi
real :: addmj
real :: addmk
real :: addml
real :: addmm
real :: addmn
real :: addmo
real :: addmp
real :: addmq
real :: addmr
real :: addms
real :: addmt
real :: addmu
real :: addmv
real :: addmw
real :: addmx
real :: addmy
real :: addmz
real :: addq(ifirst:ilast,jfirst-3:jlast+2)
real :: addr
real :: addrh
real :: addri
real :: addrj
real :: addrk
real :: addrl
real :: adlac
real :: adpmp
real :: adqe
real :: adxt
real :: al(ifirst:ilast,jfirst-1:jlast+2)
real :: bl(ifirst:ilast,jfirst-1:jlast+1)
real :: bl0
real :: bl1
real :: bl2
real :: bl3
real :: bl4
real :: bl5
real :: bl6
real :: bl7
real :: bl8
real :: bl9
real :: blaa
real :: blab
real :: blac
real :: blh
real :: bli
real :: blj
real :: blk
real :: bll
real :: blm
real :: bln
real :: blo
real :: blp
real :: blq
real :: blr
real :: bls
real :: blt
real :: blu
real :: blv
real :: blw
real :: blx
real :: bly
real :: blz
real :: br(ifirst:ilast,jfirst-1:jlast+1)
real :: br0
real :: br1
real :: br2
real :: br3
real :: br4
real :: br5
real :: br6
real :: br7
real :: br8
real :: br9
real :: braa
real :: brab
real :: brac
real :: brh
real :: bri
real :: brj
real :: brk
real :: brl
real :: brm
real :: brn
real :: bro
real :: brp
real :: brq
real :: brr
real :: brs
real :: brt
real :: bru
real :: brv
real :: brw
real :: brx
real :: bry
real :: brz
real :: c1
real :: dl
real :: dli
real :: dlj
real :: dm0
real :: dm1
real :: dm2
real :: dm3
real :: dm4
real :: dm5
real :: dm6
real :: dm7
real :: dm8
real :: dmaa
real :: dmab
real :: dmad
real :: dmae
real :: dmh
real :: dmi
real :: dmj
real :: dmk
real :: dml
real :: dmm
real :: dmn
real :: dmo
real :: dmp
real :: dmq
real :: dmr
real :: dms
real :: dmt
real :: dmu
real :: dmv
real :: dmw
real :: dmx
real :: dmy
real :: dmz
real :: dq(ifirst:ilast,jfirst-3:jlast+2)
real :: dr
real :: dri
real :: drj
integer :: help_h
integer :: help_i
integer :: help_j
integer :: help_k
integer :: help_l
integer :: help_m
integer :: i
integer :: j
integer :: je3
integer :: js3
integer :: jt
real :: lac
real :: pmp
real :: qe
real, allocatable :: tape_fyppm_1_bl_1h(:,:,:)
real, allocatable :: tape_fyppm_1_br_2h(:,:,:)
integer :: tape_fyppm_1_fyppm
real, allocatable :: tape_fyppm_2_bl_1h(:,:,:)
real, allocatable :: tape_fyppm_2_br_2h(:,:,:)
integer :: tape_fyppm_2_fyppm
real, allocatable :: tape_fyppm_3_bl_1h(:,:,:)
real, allocatable :: tape_fyppm_3_br_2h(:,:,:)
integer :: tape_fyppm_3_fyppm
real, allocatable :: tape_fyppm_4_bl_1h(:,:,:)
real, allocatable :: tape_fyppm_4_br_2h(:,:,:)
integer :: tape_fyppm_4_fyppm
real, allocatable :: tape_fyppm_5_bl_1h(:,:,:)
real, allocatable :: tape_fyppm_5_br_2h(:,:,:)
integer :: tape_fyppm_5_fyppm
real, allocatable :: tape_fyppm_6_bl_1h(:,:,:)
real, allocatable :: tape_fyppm_6_br_2h(:,:,:)
integer :: tape_fyppm_6_fyppm
real :: xt

!----------------------------------------------
! RESET LOCAL ADJOINT VARIABLES
!----------------------------------------------
adal(:,:) = 0.
adbl(:,:) = 0.
adbr(:,:) = 0.
adc1 = 0.
addl = 0.
addq(:,:) = 0.
addr = 0.
adlac = 0.
adpmp = 0.
adqe = 0.
adxt = 0.

!----------------------------------------------
! ROUTINE BODY
!----------------------------------------------
if (jord .le. 4) then
  if (uniform_ppm) then
    do j = jfirst-2, jlast+2
      do i = ifirst, ilast
        xt = 0.25*(q(i,j+1)-q(i,j-1))
        dm(i,j) = sign(min(abs(xt),max(q(i,j-1),q(i,j),q(i,j+1))-q(i,j),q(i,j)-min(q(i,j-1),q(i,j),q(i,j+1))),xt)
      end do
    end do
  else
    do j = jfirst-3, jlast+2
      do i = ifirst, ilast
        dq(i,j) = q(i,j+1)-q(i,j)
      end do
    end do
    do j = jfirst-2, jlast+2
      do i = ifirst, ilast
        xt = cy1(i,j)*dq(i,j-1)+cy2(i,j)*dq(i,j)
        dm(i,j) = sign(min(abs(xt),abs(dq(i,j-1)),abs(dq(i,j))),xt)
      end do
    end do
  endif
  do j = jfirst-1, jlast+2
    do i = ifirst, ilast
      al(i,j) = 0.5*(q(i,j-1)+q(i,j))+r3*(dm(i,j-1)-dm(i,j))
    end do
  end do
  do j = jfirst, jlast+1
    addl = 0.
    addr = 0.
    adxt = 0.
    do i = ifirst, ilast
      addl = 0.
      addr = 0.
      adxt = 0.
      if (c(i,j) .gt. 0.) then
        xt = 2.*dm(i,j-1)
        dl = sign(min(abs(xt),abs(al(i,j-1)-q(i,j-1))),xt)
        dr = sign(min(abs(xt),abs(al(i,j)-q(i,j-1))),xt)
        adc(i,j) = adc(i,j)+adflux(i,j)*((1.-c(i,j))*(dl-dr)-(c(i,j)*(dl-dr)+dr))
        addl = addl+adflux(i,j)*(1.-c(i,j))*c(i,j)
        addr = addr+adflux(i,j)*(1.-c(i,j))*(1+(-c(i,j)))
        adq(i,j-1) = adq(i,j-1)+adflux(i,j)
        adflux(i,j) = 0.
        drj = al(i,j)-q(i,j-1)
        addrk = addr*sign(1.,min(abs(xt),abs(drj)))*sign(1.,xt)
        addrl = addrk*(0.5-sign(0.5,abs(drj)-abs(xt)))*sign(1.,drj)
        adxt = adxt+addrk*(0.5+sign(0.5,abs(drj)-abs(xt)))*sign(1.,xt)
        adal(i,j) = adal(i,j)+addrl
        adq(i,j-1) = adq(i,j-1)-addrl
        addr = 0.
        dlj = al(i,j-1)-q(i,j-1)
        addlk = addl*sign(1.,min(abs(xt),abs(dlj)))*sign(1.,xt)
        addll = addlk*(0.5-sign(0.5,abs(dlj)-abs(xt)))*sign(1.,dlj)
        adxt = adxt+addlk*(0.5+sign(0.5,abs(dlj)-abs(xt)))*sign(1.,xt)
        adal(i,j-1) = adal(i,j-1)+addll
        adq(i,j-1) = adq(i,j-1)-addll
        addl = 0.
        addm(i,j-1) = addm(i,j-1)+2*adxt
        adxt = 0.
      else
        xt = 2.*dm(i,j)
        dl = sign(min(abs(xt),abs(al(i,j)-q(i,j))),xt)
        dr = sign(min(abs(xt),abs(al(i,j+1)-q(i,j))),xt)
        adc(i,j) = adc(i,j)-adflux(i,j)*((1.+2*c(i,j))*(dl-dr)+dl)
        addl = addl-adflux(i,j)*(1.+c(i,j))*(1+c(i,j))
        addr = addr+adflux(i,j)*(1.+c(i,j))*c(i,j)
        adq(i,j) = adq(i,j)+adflux(i,j)
        adflux(i,j) = 0.
        dri = al(i,j+1)-q(i,j)
        addri = addr*sign(1.,min(abs(xt),abs(dri)))*sign(1.,xt)
        addrj = addri*(0.5-sign(0.5,abs(dri)-abs(xt)))*sign(1.,dri)
        adxt = adxt+addri*(0.5+sign(0.5,abs(dri)-abs(xt)))*sign(1.,xt)
        adal(i,j+1) = adal(i,j+1)+addrj
        adq(i,j) = adq(i,j)-addrj
        addr = 0.
        dli = al(i,j)-q(i,j)
        addli = addl*sign(1.,min(abs(xt),abs(dli)))*sign(1.,xt)
        addlj = addli*(0.5-sign(0.5,abs(dli)-abs(xt)))*sign(1.,dli)
        adxt = adxt+addli*(0.5+sign(0.5,abs(dli)-abs(xt)))*sign(1.,xt)
        adal(i,j) = adal(i,j)+addlj
        adq(i,j) = adq(i,j)-addlj
        addl = 0.
        addm(i,j) = addm(i,j)+2*adxt
        adxt = 0.
      endif
    end do
  end do
  do j = jfirst-1, jlast+2
    do i = ifirst, ilast
      addm(i,j-1) = addm(i,j-1)+adal(i,j)*r3
      addm(i,j) = addm(i,j)-adal(i,j)*r3
      adq(i,j-1) = adq(i,j-1)+0.5*adal(i,j)
      adq(i,j) = adq(i,j)+0.5*adal(i,j)
      adal(i,j) = 0.
    end do
  end do
  if (uniform_ppm) then
    do j = jfirst-2, jlast+2
      adxt = 0.
      do i = ifirst, ilast
        adxt = 0.
        xt = 0.25*(q(i,j+1)-q(i,j-1))
        dm7 = abs(xt)
        dm8 = max(q(i,j-1),q(i,j))
        dmaa = max(dm8,q(i,j+1))-q(i,j)
        dmab = min(q(i,j-1),q(i,j))
        dmad = q(i,j)-min(dmab,q(i,j+1))
        dmae = min(dm7,dmaa)
        addman = addm(i,j)*sign(1.,min(dmae,dmad))*sign(1.,xt)
        addmal = addman*(0.5-sign(0.5,dmad-dmae))
        addmam = addman*(0.5+sign(0.5,dmad-dmae))
        addmaf = addmam*(0.5+sign(0.5,dmaa-dm7))
        addmai = addmam*(0.5-sign(0.5,dmaa-dm7))
        addmak = -addmal
        adq(i,j) = adq(i,j)+addmal
        addmaj = addmak*(0.5+sign(0.5,q(i,j+1)-dmab))
        adq(i,j+1) = adq(i,j+1)+addmak*(0.5-sign(0.5,q(i,j+1)-dmab))
        adq(i,j-1) = adq(i,j-1)+addmaj*(0.5+sign(0.5,q(i,j)-q(i,j-1)))
        adq(i,j) = adq(i,j)+addmaj*(0.5-sign(0.5,q(i,j)-q(i,j-1)))
        adq(i,j) = adq(i,j)-addmai
        addmag = addmai*(0.5+sign(0.5,dm8-q(i,j+1)))
        adq(i,j+1) = adq(i,j+1)+addmai*(0.5-sign(0.5,dm8-q(i,j+1)))
        adq(i,j-1) = adq(i,j-1)+addmag*(0.5+sign(0.5,q(i,j-1)-q(i,j)))
        adq(i,j) = adq(i,j)+addmag*(0.5-sign(0.5,q(i,j-1)-q(i,j)))
        adxt = adxt+addmaf*sign(1.,xt)
        addm(i,j) = 0.
        adq(i,j-1) = adq(i,j-1)-0.25*adxt
        adq(i,j+1) = adq(i,j+1)+0.25*adxt
        adxt = 0.
      end do
    end do
  else
    do j = jfirst-2, jlast+2
      adxt = 0.
      do i = ifirst, ilast
        adxt = 0.
        xt = cy1(i,j)*dq(i,j-1)+cy2(i,j)*dq(i,j)
        dmz = abs(xt)
        dm2 = abs(dq(i,j-1))
        dm5 = abs(dq(i,j))
        dm6 = min(dmz,dm2)
        addmae = addm(i,j)*sign(1.,min(dm6,dm5))*sign(1.,xt)
        addmac = addmae*(0.5-sign(0.5,dm5-dm6))
        addmad = addmae*(0.5+sign(0.5,dm5-dm6))
        addmab = addmad*(0.5-sign(0.5,dm2-dmz))
        addm4 = addmad*(0.5+sign(0.5,dm2-dmz))
        addq(i,j) = addq(i,j)+addmac*sign(1.,dq(i,j))
        addq(i,j-1) = addq(i,j-1)+addmab*sign(1.,dq(i,j-1))
        adxt = adxt+addm4*sign(1.,xt)
        addm(i,j) = 0.
        addq(i,j-1) = addq(i,j-1)+adxt*cy1(i,j)
        addq(i,j) = addq(i,j)+adxt*cy2(i,j)
        adxt = 0.
      end do
    end do
    do j = jfirst-3, jlast+2
      do i = ifirst, ilast
        adq(i,j+1) = adq(i,j+1)+addq(i,j)
        adq(i,j) = adq(i,j)-addq(i,j)
        addq(i,j) = 0.
      end do
    end do
  endif
else if (jord .eq. 5) then
  do j = jfirst-3, jlast+2
    do i = ifirst, ilast
      dq(i,j) = q(i,j+1)-q(i,j)
    end do
  end do
  if (uniform_ppm) then
    do j = jfirst-2, jlast+2
      do i = ifirst, ilast
        xt = 0.25*(q(i,j+1)-q(i,j-1))
        dm(i,j) = sign(min(abs(xt),max(q(i,j-1),q(i,j),q(i,j+1))-q(i,j),q(i,j)-min(q(i,j-1),q(i,j),q(i,j+1))),xt)
      end do
    end do
  else
    do j = jfirst-2, jlast+2
      do i = ifirst, ilast
        xt = cy1(i,j)*dq(i,j-1)+cy2(i,j)*dq(i,j)
        dm(i,j) = sign(min(abs(xt),abs(dq(i,j-1)),abs(dq(i,j))),xt)
      end do
    end do
  endif
  do j = jfirst-1, jlast+2
    do i = ifirst, ilast
      al(i,j) = 0.5*(q(i,j-1)+q(i,j))+r3*(dm(i,j-1)-dm(i,j))
    end do
  end do
  do j = jfirst-1, jlast+1
    do i = ifirst, ilast
      pmp = -(2.*dq(i,j))
      lac = pmp+1.5*dq(i,j+1)
      bl(i,j) = min(max(0.,pmp,lac),max(al(i,j)-q(i,j),min(0.,pmp,lac)))
      pmp = 2.*dq(i,j-1)
      lac = pmp-1.5*dq(i,j-2)
      br(i,j) = min(max(0.,pmp,lac),max(al(i,j+1)-q(i,j),min(0.,pmp,lac)))
    end do
  end do
  do j = jfirst, jlast+1
    do i = ifirst, ilast
      if (c(i,j) .gt. 0.) then
        adbl(i,j-1) = adbl(i,j-1)-adflux(i,j)*(1.-c(i,j))*c(i,j)
        adbr(i,j-1) = adbr(i,j-1)+adflux(i,j)*(1.-c(i,j))*(1-c(i,j))
        adc(i,j) = adc(i,j)+adflux(i,j)*((-((1.-c(i,j))*(bl(i,j-1)+br(i,j-1))))-(br(i,j-1)-c(i,j)*(bl(i,j-1)+br(i,j-1))))
        adq(i,j-1) = adq(i,j-1)+adflux(i,j)
        adflux(i,j) = 0.
      else
        adbl(i,j) = adbl(i,j)+adflux(i,j)*(1.+c(i,j))*(1+c(i,j))
        adbr(i,j) = adbr(i,j)+adflux(i,j)*(1.+c(i,j))*c(i,j)
        adc(i,j) = adc(i,j)+adflux(i,j)*((1.+c(i,j))*(bl(i,j)+br(i,j))+bl(i,j)+c(i,j)*(bl(i,j)+br(i,j)))
        adq(i,j) = adq(i,j)+adflux(i,j)
        adflux(i,j) = 0.
      endif
    end do
  end do
  do j = jfirst-1, jlast+1
    adlac = 0.
    adpmp = 0.
    do i = ifirst, ilast
      adlac = 0.
      adpmp = 0.
      pmp = 2.*dq(i,j-1)
      lac = pmp-1.5*dq(i,j-2)
      br8 = max(0.,pmp)
      br9 = max(br8,lac)
      brab = min(0.,pmp)
      brac = min(brab,lac)
      braa = max(al(i,j+1)-q(i,j),brac)
      adbrab = adbr(i,j)*(0.5+sign(0.5,braa-br9))
      adbrac = adbr(i,j)*(0.5-sign(0.5,braa-br9))
      adal(i,j+1) = adal(i,j+1)+adbrac*(0.5+sign(0.5,al(i,j+1)-q(i,j)-brac))
      adbrae = adbrac*(0.5-sign(0.5,al(i,j+1)-q(i,j)-brac))
      adq(i,j) = adq(i,j)-adbrac*(0.5+sign(0.5,al(i,j+1)-q(i,j)-brac))
      adbrad = adbrae*(0.5+sign(0.5,lac-brab))
      adlac = adlac+adbrae*(0.5-sign(0.5,lac-brab))
      adpmp = adpmp+adbrad*(0.5-sign(0.5,pmp-0.))
      adbraa = adbrab*(0.5+sign(0.5,br8-lac))
      adlac = adlac+adbrab*(0.5-sign(0.5,br8-lac))
      adpmp = adpmp+adbraa*(0.5-sign(0.5,0.-pmp))
      adbr(i,j) = 0.
      addq(i,j-2) = addq(i,j-2)-1.5*adlac
      adpmp = adpmp+adlac
      adlac = 0.
      addq(i,j-1) = addq(i,j-1)+2*adpmp
      adpmp = 0.
      pmp = -(2.*dq(i,j))
      lac = pmp+1.5*dq(i,j+1)
      bl8 = max(0.,pmp)
      bl9 = max(bl8,lac)
      blab = min(0.,pmp)
      blac = min(blab,lac)
      blaa = max(al(i,j)-q(i,j),blac)
      adblab = adbl(i,j)*(0.5+sign(0.5,blaa-bl9))
      adblac = adbl(i,j)*(0.5-sign(0.5,blaa-bl9))
      adal(i,j) = adal(i,j)+adblac*(0.5+sign(0.5,al(i,j)-q(i,j)-blac))
      adblae = adblac*(0.5-sign(0.5,al(i,j)-q(i,j)-blac))
      adq(i,j) = adq(i,j)-adblac*(0.5+sign(0.5,al(i,j)-q(i,j)-blac))
      adblad = adblae*(0.5+sign(0.5,lac-blab))
      adlac = adlac+adblae*(0.5-sign(0.5,lac-blab))
      adpmp = adpmp+adblad*(0.5-sign(0.5,pmp-0.))
      adblaa = adblab*(0.5+sign(0.5,bl8-lac))
      adlac = adlac+adblab*(0.5-sign(0.5,bl8-lac))
      adpmp = adpmp+adblaa*(0.5-sign(0.5,0.-pmp))
      adbl(i,j) = 0.
      addq(i,j+1) = addq(i,j+1)+1.5*adlac
      adpmp = adpmp+adlac
      adlac = 0.
      addq(i,j) = addq(i,j)-2*adpmp
      adpmp = 0.
    end do
  end do
  do j = jfirst-1, jlast+2
    do i = ifirst, ilast
      addm(i,j-1) = addm(i,j-1)+adal(i,j)*r3
      addm(i,j) = addm(i,j)-adal(i,j)*r3
      adq(i,j-1) = adq(i,j-1)+0.5*adal(i,j)
      adq(i,j) = adq(i,j)+0.5*adal(i,j)
      adal(i,j) = 0.
    end do
  end do
  if (uniform_ppm) then
    do j = jfirst-2, jlast+2
      adxt = 0.
      do i = ifirst, ilast
        adxt = 0.
        xt = 0.25*(q(i,j+1)-q(i,j-1))
        dmx = abs(xt)
        dmy = max(q(i,j-1),q(i,j))
        dm0 = max(dmy,q(i,j+1))-q(i,j)
        dm1 = min(q(i,j-1),q(i,j))
        dm3 = q(i,j)-min(dm1,q(i,j+1))
        dm4 = min(dmx,dm0)
        addmaa = addm(i,j)*sign(1.,min(dm4,dm3))*sign(1.,xt)
        addm8 = addmaa*(0.5-sign(0.5,dm3-dm4))
        addm9 = addmaa*(0.5+sign(0.5,dm3-dm4))
        addm5 = addm9*(0.5-sign(0.5,dm0-dmx))
        addm2 = addm9*(0.5+sign(0.5,dm0-dmx))
        addm7 = -addm8
        adq(i,j) = adq(i,j)+addm8
        addm6 = addm7*(0.5+sign(0.5,q(i,j+1)-dm1))
        adq(i,j+1) = adq(i,j+1)+addm7*(0.5-sign(0.5,q(i,j+1)-dm1))
        adq(i,j-1) = adq(i,j-1)+addm6*(0.5+sign(0.5,q(i,j)-q(i,j-1)))
        adq(i,j) = adq(i,j)+addm6*(0.5-sign(0.5,q(i,j)-q(i,j-1)))
        adq(i,j) = adq(i,j)-addm5
        addm3 = addm5*(0.5+sign(0.5,dmy-q(i,j+1)))
        adq(i,j+1) = adq(i,j+1)+addm5*(0.5-sign(0.5,dmy-q(i,j+1)))
        adq(i,j-1) = adq(i,j-1)+addm3*(0.5+sign(0.5,q(i,j-1)-q(i,j)))
        adq(i,j) = adq(i,j)+addm3*(0.5-sign(0.5,q(i,j-1)-q(i,j)))
        adxt = adxt+addm2*sign(1.,xt)
        addm(i,j) = 0.
        adq(i,j-1) = adq(i,j-1)-0.25*adxt
        adq(i,j+1) = adq(i,j+1)+0.25*adxt
        adxt = 0.
      end do
    end do
  else
    do j = jfirst-2, jlast+2
      adxt = 0.
      do i = ifirst, ilast
        adxt = 0.
        xt = cy1(i,j)*dq(i,j-1)+cy2(i,j)*dq(i,j)
        dmp = abs(xt)
        dms = abs(dq(i,j-1))
        dmv = abs(dq(i,j))
        dmw = min(dmp,dms)
        addm1 = addm(i,j)*sign(1.,min(dmw,dmv))*sign(1.,xt)
        addmz = addm1*(0.5-sign(0.5,dmv-dmw))
        addm0 = addm1*(0.5+sign(0.5,dmv-dmw))
        addmr = addm0*(0.5+sign(0.5,dms-dmp))
        addmy = addm0*(0.5-sign(0.5,dms-dmp))
        addq(i,j) = addq(i,j)+addmz*sign(1.,dq(i,j))
        addq(i,j-1) = addq(i,j-1)+addmy*sign(1.,dq(i,j-1))
        adxt = adxt+addmr*sign(1.,xt)
        addm(i,j) = 0.
        addq(i,j-1) = addq(i,j-1)+adxt*cy1(i,j)
        addq(i,j) = addq(i,j)+adxt*cy2(i,j)
        adxt = 0.
      end do
    end do
  endif
  do j = jfirst-3, jlast+2
    do i = ifirst, ilast
      adq(i,j+1) = adq(i,j+1)+addq(i,j)
      adq(i,j) = adq(i,j)-addq(i,j)
      addq(i,j) = 0.
    end do
  end do
else if (jord .eq. 6 .or. jord .eq. 7) then
  do j = jfirst-1, jlast+1
    do i = ifirst, ilast
      xt = b3*q(i,j)
      bl(i,j) = b5*q(i,j-2)+b4*q(i,j-1)+xt+b2*q(i,j+1)+b1*q(i,j+2)
      br(i,j) = b1*q(i,j-2)+b2*q(i,j-1)+xt+b4*q(i,j+1)+b5*q(i,j+2)
    end do
  end do
  if (jord .eq. 7) then
    do j = jfirst-2, jlast+3
      do i = ifirst, ilast
        dq(i,j) = q(i,j)-q(i,j-1)
      end do
    end do
    do j = jfirst-1, jlast+1
      do i = ifirst, ilast
        dl = -sign(min(abs(bl(i,j)),abs(dq(i,j))),dq(i,j))
        pmp = -(2.*dq(i,j+1))
        lac = pmp+1.5*dq(i,j+2)
        bl(i,j) = min(max(0.,pmp,lac),max(dl,min(0.,pmp,lac)))
        dr = sign(min(abs(br(i,j)),abs(dq(i,j+1))),dq(i,j+1))
        pmp = 2.*dq(i,j)
        lac = pmp-1.5*dq(i,j-1)
        br(i,j) = min(max(0.,pmp,lac),max(dr,min(0.,pmp,lac)))
      end do
    end do
  endif
  do j = jfirst, jlast+1
    do i = ifirst, ilast
      if (c(i,j) .gt. 0.) then
        adbl(i,j-1) = adbl(i,j-1)-adflux(i,j)*(1.-c(i,j))*c(i,j)
        adbr(i,j-1) = adbr(i,j-1)+adflux(i,j)*(1.-c(i,j))*(1-c(i,j))
        adc(i,j) = adc(i,j)+adflux(i,j)*((-((1.-c(i,j))*(bl(i,j-1)+br(i,j-1))))-(br(i,j-1)-c(i,j)*(bl(i,j-1)+br(i,j-1))))
        adq(i,j-1) = adq(i,j-1)+adflux(i,j)
        adflux(i,j) = 0.
      else
        adbl(i,j) = adbl(i,j)+adflux(i,j)*(1.+c(i,j))*(1+c(i,j))
        adbr(i,j) = adbr(i,j)+adflux(i,j)*(1.+c(i,j))*c(i,j)
        adc(i,j) = adc(i,j)+adflux(i,j)*((1.+c(i,j))*(bl(i,j)+br(i,j))+bl(i,j)+c(i,j)*(bl(i,j)+br(i,j)))
        adq(i,j) = adq(i,j)+adflux(i,j)
        adflux(i,j) = 0.
      endif
    end do
  end do
  do j = jfirst-1, jlast+1
    do i = ifirst, ilast
      xt = b3*q(i,j)
      bl(i,j) = b5*q(i,j-2)+b4*q(i,j-1)+xt+b2*q(i,j+1)+b1*q(i,j+2)
      br(i,j) = b1*q(i,j-2)+b2*q(i,j-1)+xt+b4*q(i,j+1)+b5*q(i,j+2)
    end do
  end do
  if (jord .eq. 7) then
    do j = jfirst-1, jlast+1
      addl = 0.
      addr = 0.
      adlac = 0.
      adpmp = 0.
      do i = ifirst, ilast
        addl = 0.
        addr = 0.
        adlac = 0.
        adpmp = 0.
        dl = -sign(min(abs(bl(i,j)),abs(dq(i,j))),dq(i,j))
        dr = sign(min(abs(br(i,j)),abs(dq(i,j+1))),dq(i,j+1))
        pmp = 2.*dq(i,j)
        lac = pmp-1.5*dq(i,j-1)
        br3 = max(0.,pmp)
        br4 = max(br3,lac)
        br6 = min(0.,pmp)
        br7 = min(br6,lac)
        br5 = max(dr,br7)
        adbr6 = adbr(i,j)*(0.5+sign(0.5,br5-br4))
        adbr7 = adbr(i,j)*(0.5-sign(0.5,br5-br4))
        adbr9 = adbr7*(0.5-sign(0.5,dr-br7))
        addr = addr+adbr7*(0.5+sign(0.5,dr-br7))
        adbr8 = adbr9*(0.5+sign(0.5,lac-br6))
        adlac = adlac+adbr9*(0.5-sign(0.5,lac-br6))
        adpmp = adpmp+adbr8*(0.5-sign(0.5,pmp-0.))
        adbr5 = adbr6*(0.5+sign(0.5,br3-lac))
        adlac = adlac+adbr6*(0.5-sign(0.5,br3-lac))
        adpmp = adpmp+adbr5*(0.5-sign(0.5,0.-pmp))
        adbr(i,j) = 0.
        addq(i,j-1) = addq(i,j-1)-1.5*adlac
        adpmp = adpmp+adlac
        adlac = 0.
        addq(i,j) = addq(i,j)+2*adpmp
        adpmp = 0.
        addrh = addr*sign(1.,min(abs(br(i,j)),abs(dq(i,j+1))))*sign(1.,dq(i,j+1))
        adbr(i,j) = adbr(i,j)+addrh*(0.5+sign(0.5,abs(dq(i,j+1))-abs(br(i,j))))*sign(1.,br(i,j))
        addq(i,j+1) = addq(i,j+1)+addrh*(0.5-sign(0.5,abs(dq(i,j+1))-abs(br(i,j))))*sign(1.,dq(i,j+1))
        addr = 0.
        pmp = -(2.*dq(i,j+1))
        lac = pmp+1.5*dq(i,j+2)
        bl3 = max(0.,pmp)
        bl4 = max(bl3,lac)
        bl6 = min(0.,pmp)
        bl7 = min(bl6,lac)
        bl5 = max(dl,bl7)
        adbl6 = adbl(i,j)*(0.5+sign(0.5,bl5-bl4))
        adbl7 = adbl(i,j)*(0.5-sign(0.5,bl5-bl4))
        adbl9 = adbl7*(0.5-sign(0.5,dl-bl7))
        addl = addl+adbl7*(0.5+sign(0.5,dl-bl7))
        adbl8 = adbl9*(0.5+sign(0.5,lac-bl6))
        adlac = adlac+adbl9*(0.5-sign(0.5,lac-bl6))
        adpmp = adpmp+adbl8*(0.5-sign(0.5,pmp-0.))
        adbl5 = adbl6*(0.5+sign(0.5,bl3-lac))
        adlac = adlac+adbl6*(0.5-sign(0.5,bl3-lac))
        adpmp = adpmp+adbl5*(0.5-sign(0.5,0.-pmp))
        adbl(i,j) = 0.
        addq(i,j+2) = addq(i,j+2)+1.5*adlac
        adpmp = adpmp+adlac
        adlac = 0.
        addq(i,j+1) = addq(i,j+1)-2*adpmp
        adpmp = 0.
        addlh = -(addl*sign(1.,min(abs(bl(i,j)),abs(dq(i,j))))*sign(1.,dq(i,j)))
        adbl(i,j) = adbl(i,j)+addlh*(0.5+sign(0.5,abs(dq(i,j))-abs(bl(i,j))))*sign(1.,bl(i,j))
        addq(i,j) = addq(i,j)+addlh*(0.5-sign(0.5,abs(dq(i,j))-abs(bl(i,j))))*sign(1.,dq(i,j))
        addl = 0.
      end do
    end do
    do j = jfirst-2, jlast+3
      do i = ifirst, ilast
        adq(i,j-1) = adq(i,j-1)-addq(i,j)
        adq(i,j) = adq(i,j)+addq(i,j)
        addq(i,j) = 0.
      end do
    end do
  endif
  do j = jfirst-1, jlast+1
    adxt = 0.
    do i = ifirst, ilast
      adxt = 0.
      adq(i,j-2) = adq(i,j-2)+adbr(i,j)*b1
      adq(i,j-1) = adq(i,j-1)+adbr(i,j)*b2
      adq(i,j+2) = adq(i,j+2)+adbr(i,j)*b5
      adq(i,j+1) = adq(i,j+1)+adbr(i,j)*b4
      adxt = adxt+adbr(i,j)
      adbr(i,j) = 0.
      adq(i,j-2) = adq(i,j-2)+adbl(i,j)*b5
      adq(i,j-1) = adq(i,j-1)+adbl(i,j)*b4
      adq(i,j+2) = adq(i,j+2)+adbl(i,j)*b1
      adq(i,j+1) = adq(i,j+1)+adbl(i,j)*b2
      adxt = adxt+adbl(i,j)
      adbl(i,j) = 0.
      adq(i,j) = adq(i,j)+adxt*b3
      adxt = 0.
    end do
  end do
else if (jord .le. 10) then
  do j = js-2, je+2
    do i = ifirst, ilast
      xt = 0.25*(q(i,j+1)-q(i,j-1))
      dm(i,j) = sign(min(abs(xt),max(q(i,j-1),q(i,j),q(i,j+1))-q(i,j),q(i,j)-min(q(i,j-1),q(i,j),q(i,j+1))),xt)
    end do
  end do
  if (grid_type .lt. 3) then
    do j = max(3,js-1), min(npy-2,je+2)
      do i = ifirst, ilast
        al(i,j) = 0.5*(q(i,j-1)+q(i,j))+r3*(dm(i,j-1)-dm(i,j))
      end do
    end do
    do j = js-3, je+2
      do i = ifirst, ilast
        dq(i,j) = q(i,j+1)-q(i,j)
      end do
    end do
    do j = max(3,js-1), min(npy-3,je+1)
      do i = ifirst, ilast
        pmp = -(2.*dq(i,j))
        lac = pmp+1.5*dq(i,j+1)
        bl(i,j) = min(max(0.,pmp,lac),max(al(i,j)-q(i,j),min(0.,pmp,lac)))
        pmp = 2.*dq(i,j-1)
        lac = pmp-1.5*dq(i,j-2)
        br(i,j) = min(max(0.,pmp,lac),max(al(i,j+1)-q(i,j),min(0.,pmp,lac)))
      end do
    end do
    if (js .eq. 1) then
      do i = ifirst, ilast
        br(i,2) = al(i,3)-q(i,2)
        xt = 0.5*((2.*dya(i,1)+dya(i,2))*(q(i,0)+q(i,1))-dya(i,1)*(q(i,-1)+q(i,2)))/(dya(i,1)+dya(i,2))
        bl(i,1) = xt-q(i,1)
        br(i,0) = xt-q(i,0)
        xt = s14*dm(i,-1)-s11*dq(i,-1)+q(i,0)
        bl(i,0) = xt-q(i,0)
        xt = s15*q(i,1)+s11*q(i,2)-s14*dm(i,2)
        br(i,1) = xt-q(i,1)
        bl(i,2) = xt-q(i,2)
      end do
      if (jord .eq. 9) then
        do j = 0, 2
          help_h = ilast-ifirst+1
          call pert_ppm( help_h,q(ifirst:ilast,j),bl(ifirst:ilast,j),br(ifirst:ilast,j),1 )
        end do
      endif
    endif
    if (je+1 .eq. npy) then
      do i = ifirst, ilast
        bl(i,npy-2) = al(i,npy-2)-q(i,npy-2)
        xt = 0.5*((2.*dya(i,npy-1)+dya(i,npy-2))*(q(i,npy-1)+q(i,npy))-dya(i,npy-1)*(q(i,npy-2)+q(i,npy+1)))/(dya(i,npy-1)+dya(i,&
&npy-2))
        br(i,npy-1) = xt-q(i,npy-1)
        bl(i,npy) = xt-q(i,npy)
        xt = s11*dq(i,npy)-s14*dm(i,npy+1)+q(i,npy)
        br(i,npy) = xt-q(i,npy)
        xt = s15*q(i,npy-1)+s11*q(i,npy-2)+s14*dm(i,npy-2)
        br(i,npy-2) = xt-q(i,npy-2)
        bl(i,npy-1) = xt-q(i,npy-1)
      end do
      if (jord .eq. 9) then
        do j = npy-2, npy
          help_i = ilast-ifirst+1
          call pert_ppm( help_i,q(ifirst:ilast,j),bl(ifirst:ilast,j),br(ifirst:ilast,j),1 )
        end do
      endif
    endif
  else
    do j = jfirst-1, jlast+2
      do i = ifirst, ilast
        al(i,j) = 0.5*(q(i,j-1)+q(i,j))+r3*(dm(i,j-1)-dm(i,j))
      end do
    end do
    do j = jfirst-3, jlast+2
      do i = ifirst, ilast
        dq(i,j) = q(i,j+1)-q(i,j)
      end do
    end do
    do j = jfirst-1, jlast+1
      do i = ifirst, ilast
        pmp = -(2.*dq(i,j))
        lac = pmp+1.5*dq(i,j+1)
        bl(i,j) = min(max(0.,pmp,lac),max(al(i,j)-q(i,j),min(0.,pmp,lac)))
        pmp = 2.*dq(i,j-1)
        lac = pmp-1.5*dq(i,j-2)
        br(i,j) = min(max(0.,pmp,lac),max(al(i,j+1)-q(i,j),min(0.,pmp,lac)))
      end do
    end do
  endif
  do j = jfirst, jlast+1
    adc1 = 0.
    adqe = 0.
    do i = ifirst, ilast
      adc1 = 0.
      adqe = 0.
      if (intel_opt_kim) then
        c1 = c(i,j)
        if (c1 .gt. 0.) then
          jt = j-1
          qe = br(i,j-1)
        else
          jt = j
          qe = bl(i,j)
        endif
        c1 = -abs(c1)
        adbl(i,jt) = adbl(i,jt)+adflux(i,j)*(1.+c1)*c1
        adbr(i,jt) = adbr(i,jt)+adflux(i,j)*(1.+c1)*c1
        adc1 = adc1+adflux(i,j)*((1.+c1)*(bl(i,jt)+br(i,jt))+qe+c1*(bl(i,jt)+br(i,jt)))
        adq(i,jt) = adq(i,jt)+adflux(i,j)
        adqe = adqe+adflux(i,j)*(1+c1)
        adflux(i,j) = 0.
        c1 = c(i,j)
        adc1 = -(adc1*sign(1.,c1))
        c1 = c(i,j)
        if (c1 .gt. 0.) then
          adbr(i,j-1) = adbr(i,j-1)+adqe
          adqe = 0.
        else
          adbl(i,j) = adbl(i,j)+adqe
          adqe = 0.
        endif
        adc(i,j) = adc(i,j)+adc1
        adc1 = 0.
      else
        if (c(i,j) .gt. 0.) then
          adbl(i,j-1) = adbl(i,j-1)-adflux(i,j)*(1.-c(i,j))*c(i,j)
          adbr(i,j-1) = adbr(i,j-1)+adflux(i,j)*(1.-c(i,j))*(1-c(i,j))
          adc(i,j) = adc(i,j)+adflux(i,j)*((-((1.-c(i,j))*(bl(i,j-1)+br(i,j-1))))-(br(i,j-1)-c(i,j)*(bl(i,j-1)+br(i,j-1))))
          adq(i,j-1) = adq(i,j-1)+adflux(i,j)
          adflux(i,j) = 0.
        else
          adbl(i,j) = adbl(i,j)+adflux(i,j)*(1.+c(i,j))*(1+c(i,j))
          adbr(i,j) = adbr(i,j)+adflux(i,j)*(1.+c(i,j))*c(i,j)
          adc(i,j) = adc(i,j)+adflux(i,j)*((1.+c(i,j))*(bl(i,j)+br(i,j))+bl(i,j)+c(i,j)*(bl(i,j)+br(i,j)))
          adq(i,j) = adq(i,j)+adflux(i,j)
          adflux(i,j) = 0.
        endif
      endif
    end do
  end do
  if (grid_type .lt. 3) then
    do j = max(3,js-1), min(npy-3,je+1)
      do i = ifirst, ilast
        pmp = -(2.*dq(i,j))
        lac = pmp+1.5*dq(i,j+1)
        bl(i,j) = min(max(0.,pmp,lac),max(al(i,j)-q(i,j),min(0.,pmp,lac)))
        pmp = 2.*dq(i,j-1)
        lac = pmp-1.5*dq(i,j-2)
        br(i,j) = min(max(0.,pmp,lac),max(al(i,j+1)-q(i,j),min(0.,pmp,lac)))
      end do
    end do
    if (js .eq. 1) then
      do i = ifirst, ilast
        br(i,2) = al(i,3)-q(i,2)
        xt = 0.5*((2.*dya(i,1)+dya(i,2))*(q(i,0)+q(i,1))-dya(i,1)*(q(i,-1)+q(i,2)))/(dya(i,1)+dya(i,2))
        bl(i,1) = xt-q(i,1)
        br(i,0) = xt-q(i,0)
        xt = s14*dm(i,-1)-s11*dq(i,-1)+q(i,0)
        bl(i,0) = xt-q(i,0)
        xt = s15*q(i,1)+s11*q(i,2)-s14*dm(i,2)
        br(i,1) = xt-q(i,1)
        bl(i,2) = xt-q(i,2)
      end do
      if (jord .eq. 9) then
        do j = 0, 2
          help_h = ilast-ifirst+1
          call pert_ppm( help_h,q(ifirst:ilast,j),bl(ifirst:ilast,j),br(ifirst:ilast,j),1 )
        end do
      endif
    endif
    if (je+1 .eq. npy) then
      do i = ifirst, ilast
        bl(i,npy-2) = al(i,npy-2)-q(i,npy-2)
        xt = 0.5*((2.*dya(i,npy-1)+dya(i,npy-2))*(q(i,npy-1)+q(i,npy))-dya(i,npy-1)*(q(i,npy-2)+q(i,npy+1)))/(dya(i,npy-1)+dya(i,&
&npy-2))
        br(i,npy-1) = xt-q(i,npy-1)
        bl(i,npy) = xt-q(i,npy)
        xt = s11*dq(i,npy)-s14*dm(i,npy+1)+q(i,npy)
        br(i,npy) = xt-q(i,npy)
        xt = s15*q(i,npy-1)+s11*q(i,npy-2)+s14*dm(i,npy-2)
        br(i,npy-2) = xt-q(i,npy-2)
        bl(i,npy-1) = xt-q(i,npy-1)
      end do
      if (jord .eq. 9) then
!----------------------------------------------
! OPEN TAPE tape_fyppm_2
!----------------------------------------------
        tape_fyppm_2_fyppm = 3

!----------------------------------------------
! TAPE COMPUTATIONS
!----------------------------------------------
        do j = npy-2, npy-1
          if ( .not. allocated(tape_fyppm_2_bl_1h)) then
            allocate( tape_fyppm_2_bl_1h(ifirst:ilast,jfirst-1:jlast+1,tape_fyppm_2_fyppm) )
          endif
          tape_fyppm_2_bl_1h(:,:,j-npy+2+1) = bl
          if ( .not. allocated(tape_fyppm_2_br_2h)) then
            allocate( tape_fyppm_2_br_2h(ifirst:ilast,jfirst-1:jlast+1,tape_fyppm_2_fyppm) )
          endif
          tape_fyppm_2_br_2h(:,:,j-npy+2+1) = br
          help_i = ilast-ifirst+1
          call pert_ppm( help_i,q(ifirst:ilast,j),bl(ifirst:ilast,j),br(ifirst:ilast,j),1 )
        end do
        j = npy
        if ( .not. allocated(tape_fyppm_2_bl_1h)) then
          allocate( tape_fyppm_2_bl_1h(ifirst:ilast,jfirst-1:jlast+1,tape_fyppm_2_fyppm) )
        endif
        tape_fyppm_2_bl_1h(:,:,j-npy+2+1) = bl
        if ( .not. allocated(tape_fyppm_2_br_2h)) then
          allocate( tape_fyppm_2_br_2h(ifirst:ilast,jfirst-1:jlast+1,tape_fyppm_2_fyppm) )
        endif
        tape_fyppm_2_br_2h(:,:,j-npy+2+1) = br

!----------------------------------------------
! ADJOINT COMPUTATIONS
!----------------------------------------------
        do j = npy, npy-2, -1
          bl = tape_fyppm_2_bl_1h(:,:,j-npy+2+1)
          br = tape_fyppm_2_br_2h(:,:,j-npy+2+1)
          help_i = ilast-ifirst+1
          call adpert_ppm( help_i,q(ifirst:ilast,j),adq(ifirst:ilast,j),bl(ifirst:ilast,j),adbl(ifirst:ilast,j),br(ifirst:ilast,j),&
&adbr(ifirst:ilast,j),1 )
        end do

!----------------------------------------------
! CLOSE TAPE tape_fyppm_2
!----------------------------------------------
        if (allocated(tape_fyppm_2_bl_1h)) then
          deallocate( tape_fyppm_2_bl_1h )
        endif
        if (allocated(tape_fyppm_2_br_2h)) then
          deallocate( tape_fyppm_2_br_2h )
        endif

      endif
      do i = ifirst, ilast
        adxt = 0.
        adq(i,npy-1) = adq(i,npy-1)-adbl(i,npy-1)
        adxt = adxt+adbl(i,npy-1)
        adbl(i,npy-1) = 0.
        adq(i,npy-2) = adq(i,npy-2)-adbr(i,npy-2)
        adxt = adxt+adbr(i,npy-2)
        adbr(i,npy-2) = 0.
        addm(i,npy-2) = addm(i,npy-2)+adxt*s14
        adq(i,npy-2) = adq(i,npy-2)+adxt*s11
        adq(i,npy-1) = adq(i,npy-1)+adxt*s15
        adxt = 0.
        adq(i,npy) = adq(i,npy)-adbr(i,npy)
        adxt = adxt+adbr(i,npy)
        adbr(i,npy) = 0.
        addm(i,npy+1) = addm(i,npy+1)-adxt*s14
        addq(i,npy) = addq(i,npy)+adxt*s11
        adq(i,npy) = adq(i,npy)+adxt
        adxt = 0.
        adq(i,npy) = adq(i,npy)-adbl(i,npy)
        adxt = adxt+adbl(i,npy)
        adbl(i,npy) = 0.
        adq(i,npy-1) = adq(i,npy-1)-adbr(i,npy-1)
        adxt = adxt+adbr(i,npy-1)
        adbr(i,npy-1) = 0.
        adq(i,npy-2) = adq(i,npy-2)-adxt*(0.5*dya(i,npy-1)/(dya(i,npy-1)+dya(i,npy-2)))
        adq(i,npy-1) = adq(i,npy-1)+adxt*(0.5*(2.*dya(i,npy-1)+dya(i,npy-2))/(dya(i,npy-1)+dya(i,npy-2)))
        adq(i,npy+1) = adq(i,npy+1)-adxt*(0.5*dya(i,npy-1)/(dya(i,npy-1)+dya(i,npy-2)))
        adq(i,npy) = adq(i,npy)+adxt*(0.5*(2.*dya(i,npy-1)+dya(i,npy-2))/(dya(i,npy-1)+dya(i,npy-2)))
        adxt = 0.
        adal(i,npy-2) = adal(i,npy-2)+adbl(i,npy-2)
        adq(i,npy-2) = adq(i,npy-2)-adbl(i,npy-2)
        adbl(i,npy-2) = 0.
      end do
    endif
    do j = max(3,js-1), min(npy-3,je+1)
      do i = ifirst, ilast
        pmp = -(2.*dq(i,j))
        lac = pmp+1.5*dq(i,j+1)
        bl(i,j) = min(max(0.,pmp,lac),max(al(i,j)-q(i,j),min(0.,pmp,lac)))
        pmp = 2.*dq(i,j-1)
        lac = pmp-1.5*dq(i,j-2)
        br(i,j) = min(max(0.,pmp,lac),max(al(i,j+1)-q(i,j),min(0.,pmp,lac)))
      end do
    end do
    if (js .eq. 1) then
      do i = ifirst, ilast
        br(i,2) = al(i,3)-q(i,2)
        xt = 0.5*((2.*dya(i,1)+dya(i,2))*(q(i,0)+q(i,1))-dya(i,1)*(q(i,-1)+q(i,2)))/(dya(i,1)+dya(i,2))
        bl(i,1) = xt-q(i,1)
        br(i,0) = xt-q(i,0)
        xt = s14*dm(i,-1)-s11*dq(i,-1)+q(i,0)
        bl(i,0) = xt-q(i,0)
        xt = s15*q(i,1)+s11*q(i,2)-s14*dm(i,2)
        br(i,1) = xt-q(i,1)
        bl(i,2) = xt-q(i,2)
      end do
      if (jord .eq. 9) then
!----------------------------------------------
! OPEN TAPE tape_fyppm_1
!----------------------------------------------
        tape_fyppm_1_fyppm = 3

!----------------------------------------------
! TAPE COMPUTATIONS
!----------------------------------------------
        do j = 0, 1
          if ( .not. allocated(tape_fyppm_1_bl_1h)) then
            allocate( tape_fyppm_1_bl_1h(ifirst:ilast,jfirst-1:jlast+1,tape_fyppm_1_fyppm) )
          endif
          tape_fyppm_1_bl_1h(:,:,j+1) = bl
          if ( .not. allocated(tape_fyppm_1_br_2h)) then
            allocate( tape_fyppm_1_br_2h(ifirst:ilast,jfirst-1:jlast+1,tape_fyppm_1_fyppm) )
          endif
          tape_fyppm_1_br_2h(:,:,j+1) = br
          help_h = ilast-ifirst+1
          call pert_ppm( help_h,q(ifirst:ilast,j),bl(ifirst:ilast,j),br(ifirst:ilast,j),1 )
        end do
        j = 2
        if ( .not. allocated(tape_fyppm_1_bl_1h)) then
          allocate( tape_fyppm_1_bl_1h(ifirst:ilast,jfirst-1:jlast+1,tape_fyppm_1_fyppm) )
        endif
        tape_fyppm_1_bl_1h(:,:,j+1) = bl
        if ( .not. allocated(tape_fyppm_1_br_2h)) then
          allocate( tape_fyppm_1_br_2h(ifirst:ilast,jfirst-1:jlast+1,tape_fyppm_1_fyppm) )
        endif
        tape_fyppm_1_br_2h(:,:,j+1) = br

!----------------------------------------------
! ADJOINT COMPUTATIONS
!----------------------------------------------
        do j = 2, 0, -1
          bl = tape_fyppm_1_bl_1h(:,:,j+1)
          br = tape_fyppm_1_br_2h(:,:,j+1)
          help_h = ilast-ifirst+1
          call adpert_ppm( help_h,q(ifirst:ilast,j),adq(ifirst:ilast,j),bl(ifirst:ilast,j),adbl(ifirst:ilast,j),br(ifirst:ilast,j),&
&adbr(ifirst:ilast,j),1 )
        end do

!----------------------------------------------
! CLOSE TAPE tape_fyppm_1
!----------------------------------------------
        if (allocated(tape_fyppm_1_bl_1h)) then
          deallocate( tape_fyppm_1_bl_1h )
        endif
        if (allocated(tape_fyppm_1_br_2h)) then
          deallocate( tape_fyppm_1_br_2h )
        endif

      endif
      do i = ifirst, ilast
        adxt = 0.
        adq(i,2) = adq(i,2)-adbl(i,2)
        adxt = adxt+adbl(i,2)
        adbl(i,2) = 0.
        adq(i,1) = adq(i,1)-adbr(i,1)
        adxt = adxt+adbr(i,1)
        adbr(i,1) = 0.
        addm(i,2) = addm(i,2)-adxt*s14
        adq(i,2) = adq(i,2)+adxt*s11
        adq(i,1) = adq(i,1)+adxt*s15
        adxt = 0.
        adq(i,0) = adq(i,0)-adbl(i,0)
        adxt = adxt+adbl(i,0)
        adbl(i,0) = 0.
        addm(i,-1) = addm(i,-1)+adxt*s14
        addq(i,-1) = addq(i,-1)-adxt*s11
        adq(i,0) = adq(i,0)+adxt
        adxt = 0.
        adq(i,0) = adq(i,0)-adbr(i,0)
        adxt = adxt+adbr(i,0)
        adbr(i,0) = 0.
        adq(i,1) = adq(i,1)-adbl(i,1)
        adxt = adxt+adbl(i,1)
        adbl(i,1) = 0.
        adq(i,-1) = adq(i,-1)-adxt*(0.5*dya(i,1)/(dya(i,1)+dya(i,2)))
        adq(i,2) = adq(i,2)-adxt*(0.5*dya(i,1)/(dya(i,1)+dya(i,2)))
        adq(i,1) = adq(i,1)+adxt*(0.5*(2.*dya(i,1)+dya(i,2))/(dya(i,1)+dya(i,2)))
        adq(i,0) = adq(i,0)+adxt*(0.5*(2.*dya(i,1)+dya(i,2))/(dya(i,1)+dya(i,2)))
        adxt = 0.
        adal(i,3) = adal(i,3)+adbr(i,2)
        adq(i,2) = adq(i,2)-adbr(i,2)
        adbr(i,2) = 0.
      end do
    endif
    do j = max(3,js-1), min(npy-3,je+1)
      adlac = 0.
      adpmp = 0.
      do i = ifirst, ilast
        adlac = 0.
        adpmp = 0.
        pmp = 2.*dq(i,j-1)
        lac = pmp-1.5*dq(i,j-2)
        bry = max(0.,pmp)
        brz = max(bry,lac)
        br1 = min(0.,pmp)
        br2 = min(br1,lac)
        br0 = max(al(i,j+1)-q(i,j),br2)
        adbr2 = adbr(i,j)*(0.5-sign(0.5,br0-brz))
        adbr1 = adbr(i,j)*(0.5+sign(0.5,br0-brz))
        adal(i,j+1) = adal(i,j+1)+adbr2*(0.5+sign(0.5,al(i,j+1)-q(i,j)-br2))
        adbr4 = adbr2*(0.5-sign(0.5,al(i,j+1)-q(i,j)-br2))
        adq(i,j) = adq(i,j)-adbr2*(0.5+sign(0.5,al(i,j+1)-q(i,j)-br2))
        adbr3 = adbr4*(0.5+sign(0.5,lac-br1))
        adlac = adlac+adbr4*(0.5-sign(0.5,lac-br1))
        adpmp = adpmp+adbr3*(0.5-sign(0.5,pmp-0.))
        adbr0 = adbr1*(0.5+sign(0.5,bry-lac))
        adlac = adlac+adbr1*(0.5-sign(0.5,bry-lac))
        adpmp = adpmp+adbr0*(0.5-sign(0.5,0.-pmp))
        adbr(i,j) = 0.
        addq(i,j-2) = addq(i,j-2)-1.5*adlac
        adpmp = adpmp+adlac
        adlac = 0.
        addq(i,j-1) = addq(i,j-1)+2*adpmp
        adpmp = 0.
        pmp = -(2.*dq(i,j))
        lac = pmp+1.5*dq(i,j+1)
        bly = max(0.,pmp)
        blz = max(bly,lac)
        bl1 = min(0.,pmp)
        bl2 = min(bl1,lac)
        bl0 = max(al(i,j)-q(i,j),bl2)
        adbl2 = adbl(i,j)*(0.5-sign(0.5,bl0-blz))
        adbl1 = adbl(i,j)*(0.5+sign(0.5,bl0-blz))
        adal(i,j) = adal(i,j)+adbl2*(0.5+sign(0.5,al(i,j)-q(i,j)-bl2))
        adbl4 = adbl2*(0.5-sign(0.5,al(i,j)-q(i,j)-bl2))
        adq(i,j) = adq(i,j)-adbl2*(0.5+sign(0.5,al(i,j)-q(i,j)-bl2))
        adbl3 = adbl4*(0.5+sign(0.5,lac-bl1))
        adlac = adlac+adbl4*(0.5-sign(0.5,lac-bl1))
        adpmp = adpmp+adbl3*(0.5-sign(0.5,pmp-0.))
        adbl0 = adbl1*(0.5+sign(0.5,bly-lac))
        adlac = adlac+adbl1*(0.5-sign(0.5,bly-lac))
        adpmp = adpmp+adbl0*(0.5-sign(0.5,0.-pmp))
        adbl(i,j) = 0.
        addq(i,j+1) = addq(i,j+1)+1.5*adlac
        adpmp = adpmp+adlac
        adlac = 0.
        addq(i,j) = addq(i,j)-2*adpmp
        adpmp = 0.
      end do
    end do
    do j = js-3, je+2
      do i = ifirst, ilast
        adq(i,j+1) = adq(i,j+1)+addq(i,j)
        adq(i,j) = adq(i,j)-addq(i,j)
        addq(i,j) = 0.
      end do
    end do
    do j = max(3,js-1), min(npy-2,je+2)
      do i = ifirst, ilast
        addm(i,j-1) = addm(i,j-1)+adal(i,j)*r3
        addm(i,j) = addm(i,j)-adal(i,j)*r3
        adq(i,j-1) = adq(i,j-1)+0.5*adal(i,j)
        adq(i,j) = adq(i,j)+0.5*adal(i,j)
        adal(i,j) = 0.
      end do
    end do
  else
    do j = jfirst-1, jlast+1
      adlac = 0.
      adpmp = 0.
      do i = ifirst, ilast
        adlac = 0.
        adpmp = 0.
        pmp = 2.*dq(i,j-1)
        lac = pmp-1.5*dq(i,j-2)
        brs = max(0.,pmp)
        bru = max(brs,lac)
        brw = min(0.,pmp)
        brx = min(brw,lac)
        brv = max(al(i,j+1)-q(i,j),brx)
        adbrw = adbr(i,j)*(0.5+sign(0.5,brv-bru))
        adbrx = adbr(i,j)*(0.5-sign(0.5,brv-bru))
        adal(i,j+1) = adal(i,j+1)+adbrx*(0.5+sign(0.5,al(i,j+1)-q(i,j)-brx))
        adbrz = adbrx*(0.5-sign(0.5,al(i,j+1)-q(i,j)-brx))
        adq(i,j) = adq(i,j)-adbrx*(0.5+sign(0.5,al(i,j+1)-q(i,j)-brx))
        adbry = adbrz*(0.5+sign(0.5,lac-brw))
        adlac = adlac+adbrz*(0.5-sign(0.5,lac-brw))
        adpmp = adpmp+adbry*(0.5-sign(0.5,pmp-0.))
        adbrv = adbrw*(0.5+sign(0.5,brs-lac))
        adlac = adlac+adbrw*(0.5-sign(0.5,brs-lac))
        adpmp = adpmp+adbrv*(0.5-sign(0.5,0.-pmp))
        adbr(i,j) = 0.
        addq(i,j-2) = addq(i,j-2)-1.5*adlac
        adpmp = adpmp+adlac
        adlac = 0.
        addq(i,j-1) = addq(i,j-1)+2*adpmp
        adpmp = 0.
        pmp = -(2.*dq(i,j))
        lac = pmp+1.5*dq(i,j+1)
        bls = max(0.,pmp)
        blu = max(bls,lac)
        blw = min(0.,pmp)
        blx = min(blw,lac)
        blv = max(al(i,j)-q(i,j),blx)
        adblw = adbl(i,j)*(0.5+sign(0.5,blv-blu))
        adblx = adbl(i,j)*(0.5-sign(0.5,blv-blu))
        adal(i,j) = adal(i,j)+adblx*(0.5+sign(0.5,al(i,j)-q(i,j)-blx))
        adblz = adblx*(0.5-sign(0.5,al(i,j)-q(i,j)-blx))
        adq(i,j) = adq(i,j)-adblx*(0.5+sign(0.5,al(i,j)-q(i,j)-blx))
        adbly = adblz*(0.5+sign(0.5,lac-blw))
        adlac = adlac+adblz*(0.5-sign(0.5,lac-blw))
        adpmp = adpmp+adbly*(0.5-sign(0.5,pmp-0.))
        adblv = adblw*(0.5+sign(0.5,bls-lac))
        adlac = adlac+adblw*(0.5-sign(0.5,bls-lac))
        adpmp = adpmp+adblv*(0.5-sign(0.5,0.-pmp))
        adbl(i,j) = 0.
        addq(i,j+1) = addq(i,j+1)+1.5*adlac
        adpmp = adpmp+adlac
        adlac = 0.
        addq(i,j) = addq(i,j)-2*adpmp
        adpmp = 0.
      end do
    end do
    do j = jfirst-3, jlast+2
      do i = ifirst, ilast
        adq(i,j+1) = adq(i,j+1)+addq(i,j)
        adq(i,j) = adq(i,j)-addq(i,j)
        addq(i,j) = 0.
      end do
    end do
    do j = jfirst-1, jlast+2
      do i = ifirst, ilast
        addm(i,j-1) = addm(i,j-1)+adal(i,j)*r3
        addm(i,j) = addm(i,j)-adal(i,j)*r3
        adq(i,j-1) = adq(i,j-1)+0.5*adal(i,j)
        adq(i,j) = adq(i,j)+0.5*adal(i,j)
        adal(i,j) = 0.
      end do
    end do
  endif
  do j = js-2, je+2
    adxt = 0.
    do i = ifirst, ilast
      adxt = 0.
      xt = 0.25*(q(i,j+1)-q(i,j-1))
      dmj = abs(xt)
      dmm = max(q(i,j-1),q(i,j))
      dmq = max(dmm,q(i,j+1))-q(i,j)
      dmr = min(q(i,j-1),q(i,j))
      dmt = q(i,j)-min(dmr,q(i,j+1))
      dmu = min(dmj,dmq)
      addmx = addm(i,j)*sign(1.,min(dmu,dmt))*sign(1.,xt)
      addmv = addmx*(0.5-sign(0.5,dmt-dmu))
      addmw = addmx*(0.5+sign(0.5,dmt-dmu))
      addmj = addmw*(0.5+sign(0.5,dmq-dmj))
      addms = addmw*(0.5-sign(0.5,dmq-dmj))
      addmu = -addmv
      adq(i,j) = adq(i,j)+addmv
      addmt = addmu*(0.5+sign(0.5,q(i,j+1)-dmr))
      adq(i,j+1) = adq(i,j+1)+addmu*(0.5-sign(0.5,q(i,j+1)-dmr))
      adq(i,j-1) = adq(i,j-1)+addmt*(0.5+sign(0.5,q(i,j)-q(i,j-1)))
      adq(i,j) = adq(i,j)+addmt*(0.5-sign(0.5,q(i,j)-q(i,j-1)))
      adq(i,j) = adq(i,j)-addms
      addmq = addms*(0.5+sign(0.5,dmm-q(i,j+1)))
      adq(i,j+1) = adq(i,j+1)+addms*(0.5-sign(0.5,dmm-q(i,j+1)))
      adq(i,j-1) = adq(i,j-1)+addmq*(0.5+sign(0.5,q(i,j-1)-q(i,j)))
      adq(i,j) = adq(i,j)+addmq*(0.5-sign(0.5,q(i,j-1)-q(i,j)))
      adxt = adxt+addmj*sign(1.,xt)
      addm(i,j) = 0.
      adq(i,j-1) = adq(i,j-1)-0.25*adxt
      adq(i,j+1) = adq(i,j+1)+0.25*adxt
      adxt = 0.
    end do
  end do
else
  do j = js-2, je+2
    do i = ifirst, ilast
      xt = 0.25*(q(i,j+1)-q(i,j-1))
      dm(i,j) = sign(min(abs(xt),max(q(i,j-1),q(i,j),q(i,j+1))-q(i,j),q(i,j)-min(q(i,j-1),q(i,j),q(i,j+1))),xt)
    end do
  end do
  if (grid_type .lt. 3) then
    js3 = max(3,js-1)
    je3 = min(npy-3,je+1)
    do j = js3, min(npy-2,je+2)
      do i = ifirst, ilast
        al(i,j) = 0.5*(q(i,j-1)+q(i,j))+r3*(dm(i,j-1)-dm(i,j))
      end do
    end do
    if (jord .eq. 11) then
      do j = js3, je3
        do i = ifirst, ilast
          xt = 2.*dm(i,j)
          bl(i,j) = -sign(min(abs(xt),abs(al(i,j)-q(i,j))),xt)
          br(i,j) = sign(min(abs(xt),abs(al(i,j+1)-q(i,j))),xt)
        end do
      end do
    else if (jord .eq. 12) then
      do j = js-3, je+2
        do i = ifirst, ilast
          dq(i,j) = q(i,j+1)-q(i,j)
        end do
      end do
      do j = js3, je3
        do i = ifirst, ilast
          pmp = -(2.*dq(i,j))
          lac = pmp+1.5*dq(i,j+1)
          bl(i,j) = min(max(0.,pmp,lac),max(al(i,j)-q(i,j),min(0.,pmp,lac)))
          pmp = 2.*dq(i,j-1)
          lac = pmp-1.5*dq(i,j-2)
          br(i,j) = min(max(0.,pmp,lac),max(al(i,j+1)-q(i,j),min(0.,pmp,lac)))
        end do
      end do
    else
      do j = js3, je3
        do i = ifirst, ilast
          bl(i,j) = al(i,j)-q(i,j)
          br(i,j) = al(i,j+1)-q(i,j)
        end do
      end do
    endif
    if (jord .ne. 11) then
      do j = js3, je3
        help_j = ilast-ifirst+1
        call pert_ppm( help_j,q(ifirst:ilast,j),bl(ifirst:ilast,j),br(ifirst:ilast,j),0 )
      end do
    endif
    if (js .eq. 1) then
      do i = ifirst, ilast
        br(i,2) = al(i,3)-q(i,2)
        xt = 0.5*((2.*dya(i,1)+dya(i,2))*(q(i,0)+q(i,1))-dya(i,1)*(q(i,-1)+q(i,2)))/(dya(i,1)+dya(i,2))
        xt = max(0.,xt)
        bl(i,1) = xt-q(i,1)
        br(i,0) = xt-q(i,0)
        xt = 4./7.*dm(i,-1)+11./14.*q(i,-1)+3./14.*q(i,0)
        xt = max(0.,xt)
        bl(i,0) = xt-q(i,0)
        xt = 3./14.*q(i,1)+11./14.*q(i,2)-4./7.*dm(i,2)
        xt = max(0.,xt)
        br(i,1) = xt-q(i,1)
        bl(i,2) = xt-q(i,2)
      end do
      do j = 0, 2
        help_k = ilast-ifirst+1
        call pert_ppm( help_k,q(ifirst:ilast,j),bl(ifirst:ilast,j),br(ifirst:ilast,j),1 )
      end do
    endif
    if (je+1 .eq. npy) then
      do i = ifirst, ilast
        bl(i,npy-2) = al(i,npy-2)-q(i,npy-2)
        xt = 0.5*((2.*dya(i,npy-1)+dya(i,npy-2))*(q(i,npy-1)+q(i,npy))-dya(i,npy-1)*(q(i,npy-2)+q(i,npy+1)))/(dya(i,npy-1)+dya(i,&
&npy-2))
        xt = max(0.,xt)
        br(i,npy-1) = xt-q(i,npy-1)
        bl(i,npy) = xt-q(i,npy)
        xt = 3./14.*q(i,npy)+11./14.*q(i,npy+1)-4./7.*dm(i,npy+1)
        xt = max(0.,xt)
        br(i,npy) = xt-q(i,npy)
        xt = 3./14.*q(i,npy-1)+11./14.*q(i,npy-2)+4./7.*dm(i,npy-2)
        xt = max(0.,xt)
        br(i,npy-2) = xt-q(i,npy-2)
        bl(i,npy-1) = xt-q(i,npy-1)
      end do
      do j = npy-2, npy
        help_l = ilast-ifirst+1
        call pert_ppm( help_l,q(ifirst:ilast,j),bl(ifirst:ilast,j),br(ifirst:ilast,j),1 )
      end do
    endif
  else
    do j = js-1, je+2
      do i = ifirst, ilast
        al(i,j) = 0.5*(q(i,j-1)+q(i,j))+r3*(dm(i,j-1)-dm(i,j))
      end do
    end do
    if (jord .eq. 11) then
      do j = js-1, je+1
        do i = ifirst, ilast
          xt = 2.*dm(i,j)
          bl(i,j) = -sign(min(abs(xt),abs(al(i,j)-q(i,j))),xt)
          br(i,j) = sign(min(abs(xt),abs(al(i,j+1)-q(i,j))),xt)
        end do
      end do
    else if (jord .eq. 12) then
      do j = js-3, je+2
        do i = ifirst, ilast
          dq(i,j) = q(i,j+1)-q(i,j)
        end do
      end do
      do j = js-1, je+1
        do i = ifirst, ilast
          pmp = -(2.*dq(i,j))
          lac = pmp+1.5*dq(i,j+1)
          bl(i,j) = min(max(0.,pmp,lac),max(al(i,j)-q(i,j),min(0.,pmp,lac)))
          pmp = 2.*dq(i,j-1)
          lac = pmp-1.5*dq(i,j-2)
          br(i,j) = min(max(0.,pmp,lac),max(al(i,j+1)-q(i,j),min(0.,pmp,lac)))
        end do
      end do
    else
      do j = js-1, je+1
        do i = ifirst, ilast
          bl(i,j) = al(i,j)-q(i,j)
          br(i,j) = al(i,j+1)-q(i,j)
        end do
      end do
    endif
    if (jord .ne. 11) then
      do j = js-1, je+1
        help_m = ifirst-ilast+1
        call pert_ppm( help_m,q(ifirst:ilast,j),bl(ifirst:ilast,j),br(ifirst:ilast,j),0 )
      end do
    endif
  endif
  do j = js, je+1
    do i = ifirst, ilast
      if (c(i,j) .gt. 0.) then
        adbl(i,j-1) = adbl(i,j-1)-adflux(i,j)*(1.-c(i,j))*c(i,j)
        adbr(i,j-1) = adbr(i,j-1)+adflux(i,j)*(1.-c(i,j))*(1-c(i,j))
        adc(i,j) = adc(i,j)+adflux(i,j)*((-((1.-c(i,j))*(bl(i,j-1)+br(i,j-1))))-(br(i,j-1)-c(i,j)*(bl(i,j-1)+br(i,j-1))))
        adq(i,j-1) = adq(i,j-1)+adflux(i,j)
        adflux(i,j) = 0.
      else
        adbl(i,j) = adbl(i,j)+adflux(i,j)*(1.+c(i,j))*(1+c(i,j))
        adbr(i,j) = adbr(i,j)+adflux(i,j)*(1.+c(i,j))*c(i,j)
        adc(i,j) = adc(i,j)+adflux(i,j)*((1.+c(i,j))*(bl(i,j)+br(i,j))+bl(i,j)+c(i,j)*(bl(i,j)+br(i,j)))
        adq(i,j) = adq(i,j)+adflux(i,j)
        adflux(i,j) = 0.
      endif
    end do
  end do
  if (grid_type .lt. 3) then
    if (je+1 .eq. npy) then
!----------------------------------------------
! OPEN TAPE tape_fyppm_5
!----------------------------------------------
      tape_fyppm_5_fyppm = 3

!----------------------------------------------
! TAPE COMPUTATIONS
!----------------------------------------------
      do j = npy-2, npy-1
        if ( .not. allocated(tape_fyppm_5_bl_1h)) then
          allocate( tape_fyppm_5_bl_1h(ifirst:ilast,jfirst-1:jlast+1,tape_fyppm_5_fyppm) )
        endif
        tape_fyppm_5_bl_1h(:,:,j-npy+2+1) = bl
        if ( .not. allocated(tape_fyppm_5_br_2h)) then
          allocate( tape_fyppm_5_br_2h(ifirst:ilast,jfirst-1:jlast+1,tape_fyppm_5_fyppm) )
        endif
        tape_fyppm_5_br_2h(:,:,j-npy+2+1) = br
        help_l = ilast-ifirst+1
        call pert_ppm( help_l,q(ifirst:ilast,j),bl(ifirst:ilast,j),br(ifirst:ilast,j),1 )
      end do
      j = npy
      if ( .not. allocated(tape_fyppm_5_bl_1h)) then
        allocate( tape_fyppm_5_bl_1h(ifirst:ilast,jfirst-1:jlast+1,tape_fyppm_5_fyppm) )
      endif
      tape_fyppm_5_bl_1h(:,:,j-npy+2+1) = bl
      if ( .not. allocated(tape_fyppm_5_br_2h)) then
        allocate( tape_fyppm_5_br_2h(ifirst:ilast,jfirst-1:jlast+1,tape_fyppm_5_fyppm) )
      endif
      tape_fyppm_5_br_2h(:,:,j-npy+2+1) = br

!----------------------------------------------
! ADJOINT COMPUTATIONS
!----------------------------------------------
      do j = npy, npy-2, -1
        bl = tape_fyppm_5_bl_1h(:,:,j-npy+2+1)
        br = tape_fyppm_5_br_2h(:,:,j-npy+2+1)
        help_l = ilast-ifirst+1
        call adpert_ppm( help_l,q(ifirst:ilast,j),adq(ifirst:ilast,j),bl(ifirst:ilast,j),adbl(ifirst:ilast,j),br(ifirst:ilast,j),&
&adbr(ifirst:ilast,j),1 )
      end do

!----------------------------------------------
! CLOSE TAPE tape_fyppm_5
!----------------------------------------------
      if (allocated(tape_fyppm_5_bl_1h)) then
        deallocate( tape_fyppm_5_bl_1h )
      endif
      if (allocated(tape_fyppm_5_br_2h)) then
        deallocate( tape_fyppm_5_br_2h )
      endif

      do i = ifirst, ilast
        adxt = 0.
        xt = 3./14.*q(i,npy-1)+11./14.*q(i,npy-2)+4./7.*dm(i,npy-2)
        adq(i,npy-1) = adq(i,npy-1)-adbl(i,npy-1)
        adxt = adxt+adbl(i,npy-1)
        adbl(i,npy-1) = 0.
        adq(i,npy-2) = adq(i,npy-2)-adbr(i,npy-2)
        adxt = adxt+adbr(i,npy-2)
        adbr(i,npy-2) = 0.
        adxt = adxt*(0.5-sign(0.5,0.-xt))
        addm(i,npy-2) = addm(i,npy-2)+0.57142857*adxt
        adq(i,npy-2) = adq(i,npy-2)+0.78571429*adxt
        adq(i,npy-1) = adq(i,npy-1)+0.21428571*adxt
        adxt = 0.
        adq(i,npy) = adq(i,npy)-adbr(i,npy)
        adxt = adxt+adbr(i,npy)
        adbr(i,npy) = 0.
        xt = 3./14.*q(i,npy)+11./14.*q(i,npy+1)-4./7.*dm(i,npy+1)
        adxt = adxt*(0.5-sign(0.5,0.-xt))
        addm(i,npy+1) = addm(i,npy+1)-0.57142857*adxt
        adq(i,npy+1) = adq(i,npy+1)+0.78571429*adxt
        adq(i,npy) = adq(i,npy)+0.21428571*adxt
        adxt = 0.
        adq(i,npy) = adq(i,npy)-adbl(i,npy)
        adxt = adxt+adbl(i,npy)
        adbl(i,npy) = 0.
        adq(i,npy-1) = adq(i,npy-1)-adbr(i,npy-1)
        adxt = adxt+adbr(i,npy-1)
        adbr(i,npy-1) = 0.
        xt = 0.5*((2.*dya(i,npy-1)+dya(i,npy-2))*(q(i,npy-1)+q(i,npy))-dya(i,npy-1)*(q(i,npy-2)+q(i,npy+1)))/(dya(i,npy-1)+dya(i,&
&npy-2))
        adxt = adxt*(0.5-sign(0.5,0.-xt))
        adq(i,npy-2) = adq(i,npy-2)-adxt*(0.5*dya(i,npy-1)/(dya(i,npy-1)+dya(i,npy-2)))
        adq(i,npy-1) = adq(i,npy-1)+adxt*(0.5*(2.*dya(i,npy-1)+dya(i,npy-2))/(dya(i,npy-1)+dya(i,npy-2)))
        adq(i,npy+1) = adq(i,npy+1)-adxt*(0.5*dya(i,npy-1)/(dya(i,npy-1)+dya(i,npy-2)))
        adq(i,npy) = adq(i,npy)+adxt*(0.5*(2.*dya(i,npy-1)+dya(i,npy-2))/(dya(i,npy-1)+dya(i,npy-2)))
        adxt = 0.
        adal(i,npy-2) = adal(i,npy-2)+adbl(i,npy-2)
        adq(i,npy-2) = adq(i,npy-2)-adbl(i,npy-2)
        adbl(i,npy-2) = 0.
      end do
    endif
    if (jord .eq. 11) then
      do j = js3, je3
        do i = ifirst, ilast
          xt = 2.*dm(i,j)
          bl(i,j) = -sign(min(abs(xt),abs(al(i,j)-q(i,j))),xt)
          br(i,j) = sign(min(abs(xt),abs(al(i,j+1)-q(i,j))),xt)
        end do
      end do
    else if (jord .eq. 12) then
      do j = js3, je3
        do i = ifirst, ilast
          pmp = -(2.*dq(i,j))
          lac = pmp+1.5*dq(i,j+1)
          bl(i,j) = min(max(0.,pmp,lac),max(al(i,j)-q(i,j),min(0.,pmp,lac)))
          pmp = 2.*dq(i,j-1)
          lac = pmp-1.5*dq(i,j-2)
          br(i,j) = min(max(0.,pmp,lac),max(al(i,j+1)-q(i,j),min(0.,pmp,lac)))
        end do
      end do
    else
      do j = js3, je3
        do i = ifirst, ilast
          bl(i,j) = al(i,j)-q(i,j)
          br(i,j) = al(i,j+1)-q(i,j)
        end do
      end do
    endif
    if (jord .ne. 11) then
      do j = js3, je3
        help_j = ilast-ifirst+1
        call pert_ppm( help_j,q(ifirst:ilast,j),bl(ifirst:ilast,j),br(ifirst:ilast,j),0 )
      end do
    endif
    if (js .eq. 1) then
      do i = ifirst, ilast
        br(i,2) = al(i,3)-q(i,2)
        xt = 0.5*((2.*dya(i,1)+dya(i,2))*(q(i,0)+q(i,1))-dya(i,1)*(q(i,-1)+q(i,2)))/(dya(i,1)+dya(i,2))
        xt = max(0.,xt)
        bl(i,1) = xt-q(i,1)
        br(i,0) = xt-q(i,0)
        xt = 4./7.*dm(i,-1)+11./14.*q(i,-1)+3./14.*q(i,0)
        xt = max(0.,xt)
        bl(i,0) = xt-q(i,0)
        xt = 3./14.*q(i,1)+11./14.*q(i,2)-4./7.*dm(i,2)
        xt = max(0.,xt)
        br(i,1) = xt-q(i,1)
        bl(i,2) = xt-q(i,2)
      end do
!----------------------------------------------
! OPEN TAPE tape_fyppm_4
!----------------------------------------------
      tape_fyppm_4_fyppm = 3

!----------------------------------------------
! TAPE COMPUTATIONS
!----------------------------------------------
      do j = 0, 1
        if ( .not. allocated(tape_fyppm_4_bl_1h)) then
          allocate( tape_fyppm_4_bl_1h(ifirst:ilast,jfirst-1:jlast+1,tape_fyppm_4_fyppm) )
        endif
        tape_fyppm_4_bl_1h(:,:,j+1) = bl
        if ( .not. allocated(tape_fyppm_4_br_2h)) then
          allocate( tape_fyppm_4_br_2h(ifirst:ilast,jfirst-1:jlast+1,tape_fyppm_4_fyppm) )
        endif
        tape_fyppm_4_br_2h(:,:,j+1) = br
        help_k = ilast-ifirst+1
        call pert_ppm( help_k,q(ifirst:ilast,j),bl(ifirst:ilast,j),br(ifirst:ilast,j),1 )
      end do
      j = 2
      if ( .not. allocated(tape_fyppm_4_bl_1h)) then
        allocate( tape_fyppm_4_bl_1h(ifirst:ilast,jfirst-1:jlast+1,tape_fyppm_4_fyppm) )
      endif
      tape_fyppm_4_bl_1h(:,:,j+1) = bl
      if ( .not. allocated(tape_fyppm_4_br_2h)) then
        allocate( tape_fyppm_4_br_2h(ifirst:ilast,jfirst-1:jlast+1,tape_fyppm_4_fyppm) )
      endif
      tape_fyppm_4_br_2h(:,:,j+1) = br

!----------------------------------------------
! ADJOINT COMPUTATIONS
!----------------------------------------------
      do j = 2, 0, -1
        bl = tape_fyppm_4_bl_1h(:,:,j+1)
        br = tape_fyppm_4_br_2h(:,:,j+1)
        help_k = ilast-ifirst+1
        call adpert_ppm( help_k,q(ifirst:ilast,j),adq(ifirst:ilast,j),bl(ifirst:ilast,j),adbl(ifirst:ilast,j),br(ifirst:ilast,j),&
&adbr(ifirst:ilast,j),1 )
      end do

!----------------------------------------------
! CLOSE TAPE tape_fyppm_4
!----------------------------------------------
      if (allocated(tape_fyppm_4_bl_1h)) then
        deallocate( tape_fyppm_4_bl_1h )
      endif
      if (allocated(tape_fyppm_4_br_2h)) then
        deallocate( tape_fyppm_4_br_2h )
      endif

      do i = ifirst, ilast
        adxt = 0.
        xt = 3./14.*q(i,1)+11./14.*q(i,2)-4./7.*dm(i,2)
        adq(i,2) = adq(i,2)-adbl(i,2)
        adxt = adxt+adbl(i,2)
        adbl(i,2) = 0.
        adq(i,1) = adq(i,1)-adbr(i,1)
        adxt = adxt+adbr(i,1)
        adbr(i,1) = 0.
        adxt = adxt*(0.5-sign(0.5,0.-xt))
        addm(i,2) = addm(i,2)-0.57142857*adxt
        adq(i,2) = adq(i,2)+0.78571429*adxt
        adq(i,1) = adq(i,1)+0.21428571*adxt
        adxt = 0.
        adq(i,0) = adq(i,0)-adbl(i,0)
        adxt = adxt+adbl(i,0)
        adbl(i,0) = 0.
        xt = 4./7.*dm(i,-1)+11./14.*q(i,-1)+3./14.*q(i,0)
        adxt = adxt*(0.5-sign(0.5,0.-xt))
        addm(i,-1) = addm(i,-1)+0.57142857*adxt
        adq(i,-1) = adq(i,-1)+0.78571429*adxt
        adq(i,0) = adq(i,0)+0.21428571*adxt
        adxt = 0.
        adq(i,0) = adq(i,0)-adbr(i,0)
        adxt = adxt+adbr(i,0)
        adbr(i,0) = 0.
        adq(i,1) = adq(i,1)-adbl(i,1)
        adxt = adxt+adbl(i,1)
        adbl(i,1) = 0.
        xt = 0.5*((2.*dya(i,1)+dya(i,2))*(q(i,0)+q(i,1))-dya(i,1)*(q(i,-1)+q(i,2)))/(dya(i,1)+dya(i,2))
        adxt = adxt*(0.5-sign(0.5,0.-xt))
        adq(i,-1) = adq(i,-1)-adxt*(0.5*dya(i,1)/(dya(i,1)+dya(i,2)))
        adq(i,2) = adq(i,2)-adxt*(0.5*dya(i,1)/(dya(i,1)+dya(i,2)))
        adq(i,1) = adq(i,1)+adxt*(0.5*(2.*dya(i,1)+dya(i,2))/(dya(i,1)+dya(i,2)))
        adq(i,0) = adq(i,0)+adxt*(0.5*(2.*dya(i,1)+dya(i,2))/(dya(i,1)+dya(i,2)))
        adxt = 0.
        adal(i,3) = adal(i,3)+adbr(i,2)
        adq(i,2) = adq(i,2)-adbr(i,2)
        adbr(i,2) = 0.
      end do
    endif
    if (jord .eq. 11) then
      do j = js3, je3
        do i = ifirst, ilast
          xt = 2.*dm(i,j)
          bl(i,j) = -sign(min(abs(xt),abs(al(i,j)-q(i,j))),xt)
          br(i,j) = sign(min(abs(xt),abs(al(i,j+1)-q(i,j))),xt)
        end do
      end do
    else if (jord .eq. 12) then
      do j = js3, je3
        do i = ifirst, ilast
          pmp = -(2.*dq(i,j))
          lac = pmp+1.5*dq(i,j+1)
          bl(i,j) = min(max(0.,pmp,lac),max(al(i,j)-q(i,j),min(0.,pmp,lac)))
          pmp = 2.*dq(i,j-1)
          lac = pmp-1.5*dq(i,j-2)
          br(i,j) = min(max(0.,pmp,lac),max(al(i,j+1)-q(i,j),min(0.,pmp,lac)))
        end do
      end do
    else
      do j = js3, je3
        do i = ifirst, ilast
          bl(i,j) = al(i,j)-q(i,j)
          br(i,j) = al(i,j+1)-q(i,j)
        end do
      end do
    endif
    if (jord .ne. 11) then
!----------------------------------------------
! OPEN TAPE tape_fyppm_3
!----------------------------------------------
      tape_fyppm_3_fyppm = je3-js3+1

!----------------------------------------------
! TAPE COMPUTATIONS
!----------------------------------------------
      do j = js3, je3-1
        if ( .not. allocated(tape_fyppm_3_bl_1h)) then
          allocate( tape_fyppm_3_bl_1h(ifirst:ilast,jfirst-1:jlast+1,tape_fyppm_3_fyppm) )
        endif
        tape_fyppm_3_bl_1h(:,:,j-js3+1) = bl
        if ( .not. allocated(tape_fyppm_3_br_2h)) then
          allocate( tape_fyppm_3_br_2h(ifirst:ilast,jfirst-1:jlast+1,tape_fyppm_3_fyppm) )
        endif
        tape_fyppm_3_br_2h(:,:,j-js3+1) = br
        help_j = ilast-ifirst+1
        call pert_ppm( help_j,q(ifirst:ilast,j),bl(ifirst:ilast,j),br(ifirst:ilast,j),0 )
      end do
      j = je3
      if ( .not. allocated(tape_fyppm_3_bl_1h)) then
        allocate( tape_fyppm_3_bl_1h(ifirst:ilast,jfirst-1:jlast+1,tape_fyppm_3_fyppm) )
      endif
      tape_fyppm_3_bl_1h(:,:,j-js3+1) = bl
      if ( .not. allocated(tape_fyppm_3_br_2h)) then
        allocate( tape_fyppm_3_br_2h(ifirst:ilast,jfirst-1:jlast+1,tape_fyppm_3_fyppm) )
      endif
      tape_fyppm_3_br_2h(:,:,j-js3+1) = br

!----------------------------------------------
! ADJOINT COMPUTATIONS
!----------------------------------------------
      do j = je3, js3, -1
        bl = tape_fyppm_3_bl_1h(:,:,j-js3+1)
        br = tape_fyppm_3_br_2h(:,:,j-js3+1)
        help_j = ilast-ifirst+1
        call adpert_ppm( help_j,q(ifirst:ilast,j),adq(ifirst:ilast,j),bl(ifirst:ilast,j),adbl(ifirst:ilast,j),br(ifirst:ilast,j),&
&adbr(ifirst:ilast,j),0 )
      end do

!----------------------------------------------
! CLOSE TAPE tape_fyppm_3
!----------------------------------------------
      if (allocated(tape_fyppm_3_bl_1h)) then
        deallocate( tape_fyppm_3_bl_1h )
      endif
      if (allocated(tape_fyppm_3_br_2h)) then
        deallocate( tape_fyppm_3_br_2h )
      endif

    endif
    if (jord .eq. 11) then
      do j = js3, je3
        adxt = 0.
        do i = ifirst, ilast
          adxt = 0.
          xt = 2.*dm(i,j)
          brt = al(i,j+1)-q(i,j)
          adbrt = adbr(i,j)*sign(1.,min(abs(xt),abs(brt)))*sign(1.,xt)
          adbru = adbrt*(0.5-sign(0.5,abs(brt)-abs(xt)))*sign(1.,brt)
          adxt = adxt+adbrt*(0.5+sign(0.5,abs(brt)-abs(xt)))*sign(1.,xt)
          adal(i,j+1) = adal(i,j+1)+adbru
          adq(i,j) = adq(i,j)-adbru
          adbr(i,j) = 0.
          blt = al(i,j)-q(i,j)
          adblt = -(adbl(i,j)*sign(1.,min(abs(xt),abs(blt)))*sign(1.,xt))
          adblu = adblt*(0.5-sign(0.5,abs(blt)-abs(xt)))*sign(1.,blt)
          adxt = adxt+adblt*(0.5+sign(0.5,abs(blt)-abs(xt)))*sign(1.,xt)
          adal(i,j) = adal(i,j)+adblu
          adq(i,j) = adq(i,j)-adblu
          adbl(i,j) = 0.
          addm(i,j) = addm(i,j)+2*adxt
          adxt = 0.
        end do
      end do
    else if (jord .eq. 12) then
      do j = js3, je3
        adlac = 0.
        adpmp = 0.
        do i = ifirst, ilast
          adlac = 0.
          adpmp = 0.
          pmp = 2.*dq(i,j-1)
          lac = pmp-1.5*dq(i,j-2)
          brm = max(0.,pmp)
          bro = max(brm,lac)
          brq = min(0.,pmp)
          brr = min(brq,lac)
          brp = max(al(i,j+1)-q(i,j),brr)
          adbrp = adbr(i,j)*(0.5+sign(0.5,brp-bro))
          adbrq = adbr(i,j)*(0.5-sign(0.5,brp-bro))
          adal(i,j+1) = adal(i,j+1)+adbrq*(0.5+sign(0.5,al(i,j+1)-q(i,j)-brr))
          adbrs = adbrq*(0.5-sign(0.5,al(i,j+1)-q(i,j)-brr))
          adq(i,j) = adq(i,j)-adbrq*(0.5+sign(0.5,al(i,j+1)-q(i,j)-brr))
          adbrr = adbrs*(0.5+sign(0.5,lac-brq))
          adlac = adlac+adbrs*(0.5-sign(0.5,lac-brq))
          adpmp = adpmp+adbrr*(0.5-sign(0.5,pmp-0.))
          adbro = adbrp*(0.5+sign(0.5,brm-lac))
          adlac = adlac+adbrp*(0.5-sign(0.5,brm-lac))
          adpmp = adpmp+adbro*(0.5-sign(0.5,0.-pmp))
          adbr(i,j) = 0.
          addq(i,j-2) = addq(i,j-2)-1.5*adlac
          adpmp = adpmp+adlac
          adlac = 0.
          addq(i,j-1) = addq(i,j-1)+2*adpmp
          adpmp = 0.
          pmp = -(2.*dq(i,j))
          lac = pmp+1.5*dq(i,j+1)
          blm = max(0.,pmp)
          blo = max(blm,lac)
          blq = min(0.,pmp)
          blr = min(blq,lac)
          blp = max(al(i,j)-q(i,j),blr)
          adblp = adbl(i,j)*(0.5+sign(0.5,blp-blo))
          adblq = adbl(i,j)*(0.5-sign(0.5,blp-blo))
          adal(i,j) = adal(i,j)+adblq*(0.5+sign(0.5,al(i,j)-q(i,j)-blr))
          adbls = adblq*(0.5-sign(0.5,al(i,j)-q(i,j)-blr))
          adq(i,j) = adq(i,j)-adblq*(0.5+sign(0.5,al(i,j)-q(i,j)-blr))
          adblr = adbls*(0.5+sign(0.5,lac-blq))
          adlac = adlac+adbls*(0.5-sign(0.5,lac-blq))
          adpmp = adpmp+adblr*(0.5-sign(0.5,pmp-0.))
          adblo = adblp*(0.5+sign(0.5,blm-lac))
          adlac = adlac+adblp*(0.5-sign(0.5,blm-lac))
          adpmp = adpmp+adblo*(0.5-sign(0.5,0.-pmp))
          adbl(i,j) = 0.
          addq(i,j+1) = addq(i,j+1)+1.5*adlac
          adpmp = adpmp+adlac
          adlac = 0.
          addq(i,j) = addq(i,j)-2*adpmp
          adpmp = 0.
        end do
      end do
      do j = js-3, je+2
        do i = ifirst, ilast
          adq(i,j+1) = adq(i,j+1)+addq(i,j)
          adq(i,j) = adq(i,j)-addq(i,j)
          addq(i,j) = 0.
        end do
      end do
    else
      do j = js3, je3
        do i = ifirst, ilast
          adal(i,j+1) = adal(i,j+1)+adbr(i,j)
          adq(i,j) = adq(i,j)-adbr(i,j)
          adbr(i,j) = 0.
          adal(i,j) = adal(i,j)+adbl(i,j)
          adq(i,j) = adq(i,j)-adbl(i,j)
          adbl(i,j) = 0.
        end do
      end do
    endif
    do j = js3, min(npy-2,je+2)
      do i = ifirst, ilast
        addm(i,j-1) = addm(i,j-1)+adal(i,j)*r3
        addm(i,j) = addm(i,j)-adal(i,j)*r3
        adq(i,j-1) = adq(i,j-1)+0.5*adal(i,j)
        adq(i,j) = adq(i,j)+0.5*adal(i,j)
        adal(i,j) = 0.
      end do
    end do
  else
    if (jord .eq. 11) then
      do j = js-1, je+1
        do i = ifirst, ilast
          xt = 2.*dm(i,j)
          bl(i,j) = -sign(min(abs(xt),abs(al(i,j)-q(i,j))),xt)
          br(i,j) = sign(min(abs(xt),abs(al(i,j+1)-q(i,j))),xt)
        end do
      end do
    else if (jord .eq. 12) then
      do j = js-1, je+1
        do i = ifirst, ilast
          pmp = -(2.*dq(i,j))
          lac = pmp+1.5*dq(i,j+1)
          bl(i,j) = min(max(0.,pmp,lac),max(al(i,j)-q(i,j),min(0.,pmp,lac)))
          pmp = 2.*dq(i,j-1)
          lac = pmp-1.5*dq(i,j-2)
          br(i,j) = min(max(0.,pmp,lac),max(al(i,j+1)-q(i,j),min(0.,pmp,lac)))
        end do
      end do
    else
      do j = js-1, je+1
        do i = ifirst, ilast
          bl(i,j) = al(i,j)-q(i,j)
          br(i,j) = al(i,j+1)-q(i,j)
        end do
      end do
    endif
    if (jord .ne. 11) then
!----------------------------------------------
! OPEN TAPE tape_fyppm_6
!----------------------------------------------
      tape_fyppm_6_fyppm = je-js+3

!----------------------------------------------
! TAPE COMPUTATIONS
!----------------------------------------------
      do j = js-1, je
        if ( .not. allocated(tape_fyppm_6_bl_1h)) then
          allocate( tape_fyppm_6_bl_1h(ifirst:ilast,jfirst-1:jlast+1,tape_fyppm_6_fyppm) )
        endif
        tape_fyppm_6_bl_1h(:,:,j-js+1+1) = bl
        if ( .not. allocated(tape_fyppm_6_br_2h)) then
          allocate( tape_fyppm_6_br_2h(ifirst:ilast,jfirst-1:jlast+1,tape_fyppm_6_fyppm) )
        endif
        tape_fyppm_6_br_2h(:,:,j-js+1+1) = br
        help_m = ifirst-ilast+1
        call pert_ppm( help_m,q(ifirst:ilast,j),bl(ifirst:ilast,j),br(ifirst:ilast,j),0 )
      end do
      j = je+1
      if ( .not. allocated(tape_fyppm_6_bl_1h)) then
        allocate( tape_fyppm_6_bl_1h(ifirst:ilast,jfirst-1:jlast+1,tape_fyppm_6_fyppm) )
      endif
      tape_fyppm_6_bl_1h(:,:,j-js+1+1) = bl
      if ( .not. allocated(tape_fyppm_6_br_2h)) then
        allocate( tape_fyppm_6_br_2h(ifirst:ilast,jfirst-1:jlast+1,tape_fyppm_6_fyppm) )
      endif
      tape_fyppm_6_br_2h(:,:,j-js+1+1) = br

!----------------------------------------------
! ADJOINT COMPUTATIONS
!----------------------------------------------
      do j = je+1, js-1, -1
        bl = tape_fyppm_6_bl_1h(:,:,j-js+1+1)
        br = tape_fyppm_6_br_2h(:,:,j-js+1+1)
        help_m = ifirst-ilast+1
        call adpert_ppm( help_m,q(ifirst:ilast,j),adq(ifirst:ilast,j),bl(ifirst:ilast,j),adbl(ifirst:ilast,j),br(ifirst:ilast,j),&
&adbr(ifirst:ilast,j),0 )
      end do

!----------------------------------------------
! CLOSE TAPE tape_fyppm_6
!----------------------------------------------
      if (allocated(tape_fyppm_6_bl_1h)) then
        deallocate( tape_fyppm_6_bl_1h )
      endif
      if (allocated(tape_fyppm_6_br_2h)) then
        deallocate( tape_fyppm_6_br_2h )
      endif

    endif
    if (jord .eq. 11) then
      do j = js-1, je+1
        adxt = 0.
        do i = ifirst, ilast
          adxt = 0.
          xt = 2.*dm(i,j)
          brn = al(i,j+1)-q(i,j)
          adbrm = adbr(i,j)*sign(1.,min(abs(xt),abs(brn)))*sign(1.,xt)
          adbrn = adbrm*(0.5-sign(0.5,abs(brn)-abs(xt)))*sign(1.,brn)
          adxt = adxt+adbrm*(0.5+sign(0.5,abs(brn)-abs(xt)))*sign(1.,xt)
          adal(i,j+1) = adal(i,j+1)+adbrn
          adq(i,j) = adq(i,j)-adbrn
          adbr(i,j) = 0.
          bln = al(i,j)-q(i,j)
          adblm = -(adbl(i,j)*sign(1.,min(abs(xt),abs(bln)))*sign(1.,xt))
          adbln = adblm*(0.5-sign(0.5,abs(bln)-abs(xt)))*sign(1.,bln)
          adxt = adxt+adblm*(0.5+sign(0.5,abs(bln)-abs(xt)))*sign(1.,xt)
          adal(i,j) = adal(i,j)+adbln
          adq(i,j) = adq(i,j)-adbln
          adbl(i,j) = 0.
          addm(i,j) = addm(i,j)+2*adxt
          adxt = 0.
        end do
      end do
    else if (jord .eq. 12) then
      do j = js-1, je+1
        adlac = 0.
        adpmp = 0.
        do i = ifirst, ilast
          adlac = 0.
          adpmp = 0.
          pmp = 2.*dq(i,j-1)
          lac = pmp-1.5*dq(i,j-2)
          brh = max(0.,pmp)
          bri = max(brh,lac)
          brk = min(0.,pmp)
          brl = min(brk,lac)
          brj = max(al(i,j+1)-q(i,j),brl)
          adbri = adbr(i,j)*(0.5+sign(0.5,brj-bri))
          adbrj = adbr(i,j)*(0.5-sign(0.5,brj-bri))
          adal(i,j+1) = adal(i,j+1)+adbrj*(0.5+sign(0.5,al(i,j+1)-q(i,j)-brl))
          adbrl = adbrj*(0.5-sign(0.5,al(i,j+1)-q(i,j)-brl))
          adq(i,j) = adq(i,j)-adbrj*(0.5+sign(0.5,al(i,j+1)-q(i,j)-brl))
          adbrk = adbrl*(0.5+sign(0.5,lac-brk))
          adlac = adlac+adbrl*(0.5-sign(0.5,lac-brk))
          adpmp = adpmp+adbrk*(0.5-sign(0.5,pmp-0.))
          adbrh = adbri*(0.5+sign(0.5,brh-lac))
          adlac = adlac+adbri*(0.5-sign(0.5,brh-lac))
          adpmp = adpmp+adbrh*(0.5-sign(0.5,0.-pmp))
          adbr(i,j) = 0.
          addq(i,j-2) = addq(i,j-2)-1.5*adlac
          adpmp = adpmp+adlac
          adlac = 0.
          addq(i,j-1) = addq(i,j-1)+2*adpmp
          adpmp = 0.
          pmp = -(2.*dq(i,j))
          lac = pmp+1.5*dq(i,j+1)
          blh = max(0.,pmp)
          bli = max(blh,lac)
          blk = min(0.,pmp)
          bll = min(blk,lac)
          blj = max(al(i,j)-q(i,j),bll)
          adbli = adbl(i,j)*(0.5+sign(0.5,blj-bli))
          adblj = adbl(i,j)*(0.5-sign(0.5,blj-bli))
          adal(i,j) = adal(i,j)+adblj*(0.5+sign(0.5,al(i,j)-q(i,j)-bll))
          adbll = adblj*(0.5-sign(0.5,al(i,j)-q(i,j)-bll))
          adq(i,j) = adq(i,j)-adblj*(0.5+sign(0.5,al(i,j)-q(i,j)-bll))
          adblk = adbll*(0.5+sign(0.5,lac-blk))
          adlac = adlac+adbll*(0.5-sign(0.5,lac-blk))
          adpmp = adpmp+adblk*(0.5-sign(0.5,pmp-0.))
          adblh = adbli*(0.5+sign(0.5,blh-lac))
          adlac = adlac+adbli*(0.5-sign(0.5,blh-lac))
          adpmp = adpmp+adblh*(0.5-sign(0.5,0.-pmp))
          adbl(i,j) = 0.
          addq(i,j+1) = addq(i,j+1)+1.5*adlac
          adpmp = adpmp+adlac
          adlac = 0.
          addq(i,j) = addq(i,j)-2*adpmp
          adpmp = 0.
        end do
      end do
      do j = js-3, je+2
        do i = ifirst, ilast
          adq(i,j+1) = adq(i,j+1)+addq(i,j)
          adq(i,j) = adq(i,j)-addq(i,j)
          addq(i,j) = 0.
        end do
      end do
    else
      do j = js-1, je+1
        do i = ifirst, ilast
          adal(i,j+1) = adal(i,j+1)+adbr(i,j)
          adq(i,j) = adq(i,j)-adbr(i,j)
          adbr(i,j) = 0.
          adal(i,j) = adal(i,j)+adbl(i,j)
          adq(i,j) = adq(i,j)-adbl(i,j)
          adbl(i,j) = 0.
        end do
      end do
    endif
    do j = js-1, je+2
      do i = ifirst, ilast
        addm(i,j-1) = addm(i,j-1)+adal(i,j)*r3
        addm(i,j) = addm(i,j)-adal(i,j)*r3
        adq(i,j-1) = adq(i,j-1)+0.5*adal(i,j)
        adq(i,j) = adq(i,j)+0.5*adal(i,j)
        adal(i,j) = 0.
      end do
    end do
  endif
  do j = js-2, je+2
    adxt = 0.
    do i = ifirst, ilast
      adxt = 0.
      xt = 0.25*(q(i,j+1)-q(i,j-1))
      dmh = abs(xt)
      dmi = max(q(i,j-1),q(i,j))
      dmk = max(dmi,q(i,j+1))-q(i,j)
      dml = min(q(i,j-1),q(i,j))
      dmn = q(i,j)-min(dml,q(i,j+1))
      dmo = min(dmh,dmk)
      addmp = addm(i,j)*sign(1.,min(dmo,dmn))*sign(1.,xt)
      addmn = addmp*(0.5-sign(0.5,dmn-dmo))
      addmo = addmp*(0.5+sign(0.5,dmn-dmo))
      addmh = addmo*(0.5+sign(0.5,dmk-dmh))
      addmk = addmo*(0.5-sign(0.5,dmk-dmh))
      addmm = -addmn
      adq(i,j) = adq(i,j)+addmn
      addml = addmm*(0.5+sign(0.5,q(i,j+1)-dml))
      adq(i,j+1) = adq(i,j+1)+addmm*(0.5-sign(0.5,q(i,j+1)-dml))
      adq(i,j-1) = adq(i,j-1)+addml*(0.5+sign(0.5,q(i,j)-q(i,j-1)))
      adq(i,j) = adq(i,j)+addml*(0.5-sign(0.5,q(i,j)-q(i,j-1)))
      adq(i,j) = adq(i,j)-addmk
      addmi = addmk*(0.5+sign(0.5,dmi-q(i,j+1)))
      adq(i,j+1) = adq(i,j+1)+addmk*(0.5-sign(0.5,dmi-q(i,j+1)))
      adq(i,j-1) = adq(i,j-1)+addmi*(0.5+sign(0.5,q(i,j-1)-q(i,j)))
      adq(i,j) = adq(i,j)+addmi*(0.5-sign(0.5,q(i,j-1)-q(i,j)))
      adxt = adxt+addmh*sign(1.,xt)
      addm(i,j) = 0.
      adq(i,j-1) = adq(i,j-1)-0.25*adxt
      adq(i,j+1) = adq(i,j+1)+0.25*adxt
      adxt = 0.
    end do
  end do
endif

end subroutine adfyppm


subroutine adpert_ppm( im, a0, ada0, al, adal, ar, adar, iv )
!******************************************************************
!******************************************************************
!** This routine was generated by Automatic differentiation.     **
!** FastOpt: Transformation of Algorithm in Fortran, TAF 1.9.43  **
!******************************************************************
!******************************************************************
!==============================================
! all entries are defined explicitly
!==============================================
implicit none

!==============================================
! declare parameters
!==============================================
real, parameter :: r12 = 1./12.

!==============================================
! declare arguments
!==============================================
integer, intent(in) :: im
real, intent(in) :: a0(im)
real, intent(inout) :: ada0(im)
real, intent(inout) :: adal(im)
real, intent(inout) :: adar(im)
real, intent(inout) :: al(im)
real, intent(inout) :: ar(im)
integer, intent(in) :: iv

!==============================================
! declare local variables
!==============================================
real :: a4
real :: a6da
real :: ada4
real :: ada6da
real :: adda1
real :: adda2
real :: adfmin
real :: da1
real :: da2
real :: fmin
integer :: i

!----------------------------------------------
! RESET LOCAL ADJOINT VARIABLES
!----------------------------------------------
ada4 = 0.
ada6da = 0.
adda1 = 0.
adda2 = 0.
adfmin = 0.

!----------------------------------------------
! ROUTINE BODY
!----------------------------------------------
if (iv .eq. 0) then
  do i = 1, im
    ada4 = 0.
    adda1 = 0.
    adfmin = 0.
    a4 = -(3.*(ar(i)+al(i)))
    da1 = ar(i)-al(i)
    if (abs(da1) .lt. (-a4)) then
      fmin = a0(i)+0.25/a4*da1**2+a4*r12
      if (fmin .lt. 0.) then
        if (ar(i) .gt. 0. .and. al(i) .gt. 0.) then
          adal(i) = 0.
          adar(i) = 0.
        else if (da1 .gt. 0.) then
          adal(i) = adal(i)-2*adar(i)
          adar(i) = 0.
        else
          adar(i) = adar(i)-2*adal(i)
          adal(i) = 0.
        endif
      endif
      ada0(i) = ada0(i)+adfmin
      ada4 = ada4+adfmin*((-(0.25/(a4*a4)*da1**2))+r12)
      adda1 = adda1+2*adfmin*0.25/a4*da1
      adfmin = 0.
    endif
    adal(i) = adal(i)-adda1
    adar(i) = adar(i)+adda1
    adda1 = 0.
    adal(i) = adal(i)-3*ada4
    adar(i) = adar(i)-3*ada4
    ada4 = 0.
  end do
else
  do i = 1, im
    ada6da = 0.
    adda1 = 0.
    adda2 = 0.
    if (al(i)*ar(i) .lt. 0.) then
      da1 = al(i)-ar(i)
      da2 = da1**2
      a6da = 3.*(al(i)+ar(i))*da1
      if (a6da .lt. (-da2)) then
        adal(i) = adal(i)-2*adar(i)
        adar(i) = 0.
      else if (a6da .gt. da2) then
        adar(i) = adar(i)-2*adal(i)
        adal(i) = 0.
      endif
      adal(i) = adal(i)+3*ada6da*da1
      adar(i) = adar(i)+3*ada6da*da1
      adda1 = adda1+3*ada6da*(al(i)+ar(i))
      ada6da = 0.
      adda1 = adda1+2*adda2*da1
      adda2 = 0.
      adal(i) = adal(i)+adda1
      adar(i) = adar(i)-adda1
      adda1 = 0.
    else
      adar(i) = 0.
      adal(i) = 0.
    endif
  end do
endif

end subroutine adpert_ppm


subroutine adxmist_2d( q, adq, dm, addm, ng, iord, ifirst, ilast, jfirst, jlast )
!******************************************************************
!******************************************************************
!** This routine was generated by Automatic differentiation.     **
!** FastOpt: Transformation of Algorithm in Fortran, TAF 1.9.43  **
!******************************************************************
!******************************************************************
!==============================================
! all entries are defined explicitly
!==============================================
implicit none

!==============================================
! declare arguments
!==============================================
integer, intent(in) :: ifirst
integer, intent(in) :: ilast
integer, intent(in) :: jfirst
integer, intent(in) :: jlast
integer, intent(in) :: ng
real, intent(inout) :: addm(ifirst-ng:ilast+ng,jfirst:jlast)
real, intent(inout) :: adq(ifirst-ng:ilast+ng,jfirst:jlast)
real, intent(inout) :: dm(ifirst-ng:ilast+ng,jfirst:jlast)
integer, intent(in) :: iord
real, intent(in) :: q(ifirst-ng:ilast+ng,jfirst:jlast)

!==============================================
! declare local variables
!==============================================
real :: addmh
real :: addmi
real :: addmj
real :: adqmax
real :: adqmaxi
real :: adqmin
real :: adqminh
real :: adqmini
real :: dmh
real :: dmi
integer :: i
integer :: j
real :: qmax
real :: qmaxi
real :: qmin
real :: qmini

!----------------------------------------------
! RESET LOCAL ADJOINT VARIABLES
!----------------------------------------------
adqmax = 0.
adqmin = 0.

!----------------------------------------------
! ROUTINE BODY
!----------------------------------------------
do j = jfirst, jlast
  do i = ifirst-ng+1, ilast+ng-1
    dm(i,j) = 0.25*(q(i+1,j)-q(i-1,j))
  end do
end do
if (iord .gt. 0) then
  do j = jfirst, jlast
    adqmax = 0.
    adqmin = 0.
    do i = ifirst-ng+1, ilast+ng-1
      adqmax = 0.
      adqmin = 0.
      qmax = max(max(q(i-1,j),q(i,j)),q(i+1,j))-q(i,j)
      qmin = q(i,j)-min(min(q(i-1,j),q(i,j)),q(i+1,j))
      dmh = abs(dm(i,j))
      dmi = min(dmh,qmin)
      addmj = addm(i,j)*sign(1.,min(dmi,qmax))*sign(1.,dm(i,j))
      addmi = addmj*(0.5+sign(0.5,qmax-dmi))
      adqmax = adqmax+addmj*(0.5-sign(0.5,qmax-dmi))
      addmh = addmi*(0.5+sign(0.5,qmin-dmh))
      adqmin = adqmin+addmi*(0.5-sign(0.5,qmin-dmh))
      addm(i,j) = addmh*sign(1.,dm(i,j))
      qmini = min(q(i-1,j),q(i,j))
      adq(i,j) = adq(i,j)+adqmin
      adqminh = -adqmin
      adq(i+1,j) = adq(i+1,j)+adqminh*(0.5-sign(0.5,q(i+1,j)-qmini))
      adqmini = adqminh*(0.5+sign(0.5,q(i+1,j)-qmini))
      adq(i-1,j) = adq(i-1,j)+adqmini*(0.5+sign(0.5,q(i,j)-q(i-1,j)))
      adq(i,j) = adq(i,j)+adqmini*(0.5-sign(0.5,q(i,j)-q(i-1,j)))
      adqmin = 0.
      qmaxi = max(q(i-1,j),q(i,j))
      adq(i,j) = adq(i,j)-adqmax
      adq(i+1,j) = adq(i+1,j)+adqmax*(0.5-sign(0.5,qmaxi-q(i+1,j)))
      adqmaxi = adqmax*(0.5+sign(0.5,qmaxi-q(i+1,j)))
      adq(i-1,j) = adq(i-1,j)+adqmaxi*(0.5+sign(0.5,q(i-1,j)-q(i,j)))
      adq(i,j) = adq(i,j)+adqmaxi*(0.5-sign(0.5,q(i-1,j)-q(i,j)))
      adqmax = 0.
    end do
  end do
endif
do j = jfirst, jlast
  do i = ifirst-ng+1, ilast+ng-1
    adq(i-1,j) = adq(i-1,j)-0.25*addm(i,j)
    adq(i+1,j) = adq(i+1,j)+0.25*addm(i,j)
    addm(i,j) = 0.
  end do
end do

end subroutine adxmist_2d


subroutine adxtp( adfx, q, adq, c, adc, iord, ifirst, ilast, jfirst, jlast, npx, uniform_ppm )
!******************************************************************
!******************************************************************
!** This routine was generated by Automatic differentiation.     **
!** FastOpt: Transformation of Algorithm in Fortran, TAF 1.9.43  **
!******************************************************************
!******************************************************************
!==============================================
! all entries are defined explicitly
!==============================================
implicit none

!==============================================
! declare arguments
!==============================================
integer, intent(in) :: jfirst
integer, intent(in) :: jlast
real, intent(inout) :: adc(is:ie+1,jfirst:jlast)
integer, intent(in) :: ifirst
integer, intent(in) :: ilast
real, intent(inout) :: adfx(ifirst:ilast+1,jfirst:jlast)
real, intent(inout) :: adq(isd:ied,jfirst:jlast)
real, intent(in) :: c(is:ie+1,jfirst:jlast)
integer, intent(in) :: iord
integer, intent(in) :: npx
real, intent(in) :: q(isd:ied,jfirst:jlast)
logical, intent(in) :: uniform_ppm

!==============================================
! declare local variables
!==============================================
real :: addm(ifirst-ng:ilast+ng,jfirst:jlast)
real :: dm(ifirst-ng:ilast+ng,jfirst:jlast)
integer :: i
integer :: iu
integer :: j

!----------------------------------------------
! RESET LOCAL ADJOINT VARIABLES
!----------------------------------------------
addm(:,:) = 0.

!----------------------------------------------
! ROUTINE BODY
!----------------------------------------------
if (iord .eq. 1) then
  do j = jfirst, jlast
    do i = ifirst, ilast+1
      iu = floor(real(i)-c(i,j))
      adq(iu,j) = adq(iu,j)+adfx(i,j)
      adfx(i,j) = 0.
    end do
  end do
else if (abs(iord) .eq. 2) then
  call xmist_2d( q,dm,ng,iord,ifirst,ilast,jfirst,jlast )
  do j = jfirst, jlast
    do i = ifirst, ilast+1
      iu = floor(real(i)-c(i,j))
      adc(i,j) = adc(i,j)-adfx(i,j)*dm(iu,j)
      addm(iu,j) = addm(iu,j)+adfx(i,j)*(sign(1.,c(i,j))-c(i,j))
      adq(iu,j) = adq(iu,j)+adfx(i,j)
      adfx(i,j) = 0.
    end do
  end do
  call adxmist_2d( q,adq,dm,addm,ng,iord,ifirst,ilast,jfirst,jlast )
else
  call adfxppm( c,adc,q,adq,adfx,iord,ifirst,ilast,jfirst,jlast,npx,uniform_ppm )
endif

end subroutine adxtp


subroutine adymist( q, adq, dm, addm, ng, jord, ifirst, ilast, jfirst, jlast )
!******************************************************************
!******************************************************************
!** This routine was generated by Automatic differentiation.     **
!** FastOpt: Transformation of Algorithm in Fortran, TAF 1.9.43  **
!******************************************************************
!******************************************************************
!==============================================
! all entries are defined explicitly
!==============================================
implicit none

!==============================================
! declare arguments
!==============================================
integer, intent(in) :: ifirst
integer, intent(in) :: ilast
integer, intent(in) :: jfirst
integer, intent(in) :: jlast
integer, intent(in) :: ng
real, intent(inout) :: addm(ifirst:ilast,jfirst-ng:jlast+ng)
real, intent(inout) :: adq(ifirst:ilast,jfirst-ng:jlast+ng)
real, intent(inout) :: dm(ifirst:ilast,jfirst-ng:jlast+ng)
integer, intent(in) :: jord
real, intent(in) :: q(ifirst:ilast,jfirst-ng:jlast+ng)

!==============================================
! declare local variables
!==============================================
real :: addmh
real :: addmi
real :: addmj
real :: adqmax
real :: adqmaxi
real :: adqmin
real :: adqminh
real :: adqmini
real :: dmh
real :: dmi
integer :: i
integer :: j
real :: qmax
real :: qmaxi
real :: qmin
real :: qmini

!----------------------------------------------
! RESET LOCAL ADJOINT VARIABLES
!----------------------------------------------
adqmax = 0.
adqmin = 0.

!----------------------------------------------
! ROUTINE BODY
!----------------------------------------------
do j = jfirst-ng+1, jlast+ng-1
  do i = ifirst, ilast
    dm(i,j) = 0.25*(q(i,j+1)-q(i,j-1))
  end do
end do
if (jord .gt. 0) then
  do j = jfirst-ng+1, jlast+ng-1
    adqmax = 0.
    adqmin = 0.
    do i = ifirst, ilast
      adqmax = 0.
      adqmin = 0.
      qmax = max(max(q(i,j-1),q(i,j)),q(i,j+1))-q(i,j)
      qmin = q(i,j)-min(min(q(i,j-1),q(i,j)),q(i,j+1))
      dmh = abs(dm(i,j))
      dmi = min(dmh,qmin)
      addmj = addm(i,j)*sign(1.,min(dmi,qmax))*sign(1.,dm(i,j))
      addmi = addmj*(0.5+sign(0.5,qmax-dmi))
      adqmax = adqmax+addmj*(0.5-sign(0.5,qmax-dmi))
      addmh = addmi*(0.5+sign(0.5,qmin-dmh))
      adqmin = adqmin+addmi*(0.5-sign(0.5,qmin-dmh))
      addm(i,j) = addmh*sign(1.,dm(i,j))
      qmini = min(q(i,j-1),q(i,j))
      adq(i,j) = adq(i,j)+adqmin
      adqminh = -adqmin
      adq(i,j+1) = adq(i,j+1)+adqminh*(0.5-sign(0.5,q(i,j+1)-qmini))
      adqmini = adqminh*(0.5+sign(0.5,q(i,j+1)-qmini))
      adq(i,j-1) = adq(i,j-1)+adqmini*(0.5+sign(0.5,q(i,j)-q(i,j-1)))
      adq(i,j) = adq(i,j)+adqmini*(0.5-sign(0.5,q(i,j)-q(i,j-1)))
      adqmin = 0.
      qmaxi = max(q(i,j-1),q(i,j))
      adq(i,j) = adq(i,j)-adqmax
      adq(i,j+1) = adq(i,j+1)+adqmax*(0.5-sign(0.5,qmaxi-q(i,j+1)))
      adqmaxi = adqmax*(0.5+sign(0.5,qmaxi-q(i,j+1)))
      adq(i,j-1) = adq(i,j-1)+adqmaxi*(0.5+sign(0.5,q(i,j-1)-q(i,j)))
      adq(i,j) = adq(i,j)+adqmaxi*(0.5-sign(0.5,q(i,j-1)-q(i,j)))
      adqmax = 0.
    end do
  end do
endif
do j = jfirst-ng+1, jlast+ng-1
  do i = ifirst, ilast
    adq(i,j-1) = adq(i,j-1)-0.25*addm(i,j)
    adq(i,j+1) = adq(i,j+1)+0.25*addm(i,j)
    addm(i,j) = 0.
  end do
end do

end subroutine adymist


subroutine adytp( adfy, q, adq, c, adc, jord, ifirst, ilast, jfirst, jlast, npy, uniform_ppm )
!******************************************************************
!******************************************************************
!** This routine was generated by Automatic differentiation.     **
!** FastOpt: Transformation of Algorithm in Fortran, TAF 1.9.43  **
!******************************************************************
!******************************************************************
!==============================================
! all entries are defined explicitly
!==============================================
implicit none

!==============================================
! declare arguments
!==============================================
real, intent(inout) :: adc(isd:ied,js:je+1)
integer, intent(in) :: ifirst
integer, intent(in) :: ilast
integer, intent(in) :: jfirst
integer, intent(in) :: jlast
real, intent(inout) :: adfy(ifirst:ilast,jfirst:jlast+1)
real, intent(inout) :: adq(ifirst:ilast,jfirst-ng:jlast+ng)
real, intent(in) :: c(isd:ied,js:je+1)
integer, intent(in) :: jord
integer, intent(in) :: npy
real, intent(in) :: q(ifirst:ilast,jfirst-ng:jlast+ng)
logical, intent(in) :: uniform_ppm

!==============================================
! declare local variables
!==============================================
real :: addm(ifirst:ilast,jfirst-ng:jlast+ng)
real :: dm(ifirst:ilast,jfirst-ng:jlast+ng)
integer :: i
integer :: j
integer :: jt

!----------------------------------------------
! RESET LOCAL ADJOINT VARIABLES
!----------------------------------------------
addm(:,:) = 0.

!----------------------------------------------
! ROUTINE BODY
!----------------------------------------------
if (jord .eq. 1) then
  do j = jfirst, jlast+1
    do i = ifirst, ilast
      jt = floor(real(j)-c(i,j))
      adq(i,jt) = adq(i,jt)+adfy(i,j)
      adfy(i,j) = 0.
    end do
  end do
else if (abs(jord) .eq. 2) then
  call ymist( q,dm,ng,jord,ifirst,ilast,jfirst,jlast )
  do j = jfirst, jlast+1
    do i = ifirst, ilast
      jt = floor(real(j)-c(i,j))
      adc(i,j) = adc(i,j)-adfy(i,j)*dm(i,jt)
      addm(i,jt) = addm(i,jt)+adfy(i,j)*(sign(1.,c(i,j))-c(i,j))
      adq(i,jt) = adq(i,jt)+adfy(i,j)
      adfy(i,j) = 0.
    end do
  end do
  call adymist( q,adq,dm,addm,ng,jord,ifirst,ilast,jfirst,jlast )
else
  call adfyppm( c,adc,q,adq,adfy,jord,ifirst,ilast,jfirst,jlast,npy,uniform_ppm,dm,addm )
endif

end subroutine adytp


end module     adtp_core_mod



