module     adfv_fill_mod
!******************************************************************
!******************************************************************
!** This routine was generated by Automatic differentiation.     **
!** FastOpt: Transformation of Algorithm in Fortran, TAF 1.9.33  **
!******************************************************************
!******************************************************************
!==============================================
! referencing used modules
!==============================================
use fv_fill_mod

!==============================================
! all entries are defined explicitly
!==============================================
implicit none

contains
subroutine adfillz( im, km, nq, q, adq, dp, addp )
!******************************************************************
!******************************************************************
!** This routine was generated by Automatic differentiation.     **
!** FastOpt: Transformation of Algorithm in Fortran, TAF 1.9.33  **
!******************************************************************
!******************************************************************
!==============================================
! all entries are defined explicitly
!==============================================
implicit none

!==============================================
! declare arguments
!==============================================
integer, intent(in) :: im
integer, intent(in) :: km
real, intent(inout) :: addp(im,km)
integer, intent(in) :: nq
real, intent(inout) :: adq(im,km,nq)
real, intent(in) :: dp(im,km)
real, intent(inout) :: q(im,km,nq)

!==============================================
! declare local variables
!==============================================
real :: addup
real :: adhelp_h
real :: adhelp_i
real :: adhelp_j
real :: adqly
real :: adqup
real :: dup
real :: help_h
real :: help_i
real :: help_j
integer :: i
integer :: ic
integer :: k
real :: qly
real :: qup
integer :: tape_fill1_fillz
real, allocatable :: tape_fill1_q_1h(:,:)
real, allocatable :: tape_fill1_q_2h(:,:)
integer :: tape_fill2_fillz
real, allocatable :: tape_fill2_q_1h(:,:,:)
real, allocatable :: tape_fill2_q_2h(:,:,:)

!----------------------------------------------
! RESET LOCAL ADJOINT VARIABLES
!----------------------------------------------
addup = 0.
adhelp_h = 0.
adhelp_i = 0.
adhelp_j = 0.
adqly = 0.
adqup = 0.

!----------------------------------------------
! ROUTINE BODY
!----------------------------------------------
!----------------------------------------------
! OPEN TAPE tape_fill1
!----------------------------------------------
tape_fill1_fillz = nq

!----------------------------------------------
! TAPE COMPUTATIONS
!----------------------------------------------
do ic = 1, nq-1
  if ( .not. allocated(tape_fill1_q_1h)) then
    allocate( tape_fill1_q_1h(1:im,tape_fill1_fillz) )
  endif
  tape_fill1_q_1h(:,ic) = q(:,1,ic)
  if ( .not. allocated(tape_fill1_q_2h)) then
    allocate( tape_fill1_q_2h(1:im,tape_fill1_fillz) )
  endif
  tape_fill1_q_2h(:,ic) = q(:,2,ic)
  do i = 1, im
    if (q(i,1,ic) .lt. 0.) then
      q(i,2,ic) = q(i,2,ic)+q(i,1,ic)*dp(i,1)/dp(i,2)
      q(i,1,ic) = 0.
    endif
  end do
  do k = 2, km-1
    do i = 1, im
      if (q(i,k,ic) .lt. 0.) then
        help_h = q(i,k-1,ic)*dp(i,k-1)
        if (0. .lt. help_h) then
          qup = help_h
        else
          qup = 0.
        endif
        qly = -(q(i,k,ic)*dp(i,k))
        help_i = 0.5*qly
        help_j = 0.99*qup
        if (help_i .gt. help_j) then
          dup = help_j
        else
          dup = help_i
        endif
        q(i,k-1,ic) = q(i,k-1,ic)-dup/dp(i,k-1)
        q(i,k+1,ic) = q(i,k+1,ic)-(qly-dup)/dp(i,k+1)
        q(i,k,ic) = 0.
      endif
    end do
  end do
  k = km
  do i = 1, im
    if (q(i,k,ic) .lt. 0. .and. q(i,k-1,ic) .gt. 0.) then
      qup = q(i,k-1,ic)*dp(i,k-1)
      qly = -(q(i,k,ic)*dp(i,k))
      if (qly .gt. qup) then
        dup = qup
      else
        dup = qly
      endif
      q(i,k-1,ic) = q(i,k-1,ic)-dup/dp(i,k-1)
      q(i,k,ic) = q(i,k,ic)+dup/dp(i,k)
    else
      q(i,km,ic) = 0.
    endif
  end do
end do
ic = nq
if ( .not. allocated(tape_fill1_q_1h)) then
  allocate( tape_fill1_q_1h(1:im,tape_fill1_fillz) )
endif
tape_fill1_q_1h(:,ic) = q(:,1,ic)
if ( .not. allocated(tape_fill1_q_2h)) then
  allocate( tape_fill1_q_2h(1:im,tape_fill1_fillz) )
endif
tape_fill1_q_2h(:,ic) = q(:,2,ic)

!----------------------------------------------
! ADJOINT COMPUTATIONS
!----------------------------------------------
do ic = nq, 1, -1
  q(:,1,ic) = tape_fill1_q_1h(:,ic)
  q(:,2,ic) = tape_fill1_q_2h(:,ic)
  do i = 1, im
    if (q(i,1,ic) .lt. 0.) then
      q(i,2,ic) = q(i,2,ic)+q(i,1,ic)*dp(i,1)/dp(i,2)
      q(i,1,ic) = 0.
    endif
  end do
!----------------------------------------------
! OPEN TAPE tape_fill2
!----------------------------------------------
  tape_fill2_fillz = (km-1)*im

!----------------------------------------------
! TAPE COMPUTATIONS
!----------------------------------------------
  do k = 2, km-1
    do i = 1, im
      if ( .not. allocated(tape_fill2_q_1h)) then
        allocate( tape_fill2_q_1h(1:im,1:km,tape_fill2_fillz) )
      endif
      tape_fill2_q_1h(:,:,(k-2)*im+i) = q(:,:,ic)
      if (q(i,k,ic) .lt. 0.) then
        help_h = q(i,k-1,ic)*dp(i,k-1)
        if (0. .lt. help_h) then
          qup = help_h
        else
          qup = 0.
        endif
        qly = -(q(i,k,ic)*dp(i,k))
        help_i = 0.5*qly
        help_j = 0.99*qup
        if (help_i .gt. help_j) then
          dup = help_j
        else
          dup = help_i
        endif
        q(i,k-1,ic) = q(i,k-1,ic)-dup/dp(i,k-1)
        q(i,k+1,ic) = q(i,k+1,ic)-(qly-dup)/dp(i,k+1)
        q(i,k,ic) = 0.
      endif
    end do
  end do
  k = km
  do i = 1, im-1
    if ( .not. allocated(tape_fill2_q_2h)) then
      allocate( tape_fill2_q_2h(1:im,1:km,tape_fill2_fillz) )
    endif
    tape_fill2_q_2h(:,:,(k-2)*im+i) = q(:,:,ic)
    if (q(i,k,ic) .lt. 0. .and. q(i,k-1,ic) .gt. 0.) then
      qup = q(i,k-1,ic)*dp(i,k-1)
      qly = -(q(i,k,ic)*dp(i,k))
      if (qly .gt. qup) then
        dup = qup
      else
        dup = qly
      endif
      q(i,k-1,ic) = q(i,k-1,ic)-dup/dp(i,k-1)
      q(i,k,ic) = q(i,k,ic)+dup/dp(i,k)
    else
      q(i,km,ic) = 0.
    endif
  end do
  i = im
  if ( .not. allocated(tape_fill2_q_2h)) then
    allocate( tape_fill2_q_2h(1:im,1:km,tape_fill2_fillz) )
  endif
  tape_fill2_q_2h(:,:,(k-2)*im+i) = q(:,:,ic)

!----------------------------------------------
! ADJOINT COMPUTATIONS
!----------------------------------------------
  do i = im, 1, -1
    q(:,:,ic) = tape_fill2_q_2h(:,:,(k-2)*im+i)
    if (q(i,k,ic) .lt. 0. .and. q(i,k-1,ic) .gt. 0.) then
      qup = q(i,k-1,ic)*dp(i,k-1)
      qly = -(q(i,k,ic)*dp(i,k))
      if (qly .gt. qup) then
        dup = qup
      else
        dup = qly
      endif
      addp(i,k) = addp(i,k)-adq(i,k,ic)*(dup/(dp(i,k)*dp(i,k)))
      addup = addup+adq(i,k,ic)/dp(i,k)
      addp(i,k-1) = addp(i,k-1)+adq(i,k-1,ic)*(dup/(dp(i,k-1)*dp(i,k-1)))
      addup = addup-adq(i,k-1,ic)/dp(i,k-1)
      if (qly .gt. qup) then
        adqup = adqup+addup
        addup = 0.
      else
        adqly = adqly+addup
        addup = 0.
      endif
      addp(i,k) = addp(i,k)-adqly*q(i,k,ic)
      adq(i,k,ic) = adq(i,k,ic)-adqly*dp(i,k)
      adqly = 0.
      addp(i,k-1) = addp(i,k-1)+adqup*q(i,k-1,ic)
      adq(i,k-1,ic) = adq(i,k-1,ic)+adqup*dp(i,k-1)
      adqup = 0.
    else
      adq(i,km,ic) = 0.
    endif
  end do
  do k = km-1, 2, -1
    do i = im, 1, -1
      q(:,:,ic) = tape_fill2_q_1h(:,:,(k-2)*im+i)
      if (q(i,k,ic) .lt. 0.) then
        help_h = q(i,k-1,ic)*dp(i,k-1)
        if (0. .lt. help_h) then
          qup = help_h
        else
          qup = 0.
        endif
        qly = -(q(i,k,ic)*dp(i,k))
        help_i = 0.5*qly
        help_j = 0.99*qup
        if (help_i .gt. help_j) then
          dup = help_j
        else
          dup = help_i
        endif
        adq(i,k,ic) = 0.
        addp(i,k+1) = addp(i,k+1)+adq(i,k+1,ic)*((qly-dup)/(dp(i,k+1)*dp(i,k+1)))
        addup = addup+adq(i,k+1,ic)/dp(i,k+1)
        adqly = adqly-adq(i,k+1,ic)/dp(i,k+1)
        addp(i,k-1) = addp(i,k-1)+adq(i,k-1,ic)*(dup/(dp(i,k-1)*dp(i,k-1)))
        addup = addup-adq(i,k-1,ic)/dp(i,k-1)
        if (help_i .gt. help_j) then
          adhelp_j = adhelp_j+addup
          addup = 0.
        else
          adhelp_i = adhelp_i+addup
          addup = 0.
        endif
        adqup = adqup+0.99*adhelp_j
        adhelp_j = 0.
        adqly = adqly+0.5*adhelp_i
        adhelp_i = 0.
        addp(i,k) = addp(i,k)-adqly*q(i,k,ic)
        adq(i,k,ic) = adq(i,k,ic)-adqly*dp(i,k)
        adqly = 0.
        if (0. .lt. help_h) then
          adhelp_h = adhelp_h+adqup
          adqup = 0.
        else
          adqup = 0.
        endif
        addp(i,k-1) = addp(i,k-1)+adhelp_h*q(i,k-1,ic)
        adq(i,k-1,ic) = adq(i,k-1,ic)+adhelp_h*dp(i,k-1)
        adhelp_h = 0.
      endif
    end do
  end do

!----------------------------------------------
! CLOSE TAPE tape_fill2
!----------------------------------------------
  if (allocated(tape_fill2_q_1h)) then
    deallocate( tape_fill2_q_1h )
  endif
  if (allocated(tape_fill2_q_2h)) then
    deallocate( tape_fill2_q_2h )
  endif

  q(:,1,ic) = tape_fill1_q_1h(:,ic)
  q(:,2,ic) = tape_fill1_q_2h(:,ic)
  do i = 1, im
    if (q(i,1,ic) .lt. 0.) then
      adq(i,1,ic) = 0.
      addp(i,2) = addp(i,2)-adq(i,2,ic)*(q(i,1,ic)*dp(i,1)/(dp(i,2)*dp(i,2)))
      addp(i,1) = addp(i,1)+adq(i,2,ic)*(q(i,1,ic)/dp(i,2))
      adq(i,1,ic) = adq(i,1,ic)+adq(i,2,ic)*(dp(i,1)/dp(i,2))
    endif
  end do
end do

!----------------------------------------------
! CLOSE TAPE tape_fill1
!----------------------------------------------
if (allocated(tape_fill1_q_1h)) then
  deallocate( tape_fill1_q_1h )
endif
if (allocated(tape_fill1_q_2h)) then
  deallocate( tape_fill1_q_2h )
endif


end subroutine adfillz


end module     adfv_fill_mod


