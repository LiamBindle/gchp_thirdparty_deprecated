!                           DISCLAIMER
!
!   This file was generated by TAF version 1.9.22
!
!   FASTOPT DISCLAIMS  ALL  WARRANTIES,  EXPRESS  OR  IMPLIED,
!   INCLUDING (WITHOUT LIMITATION) ALL IMPLIED  WARRANTIES  OF
!   MERCHANTABILITY  OR FITNESS FOR A PARTICULAR PURPOSE, WITH
!   RESPECT TO THE SOFTWARE AND USER PROGRAMS.   IN  NO  EVENT
!   SHALL  FASTOPT BE LIABLE FOR ANY LOST OR ANTICIPATED PROF-
!   ITS, OR ANY INDIRECT, INCIDENTAL, EXEMPLARY,  SPECIAL,  OR
!   CONSEQUENTIAL  DAMAGES, WHETHER OR NOT FASTOPT WAS ADVISED
!   OF THE POSSIBILITY OF SUCH DAMAGES.
!
!                           Haftungsbeschraenkung
!   FastOpt gibt ausdruecklich keine Gewaehr, explizit oder indirekt,
!   bezueglich der Brauchbarkeit  der Software  fuer einen bestimmten
!   Zweck.   Unter  keinen  Umstaenden   ist  FastOpt   haftbar  fuer
!   irgendeinen Verlust oder nicht eintretenden erwarteten Gewinn und
!   allen indirekten,  zufaelligen,  exemplarischen  oder  speziellen
!   Schaeden  oder  Folgeschaeden  unabhaengig  von einer eventuellen
!   Mitteilung darueber an FastOpt.
!
module     adtpcore
!******************************************************************
!******************************************************************
!** This routine was generated by Automatic differentiation.     **
!** FastOpt: Transformation of Algorithm in Fortran, TAF 1.9.22  **
!******************************************************************
!******************************************************************
!==============================================
! referencing used modules
!==============================================
use pre_direct
use mp_mod, only : ie,ied,is,isd,je,jed,js,jsd,ng
use grid_utils, only : cx1,cx2,cy1,cy2,ne_corner,nw_corner,se_corner,sw_corner
use grid_tools, only : dxa,dya,grid_type
use tpcore

!==============================================
! all entries are defined explicitly
!==============================================
implicit none

contains
subroutine adcopy_corners( adq, npx, npy, dir )
!******************************************************************
!******************************************************************
!** This routine was generated by Automatic differentiation.     **
!** FastOpt: Transformation of Algorithm in Fortran, TAF 1.9.22  **
!******************************************************************
!******************************************************************
!==============================================
! all entries are defined explicitly
!==============================================
implicit none

!==============================================
! declare arguments
!==============================================
real, intent(inout) :: adq(isd:ied,jsd:jed)
integer, intent(in) :: dir
integer, intent(in) :: npx
integer, intent(in) :: npy

!==============================================
! declare local variables
!==============================================
real :: adqh
real :: adqi
real :: adqj
real :: adqk
real :: adql
real :: adqm
real :: adqn
real :: adqo
integer :: i
integer :: j

!----------------------------------------------
! ROUTINE BODY
!----------------------------------------------
if (dir .eq. 1) then
  if (nw_corner) then
    do j = npy+ng-1, npy, -1
      do i = 0, 1-ng, -1
        adql = adq(i,j)
        adq(i,j) = 0.
        adq(npy-j,i-1+npx) = adq(npy-j,i-1+npx)+adql
      end do
    end do
  endif
  if (ne_corner) then
    do j = npy+ng-1, npy, -1
      do i = npx+ng-1, npx, -1
        adqm = adq(i,j)
        adq(i,j) = 0.
        adq(j,2*npx-1-i) = adq(j,2*npx-1-i)+adqm
      end do
    end do
  endif
  if (se_corner) then
    do j = 0, 1-ng, -1
      do i = npx+ng-1, npx, -1
        adqn = adq(i,j)
        adq(i,j) = 0.
        adq(npy-j,i-npx+1) = adq(npy-j,i-npx+1)+adqn
      end do
    end do
  endif
  if (sw_corner) then
    do j = 1-ng, 0
      do i = 0, 1-ng, -1
        adqo = adq(i,j)
        adq(i,j) = 0.
        adq(j,1-i) = adq(j,1-i)+adqo
      end do
    end do
  endif
else if (dir .eq. 2) then
  if (nw_corner) then
    do j = npy+ng-1, npy, -1
      do i = 0, 1-ng, -1
        adqh = adq(i,j)
        adq(i,j) = 0.
        adq(j+1-npx,npy-i) = adq(j+1-npx,npy-i)+adqh
      end do
    end do
  endif
  if (ne_corner) then
    do j = npy+ng-1, npy, -1
      do i = npx+ng-1, npx, -1
        adqi = adq(i,j)
        adq(i,j) = 0.
        adq(2*npy-1-j,i) = adq(2*npy-1-j,i)+adqi
      end do
    end do
  endif
  if (se_corner) then
    do j = 0, 1-ng, -1
      do i = npx+ng-1, npx, -1
        adqj = adq(i,j)
        adq(i,j) = 0.
        adq(npy+j-1,npx-i) = adq(npy+j-1,npx-i)+adqj
      end do
    end do
  endif
  if (sw_corner) then
    do j = 1-ng, 0
      do i = 0, 1-ng, -1
        adqk = adq(i,j)
        adq(i,j) = 0.
        adq(1-j,i) = adq(1-j,i)+adqk
      end do
    end do
  endif
endif

end subroutine adcopy_corners


subroutine adfv_tp_2d( q, adq, crx, adcrx, cry, adcry, npx, npy, hord, adfx, adfy, xfx, adxfx, yfx, adyfx, area, ra_x, adra_x, &
&ra_y, adra_y, uni_ppm, mfx, admfx, mfy, admfy )
!******************************************************************
!******************************************************************
!** This routine was generated by Automatic differentiation.     **
!** FastOpt: Transformation of Algorithm in Fortran, TAF 1.9.22  **
!******************************************************************
!******************************************************************
!==============================================
! all entries are defined explicitly
!==============================================
implicit none

!==============================================
! declare arguments
!==============================================
real, intent(inout) :: adcrx(is:ie+1,jsd:jed)
real, intent(inout) :: adcry(isd:ied,js:je+1)
real, intent(inout) :: adfx(is:ie+1,js:je)
real, intent(inout) :: adfy(is:ie,js:je+1)
real,optional, intent(inout) :: admfx(is:ie+1,js:je)
real,optional, intent(inout) :: admfy(is:ie,js:je+1)
real, intent(inout) :: adq(isd:ied,jsd:jed)
real, intent(inout) :: adra_x(is:ie,jsd:jed)
real, intent(inout) :: adra_y(isd:ied,js:je)
real, intent(inout) :: adxfx(is:ie+1,jsd:jed)
real, intent(inout) :: adyfx(isd:ied,js:je+1)
real, intent(in) :: area(isd:ied,jsd:jed)
real, intent(in) :: crx(is:ie+1,jsd:jed)
real, intent(in) :: cry(isd:ied,js:je+1)
integer, intent(in) :: hord
real,optional, intent(in) :: mfx(is:ie+1,js:je)
real,optional, intent(in) :: mfy(is:ie,js:je+1)
integer, intent(in) :: npx
integer, intent(in) :: npy
real, intent(inout) :: q(isd:ied,jsd:jed)
real, intent(in) :: ra_x(is:ie,jsd:jed)
real, intent(in) :: ra_y(isd:ied,js:je)
logical, intent(in) :: uni_ppm
real, intent(in) :: xfx(is:ie+1,jsd:jed)
real, intent(in) :: yfx(isd:ied,js:je+1)

!==============================================
! declare local variables
!==============================================
real :: adfx1(is:ie+1)
real :: adfx2(is:ie+1,jsd:jed)
real :: adfy2(isd:ied,js:je+1)
real :: adfyy(isd:ied,js:je+1)
real :: adq_i(isd:ied,js:je)
real :: adq_j(is:ie,jsd:jed)
real :: fx(is:ie+1,js:je)
real :: fx1(is:ie+1)
real :: fx2(is:ie+1,jsd:jed)
real :: fy(is:ie,js:je+1)
real :: fy2(isd:ied,js:je+1)
real :: fyy(isd:ied,js:je+1)
integer :: i
integer :: j
real :: q_i(isd:ied,js:je)
real :: q_j(is:ie,jsd:jed)
real :: qh(lbound(q,1):ubound(q,1),lbound(q,2):ubound(q,2))

!----------------------------------------------
! SAVE REQUIRED INPUT VARIABLES
!----------------------------------------------
qh(:,:) = q(:,:)

!----------------------------------------------
! RESET LOCAL ADJOINT VARIABLES
!----------------------------------------------
adfx1(:) = 0.
adfx2(:,:) = 0.
adfy2(:,:) = 0.
adfyy(:,:) = 0.
adq_i(:,:) = 0.
adq_j(:,:) = 0.

!----------------------------------------------
! ROUTINE BODY
!----------------------------------------------
call copy_corners( q,npx,npy,2 )
call ytp( fy2,q,cry,hord,isd,ied,js,je,npx,npy,uni_ppm )
do j = js, je+1
  do i = isd, ied
    fyy(i,j) = yfx(i,j)*fy2(i,j)
  end do
end do
do j = js, je
  do i = isd, ied
    q_i(i,j) = (q(i,j)*area(i,j)+fyy(i,j)-fyy(i,j+1))/ra_y(i,j)
  end do
end do
call xtp( fx,q_i,crx(is,js),hord,is,ie,js,je,npx,npy,uni_ppm )
call copy_corners( q,npx,npy,1 )
call xtp( fx2,q,crx,hord,is,ie,jsd,jed,npx,npy,uni_ppm )
do j = jsd, jed
  do i = is, ie+1
    fx1(i) = xfx(i,j)*fx2(i,j)
  end do
  do i = is, ie
    q_j(i,j) = (q(i,j)*area(i,j)+fx1(i)-fx1(i+1))/ra_x(i,j)
  end do
end do
call ytp( fy,q_j,cry,hord,is,ie,js,je,npx,npy,uni_ppm )
if (present(mfx) .and. present(mfy)) then
  do j = js, je+1
    do i = is, ie
      adfy2(i,j) = adfy2(i,j)+0.5*adfy(i,j)*mfy(i,j)
      admfy(i,j) = admfy(i,j)+0.5*adfy(i,j)*(fy(i,j)+fy2(i,j))
      adfy(i,j) = 0.5*adfy(i,j)*mfy(i,j)
    end do
  end do
  do j = js, je
    do i = is, ie+1
      adfx2(i,j) = adfx2(i,j)+0.5*adfx(i,j)*mfx(i,j)
      admfx(i,j) = admfx(i,j)+0.5*adfx(i,j)*(fx(i,j)+fx2(i,j))
      adfx(i,j) = 0.5*adfx(i,j)*mfx(i,j)
    end do
  end do
else
  do j = js, je+1
    do i = is, ie
      adfy2(i,j) = adfy2(i,j)+0.5*adfy(i,j)*yfx(i,j)
      adyfx(i,j) = adyfx(i,j)+0.5*adfy(i,j)*(fy(i,j)+fy2(i,j))
      adfy(i,j) = 0.5*adfy(i,j)*yfx(i,j)
    end do
  end do
  do j = js, je
    do i = is, ie+1
      adfx2(i,j) = adfx2(i,j)+0.5*adfx(i,j)*xfx(i,j)
      adxfx(i,j) = adxfx(i,j)+0.5*adfx(i,j)*(fx(i,j)+fx2(i,j))
      adfx(i,j) = 0.5*adfx(i,j)*xfx(i,j)
    end do
  end do
endif
call adytp( adfy,q_j,adq_j,cry,adcry,hord,is,ie,js,je,npx,npy,uni_ppm )
do j = jsd, jed
  do i = is, ie+1
    fx1(i) = xfx(i,j)*fx2(i,j)
  end do
  do i = is, ie
    adfx1(i+1) = adfx1(i+1)-adq_j(i,j)/ra_x(i,j)
    adfx1(i) = adfx1(i)+adq_j(i,j)/ra_x(i,j)
    adq(i,j) = adq(i,j)+adq_j(i,j)*(area(i,j)/ra_x(i,j))
    adra_x(i,j) = adra_x(i,j)-adq_j(i,j)*((q(i,j)*area(i,j)+fx1(i)-fx1(i+1))/(ra_x(i,j)*ra_x(i,j)))
    adq_j(i,j) = 0.
  end do
  do i = is, ie+1
    adfx2(i,j) = adfx2(i,j)+adfx1(i)*xfx(i,j)
    adxfx(i,j) = adxfx(i,j)+adfx1(i)*fx2(i,j)
    adfx1(i) = 0.
  end do
end do
call adxtp( adfx2,q,adq,crx,adcrx,hord,is,ie,jsd,jed,npx,npy,uni_ppm )
call adcopy_corners( adq,npx,npy,1 )
call adxtp( adfx,q_i,adq_i,crx(is,js),adcrx(is,js),hord,is,ie,js,je,npx,npy,uni_ppm )
q(:,:) = qh(:,:)
call copy_corners( q,npx,npy,2 )
do j = js, je
  do i = isd, ied
    adfyy(i,j+1) = adfyy(i,j+1)-adq_i(i,j)/ra_y(i,j)
    adfyy(i,j) = adfyy(i,j)+adq_i(i,j)/ra_y(i,j)
    adq(i,j) = adq(i,j)+adq_i(i,j)*(area(i,j)/ra_y(i,j))
    adra_y(i,j) = adra_y(i,j)-adq_i(i,j)*((q(i,j)*area(i,j)+fyy(i,j)-fyy(i,j+1))/(ra_y(i,j)*ra_y(i,j)))
    adq_i(i,j) = 0.
  end do
end do
do j = js, je+1
  do i = isd, ied
    adfy2(i,j) = adfy2(i,j)+adfyy(i,j)*yfx(i,j)
    adyfx(i,j) = adyfx(i,j)+adfyy(i,j)*fy2(i,j)
    adfyy(i,j) = 0.
  end do
end do
q(:,:) = qh(:,:)
call copy_corners( q,npx,npy,2 )
call adytp( adfy2,q,adq,cry,adcry,hord,isd,ied,js,je,npx,npy,uni_ppm )
call adcopy_corners( adq,npx,npy,2 )

!----------------------------------------------
! FREE DYNAMIC MEMORY
!----------------------------------------------

end subroutine adfv_tp_2d


subroutine adfxppm( c, adc, q, adq, adflux, iord, ifirst, ilast, jfirst, jlast, npx, npy, uniform_ppm )
!******************************************************************
!******************************************************************
!** This routine was generated by Automatic differentiation.     **
!** FastOpt: Transformation of Algorithm in Fortran, TAF 1.9.22  **
!******************************************************************
!******************************************************************
!==============================================
! all entries are defined explicitly
!==============================================
implicit none

!==============================================
! declare parameters
!==============================================
real, parameter :: b1 = 1./30.
real, parameter :: b2 = -(13./60.)
real, parameter :: b3 = -(13./60.)
real, parameter :: b4 = 0.45
real, parameter :: b5 = -0.05
real, parameter :: r3 = 1./3.

!==============================================
! declare arguments
!==============================================
integer, intent(in) :: ifirst
integer, intent(in) :: ilast
integer, intent(in) :: jfirst
integer, intent(in) :: jlast
real, intent(inout) :: adc(ifirst:ilast+1,jfirst:jlast)
real, intent(inout) :: adflux(ifirst:ilast+1,jfirst:jlast)
real, intent(inout) :: adq(ifirst-ng:ilast+ng,jfirst:jlast)
real, intent(in) :: c(ifirst:ilast+1,jfirst:jlast)
integer, intent(in) :: iord
integer, intent(in) :: npx
integer, intent(in) :: npy
real, intent(in) :: q(ifirst-ng:ilast+ng,jfirst:jlast)
logical, intent(in) :: uniform_ppm

!==============================================
! declare local variables
!==============================================
real :: adal(ifirst-1:ilast+2)
real :: adbl(ifirst-1:ilast+1)
real :: adblh
real :: adbli
real :: adblj
real :: adblk
real :: adbll
real :: adblm
real :: adbln
real :: adblo
real :: adblp
real :: adblq
real :: adblr
real :: adbls
real :: adblt
real :: adblu
real :: adblv
real :: adblw
real :: adblx
real :: adbly
real :: adblz
real :: adblza
real :: adblzb
real :: adblzc
real :: adblzd
real :: adblze
real :: adblzf
real :: adblzg
real :: adblzh
real :: adblzi
real :: adblzj
real :: adblzk
real :: adblzl
real :: adblzm
real :: adblzn
real :: adblzo
real :: adbr(ifirst-1:ilast+1)
real :: adbrh
real :: adbri
real :: adbrj
real :: adbrk
real :: adbrl
real :: adbrm
real :: adbrn
real :: adbro
real :: adbrp
real :: adbrq
real :: adbrr
real :: adbrs
real :: adbrt
real :: adbru
real :: adbrv
real :: adbrw
real :: adbrx
real :: adbry
real :: adbrz
real :: adbrza
real :: adbrzb
real :: adbrzc
real :: adbrzd
real :: adbrze
real :: adbrzf
real :: adbrzg
real :: adbrzh
real :: adbrzi
real :: adbrzj
real :: adbrzk
real :: adbrzl
real :: adbrzm
real :: adbrzn
real :: adbrzo
real :: adc1
real :: addl
real :: addlh
real :: addli
real :: addlj
real :: addlk
real :: addll
real :: addm1(ifirst-2:ilast+2)
real :: addm1h
real :: addm1i
real :: addm1j
real :: addm1k
real :: addm1l
real :: addm1m
real :: addm1n
real :: addm1o
real :: addm1p
real :: addm1q
real :: addm1r
real :: addm1s
real :: addm1t
real :: addm1u
real :: addm1v
real :: addm1w
real :: addm1x
real :: addm1y
real :: addm1z
real :: addm1za
real :: addm1zb
real :: addm1zc
real :: addm1zd
real :: addm1ze
real :: addm1zf
real :: addm1zg
real :: addm1zh
real :: addm1zi
real :: addm1zj
real :: addm1zk
real :: addm1zl
real :: addm1zm
real :: addm1zn
real :: addm1zo
real :: addm1zp
real :: addm1zq
real :: addm1zr
real :: addm1zs
real :: addm1zt
real :: addm1zu
real :: addm1zv
real :: addm1zx
real :: addm1zy
real :: addm1zz
real :: addm1zza
real :: addm1zzb
real :: addm1zzc
real :: addq(ifirst-3:ilast+2)
real :: addr
real :: addrh
real :: addri
real :: addrj
real :: addrk
real :: addrl
real :: adlac
real :: adpmp
real :: adqe
real :: adxt
real :: adxth
real :: adxti
real :: adxtk
real :: adxtl
real :: adxtn
real :: adxto
real :: adxtq
real :: adxtr
real :: adxts
real :: adxtt
real :: adxtu
real :: adxtv
real :: adxtw
real :: adxtx
real :: adxty
real :: adxtz
real :: adxtza
real :: adxtzb
real :: adxtzc
real :: adxtzd
real :: adxtze
real :: adxtzf
real :: adxtzg
real :: adxtzh
real :: adxtzi
real :: adxtzj
real :: adxtzk
real :: adxtzl
real :: adxtzm
real :: adxtzn
real :: adxtzo
real :: adxtzp
real :: adxtzq
real :: adxtzr
real :: adxtzt
real :: adxtzu
real :: adxtzw
real :: adxtzx
real :: adxtzy
real :: adxtzz
real :: adxtzza
real :: adxtzzb
real :: adxtzzc
real :: adxtzzd
real :: adxtzze
real :: adxtzzf
real :: adxtzzg
real :: adxtzzh
real :: adxtzzi
real :: adxtzzj
real :: adxtzzk
real :: adxtzzl
real :: adxtzzm
real :: adxtzzn
real :: adxtzzo
real :: adxtzzp
real :: adxtzzq
real :: adxtzzr
real :: adxtzzs
real :: adxtzzt
real :: adxtzzu
real :: adxtzzv
real :: adxtzzw
real :: adxtzzx
real :: al(ifirst-1:ilast+2)
real :: bl(ifirst-1:ilast+1)
real :: blh
real :: bli
real :: blj
real :: blk
real :: bll
real :: blm
real :: bln
real :: blo
real :: blp
real :: blq
real :: blr
real :: bls(lbound(bl,1):ubound(bl,1))
real :: blt
real :: blu
real :: blv
real :: blw
real :: blx
real :: bly
real :: blz
real :: blza
real :: blzb
real :: blzc
real :: blzd
real :: blze(lbound(bl,1):ubound(bl,1))
real :: blzf
real :: blzg
real :: blzh
real :: blzi
real :: blzj
real :: blzk
real :: blzl
real :: blzm
real :: blzn
real :: blzo
real :: br(ifirst-1:ilast+1)
real :: brh
real :: bri
real :: brj
real :: brk
real :: brl
real :: brm
real :: brn
real :: bro
real :: brp
real :: brq
real :: brr
real :: brs(lbound(br,1):ubound(br,1))
real :: brt
real :: bru
real :: brv
real :: brw
real :: brx
real :: bry
real :: brz
real :: brza
real :: brzb
real :: brzc
real :: brzd
real :: brze(lbound(br,1):ubound(br,1))
real :: brzf
real :: brzg
real :: brzh
real :: brzi
real :: brzj
real :: brzk
real :: brzl
real :: brzm
real :: brzn
real :: brzo
real :: c1
real :: dl
real :: dli
real :: dlj
real :: dm1(ifirst-2:ilast+2)
real :: dm1h
real :: dm1i
real :: dm1j
real :: dm1k
real :: dm1l
real :: dm1m
real :: dm1n
real :: dm1o
real :: dm1p
real :: dm1q
real :: dm1r
real :: dm1s
real :: dm1t
real :: dm1u
real :: dm1v
real :: dm1w
real :: dm1x
real :: dm1y
real :: dm1z
real :: dm1za
real :: dm1zb
real :: dm1zc
real :: dm1zd
real :: dm1ze
real :: dm1zf
real :: dm1zg
real :: dm1zh
real :: dm1zi
real :: dm1zj
real :: dm1zk
real :: dm1zl
real :: dm1zm
real :: dm1zo
real :: dm1zp
real :: dm1zr
real :: dm1zs
real :: dq(ifirst-3:ilast+2)
real :: dr
real :: dri
real :: drj
integer :: help_h
integer :: help_i
integer :: i
integer :: ie3
integer :: is3
integer :: it
integer :: j
integer :: j1
integer :: j2
real :: lac
real :: pmp
real :: qe
real :: xt
real :: xth
real :: xti
real :: xtj
real :: xtk
real :: xtl
real :: xtm
real :: xtn
real :: xto
real :: xtq
real :: xtr
real :: xts
real :: xtt
real :: xtu
real :: xtv
real :: xtw
real :: xtx
real :: xty
real :: xtz
real :: xtza
real :: xtzb
real :: xtzc
real :: xtzd
real :: xtze
real :: xtzf
real :: xtzg
real :: xtzh
real :: xtzi
real :: xtzj
real :: xtzk
real :: xtzl
real :: xtzm
real :: xtzn
real :: xtzo
real :: xtzp
real :: xtzq
real :: xtzr
real :: xtzs
real :: xtzt
real :: xtzu
real :: xtzv
real :: xtzw
real :: xtzx
real :: xtzy
real :: xtzz
real :: xtzza
real :: xtzzb
real :: xtzzc
real :: xtzzd
real :: xtzze
real :: xtzzf
real :: xtzzg
real :: xtzzh
real :: xtzzi
real :: xtzzj
real :: xtzzk
real :: xtzzl
real :: xtzzm
real :: xtzzn
real :: xtzzo
real :: xtzzp
real :: xtzzq
real :: xtzzr
real :: xtzzs
real :: xtzzt
real :: xtzzu
real :: xtzzv
real :: xtzzw
real :: xtzzx

!----------------------------------------------
! RESET LOCAL ADJOINT VARIABLES
!----------------------------------------------
adal(:) = 0.
adbl(:) = 0.
adbr(:) = 0.
adc1 = 0.
addl = 0.
addm1(:) = 0.
addq(:) = 0.
addr = 0.
adlac = 0.
adpmp = 0.
adqe = 0.
adxt = 0.

!----------------------------------------------
! ROUTINE BODY
!----------------------------------------------
if (iord .le. 4) then
  do j = jlast, jfirst, -1
    if (uniform_ppm) then
      do i = ifirst-2, ilast+2
        xt = 0.25*(q(i+1,j)-q(i-1,j))
        dm1(i) = sign(min(abs(xt),max(q(i-1,j),q(i,j),q(i+1,j))-q(i,j),q(i,j)-min(q(i-1,j),q(i,j),q(i+1,j))),xt)
      end do
    else
      do i = ifirst-3, ilast+2
        dq(i) = q(i+1,j)-q(i,j)
      end do
      do i = ifirst-2, ilast+2
        xt = cx1(i,j)*dq(i-1)+cx2(i,j)*dq(i)
        dm1(i) = sign(min(abs(xt),abs(dq(i-1)),abs(dq(i))),xt)
      end do
    endif
    do i = ifirst-1, ilast+2
      al(i) = 0.5*(q(i-1,j)+q(i,j))+r3*(dm1(i-1)-dm1(i))
    end do
    do i = ifirst, ilast+1
      addl = 0.
      addr = 0.
      adxt = 0.
      if (c(i,j) .gt. 0.) then
        xt = 2.*dm1(i-1)
        dl = sign(min(abs(xt),abs(al(i-1)-q(i-1,j))),xt)
        dr = sign(min(abs(xt),abs(al(i)-q(i-1,j))),xt)
        adc(i,j) = adc(i,j)+adflux(i,j)*((1.-c(i,j))*(dl-dr)-(c(i,j)*(dl-dr)+dr))
        addl = addl+adflux(i,j)*(1.-c(i,j))*c(i,j)
        addr = addr+adflux(i,j)*(1.-c(i,j))*(1+(-c(i,j)))
        adq(i-1,j) = adq(i-1,j)+adflux(i,j)
        adflux(i,j) = 0.
        drj = al(i)-q(i-1,j)
        addrk = addr*sign(1.,min(abs(xt),abs(drj)))*sign(1.,xt)
        addrl = addrk*(0.5-sign(0.5,abs(drj)-abs(xt)))*sign(1.,drj)
        adxt = adxt+addrk*(0.5+sign(0.5,abs(drj)-abs(xt)))*sign(1.,xt)
        adal(i) = adal(i)+addrl
        adq(i-1,j) = adq(i-1,j)-addrl
        addr = 0.
        dlj = al(i-1)-q(i-1,j)
        addlk = addl*sign(1.,min(abs(xt),abs(dlj)))*sign(1.,xt)
        addll = addlk*(0.5-sign(0.5,abs(dlj)-abs(xt)))*sign(1.,dlj)
        adxt = adxt+addlk*(0.5+sign(0.5,abs(dlj)-abs(xt)))*sign(1.,xt)
        adal(i-1) = adal(i-1)+addll
        adq(i-1,j) = adq(i-1,j)-addll
        addl = 0.
        addm1(i-1) = addm1(i-1)+2*adxt
        adxt = 0.
      else
        xt = 2.*dm1(i)
        dl = sign(min(abs(xt),abs(al(i)-q(i,j))),xt)
        dr = sign(min(abs(xt),abs(al(i+1)-q(i,j))),xt)
        adc(i,j) = adc(i,j)-adflux(i,j)*((1.+2*c(i,j))*(dl-dr)+dl)
        addl = addl-adflux(i,j)*(1.+c(i,j))*(1+c(i,j))
        addr = addr+adflux(i,j)*(1.+c(i,j))*c(i,j)
        adq(i,j) = adq(i,j)+adflux(i,j)
        adflux(i,j) = 0.
        dri = al(i+1)-q(i,j)
        addri = addr*sign(1.,min(abs(xt),abs(dri)))*sign(1.,xt)
        addrj = addri*(0.5-sign(0.5,abs(dri)-abs(xt)))*sign(1.,dri)
        adxt = adxt+addri*(0.5+sign(0.5,abs(dri)-abs(xt)))*sign(1.,xt)
        adal(i+1) = adal(i+1)+addrj
        adq(i,j) = adq(i,j)-addrj
        addr = 0.
        dli = al(i)-q(i,j)
        addli = addl*sign(1.,min(abs(xt),abs(dli)))*sign(1.,xt)
        addlj = addli*(0.5-sign(0.5,abs(dli)-abs(xt)))*sign(1.,dli)
        adxt = adxt+addli*(0.5+sign(0.5,abs(dli)-abs(xt)))*sign(1.,xt)
        adal(i) = adal(i)+addlj
        adq(i,j) = adq(i,j)-addlj
        addl = 0.
        addm1(i) = addm1(i)+2*adxt
        adxt = 0.
      endif
    end do
    do i = ifirst-1, ilast+2
      addm1(i-1) = addm1(i-1)+adal(i)*r3
      addm1(i) = addm1(i)-adal(i)*r3
      adq(i-1,j) = adq(i-1,j)+0.5*adal(i)
      adq(i,j) = adq(i,j)+0.5*adal(i)
      adal(i) = 0.
    end do
    if (uniform_ppm) then
      do i = ifirst-2, ilast+2
        adxt = 0.
        xt = 0.25*(q(i+1,j)-q(i-1,j))
        dm1zl = abs(xt)
        dm1zm = max(q(i-1,j),q(i,j))
        dm1zo = max(dm1zm,q(i+1,j))-q(i,j)
        dm1zp = min(q(i-1,j),q(i,j))
        dm1zr = q(i,j)-min(dm1zp,q(i+1,j))
        dm1zs = min(dm1zl,dm1zo)
        addm1zzc = addm1(i)*sign(1.,min(dm1zs,dm1zr))*sign(1.,xt)
        addm1zza = addm1zzc*(0.5-sign(0.5,dm1zr-dm1zs))
        addm1zzb = addm1zzc*(0.5+sign(0.5,dm1zr-dm1zs))
        addm1zu = addm1zzb*(0.5+sign(0.5,dm1zo-dm1zl))
        addm1zx = addm1zzb*(0.5-sign(0.5,dm1zo-dm1zl))
        addm1zz = -addm1zza
        adq(i,j) = adq(i,j)+addm1zza
        addm1zy = addm1zz*(0.5+sign(0.5,q(i+1,j)-dm1zp))
        adq(i+1,j) = adq(i+1,j)+addm1zz*(0.5-sign(0.5,q(i+1,j)-dm1zp))
        adq(i-1,j) = adq(i-1,j)+addm1zy*(0.5+sign(0.5,q(i,j)-q(i-1,j)))
        adq(i,j) = adq(i,j)+addm1zy*(0.5-sign(0.5,q(i,j)-q(i-1,j)))
        adq(i,j) = adq(i,j)-addm1zx
        addm1zv = addm1zx*(0.5+sign(0.5,dm1zm-q(i+1,j)))
        adq(i+1,j) = adq(i+1,j)+addm1zx*(0.5-sign(0.5,dm1zm-q(i+1,j)))
        adq(i-1,j) = adq(i-1,j)+addm1zv*(0.5+sign(0.5,q(i-1,j)-q(i,j)))
        adq(i,j) = adq(i,j)+addm1zv*(0.5-sign(0.5,q(i-1,j)-q(i,j)))
        adxt = adxt+addm1zu*sign(1.,xt)
        addm1(i) = 0.
        adq(i-1,j) = adq(i-1,j)-0.25*adxt
        adq(i+1,j) = adq(i+1,j)+0.25*adxt
        adxt = 0.
      end do
    else
      do i = ifirst-2, ilast+2
        adxt = 0.
        xt = cx1(i,j)*dq(i-1)+cx2(i,j)*dq(i)
        dm1zd = abs(xt)
        dm1zg = abs(dq(i-1))
        dm1zj = abs(dq(i))
        dm1zk = min(dm1zd,dm1zg)
        addm1zt = addm1(i)*sign(1.,min(dm1zk,dm1zj))*sign(1.,xt)
        addm1zr = addm1zt*(0.5-sign(0.5,dm1zj-dm1zk))
        addm1zs = addm1zt*(0.5+sign(0.5,dm1zj-dm1zk))
        addm1zj = addm1zs*(0.5+sign(0.5,dm1zg-dm1zd))
        addm1zq = addm1zs*(0.5-sign(0.5,dm1zg-dm1zd))
        addq(i) = addq(i)+addm1zr*sign(1.,dq(i))
        addq(i-1) = addq(i-1)+addm1zq*sign(1.,dq(i-1))
        adxt = adxt+addm1zj*sign(1.,xt)
        addm1(i) = 0.
        addq(i-1) = addq(i-1)+adxt*cx1(i,j)
        addq(i) = addq(i)+adxt*cx2(i,j)
        adxt = 0.
      end do
      do i = ifirst-3, ilast+2
        adq(i+1,j) = adq(i+1,j)+addq(i)
        adq(i,j) = adq(i,j)-addq(i)
        addq(i) = 0.
      end do
    endif
  end do
else if (iord .eq. 5) then
  do j = jfirst, jlast
    adlac = 0.
    adpmp = 0.
    adxt = 0.
    do i = ifirst-3, ilast+2
      dq(i) = q(i+1,j)-q(i,j)
    end do
    if (uniform_ppm) then
      do i = ifirst-2, ilast+2
        xt = 0.25*(q(i+1,j)-q(i-1,j))
        dm1(i) = sign(min(abs(xt),max(q(i-1,j),q(i,j),q(i+1,j))-q(i,j),q(i,j)-min(q(i-1,j),q(i,j),q(i+1,j))),xt)
      end do
    else
      do i = ifirst-2, ilast+2
        xt = cx1(i,j)*dq(i-1)+cx2(i,j)*dq(i)
        dm1(i) = sign(min(abs(xt),abs(dq(i-1)),abs(dq(i))),xt)
      end do
    endif
    do i = ifirst-1, ilast+2
      al(i) = 0.5*(q(i-1,j)+q(i,j))+r3*(dm1(i-1)-dm1(i))
    end do
    do i = ifirst-1, ilast+1
      pmp = -(2.*dq(i))
      lac = pmp+1.5*dq(i+1)
      bl(i) = min(max(0.,pmp,lac),max(al(i)-q(i,j),min(0.,pmp,lac)))
      pmp = 2.*dq(i-1)
      lac = pmp-1.5*dq(i-2)
      br(i) = min(max(0.,pmp,lac),max(al(i+1)-q(i,j),min(0.,pmp,lac)))
    end do
    do i = ifirst, ilast+1
      if (c(i,j) .gt. 0.) then
        adbl(i-1) = adbl(i-1)-adflux(i,j)*(1.-c(i,j))*c(i,j)
        adbr(i-1) = adbr(i-1)+adflux(i,j)*(1.-c(i,j))*(1-c(i,j))
        adc(i,j) = adc(i,j)+adflux(i,j)*((-((1.-c(i,j))*(bl(i-1)+br(i-1))))-(br(i-1)-c(i,j)*(bl(i-1)+br(i-1))))
        adq(i-1,j) = adq(i-1,j)+adflux(i,j)
        adflux(i,j) = 0.
      else
        adbl(i) = adbl(i)+adflux(i,j)*(1.+c(i,j))*(1+c(i,j))
        adbr(i) = adbr(i)+adflux(i,j)*(1.+c(i,j))*c(i,j)
        adc(i,j) = adc(i,j)+adflux(i,j)*((1.+c(i,j))*(bl(i)+br(i))+bl(i)+c(i,j)*(bl(i)+br(i)))
        adq(i,j) = adq(i,j)+adflux(i,j)
        adflux(i,j) = 0.
      endif
    end do
    do i = ifirst-1, ilast+1
      adlac = 0.
      adpmp = 0.
      pmp = 2.*dq(i-1)
      lac = pmp-1.5*dq(i-2)
      brzk = max(0.,pmp)
      brzl = max(brzk,lac)
      brzn = min(0.,pmp)
      brzo = min(brzn,lac)
      brzm = max(al(i+1)-q(i,j),brzo)
      adbrzl = adbr(i)*(0.5+sign(0.5,brzm-brzl))
      adbrzm = adbr(i)*(0.5-sign(0.5,brzm-brzl))
      adal(i+1) = adal(i+1)+adbrzm*(0.5+sign(0.5,al(i+1)-q(i,j)-brzo))
      adbrzo = adbrzm*(0.5-sign(0.5,al(i+1)-q(i,j)-brzo))
      adq(i,j) = adq(i,j)-adbrzm*(0.5+sign(0.5,al(i+1)-q(i,j)-brzo))
      adbrzn = adbrzo*(0.5+sign(0.5,lac-brzn))
      adlac = adlac+adbrzo*(0.5-sign(0.5,lac-brzn))
      adpmp = adpmp+adbrzn*(0.5-sign(0.5,pmp-0.))
      adbrzk = adbrzl*(0.5+sign(0.5,brzk-lac))
      adlac = adlac+adbrzl*(0.5-sign(0.5,brzk-lac))
      adpmp = adpmp+adbrzk*(0.5-sign(0.5,0.-pmp))
      adbr(i) = 0.
      addq(i-2) = addq(i-2)-1.5*adlac
      adpmp = adpmp+adlac
      adlac = 0.
      addq(i-1) = addq(i-1)+2*adpmp
      adpmp = 0.
      pmp = -(2.*dq(i))
      lac = pmp+1.5*dq(i+1)
      blzk = max(0.,pmp)
      blzl = max(blzk,lac)
      blzn = min(0.,pmp)
      blzo = min(blzn,lac)
      blzm = max(al(i)-q(i,j),blzo)
      adblzl = adbl(i)*(0.5+sign(0.5,blzm-blzl))
      adblzm = adbl(i)*(0.5-sign(0.5,blzm-blzl))
      adal(i) = adal(i)+adblzm*(0.5+sign(0.5,al(i)-q(i,j)-blzo))
      adblzo = adblzm*(0.5-sign(0.5,al(i)-q(i,j)-blzo))
      adq(i,j) = adq(i,j)-adblzm*(0.5+sign(0.5,al(i)-q(i,j)-blzo))
      adblzn = adblzo*(0.5+sign(0.5,lac-blzn))
      adlac = adlac+adblzo*(0.5-sign(0.5,lac-blzn))
      adpmp = adpmp+adblzn*(0.5-sign(0.5,pmp-0.))
      adblzk = adblzl*(0.5+sign(0.5,blzk-lac))
      adlac = adlac+adblzl*(0.5-sign(0.5,blzk-lac))
      adpmp = adpmp+adblzk*(0.5-sign(0.5,0.-pmp))
      adbl(i) = 0.
      addq(i+1) = addq(i+1)+1.5*adlac
      adpmp = adpmp+adlac
      adlac = 0.
      addq(i) = addq(i)-2*adpmp
      adpmp = 0.
    end do
    do i = ifirst-1, ilast+2
      addm1(i-1) = addm1(i-1)+adal(i)*r3
      addm1(i) = addm1(i)-adal(i)*r3
      adq(i-1,j) = adq(i-1,j)+0.5*adal(i)
      adq(i,j) = adq(i,j)+0.5*adal(i)
      adal(i) = 0.
    end do
    if (uniform_ppm) then
      do i = ifirst-2, ilast+2
        adxt = 0.
        xt = 0.25*(q(i+1,j)-q(i-1,j))
        dm1zb = abs(xt)
        dm1zc = max(q(i-1,j),q(i,j))
        dm1ze = max(dm1zc,q(i+1,j))-q(i,j)
        dm1zf = min(q(i-1,j),q(i,j))
        dm1zh = q(i,j)-min(dm1zf,q(i+1,j))
        dm1zi = min(dm1zb,dm1ze)
        addm1zp = addm1(i)*sign(1.,min(dm1zi,dm1zh))*sign(1.,xt)
        addm1zn = addm1zp*(0.5-sign(0.5,dm1zh-dm1zi))
        addm1zo = addm1zp*(0.5+sign(0.5,dm1zh-dm1zi))
        addm1zh = addm1zo*(0.5+sign(0.5,dm1ze-dm1zb))
        addm1zk = addm1zo*(0.5-sign(0.5,dm1ze-dm1zb))
        addm1zm = -addm1zn
        adq(i,j) = adq(i,j)+addm1zn
        addm1zl = addm1zm*(0.5+sign(0.5,q(i+1,j)-dm1zf))
        adq(i+1,j) = adq(i+1,j)+addm1zm*(0.5-sign(0.5,q(i+1,j)-dm1zf))
        adq(i-1,j) = adq(i-1,j)+addm1zl*(0.5+sign(0.5,q(i,j)-q(i-1,j)))
        adq(i,j) = adq(i,j)+addm1zl*(0.5-sign(0.5,q(i,j)-q(i-1,j)))
        adq(i,j) = adq(i,j)-addm1zk
        addm1zi = addm1zk*(0.5+sign(0.5,dm1zc-q(i+1,j)))
        adq(i+1,j) = adq(i+1,j)+addm1zk*(0.5-sign(0.5,dm1zc-q(i+1,j)))
        adq(i-1,j) = adq(i-1,j)+addm1zi*(0.5+sign(0.5,q(i-1,j)-q(i,j)))
        adq(i,j) = adq(i,j)+addm1zi*(0.5-sign(0.5,q(i-1,j)-q(i,j)))
        adxt = adxt+addm1zh*sign(1.,xt)
        addm1(i) = 0.
        adq(i-1,j) = adq(i-1,j)-0.25*adxt
        adq(i+1,j) = adq(i+1,j)+0.25*adxt
        adxt = 0.
      end do
    else
      do i = ifirst-2, ilast+2
        adxt = 0.
        xt = cx1(i,j)*dq(i-1)+cx2(i,j)*dq(i)
        dm1t = abs(xt)
        dm1w = abs(dq(i-1))
        dm1z = abs(dq(i))
        dm1za = min(dm1t,dm1w)
        addm1zg = addm1(i)*sign(1.,min(dm1za,dm1z))*sign(1.,xt)
        addm1ze = addm1zg*(0.5-sign(0.5,dm1z-dm1za))
        addm1zf = addm1zg*(0.5+sign(0.5,dm1z-dm1za))
        addm1w = addm1zf*(0.5+sign(0.5,dm1w-dm1t))
        addm1zd = addm1zf*(0.5-sign(0.5,dm1w-dm1t))
        addq(i) = addq(i)+addm1ze*sign(1.,dq(i))
        addq(i-1) = addq(i-1)+addm1zd*sign(1.,dq(i-1))
        adxt = adxt+addm1w*sign(1.,xt)
        addm1(i) = 0.
        addq(i-1) = addq(i-1)+adxt*cx1(i,j)
        addq(i) = addq(i)+adxt*cx2(i,j)
        adxt = 0.
      end do
    endif
    do i = ifirst-3, ilast+2
      adq(i+1,j) = adq(i+1,j)+addq(i)
      adq(i,j) = adq(i,j)-addq(i)
      addq(i) = 0.
    end do
  end do
else if (iord .eq. 6 .or. iord .eq. 7) then
  do j = jfirst, jlast
    addl = 0.
    addr = 0.
    adlac = 0.
    adpmp = 0.
    adxt = 0.
    do i = ifirst-1, ilast+1
      xt = b3*q(i,j)
      bl(i) = b5*q(i-2,j)+b4*q(i-1,j)+xt+b2*q(i+1,j)+b1*q(i+2,j)
      br(i) = b1*q(i-2,j)+b2*q(i-1,j)+xt+b4*q(i+1,j)+b5*q(i+2,j)
    end do
    if (iord .eq. 7) then
      do i = ifirst-2, ilast+3
        dq(i) = q(i,j)-q(i-1,j)
      end do
      do i = ifirst-1, ilast+1
        dl = -sign(min(abs(bl(i)),abs(dq(i))),dq(i))
        pmp = -(2.*dq(i+1))
        lac = pmp+1.5*dq(i+2)
        bl(i) = min(max(0.,pmp,lac),max(dl,min(0.,pmp,lac)))
        dr = sign(min(abs(br(i)),abs(dq(i+1))),dq(i+1))
        pmp = 2.*dq(i)
        lac = pmp-1.5*dq(i-1)
        br(i) = min(max(0.,pmp,lac),max(dr,min(0.,pmp,lac)))
      end do
    endif
    do i = ifirst, ilast+1
      if (c(i,j) .gt. 0.) then
        adbl(i-1) = adbl(i-1)-adflux(i,j)*(1.-c(i,j))*c(i,j)
        adbr(i-1) = adbr(i-1)+adflux(i,j)*(1.-c(i,j))*(1-c(i,j))
        adc(i,j) = adc(i,j)+adflux(i,j)*((-((1.-c(i,j))*(bl(i-1)+br(i-1))))-(br(i-1)-c(i,j)*(bl(i-1)+br(i-1))))
        adq(i-1,j) = adq(i-1,j)+adflux(i,j)
        adflux(i,j) = 0.
      else
        adbl(i) = adbl(i)+adflux(i,j)*(1.+c(i,j))*(1+c(i,j))
        adbr(i) = adbr(i)+adflux(i,j)*(1.+c(i,j))*c(i,j)
        adc(i,j) = adc(i,j)+adflux(i,j)*((1.+c(i,j))*(bl(i)+br(i))+bl(i)+c(i,j)*(bl(i)+br(i)))
        adq(i,j) = adq(i,j)+adflux(i,j)
        adflux(i,j) = 0.
      endif
    end do
    do i = ifirst-1, ilast+1
      xt = b3*q(i,j)
      bl(i) = b5*q(i-2,j)+b4*q(i-1,j)+xt+b2*q(i+1,j)+b1*q(i+2,j)
      br(i) = b1*q(i-2,j)+b2*q(i-1,j)+xt+b4*q(i+1,j)+b5*q(i+2,j)
    end do
    if (iord .eq. 7) then
      do i = ifirst-1, ilast+1
        addl = 0.
        addr = 0.
        adlac = 0.
        adpmp = 0.
        dl = -sign(min(abs(bl(i)),abs(dq(i))),dq(i))
        dr = sign(min(abs(br(i)),abs(dq(i+1))),dq(i+1))
        pmp = 2.*dq(i)
        lac = pmp-1.5*dq(i-1)
        brzf = max(0.,pmp)
        brzg = max(brzf,lac)
        brzi = min(0.,pmp)
        brzj = min(brzi,lac)
        brzh = max(dr,brzj)
        adbrzg = adbr(i)*(0.5+sign(0.5,brzh-brzg))
        adbrzh = adbr(i)*(0.5-sign(0.5,brzh-brzg))
        adbrzj = adbrzh*(0.5-sign(0.5,dr-brzj))
        addr = addr+adbrzh*(0.5+sign(0.5,dr-brzj))
        adbrzi = adbrzj*(0.5+sign(0.5,lac-brzi))
        adlac = adlac+adbrzj*(0.5-sign(0.5,lac-brzi))
        adpmp = adpmp+adbrzi*(0.5-sign(0.5,pmp-0.))
        adbrzf = adbrzg*(0.5+sign(0.5,brzf-lac))
        adlac = adlac+adbrzg*(0.5-sign(0.5,brzf-lac))
        adpmp = adpmp+adbrzf*(0.5-sign(0.5,0.-pmp))
        adbr(i) = 0.
        addq(i-1) = addq(i-1)-1.5*adlac
        adpmp = adpmp+adlac
        adlac = 0.
        addq(i) = addq(i)+2*adpmp
        adpmp = 0.
        addrh = addr*sign(1.,min(abs(br(i)),abs(dq(i+1))))*sign(1.,dq(i+1))
        adbr(i) = adbr(i)+addrh*(0.5+sign(0.5,abs(dq(i+1))-abs(br(i))))*sign(1.,br(i))
        addq(i+1) = addq(i+1)+addrh*(0.5-sign(0.5,abs(dq(i+1))-abs(br(i))))*sign(1.,dq(i+1))
        addr = 0.
        pmp = -(2.*dq(i+1))
        lac = pmp+1.5*dq(i+2)
        blzf = max(0.,pmp)
        blzg = max(blzf,lac)
        blzi = min(0.,pmp)
        blzj = min(blzi,lac)
        blzh = max(dl,blzj)
        adblzg = adbl(i)*(0.5+sign(0.5,blzh-blzg))
        adblzh = adbl(i)*(0.5-sign(0.5,blzh-blzg))
        adblzj = adblzh*(0.5-sign(0.5,dl-blzj))
        addl = addl+adblzh*(0.5+sign(0.5,dl-blzj))
        adblzi = adblzj*(0.5+sign(0.5,lac-blzi))
        adlac = adlac+adblzj*(0.5-sign(0.5,lac-blzi))
        adpmp = adpmp+adblzi*(0.5-sign(0.5,pmp-0.))
        adblzf = adblzg*(0.5+sign(0.5,blzf-lac))
        adlac = adlac+adblzg*(0.5-sign(0.5,blzf-lac))
        adpmp = adpmp+adblzf*(0.5-sign(0.5,0.-pmp))
        adbl(i) = 0.
        addq(i+2) = addq(i+2)+1.5*adlac
        adpmp = adpmp+adlac
        adlac = 0.
        addq(i+1) = addq(i+1)-2*adpmp
        adpmp = 0.
        addlh = -(addl*sign(1.,min(abs(bl(i)),abs(dq(i))))*sign(1.,dq(i)))
        adbl(i) = adbl(i)+addlh*(0.5+sign(0.5,abs(dq(i))-abs(bl(i))))*sign(1.,bl(i))
        addq(i) = addq(i)+addlh*(0.5-sign(0.5,abs(dq(i))-abs(bl(i))))*sign(1.,dq(i))
        addl = 0.
      end do
      do i = ifirst-2, ilast+3
        adq(i-1,j) = adq(i-1,j)-addq(i)
        adq(i,j) = adq(i,j)+addq(i)
        addq(i) = 0.
      end do
    endif
    do i = ifirst-1, ilast+1
      adxt = 0.
      adq(i-2,j) = adq(i-2,j)+adbr(i)*b1
      adq(i-1,j) = adq(i-1,j)+adbr(i)*b2
      adq(i+2,j) = adq(i+2,j)+adbr(i)*b5
      adq(i+1,j) = adq(i+1,j)+adbr(i)*b4
      adxt = adxt+adbr(i)
      adbr(i) = 0.
      adq(i-2,j) = adq(i-2,j)+adbl(i)*b5
      adq(i-1,j) = adq(i-1,j)+adbl(i)*b4
      adq(i+2,j) = adq(i+2,j)+adbl(i)*b1
      adq(i+1,j) = adq(i+1,j)+adbl(i)*b2
      adxt = adxt+adbl(i)
      adbl(i) = 0.
      adq(i,j) = adq(i,j)+adxt*b3
      adxt = 0.
    end do
  end do
else if (iord .eq. 9 .or. iord .eq. 10) then
  is3 = max(3,is-1)
  ie3 = min(npx-3,ie+1)
  do j = jlast, jfirst, -1
    do j2 = jfirst, j-1
      do i = is-3, ie+2
        dq(i) = q(i+1,j2)-q(i,j2)
      end do
      if (uniform_ppm) then
        do i = is-2, ie+2
          xt = 0.25*(q(i+1,j2)-q(i-1,j2))
          dm1(i) = sign(min(abs(xt),max(q(i-1,j2),q(i,j2),q(i+1,j2))-q(i,j2),q(i,j2)-min(q(i-1,j2),q(i,j2),q(i+1,j2))),xt)
        end do
      else
        do i = is-2, ie+2
          xt = cx1(i,j2)*dq(i-1)+cx2(i,j2)*dq(i)
          dm1(i) = sign(min(abs(xt),abs(dq(i-1)),abs(dq(i))),xt)
        end do
      endif
      if (grid_type .lt. 3) then
        do i = is3, min(npx-2,ie+2)
          al(i) = 0.5*(q(i-1,j2)+q(i,j2))+r3*(dm1(i-1)-dm1(i))
        end do
        do i = is3, ie3
          pmp = -(2.*dq(i))
          lac = pmp+1.5*dq(i+1)
          bl(i) = min(max(0.,pmp,lac),max(al(i)-q(i,j2),min(0.,pmp,lac)))
          pmp = 2.*dq(i-1)
          lac = pmp-1.5*dq(i-2)
          br(i) = min(max(0.,pmp,lac),max(al(i+1)-q(i,j2),min(0.,pmp,lac)))
        end do
        if (is .eq. 1) then
          br(2) = al(3)-q(2,j2)
          xt = 0.5*((2.*dxa(1,j2)+dxa(2,j2))*(q(0,j2)+q(1,j2))-dxa(1,j2)*(q(-1,j2)+q(2,j2)))/(dxa(1,j2)+dxa(2,j2))
          if (edge_mono_kim) then
            if (j2 .gt. (-2) .and. j2 .lt. 1 .or. j2 .gt. npy-3 .and. j2 .lt. npy) then
              xt = min(xt,max(q(0,j2),q(1,j2),q(0,j2-1),q(1,j2-1)))
              xt = max(xt,min(q(0,j2),q(1,j2),q(0,j2-1),q(1,j2-1)))
            else if (j2 .lt. 3 .and. j2 .gt. 0 .or. j2 .gt. npy-1 .and. j2 .lt. npy+2) then
              xt = min(xt,max(q(0,j2),q(1,j2),q(0,j2+1),q(1,j2+1)))
              xt = max(xt,min(q(0,j2),q(1,j2),q(0,j2+1),q(1,j2+1)))
            endif
          endif
          bl(1) = xt-q(1,j2)
          br(0) = xt-q(0,j2)
          xt = 4./7.*dm1(-1)-11./14.*dq(-1)+q(0,j2)
          if (s_mono_kim) then
            xt = max(xt,min(q(-1,j2),q(0,j2)))
            xt = min(xt,max(q(-1,j2),q(0,j2)))
          endif
          bl(0) = xt-q(0,j2)
          xt = 3./14.*q(1,j2)+11./14.*q(2,j2)-4./7.*dm1(2)
          if (s_mono_kim) then
            xt = max(xt,min(q(1,j2),q(2,j2)))
            xt = min(xt,max(q(1,j2),q(2,j2)))
          endif
          br(1) = xt-q(1,j2)
          bl(2) = xt-q(2,j2)
          if (iord .eq. 9) then
            call pert_ppm( 3,q(0,j2),bl(0),br(0),1 )
          endif
        endif
        if (ie+1 .eq. npx) then
          bl(npx-2) = al(npx-2)-q(npx-2,j2)
          xt = 0.5*((2.*dxa(npx-1,j2)+dxa(npx-2,j2))*(q(npx-1,j2)+q(npx,j2))-dxa(npx-1,j2)*(q(npx-2,j2)+q(npx+1,j2)))/(dxa(npx-1,&
&j2)+dxa(npx-2,j2))
          if (edge_mono_kim) then
            if (j2 .gt. (-2) .and. j2 .lt. 1 .or. j2 .gt. npy-3 .and. j2 .lt. npy) then
              xt = min(xt,max(q(npx-1,j2),q(npx,j2),q(npx-1,j2-1),q(npx,j2-1)))
              xt = max(xt,min(q(npx-1,j2),q(npx,j2),q(npx-1,j2-1),q(npx,j2-1)))
            else if (j2 .lt. 3 .and. j2 .gt. 0 .or. j2 .gt. npy-1 .and. j2 .lt. npy+2) then
              xt = min(xt,max(q(npx-1,j2),q(npx,j2),q(npx-1,j2+1),q(npx,j2+1)))
              xt = max(xt,min(q(npx-1,j2),q(npx,j2),q(npx-1,j2+1),q(npx,j2+1)))
            endif
          endif
          br(npx-1) = xt-q(npx-1,j2)
          bl(npx) = xt-q(npx,j2)
          xt = 11./14.*dq(npx)-4./7.*dm1(npx+1)+q(npx,j2)
          if (s_mono_kim) then
            xt = min(xt,max(q(npx,j2),q(npx+1,j2)))
            xt = max(xt,min(q(npx,j2),q(npx+1,j2)))
          endif
          br(npx) = xt-q(npx,j2)
          xt = 3./14.*q(npx-1,j2)+11./14.*q(npx-2,j2)+4./7.*dm1(npx-2)
          if (s_mono_kim) then
            xt = min(xt,max(q(npx-2,j2),q(npx-1,j2)))
            xt = max(xt,min(q(npx-2,j2),q(npx-1,j2)))
          endif
          br(npx-2) = xt-q(npx-2,j2)
          bl(npx-1) = xt-q(npx-1,j2)
          if (iord .eq. 9) then
            call pert_ppm( 3,q(npx-2,j2),bl(npx-2),br(npx-2),1 )
          endif
        endif
      else
        do i = is-1, ie+2
          al(i) = 0.5*(q(i-1,j2)+q(i,j2))+r3*(dm1(i-1)-dm1(i))
        end do
        do i = is-1, ie+1
          pmp = -(2.*dq(i))
          lac = pmp+1.5*dq(i+1)
          bl(i) = min(max(0.,pmp,lac),max(al(i)-q(i,j2),min(0.,pmp,lac)))
          pmp = 2.*dq(i-1)
          lac = pmp-1.5*dq(i-2)
          br(i) = min(max(0.,pmp,lac),max(al(i+1)-q(i,j2),min(0.,pmp,lac)))
        end do
      endif
    end do
    brze(:) = br(:)
    blze(:) = bl(:)
    do i = is-3, ie+2
      dq(i) = q(i+1,j)-q(i,j)
    end do
    if (uniform_ppm) then
      do i = is-2, ie+2
        xt = 0.25*(q(i+1,j)-q(i-1,j))
        dm1(i) = sign(min(abs(xt),max(q(i-1,j),q(i,j),q(i+1,j))-q(i,j),q(i,j)-min(q(i-1,j),q(i,j),q(i+1,j))),xt)
      end do
    else
      do i = is-2, ie+2
        xt = cx1(i,j)*dq(i-1)+cx2(i,j)*dq(i)
        dm1(i) = sign(min(abs(xt),abs(dq(i-1)),abs(dq(i))),xt)
      end do
    endif
    if (grid_type .lt. 3) then
      do i = is3, min(npx-2,ie+2)
        al(i) = 0.5*(q(i-1,j)+q(i,j))+r3*(dm1(i-1)-dm1(i))
      end do
      do i = is3, ie3
        pmp = -(2.*dq(i))
        lac = pmp+1.5*dq(i+1)
        bl(i) = min(max(0.,pmp,lac),max(al(i)-q(i,j),min(0.,pmp,lac)))
        pmp = 2.*dq(i-1)
        lac = pmp-1.5*dq(i-2)
        br(i) = min(max(0.,pmp,lac),max(al(i+1)-q(i,j),min(0.,pmp,lac)))
      end do
      if (is .eq. 1) then
        br(2) = al(3)-q(2,j)
        xt = 0.5*((2.*dxa(1,j)+dxa(2,j))*(q(0,j)+q(1,j))-dxa(1,j)*(q(-1,j)+q(2,j)))/(dxa(1,j)+dxa(2,j))
        if (edge_mono_kim) then
          if (j .gt. (-2) .and. j .lt. 1 .or. j .gt. npy-3 .and. j .lt. npy) then
            xt = min(xt,max(q(0,j),q(1,j),q(0,j-1),q(1,j-1)))
            xt = max(xt,min(q(0,j),q(1,j),q(0,j-1),q(1,j-1)))
          else if (j .lt. 3 .and. j .gt. 0 .or. j .gt. npy-1 .and. j .lt. npy+2) then
            xt = min(xt,max(q(0,j),q(1,j),q(0,j+1),q(1,j+1)))
            xt = max(xt,min(q(0,j),q(1,j),q(0,j+1),q(1,j+1)))
          endif
        endif
        bl(1) = xt-q(1,j)
        br(0) = xt-q(0,j)
        xt = 4./7.*dm1(-1)-11./14.*dq(-1)+q(0,j)
        if (s_mono_kim) then
          xt = max(xt,min(q(-1,j),q(0,j)))
          xt = min(xt,max(q(-1,j),q(0,j)))
        endif
        bl(0) = xt-q(0,j)
        xt = 3./14.*q(1,j)+11./14.*q(2,j)-4./7.*dm1(2)
        if (s_mono_kim) then
          xt = max(xt,min(q(1,j),q(2,j)))
          xt = min(xt,max(q(1,j),q(2,j)))
        endif
        br(1) = xt-q(1,j)
        bl(2) = xt-q(2,j)
        if (iord .eq. 9) then
          call pert_ppm( 3,q(0,j),bl(0),br(0),1 )
        endif
      endif
      if (ie+1 .eq. npx) then
        bl(npx-2) = al(npx-2)-q(npx-2,j)
        xt = 0.5*((2.*dxa(npx-1,j)+dxa(npx-2,j))*(q(npx-1,j)+q(npx,j))-dxa(npx-1,j)*(q(npx-2,j)+q(npx+1,j)))/(dxa(npx-1,j)+dxa(npx-&
&2,j))
        if (edge_mono_kim) then
          if (j .gt. (-2) .and. j .lt. 1 .or. j .gt. npy-3 .and. j .lt. npy) then
            xt = min(xt,max(q(npx-1,j),q(npx,j),q(npx-1,j-1),q(npx,j-1)))
            xt = max(xt,min(q(npx-1,j),q(npx,j),q(npx-1,j-1),q(npx,j-1)))
          else if (j .lt. 3 .and. j .gt. 0 .or. j .gt. npy-1 .and. j .lt. npy+2) then
            xt = min(xt,max(q(npx-1,j),q(npx,j),q(npx-1,j+1),q(npx,j+1)))
            xt = max(xt,min(q(npx-1,j),q(npx,j),q(npx-1,j+1),q(npx,j+1)))
          endif
        endif
        br(npx-1) = xt-q(npx-1,j)
        bl(npx) = xt-q(npx,j)
        xt = 11./14.*dq(npx)-4./7.*dm1(npx+1)+q(npx,j)
        if (s_mono_kim) then
          xt = min(xt,max(q(npx,j),q(npx+1,j)))
          xt = max(xt,min(q(npx,j),q(npx+1,j)))
        endif
        br(npx) = xt-q(npx,j)
        xt = 3./14.*q(npx-1,j)+11./14.*q(npx-2,j)+4./7.*dm1(npx-2)
        if (s_mono_kim) then
          xt = min(xt,max(q(npx-2,j),q(npx-1,j)))
          xt = max(xt,min(q(npx-2,j),q(npx-1,j)))
        endif
        br(npx-2) = xt-q(npx-2,j)
        bl(npx-1) = xt-q(npx-1,j)
        if (iord .eq. 9) then
          call pert_ppm( 3,q(npx-2,j),bl(npx-2),br(npx-2),1 )
        endif
      endif
    else
      do i = is-1, ie+2
        al(i) = 0.5*(q(i-1,j)+q(i,j))+r3*(dm1(i-1)-dm1(i))
      end do
      do i = is-1, ie+1
        pmp = -(2.*dq(i))
        lac = pmp+1.5*dq(i+1)
        bl(i) = min(max(0.,pmp,lac),max(al(i)-q(i,j),min(0.,pmp,lac)))
        pmp = 2.*dq(i-1)
        lac = pmp-1.5*dq(i-2)
        br(i) = min(max(0.,pmp,lac),max(al(i+1)-q(i,j),min(0.,pmp,lac)))
      end do
    endif
    do i = is, ie+1
      adc1 = 0.
      adqe = 0.
      if (intel_opt_kim) then
        c1 = c(i,j)
        if (c1 .gt. 0.) then
          it = i-1
          qe = br(i-1)
        else
          it = i
          qe = bl(i)
        endif
        c1 = -abs(c1)
        adbl(it) = adbl(it)+adflux(i,j)*(1.+c1)*c1
        adbr(it) = adbr(it)+adflux(i,j)*(1.+c1)*c1
        adc1 = adc1+adflux(i,j)*((1.+c1)*(bl(it)+br(it))+qe+c1*(bl(it)+br(it)))
        adq(it,j) = adq(it,j)+adflux(i,j)
        adqe = adqe+adflux(i,j)*(1+c1)
        adflux(i,j) = 0.
        c1 = c(i,j)
        adc1 = -(adc1*sign(1.,c1))
        c1 = c(i,j)
        if (c1 .gt. 0.) then
          adbr(i-1) = adbr(i-1)+adqe
          adqe = 0.
        else
          adbl(i) = adbl(i)+adqe
          adqe = 0.
        endif
        adc(i,j) = adc(i,j)+adc1
        adc1 = 0.
      else
        if (c(i,j) .gt. 0.) then
          adbl(i-1) = adbl(i-1)-adflux(i,j)*(1.-c(i,j))*c(i,j)
          adbr(i-1) = adbr(i-1)+adflux(i,j)*(1.-c(i,j))*(1-c(i,j))
          adc(i,j) = adc(i,j)+adflux(i,j)*((-((1.-c(i,j))*(bl(i-1)+br(i-1))))-(br(i-1)-c(i,j)*(bl(i-1)+br(i-1))))
          adq(i-1,j) = adq(i-1,j)+adflux(i,j)
          adflux(i,j) = 0.
        else
          adbl(i) = adbl(i)+adflux(i,j)*(1.+c(i,j))*(1+c(i,j))
          adbr(i) = adbr(i)+adflux(i,j)*(1.+c(i,j))*c(i,j)
          adc(i,j) = adc(i,j)+adflux(i,j)*((1.+c(i,j))*(bl(i)+br(i))+bl(i)+c(i,j)*(bl(i)+br(i)))
          adq(i,j) = adq(i,j)+adflux(i,j)
          adflux(i,j) = 0.
        endif
      endif
    end do
    bl(:) = blze(:)
    br(:) = brze(:)
    if (grid_type .lt. 3) then
      do i = is3, ie3
        pmp = -(2.*dq(i))
        lac = pmp+1.5*dq(i+1)
        bl(i) = min(max(0.,pmp,lac),max(al(i)-q(i,j),min(0.,pmp,lac)))
        pmp = 2.*dq(i-1)
        lac = pmp-1.5*dq(i-2)
        br(i) = min(max(0.,pmp,lac),max(al(i+1)-q(i,j),min(0.,pmp,lac)))
      end do
      if (is .eq. 1) then
        br(2) = al(3)-q(2,j)
        xt = 0.5*((2.*dxa(1,j)+dxa(2,j))*(q(0,j)+q(1,j))-dxa(1,j)*(q(-1,j)+q(2,j)))/(dxa(1,j)+dxa(2,j))
        if (edge_mono_kim) then
          if (j .gt. (-2) .and. j .lt. 1 .or. j .gt. npy-3 .and. j .lt. npy) then
            xt = min(xt,max(q(0,j),q(1,j),q(0,j-1),q(1,j-1)))
            xt = max(xt,min(q(0,j),q(1,j),q(0,j-1),q(1,j-1)))
          else if (j .lt. 3 .and. j .gt. 0 .or. j .gt. npy-1 .and. j .lt. npy+2) then
            xt = min(xt,max(q(0,j),q(1,j),q(0,j+1),q(1,j+1)))
            xt = max(xt,min(q(0,j),q(1,j),q(0,j+1),q(1,j+1)))
          endif
        endif
        bl(1) = xt-q(1,j)
        br(0) = xt-q(0,j)
        xt = 4./7.*dm1(-1)-11./14.*dq(-1)+q(0,j)
        if (s_mono_kim) then
          xt = max(xt,min(q(-1,j),q(0,j)))
          xt = min(xt,max(q(-1,j),q(0,j)))
        endif
        bl(0) = xt-q(0,j)
        xt = 3./14.*q(1,j)+11./14.*q(2,j)-4./7.*dm1(2)
        if (s_mono_kim) then
          xt = max(xt,min(q(1,j),q(2,j)))
          xt = min(xt,max(q(1,j),q(2,j)))
        endif
        br(1) = xt-q(1,j)
        bl(2) = xt-q(2,j)
        if (iord .eq. 9) then
          call pert_ppm( 3,q(0,j),bl(0),br(0),1 )
        endif
      endif
      if (ie+1 .eq. npx) then
        xtzs = xt
        xtzv = xt
        bl(npx-2) = al(npx-2)-q(npx-2,j)
        xt = 0.5*((2.*dxa(npx-1,j)+dxa(npx-2,j))*(q(npx-1,j)+q(npx,j))-dxa(npx-1,j)*(q(npx-2,j)+q(npx+1,j)))/(dxa(npx-1,j)+dxa(npx-&
&2,j))
        if (edge_mono_kim) then
          if (j .gt. (-2) .and. j .lt. 1 .or. j .gt. npy-3 .and. j .lt. npy) then
            xt = min(xt,max(q(npx-1,j),q(npx,j),q(npx-1,j-1),q(npx,j-1)))
            xt = max(xt,min(q(npx-1,j),q(npx,j),q(npx-1,j-1),q(npx,j-1)))
          else if (j .lt. 3 .and. j .gt. 0 .or. j .gt. npy-1 .and. j .lt. npy+2) then
            xt = min(xt,max(q(npx-1,j),q(npx,j),q(npx-1,j+1),q(npx,j+1)))
            xt = max(xt,min(q(npx-1,j),q(npx,j),q(npx-1,j+1),q(npx,j+1)))
          endif
        endif
        br(npx-1) = xt-q(npx-1,j)
        bl(npx) = xt-q(npx,j)
        xt = xtzv
        xt = 11./14.*dq(npx)-4./7.*dm1(npx+1)+q(npx,j)
        if (s_mono_kim) then
          xt = min(xt,max(q(npx,j),q(npx+1,j)))
          xt = max(xt,min(q(npx,j),q(npx+1,j)))
        endif
        br(npx) = xt-q(npx,j)
        xt = xtzs
        br(npx-2) = xt-q(npx-2,j)
        bl(npx-1) = xt-q(npx-1,j)
        if (iord .eq. 9) then
          call adpert_ppm( 3,q(npx-2,j),adq(npx-2,j),bl(npx-2),adbl(npx-2),br(npx-2),adbr(npx-2),1 )
        endif
        adq(npx-1,j) = adq(npx-1,j)-adbl(npx-1)
        adxt = adxt+adbl(npx-1)
        adbl(npx-1) = 0.
        adq(npx-2,j) = adq(npx-2,j)-adbr(npx-2)
        adxt = adxt+adbr(npx-2)
        adbr(npx-2) = 0.
        xt = 3./14.*q(npx-1,j)+11./14.*q(npx-2,j)+4./7.*dm1(npx-2)
        if (s_mono_kim) then
          xt = min(xt,max(q(npx-2,j),q(npx-1,j)))
          xtzq = min(q(npx-2,j),q(npx-1,j))
          adxtzq = adxt*(0.5-sign(0.5,xt-xtzq))
          adq(npx-2,j) = adq(npx-2,j)+adxtzq*(0.5+sign(0.5,q(npx-1,j)-q(npx-2,j)))
          adq(npx-1,j) = adq(npx-1,j)+adxtzq*(0.5-sign(0.5,q(npx-1,j)-q(npx-2,j)))
          adxt = adxt*(0.5+sign(0.5,xt-xtzq))
          bl(npx-2) = al(npx-2)-q(npx-2,j)
          xt = 0.5*((2.*dxa(npx-1,j)+dxa(npx-2,j))*(q(npx-1,j)+q(npx,j))-dxa(npx-1,j)*(q(npx-2,j)+q(npx+1,j)))/(dxa(npx-1,j)+&
&dxa(npx-2,j))
          if (edge_mono_kim) then
            if (j .gt. (-2) .and. j .lt. 1 .or. j .gt. npy-3 .and. j .lt. npy) then
              xt = min(xt,max(q(npx-1,j),q(npx,j),q(npx-1,j-1),q(npx,j-1)))
              xt = max(xt,min(q(npx-1,j),q(npx,j),q(npx-1,j-1),q(npx,j-1)))
            else if (j .lt. 3 .and. j .gt. 0 .or. j .gt. npy-1 .and. j .lt. npy+2) then
              xt = min(xt,max(q(npx-1,j),q(npx,j),q(npx-1,j+1),q(npx,j+1)))
              xt = max(xt,min(q(npx-1,j),q(npx,j),q(npx-1,j+1),q(npx,j+1)))
            endif
          endif
          br(npx-1) = xt-q(npx-1,j)
          bl(npx) = xt-q(npx,j)
          xt = 11./14.*dq(npx)-4./7.*dm1(npx+1)+q(npx,j)
          if (s_mono_kim) then
            xt = min(xt,max(q(npx,j),q(npx+1,j)))
            xt = max(xt,min(q(npx,j),q(npx+1,j)))
          endif
          br(npx) = xt-q(npx,j)
          xt = 3./14.*q(npx-1,j)+11./14.*q(npx-2,j)+4./7.*dm1(npx-2)
          xtzr = max(q(npx-2,j),q(npx-1,j))
          adxtzr = adxt*(0.5-sign(0.5,xtzr-xt))
          adq(npx-2,j) = adq(npx-2,j)+adxtzr*(0.5+sign(0.5,q(npx-2,j)-q(npx-1,j)))
          adq(npx-1,j) = adq(npx-1,j)+adxtzr*(0.5-sign(0.5,q(npx-2,j)-q(npx-1,j)))
          adxt = adxt*(0.5+sign(0.5,xtzr-xt))
        endif
        addm1(npx-2) = addm1(npx-2)+0.57142857*adxt
        adq(npx-2,j) = adq(npx-2,j)+0.78571429*adxt
        adq(npx-1,j) = adq(npx-1,j)+0.21428571*adxt
        adxt = 0.
        adq(npx,j) = adq(npx,j)-adbr(npx)
        adxt = adxt+adbr(npx)
        adbr(npx) = 0.
        xt = 11./14.*dq(npx)-4./7.*dm1(npx+1)+q(npx,j)
        if (s_mono_kim) then
          xt = min(xt,max(q(npx,j),q(npx+1,j)))
          xtzt = min(q(npx,j),q(npx+1,j))
          adxtzt = adxt*(0.5-sign(0.5,xt-xtzt))
          adq(npx+1,j) = adq(npx+1,j)+adxtzt*(0.5-sign(0.5,q(npx+1,j)-q(npx,j)))
          adq(npx,j) = adq(npx,j)+adxtzt*(0.5+sign(0.5,q(npx+1,j)-q(npx,j)))
          adxt = adxt*(0.5+sign(0.5,xt-xtzt))
          bl(npx-2) = al(npx-2)-q(npx-2,j)
          xt = 0.5*((2.*dxa(npx-1,j)+dxa(npx-2,j))*(q(npx-1,j)+q(npx,j))-dxa(npx-1,j)*(q(npx-2,j)+q(npx+1,j)))/(dxa(npx-1,j)+&
&dxa(npx-2,j))
          if (edge_mono_kim) then
            if (j .gt. (-2) .and. j .lt. 1 .or. j .gt. npy-3 .and. j .lt. npy) then
              xt = min(xt,max(q(npx-1,j),q(npx,j),q(npx-1,j-1),q(npx,j-1)))
              xt = max(xt,min(q(npx-1,j),q(npx,j),q(npx-1,j-1),q(npx,j-1)))
            else if (j .lt. 3 .and. j .gt. 0 .or. j .gt. npy-1 .and. j .lt. npy+2) then
              xt = min(xt,max(q(npx-1,j),q(npx,j),q(npx-1,j+1),q(npx,j+1)))
              xt = max(xt,min(q(npx-1,j),q(npx,j),q(npx-1,j+1),q(npx,j+1)))
            endif
          endif
          br(npx-1) = xt-q(npx-1,j)
          bl(npx) = xt-q(npx,j)
          xt = 11./14.*dq(npx)-4./7.*dm1(npx+1)+q(npx,j)
          xtzu = max(q(npx,j),q(npx+1,j))
          adxtzu = adxt*(0.5-sign(0.5,xtzu-xt))
          adq(npx+1,j) = adq(npx+1,j)+adxtzu*(0.5-sign(0.5,q(npx,j)-q(npx+1,j)))
          adq(npx,j) = adq(npx,j)+adxtzu*(0.5+sign(0.5,q(npx,j)-q(npx+1,j)))
          adxt = adxt*(0.5+sign(0.5,xtzu-xt))
        endif
        addm1(npx+1) = addm1(npx+1)-0.57142857*adxt
        addq(npx) = addq(npx)+0.78571429*adxt
        adq(npx,j) = adq(npx,j)+adxt
        adxt = 0.
        adq(npx,j) = adq(npx,j)-adbl(npx)
        adxt = adxt+adbl(npx)
        adbl(npx) = 0.
        adq(npx-1,j) = adq(npx-1,j)-adbr(npx-1)
        adxt = adxt+adbr(npx-1)
        adbr(npx-1) = 0.
        xt = 0.5*((2.*dxa(npx-1,j)+dxa(npx-2,j))*(q(npx-1,j)+q(npx,j))-dxa(npx-1,j)*(q(npx-2,j)+q(npx+1,j)))/(dxa(npx-1,j)+dxa(npx-&
&2,j))
        if (edge_mono_kim) then
          if (j .gt. (-2) .and. j .lt. 1 .or. j .gt. npy-3 .and. j .lt. npy) then
            xt = min(xt,max(q(npx-1,j),q(npx,j),q(npx-1,j-1),q(npx,j-1)))
            xtzzc = min(q(npx-1,j),q(npx,j))
            xtzzd = min(xtzzc,q(npx-1,j-1))
            xtzze = min(xtzzd,q(npx,j-1))
            adxtzze = adxt*(0.5-sign(0.5,xt-xtzze))
            adq(npx,j-1) = adq(npx,j-1)+adxtzze*(0.5-sign(0.5,q(npx,j-1)-xtzzd))
            adxtzzd = adxtzze*(0.5+sign(0.5,q(npx,j-1)-xtzzd))
            adq(npx-1,j-1) = adq(npx-1,j-1)+adxtzzd*(0.5-sign(0.5,q(npx-1,j-1)-xtzzc))
            adxtzzc = adxtzzd*(0.5+sign(0.5,q(npx-1,j-1)-xtzzc))
            adq(npx-1,j) = adq(npx-1,j)+adxtzzc*(0.5+sign(0.5,q(npx,j)-q(npx-1,j)))
            adq(npx,j) = adq(npx,j)+adxtzzc*(0.5-sign(0.5,q(npx,j)-q(npx-1,j)))
            adxt = adxt*(0.5+sign(0.5,xt-xtzze))
            bl(npx-2) = al(npx-2)-q(npx-2,j)
            xt = 0.5*((2.*dxa(npx-1,j)+dxa(npx-2,j))*(q(npx-1,j)+q(npx,j))-dxa(npx-1,j)*(q(npx-2,j)+q(npx+1,j)))/(dxa(npx-1,j)+&
&dxa(npx-2,j))
            xtzzf = max(q(npx-1,j),q(npx,j))
            xtzzg = max(xtzzf,q(npx-1,j-1))
            xtzzh = max(xtzzg,q(npx,j-1))
            adxtzzh = adxt*(0.5-sign(0.5,xtzzh-xt))
            adq(npx,j-1) = adq(npx,j-1)+adxtzzh*(0.5-sign(0.5,xtzzg-q(npx,j-1)))
            adxtzzg = adxtzzh*(0.5+sign(0.5,xtzzg-q(npx,j-1)))
            adq(npx-1,j-1) = adq(npx-1,j-1)+adxtzzg*(0.5-sign(0.5,xtzzf-q(npx-1,j-1)))
            adxtzzf = adxtzzg*(0.5+sign(0.5,xtzzf-q(npx-1,j-1)))
            adq(npx-1,j) = adq(npx-1,j)+adxtzzf*(0.5+sign(0.5,q(npx-1,j)-q(npx,j)))
            adq(npx,j) = adq(npx,j)+adxtzzf*(0.5-sign(0.5,q(npx-1,j)-q(npx,j)))
            adxt = adxt*(0.5+sign(0.5,xtzzh-xt))
          else if (j .lt. 3 .and. j .gt. 0 .or. j .gt. npy-1 .and. j .lt. npy+2) then
            xt = min(xt,max(q(npx-1,j),q(npx,j),q(npx-1,j+1),q(npx,j+1)))
            xtzw = min(q(npx-1,j),q(npx,j))
            xtzx = min(xtzw,q(npx-1,j+1))
            xtzy = min(xtzx,q(npx,j+1))
            adxtzy = adxt*(0.5-sign(0.5,xt-xtzy))
            adq(npx,j+1) = adq(npx,j+1)+adxtzy*(0.5-sign(0.5,q(npx,j+1)-xtzx))
            adxtzx = adxtzy*(0.5+sign(0.5,q(npx,j+1)-xtzx))
            adq(npx-1,j+1) = adq(npx-1,j+1)+adxtzx*(0.5-sign(0.5,q(npx-1,j+1)-xtzw))
            adxtzw = adxtzx*(0.5+sign(0.5,q(npx-1,j+1)-xtzw))
            adq(npx-1,j) = adq(npx-1,j)+adxtzw*(0.5+sign(0.5,q(npx,j)-q(npx-1,j)))
            adq(npx,j) = adq(npx,j)+adxtzw*(0.5-sign(0.5,q(npx,j)-q(npx-1,j)))
            adxt = adxt*(0.5+sign(0.5,xt-xtzy))
            bl(npx-2) = al(npx-2)-q(npx-2,j)
            xt = 0.5*((2.*dxa(npx-1,j)+dxa(npx-2,j))*(q(npx-1,j)+q(npx,j))-dxa(npx-1,j)*(q(npx-2,j)+q(npx+1,j)))/(dxa(npx-1,j)+&
&dxa(npx-2,j))
            xtzz = max(q(npx-1,j),q(npx,j))
            xtzza = max(xtzz,q(npx-1,j+1))
            xtzzb = max(xtzza,q(npx,j+1))
            adxtzzb = adxt*(0.5-sign(0.5,xtzzb-xt))
            adq(npx,j+1) = adq(npx,j+1)+adxtzzb*(0.5-sign(0.5,xtzza-q(npx,j+1)))
            adxtzza = adxtzzb*(0.5+sign(0.5,xtzza-q(npx,j+1)))
            adq(npx-1,j+1) = adq(npx-1,j+1)+adxtzza*(0.5-sign(0.5,xtzz-q(npx-1,j+1)))
            adxtzz = adxtzza*(0.5+sign(0.5,xtzz-q(npx-1,j+1)))
            adq(npx-1,j) = adq(npx-1,j)+adxtzz*(0.5+sign(0.5,q(npx-1,j)-q(npx,j)))
            adq(npx,j) = adq(npx,j)+adxtzz*(0.5-sign(0.5,q(npx-1,j)-q(npx,j)))
            adxt = adxt*(0.5+sign(0.5,xtzzb-xt))
          endif
        endif
        adq(npx-2,j) = adq(npx-2,j)-adxt*(0.5*dxa(npx-1,j)/(dxa(npx-1,j)+dxa(npx-2,j)))
        adq(npx-1,j) = adq(npx-1,j)+adxt*(0.5*(2.*dxa(npx-1,j)+dxa(npx-2,j))/(dxa(npx-1,j)+dxa(npx-2,j)))
        adq(npx+1,j) = adq(npx+1,j)-adxt*(0.5*dxa(npx-1,j)/(dxa(npx-1,j)+dxa(npx-2,j)))
        adq(npx,j) = adq(npx,j)+adxt*(0.5*(2.*dxa(npx-1,j)+dxa(npx-2,j))/(dxa(npx-1,j)+dxa(npx-2,j)))
        adxt = 0.
        adal(npx-2) = adal(npx-2)+adbl(npx-2)
        adq(npx-2,j) = adq(npx-2,j)-adbl(npx-2)
        adbl(npx-2) = 0.
      endif
      do i = is3, ie3
        pmp = -(2.*dq(i))
        lac = pmp+1.5*dq(i+1)
        bl(i) = min(max(0.,pmp,lac),max(al(i)-q(i,j),min(0.,pmp,lac)))
        pmp = 2.*dq(i-1)
        lac = pmp-1.5*dq(i-2)
        br(i) = min(max(0.,pmp,lac),max(al(i+1)-q(i,j),min(0.,pmp,lac)))
      end do
      if (is .eq. 1) then
        br(2) = al(3)-q(2,j)
        xt = 0.5*((2.*dxa(1,j)+dxa(2,j))*(q(0,j)+q(1,j))-dxa(1,j)*(q(-1,j)+q(2,j)))/(dxa(1,j)+dxa(2,j))
        if (edge_mono_kim) then
          if (j .gt. (-2) .and. j .lt. 1 .or. j .gt. npy-3 .and. j .lt. npy) then
            xt = min(xt,max(q(0,j),q(1,j),q(0,j-1),q(1,j-1)))
            xt = max(xt,min(q(0,j),q(1,j),q(0,j-1),q(1,j-1)))
          else if (j .lt. 3 .and. j .gt. 0 .or. j .gt. npy-1 .and. j .lt. npy+2) then
            xt = min(xt,max(q(0,j),q(1,j),q(0,j+1),q(1,j+1)))
            xt = max(xt,min(q(0,j),q(1,j),q(0,j+1),q(1,j+1)))
          endif
        endif
        bl(1) = xt-q(1,j)
        br(0) = xt-q(0,j)
        xt = 4./7.*dm1(-1)-11./14.*dq(-1)+q(0,j)
        if (s_mono_kim) then
          xt = max(xt,min(q(-1,j),q(0,j)))
          xt = min(xt,max(q(-1,j),q(0,j)))
        endif
        bl(0) = xt-q(0,j)
        xt = 3./14.*q(1,j)+11./14.*q(2,j)-4./7.*dm1(2)
        if (s_mono_kim) then
          xt = max(xt,min(q(1,j),q(2,j)))
          xt = min(xt,max(q(1,j),q(2,j)))
        endif
        br(1) = xt-q(1,j)
        bl(2) = xt-q(2,j)
        if (iord .eq. 9) then
          call adpert_ppm( 3,q(0,j),adq(0,j),bl(0),adbl(0),br(0),adbr(0),1 )
        endif
        adq(2,j) = adq(2,j)-adbl(2)
        adxt = adxt+adbl(2)
        adbl(2) = 0.
        adq(1,j) = adq(1,j)-adbr(1)
        adxt = adxt+adbr(1)
        adbr(1) = 0.
        xt = 3./14.*q(1,j)+11./14.*q(2,j)-4./7.*dm1(2)
        if (s_mono_kim) then
          xt = max(xt,min(q(1,j),q(2,j)))
          xtzzi = max(q(1,j),q(2,j))
          adxtzzi = adxt*(0.5-sign(0.5,xtzzi-xt))
          adq(2,j) = adq(2,j)+adxtzzi*(0.5-sign(0.5,q(1,j)-q(2,j)))
          adq(1,j) = adq(1,j)+adxtzzi*(0.5+sign(0.5,q(1,j)-q(2,j)))
          adxt = adxt*(0.5+sign(0.5,xtzzi-xt))
          br(2) = al(3)-q(2,j)
          xt = 0.5*((2.*dxa(1,j)+dxa(2,j))*(q(0,j)+q(1,j))-dxa(1,j)*(q(-1,j)+q(2,j)))/(dxa(1,j)+dxa(2,j))
          if (edge_mono_kim) then
            if (j .gt. (-2) .and. j .lt. 1 .or. j .gt. npy-3 .and. j .lt. npy) then
              xt = min(xt,max(q(0,j),q(1,j),q(0,j-1),q(1,j-1)))
              xt = max(xt,min(q(0,j),q(1,j),q(0,j-1),q(1,j-1)))
            else if (j .lt. 3 .and. j .gt. 0 .or. j .gt. npy-1 .and. j .lt. npy+2) then
              xt = min(xt,max(q(0,j),q(1,j),q(0,j+1),q(1,j+1)))
              xt = max(xt,min(q(0,j),q(1,j),q(0,j+1),q(1,j+1)))
            endif
          endif
          bl(1) = xt-q(1,j)
          br(0) = xt-q(0,j)
          xt = 4./7.*dm1(-1)-11./14.*dq(-1)+q(0,j)
          if (s_mono_kim) then
            xt = max(xt,min(q(-1,j),q(0,j)))
            xt = min(xt,max(q(-1,j),q(0,j)))
          endif
          bl(0) = xt-q(0,j)
          xt = 3./14.*q(1,j)+11./14.*q(2,j)-4./7.*dm1(2)
          xtzzj = min(q(1,j),q(2,j))
          adxtzzj = adxt*(0.5-sign(0.5,xt-xtzzj))
          adq(2,j) = adq(2,j)+adxtzzj*(0.5-sign(0.5,q(2,j)-q(1,j)))
          adq(1,j) = adq(1,j)+adxtzzj*(0.5+sign(0.5,q(2,j)-q(1,j)))
          adxt = adxt*(0.5+sign(0.5,xt-xtzzj))
        endif
        addm1(2) = addm1(2)-0.57142857*adxt
        adq(2,j) = adq(2,j)+0.78571429*adxt
        adq(1,j) = adq(1,j)+0.21428571*adxt
        adxt = 0.
        adq(0,j) = adq(0,j)-adbl(0)
        adxt = adxt+adbl(0)
        adbl(0) = 0.
        xt = 4./7.*dm1(-1)-11./14.*dq(-1)+q(0,j)
        if (s_mono_kim) then
          xt = max(xt,min(q(-1,j),q(0,j)))
          xtzzk = max(q(-1,j),q(0,j))
          adxtzzk = adxt*(0.5-sign(0.5,xtzzk-xt))
          adq(-1,j) = adq(-1,j)+adxtzzk*(0.5+sign(0.5,q(-1,j)-q(0,j)))
          adq(0,j) = adq(0,j)+adxtzzk*(0.5-sign(0.5,q(-1,j)-q(0,j)))
          adxt = adxt*(0.5+sign(0.5,xtzzk-xt))
          br(2) = al(3)-q(2,j)
          xt = 0.5*((2.*dxa(1,j)+dxa(2,j))*(q(0,j)+q(1,j))-dxa(1,j)*(q(-1,j)+q(2,j)))/(dxa(1,j)+dxa(2,j))
          if (edge_mono_kim) then
            if (j .gt. (-2) .and. j .lt. 1 .or. j .gt. npy-3 .and. j .lt. npy) then
              xt = min(xt,max(q(0,j),q(1,j),q(0,j-1),q(1,j-1)))
              xt = max(xt,min(q(0,j),q(1,j),q(0,j-1),q(1,j-1)))
            else if (j .lt. 3 .and. j .gt. 0 .or. j .gt. npy-1 .and. j .lt. npy+2) then
              xt = min(xt,max(q(0,j),q(1,j),q(0,j+1),q(1,j+1)))
              xt = max(xt,min(q(0,j),q(1,j),q(0,j+1),q(1,j+1)))
            endif
          endif
          bl(1) = xt-q(1,j)
          br(0) = xt-q(0,j)
          xt = 4./7.*dm1(-1)-11./14.*dq(-1)+q(0,j)
          xtzzl = min(q(-1,j),q(0,j))
          adxtzzl = adxt*(0.5-sign(0.5,xt-xtzzl))
          adq(-1,j) = adq(-1,j)+adxtzzl*(0.5+sign(0.5,q(0,j)-q(-1,j)))
          adq(0,j) = adq(0,j)+adxtzzl*(0.5-sign(0.5,q(0,j)-q(-1,j)))
          adxt = adxt*(0.5+sign(0.5,xt-xtzzl))
        endif
        addm1(-1) = addm1(-1)+0.57142857*adxt
        addq(-1) = addq(-1)-0.78571429*adxt
        adq(0,j) = adq(0,j)+adxt
        adxt = 0.
        adq(0,j) = adq(0,j)-adbr(0)
        adxt = adxt+adbr(0)
        adbr(0) = 0.
        adq(1,j) = adq(1,j)-adbl(1)
        adxt = adxt+adbl(1)
        adbl(1) = 0.
        xt = 0.5*((2.*dxa(1,j)+dxa(2,j))*(q(0,j)+q(1,j))-dxa(1,j)*(q(-1,j)+q(2,j)))/(dxa(1,j)+dxa(2,j))
        if (edge_mono_kim) then
          if (j .gt. (-2) .and. j .lt. 1 .or. j .gt. npy-3 .and. j .lt. npy) then
            xt = min(xt,max(q(0,j),q(1,j),q(0,j-1),q(1,j-1)))
            xtzzs = min(q(0,j),q(1,j))
            xtzzt = min(xtzzs,q(0,j-1))
            xtzzu = min(xtzzt,q(1,j-1))
            adxtzzu = adxt*(0.5-sign(0.5,xt-xtzzu))
            adq(1,j-1) = adq(1,j-1)+adxtzzu*(0.5-sign(0.5,q(1,j-1)-xtzzt))
            adxtzzt = adxtzzu*(0.5+sign(0.5,q(1,j-1)-xtzzt))
            adq(0,j-1) = adq(0,j-1)+adxtzzt*(0.5-sign(0.5,q(0,j-1)-xtzzs))
            adxtzzs = adxtzzt*(0.5+sign(0.5,q(0,j-1)-xtzzs))
            adq(1,j) = adq(1,j)+adxtzzs*(0.5-sign(0.5,q(1,j)-q(0,j)))
            adq(0,j) = adq(0,j)+adxtzzs*(0.5+sign(0.5,q(1,j)-q(0,j)))
            adxt = adxt*(0.5+sign(0.5,xt-xtzzu))
            br(2) = al(3)-q(2,j)
            xt = 0.5*((2.*dxa(1,j)+dxa(2,j))*(q(0,j)+q(1,j))-dxa(1,j)*(q(-1,j)+q(2,j)))/(dxa(1,j)+dxa(2,j))
            xtzzv = max(q(0,j),q(1,j))
            xtzzw = max(xtzzv,q(0,j-1))
            xtzzx = max(xtzzw,q(1,j-1))
            adxtzzx = adxt*(0.5-sign(0.5,xtzzx-xt))
            adq(1,j-1) = adq(1,j-1)+adxtzzx*(0.5-sign(0.5,xtzzw-q(1,j-1)))
            adxtzzw = adxtzzx*(0.5+sign(0.5,xtzzw-q(1,j-1)))
            adq(0,j-1) = adq(0,j-1)+adxtzzw*(0.5-sign(0.5,xtzzv-q(0,j-1)))
            adxtzzv = adxtzzw*(0.5+sign(0.5,xtzzv-q(0,j-1)))
            adq(1,j) = adq(1,j)+adxtzzv*(0.5-sign(0.5,q(0,j)-q(1,j)))
            adq(0,j) = adq(0,j)+adxtzzv*(0.5+sign(0.5,q(0,j)-q(1,j)))
            adxt = adxt*(0.5+sign(0.5,xtzzx-xt))
          else if (j .lt. 3 .and. j .gt. 0 .or. j .gt. npy-1 .and. j .lt. npy+2) then
            xt = min(xt,max(q(0,j),q(1,j),q(0,j+1),q(1,j+1)))
            xtzzm = min(q(0,j),q(1,j))
            xtzzn = min(xtzzm,q(0,j+1))
            xtzzo = min(xtzzn,q(1,j+1))
            adxtzzo = adxt*(0.5-sign(0.5,xt-xtzzo))
            adq(1,j+1) = adq(1,j+1)+adxtzzo*(0.5-sign(0.5,q(1,j+1)-xtzzn))
            adxtzzn = adxtzzo*(0.5+sign(0.5,q(1,j+1)-xtzzn))
            adq(0,j+1) = adq(0,j+1)+adxtzzn*(0.5-sign(0.5,q(0,j+1)-xtzzm))
            adxtzzm = adxtzzn*(0.5+sign(0.5,q(0,j+1)-xtzzm))
            adq(1,j) = adq(1,j)+adxtzzm*(0.5-sign(0.5,q(1,j)-q(0,j)))
            adq(0,j) = adq(0,j)+adxtzzm*(0.5+sign(0.5,q(1,j)-q(0,j)))
            adxt = adxt*(0.5+sign(0.5,xt-xtzzo))
            br(2) = al(3)-q(2,j)
            xt = 0.5*((2.*dxa(1,j)+dxa(2,j))*(q(0,j)+q(1,j))-dxa(1,j)*(q(-1,j)+q(2,j)))/(dxa(1,j)+dxa(2,j))
            xtzzp = max(q(0,j),q(1,j))
            xtzzq = max(xtzzp,q(0,j+1))
            xtzzr = max(xtzzq,q(1,j+1))
            adxtzzr = adxt*(0.5-sign(0.5,xtzzr-xt))
            adq(1,j+1) = adq(1,j+1)+adxtzzr*(0.5-sign(0.5,xtzzq-q(1,j+1)))
            adxtzzq = adxtzzr*(0.5+sign(0.5,xtzzq-q(1,j+1)))
            adq(0,j+1) = adq(0,j+1)+adxtzzq*(0.5-sign(0.5,xtzzp-q(0,j+1)))
            adxtzzp = adxtzzq*(0.5+sign(0.5,xtzzp-q(0,j+1)))
            adq(1,j) = adq(1,j)+adxtzzp*(0.5-sign(0.5,q(0,j)-q(1,j)))
            adq(0,j) = adq(0,j)+adxtzzp*(0.5+sign(0.5,q(0,j)-q(1,j)))
            adxt = adxt*(0.5+sign(0.5,xtzzr-xt))
          endif
        endif
        adq(-1,j) = adq(-1,j)-adxt*(0.5*dxa(1,j)/(dxa(1,j)+dxa(2,j)))
        adq(2,j) = adq(2,j)-adxt*(0.5*dxa(1,j)/(dxa(1,j)+dxa(2,j)))
        adq(1,j) = adq(1,j)+adxt*(0.5*(2.*dxa(1,j)+dxa(2,j))/(dxa(1,j)+dxa(2,j)))
        adq(0,j) = adq(0,j)+adxt*(0.5*(2.*dxa(1,j)+dxa(2,j))/(dxa(1,j)+dxa(2,j)))
        adxt = 0.
        adal(3) = adal(3)+adbr(2)
        adq(2,j) = adq(2,j)-adbr(2)
        adbr(2) = 0.
      endif
      do i = is3, ie3
        adlac = 0.
        adpmp = 0.
        pmp = 2.*dq(i-1)
        lac = pmp-1.5*dq(i-2)
        brz = max(0.,pmp)
        brza = max(brz,lac)
        brzc = min(0.,pmp)
        brzd = min(brzc,lac)
        brzb = max(al(i+1)-q(i,j),brzd)
        adbrzb = adbr(i)*(0.5+sign(0.5,brzb-brza))
        adbrzc = adbr(i)*(0.5-sign(0.5,brzb-brza))
        adal(i+1) = adal(i+1)+adbrzc*(0.5+sign(0.5,al(i+1)-q(i,j)-brzd))
        adbrze = adbrzc*(0.5-sign(0.5,al(i+1)-q(i,j)-brzd))
        adq(i,j) = adq(i,j)-adbrzc*(0.5+sign(0.5,al(i+1)-q(i,j)-brzd))
        adbrzd = adbrze*(0.5+sign(0.5,lac-brzc))
        adlac = adlac+adbrze*(0.5-sign(0.5,lac-brzc))
        adpmp = adpmp+adbrzd*(0.5-sign(0.5,pmp-0.))
        adbrza = adbrzb*(0.5+sign(0.5,brz-lac))
        adlac = adlac+adbrzb*(0.5-sign(0.5,brz-lac))
        adpmp = adpmp+adbrza*(0.5-sign(0.5,0.-pmp))
        adbr(i) = 0.
        addq(i-2) = addq(i-2)-1.5*adlac
        adpmp = adpmp+adlac
        adlac = 0.
        addq(i-1) = addq(i-1)+2*adpmp
        adpmp = 0.
        pmp = -(2.*dq(i))
        lac = pmp+1.5*dq(i+1)
        blz = max(0.,pmp)
        blza = max(blz,lac)
        blzc = min(0.,pmp)
        blzd = min(blzc,lac)
        blzb = max(al(i)-q(i,j),blzd)
        adblzb = adbl(i)*(0.5+sign(0.5,blzb-blza))
        adblzc = adbl(i)*(0.5-sign(0.5,blzb-blza))
        adal(i) = adal(i)+adblzc*(0.5+sign(0.5,al(i)-q(i,j)-blzd))
        adblze = adblzc*(0.5-sign(0.5,al(i)-q(i,j)-blzd))
        adq(i,j) = adq(i,j)-adblzc*(0.5+sign(0.5,al(i)-q(i,j)-blzd))
        adblzd = adblze*(0.5+sign(0.5,lac-blzc))
        adlac = adlac+adblze*(0.5-sign(0.5,lac-blzc))
        adpmp = adpmp+adblzd*(0.5-sign(0.5,pmp-0.))
        adblza = adblzb*(0.5+sign(0.5,blz-lac))
        adlac = adlac+adblzb*(0.5-sign(0.5,blz-lac))
        adpmp = adpmp+adblza*(0.5-sign(0.5,0.-pmp))
        adbl(i) = 0.
        addq(i+1) = addq(i+1)+1.5*adlac
        adpmp = adpmp+adlac
        adlac = 0.
        addq(i) = addq(i)-2*adpmp
        adpmp = 0.
      end do
      do i = is3, min(npx-2,ie+2)
        addm1(i-1) = addm1(i-1)+adal(i)*r3
        addm1(i) = addm1(i)-adal(i)*r3
        adq(i-1,j) = adq(i-1,j)+0.5*adal(i)
        adq(i,j) = adq(i,j)+0.5*adal(i)
        adal(i) = 0.
      end do
    else
      do i = is-1, ie+1
        adlac = 0.
        adpmp = 0.
        pmp = 2.*dq(i-1)
        lac = pmp-1.5*dq(i-2)
        bru = max(0.,pmp)
        brv = max(bru,lac)
        brx = min(0.,pmp)
        bry = min(brx,lac)
        brw = max(al(i+1)-q(i,j),bry)
        adbrw = adbr(i)*(0.5+sign(0.5,brw-brv))
        adbrx = adbr(i)*(0.5-sign(0.5,brw-brv))
        adal(i+1) = adal(i+1)+adbrx*(0.5+sign(0.5,al(i+1)-q(i,j)-bry))
        adbrz = adbrx*(0.5-sign(0.5,al(i+1)-q(i,j)-bry))
        adq(i,j) = adq(i,j)-adbrx*(0.5+sign(0.5,al(i+1)-q(i,j)-bry))
        adbry = adbrz*(0.5+sign(0.5,lac-brx))
        adlac = adlac+adbrz*(0.5-sign(0.5,lac-brx))
        adpmp = adpmp+adbry*(0.5-sign(0.5,pmp-0.))
        adbrv = adbrw*(0.5+sign(0.5,bru-lac))
        adlac = adlac+adbrw*(0.5-sign(0.5,bru-lac))
        adpmp = adpmp+adbrv*(0.5-sign(0.5,0.-pmp))
        adbr(i) = 0.
        addq(i-2) = addq(i-2)-1.5*adlac
        adpmp = adpmp+adlac
        adlac = 0.
        addq(i-1) = addq(i-1)+2*adpmp
        adpmp = 0.
        pmp = -(2.*dq(i))
        lac = pmp+1.5*dq(i+1)
        blu = max(0.,pmp)
        blv = max(blu,lac)
        blx = min(0.,pmp)
        bly = min(blx,lac)
        blw = max(al(i)-q(i,j),bly)
        adblw = adbl(i)*(0.5+sign(0.5,blw-blv))
        adblx = adbl(i)*(0.5-sign(0.5,blw-blv))
        adal(i) = adal(i)+adblx*(0.5+sign(0.5,al(i)-q(i,j)-bly))
        adblz = adblx*(0.5-sign(0.5,al(i)-q(i,j)-bly))
        adq(i,j) = adq(i,j)-adblx*(0.5+sign(0.5,al(i)-q(i,j)-bly))
        adbly = adblz*(0.5+sign(0.5,lac-blx))
        adlac = adlac+adblz*(0.5-sign(0.5,lac-blx))
        adpmp = adpmp+adbly*(0.5-sign(0.5,pmp-0.))
        adblv = adblw*(0.5+sign(0.5,blu-lac))
        adlac = adlac+adblw*(0.5-sign(0.5,blu-lac))
        adpmp = adpmp+adblv*(0.5-sign(0.5,0.-pmp))
        adbl(i) = 0.
        addq(i+1) = addq(i+1)+1.5*adlac
        adpmp = adpmp+adlac
        adlac = 0.
        addq(i) = addq(i)-2*adpmp
        adpmp = 0.
      end do
      do i = is-1, ie+2
        addm1(i-1) = addm1(i-1)+adal(i)*r3
        addm1(i) = addm1(i)-adal(i)*r3
        adq(i-1,j) = adq(i-1,j)+0.5*adal(i)
        adq(i,j) = adq(i,j)+0.5*adal(i)
        adal(i) = 0.
      end do
    endif
    if (uniform_ppm) then
      do i = is-2, ie+2
        adxt = 0.
        xt = 0.25*(q(i+1,j)-q(i-1,j))
        dm1r = abs(xt)
        dm1s = max(q(i-1,j),q(i,j))
        dm1u = max(dm1s,q(i+1,j))-q(i,j)
        dm1v = min(q(i-1,j),q(i,j))
        dm1x = q(i,j)-min(dm1v,q(i+1,j))
        dm1y = min(dm1r,dm1u)
        addm1zc = addm1(i)*sign(1.,min(dm1y,dm1x))*sign(1.,xt)
        addm1za = addm1zc*(0.5-sign(0.5,dm1x-dm1y))
        addm1zb = addm1zc*(0.5+sign(0.5,dm1x-dm1y))
        addm1u = addm1zb*(0.5+sign(0.5,dm1u-dm1r))
        addm1x = addm1zb*(0.5-sign(0.5,dm1u-dm1r))
        addm1z = -addm1za
        adq(i,j) = adq(i,j)+addm1za
        addm1y = addm1z*(0.5+sign(0.5,q(i+1,j)-dm1v))
        adq(i+1,j) = adq(i+1,j)+addm1z*(0.5-sign(0.5,q(i+1,j)-dm1v))
        adq(i-1,j) = adq(i-1,j)+addm1y*(0.5+sign(0.5,q(i,j)-q(i-1,j)))
        adq(i,j) = adq(i,j)+addm1y*(0.5-sign(0.5,q(i,j)-q(i-1,j)))
        adq(i,j) = adq(i,j)-addm1x
        addm1v = addm1x*(0.5+sign(0.5,dm1s-q(i+1,j)))
        adq(i+1,j) = adq(i+1,j)+addm1x*(0.5-sign(0.5,dm1s-q(i+1,j)))
        adq(i-1,j) = adq(i-1,j)+addm1v*(0.5+sign(0.5,q(i-1,j)-q(i,j)))
        adq(i,j) = adq(i,j)+addm1v*(0.5-sign(0.5,q(i-1,j)-q(i,j)))
        adxt = adxt+addm1u*sign(1.,xt)
        addm1(i) = 0.
        adq(i-1,j) = adq(i-1,j)-0.25*adxt
        adq(i+1,j) = adq(i+1,j)+0.25*adxt
        adxt = 0.
      end do
    else
      do i = is-2, ie+2
        adxt = 0.
        xt = cx1(i,j)*dq(i-1)+cx2(i,j)*dq(i)
        dm1j = abs(xt)
        dm1m = abs(dq(i-1))
        dm1p = abs(dq(i))
        dm1q = min(dm1j,dm1m)
        addm1t = addm1(i)*sign(1.,min(dm1q,dm1p))*sign(1.,xt)
        addm1r = addm1t*(0.5-sign(0.5,dm1p-dm1q))
        addm1s = addm1t*(0.5+sign(0.5,dm1p-dm1q))
        addm1j = addm1s*(0.5+sign(0.5,dm1m-dm1j))
        addm1q = addm1s*(0.5-sign(0.5,dm1m-dm1j))
        addq(i) = addq(i)+addm1r*sign(1.,dq(i))
        addq(i-1) = addq(i-1)+addm1q*sign(1.,dq(i-1))
        adxt = adxt+addm1j*sign(1.,xt)
        addm1(i) = 0.
        addq(i-1) = addq(i-1)+adxt*cx1(i,j)
        addq(i) = addq(i)+adxt*cx2(i,j)
        adxt = 0.
      end do
    endif
    do i = is-3, ie+2
      adq(i+1,j) = adq(i+1,j)+addq(i)
      adq(i,j) = adq(i,j)-addq(i)
      addq(i) = 0.
    end do
  end do
else
  do j = jlast, jfirst, -1
    do j1 = jfirst, j-1
      do i = ifirst-2, ilast+2
        xt = 0.25*(q(i+1,j1)-q(i-1,j1))
        dm1(i) = sign(min(abs(xt),max(q(i-1,j1),q(i,j1),q(i+1,j1))-q(i,j1),q(i,j1)-min(q(i-1,j1),q(i,j1),q(i+1,j1))),xt)
      end do
      if (grid_type .lt. 3) then
        is3 = max(3,is-1)
        ie3 = min(npx-3,ie+1)
        do i = is3, min(npx-2,ie+2)
          al(i) = 0.5*(q(i-1,j1)+q(i,j1))+r3*(dm1(i-1)-dm1(i))
        end do
        if (iord .eq. 11) then
          do i = is3, ie3
            xt = 2.*dm1(i)
            bl(i) = -sign(min(abs(xt),abs(al(i)-q(i,j1))),xt)
            br(i) = sign(min(abs(xt),abs(al(i+1)-q(i,j1))),xt)
          end do
        else if (iord .eq. 12) then
          do i = is-3, ie+2
            dq(i) = q(i+1,j1)-q(i,j1)
          end do
          do i = is3, ie3
            pmp = -(2.*dq(i))
            lac = pmp+1.5*dq(i+1)
            bl(i) = min(max(0.,pmp,lac),max(al(i)-q(i,j1),min(0.,pmp,lac)))
            pmp = 2.*dq(i-1)
            lac = pmp-1.5*dq(i-2)
            br(i) = min(max(0.,pmp,lac),max(al(i+1)-q(i,j1),min(0.,pmp,lac)))
          end do
        else
          do i = is3, ie3
            bl(i) = al(i)-q(i,j1)
            br(i) = al(i+1)-q(i,j1)
          end do
        endif
        if (iord .ne. 11) then
          help_h = ie3-is3+1
          call pert_ppm( help_h,q(is3,j1),bl(is3),br(is3),0 )
        endif
        if (is .eq. 1) then
          br(2) = al(3)-q(2,j1)
          xt = 0.5*((2.*dxa(1,j1)+dxa(2,j1))*(q(0,j1)+q(1,j1))-dxa(1,j1)*(q(-1,j1)+q(2,j1)))/(dxa(1,j1)+dxa(2,j1))
          if (edge_mono_kim) then
            if (j1 .gt. (-2) .and. j1 .lt. 1 .or. j1 .gt. npy-3 .and. j1 .lt. npy) then
              xt = min(xt,max(q(0,j1),q(1,j1),q(0,j1-1),q(1,j1-1)))
              xt = max(xt,min(q(0,j1),q(1,j1),q(0,j1-1),q(1,j1-1)))
            else if (j1 .lt. 3 .and. j1 .gt. 0 .or. j1 .gt. npy-1 .and. j1 .lt. npy+2) then
              xt = min(xt,max(q(0,j1),q(1,j1),q(0,j1+1),q(1,j1+1)))
              xt = max(xt,min(q(0,j1),q(1,j1),q(0,j1+1),q(1,j1+1)))
            else
              xt = max(0.,xt)
            endif
          else
            xt = max(0.,xt)
          endif
          bl(1) = xt-q(1,j1)
          br(0) = xt-q(0,j1)
          xt = 4./7.*dm1(-1)+11./14.*q(-1,j1)+3./14.*q(0,j1)
          if (s_mono_kim) then
            xt = min(xt,max(q(-1,j1),q(0,j1)))
            xt = max(xt,min(q(-1,j1),q(0,j1)))
          else
            xt = max(0.,xt)
          endif
          bl(0) = xt-q(0,j1)
          xt = 3./14.*q(1,j1)+11./14.*q(2,j1)-4./7.*dm1(2)
          if (s_mono_kim) then
            xt = min(xt,max(q(1,j1),q(2,j1)))
            xt = max(xt,min(q(1,j1),q(2,j1)))
          else
            xt = max(0.,xt)
          endif
          br(1) = xt-q(1,j1)
          bl(2) = xt-q(2,j1)
          call pert_ppm( 3,q(0,j1),bl(0),br(0),1 )
        endif
        if (ie+1 .eq. npx) then
          bl(npx-2) = al(npx-2)-q(npx-2,j1)
          xt = 0.5*((2.*dxa(npx-1,j1)+dxa(npx-2,j1))*(q(npx-1,j1)+q(npx,j1))-dxa(npx-1,j1)*(q(npx-2,j1)+q(npx+1,j1)))/(dxa(npx-1,&
&j1)+dxa(npx-2,j1))
          if (edge_mono_kim) then
            if (j1 .gt. (-2) .and. j1 .lt. 1 .or. j1 .gt. npy-3 .and. j1 .lt. npy) then
              xt = min(xt,max(q(npx-1,j1),q(npx,j1),q(npx-1,j1-1),q(npx,j1-1)))
              xt = max(xt,min(q(npx-1,j1),q(npx,j1),q(npx-1,j1-1),q(npx,j1-1)))
            else if (j1 .lt. 3 .and. j1 .gt. 0 .or. j1 .gt. npy-1 .and. j1 .lt. npy+2) then
              xt = min(xt,max(q(npx-1,j1),q(npx,j1),q(npx-1,j1+1),q(npx,j1+1)))
              xt = max(xt,min(q(npx-1,j1),q(npx,j1),q(npx-1,j1+1),q(npx,j1+1)))
            else
              xt = max(0.,xt)
            endif
          else
            xt = max(0.,xt)
          endif
          br(npx-1) = xt-q(npx-1,j1)
          bl(npx) = xt-q(npx,j1)
          xt = 11./14.*q(npx+1,j1)+3./14.*q(npx,j1)-4./7.*dm1(npx+1)
          if (s_mono_kim) then
            xt = min(xt,max(q(npx,j1),q(npx+1,j1)))
            xt = max(xt,min(q(npx,j1),q(npx+1,j1)))
          else
            xt = max(0.,xt)
          endif
          br(npx) = xt-q(npx,j1)
          xt = 3./14.*q(npx-1,j1)+11./14.*q(npx-2,j1)+4./7.*dm1(npx-2)
          if (s_mono_kim) then
            xt = min(xt,max(q(npx-2,j1),q(npx-1,j1)))
            xt = max(xt,min(q(npx-2,j1),q(npx-1,j1)))
          else
            xt = max(0.,xt)
          endif
          br(npx-2) = xt-q(npx-2,j1)
          bl(npx-1) = xt-q(npx-1,j1)
          call pert_ppm( 3,q(npx-2,j1),bl(npx-2),br(npx-2),1 )
        endif
      else
        do i = is-1, ie+2
          al(i) = 0.5*(q(i-1,j1)+q(i,j1))+r3*(dm1(i-1)-dm1(i))
        end do
        if (iord .eq. 11) then
          do i = is-1, ie+1
            xt = 2.*dm1(i)
            bl(i) = -sign(min(abs(xt),abs(al(i)-q(i,j1))),xt)
            br(i) = sign(min(abs(xt),abs(al(i+1)-q(i,j1))),xt)
          end do
        else if (iord .eq. 12) then
          do i = is-3, ie+2
            dq(i) = q(i+1,j1)-q(i,j1)
          end do
          do i = is-1, ie+1
            pmp = -(2.*dq(i))
            lac = pmp+1.5*dq(i+1)
            bl(i) = min(max(0.,pmp,lac),max(al(i)-q(i,j1),min(0.,pmp,lac)))
            pmp = 2.*dq(i-1)
            lac = pmp-1.5*dq(i-2)
            br(i) = min(max(0.,pmp,lac),max(al(i+1)-q(i,j1),min(0.,pmp,lac)))
          end do
        else
          do i = is-1, ie+1
            bl(i) = al(i)-q(i,j1)
            br(i) = al(i+1)-q(i,j1)
          end do
        endif
        if (iord .ne. 11) then
          help_i = ie-is+1
          call pert_ppm( help_i,q(is-1,j1),bl(is-1),br(is-1),0 )
        endif
      endif
    end do
    brs(:) = br(:)
    bls(:) = bl(:)
    do i = ifirst-2, ilast+2
      xt = 0.25*(q(i+1,j)-q(i-1,j))
      dm1(i) = sign(min(abs(xt),max(q(i-1,j),q(i,j),q(i+1,j))-q(i,j),q(i,j)-min(q(i-1,j),q(i,j),q(i+1,j))),xt)
    end do
    if (grid_type .lt. 3) then
      is3 = max(3,is-1)
      ie3 = min(npx-3,ie+1)
      do i = is3, min(npx-2,ie+2)
        al(i) = 0.5*(q(i-1,j)+q(i,j))+r3*(dm1(i-1)-dm1(i))
      end do
      if (iord .eq. 11) then
        do i = is3, ie3
          xt = 2.*dm1(i)
          bl(i) = -sign(min(abs(xt),abs(al(i)-q(i,j))),xt)
          br(i) = sign(min(abs(xt),abs(al(i+1)-q(i,j))),xt)
        end do
      else if (iord .eq. 12) then
        do i = is-3, ie+2
          dq(i) = q(i+1,j)-q(i,j)
        end do
        do i = is3, ie3
          pmp = -(2.*dq(i))
          lac = pmp+1.5*dq(i+1)
          bl(i) = min(max(0.,pmp,lac),max(al(i)-q(i,j),min(0.,pmp,lac)))
          pmp = 2.*dq(i-1)
          lac = pmp-1.5*dq(i-2)
          br(i) = min(max(0.,pmp,lac),max(al(i+1)-q(i,j),min(0.,pmp,lac)))
        end do
      else
        do i = is3, ie3
          bl(i) = al(i)-q(i,j)
          br(i) = al(i+1)-q(i,j)
        end do
      endif
      if (iord .ne. 11) then
        help_h = ie3-is3+1
        call pert_ppm( help_h,q(is3,j),bl(is3),br(is3),0 )
      endif
      if (is .eq. 1) then
        br(2) = al(3)-q(2,j)
        xt = 0.5*((2.*dxa(1,j)+dxa(2,j))*(q(0,j)+q(1,j))-dxa(1,j)*(q(-1,j)+q(2,j)))/(dxa(1,j)+dxa(2,j))
        if (edge_mono_kim) then
          if (j .gt. (-2) .and. j .lt. 1 .or. j .gt. npy-3 .and. j .lt. npy) then
            xt = min(xt,max(q(0,j),q(1,j),q(0,j-1),q(1,j-1)))
            xt = max(xt,min(q(0,j),q(1,j),q(0,j-1),q(1,j-1)))
          else if (j .lt. 3 .and. j .gt. 0 .or. j .gt. npy-1 .and. j .lt. npy+2) then
            xt = min(xt,max(q(0,j),q(1,j),q(0,j+1),q(1,j+1)))
            xt = max(xt,min(q(0,j),q(1,j),q(0,j+1),q(1,j+1)))
          else
            xt = max(0.,xt)
          endif
        else
          xt = max(0.,xt)
        endif
        bl(1) = xt-q(1,j)
        br(0) = xt-q(0,j)
        xt = 4./7.*dm1(-1)+11./14.*q(-1,j)+3./14.*q(0,j)
        if (s_mono_kim) then
          xt = min(xt,max(q(-1,j),q(0,j)))
          xt = max(xt,min(q(-1,j),q(0,j)))
        else
          xt = max(0.,xt)
        endif
        bl(0) = xt-q(0,j)
        xt = 3./14.*q(1,j)+11./14.*q(2,j)-4./7.*dm1(2)
        if (s_mono_kim) then
          xt = min(xt,max(q(1,j),q(2,j)))
          xt = max(xt,min(q(1,j),q(2,j)))
        else
          xt = max(0.,xt)
        endif
        br(1) = xt-q(1,j)
        bl(2) = xt-q(2,j)
        call pert_ppm( 3,q(0,j),bl(0),br(0),1 )
      endif
      if (ie+1 .eq. npx) then
        bl(npx-2) = al(npx-2)-q(npx-2,j)
        xt = 0.5*((2.*dxa(npx-1,j)+dxa(npx-2,j))*(q(npx-1,j)+q(npx,j))-dxa(npx-1,j)*(q(npx-2,j)+q(npx+1,j)))/(dxa(npx-1,j)+dxa(npx-&
&2,j))
        if (edge_mono_kim) then
          if (j .gt. (-2) .and. j .lt. 1 .or. j .gt. npy-3 .and. j .lt. npy) then
            xt = min(xt,max(q(npx-1,j),q(npx,j),q(npx-1,j-1),q(npx,j-1)))
            xt = max(xt,min(q(npx-1,j),q(npx,j),q(npx-1,j-1),q(npx,j-1)))
          else if (j .lt. 3 .and. j .gt. 0 .or. j .gt. npy-1 .and. j .lt. npy+2) then
            xt = min(xt,max(q(npx-1,j),q(npx,j),q(npx-1,j+1),q(npx,j+1)))
            xt = max(xt,min(q(npx-1,j),q(npx,j),q(npx-1,j+1),q(npx,j+1)))
          else
            xt = max(0.,xt)
          endif
        else
          xt = max(0.,xt)
        endif
        br(npx-1) = xt-q(npx-1,j)
        bl(npx) = xt-q(npx,j)
        xt = 11./14.*q(npx+1,j)+3./14.*q(npx,j)-4./7.*dm1(npx+1)
        if (s_mono_kim) then
          xt = min(xt,max(q(npx,j),q(npx+1,j)))
          xt = max(xt,min(q(npx,j),q(npx+1,j)))
        else
          xt = max(0.,xt)
        endif
        br(npx) = xt-q(npx,j)
        xt = 3./14.*q(npx-1,j)+11./14.*q(npx-2,j)+4./7.*dm1(npx-2)
        if (s_mono_kim) then
          xt = min(xt,max(q(npx-2,j),q(npx-1,j)))
          xt = max(xt,min(q(npx-2,j),q(npx-1,j)))
        else
          xt = max(0.,xt)
        endif
        br(npx-2) = xt-q(npx-2,j)
        bl(npx-1) = xt-q(npx-1,j)
        call pert_ppm( 3,q(npx-2,j),bl(npx-2),br(npx-2),1 )
      endif
    else
      do i = is-1, ie+2
        al(i) = 0.5*(q(i-1,j)+q(i,j))+r3*(dm1(i-1)-dm1(i))
      end do
      if (iord .eq. 11) then
        do i = is-1, ie+1
          xt = 2.*dm1(i)
          bl(i) = -sign(min(abs(xt),abs(al(i)-q(i,j))),xt)
          br(i) = sign(min(abs(xt),abs(al(i+1)-q(i,j))),xt)
        end do
      else if (iord .eq. 12) then
        do i = is-3, ie+2
          dq(i) = q(i+1,j)-q(i,j)
        end do
        do i = is-1, ie+1
          pmp = -(2.*dq(i))
          lac = pmp+1.5*dq(i+1)
          bl(i) = min(max(0.,pmp,lac),max(al(i)-q(i,j),min(0.,pmp,lac)))
          pmp = 2.*dq(i-1)
          lac = pmp-1.5*dq(i-2)
          br(i) = min(max(0.,pmp,lac),max(al(i+1)-q(i,j),min(0.,pmp,lac)))
        end do
      else
        do i = is-1, ie+1
          bl(i) = al(i)-q(i,j)
          br(i) = al(i+1)-q(i,j)
        end do
      endif
      if (iord .ne. 11) then
        help_i = ie-is+1
        call pert_ppm( help_i,q(is-1,j),bl(is-1),br(is-1),0 )
      endif
    endif
    do i = is, ie+1
      if (c(i,j) .gt. 0.) then
        adbl(i-1) = adbl(i-1)-adflux(i,j)*(1.-c(i,j))*c(i,j)
        adbr(i-1) = adbr(i-1)+adflux(i,j)*(1.-c(i,j))*(1-c(i,j))
        adc(i,j) = adc(i,j)+adflux(i,j)*((-((1.-c(i,j))*(bl(i-1)+br(i-1))))-(br(i-1)-c(i,j)*(bl(i-1)+br(i-1))))
        adq(i-1,j) = adq(i-1,j)+adflux(i,j)
        adflux(i,j) = 0.
      else
        adbl(i) = adbl(i)+adflux(i,j)*(1.+c(i,j))*(1+c(i,j))
        adbr(i) = adbr(i)+adflux(i,j)*(1.+c(i,j))*c(i,j)
        adc(i,j) = adc(i,j)+adflux(i,j)*((1.+c(i,j))*(bl(i)+br(i))+bl(i)+c(i,j)*(bl(i)+br(i)))
        adq(i,j) = adq(i,j)+adflux(i,j)
        adflux(i,j) = 0.
      endif
    end do
    bl(:) = bls(:)
    br(:) = brs(:)
    if (grid_type .lt. 3) then
      if (iord .eq. 11) then
        do i = is3, ie3
          xt = 2.*dm1(i)
          bl(i) = -sign(min(abs(xt),abs(al(i)-q(i,j))),xt)
          br(i) = sign(min(abs(xt),abs(al(i+1)-q(i,j))),xt)
        end do
      else if (iord .eq. 12) then
        do i = is3, ie3
          pmp = -(2.*dq(i))
          lac = pmp+1.5*dq(i+1)
          bl(i) = min(max(0.,pmp,lac),max(al(i)-q(i,j),min(0.,pmp,lac)))
          pmp = 2.*dq(i-1)
          lac = pmp-1.5*dq(i-2)
          br(i) = min(max(0.,pmp,lac),max(al(i+1)-q(i,j),min(0.,pmp,lac)))
        end do
      else
        do i = is3, ie3
          bl(i) = al(i)-q(i,j)
          br(i) = al(i+1)-q(i,j)
        end do
      endif
      if (iord .ne. 11) then
        call pert_ppm( help_h,q(is3,j),bl(is3),br(is3),0 )
      endif
      if (is .eq. 1) then
        br(2) = al(3)-q(2,j)
        xt = 0.5*((2.*dxa(1,j)+dxa(2,j))*(q(0,j)+q(1,j))-dxa(1,j)*(q(-1,j)+q(2,j)))/(dxa(1,j)+dxa(2,j))
        if (edge_mono_kim) then
          if (j .gt. (-2) .and. j .lt. 1 .or. j .gt. npy-3 .and. j .lt. npy) then
            xt = min(xt,max(q(0,j),q(1,j),q(0,j-1),q(1,j-1)))
            xt = max(xt,min(q(0,j),q(1,j),q(0,j-1),q(1,j-1)))
          else if (j .lt. 3 .and. j .gt. 0 .or. j .gt. npy-1 .and. j .lt. npy+2) then
            xt = min(xt,max(q(0,j),q(1,j),q(0,j+1),q(1,j+1)))
            xt = max(xt,min(q(0,j),q(1,j),q(0,j+1),q(1,j+1)))
          else
            xt = max(0.,xt)
          endif
        else
          xt = max(0.,xt)
        endif
        bl(1) = xt-q(1,j)
        br(0) = xt-q(0,j)
        xt = 4./7.*dm1(-1)+11./14.*q(-1,j)+3./14.*q(0,j)
        if (s_mono_kim) then
          xt = min(xt,max(q(-1,j),q(0,j)))
          xt = max(xt,min(q(-1,j),q(0,j)))
        else
          xt = max(0.,xt)
        endif
        bl(0) = xt-q(0,j)
        xt = 3./14.*q(1,j)+11./14.*q(2,j)-4./7.*dm1(2)
        if (s_mono_kim) then
          xt = min(xt,max(q(1,j),q(2,j)))
          xt = max(xt,min(q(1,j),q(2,j)))
        else
          xt = max(0.,xt)
        endif
        br(1) = xt-q(1,j)
        bl(2) = xt-q(2,j)
        call pert_ppm( 3,q(0,j),bl(0),br(0),1 )
      endif
      if (ie+1 .eq. npx) then
        xtj = xt
        xtm = xt
        bl(npx-2) = al(npx-2)-q(npx-2,j)
        xt = 0.5*((2.*dxa(npx-1,j)+dxa(npx-2,j))*(q(npx-1,j)+q(npx,j))-dxa(npx-1,j)*(q(npx-2,j)+q(npx+1,j)))/(dxa(npx-1,j)+dxa(npx-&
&2,j))
        if (edge_mono_kim) then
          if (j .gt. (-2) .and. j .lt. 1 .or. j .gt. npy-3 .and. j .lt. npy) then
            xt = min(xt,max(q(npx-1,j),q(npx,j),q(npx-1,j-1),q(npx,j-1)))
            xt = max(xt,min(q(npx-1,j),q(npx,j),q(npx-1,j-1),q(npx,j-1)))
          else if (j .lt. 3 .and. j .gt. 0 .or. j .gt. npy-1 .and. j .lt. npy+2) then
            xt = min(xt,max(q(npx-1,j),q(npx,j),q(npx-1,j+1),q(npx,j+1)))
            xt = max(xt,min(q(npx-1,j),q(npx,j),q(npx-1,j+1),q(npx,j+1)))
          else
            xt = max(0.,xt)
          endif
        else
          xt = max(0.,xt)
        endif
        br(npx-1) = xt-q(npx-1,j)
        bl(npx) = xt-q(npx,j)
        xt = xtm
        xt = 11./14.*q(npx+1,j)+3./14.*q(npx,j)-4./7.*dm1(npx+1)
        if (s_mono_kim) then
          xt = min(xt,max(q(npx,j),q(npx+1,j)))
          xt = max(xt,min(q(npx,j),q(npx+1,j)))
        else
          xt = max(0.,xt)
        endif
        br(npx) = xt-q(npx,j)
        xt = xtj
        br(npx-2) = xt-q(npx-2,j)
        bl(npx-1) = xt-q(npx-1,j)
        call adpert_ppm( 3,q(npx-2,j),adq(npx-2,j),bl(npx-2),adbl(npx-2),br(npx-2),adbr(npx-2),1 )
        adq(npx-1,j) = adq(npx-1,j)-adbl(npx-1)
        adxt = adxt+adbl(npx-1)
        adbl(npx-1) = 0.
        adq(npx-2,j) = adq(npx-2,j)-adbr(npx-2)
        adxt = adxt+adbr(npx-2)
        adbr(npx-2) = 0.
        xt = 3./14.*q(npx-1,j)+11./14.*q(npx-2,j)+4./7.*dm1(npx-2)
        if (s_mono_kim) then
          xt = min(xt,max(q(npx-2,j),q(npx-1,j)))
          xth = min(q(npx-2,j),q(npx-1,j))
          adxth = adxt*(0.5-sign(0.5,xt-xth))
          adq(npx-2,j) = adq(npx-2,j)+adxth*(0.5+sign(0.5,q(npx-1,j)-q(npx-2,j)))
          adq(npx-1,j) = adq(npx-1,j)+adxth*(0.5-sign(0.5,q(npx-1,j)-q(npx-2,j)))
          adxt = adxt*(0.5+sign(0.5,xt-xth))
          bl(npx-2) = al(npx-2)-q(npx-2,j)
          xt = 0.5*((2.*dxa(npx-1,j)+dxa(npx-2,j))*(q(npx-1,j)+q(npx,j))-dxa(npx-1,j)*(q(npx-2,j)+q(npx+1,j)))/(dxa(npx-1,j)+&
&dxa(npx-2,j))
          if (edge_mono_kim) then
            if (j .gt. (-2) .and. j .lt. 1 .or. j .gt. npy-3 .and. j .lt. npy) then
              xt = min(xt,max(q(npx-1,j),q(npx,j),q(npx-1,j-1),q(npx,j-1)))
              xt = max(xt,min(q(npx-1,j),q(npx,j),q(npx-1,j-1),q(npx,j-1)))
            else if (j .lt. 3 .and. j .gt. 0 .or. j .gt. npy-1 .and. j .lt. npy+2) then
              xt = min(xt,max(q(npx-1,j),q(npx,j),q(npx-1,j+1),q(npx,j+1)))
              xt = max(xt,min(q(npx-1,j),q(npx,j),q(npx-1,j+1),q(npx,j+1)))
            else
              xt = max(0.,xt)
            endif
          else
            xt = max(0.,xt)
          endif
          br(npx-1) = xt-q(npx-1,j)
          bl(npx) = xt-q(npx,j)
          xt = 11./14.*q(npx+1,j)+3./14.*q(npx,j)-4./7.*dm1(npx+1)
          if (s_mono_kim) then
            xt = min(xt,max(q(npx,j),q(npx+1,j)))
            xt = max(xt,min(q(npx,j),q(npx+1,j)))
          else
            xt = max(0.,xt)
          endif
          br(npx) = xt-q(npx,j)
          xt = 3./14.*q(npx-1,j)+11./14.*q(npx-2,j)+4./7.*dm1(npx-2)
          xti = max(q(npx-2,j),q(npx-1,j))
          adxti = adxt*(0.5-sign(0.5,xti-xt))
          adq(npx-2,j) = adq(npx-2,j)+adxti*(0.5+sign(0.5,q(npx-2,j)-q(npx-1,j)))
          adq(npx-1,j) = adq(npx-1,j)+adxti*(0.5-sign(0.5,q(npx-2,j)-q(npx-1,j)))
          adxt = adxt*(0.5+sign(0.5,xti-xt))
        else
          adxt = adxt*(0.5-sign(0.5,0.-xt))
        endif
        addm1(npx-2) = addm1(npx-2)+0.57142857*adxt
        adq(npx-2,j) = adq(npx-2,j)+0.78571429*adxt
        adq(npx-1,j) = adq(npx-1,j)+0.21428571*adxt
        adxt = 0.
        adq(npx,j) = adq(npx,j)-adbr(npx)
        adxt = adxt+adbr(npx)
        adbr(npx) = 0.
        xt = 11./14.*q(npx+1,j)+3./14.*q(npx,j)-4./7.*dm1(npx+1)
        if (s_mono_kim) then
          xt = min(xt,max(q(npx,j),q(npx+1,j)))
          xtk = min(q(npx,j),q(npx+1,j))
          adxtk = adxt*(0.5-sign(0.5,xt-xtk))
          adq(npx+1,j) = adq(npx+1,j)+adxtk*(0.5-sign(0.5,q(npx+1,j)-q(npx,j)))
          adq(npx,j) = adq(npx,j)+adxtk*(0.5+sign(0.5,q(npx+1,j)-q(npx,j)))
          adxt = adxt*(0.5+sign(0.5,xt-xtk))
          bl(npx-2) = al(npx-2)-q(npx-2,j)
          xt = 0.5*((2.*dxa(npx-1,j)+dxa(npx-2,j))*(q(npx-1,j)+q(npx,j))-dxa(npx-1,j)*(q(npx-2,j)+q(npx+1,j)))/(dxa(npx-1,j)+&
&dxa(npx-2,j))
          if (edge_mono_kim) then
            if (j .gt. (-2) .and. j .lt. 1 .or. j .gt. npy-3 .and. j .lt. npy) then
              xt = min(xt,max(q(npx-1,j),q(npx,j),q(npx-1,j-1),q(npx,j-1)))
              xt = max(xt,min(q(npx-1,j),q(npx,j),q(npx-1,j-1),q(npx,j-1)))
            else if (j .lt. 3 .and. j .gt. 0 .or. j .gt. npy-1 .and. j .lt. npy+2) then
              xt = min(xt,max(q(npx-1,j),q(npx,j),q(npx-1,j+1),q(npx,j+1)))
              xt = max(xt,min(q(npx-1,j),q(npx,j),q(npx-1,j+1),q(npx,j+1)))
            else
              xt = max(0.,xt)
            endif
          else
            xt = max(0.,xt)
          endif
          br(npx-1) = xt-q(npx-1,j)
          bl(npx) = xt-q(npx,j)
          xt = 11./14.*q(npx+1,j)+3./14.*q(npx,j)-4./7.*dm1(npx+1)
          xtl = max(q(npx,j),q(npx+1,j))
          adxtl = adxt*(0.5-sign(0.5,xtl-xt))
          adq(npx+1,j) = adq(npx+1,j)+adxtl*(0.5-sign(0.5,q(npx,j)-q(npx+1,j)))
          adq(npx,j) = adq(npx,j)+adxtl*(0.5+sign(0.5,q(npx,j)-q(npx+1,j)))
          adxt = adxt*(0.5+sign(0.5,xtl-xt))
        else
          adxt = adxt*(0.5-sign(0.5,0.-xt))
        endif
        addm1(npx+1) = addm1(npx+1)-0.57142857*adxt
        adq(npx+1,j) = adq(npx+1,j)+0.78571429*adxt
        adq(npx,j) = adq(npx,j)+0.21428571*adxt
        adxt = 0.
        adq(npx,j) = adq(npx,j)-adbl(npx)
        adxt = adxt+adbl(npx)
        adbl(npx) = 0.
        adq(npx-1,j) = adq(npx-1,j)-adbr(npx-1)
        adxt = adxt+adbr(npx-1)
        adbr(npx-1) = 0.
        xt = 0.5*((2.*dxa(npx-1,j)+dxa(npx-2,j))*(q(npx-1,j)+q(npx,j))-dxa(npx-1,j)*(q(npx-2,j)+q(npx+1,j)))/(dxa(npx-1,j)+dxa(npx-&
&2,j))
        if (edge_mono_kim) then
          if (j .gt. (-2) .and. j .lt. 1 .or. j .gt. npy-3 .and. j .lt. npy) then
            xt = min(xt,max(q(npx-1,j),q(npx,j),q(npx-1,j-1),q(npx,j-1)))
            xtu = min(q(npx-1,j),q(npx,j))
            xtv = min(xtu,q(npx-1,j-1))
            xtw = min(xtv,q(npx,j-1))
            adxtw = adxt*(0.5-sign(0.5,xt-xtw))
            adq(npx,j-1) = adq(npx,j-1)+adxtw*(0.5-sign(0.5,q(npx,j-1)-xtv))
            adxtv = adxtw*(0.5+sign(0.5,q(npx,j-1)-xtv))
            adq(npx-1,j-1) = adq(npx-1,j-1)+adxtv*(0.5-sign(0.5,q(npx-1,j-1)-xtu))
            adxtu = adxtv*(0.5+sign(0.5,q(npx-1,j-1)-xtu))
            adq(npx-1,j) = adq(npx-1,j)+adxtu*(0.5+sign(0.5,q(npx,j)-q(npx-1,j)))
            adq(npx,j) = adq(npx,j)+adxtu*(0.5-sign(0.5,q(npx,j)-q(npx-1,j)))
            adxt = adxt*(0.5+sign(0.5,xt-xtw))
            bl(npx-2) = al(npx-2)-q(npx-2,j)
            xt = 0.5*((2.*dxa(npx-1,j)+dxa(npx-2,j))*(q(npx-1,j)+q(npx,j))-dxa(npx-1,j)*(q(npx-2,j)+q(npx+1,j)))/(dxa(npx-1,j)+&
&dxa(npx-2,j))
            xtx = max(q(npx-1,j),q(npx,j))
            xty = max(xtx,q(npx-1,j-1))
            xtz = max(xty,q(npx,j-1))
            adxtz = adxt*(0.5-sign(0.5,xtz-xt))
            adq(npx,j-1) = adq(npx,j-1)+adxtz*(0.5-sign(0.5,xty-q(npx,j-1)))
            adxty = adxtz*(0.5+sign(0.5,xty-q(npx,j-1)))
            adq(npx-1,j-1) = adq(npx-1,j-1)+adxty*(0.5-sign(0.5,xtx-q(npx-1,j-1)))
            adxtx = adxty*(0.5+sign(0.5,xtx-q(npx-1,j-1)))
            adq(npx-1,j) = adq(npx-1,j)+adxtx*(0.5+sign(0.5,q(npx-1,j)-q(npx,j)))
            adq(npx,j) = adq(npx,j)+adxtx*(0.5-sign(0.5,q(npx-1,j)-q(npx,j)))
            adxt = adxt*(0.5+sign(0.5,xtz-xt))
          else if (j .lt. 3 .and. j .gt. 0 .or. j .gt. npy-1 .and. j .lt. npy+2) then
            xt = min(xt,max(q(npx-1,j),q(npx,j),q(npx-1,j+1),q(npx,j+1)))
            xtn = min(q(npx-1,j),q(npx,j))
            xto = min(xtn,q(npx-1,j+1))
            xtq = min(xto,q(npx,j+1))
            adxtq = adxt*(0.5-sign(0.5,xt-xtq))
            adq(npx,j+1) = adq(npx,j+1)+adxtq*(0.5-sign(0.5,q(npx,j+1)-xto))
            adxto = adxtq*(0.5+sign(0.5,q(npx,j+1)-xto))
            adq(npx-1,j+1) = adq(npx-1,j+1)+adxto*(0.5-sign(0.5,q(npx-1,j+1)-xtn))
            adxtn = adxto*(0.5+sign(0.5,q(npx-1,j+1)-xtn))
            adq(npx-1,j) = adq(npx-1,j)+adxtn*(0.5+sign(0.5,q(npx,j)-q(npx-1,j)))
            adq(npx,j) = adq(npx,j)+adxtn*(0.5-sign(0.5,q(npx,j)-q(npx-1,j)))
            adxt = adxt*(0.5+sign(0.5,xt-xtq))
            bl(npx-2) = al(npx-2)-q(npx-2,j)
            xt = 0.5*((2.*dxa(npx-1,j)+dxa(npx-2,j))*(q(npx-1,j)+q(npx,j))-dxa(npx-1,j)*(q(npx-2,j)+q(npx+1,j)))/(dxa(npx-1,j)+&
&dxa(npx-2,j))
            xtr = max(q(npx-1,j),q(npx,j))
            xts = max(xtr,q(npx-1,j+1))
            xtt = max(xts,q(npx,j+1))
            adxtt = adxt*(0.5-sign(0.5,xtt-xt))
            adq(npx,j+1) = adq(npx,j+1)+adxtt*(0.5-sign(0.5,xts-q(npx,j+1)))
            adxts = adxtt*(0.5+sign(0.5,xts-q(npx,j+1)))
            adq(npx-1,j+1) = adq(npx-1,j+1)+adxts*(0.5-sign(0.5,xtr-q(npx-1,j+1)))
            adxtr = adxts*(0.5+sign(0.5,xtr-q(npx-1,j+1)))
            adq(npx-1,j) = adq(npx-1,j)+adxtr*(0.5+sign(0.5,q(npx-1,j)-q(npx,j)))
            adq(npx,j) = adq(npx,j)+adxtr*(0.5-sign(0.5,q(npx-1,j)-q(npx,j)))
            adxt = adxt*(0.5+sign(0.5,xtt-xt))
          else
            adxt = adxt*(0.5-sign(0.5,0.-xt))
          endif
        else
          adxt = adxt*(0.5-sign(0.5,0.-xt))
        endif
        adq(npx-2,j) = adq(npx-2,j)-adxt*(0.5*dxa(npx-1,j)/(dxa(npx-1,j)+dxa(npx-2,j)))
        adq(npx-1,j) = adq(npx-1,j)+adxt*(0.5*(2.*dxa(npx-1,j)+dxa(npx-2,j))/(dxa(npx-1,j)+dxa(npx-2,j)))
        adq(npx+1,j) = adq(npx+1,j)-adxt*(0.5*dxa(npx-1,j)/(dxa(npx-1,j)+dxa(npx-2,j)))
        adq(npx,j) = adq(npx,j)+adxt*(0.5*(2.*dxa(npx-1,j)+dxa(npx-2,j))/(dxa(npx-1,j)+dxa(npx-2,j)))
        adxt = 0.
        adal(npx-2) = adal(npx-2)+adbl(npx-2)
        adq(npx-2,j) = adq(npx-2,j)-adbl(npx-2)
        adbl(npx-2) = 0.
      endif
      if (iord .eq. 11) then
        do i = is3, ie3
          xt = 2.*dm1(i)
          bl(i) = -sign(min(abs(xt),abs(al(i)-q(i,j))),xt)
          br(i) = sign(min(abs(xt),abs(al(i+1)-q(i,j))),xt)
        end do
      else if (iord .eq. 12) then
        do i = is3, ie3
          pmp = -(2.*dq(i))
          lac = pmp+1.5*dq(i+1)
          bl(i) = min(max(0.,pmp,lac),max(al(i)-q(i,j),min(0.,pmp,lac)))
          pmp = 2.*dq(i-1)
          lac = pmp-1.5*dq(i-2)
          br(i) = min(max(0.,pmp,lac),max(al(i+1)-q(i,j),min(0.,pmp,lac)))
        end do
      else
        do i = is3, ie3
          bl(i) = al(i)-q(i,j)
          br(i) = al(i+1)-q(i,j)
        end do
      endif
      if (iord .ne. 11) then
        call pert_ppm( help_h,q(is3,j),bl(is3),br(is3),0 )
      endif
      if (is .eq. 1) then
        br(2) = al(3)-q(2,j)
        xt = 0.5*((2.*dxa(1,j)+dxa(2,j))*(q(0,j)+q(1,j))-dxa(1,j)*(q(-1,j)+q(2,j)))/(dxa(1,j)+dxa(2,j))
        if (edge_mono_kim) then
          if (j .gt. (-2) .and. j .lt. 1 .or. j .gt. npy-3 .and. j .lt. npy) then
            xt = min(xt,max(q(0,j),q(1,j),q(0,j-1),q(1,j-1)))
            xt = max(xt,min(q(0,j),q(1,j),q(0,j-1),q(1,j-1)))
          else if (j .lt. 3 .and. j .gt. 0 .or. j .gt. npy-1 .and. j .lt. npy+2) then
            xt = min(xt,max(q(0,j),q(1,j),q(0,j+1),q(1,j+1)))
            xt = max(xt,min(q(0,j),q(1,j),q(0,j+1),q(1,j+1)))
          else
            xt = max(0.,xt)
          endif
        else
          xt = max(0.,xt)
        endif
        bl(1) = xt-q(1,j)
        br(0) = xt-q(0,j)
        xt = 4./7.*dm1(-1)+11./14.*q(-1,j)+3./14.*q(0,j)
        if (s_mono_kim) then
          xt = min(xt,max(q(-1,j),q(0,j)))
          xt = max(xt,min(q(-1,j),q(0,j)))
        else
          xt = max(0.,xt)
        endif
        bl(0) = xt-q(0,j)
        xt = 3./14.*q(1,j)+11./14.*q(2,j)-4./7.*dm1(2)
        if (s_mono_kim) then
          xt = min(xt,max(q(1,j),q(2,j)))
          xt = max(xt,min(q(1,j),q(2,j)))
        else
          xt = max(0.,xt)
        endif
        br(1) = xt-q(1,j)
        bl(2) = xt-q(2,j)
        call adpert_ppm( 3,q(0,j),adq(0,j),bl(0),adbl(0),br(0),adbr(0),1 )
        adq(2,j) = adq(2,j)-adbl(2)
        adxt = adxt+adbl(2)
        adbl(2) = 0.
        adq(1,j) = adq(1,j)-adbr(1)
        adxt = adxt+adbr(1)
        adbr(1) = 0.
        xt = 3./14.*q(1,j)+11./14.*q(2,j)-4./7.*dm1(2)
        if (s_mono_kim) then
          xt = min(xt,max(q(1,j),q(2,j)))
          xtza = min(q(1,j),q(2,j))
          adxtza = adxt*(0.5-sign(0.5,xt-xtza))
          adq(2,j) = adq(2,j)+adxtza*(0.5-sign(0.5,q(2,j)-q(1,j)))
          adq(1,j) = adq(1,j)+adxtza*(0.5+sign(0.5,q(2,j)-q(1,j)))
          adxt = adxt*(0.5+sign(0.5,xt-xtza))
          br(2) = al(3)-q(2,j)
          xt = 0.5*((2.*dxa(1,j)+dxa(2,j))*(q(0,j)+q(1,j))-dxa(1,j)*(q(-1,j)+q(2,j)))/(dxa(1,j)+dxa(2,j))
          if (edge_mono_kim) then
            if (j .gt. (-2) .and. j .lt. 1 .or. j .gt. npy-3 .and. j .lt. npy) then
              xt = min(xt,max(q(0,j),q(1,j),q(0,j-1),q(1,j-1)))
              xt = max(xt,min(q(0,j),q(1,j),q(0,j-1),q(1,j-1)))
            else if (j .lt. 3 .and. j .gt. 0 .or. j .gt. npy-1 .and. j .lt. npy+2) then
              xt = min(xt,max(q(0,j),q(1,j),q(0,j+1),q(1,j+1)))
              xt = max(xt,min(q(0,j),q(1,j),q(0,j+1),q(1,j+1)))
            else
              xt = max(0.,xt)
            endif
          else
            xt = max(0.,xt)
          endif
          bl(1) = xt-q(1,j)
          br(0) = xt-q(0,j)
          xt = 4./7.*dm1(-1)+11./14.*q(-1,j)+3./14.*q(0,j)
          if (s_mono_kim) then
            xt = min(xt,max(q(-1,j),q(0,j)))
            xt = max(xt,min(q(-1,j),q(0,j)))
          else
            xt = max(0.,xt)
          endif
          bl(0) = xt-q(0,j)
          xt = 3./14.*q(1,j)+11./14.*q(2,j)-4./7.*dm1(2)
          xtzb = max(q(1,j),q(2,j))
          adxtzb = adxt*(0.5-sign(0.5,xtzb-xt))
          adq(2,j) = adq(2,j)+adxtzb*(0.5-sign(0.5,q(1,j)-q(2,j)))
          adq(1,j) = adq(1,j)+adxtzb*(0.5+sign(0.5,q(1,j)-q(2,j)))
          adxt = adxt*(0.5+sign(0.5,xtzb-xt))
        else
          adxt = adxt*(0.5-sign(0.5,0.-xt))
        endif
        addm1(2) = addm1(2)-0.57142857*adxt
        adq(2,j) = adq(2,j)+0.78571429*adxt
        adq(1,j) = adq(1,j)+0.21428571*adxt
        adxt = 0.
        adq(0,j) = adq(0,j)-adbl(0)
        adxt = adxt+adbl(0)
        adbl(0) = 0.
        xt = 4./7.*dm1(-1)+11./14.*q(-1,j)+3./14.*q(0,j)
        if (s_mono_kim) then
          xt = min(xt,max(q(-1,j),q(0,j)))
          xtzc = min(q(-1,j),q(0,j))
          adxtzc = adxt*(0.5-sign(0.5,xt-xtzc))
          adq(-1,j) = adq(-1,j)+adxtzc*(0.5+sign(0.5,q(0,j)-q(-1,j)))
          adq(0,j) = adq(0,j)+adxtzc*(0.5-sign(0.5,q(0,j)-q(-1,j)))
          adxt = adxt*(0.5+sign(0.5,xt-xtzc))
          br(2) = al(3)-q(2,j)
          xt = 0.5*((2.*dxa(1,j)+dxa(2,j))*(q(0,j)+q(1,j))-dxa(1,j)*(q(-1,j)+q(2,j)))/(dxa(1,j)+dxa(2,j))
          if (edge_mono_kim) then
            if (j .gt. (-2) .and. j .lt. 1 .or. j .gt. npy-3 .and. j .lt. npy) then
              xt = min(xt,max(q(0,j),q(1,j),q(0,j-1),q(1,j-1)))
              xt = max(xt,min(q(0,j),q(1,j),q(0,j-1),q(1,j-1)))
            else if (j .lt. 3 .and. j .gt. 0 .or. j .gt. npy-1 .and. j .lt. npy+2) then
              xt = min(xt,max(q(0,j),q(1,j),q(0,j+1),q(1,j+1)))
              xt = max(xt,min(q(0,j),q(1,j),q(0,j+1),q(1,j+1)))
            else
              xt = max(0.,xt)
            endif
          else
            xt = max(0.,xt)
          endif
          bl(1) = xt-q(1,j)
          br(0) = xt-q(0,j)
          xt = 4./7.*dm1(-1)+11./14.*q(-1,j)+3./14.*q(0,j)
          xtzd = max(q(-1,j),q(0,j))
          adxtzd = adxt*(0.5-sign(0.5,xtzd-xt))
          adq(-1,j) = adq(-1,j)+adxtzd*(0.5+sign(0.5,q(-1,j)-q(0,j)))
          adq(0,j) = adq(0,j)+adxtzd*(0.5-sign(0.5,q(-1,j)-q(0,j)))
          adxt = adxt*(0.5+sign(0.5,xtzd-xt))
        else
          adxt = adxt*(0.5-sign(0.5,0.-xt))
        endif
        addm1(-1) = addm1(-1)+0.57142857*adxt
        adq(-1,j) = adq(-1,j)+0.78571429*adxt
        adq(0,j) = adq(0,j)+0.21428571*adxt
        adxt = 0.
        adq(0,j) = adq(0,j)-adbr(0)
        adxt = adxt+adbr(0)
        adbr(0) = 0.
        adq(1,j) = adq(1,j)-adbl(1)
        adxt = adxt+adbl(1)
        adbl(1) = 0.
        xt = 0.5*((2.*dxa(1,j)+dxa(2,j))*(q(0,j)+q(1,j))-dxa(1,j)*(q(-1,j)+q(2,j)))/(dxa(1,j)+dxa(2,j))
        if (edge_mono_kim) then
          if (j .gt. (-2) .and. j .lt. 1 .or. j .gt. npy-3 .and. j .lt. npy) then
            xt = min(xt,max(q(0,j),q(1,j),q(0,j-1),q(1,j-1)))
            xtzk = min(q(0,j),q(1,j))
            xtzl = min(xtzk,q(0,j-1))
            xtzm = min(xtzl,q(1,j-1))
            adxtzm = adxt*(0.5-sign(0.5,xt-xtzm))
            adq(1,j-1) = adq(1,j-1)+adxtzm*(0.5-sign(0.5,q(1,j-1)-xtzl))
            adxtzl = adxtzm*(0.5+sign(0.5,q(1,j-1)-xtzl))
            adq(0,j-1) = adq(0,j-1)+adxtzl*(0.5-sign(0.5,q(0,j-1)-xtzk))
            adxtzk = adxtzl*(0.5+sign(0.5,q(0,j-1)-xtzk))
            adq(1,j) = adq(1,j)+adxtzk*(0.5-sign(0.5,q(1,j)-q(0,j)))
            adq(0,j) = adq(0,j)+adxtzk*(0.5+sign(0.5,q(1,j)-q(0,j)))
            adxt = adxt*(0.5+sign(0.5,xt-xtzm))
            br(2) = al(3)-q(2,j)
            xt = 0.5*((2.*dxa(1,j)+dxa(2,j))*(q(0,j)+q(1,j))-dxa(1,j)*(q(-1,j)+q(2,j)))/(dxa(1,j)+dxa(2,j))
            xtzn = max(q(0,j),q(1,j))
            xtzo = max(xtzn,q(0,j-1))
            xtzp = max(xtzo,q(1,j-1))
            adxtzp = adxt*(0.5-sign(0.5,xtzp-xt))
            adq(1,j-1) = adq(1,j-1)+adxtzp*(0.5-sign(0.5,xtzo-q(1,j-1)))
            adxtzo = adxtzp*(0.5+sign(0.5,xtzo-q(1,j-1)))
            adq(0,j-1) = adq(0,j-1)+adxtzo*(0.5-sign(0.5,xtzn-q(0,j-1)))
            adxtzn = adxtzo*(0.5+sign(0.5,xtzn-q(0,j-1)))
            adq(1,j) = adq(1,j)+adxtzn*(0.5-sign(0.5,q(0,j)-q(1,j)))
            adq(0,j) = adq(0,j)+adxtzn*(0.5+sign(0.5,q(0,j)-q(1,j)))
            adxt = adxt*(0.5+sign(0.5,xtzp-xt))
          else if (j .lt. 3 .and. j .gt. 0 .or. j .gt. npy-1 .and. j .lt. npy+2) then
            xt = min(xt,max(q(0,j),q(1,j),q(0,j+1),q(1,j+1)))
            xtze = min(q(0,j),q(1,j))
            xtzf = min(xtze,q(0,j+1))
            xtzg = min(xtzf,q(1,j+1))
            adxtzg = adxt*(0.5-sign(0.5,xt-xtzg))
            adq(1,j+1) = adq(1,j+1)+adxtzg*(0.5-sign(0.5,q(1,j+1)-xtzf))
            adxtzf = adxtzg*(0.5+sign(0.5,q(1,j+1)-xtzf))
            adq(0,j+1) = adq(0,j+1)+adxtzf*(0.5-sign(0.5,q(0,j+1)-xtze))
            adxtze = adxtzf*(0.5+sign(0.5,q(0,j+1)-xtze))
            adq(1,j) = adq(1,j)+adxtze*(0.5-sign(0.5,q(1,j)-q(0,j)))
            adq(0,j) = adq(0,j)+adxtze*(0.5+sign(0.5,q(1,j)-q(0,j)))
            adxt = adxt*(0.5+sign(0.5,xt-xtzg))
            br(2) = al(3)-q(2,j)
            xt = 0.5*((2.*dxa(1,j)+dxa(2,j))*(q(0,j)+q(1,j))-dxa(1,j)*(q(-1,j)+q(2,j)))/(dxa(1,j)+dxa(2,j))
            xtzh = max(q(0,j),q(1,j))
            xtzi = max(xtzh,q(0,j+1))
            xtzj = max(xtzi,q(1,j+1))
            adxtzj = adxt*(0.5-sign(0.5,xtzj-xt))
            adq(1,j+1) = adq(1,j+1)+adxtzj*(0.5-sign(0.5,xtzi-q(1,j+1)))
            adxtzi = adxtzj*(0.5+sign(0.5,xtzi-q(1,j+1)))
            adq(0,j+1) = adq(0,j+1)+adxtzi*(0.5-sign(0.5,xtzh-q(0,j+1)))
            adxtzh = adxtzi*(0.5+sign(0.5,xtzh-q(0,j+1)))
            adq(1,j) = adq(1,j)+adxtzh*(0.5-sign(0.5,q(0,j)-q(1,j)))
            adq(0,j) = adq(0,j)+adxtzh*(0.5+sign(0.5,q(0,j)-q(1,j)))
            adxt = adxt*(0.5+sign(0.5,xtzj-xt))
          else
            adxt = adxt*(0.5-sign(0.5,0.-xt))
          endif
        else
          adxt = adxt*(0.5-sign(0.5,0.-xt))
        endif
        adq(-1,j) = adq(-1,j)-adxt*(0.5*dxa(1,j)/(dxa(1,j)+dxa(2,j)))
        adq(2,j) = adq(2,j)-adxt*(0.5*dxa(1,j)/(dxa(1,j)+dxa(2,j)))
        adq(1,j) = adq(1,j)+adxt*(0.5*(2.*dxa(1,j)+dxa(2,j))/(dxa(1,j)+dxa(2,j)))
        adq(0,j) = adq(0,j)+adxt*(0.5*(2.*dxa(1,j)+dxa(2,j))/(dxa(1,j)+dxa(2,j)))
        adxt = 0.
        adal(3) = adal(3)+adbr(2)
        adq(2,j) = adq(2,j)-adbr(2)
        adbr(2) = 0.
      endif
      if (iord .eq. 11) then
        do i = is3, ie3
          xt = 2.*dm1(i)
          bl(i) = -sign(min(abs(xt),abs(al(i)-q(i,j))),xt)
          br(i) = sign(min(abs(xt),abs(al(i+1)-q(i,j))),xt)
        end do
      else if (iord .eq. 12) then
        do i = is3, ie3
          pmp = -(2.*dq(i))
          lac = pmp+1.5*dq(i+1)
          bl(i) = min(max(0.,pmp,lac),max(al(i)-q(i,j),min(0.,pmp,lac)))
          pmp = 2.*dq(i-1)
          lac = pmp-1.5*dq(i-2)
          br(i) = min(max(0.,pmp,lac),max(al(i+1)-q(i,j),min(0.,pmp,lac)))
        end do
      else
        do i = is3, ie3
          bl(i) = al(i)-q(i,j)
          br(i) = al(i+1)-q(i,j)
        end do
      endif
      if (iord .ne. 11) then
        call adpert_ppm( help_h,q(is3,j),adq(is3,j),bl(is3),adbl(is3),br(is3),adbr(is3),0 )
      endif
      if (iord .eq. 11) then
        do i = is3, ie3
          adxt = 0.
          xt = 2.*dm1(i)
          brt = al(i+1)-q(i,j)
          adbrt = adbr(i)*sign(1.,min(abs(xt),abs(brt)))*sign(1.,xt)
          adbru = adbrt*(0.5-sign(0.5,abs(brt)-abs(xt)))*sign(1.,brt)
          adxt = adxt+adbrt*(0.5+sign(0.5,abs(brt)-abs(xt)))*sign(1.,xt)
          adal(i+1) = adal(i+1)+adbru
          adq(i,j) = adq(i,j)-adbru
          adbr(i) = 0.
          blt = al(i)-q(i,j)
          adblt = -(adbl(i)*sign(1.,min(abs(xt),abs(blt)))*sign(1.,xt))
          adblu = adblt*(0.5-sign(0.5,abs(blt)-abs(xt)))*sign(1.,blt)
          adxt = adxt+adblt*(0.5+sign(0.5,abs(blt)-abs(xt)))*sign(1.,xt)
          adal(i) = adal(i)+adblu
          adq(i,j) = adq(i,j)-adblu
          adbl(i) = 0.
          addm1(i) = addm1(i)+2*adxt
          adxt = 0.
        end do
      else if (iord .eq. 12) then
        do i = is3, ie3
          adlac = 0.
          adpmp = 0.
          pmp = 2.*dq(i-1)
          lac = pmp-1.5*dq(i-2)
          brm = max(0.,pmp)
          bro = max(brm,lac)
          brq = min(0.,pmp)
          brr = min(brq,lac)
          brp = max(al(i+1)-q(i,j),brr)
          adbrp = adbr(i)*(0.5+sign(0.5,brp-bro))
          adbrq = adbr(i)*(0.5-sign(0.5,brp-bro))
          adal(i+1) = adal(i+1)+adbrq*(0.5+sign(0.5,al(i+1)-q(i,j)-brr))
          adbrs = adbrq*(0.5-sign(0.5,al(i+1)-q(i,j)-brr))
          adq(i,j) = adq(i,j)-adbrq*(0.5+sign(0.5,al(i+1)-q(i,j)-brr))
          adbrr = adbrs*(0.5+sign(0.5,lac-brq))
          adlac = adlac+adbrs*(0.5-sign(0.5,lac-brq))
          adpmp = adpmp+adbrr*(0.5-sign(0.5,pmp-0.))
          adbro = adbrp*(0.5+sign(0.5,brm-lac))
          adlac = adlac+adbrp*(0.5-sign(0.5,brm-lac))
          adpmp = adpmp+adbro*(0.5-sign(0.5,0.-pmp))
          adbr(i) = 0.
          addq(i-2) = addq(i-2)-1.5*adlac
          adpmp = adpmp+adlac
          adlac = 0.
          addq(i-1) = addq(i-1)+2*adpmp
          adpmp = 0.
          pmp = -(2.*dq(i))
          lac = pmp+1.5*dq(i+1)
          blm = max(0.,pmp)
          blo = max(blm,lac)
          blq = min(0.,pmp)
          blr = min(blq,lac)
          blp = max(al(i)-q(i,j),blr)
          adblp = adbl(i)*(0.5+sign(0.5,blp-blo))
          adblq = adbl(i)*(0.5-sign(0.5,blp-blo))
          adal(i) = adal(i)+adblq*(0.5+sign(0.5,al(i)-q(i,j)-blr))
          adbls = adblq*(0.5-sign(0.5,al(i)-q(i,j)-blr))
          adq(i,j) = adq(i,j)-adblq*(0.5+sign(0.5,al(i)-q(i,j)-blr))
          adblr = adbls*(0.5+sign(0.5,lac-blq))
          adlac = adlac+adbls*(0.5-sign(0.5,lac-blq))
          adpmp = adpmp+adblr*(0.5-sign(0.5,pmp-0.))
          adblo = adblp*(0.5+sign(0.5,blm-lac))
          adlac = adlac+adblp*(0.5-sign(0.5,blm-lac))
          adpmp = adpmp+adblo*(0.5-sign(0.5,0.-pmp))
          adbl(i) = 0.
          addq(i+1) = addq(i+1)+1.5*adlac
          adpmp = adpmp+adlac
          adlac = 0.
          addq(i) = addq(i)-2*adpmp
          adpmp = 0.
        end do
        do i = is-3, ie+2
          adq(i+1,j) = adq(i+1,j)+addq(i)
          adq(i,j) = adq(i,j)-addq(i)
          addq(i) = 0.
        end do
      else
        do i = is3, ie3
          adal(i+1) = adal(i+1)+adbr(i)
          adq(i,j) = adq(i,j)-adbr(i)
          adbr(i) = 0.
          adal(i) = adal(i)+adbl(i)
          adq(i,j) = adq(i,j)-adbl(i)
          adbl(i) = 0.
        end do
      endif
      do i = is3, min(npx-2,ie+2)
        addm1(i-1) = addm1(i-1)+adal(i)*r3
        addm1(i) = addm1(i)-adal(i)*r3
        adq(i-1,j) = adq(i-1,j)+0.5*adal(i)
        adq(i,j) = adq(i,j)+0.5*adal(i)
        adal(i) = 0.
      end do
    else
      if (iord .eq. 11) then
        do i = is-1, ie+1
          xt = 2.*dm1(i)
          bl(i) = -sign(min(abs(xt),abs(al(i)-q(i,j))),xt)
          br(i) = sign(min(abs(xt),abs(al(i+1)-q(i,j))),xt)
        end do
      else if (iord .eq. 12) then
        do i = is-1, ie+1
          pmp = -(2.*dq(i))
          lac = pmp+1.5*dq(i+1)
          bl(i) = min(max(0.,pmp,lac),max(al(i)-q(i,j),min(0.,pmp,lac)))
          pmp = 2.*dq(i-1)
          lac = pmp-1.5*dq(i-2)
          br(i) = min(max(0.,pmp,lac),max(al(i+1)-q(i,j),min(0.,pmp,lac)))
        end do
      else
        do i = is-1, ie+1
          bl(i) = al(i)-q(i,j)
          br(i) = al(i+1)-q(i,j)
        end do
      endif
      if (iord .ne. 11) then
        call adpert_ppm( help_i,q(is-1,j),adq(is-1,j),bl(is-1),adbl(is-1),br(is-1),adbr(is-1),0 )
      endif
      if (iord .eq. 11) then
        do i = is-1, ie+1
          adxt = 0.
          xt = 2.*dm1(i)
          brn = al(i+1)-q(i,j)
          adbrm = adbr(i)*sign(1.,min(abs(xt),abs(brn)))*sign(1.,xt)
          adbrn = adbrm*(0.5-sign(0.5,abs(brn)-abs(xt)))*sign(1.,brn)
          adxt = adxt+adbrm*(0.5+sign(0.5,abs(brn)-abs(xt)))*sign(1.,xt)
          adal(i+1) = adal(i+1)+adbrn
          adq(i,j) = adq(i,j)-adbrn
          adbr(i) = 0.
          bln = al(i)-q(i,j)
          adblm = -(adbl(i)*sign(1.,min(abs(xt),abs(bln)))*sign(1.,xt))
          adbln = adblm*(0.5-sign(0.5,abs(bln)-abs(xt)))*sign(1.,bln)
          adxt = adxt+adblm*(0.5+sign(0.5,abs(bln)-abs(xt)))*sign(1.,xt)
          adal(i) = adal(i)+adbln
          adq(i,j) = adq(i,j)-adbln
          adbl(i) = 0.
          addm1(i) = addm1(i)+2*adxt
          adxt = 0.
        end do
      else if (iord .eq. 12) then
        do i = is-1, ie+1
          adlac = 0.
          adpmp = 0.
          pmp = 2.*dq(i-1)
          lac = pmp-1.5*dq(i-2)
          brh = max(0.,pmp)
          bri = max(brh,lac)
          brk = min(0.,pmp)
          brl = min(brk,lac)
          brj = max(al(i+1)-q(i,j),brl)
          adbri = adbr(i)*(0.5+sign(0.5,brj-bri))
          adbrj = adbr(i)*(0.5-sign(0.5,brj-bri))
          adal(i+1) = adal(i+1)+adbrj*(0.5+sign(0.5,al(i+1)-q(i,j)-brl))
          adbrl = adbrj*(0.5-sign(0.5,al(i+1)-q(i,j)-brl))
          adq(i,j) = adq(i,j)-adbrj*(0.5+sign(0.5,al(i+1)-q(i,j)-brl))
          adbrk = adbrl*(0.5+sign(0.5,lac-brk))
          adlac = adlac+adbrl*(0.5-sign(0.5,lac-brk))
          adpmp = adpmp+adbrk*(0.5-sign(0.5,pmp-0.))
          adbrh = adbri*(0.5+sign(0.5,brh-lac))
          adlac = adlac+adbri*(0.5-sign(0.5,brh-lac))
          adpmp = adpmp+adbrh*(0.5-sign(0.5,0.-pmp))
          adbr(i) = 0.
          addq(i-2) = addq(i-2)-1.5*adlac
          adpmp = adpmp+adlac
          adlac = 0.
          addq(i-1) = addq(i-1)+2*adpmp
          adpmp = 0.
          pmp = -(2.*dq(i))
          lac = pmp+1.5*dq(i+1)
          blh = max(0.,pmp)
          bli = max(blh,lac)
          blk = min(0.,pmp)
          bll = min(blk,lac)
          blj = max(al(i)-q(i,j),bll)
          adbli = adbl(i)*(0.5+sign(0.5,blj-bli))
          adblj = adbl(i)*(0.5-sign(0.5,blj-bli))
          adal(i) = adal(i)+adblj*(0.5+sign(0.5,al(i)-q(i,j)-bll))
          adbll = adblj*(0.5-sign(0.5,al(i)-q(i,j)-bll))
          adq(i,j) = adq(i,j)-adblj*(0.5+sign(0.5,al(i)-q(i,j)-bll))
          adblk = adbll*(0.5+sign(0.5,lac-blk))
          adlac = adlac+adbll*(0.5-sign(0.5,lac-blk))
          adpmp = adpmp+adblk*(0.5-sign(0.5,pmp-0.))
          adblh = adbli*(0.5+sign(0.5,blh-lac))
          adlac = adlac+adbli*(0.5-sign(0.5,blh-lac))
          adpmp = adpmp+adblh*(0.5-sign(0.5,0.-pmp))
          adbl(i) = 0.
          addq(i+1) = addq(i+1)+1.5*adlac
          adpmp = adpmp+adlac
          adlac = 0.
          addq(i) = addq(i)-2*adpmp
          adpmp = 0.
        end do
        do i = is-3, ie+2
          adq(i+1,j) = adq(i+1,j)+addq(i)
          adq(i,j) = adq(i,j)-addq(i)
          addq(i) = 0.
        end do
      else
        do i = is-1, ie+1
          adal(i+1) = adal(i+1)+adbr(i)
          adq(i,j) = adq(i,j)-adbr(i)
          adbr(i) = 0.
          adal(i) = adal(i)+adbl(i)
          adq(i,j) = adq(i,j)-adbl(i)
          adbl(i) = 0.
        end do
      endif
      do i = is-1, ie+2
        addm1(i-1) = addm1(i-1)+adal(i)*r3
        addm1(i) = addm1(i)-adal(i)*r3
        adq(i-1,j) = adq(i-1,j)+0.5*adal(i)
        adq(i,j) = adq(i,j)+0.5*adal(i)
        adal(i) = 0.
      end do
    endif
    do i = ifirst-2, ilast+2
      adxt = 0.
      xt = 0.25*(q(i+1,j)-q(i-1,j))
      dm1h = abs(xt)
      dm1i = max(q(i-1,j),q(i,j))
      dm1k = max(dm1i,q(i+1,j))-q(i,j)
      dm1l = min(q(i-1,j),q(i,j))
      dm1n = q(i,j)-min(dm1l,q(i+1,j))
      dm1o = min(dm1h,dm1k)
      addm1p = addm1(i)*sign(1.,min(dm1o,dm1n))*sign(1.,xt)
      addm1n = addm1p*(0.5-sign(0.5,dm1n-dm1o))
      addm1o = addm1p*(0.5+sign(0.5,dm1n-dm1o))
      addm1h = addm1o*(0.5+sign(0.5,dm1k-dm1h))
      addm1k = addm1o*(0.5-sign(0.5,dm1k-dm1h))
      addm1m = -addm1n
      adq(i,j) = adq(i,j)+addm1n
      addm1l = addm1m*(0.5+sign(0.5,q(i+1,j)-dm1l))
      adq(i+1,j) = adq(i+1,j)+addm1m*(0.5-sign(0.5,q(i+1,j)-dm1l))
      adq(i-1,j) = adq(i-1,j)+addm1l*(0.5+sign(0.5,q(i,j)-q(i-1,j)))
      adq(i,j) = adq(i,j)+addm1l*(0.5-sign(0.5,q(i,j)-q(i-1,j)))
      adq(i,j) = adq(i,j)-addm1k
      addm1i = addm1k*(0.5+sign(0.5,dm1i-q(i+1,j)))
      adq(i+1,j) = adq(i+1,j)+addm1k*(0.5-sign(0.5,dm1i-q(i+1,j)))
      adq(i-1,j) = adq(i-1,j)+addm1i*(0.5+sign(0.5,q(i-1,j)-q(i,j)))
      adq(i,j) = adq(i,j)+addm1i*(0.5-sign(0.5,q(i-1,j)-q(i,j)))
      adxt = adxt+addm1h*sign(1.,xt)
      addm1(i) = 0.
      adq(i-1,j) = adq(i-1,j)-0.25*adxt
      adq(i+1,j) = adq(i+1,j)+0.25*adxt
      adxt = 0.
    end do
  end do
endif

end subroutine adfxppm


subroutine adfyppm( c, adc, q, adq, adflux, jord, ifirst, ilast, jfirst, jlast, npx, npy, uniform_ppm, dm, addm )
!******************************************************************
!******************************************************************
!** This routine was generated by Automatic differentiation.     **
!** FastOpt: Transformation of Algorithm in Fortran, TAF 1.9.22  **
!******************************************************************
!******************************************************************
!==============================================
! all entries are defined explicitly
!==============================================
implicit none

!==============================================
! declare parameters
!==============================================
real, parameter :: b1 = 1./30.
real, parameter :: b2 = -(13./60.)
real, parameter :: b3 = -(13./60.)
real, parameter :: b4 = 0.45
real, parameter :: b5 = -0.05
real, parameter :: r3 = 1./3.

!==============================================
! declare arguments
!==============================================
real, intent(inout) :: adc(isd:ied,js:je+1)
integer, intent(in) :: ifirst
integer, intent(in) :: ilast
integer, intent(in) :: jfirst
integer, intent(in) :: jlast
real, intent(inout) :: addm(ifirst:ilast,jfirst-ng:jlast+ng)
real, intent(inout) :: adflux(ifirst:ilast,jfirst:jlast+1)
real, intent(inout) :: adq(ifirst:ilast,jfirst-ng:jlast+ng)
real, intent(in) :: c(isd:ied,js:je+1)
real, intent(out) :: dm(ifirst:ilast,jfirst-ng:jlast+ng)
integer, intent(in) :: jord
integer, intent(in) :: npx
integer, intent(in) :: npy
real, intent(in) :: q(ifirst:ilast,jfirst-ng:jlast+ng)
logical, intent(in) :: uniform_ppm

!==============================================
! declare local variables
!==============================================
real :: adal(ifirst:ilast,jfirst-1:jlast+2)
real :: adbl(ifirst:ilast,jfirst-1:jlast+1)
real :: adblh
real :: adbli
real :: adblj
real :: adblk
real :: adbll
real :: adblm
real :: adbln
real :: adblo
real :: adblp
real :: adblq
real :: adblr
real :: adbls
real :: adblt
real :: adblu
real :: adblv
real :: adblw
real :: adblx
real :: adbly
real :: adblz
real :: adblza
real :: adblzb
real :: adblzc
real :: adblzd
real :: adblze
real :: adblzf
real :: adblzg
real :: adblzh
real :: adblzi
real :: adblzj
real :: adblzk
real :: adblzl
real :: adblzm
real :: adblzn
real :: adblzo
real :: adbr(ifirst:ilast,jfirst-1:jlast+1)
real :: adbrh
real :: adbri
real :: adbrj
real :: adbrk
real :: adbrl
real :: adbrm
real :: adbrn
real :: adbro
real :: adbrp
real :: adbrq
real :: adbrr
real :: adbrs
real :: adbrt
real :: adbru
real :: adbrv
real :: adbrw
real :: adbrx
real :: adbry
real :: adbrz
real :: adbrza
real :: adbrzb
real :: adbrzc
real :: adbrzd
real :: adbrze
real :: adbrzf
real :: adbrzg
real :: adbrzh
real :: adbrzi
real :: adbrzj
real :: adbrzk
real :: adbrzl
real :: adbrzm
real :: adbrzn
real :: adbrzo
real :: adc1
real :: addl
real :: addlh
real :: addli
real :: addlj
real :: addlk
real :: addll
real :: addmh
real :: addmi
real :: addmj
real :: addmk
real :: addml
real :: addmm
real :: addmn
real :: addmo
real :: addmp
real :: addmq
real :: addmr
real :: addms
real :: addmt
real :: addmu
real :: addmv
real :: addmw
real :: addmx
real :: addmy
real :: addmz
real :: addmza
real :: addmzb
real :: addmzc
real :: addmzd
real :: addmze
real :: addmzf
real :: addmzg
real :: addmzh
real :: addmzi
real :: addmzj
real :: addmzk
real :: addmzl
real :: addmzm
real :: addmzn
real :: addmzo
real :: addmzp
real :: addmzq
real :: addmzr
real :: addmzs
real :: addmzt
real :: addmzu
real :: addmzv
real :: addmzx
real :: addmzy
real :: addmzz
real :: addmzza
real :: addmzzb
real :: addmzzc
real :: addq(ifirst:ilast,jfirst-3:jlast+2)
real :: addr
real :: addrh
real :: addri
real :: addrj
real :: addrk
real :: addrl
real :: adlac
real :: adpmp
real :: adqe
real :: adxt
real :: adxth
real :: adxti
real :: adxtj
real :: adxtk
real :: adxtl
real :: adxtm
real :: adxtn
real :: adxto
real :: adxtq
real :: adxtr
real :: adxts
real :: adxtt
real :: adxtu
real :: adxtv
real :: adxtw
real :: adxtx
real :: adxty
real :: adxtz
real :: adxtza
real :: adxtzb
real :: adxtzc
real :: adxtzd
real :: adxtze
real :: adxtzf
real :: adxtzg
real :: adxtzh
real :: adxtzi
real :: adxtzj
real :: adxtzk
real :: adxtzl
real :: adxtzm
real :: adxtzn
real :: adxtzo
real :: adxtzp
real :: adxtzq
real :: adxtzr
real :: adxtzs
real :: adxtzt
real :: adxtzu
real :: adxtzv
real :: adxtzw
real :: adxtzx
real :: adxtzy
real :: adxtzz
real :: adxtzza
real :: adxtzzb
real :: adxtzzc
real :: adxtzzd
real :: adxtzze
real :: adxtzzf
real :: adxtzzg
real :: adxtzzh
real :: adxtzzi
real :: adxtzzj
real :: adxtzzk
real :: adxtzzl
real :: adxtzzm
real :: adxtzzn
real :: adxtzzo
real :: adxtzzp
real :: adxtzzq
real :: adxtzzr
real :: adxtzzs
real :: adxtzzt
real :: al(ifirst:ilast,jfirst-1:jlast+2)
real :: bl(ifirst:ilast,jfirst-1:jlast+1)
real :: blh
real :: bli
real :: blj
real :: blk
real :: bll
real :: blm
real :: bln
real :: blo
real :: blp
real :: blq
real :: blr
real :: bls
real :: blt
real :: blu
real :: blv
real :: blw
real :: blx
real :: bly
real :: blz
real :: blza
real :: blzb
real :: blzc
real :: blzd
real :: blze
real :: blzf
real :: blzg
real :: blzh
real :: blzi
real :: blzj
real :: blzk
real :: blzl
real :: blzm
real :: br(ifirst:ilast,jfirst-1:jlast+1)
real :: brh
real :: bri
real :: brj
real :: brk
real :: brl
real :: brm
real :: brn
real :: bro
real :: brp
real :: brq
real :: brr
real :: brs
real :: brt
real :: bru
real :: brv
real :: brw
real :: brx
real :: bry
real :: brz
real :: brza
real :: brzb
real :: brzc
real :: brzd
real :: brze
real :: brzf
real :: brzg
real :: brzh
real :: brzi
real :: brzj
real :: brzk
real :: brzl
real :: brzm
real :: c1
real :: dl
real :: dli
real :: dlj
real :: dmh
real :: dmi
real :: dmj
real :: dmk
real :: dml
real :: dmm
real :: dmn
real :: dmo
real :: dmp
real :: dmq
real :: dmr
real :: dms
real :: dmt
real :: dmu
real :: dmv
real :: dmw
real :: dmx
real :: dmy
real :: dmz
real :: dmza
real :: dmzb
real :: dmzc
real :: dmzd
real :: dmze
real :: dmzf
real :: dmzg
real :: dmzh
real :: dmzi
real :: dmzj
real :: dmzk
real :: dmzl
real :: dmzm
real :: dmzo
real :: dmzp
real :: dmzr
real :: dmzs
real :: dq(ifirst:ilast,jfirst-3:jlast+2)
real :: dr
real :: dri
real :: drj
integer :: help_h
integer :: help_i
integer :: help_j
integer :: help_k
integer :: help_l
integer :: help_m
integer :: i
integer :: j
integer :: j1
integer :: j2
integer :: j3
integer :: j4
integer :: j5
integer :: j6
integer :: ja1
integer :: ja4
integer :: je3
integer :: js3
integer :: jt
real :: lac
real :: pmp
real :: qe
real :: xt
real :: xth
real :: xti
real :: xtj
real :: xtk
real :: xtl
real :: xtm
real :: xtn
real :: xto
real :: xtq
real :: xtr
real :: xts
real :: xtt
real :: xtu
real :: xtv
real :: xtw
real :: xtx
real :: xty
real :: xtz
real :: xtza
real :: xtzb
real :: xtzc
real :: xtzd
real :: xtze
real :: xtzf
real :: xtzg
real :: xtzh
real :: xtzi
real :: xtzj
real :: xtzk
real :: xtzl
real :: xtzm
real :: xtzn
real :: xtzo
real :: xtzp
real :: xtzq
real :: xtzr
real :: xtzs
real :: xtzt
real :: xtzu
real :: xtzv
real :: xtzw
real :: xtzx
real :: xtzy
real :: xtzz
real :: xtzza
real :: xtzzb
real :: xtzzc
real :: xtzzd
real :: xtzze
real :: xtzzf
real :: xtzzg
real :: xtzzh
real :: xtzzi
real :: xtzzj
real :: xtzzk
real :: xtzzl
real :: xtzzm
real :: xtzzn
real :: xtzzo
real :: xtzzp
real :: xtzzq
real :: xtzzr
real :: xtzzs
real :: xtzzt

!----------------------------------------------
! RESET LOCAL ADJOINT VARIABLES
!----------------------------------------------
adal(:,:) = 0.
adbl(:,:) = 0.
adbr(:,:) = 0.
adc1 = 0.
addl = 0.
addq(:,:) = 0.
addr = 0.
adlac = 0.
adpmp = 0.
adqe = 0.
adxt = 0.

!----------------------------------------------
! ROUTINE BODY
!----------------------------------------------
if (jord .le. 4) then
  if (uniform_ppm) then
    do j = jfirst-2, jlast+2
      do i = ifirst, ilast
        xt = 0.25*(q(i,j+1)-q(i,j-1))
        dm(i,j) = sign(min(abs(xt),max(q(i,j-1),q(i,j),q(i,j+1))-q(i,j),q(i,j)-min(q(i,j-1),q(i,j),q(i,j+1))),xt)
      end do
    end do
  else
    do j = jfirst-3, jlast+2
      do i = ifirst, ilast
        dq(i,j) = q(i,j+1)-q(i,j)
      end do
    end do
    do j = jfirst-2, jlast+2
      do i = ifirst, ilast
        xt = cy1(i,j)*dq(i,j-1)+cy2(i,j)*dq(i,j)
        dm(i,j) = sign(min(abs(xt),abs(dq(i,j-1)),abs(dq(i,j))),xt)
      end do
    end do
  endif
  do j = jfirst-1, jlast+2
    do i = ifirst, ilast
      al(i,j) = 0.5*(q(i,j-1)+q(i,j))+r3*(dm(i,j-1)-dm(i,j))
    end do
  end do
  do j = jfirst, jlast+1
    addl = 0.
    addr = 0.
    adxt = 0.
    do i = ifirst, ilast
      addl = 0.
      addr = 0.
      adxt = 0.
      if (c(i,j) .gt. 0.) then
        xt = 2.*dm(i,j-1)
        dl = sign(min(abs(xt),abs(al(i,j-1)-q(i,j-1))),xt)
        dr = sign(min(abs(xt),abs(al(i,j)-q(i,j-1))),xt)
        adc(i,j) = adc(i,j)+adflux(i,j)*((1.-c(i,j))*(dl-dr)-(c(i,j)*(dl-dr)+dr))
        addl = addl+adflux(i,j)*(1.-c(i,j))*c(i,j)
        addr = addr+adflux(i,j)*(1.-c(i,j))*(1+(-c(i,j)))
        adq(i,j-1) = adq(i,j-1)+adflux(i,j)
        adflux(i,j) = 0.
        drj = al(i,j)-q(i,j-1)
        addrk = addr*sign(1.,min(abs(xt),abs(drj)))*sign(1.,xt)
        addrl = addrk*(0.5-sign(0.5,abs(drj)-abs(xt)))*sign(1.,drj)
        adxt = adxt+addrk*(0.5+sign(0.5,abs(drj)-abs(xt)))*sign(1.,xt)
        adal(i,j) = adal(i,j)+addrl
        adq(i,j-1) = adq(i,j-1)-addrl
        addr = 0.
        dlj = al(i,j-1)-q(i,j-1)
        addlk = addl*sign(1.,min(abs(xt),abs(dlj)))*sign(1.,xt)
        addll = addlk*(0.5-sign(0.5,abs(dlj)-abs(xt)))*sign(1.,dlj)
        adxt = adxt+addlk*(0.5+sign(0.5,abs(dlj)-abs(xt)))*sign(1.,xt)
        adal(i,j-1) = adal(i,j-1)+addll
        adq(i,j-1) = adq(i,j-1)-addll
        addl = 0.
        addm(i,j-1) = addm(i,j-1)+2*adxt
        adxt = 0.
      else
        xt = 2.*dm(i,j)
        dl = sign(min(abs(xt),abs(al(i,j)-q(i,j))),xt)
        dr = sign(min(abs(xt),abs(al(i,j+1)-q(i,j))),xt)
        adc(i,j) = adc(i,j)-adflux(i,j)*((1.+2*c(i,j))*(dl-dr)+dl)
        addl = addl-adflux(i,j)*(1.+c(i,j))*(1+c(i,j))
        addr = addr+adflux(i,j)*(1.+c(i,j))*c(i,j)
        adq(i,j) = adq(i,j)+adflux(i,j)
        adflux(i,j) = 0.
        dri = al(i,j+1)-q(i,j)
        addri = addr*sign(1.,min(abs(xt),abs(dri)))*sign(1.,xt)
        addrj = addri*(0.5-sign(0.5,abs(dri)-abs(xt)))*sign(1.,dri)
        adxt = adxt+addri*(0.5+sign(0.5,abs(dri)-abs(xt)))*sign(1.,xt)
        adal(i,j+1) = adal(i,j+1)+addrj
        adq(i,j) = adq(i,j)-addrj
        addr = 0.
        dli = al(i,j)-q(i,j)
        addli = addl*sign(1.,min(abs(xt),abs(dli)))*sign(1.,xt)
        addlj = addli*(0.5-sign(0.5,abs(dli)-abs(xt)))*sign(1.,dli)
        adxt = adxt+addli*(0.5+sign(0.5,abs(dli)-abs(xt)))*sign(1.,xt)
        adal(i,j) = adal(i,j)+addlj
        adq(i,j) = adq(i,j)-addlj
        addl = 0.
        addm(i,j) = addm(i,j)+2*adxt
        adxt = 0.
      endif
    end do
  end do
  do j = jfirst-1, jlast+2
    do i = ifirst, ilast
      addm(i,j-1) = addm(i,j-1)+adal(i,j)*r3
      addm(i,j) = addm(i,j)-adal(i,j)*r3
      adq(i,j-1) = adq(i,j-1)+0.5*adal(i,j)
      adq(i,j) = adq(i,j)+0.5*adal(i,j)
      adal(i,j) = 0.
    end do
  end do
  if (uniform_ppm) then
    do j = jfirst-2, jlast+2
      adxt = 0.
      do i = ifirst, ilast
        adxt = 0.
        xt = 0.25*(q(i,j+1)-q(i,j-1))
        dmzl = abs(xt)
        dmzm = max(q(i,j-1),q(i,j))
        dmzo = max(dmzm,q(i,j+1))-q(i,j)
        dmzp = min(q(i,j-1),q(i,j))
        dmzr = q(i,j)-min(dmzp,q(i,j+1))
        dmzs = min(dmzl,dmzo)
        addmzzc = addm(i,j)*sign(1.,min(dmzs,dmzr))*sign(1.,xt)
        addmzza = addmzzc*(0.5-sign(0.5,dmzr-dmzs))
        addmzzb = addmzzc*(0.5+sign(0.5,dmzr-dmzs))
        addmzu = addmzzb*(0.5+sign(0.5,dmzo-dmzl))
        addmzx = addmzzb*(0.5-sign(0.5,dmzo-dmzl))
        addmzz = -addmzza
        adq(i,j) = adq(i,j)+addmzza
        addmzy = addmzz*(0.5+sign(0.5,q(i,j+1)-dmzp))
        adq(i,j+1) = adq(i,j+1)+addmzz*(0.5-sign(0.5,q(i,j+1)-dmzp))
        adq(i,j-1) = adq(i,j-1)+addmzy*(0.5+sign(0.5,q(i,j)-q(i,j-1)))
        adq(i,j) = adq(i,j)+addmzy*(0.5-sign(0.5,q(i,j)-q(i,j-1)))
        adq(i,j) = adq(i,j)-addmzx
        addmzv = addmzx*(0.5+sign(0.5,dmzm-q(i,j+1)))
        adq(i,j+1) = adq(i,j+1)+addmzx*(0.5-sign(0.5,dmzm-q(i,j+1)))
        adq(i,j-1) = adq(i,j-1)+addmzv*(0.5+sign(0.5,q(i,j-1)-q(i,j)))
        adq(i,j) = adq(i,j)+addmzv*(0.5-sign(0.5,q(i,j-1)-q(i,j)))
        adxt = adxt+addmzu*sign(1.,xt)
        addm(i,j) = 0.
        adq(i,j-1) = adq(i,j-1)-0.25*adxt
        adq(i,j+1) = adq(i,j+1)+0.25*adxt
        adxt = 0.
      end do
    end do
  else
    do j = jfirst-2, jlast+2
      adxt = 0.
      do i = ifirst, ilast
        adxt = 0.
        xt = cy1(i,j)*dq(i,j-1)+cy2(i,j)*dq(i,j)
        dmzd = abs(xt)
        dmzg = abs(dq(i,j-1))
        dmzj = abs(dq(i,j))
        dmzk = min(dmzd,dmzg)
        addmzt = addm(i,j)*sign(1.,min(dmzk,dmzj))*sign(1.,xt)
        addmzr = addmzt*(0.5-sign(0.5,dmzj-dmzk))
        addmzs = addmzt*(0.5+sign(0.5,dmzj-dmzk))
        addmzj = addmzs*(0.5+sign(0.5,dmzg-dmzd))
        addmzq = addmzs*(0.5-sign(0.5,dmzg-dmzd))
        addq(i,j) = addq(i,j)+addmzr*sign(1.,dq(i,j))
        addq(i,j-1) = addq(i,j-1)+addmzq*sign(1.,dq(i,j-1))
        adxt = adxt+addmzj*sign(1.,xt)
        addm(i,j) = 0.
        addq(i,j-1) = addq(i,j-1)+adxt*cy1(i,j)
        addq(i,j) = addq(i,j)+adxt*cy2(i,j)
        adxt = 0.
      end do
    end do
    do j = jfirst-3, jlast+2
      do i = ifirst, ilast
        adq(i,j+1) = adq(i,j+1)+addq(i,j)
        adq(i,j) = adq(i,j)-addq(i,j)
        addq(i,j) = 0.
      end do
    end do
  endif
else if (jord .eq. 5) then
  do j = jfirst-3, jlast+2
    do i = ifirst, ilast
      dq(i,j) = q(i,j+1)-q(i,j)
    end do
  end do
  if (uniform_ppm) then
    do j = jfirst-2, jlast+2
      do i = ifirst, ilast
        xt = 0.25*(q(i,j+1)-q(i,j-1))
        dm(i,j) = sign(min(abs(xt),max(q(i,j-1),q(i,j),q(i,j+1))-q(i,j),q(i,j)-min(q(i,j-1),q(i,j),q(i,j+1))),xt)
      end do
    end do
  else
    do j = jfirst-2, jlast+2
      do i = ifirst, ilast
        xt = cy1(i,j)*dq(i,j-1)+cy2(i,j)*dq(i,j)
        dm(i,j) = sign(min(abs(xt),abs(dq(i,j-1)),abs(dq(i,j))),xt)
      end do
    end do
  endif
  do j = jfirst-1, jlast+2
    do i = ifirst, ilast
      al(i,j) = 0.5*(q(i,j-1)+q(i,j))+r3*(dm(i,j-1)-dm(i,j))
    end do
  end do
  do j = jfirst-1, jlast+1
    do i = ifirst, ilast
      pmp = -(2.*dq(i,j))
      lac = pmp+1.5*dq(i,j+1)
      bl(i,j) = min(max(0.,pmp,lac),max(al(i,j)-q(i,j),min(0.,pmp,lac)))
      pmp = 2.*dq(i,j-1)
      lac = pmp-1.5*dq(i,j-2)
      br(i,j) = min(max(0.,pmp,lac),max(al(i,j+1)-q(i,j),min(0.,pmp,lac)))
    end do
  end do
  do j = jfirst, jlast+1
    do i = ifirst, ilast
      if (c(i,j) .gt. 0.) then
        adbl(i,j-1) = adbl(i,j-1)-adflux(i,j)*(1.-c(i,j))*c(i,j)
        adbr(i,j-1) = adbr(i,j-1)+adflux(i,j)*(1.-c(i,j))*(1-c(i,j))
        adc(i,j) = adc(i,j)+adflux(i,j)*((-((1.-c(i,j))*(bl(i,j-1)+br(i,j-1))))-(br(i,j-1)-c(i,j)*(bl(i,j-1)+br(i,j-1))))
        adq(i,j-1) = adq(i,j-1)+adflux(i,j)
        adflux(i,j) = 0.
      else
        adbl(i,j) = adbl(i,j)+adflux(i,j)*(1.+c(i,j))*(1+c(i,j))
        adbr(i,j) = adbr(i,j)+adflux(i,j)*(1.+c(i,j))*c(i,j)
        adc(i,j) = adc(i,j)+adflux(i,j)*((1.+c(i,j))*(bl(i,j)+br(i,j))+bl(i,j)+c(i,j)*(bl(i,j)+br(i,j)))
        adq(i,j) = adq(i,j)+adflux(i,j)
        adflux(i,j) = 0.
      endif
    end do
  end do
  do j = jfirst-1, jlast+1
    adlac = 0.
    adpmp = 0.
    do i = ifirst, ilast
      adlac = 0.
      adpmp = 0.
      pmp = 2.*dq(i,j-1)
      lac = pmp-1.5*dq(i,j-2)
      brzi = max(0.,pmp)
      brzj = max(brzi,lac)
      brzl = min(0.,pmp)
      brzm = min(brzl,lac)
      brzk = max(al(i,j+1)-q(i,j),brzm)
      adbrzl = adbr(i,j)*(0.5+sign(0.5,brzk-brzj))
      adbrzm = adbr(i,j)*(0.5-sign(0.5,brzk-brzj))
      adal(i,j+1) = adal(i,j+1)+adbrzm*(0.5+sign(0.5,al(i,j+1)-q(i,j)-brzm))
      adbrzo = adbrzm*(0.5-sign(0.5,al(i,j+1)-q(i,j)-brzm))
      adq(i,j) = adq(i,j)-adbrzm*(0.5+sign(0.5,al(i,j+1)-q(i,j)-brzm))
      adbrzn = adbrzo*(0.5+sign(0.5,lac-brzl))
      adlac = adlac+adbrzo*(0.5-sign(0.5,lac-brzl))
      adpmp = adpmp+adbrzn*(0.5-sign(0.5,pmp-0.))
      adbrzk = adbrzl*(0.5+sign(0.5,brzi-lac))
      adlac = adlac+adbrzl*(0.5-sign(0.5,brzi-lac))
      adpmp = adpmp+adbrzk*(0.5-sign(0.5,0.-pmp))
      adbr(i,j) = 0.
      addq(i,j-2) = addq(i,j-2)-1.5*adlac
      adpmp = adpmp+adlac
      adlac = 0.
      addq(i,j-1) = addq(i,j-1)+2*adpmp
      adpmp = 0.
      pmp = -(2.*dq(i,j))
      lac = pmp+1.5*dq(i,j+1)
      blzi = max(0.,pmp)
      blzj = max(blzi,lac)
      blzl = min(0.,pmp)
      blzm = min(blzl,lac)
      blzk = max(al(i,j)-q(i,j),blzm)
      adblzl = adbl(i,j)*(0.5+sign(0.5,blzk-blzj))
      adblzm = adbl(i,j)*(0.5-sign(0.5,blzk-blzj))
      adal(i,j) = adal(i,j)+adblzm*(0.5+sign(0.5,al(i,j)-q(i,j)-blzm))
      adblzo = adblzm*(0.5-sign(0.5,al(i,j)-q(i,j)-blzm))
      adq(i,j) = adq(i,j)-adblzm*(0.5+sign(0.5,al(i,j)-q(i,j)-blzm))
      adblzn = adblzo*(0.5+sign(0.5,lac-blzl))
      adlac = adlac+adblzo*(0.5-sign(0.5,lac-blzl))
      adpmp = adpmp+adblzn*(0.5-sign(0.5,pmp-0.))
      adblzk = adblzl*(0.5+sign(0.5,blzi-lac))
      adlac = adlac+adblzl*(0.5-sign(0.5,blzi-lac))
      adpmp = adpmp+adblzk*(0.5-sign(0.5,0.-pmp))
      adbl(i,j) = 0.
      addq(i,j+1) = addq(i,j+1)+1.5*adlac
      adpmp = adpmp+adlac
      adlac = 0.
      addq(i,j) = addq(i,j)-2*adpmp
      adpmp = 0.
    end do
  end do
  do j = jfirst-1, jlast+2
    do i = ifirst, ilast
      addm(i,j-1) = addm(i,j-1)+adal(i,j)*r3
      addm(i,j) = addm(i,j)-adal(i,j)*r3
      adq(i,j-1) = adq(i,j-1)+0.5*adal(i,j)
      adq(i,j) = adq(i,j)+0.5*adal(i,j)
      adal(i,j) = 0.
    end do
  end do
  if (uniform_ppm) then
    do j = jfirst-2, jlast+2
      adxt = 0.
      do i = ifirst, ilast
        adxt = 0.
        xt = 0.25*(q(i,j+1)-q(i,j-1))
        dmzb = abs(xt)
        dmzc = max(q(i,j-1),q(i,j))
        dmze = max(dmzc,q(i,j+1))-q(i,j)
        dmzf = min(q(i,j-1),q(i,j))
        dmzh = q(i,j)-min(dmzf,q(i,j+1))
        dmzi = min(dmzb,dmze)
        addmzp = addm(i,j)*sign(1.,min(dmzi,dmzh))*sign(1.,xt)
        addmzn = addmzp*(0.5-sign(0.5,dmzh-dmzi))
        addmzo = addmzp*(0.5+sign(0.5,dmzh-dmzi))
        addmzh = addmzo*(0.5+sign(0.5,dmze-dmzb))
        addmzk = addmzo*(0.5-sign(0.5,dmze-dmzb))
        addmzm = -addmzn
        adq(i,j) = adq(i,j)+addmzn
        addmzl = addmzm*(0.5+sign(0.5,q(i,j+1)-dmzf))
        adq(i,j+1) = adq(i,j+1)+addmzm*(0.5-sign(0.5,q(i,j+1)-dmzf))
        adq(i,j-1) = adq(i,j-1)+addmzl*(0.5+sign(0.5,q(i,j)-q(i,j-1)))
        adq(i,j) = adq(i,j)+addmzl*(0.5-sign(0.5,q(i,j)-q(i,j-1)))
        adq(i,j) = adq(i,j)-addmzk
        addmzi = addmzk*(0.5+sign(0.5,dmzc-q(i,j+1)))
        adq(i,j+1) = adq(i,j+1)+addmzk*(0.5-sign(0.5,dmzc-q(i,j+1)))
        adq(i,j-1) = adq(i,j-1)+addmzi*(0.5+sign(0.5,q(i,j-1)-q(i,j)))
        adq(i,j) = adq(i,j)+addmzi*(0.5-sign(0.5,q(i,j-1)-q(i,j)))
        adxt = adxt+addmzh*sign(1.,xt)
        addm(i,j) = 0.
        adq(i,j-1) = adq(i,j-1)-0.25*adxt
        adq(i,j+1) = adq(i,j+1)+0.25*adxt
        adxt = 0.
      end do
    end do
  else
    do j = jfirst-2, jlast+2
      adxt = 0.
      do i = ifirst, ilast
        adxt = 0.
        xt = cy1(i,j)*dq(i,j-1)+cy2(i,j)*dq(i,j)
        dmt = abs(xt)
        dmw = abs(dq(i,j-1))
        dmz = abs(dq(i,j))
        dmza = min(dmt,dmw)
        addmzg = addm(i,j)*sign(1.,min(dmza,dmz))*sign(1.,xt)
        addmze = addmzg*(0.5-sign(0.5,dmz-dmza))
        addmzf = addmzg*(0.5+sign(0.5,dmz-dmza))
        addmw = addmzf*(0.5+sign(0.5,dmw-dmt))
        addmzd = addmzf*(0.5-sign(0.5,dmw-dmt))
        addq(i,j) = addq(i,j)+addmze*sign(1.,dq(i,j))
        addq(i,j-1) = addq(i,j-1)+addmzd*sign(1.,dq(i,j-1))
        adxt = adxt+addmw*sign(1.,xt)
        addm(i,j) = 0.
        addq(i,j-1) = addq(i,j-1)+adxt*cy1(i,j)
        addq(i,j) = addq(i,j)+adxt*cy2(i,j)
        adxt = 0.
      end do
    end do
  endif
  do j = jfirst-3, jlast+2
    do i = ifirst, ilast
      adq(i,j+1) = adq(i,j+1)+addq(i,j)
      adq(i,j) = adq(i,j)-addq(i,j)
      addq(i,j) = 0.
    end do
  end do
else if (jord .eq. 6 .or. jord .eq. 7) then
  do j = jfirst-1, jlast+1
    do i = ifirst, ilast
      xt = b3*q(i,j)
      bl(i,j) = b5*q(i,j-2)+b4*q(i,j-1)+xt+b2*q(i,j+1)+b1*q(i,j+2)
      br(i,j) = b1*q(i,j-2)+b2*q(i,j-1)+xt+b4*q(i,j+1)+b5*q(i,j+2)
    end do
  end do
  if (jord .eq. 7) then
    do j = jfirst-2, jlast+3
      do i = ifirst, ilast
        dq(i,j) = q(i,j)-q(i,j-1)
      end do
    end do
    do j = jfirst-1, jlast+1
      do i = ifirst, ilast
        dl = -sign(min(abs(bl(i,j)),abs(dq(i,j))),dq(i,j))
        pmp = -(2.*dq(i,j+1))
        lac = pmp+1.5*dq(i,j+2)
        bl(i,j) = min(max(0.,pmp,lac),max(dl,min(0.,pmp,lac)))
        dr = sign(min(abs(br(i,j)),abs(dq(i,j+1))),dq(i,j+1))
        pmp = 2.*dq(i,j)
        lac = pmp-1.5*dq(i,j-1)
        br(i,j) = min(max(0.,pmp,lac),max(dr,min(0.,pmp,lac)))
      end do
    end do
  endif
  do j = jfirst, jlast+1
    do i = ifirst, ilast
      if (c(i,j) .gt. 0.) then
        adbl(i,j-1) = adbl(i,j-1)-adflux(i,j)*(1.-c(i,j))*c(i,j)
        adbr(i,j-1) = adbr(i,j-1)+adflux(i,j)*(1.-c(i,j))*(1-c(i,j))
        adc(i,j) = adc(i,j)+adflux(i,j)*((-((1.-c(i,j))*(bl(i,j-1)+br(i,j-1))))-(br(i,j-1)-c(i,j)*(bl(i,j-1)+br(i,j-1))))
        adq(i,j-1) = adq(i,j-1)+adflux(i,j)
        adflux(i,j) = 0.
      else
        adbl(i,j) = adbl(i,j)+adflux(i,j)*(1.+c(i,j))*(1+c(i,j))
        adbr(i,j) = adbr(i,j)+adflux(i,j)*(1.+c(i,j))*c(i,j)
        adc(i,j) = adc(i,j)+adflux(i,j)*((1.+c(i,j))*(bl(i,j)+br(i,j))+bl(i,j)+c(i,j)*(bl(i,j)+br(i,j)))
        adq(i,j) = adq(i,j)+adflux(i,j)
        adflux(i,j) = 0.
      endif
    end do
  end do
  do j = jfirst-1, jlast+1
    do i = ifirst, ilast
      xt = b3*q(i,j)
      bl(i,j) = b5*q(i,j-2)+b4*q(i,j-1)+xt+b2*q(i,j+1)+b1*q(i,j+2)
      br(i,j) = b1*q(i,j-2)+b2*q(i,j-1)+xt+b4*q(i,j+1)+b5*q(i,j+2)
    end do
  end do
  if (jord .eq. 7) then
    do j = jfirst-1, jlast+1
      addl = 0.
      addr = 0.
      adlac = 0.
      adpmp = 0.
      do i = ifirst, ilast
        addl = 0.
        addr = 0.
        adlac = 0.
        adpmp = 0.
        dl = -sign(min(abs(bl(i,j)),abs(dq(i,j))),dq(i,j))
        dr = sign(min(abs(br(i,j)),abs(dq(i,j+1))),dq(i,j+1))
        pmp = 2.*dq(i,j)
        lac = pmp-1.5*dq(i,j-1)
        brzd = max(0.,pmp)
        brze = max(brzd,lac)
        brzg = min(0.,pmp)
        brzh = min(brzg,lac)
        brzf = max(dr,brzh)
        adbrzg = adbr(i,j)*(0.5+sign(0.5,brzf-brze))
        adbrzh = adbr(i,j)*(0.5-sign(0.5,brzf-brze))
        adbrzj = adbrzh*(0.5-sign(0.5,dr-brzh))
        addr = addr+adbrzh*(0.5+sign(0.5,dr-brzh))
        adbrzi = adbrzj*(0.5+sign(0.5,lac-brzg))
        adlac = adlac+adbrzj*(0.5-sign(0.5,lac-brzg))
        adpmp = adpmp+adbrzi*(0.5-sign(0.5,pmp-0.))
        adbrzf = adbrzg*(0.5+sign(0.5,brzd-lac))
        adlac = adlac+adbrzg*(0.5-sign(0.5,brzd-lac))
        adpmp = adpmp+adbrzf*(0.5-sign(0.5,0.-pmp))
        adbr(i,j) = 0.
        addq(i,j-1) = addq(i,j-1)-1.5*adlac
        adpmp = adpmp+adlac
        adlac = 0.
        addq(i,j) = addq(i,j)+2*adpmp
        adpmp = 0.
        addrh = addr*sign(1.,min(abs(br(i,j)),abs(dq(i,j+1))))*sign(1.,dq(i,j+1))
        adbr(i,j) = adbr(i,j)+addrh*(0.5+sign(0.5,abs(dq(i,j+1))-abs(br(i,j))))*sign(1.,br(i,j))
        addq(i,j+1) = addq(i,j+1)+addrh*(0.5-sign(0.5,abs(dq(i,j+1))-abs(br(i,j))))*sign(1.,dq(i,j+1))
        addr = 0.
        pmp = -(2.*dq(i,j+1))
        lac = pmp+1.5*dq(i,j+2)
        blzd = max(0.,pmp)
        blze = max(blzd,lac)
        blzg = min(0.,pmp)
        blzh = min(blzg,lac)
        blzf = max(dl,blzh)
        adblzg = adbl(i,j)*(0.5+sign(0.5,blzf-blze))
        adblzh = adbl(i,j)*(0.5-sign(0.5,blzf-blze))
        adblzj = adblzh*(0.5-sign(0.5,dl-blzh))
        addl = addl+adblzh*(0.5+sign(0.5,dl-blzh))
        adblzi = adblzj*(0.5+sign(0.5,lac-blzg))
        adlac = adlac+adblzj*(0.5-sign(0.5,lac-blzg))
        adpmp = adpmp+adblzi*(0.5-sign(0.5,pmp-0.))
        adblzf = adblzg*(0.5+sign(0.5,blzd-lac))
        adlac = adlac+adblzg*(0.5-sign(0.5,blzd-lac))
        adpmp = adpmp+adblzf*(0.5-sign(0.5,0.-pmp))
        adbl(i,j) = 0.
        addq(i,j+2) = addq(i,j+2)+1.5*adlac
        adpmp = adpmp+adlac
        adlac = 0.
        addq(i,j+1) = addq(i,j+1)-2*adpmp
        adpmp = 0.
        addlh = -(addl*sign(1.,min(abs(bl(i,j)),abs(dq(i,j))))*sign(1.,dq(i,j)))
        adbl(i,j) = adbl(i,j)+addlh*(0.5+sign(0.5,abs(dq(i,j))-abs(bl(i,j))))*sign(1.,bl(i,j))
        addq(i,j) = addq(i,j)+addlh*(0.5-sign(0.5,abs(dq(i,j))-abs(bl(i,j))))*sign(1.,dq(i,j))
        addl = 0.
      end do
    end do
    do j = jfirst-2, jlast+3
      do i = ifirst, ilast
        adq(i,j-1) = adq(i,j-1)-addq(i,j)
        adq(i,j) = adq(i,j)+addq(i,j)
        addq(i,j) = 0.
      end do
    end do
  endif
  do j = jfirst-1, jlast+1
    adxt = 0.
    do i = ifirst, ilast
      adxt = 0.
      adq(i,j-2) = adq(i,j-2)+adbr(i,j)*b1
      adq(i,j-1) = adq(i,j-1)+adbr(i,j)*b2
      adq(i,j+2) = adq(i,j+2)+adbr(i,j)*b5
      adq(i,j+1) = adq(i,j+1)+adbr(i,j)*b4
      adxt = adxt+adbr(i,j)
      adbr(i,j) = 0.
      adq(i,j-2) = adq(i,j-2)+adbl(i,j)*b5
      adq(i,j-1) = adq(i,j-1)+adbl(i,j)*b4
      adq(i,j+2) = adq(i,j+2)+adbl(i,j)*b1
      adq(i,j+1) = adq(i,j+1)+adbl(i,j)*b2
      adxt = adxt+adbl(i,j)
      adbl(i,j) = 0.
      adq(i,j) = adq(i,j)+adxt*b3
      adxt = 0.
    end do
  end do
else if (jord .eq. 9 .or. jord .eq. 10) then
  do j = js-3, je+2
    do i = ifirst, ilast
      dq(i,j) = q(i,j+1)-q(i,j)
    end do
  end do
  if (uniform_ppm) then
    do j = js-2, je+2
      do i = ifirst, ilast
        xt = 0.25*(q(i,j+1)-q(i,j-1))
        dm(i,j) = sign(min(abs(xt),max(q(i,j-1),q(i,j),q(i,j+1))-q(i,j),q(i,j)-min(q(i,j-1),q(i,j),q(i,j+1))),xt)
      end do
    end do
  else
    do j = js-2, je+2
      do i = ifirst, ilast
        xt = cy1(i,j)*dq(i,j-1)+cy2(i,j)*dq(i,j)
        dm(i,j) = sign(min(abs(xt),abs(dq(i,j-1)),abs(dq(i,j))),xt)
      end do
    end do
  endif
  if (grid_type .lt. 3) then
    do j = max(3,js-1), min(npy-2,je+2)
      do i = ifirst, ilast
        al(i,j) = 0.5*(q(i,j-1)+q(i,j))+r3*(dm(i,j-1)-dm(i,j))
      end do
    end do
    do j = max(3,js-1), min(npy-3,je+1)
      do i = ifirst, ilast
        pmp = -(2.*dq(i,j))
        lac = pmp+1.5*dq(i,j+1)
        bl(i,j) = min(max(0.,pmp,lac),max(al(i,j)-q(i,j),min(0.,pmp,lac)))
        pmp = 2.*dq(i,j-1)
        lac = pmp-1.5*dq(i,j-2)
        br(i,j) = min(max(0.,pmp,lac),max(al(i,j+1)-q(i,j),min(0.,pmp,lac)))
      end do
    end do
    if (js .eq. 1) then
      do i = ifirst, ilast
        br(i,2) = al(i,3)-q(i,2)
        xt = 0.5*((2.*dya(i,1)+dya(i,2))*(q(i,0)+q(i,1))-dya(i,1)*(q(i,-1)+q(i,2)))/(dya(i,1)+dya(i,2))
        if (edge_mono_kim) then
          if (i .gt. (-2) .and. i .lt. 1 .or. i .gt. npx-3 .and. i .lt. npx) then
            xt = min(xt,max(q(i,0),q(i,1),q(i-1,0),q(i-1,1)))
            xt = max(xt,min(q(i,0),q(i,1),q(i-1,0),q(i-1,1)))
          else if (i .lt. 3 .and. i .gt. 0 .or. i .gt. npx-1 .and. i .lt. npx+2) then
            xt = min(xt,max(q(i,0),q(i,1),q(i+1,0),q(i+1,1)))
            xt = max(xt,min(q(i,0),q(i,1),q(i+1,0),q(i+1,1)))
          endif
        endif
        bl(i,1) = xt-q(i,1)
        br(i,0) = xt-q(i,0)
        xt = 4./7.*dm(i,-1)-11./14.*dq(i,-1)+q(i,0)
        if (s_mono_kim) then
          xt = min(xt,max(q(i,-1),q(i,0)))
          xt = max(xt,min(q(i,-1),q(i,0)))
        endif
        bl(i,0) = xt-q(i,0)
        xt = 3./14.*q(i,1)+11./14.*q(i,2)-4./7.*dm(i,2)
        if (s_mono_kim) then
          xt = min(xt,max(q(i,1),q(i,2)))
          xt = max(xt,min(q(i,1),q(i,2)))
        endif
        br(i,1) = xt-q(i,1)
        bl(i,2) = xt-q(i,2)
      end do
      if (jord .eq. 9) then
        do j = 0, 2
          help_h = ilast-ifirst+1
          call pert_ppm( help_h,q(ifirst,j),bl(ifirst,j),br(ifirst,j),1 )
        end do
      endif
    endif
    if (je+1 .eq. npy) then
      do i = ifirst, ilast
        bl(i,npy-2) = al(i,npy-2)-q(i,npy-2)
        xt = 0.5*((2.*dya(i,npy-1)+dya(i,npy-2))*(q(i,npy-1)+q(i,npy))-dya(i,npy-1)*(q(i,npy-2)+q(i,npy+1)))/(dya(i,npy-1)+dya(i,&
&npy-2))
        if (edge_mono_kim) then
          if (i .gt. (-2) .and. i .lt. 1 .or. i .gt. npx-3 .and. i .lt. npx) then
            xt = min(xt,max(q(i,npy-1),q(i,npy),q(i-1,npy-1),q(i-1,npy)))
            xt = max(xt,min(q(i,npy-1),q(i,npy),q(i-1,npy-1),q(i-1,npy)))
          else if (i .lt. 3 .and. i .gt. 0 .or. i .gt. npx-1 .and. i .lt. npx+2) then
            xt = min(xt,max(q(i,npy-1),q(i,npy),q(i+1,npy-1),q(i+1,npy)))
            xt = max(xt,min(q(i,npy-1),q(i,npy),q(i+1,npy-1),q(i+1,npy)))
          endif
        endif
        br(i,npy-1) = xt-q(i,npy-1)
        bl(i,npy) = xt-q(i,npy)
        xt = 11./14.*dq(i,npy)-4./7.*dm(i,npy+1)+q(i,npy)
        if (s_mono_kim) then
          xt = min(xt,max(q(i,npy),q(i,npy+1)))
          xt = max(xt,min(q(i,npy),q(i,npy+1)))
        endif
        br(i,npy) = xt-q(i,npy)
        xt = 3./14.*q(i,npy-1)+11./14.*q(i,npy-2)+4./7.*dm(i,npy-2)
        if (s_mono_kim) then
          xt = min(xt,max(q(i,npy-2),q(i,npy-1)))
          xt = max(xt,min(q(i,npy-2),q(i,npy-1)))
        endif
        br(i,npy-2) = xt-q(i,npy-2)
        bl(i,npy-1) = xt-q(i,npy-1)
      end do
      if (jord .eq. 9) then
        do j = npy-2, npy
          help_i = ilast-ifirst+1
          call pert_ppm( help_i,q(ifirst,j),bl(ifirst,j),br(ifirst,j),1 )
        end do
      endif
    endif
  else
    do j = js-1, je+2
      do i = ifirst, ilast
        al(i,j) = 0.5*(q(i,j-1)+q(i,j))+r3*(dm(i,j-1)-dm(i,j))
      end do
    end do
    do j = js-1, je+1
      do i = ifirst, ilast
        pmp = -(2.*dq(i,j))
        lac = pmp+1.5*dq(i,j+1)
        bl(i,j) = min(max(0.,pmp,lac),max(al(i,j)-q(i,j),min(0.,pmp,lac)))
        pmp = 2.*dq(i,j-1)
        lac = pmp-1.5*dq(i,j-2)
        br(i,j) = min(max(0.,pmp,lac),max(al(i,j+1)-q(i,j),min(0.,pmp,lac)))
      end do
    end do
  endif
  do j = js, je+1
    adc1 = 0.
    adqe = 0.
    do i = ifirst, ilast
      adc1 = 0.
      adqe = 0.
      if (intel_opt_kim) then
        c1 = c(i,j)
        if (c1 .gt. 0.) then
          jt = j-1
          qe = br(i,j-1)
        else
          jt = j
          qe = bl(i,j)
        endif
        c1 = -abs(c1)
        adbl(i,jt) = adbl(i,jt)+adflux(i,j)*(1.+c1)*c1
        adbr(i,jt) = adbr(i,jt)+adflux(i,j)*(1.+c1)*c1
        adc1 = adc1+adflux(i,j)*((1.+c1)*(bl(i,jt)+br(i,jt))+qe+c1*(bl(i,jt)+br(i,jt)))
        adq(i,jt) = adq(i,jt)+adflux(i,j)
        adqe = adqe+adflux(i,j)*(1+c1)
        adflux(i,j) = 0.
        c1 = c(i,j)
        adc1 = -(adc1*sign(1.,c1))
        c1 = c(i,j)
        if (c1 .gt. 0.) then
          adbr(i,j-1) = adbr(i,j-1)+adqe
          adqe = 0.
        else
          adbl(i,j) = adbl(i,j)+adqe
          adqe = 0.
        endif
        adc(i,j) = adc(i,j)+adc1
        adc1 = 0.
      else
        if (c(i,j) .gt. 0.) then
          adbl(i,j-1) = adbl(i,j-1)-adflux(i,j)*(1.-c(i,j))*c(i,j)
          adbr(i,j-1) = adbr(i,j-1)+adflux(i,j)*(1.-c(i,j))*(1-c(i,j))
          adc(i,j) = adc(i,j)+adflux(i,j)*((-((1.-c(i,j))*(bl(i,j-1)+br(i,j-1))))-(br(i,j-1)-c(i,j)*(bl(i,j-1)+br(i,j-1))))
          adq(i,j-1) = adq(i,j-1)+adflux(i,j)
          adflux(i,j) = 0.
        else
          adbl(i,j) = adbl(i,j)+adflux(i,j)*(1.+c(i,j))*(1+c(i,j))
          adbr(i,j) = adbr(i,j)+adflux(i,j)*(1.+c(i,j))*c(i,j)
          adc(i,j) = adc(i,j)+adflux(i,j)*((1.+c(i,j))*(bl(i,j)+br(i,j))+bl(i,j)+c(i,j)*(bl(i,j)+br(i,j)))
          adq(i,j) = adq(i,j)+adflux(i,j)
          adflux(i,j) = 0.
        endif
      endif
    end do
  end do
  if (grid_type .lt. 3) then
    do j = max(3,js-1), min(npy-3,je+1)
      do i = ifirst, ilast
        pmp = -(2.*dq(i,j))
        lac = pmp+1.5*dq(i,j+1)
        bl(i,j) = min(max(0.,pmp,lac),max(al(i,j)-q(i,j),min(0.,pmp,lac)))
        pmp = 2.*dq(i,j-1)
        lac = pmp-1.5*dq(i,j-2)
        br(i,j) = min(max(0.,pmp,lac),max(al(i,j+1)-q(i,j),min(0.,pmp,lac)))
      end do
    end do
    if (js .eq. 1) then
      do i = ifirst, ilast
        br(i,2) = al(i,3)-q(i,2)
        xt = 0.5*((2.*dya(i,1)+dya(i,2))*(q(i,0)+q(i,1))-dya(i,1)*(q(i,-1)+q(i,2)))/(dya(i,1)+dya(i,2))
        if (edge_mono_kim) then
          if (i .gt. (-2) .and. i .lt. 1 .or. i .gt. npx-3 .and. i .lt. npx) then
            xt = min(xt,max(q(i,0),q(i,1),q(i-1,0),q(i-1,1)))
            xt = max(xt,min(q(i,0),q(i,1),q(i-1,0),q(i-1,1)))
          else if (i .lt. 3 .and. i .gt. 0 .or. i .gt. npx-1 .and. i .lt. npx+2) then
            xt = min(xt,max(q(i,0),q(i,1),q(i+1,0),q(i+1,1)))
            xt = max(xt,min(q(i,0),q(i,1),q(i+1,0),q(i+1,1)))
          endif
        endif
        bl(i,1) = xt-q(i,1)
        br(i,0) = xt-q(i,0)
        xt = 4./7.*dm(i,-1)-11./14.*dq(i,-1)+q(i,0)
        if (s_mono_kim) then
          xt = min(xt,max(q(i,-1),q(i,0)))
          xt = max(xt,min(q(i,-1),q(i,0)))
        endif
        bl(i,0) = xt-q(i,0)
        xt = 3./14.*q(i,1)+11./14.*q(i,2)-4./7.*dm(i,2)
        if (s_mono_kim) then
          xt = min(xt,max(q(i,1),q(i,2)))
          xt = max(xt,min(q(i,1),q(i,2)))
        endif
        br(i,1) = xt-q(i,1)
        bl(i,2) = xt-q(i,2)
      end do
      if (jord .eq. 9) then
        do j = 0, 2
          help_h = ilast-ifirst+1
          call pert_ppm( help_h,q(ifirst,j),bl(ifirst,j),br(ifirst,j),1 )
        end do
      endif
    endif
    if (je+1 .eq. npy) then
      do i = ifirst, ilast
        bl(i,npy-2) = al(i,npy-2)-q(i,npy-2)
        xt = 0.5*((2.*dya(i,npy-1)+dya(i,npy-2))*(q(i,npy-1)+q(i,npy))-dya(i,npy-1)*(q(i,npy-2)+q(i,npy+1)))/(dya(i,npy-1)+dya(i,&
&npy-2))
        if (edge_mono_kim) then
          if (i .gt. (-2) .and. i .lt. 1 .or. i .gt. npx-3 .and. i .lt. npx) then
            xt = min(xt,max(q(i,npy-1),q(i,npy),q(i-1,npy-1),q(i-1,npy)))
            xt = max(xt,min(q(i,npy-1),q(i,npy),q(i-1,npy-1),q(i-1,npy)))
          else if (i .lt. 3 .and. i .gt. 0 .or. i .gt. npx-1 .and. i .lt. npx+2) then
            xt = min(xt,max(q(i,npy-1),q(i,npy),q(i+1,npy-1),q(i+1,npy)))
            xt = max(xt,min(q(i,npy-1),q(i,npy),q(i+1,npy-1),q(i+1,npy)))
          endif
        endif
        br(i,npy-1) = xt-q(i,npy-1)
        bl(i,npy) = xt-q(i,npy)
        xt = 11./14.*dq(i,npy)-4./7.*dm(i,npy+1)+q(i,npy)
        if (s_mono_kim) then
          xt = min(xt,max(q(i,npy),q(i,npy+1)))
          xt = max(xt,min(q(i,npy),q(i,npy+1)))
        endif
        br(i,npy) = xt-q(i,npy)
        xt = 3./14.*q(i,npy-1)+11./14.*q(i,npy-2)+4./7.*dm(i,npy-2)
        if (s_mono_kim) then
          xt = min(xt,max(q(i,npy-2),q(i,npy-1)))
          xt = max(xt,min(q(i,npy-2),q(i,npy-1)))
        endif
        br(i,npy-2) = xt-q(i,npy-2)
        bl(i,npy-1) = xt-q(i,npy-1)
      end do
      if (jord .eq. 9) then
        do j = npy, npy-2, -1
          do i = ifirst, ilast
            bl(i,npy-2) = al(i,npy-2)-q(i,npy-2)
            xt = 0.5*((2.*dya(i,npy-1)+dya(i,npy-2))*(q(i,npy-1)+q(i,npy))-dya(i,npy-1)*(q(i,npy-2)+q(i,npy+1)))/(dya(i,npy-1)+&
&dya(i,npy-2))
            if (edge_mono_kim) then
              if (i .gt. (-2) .and. i .lt. 1 .or. i .gt. npx-3 .and. i .lt. npx) then
xt = min(xt,max(q(i,npy-1),q(i,npy),q(i-1,npy-1),q(i-1,npy)))
xt = max(xt,min(q(i,npy-1),q(i,npy),q(i-1,npy-1),q(i-1,npy)))
              else if (i .lt. 3 .and. i .gt. 0 .or. i .gt. npx-1 .and. i .lt. npx+2) then
xt = min(xt,max(q(i,npy-1),q(i,npy),q(i+1,npy-1),q(i+1,npy)))
xt = max(xt,min(q(i,npy-1),q(i,npy),q(i+1,npy-1),q(i+1,npy)))
              endif
            endif
            br(i,npy-1) = xt-q(i,npy-1)
            bl(i,npy) = xt-q(i,npy)
            xt = 11./14.*dq(i,npy)-4./7.*dm(i,npy+1)+q(i,npy)
            if (s_mono_kim) then
              xt = min(xt,max(q(i,npy),q(i,npy+1)))
              xt = max(xt,min(q(i,npy),q(i,npy+1)))
            endif
            br(i,npy) = xt-q(i,npy)
            xt = 3./14.*q(i,npy-1)+11./14.*q(i,npy-2)+4./7.*dm(i,npy-2)
            if (s_mono_kim) then
              xt = min(xt,max(q(i,npy-2),q(i,npy-1)))
              xt = max(xt,min(q(i,npy-2),q(i,npy-1)))
            endif
            br(i,npy-2) = xt-q(i,npy-2)
            bl(i,npy-1) = xt-q(i,npy-1)
          end do
          do j5 = npy-2, j-1
            help_i = ilast-ifirst+1
            call pert_ppm( help_i,q(ifirst,j5),bl(ifirst,j5),br(ifirst,j5),1 )
          end do
          help_i = ilast-ifirst+1
          call adpert_ppm( help_i,q(ifirst,j),adq(ifirst,j),bl(ifirst,j),adbl(ifirst,j),br(ifirst,j),adbr(ifirst,j),1 )
        end do
      endif
      do i = ifirst, ilast
        adxt = 0.
        xt = 3./14.*q(i,npy-1)+11./14.*q(i,npy-2)+4./7.*dm(i,npy-2)
        adq(i,npy-1) = adq(i,npy-1)-adbl(i,npy-1)
        adxt = adxt+adbl(i,npy-1)
        adbl(i,npy-1) = 0.
        adq(i,npy-2) = adq(i,npy-2)-adbr(i,npy-2)
        adxt = adxt+adbr(i,npy-2)
        adbr(i,npy-2) = 0.
        if (s_mono_kim) then
          xt = min(xt,max(q(i,npy-2),q(i,npy-1)))
          xtzo = min(q(i,npy-2),q(i,npy-1))
          adxtzo = adxt*(0.5-sign(0.5,xt-xtzo))
          adq(i,npy-2) = adq(i,npy-2)+adxtzo*(0.5+sign(0.5,q(i,npy-1)-q(i,npy-2)))
          adq(i,npy-1) = adq(i,npy-1)+adxtzo*(0.5-sign(0.5,q(i,npy-1)-q(i,npy-2)))
          adxt = adxt*(0.5+sign(0.5,xt-xtzo))
          xt = 3./14.*q(i,npy-1)+11./14.*q(i,npy-2)+4./7.*dm(i,npy-2)
          xtzp = max(q(i,npy-2),q(i,npy-1))
          adxtzp = adxt*(0.5-sign(0.5,xtzp-xt))
          adq(i,npy-2) = adq(i,npy-2)+adxtzp*(0.5+sign(0.5,q(i,npy-2)-q(i,npy-1)))
          adq(i,npy-1) = adq(i,npy-1)+adxtzp*(0.5-sign(0.5,q(i,npy-2)-q(i,npy-1)))
          adxt = adxt*(0.5+sign(0.5,xtzp-xt))
        endif
        addm(i,npy-2) = addm(i,npy-2)+0.57142857*adxt
        adq(i,npy-2) = adq(i,npy-2)+0.78571429*adxt
        adq(i,npy-1) = adq(i,npy-1)+0.21428571*adxt
        adxt = 0.
        adq(i,npy) = adq(i,npy)-adbr(i,npy)
        adxt = adxt+adbr(i,npy)
        adbr(i,npy) = 0.
        xt = 11./14.*dq(i,npy)-4./7.*dm(i,npy+1)+q(i,npy)
        if (s_mono_kim) then
          xt = min(xt,max(q(i,npy),q(i,npy+1)))
          xtzq = min(q(i,npy),q(i,npy+1))
          adxtzq = adxt*(0.5-sign(0.5,xt-xtzq))
          adq(i,npy+1) = adq(i,npy+1)+adxtzq*(0.5-sign(0.5,q(i,npy+1)-q(i,npy)))
          adq(i,npy) = adq(i,npy)+adxtzq*(0.5+sign(0.5,q(i,npy+1)-q(i,npy)))
          adxt = adxt*(0.5+sign(0.5,xt-xtzq))
          xt = 11./14.*dq(i,npy)-4./7.*dm(i,npy+1)+q(i,npy)
          xtzr = max(q(i,npy),q(i,npy+1))
          adxtzr = adxt*(0.5-sign(0.5,xtzr-xt))
          adq(i,npy+1) = adq(i,npy+1)+adxtzr*(0.5-sign(0.5,q(i,npy)-q(i,npy+1)))
          adq(i,npy) = adq(i,npy)+adxtzr*(0.5+sign(0.5,q(i,npy)-q(i,npy+1)))
          adxt = adxt*(0.5+sign(0.5,xtzr-xt))
        endif
        addm(i,npy+1) = addm(i,npy+1)-0.57142857*adxt
        addq(i,npy) = addq(i,npy)+0.78571429*adxt
        adq(i,npy) = adq(i,npy)+adxt
        adxt = 0.
        adq(i,npy) = adq(i,npy)-adbl(i,npy)
        adxt = adxt+adbl(i,npy)
        adbl(i,npy) = 0.
        adq(i,npy-1) = adq(i,npy-1)-adbr(i,npy-1)
        adxt = adxt+adbr(i,npy-1)
        adbr(i,npy-1) = 0.
        xt = 0.5*((2.*dya(i,npy-1)+dya(i,npy-2))*(q(i,npy-1)+q(i,npy))-dya(i,npy-1)*(q(i,npy-2)+q(i,npy+1)))/(dya(i,npy-1)+dya(i,&
&npy-2))
        if (edge_mono_kim) then
          if (i .gt. (-2) .and. i .lt. 1 .or. i .gt. npx-3 .and. i .lt. npx) then
            xt = min(xt,max(q(i,npy-1),q(i,npy),q(i-1,npy-1),q(i-1,npy)))
            xtzy = min(q(i,npy-1),q(i,npy))
            xtzz = min(xtzy,q(i-1,npy-1))
            xtzza = min(xtzz,q(i-1,npy))
            adxtzza = adxt*(0.5-sign(0.5,xt-xtzza))
            adq(i-1,npy) = adq(i-1,npy)+adxtzza*(0.5-sign(0.5,q(i-1,npy)-xtzz))
            adxtzz = adxtzza*(0.5+sign(0.5,q(i-1,npy)-xtzz))
            adq(i-1,npy-1) = adq(i-1,npy-1)+adxtzz*(0.5-sign(0.5,q(i-1,npy-1)-xtzy))
            adxtzy = adxtzz*(0.5+sign(0.5,q(i-1,npy-1)-xtzy))
            adq(i,npy-1) = adq(i,npy-1)+adxtzy*(0.5+sign(0.5,q(i,npy)-q(i,npy-1)))
            adq(i,npy) = adq(i,npy)+adxtzy*(0.5-sign(0.5,q(i,npy)-q(i,npy-1)))
            adxt = adxt*(0.5+sign(0.5,xt-xtzza))
            xt = 0.5*((2.*dya(i,npy-1)+dya(i,npy-2))*(q(i,npy-1)+q(i,npy))-dya(i,npy-1)*(q(i,npy-2)+q(i,npy+1)))/(dya(i,npy-1)+&
&dya(i,npy-2))
            xtzzb = max(q(i,npy-1),q(i,npy))
            xtzzc = max(xtzzb,q(i-1,npy-1))
            xtzzd = max(xtzzc,q(i-1,npy))
            adxtzzd = adxt*(0.5-sign(0.5,xtzzd-xt))
            adq(i-1,npy) = adq(i-1,npy)+adxtzzd*(0.5-sign(0.5,xtzzc-q(i-1,npy)))
            adxtzzc = adxtzzd*(0.5+sign(0.5,xtzzc-q(i-1,npy)))
            adq(i-1,npy-1) = adq(i-1,npy-1)+adxtzzc*(0.5-sign(0.5,xtzzb-q(i-1,npy-1)))
            adxtzzb = adxtzzc*(0.5+sign(0.5,xtzzb-q(i-1,npy-1)))
            adq(i,npy-1) = adq(i,npy-1)+adxtzzb*(0.5+sign(0.5,q(i,npy-1)-q(i,npy)))
            adq(i,npy) = adq(i,npy)+adxtzzb*(0.5-sign(0.5,q(i,npy-1)-q(i,npy)))
            adxt = adxt*(0.5+sign(0.5,xtzzd-xt))
          else if (i .lt. 3 .and. i .gt. 0 .or. i .gt. npx-1 .and. i .lt. npx+2) then
            xt = min(xt,max(q(i,npy-1),q(i,npy),q(i+1,npy-1),q(i+1,npy)))
            xtzs = min(q(i,npy-1),q(i,npy))
            xtzt = min(xtzs,q(i+1,npy-1))
            xtzu = min(xtzt,q(i+1,npy))
            adxtzu = adxt*(0.5-sign(0.5,xt-xtzu))
            adq(i+1,npy) = adq(i+1,npy)+adxtzu*(0.5-sign(0.5,q(i+1,npy)-xtzt))
            adxtzt = adxtzu*(0.5+sign(0.5,q(i+1,npy)-xtzt))
            adq(i+1,npy-1) = adq(i+1,npy-1)+adxtzt*(0.5-sign(0.5,q(i+1,npy-1)-xtzs))
            adxtzs = adxtzt*(0.5+sign(0.5,q(i+1,npy-1)-xtzs))
            adq(i,npy-1) = adq(i,npy-1)+adxtzs*(0.5+sign(0.5,q(i,npy)-q(i,npy-1)))
            adq(i,npy) = adq(i,npy)+adxtzs*(0.5-sign(0.5,q(i,npy)-q(i,npy-1)))
            adxt = adxt*(0.5+sign(0.5,xt-xtzu))
            xt = 0.5*((2.*dya(i,npy-1)+dya(i,npy-2))*(q(i,npy-1)+q(i,npy))-dya(i,npy-1)*(q(i,npy-2)+q(i,npy+1)))/(dya(i,npy-1)+&
&dya(i,npy-2))
            xtzv = max(q(i,npy-1),q(i,npy))
            xtzw = max(xtzv,q(i+1,npy-1))
            xtzx = max(xtzw,q(i+1,npy))
            adxtzx = adxt*(0.5-sign(0.5,xtzx-xt))
            adq(i+1,npy) = adq(i+1,npy)+adxtzx*(0.5-sign(0.5,xtzw-q(i+1,npy)))
            adxtzw = adxtzx*(0.5+sign(0.5,xtzw-q(i+1,npy)))
            adq(i+1,npy-1) = adq(i+1,npy-1)+adxtzw*(0.5-sign(0.5,xtzv-q(i+1,npy-1)))
            adxtzv = adxtzw*(0.5+sign(0.5,xtzv-q(i+1,npy-1)))
            adq(i,npy-1) = adq(i,npy-1)+adxtzv*(0.5+sign(0.5,q(i,npy-1)-q(i,npy)))
            adq(i,npy) = adq(i,npy)+adxtzv*(0.5-sign(0.5,q(i,npy-1)-q(i,npy)))
            adxt = adxt*(0.5+sign(0.5,xtzx-xt))
          endif
        endif
        adq(i,npy-2) = adq(i,npy-2)-adxt*(0.5*dya(i,npy-1)/(dya(i,npy-1)+dya(i,npy-2)))
        adq(i,npy-1) = adq(i,npy-1)+adxt*(0.5*(2.*dya(i,npy-1)+dya(i,npy-2))/(dya(i,npy-1)+dya(i,npy-2)))
        adq(i,npy+1) = adq(i,npy+1)-adxt*(0.5*dya(i,npy-1)/(dya(i,npy-1)+dya(i,npy-2)))
        adq(i,npy) = adq(i,npy)+adxt*(0.5*(2.*dya(i,npy-1)+dya(i,npy-2))/(dya(i,npy-1)+dya(i,npy-2)))
        adxt = 0.
        adal(i,npy-2) = adal(i,npy-2)+adbl(i,npy-2)
        adq(i,npy-2) = adq(i,npy-2)-adbl(i,npy-2)
        adbl(i,npy-2) = 0.
      end do
    endif
    do j = max(3,js-1), min(npy-3,je+1)
      do i = ifirst, ilast
        pmp = -(2.*dq(i,j))
        lac = pmp+1.5*dq(i,j+1)
        bl(i,j) = min(max(0.,pmp,lac),max(al(i,j)-q(i,j),min(0.,pmp,lac)))
        pmp = 2.*dq(i,j-1)
        lac = pmp-1.5*dq(i,j-2)
        br(i,j) = min(max(0.,pmp,lac),max(al(i,j+1)-q(i,j),min(0.,pmp,lac)))
      end do
    end do
    if (js .eq. 1) then
      do i = ifirst, ilast
        br(i,2) = al(i,3)-q(i,2)
        xt = 0.5*((2.*dya(i,1)+dya(i,2))*(q(i,0)+q(i,1))-dya(i,1)*(q(i,-1)+q(i,2)))/(dya(i,1)+dya(i,2))
        if (edge_mono_kim) then
          if (i .gt. (-2) .and. i .lt. 1 .or. i .gt. npx-3 .and. i .lt. npx) then
            xt = min(xt,max(q(i,0),q(i,1),q(i-1,0),q(i-1,1)))
            xt = max(xt,min(q(i,0),q(i,1),q(i-1,0),q(i-1,1)))
          else if (i .lt. 3 .and. i .gt. 0 .or. i .gt. npx-1 .and. i .lt. npx+2) then
            xt = min(xt,max(q(i,0),q(i,1),q(i+1,0),q(i+1,1)))
            xt = max(xt,min(q(i,0),q(i,1),q(i+1,0),q(i+1,1)))
          endif
        endif
        bl(i,1) = xt-q(i,1)
        br(i,0) = xt-q(i,0)
        xt = 4./7.*dm(i,-1)-11./14.*dq(i,-1)+q(i,0)
        if (s_mono_kim) then
          xt = min(xt,max(q(i,-1),q(i,0)))
          xt = max(xt,min(q(i,-1),q(i,0)))
        endif
        bl(i,0) = xt-q(i,0)
        xt = 3./14.*q(i,1)+11./14.*q(i,2)-4./7.*dm(i,2)
        if (s_mono_kim) then
          xt = min(xt,max(q(i,1),q(i,2)))
          xt = max(xt,min(q(i,1),q(i,2)))
        endif
        br(i,1) = xt-q(i,1)
        bl(i,2) = xt-q(i,2)
      end do
      if (jord .eq. 9) then
        do j = 2, 0, -1
          do i = ifirst, ilast
            br(i,2) = al(i,3)-q(i,2)
            xt = 0.5*((2.*dya(i,1)+dya(i,2))*(q(i,0)+q(i,1))-dya(i,1)*(q(i,-1)+q(i,2)))/(dya(i,1)+dya(i,2))
            if (edge_mono_kim) then
              if (i .gt. (-2) .and. i .lt. 1 .or. i .gt. npx-3 .and. i .lt. npx) then
xt = min(xt,max(q(i,0),q(i,1),q(i-1,0),q(i-1,1)))
xt = max(xt,min(q(i,0),q(i,1),q(i-1,0),q(i-1,1)))
              else if (i .lt. 3 .and. i .gt. 0 .or. i .gt. npx-1 .and. i .lt. npx+2) then
xt = min(xt,max(q(i,0),q(i,1),q(i+1,0),q(i+1,1)))
xt = max(xt,min(q(i,0),q(i,1),q(i+1,0),q(i+1,1)))
              endif
            endif
            bl(i,1) = xt-q(i,1)
            br(i,0) = xt-q(i,0)
            xt = 4./7.*dm(i,-1)-11./14.*dq(i,-1)+q(i,0)
            if (s_mono_kim) then
              xt = min(xt,max(q(i,-1),q(i,0)))
              xt = max(xt,min(q(i,-1),q(i,0)))
            endif
            bl(i,0) = xt-q(i,0)
            xt = 3./14.*q(i,1)+11./14.*q(i,2)-4./7.*dm(i,2)
            if (s_mono_kim) then
              xt = min(xt,max(q(i,1),q(i,2)))
              xt = max(xt,min(q(i,1),q(i,2)))
            endif
            br(i,1) = xt-q(i,1)
            bl(i,2) = xt-q(i,2)
          end do
          do j6 = 0, j-1
            help_h = ilast-ifirst+1
            call pert_ppm( help_h,q(ifirst,j6),bl(ifirst,j6),br(ifirst,j6),1 )
          end do
          help_h = ilast-ifirst+1
          call adpert_ppm( help_h,q(ifirst,j),adq(ifirst,j),bl(ifirst,j),adbl(ifirst,j),br(ifirst,j),adbr(ifirst,j),1 )
        end do
      endif
      do i = ifirst, ilast
        adxt = 0.
        xt = 3./14.*q(i,1)+11./14.*q(i,2)-4./7.*dm(i,2)
        adq(i,2) = adq(i,2)-adbl(i,2)
        adxt = adxt+adbl(i,2)
        adbl(i,2) = 0.
        adq(i,1) = adq(i,1)-adbr(i,1)
        adxt = adxt+adbr(i,1)
        adbr(i,1) = 0.
        if (s_mono_kim) then
          xt = min(xt,max(q(i,1),q(i,2)))
          xtzze = min(q(i,1),q(i,2))
          adxtzze = adxt*(0.5-sign(0.5,xt-xtzze))
          adq(i,2) = adq(i,2)+adxtzze*(0.5-sign(0.5,q(i,2)-q(i,1)))
          adq(i,1) = adq(i,1)+adxtzze*(0.5+sign(0.5,q(i,2)-q(i,1)))
          adxt = adxt*(0.5+sign(0.5,xt-xtzze))
          xt = 3./14.*q(i,1)+11./14.*q(i,2)-4./7.*dm(i,2)
          xtzzf = max(q(i,1),q(i,2))
          adxtzzf = adxt*(0.5-sign(0.5,xtzzf-xt))
          adq(i,2) = adq(i,2)+adxtzzf*(0.5-sign(0.5,q(i,1)-q(i,2)))
          adq(i,1) = adq(i,1)+adxtzzf*(0.5+sign(0.5,q(i,1)-q(i,2)))
          adxt = adxt*(0.5+sign(0.5,xtzzf-xt))
        endif
        addm(i,2) = addm(i,2)-0.57142857*adxt
        adq(i,2) = adq(i,2)+0.78571429*adxt
        adq(i,1) = adq(i,1)+0.21428571*adxt
        adxt = 0.
        adq(i,0) = adq(i,0)-adbl(i,0)
        adxt = adxt+adbl(i,0)
        adbl(i,0) = 0.
        xt = 4./7.*dm(i,-1)-11./14.*dq(i,-1)+q(i,0)
        if (s_mono_kim) then
          xt = min(xt,max(q(i,-1),q(i,0)))
          xtzzg = min(q(i,-1),q(i,0))
          adxtzzg = adxt*(0.5-sign(0.5,xt-xtzzg))
          adq(i,-1) = adq(i,-1)+adxtzzg*(0.5+sign(0.5,q(i,0)-q(i,-1)))
          adq(i,0) = adq(i,0)+adxtzzg*(0.5-sign(0.5,q(i,0)-q(i,-1)))
          adxt = adxt*(0.5+sign(0.5,xt-xtzzg))
          xt = 4./7.*dm(i,-1)-11./14.*dq(i,-1)+q(i,0)
          xtzzh = max(q(i,-1),q(i,0))
          adxtzzh = adxt*(0.5-sign(0.5,xtzzh-xt))
          adq(i,-1) = adq(i,-1)+adxtzzh*(0.5+sign(0.5,q(i,-1)-q(i,0)))
          adq(i,0) = adq(i,0)+adxtzzh*(0.5-sign(0.5,q(i,-1)-q(i,0)))
          adxt = adxt*(0.5+sign(0.5,xtzzh-xt))
        endif
        addm(i,-1) = addm(i,-1)+0.57142857*adxt
        addq(i,-1) = addq(i,-1)-0.78571429*adxt
        adq(i,0) = adq(i,0)+adxt
        adxt = 0.
        adq(i,0) = adq(i,0)-adbr(i,0)
        adxt = adxt+adbr(i,0)
        adbr(i,0) = 0.
        adq(i,1) = adq(i,1)-adbl(i,1)
        adxt = adxt+adbl(i,1)
        adbl(i,1) = 0.
        xt = 0.5*((2.*dya(i,1)+dya(i,2))*(q(i,0)+q(i,1))-dya(i,1)*(q(i,-1)+q(i,2)))/(dya(i,1)+dya(i,2))
        if (edge_mono_kim) then
          if (i .gt. (-2) .and. i .lt. 1 .or. i .gt. npx-3 .and. i .lt. npx) then
            xt = min(xt,max(q(i,0),q(i,1),q(i-1,0),q(i-1,1)))
            xtzzo = min(q(i,0),q(i,1))
            xtzzp = min(xtzzo,q(i-1,0))
            xtzzq = min(xtzzp,q(i-1,1))
            adxtzzq = adxt*(0.5-sign(0.5,xt-xtzzq))
            adq(i-1,1) = adq(i-1,1)+adxtzzq*(0.5-sign(0.5,q(i-1,1)-xtzzp))
            adxtzzp = adxtzzq*(0.5+sign(0.5,q(i-1,1)-xtzzp))
            adq(i-1,0) = adq(i-1,0)+adxtzzp*(0.5-sign(0.5,q(i-1,0)-xtzzo))
            adxtzzo = adxtzzp*(0.5+sign(0.5,q(i-1,0)-xtzzo))
            adq(i,1) = adq(i,1)+adxtzzo*(0.5-sign(0.5,q(i,1)-q(i,0)))
            adq(i,0) = adq(i,0)+adxtzzo*(0.5+sign(0.5,q(i,1)-q(i,0)))
            adxt = adxt*(0.5+sign(0.5,xt-xtzzq))
            xt = 0.5*((2.*dya(i,1)+dya(i,2))*(q(i,0)+q(i,1))-dya(i,1)*(q(i,-1)+q(i,2)))/(dya(i,1)+dya(i,2))
            xtzzr = max(q(i,0),q(i,1))
            xtzzs = max(xtzzr,q(i-1,0))
            xtzzt = max(xtzzs,q(i-1,1))
            adxtzzt = adxt*(0.5-sign(0.5,xtzzt-xt))
            adq(i-1,1) = adq(i-1,1)+adxtzzt*(0.5-sign(0.5,xtzzs-q(i-1,1)))
            adxtzzs = adxtzzt*(0.5+sign(0.5,xtzzs-q(i-1,1)))
            adq(i-1,0) = adq(i-1,0)+adxtzzs*(0.5-sign(0.5,xtzzr-q(i-1,0)))
            adxtzzr = adxtzzs*(0.5+sign(0.5,xtzzr-q(i-1,0)))
            adq(i,1) = adq(i,1)+adxtzzr*(0.5-sign(0.5,q(i,0)-q(i,1)))
            adq(i,0) = adq(i,0)+adxtzzr*(0.5+sign(0.5,q(i,0)-q(i,1)))
            adxt = adxt*(0.5+sign(0.5,xtzzt-xt))
          else if (i .lt. 3 .and. i .gt. 0 .or. i .gt. npx-1 .and. i .lt. npx+2) then
            xt = min(xt,max(q(i,0),q(i,1),q(i+1,0),q(i+1,1)))
            xtzzi = min(q(i,0),q(i,1))
            xtzzj = min(xtzzi,q(i+1,0))
            xtzzk = min(xtzzj,q(i+1,1))
            adxtzzk = adxt*(0.5-sign(0.5,xt-xtzzk))
            adq(i+1,1) = adq(i+1,1)+adxtzzk*(0.5-sign(0.5,q(i+1,1)-xtzzj))
            adxtzzj = adxtzzk*(0.5+sign(0.5,q(i+1,1)-xtzzj))
            adq(i+1,0) = adq(i+1,0)+adxtzzj*(0.5-sign(0.5,q(i+1,0)-xtzzi))
            adxtzzi = adxtzzj*(0.5+sign(0.5,q(i+1,0)-xtzzi))
            adq(i,1) = adq(i,1)+adxtzzi*(0.5-sign(0.5,q(i,1)-q(i,0)))
            adq(i,0) = adq(i,0)+adxtzzi*(0.5+sign(0.5,q(i,1)-q(i,0)))
            adxt = adxt*(0.5+sign(0.5,xt-xtzzk))
            xt = 0.5*((2.*dya(i,1)+dya(i,2))*(q(i,0)+q(i,1))-dya(i,1)*(q(i,-1)+q(i,2)))/(dya(i,1)+dya(i,2))
            xtzzl = max(q(i,0),q(i,1))
            xtzzm = max(xtzzl,q(i+1,0))
            xtzzn = max(xtzzm,q(i+1,1))
            adxtzzn = adxt*(0.5-sign(0.5,xtzzn-xt))
            adq(i+1,1) = adq(i+1,1)+adxtzzn*(0.5-sign(0.5,xtzzm-q(i+1,1)))
            adxtzzm = adxtzzn*(0.5+sign(0.5,xtzzm-q(i+1,1)))
            adq(i+1,0) = adq(i+1,0)+adxtzzm*(0.5-sign(0.5,xtzzl-q(i+1,0)))
            adxtzzl = adxtzzm*(0.5+sign(0.5,xtzzl-q(i+1,0)))
            adq(i,1) = adq(i,1)+adxtzzl*(0.5-sign(0.5,q(i,0)-q(i,1)))
            adq(i,0) = adq(i,0)+adxtzzl*(0.5+sign(0.5,q(i,0)-q(i,1)))
            adxt = adxt*(0.5+sign(0.5,xtzzn-xt))
          endif
        endif
        adq(i,-1) = adq(i,-1)-adxt*(0.5*dya(i,1)/(dya(i,1)+dya(i,2)))
        adq(i,2) = adq(i,2)-adxt*(0.5*dya(i,1)/(dya(i,1)+dya(i,2)))
        adq(i,1) = adq(i,1)+adxt*(0.5*(2.*dya(i,1)+dya(i,2))/(dya(i,1)+dya(i,2)))
        adq(i,0) = adq(i,0)+adxt*(0.5*(2.*dya(i,1)+dya(i,2))/(dya(i,1)+dya(i,2)))
        adxt = 0.
        adal(i,3) = adal(i,3)+adbr(i,2)
        adq(i,2) = adq(i,2)-adbr(i,2)
        adbr(i,2) = 0.
      end do
    endif
    do j = max(3,js-1), min(npy-3,je+1)
      adlac = 0.
      adpmp = 0.
      do i = ifirst, ilast
        adlac = 0.
        adpmp = 0.
        pmp = 2.*dq(i,j-1)
        lac = pmp-1.5*dq(i,j-2)
        bry = max(0.,pmp)
        brz = max(bry,lac)
        brzb = min(0.,pmp)
        brzc = min(brzb,lac)
        brza = max(al(i,j+1)-q(i,j),brzc)
        adbrzb = adbr(i,j)*(0.5+sign(0.5,brza-brz))
        adbrzc = adbr(i,j)*(0.5-sign(0.5,brza-brz))
        adal(i,j+1) = adal(i,j+1)+adbrzc*(0.5+sign(0.5,al(i,j+1)-q(i,j)-brzc))
        adbrze = adbrzc*(0.5-sign(0.5,al(i,j+1)-q(i,j)-brzc))
        adq(i,j) = adq(i,j)-adbrzc*(0.5+sign(0.5,al(i,j+1)-q(i,j)-brzc))
        adbrzd = adbrze*(0.5+sign(0.5,lac-brzb))
        adlac = adlac+adbrze*(0.5-sign(0.5,lac-brzb))
        adpmp = adpmp+adbrzd*(0.5-sign(0.5,pmp-0.))
        adbrza = adbrzb*(0.5+sign(0.5,bry-lac))
        adlac = adlac+adbrzb*(0.5-sign(0.5,bry-lac))
        adpmp = adpmp+adbrza*(0.5-sign(0.5,0.-pmp))
        adbr(i,j) = 0.
        addq(i,j-2) = addq(i,j-2)-1.5*adlac
        adpmp = adpmp+adlac
        adlac = 0.
        addq(i,j-1) = addq(i,j-1)+2*adpmp
        adpmp = 0.
        pmp = -(2.*dq(i,j))
        lac = pmp+1.5*dq(i,j+1)
        bly = max(0.,pmp)
        blz = max(bly,lac)
        blzb = min(0.,pmp)
        blzc = min(blzb,lac)
        blza = max(al(i,j)-q(i,j),blzc)
        adblzb = adbl(i,j)*(0.5+sign(0.5,blza-blz))
        adblzc = adbl(i,j)*(0.5-sign(0.5,blza-blz))
        adal(i,j) = adal(i,j)+adblzc*(0.5+sign(0.5,al(i,j)-q(i,j)-blzc))
        adblze = adblzc*(0.5-sign(0.5,al(i,j)-q(i,j)-blzc))
        adq(i,j) = adq(i,j)-adblzc*(0.5+sign(0.5,al(i,j)-q(i,j)-blzc))
        adblzd = adblze*(0.5+sign(0.5,lac-blzb))
        adlac = adlac+adblze*(0.5-sign(0.5,lac-blzb))
        adpmp = adpmp+adblzd*(0.5-sign(0.5,pmp-0.))
        adblza = adblzb*(0.5+sign(0.5,bly-lac))
        adlac = adlac+adblzb*(0.5-sign(0.5,bly-lac))
        adpmp = adpmp+adblza*(0.5-sign(0.5,0.-pmp))
        adbl(i,j) = 0.
        addq(i,j+1) = addq(i,j+1)+1.5*adlac
        adpmp = adpmp+adlac
        adlac = 0.
        addq(i,j) = addq(i,j)-2*adpmp
        adpmp = 0.
      end do
    end do
    do j = max(3,js-1), min(npy-2,je+2)
      do i = ifirst, ilast
        addm(i,j-1) = addm(i,j-1)+adal(i,j)*r3
        addm(i,j) = addm(i,j)-adal(i,j)*r3
        adq(i,j-1) = adq(i,j-1)+0.5*adal(i,j)
        adq(i,j) = adq(i,j)+0.5*adal(i,j)
        adal(i,j) = 0.
      end do
    end do
  else
    do j = js-1, je+1
      adlac = 0.
      adpmp = 0.
      do i = ifirst, ilast
        adlac = 0.
        adpmp = 0.
        pmp = 2.*dq(i,j-1)
        lac = pmp-1.5*dq(i,j-2)
        brs = max(0.,pmp)
        bru = max(brs,lac)
        brw = min(0.,pmp)
        brx = min(brw,lac)
        brv = max(al(i,j+1)-q(i,j),brx)
        adbrw = adbr(i,j)*(0.5+sign(0.5,brv-bru))
        adbrx = adbr(i,j)*(0.5-sign(0.5,brv-bru))
        adal(i,j+1) = adal(i,j+1)+adbrx*(0.5+sign(0.5,al(i,j+1)-q(i,j)-brx))
        adbrz = adbrx*(0.5-sign(0.5,al(i,j+1)-q(i,j)-brx))
        adq(i,j) = adq(i,j)-adbrx*(0.5+sign(0.5,al(i,j+1)-q(i,j)-brx))
        adbry = adbrz*(0.5+sign(0.5,lac-brw))
        adlac = adlac+adbrz*(0.5-sign(0.5,lac-brw))
        adpmp = adpmp+adbry*(0.5-sign(0.5,pmp-0.))
        adbrv = adbrw*(0.5+sign(0.5,brs-lac))
        adlac = adlac+adbrw*(0.5-sign(0.5,brs-lac))
        adpmp = adpmp+adbrv*(0.5-sign(0.5,0.-pmp))
        adbr(i,j) = 0.
        addq(i,j-2) = addq(i,j-2)-1.5*adlac
        adpmp = adpmp+adlac
        adlac = 0.
        addq(i,j-1) = addq(i,j-1)+2*adpmp
        adpmp = 0.
        pmp = -(2.*dq(i,j))
        lac = pmp+1.5*dq(i,j+1)
        bls = max(0.,pmp)
        blu = max(bls,lac)
        blw = min(0.,pmp)
        blx = min(blw,lac)
        blv = max(al(i,j)-q(i,j),blx)
        adblw = adbl(i,j)*(0.5+sign(0.5,blv-blu))
        adblx = adbl(i,j)*(0.5-sign(0.5,blv-blu))
        adal(i,j) = adal(i,j)+adblx*(0.5+sign(0.5,al(i,j)-q(i,j)-blx))
        adblz = adblx*(0.5-sign(0.5,al(i,j)-q(i,j)-blx))
        adq(i,j) = adq(i,j)-adblx*(0.5+sign(0.5,al(i,j)-q(i,j)-blx))
        adbly = adblz*(0.5+sign(0.5,lac-blw))
        adlac = adlac+adblz*(0.5-sign(0.5,lac-blw))
        adpmp = adpmp+adbly*(0.5-sign(0.5,pmp-0.))
        adblv = adblw*(0.5+sign(0.5,bls-lac))
        adlac = adlac+adblw*(0.5-sign(0.5,bls-lac))
        adpmp = adpmp+adblv*(0.5-sign(0.5,0.-pmp))
        adbl(i,j) = 0.
        addq(i,j+1) = addq(i,j+1)+1.5*adlac
        adpmp = adpmp+adlac
        adlac = 0.
        addq(i,j) = addq(i,j)-2*adpmp
        adpmp = 0.
      end do
    end do
    do j = js-1, je+2
      do i = ifirst, ilast
        addm(i,j-1) = addm(i,j-1)+adal(i,j)*r3
        addm(i,j) = addm(i,j)-adal(i,j)*r3
        adq(i,j-1) = adq(i,j-1)+0.5*adal(i,j)
        adq(i,j) = adq(i,j)+0.5*adal(i,j)
        adal(i,j) = 0.
      end do
    end do
  endif
  if (uniform_ppm) then
    do j = js-2, je+2
      adxt = 0.
      do i = ifirst, ilast
        adxt = 0.
        xt = 0.25*(q(i,j+1)-q(i,j-1))
        dmr = abs(xt)
        dms = max(q(i,j-1),q(i,j))
        dmu = max(dms,q(i,j+1))-q(i,j)
        dmv = min(q(i,j-1),q(i,j))
        dmx = q(i,j)-min(dmv,q(i,j+1))
        dmy = min(dmr,dmu)
        addmzc = addm(i,j)*sign(1.,min(dmy,dmx))*sign(1.,xt)
        addmza = addmzc*(0.5-sign(0.5,dmx-dmy))
        addmzb = addmzc*(0.5+sign(0.5,dmx-dmy))
        addmu = addmzb*(0.5+sign(0.5,dmu-dmr))
        addmx = addmzb*(0.5-sign(0.5,dmu-dmr))
        addmz = -addmza
        adq(i,j) = adq(i,j)+addmza
        addmy = addmz*(0.5+sign(0.5,q(i,j+1)-dmv))
        adq(i,j+1) = adq(i,j+1)+addmz*(0.5-sign(0.5,q(i,j+1)-dmv))
        adq(i,j-1) = adq(i,j-1)+addmy*(0.5+sign(0.5,q(i,j)-q(i,j-1)))
        adq(i,j) = adq(i,j)+addmy*(0.5-sign(0.5,q(i,j)-q(i,j-1)))
        adq(i,j) = adq(i,j)-addmx
        addmv = addmx*(0.5+sign(0.5,dms-q(i,j+1)))
        adq(i,j+1) = adq(i,j+1)+addmx*(0.5-sign(0.5,dms-q(i,j+1)))
        adq(i,j-1) = adq(i,j-1)+addmv*(0.5+sign(0.5,q(i,j-1)-q(i,j)))
        adq(i,j) = adq(i,j)+addmv*(0.5-sign(0.5,q(i,j-1)-q(i,j)))
        adxt = adxt+addmu*sign(1.,xt)
        addm(i,j) = 0.
        adq(i,j-1) = adq(i,j-1)-0.25*adxt
        adq(i,j+1) = adq(i,j+1)+0.25*adxt
        adxt = 0.
      end do
    end do
  else
    do j = js-2, je+2
      adxt = 0.
      do i = ifirst, ilast
        adxt = 0.
        xt = cy1(i,j)*dq(i,j-1)+cy2(i,j)*dq(i,j)
        dmj = abs(xt)
        dmm = abs(dq(i,j-1))
        dmp = abs(dq(i,j))
        dmq = min(dmj,dmm)
        addmt = addm(i,j)*sign(1.,min(dmq,dmp))*sign(1.,xt)
        addmr = addmt*(0.5-sign(0.5,dmp-dmq))
        addms = addmt*(0.5+sign(0.5,dmp-dmq))
        addmj = addms*(0.5+sign(0.5,dmm-dmj))
        addmq = addms*(0.5-sign(0.5,dmm-dmj))
        addq(i,j) = addq(i,j)+addmr*sign(1.,dq(i,j))
        addq(i,j-1) = addq(i,j-1)+addmq*sign(1.,dq(i,j-1))
        adxt = adxt+addmj*sign(1.,xt)
        addm(i,j) = 0.
        addq(i,j-1) = addq(i,j-1)+adxt*cy1(i,j)
        addq(i,j) = addq(i,j)+adxt*cy2(i,j)
        adxt = 0.
      end do
    end do
  endif
  do j = js-3, je+2
    do i = ifirst, ilast
      adq(i,j+1) = adq(i,j+1)+addq(i,j)
      adq(i,j) = adq(i,j)-addq(i,j)
      addq(i,j) = 0.
    end do
  end do
else
  js3 = max(3,js-1)
  je3 = min(npy-3,je+1)
  do j = js-2, je+2
    do i = ifirst, ilast
      xt = 0.25*(q(i,j+1)-q(i,j-1))
      dm(i,j) = sign(min(abs(xt),max(q(i,j-1),q(i,j),q(i,j+1))-q(i,j),q(i,j)-min(q(i,j-1),q(i,j),q(i,j+1))),xt)
    end do
  end do
  if (grid_type .lt. 3) then
    do j = js3, min(npy-2,je+2)
      do i = ifirst, ilast
        al(i,j) = 0.5*(q(i,j-1)+q(i,j))+r3*(dm(i,j-1)-dm(i,j))
      end do
    end do
    if (jord .eq. 11) then
      do j = js3, je3
        do i = ifirst, ilast
          xt = 2.*dm(i,j)
          bl(i,j) = -sign(min(abs(xt),abs(al(i,j)-q(i,j))),xt)
          br(i,j) = sign(min(abs(xt),abs(al(i,j+1)-q(i,j))),xt)
        end do
      end do
    else if (jord .eq. 12) then
      do j = js-3, je+2
        do i = ifirst, ilast
          dq(i,j) = q(i,j+1)-q(i,j)
        end do
      end do
      do j = js3, je3
        do i = ifirst, ilast
          pmp = -(2.*dq(i,j))
          lac = pmp+1.5*dq(i,j+1)
          bl(i,j) = min(max(0.,pmp,lac),max(al(i,j)-q(i,j),min(0.,pmp,lac)))
          pmp = 2.*dq(i,j-1)
          lac = pmp-1.5*dq(i,j-2)
          br(i,j) = min(max(0.,pmp,lac),max(al(i,j+1)-q(i,j),min(0.,pmp,lac)))
        end do
      end do
    else
      do j = js3, je3
        do i = ifirst, ilast
          bl(i,j) = al(i,j)-q(i,j)
          br(i,j) = al(i,j+1)-q(i,j)
        end do
      end do
    endif
    if (jord .ne. 11) then
      do j = js3, je3
        help_j = ilast-ifirst+1
        call pert_ppm( help_j,q(ifirst,j),bl(ifirst,j),br(ifirst,j),0 )
      end do
    endif
    if (js .eq. 1) then
      do i = ifirst, ilast
        br(i,2) = al(i,3)-q(i,2)
        xt = 0.5*((2.*dya(i,1)+dya(i,2))*(q(i,0)+q(i,1))-dya(i,1)*(q(i,-1)+q(i,2)))/(dya(i,1)+dya(i,2))
        if (edge_mono_kim) then
          if (i .gt. (-2) .and. i .lt. 1 .or. i .gt. npx-3 .and. i .lt. npx) then
            xt = min(xt,max(q(i,0),q(i,1),q(i-1,0),q(i-1,1)))
            xt = max(xt,min(q(i,0),q(i,1),q(i-1,0),q(i-1,1)))
          else if (i .lt. 3 .and. i .gt. 0 .or. i .gt. npx-1 .and. i .lt. npx+2) then
            xt = min(xt,max(q(i,0),q(i,1),q(i+1,0),q(i+1,1)))
            xt = max(xt,min(q(i,0),q(i,1),q(i+1,0),q(i+1,1)))
          else
            xt = max(0.,xt)
          endif
        else
          xt = max(0.,xt)
        endif
        bl(i,1) = xt-q(i,1)
        br(i,0) = xt-q(i,0)
        xt = 4./7.*dm(i,-1)+11./14.*q(i,-1)+3./14.*q(i,0)
        if (s_mono_kim) then
          xt = min(xt,max(q(i,-1),q(i,0)))
          xt = max(xt,min(q(i,-1),q(i,0)))
        else
          xt = max(0.,xt)
        endif
        bl(i,0) = xt-q(i,0)
        xt = 3./14.*q(i,1)+11./14.*q(i,2)-4./7.*dm(i,2)
        if (s_mono_kim) then
          xt = min(xt,max(q(i,1),q(i,2)))
          xt = max(xt,min(q(i,1),q(i,2)))
        else
          xt = max(0.,xt)
        endif
        br(i,1) = xt-q(i,1)
        bl(i,2) = xt-q(i,2)
      end do
      do j = 0, 2
        help_k = ilast-ifirst+1
        call pert_ppm( help_k,q(ifirst,j),bl(ifirst,j),br(ifirst,j),1 )
      end do
    endif
    if (je+1 .eq. npy) then
      do i = ifirst, ilast
        bl(i,npy-2) = al(i,npy-2)-q(i,npy-2)
        xt = 0.5*((2.*dya(i,npy-1)+dya(i,npy-2))*(q(i,npy-1)+q(i,npy))-dya(i,npy-1)*(q(i,npy-2)+q(i,npy+1)))/(dya(i,npy-1)+dya(i,&
&npy-2))
        if (edge_mono_kim) then
          if (i .gt. (-2) .and. i .lt. 1 .or. i .gt. npx-3 .and. i .lt. npx) then
            xt = min(xt,max(q(i,npy-1),q(i,npy),q(i-1,npy-1),q(i-1,npy)))
            xt = max(xt,min(q(i,npy-1),q(i,npy),q(i-1,npy-1),q(i-1,npy)))
          else if (i .lt. 3 .and. i .gt. 0 .or. i .gt. npx-1 .and. i .lt. npx+2) then
            xt = min(xt,max(q(i,npy-1),q(i,npy),q(i+1,npy-1),q(i+1,npy)))
            xt = max(xt,min(q(i,npy-1),q(i,npy),q(i+1,npy-1),q(i+1,npy)))
          else
            xt = max(0.,xt)
          endif
        else
          xt = max(0.,xt)
        endif
        br(i,npy-1) = xt-q(i,npy-1)
        bl(i,npy) = xt-q(i,npy)
        xt = 3./14.*q(i,npy)+11./14.*q(i,npy+1)-4./7.*dm(i,npy+1)
        if (s_mono_kim) then
          xt = min(xt,max(q(i,npy),q(i,npy+1)))
          xt = max(xt,min(q(i,npy),q(i,npy+1)))
        else
          xt = max(0.,xt)
        endif
        br(i,npy) = xt-q(i,npy)
        xt = 3./14.*q(i,npy-1)+11./14.*q(i,npy-2)+4./7.*dm(i,npy-2)
        if (s_mono_kim) then
          xt = min(xt,max(q(i,npy-2),q(i,npy-1)))
          xt = max(xt,min(q(i,npy-2),q(i,npy-1)))
        else
          xt = max(0.,xt)
        endif
        br(i,npy-2) = xt-q(i,npy-2)
        bl(i,npy-1) = xt-q(i,npy-1)
      end do
      do j = npy-2, npy
        help_l = ilast-ifirst+1
        call pert_ppm( help_l,q(ifirst,j),bl(ifirst,j),br(ifirst,j),1 )
      end do
    endif
  else
    do j = js-1, je+2
      do i = ifirst, ilast
        al(i,j) = 0.5*(q(i,j-1)+q(i,j))+r3*(dm(i,j-1)-dm(i,j))
      end do
    end do
    if (jord .eq. 11) then
      do j = js-1, je+1
        do i = ifirst, ilast
          xt = 2.*dm(i,j)
          bl(i,j) = -sign(min(abs(xt),abs(al(i,j)-q(i,j))),xt)
          br(i,j) = sign(min(abs(xt),abs(al(i,j+1)-q(i,j))),xt)
        end do
      end do
    else if (jord .eq. 12) then
      do j = js-3, je+2
        do i = ifirst, ilast
          dq(i,j) = q(i,j+1)-q(i,j)
        end do
      end do
      do j = js-1, je+1
        do i = ifirst, ilast
          pmp = -(2.*dq(i,j))
          lac = pmp+1.5*dq(i,j+1)
          bl(i,j) = min(max(0.,pmp,lac),max(al(i,j)-q(i,j),min(0.,pmp,lac)))
          pmp = 2.*dq(i,j-1)
          lac = pmp-1.5*dq(i,j-2)
          br(i,j) = min(max(0.,pmp,lac),max(al(i,j+1)-q(i,j),min(0.,pmp,lac)))
        end do
      end do
    else
      do j = js-1, je+1
        do i = ifirst, ilast
          bl(i,j) = al(i,j)-q(i,j)
          br(i,j) = al(i,j+1)-q(i,j)
        end do
      end do
    endif
    if (jord .ne. 11) then
      do j = js-1, je+1
        help_m = ilast-ifirst+1
        call pert_ppm( help_m,q(ifirst,j),bl(ifirst,j),br(ifirst,j),0 )
      end do
    endif
  endif
  do j = js, je+1
    do i = ifirst, ilast
      if (c(i,j) .gt. 0.) then
        adbl(i,j-1) = adbl(i,j-1)-adflux(i,j)*(1.-c(i,j))*c(i,j)
        adbr(i,j-1) = adbr(i,j-1)+adflux(i,j)*(1.-c(i,j))*(1-c(i,j))
        adc(i,j) = adc(i,j)+adflux(i,j)*((-((1.-c(i,j))*(bl(i,j-1)+br(i,j-1))))-(br(i,j-1)-c(i,j)*(bl(i,j-1)+br(i,j-1))))
        adq(i,j-1) = adq(i,j-1)+adflux(i,j)
        adflux(i,j) = 0.
      else
        adbl(i,j) = adbl(i,j)+adflux(i,j)*(1.+c(i,j))*(1+c(i,j))
        adbr(i,j) = adbr(i,j)+adflux(i,j)*(1.+c(i,j))*c(i,j)
        adc(i,j) = adc(i,j)+adflux(i,j)*((1.+c(i,j))*(bl(i,j)+br(i,j))+bl(i,j)+c(i,j)*(bl(i,j)+br(i,j)))
        adq(i,j) = adq(i,j)+adflux(i,j)
        adflux(i,j) = 0.
      endif
    end do
  end do
  if (grid_type .lt. 3) then
    if (jord .eq. 11) then
      do j = js3, je3
        do i = ifirst, ilast
          xt = 2.*dm(i,j)
          bl(i,j) = -sign(min(abs(xt),abs(al(i,j)-q(i,j))),xt)
          br(i,j) = sign(min(abs(xt),abs(al(i,j+1)-q(i,j))),xt)
        end do
      end do
    else if (jord .eq. 12) then
      do j = js3, je3
        do i = ifirst, ilast
          pmp = -(2.*dq(i,j))
          lac = pmp+1.5*dq(i,j+1)
          bl(i,j) = min(max(0.,pmp,lac),max(al(i,j)-q(i,j),min(0.,pmp,lac)))
          pmp = 2.*dq(i,j-1)
          lac = pmp-1.5*dq(i,j-2)
          br(i,j) = min(max(0.,pmp,lac),max(al(i,j+1)-q(i,j),min(0.,pmp,lac)))
        end do
      end do
    else
      do j = js3, je3
        do i = ifirst, ilast
          bl(i,j) = al(i,j)-q(i,j)
          br(i,j) = al(i,j+1)-q(i,j)
        end do
      end do
    endif
    if (jord .ne. 11) then
      do j = js3, je3
        help_j = ilast-ifirst+1
        call pert_ppm( help_j,q(ifirst,j),bl(ifirst,j),br(ifirst,j),0 )
      end do
    endif
    if (js .eq. 1) then
      do i = ifirst, ilast
        br(i,2) = al(i,3)-q(i,2)
        xt = 0.5*((2.*dya(i,1)+dya(i,2))*(q(i,0)+q(i,1))-dya(i,1)*(q(i,-1)+q(i,2)))/(dya(i,1)+dya(i,2))
        if (edge_mono_kim) then
          if (i .gt. (-2) .and. i .lt. 1 .or. i .gt. npx-3 .and. i .lt. npx) then
            xt = min(xt,max(q(i,0),q(i,1),q(i-1,0),q(i-1,1)))
            xt = max(xt,min(q(i,0),q(i,1),q(i-1,0),q(i-1,1)))
          else if (i .lt. 3 .and. i .gt. 0 .or. i .gt. npx-1 .and. i .lt. npx+2) then
            xt = min(xt,max(q(i,0),q(i,1),q(i+1,0),q(i+1,1)))
            xt = max(xt,min(q(i,0),q(i,1),q(i+1,0),q(i+1,1)))
          else
            xt = max(0.,xt)
          endif
        else
          xt = max(0.,xt)
        endif
        bl(i,1) = xt-q(i,1)
        br(i,0) = xt-q(i,0)
        xt = 4./7.*dm(i,-1)+11./14.*q(i,-1)+3./14.*q(i,0)
        if (s_mono_kim) then
          xt = min(xt,max(q(i,-1),q(i,0)))
          xt = max(xt,min(q(i,-1),q(i,0)))
        else
          xt = max(0.,xt)
        endif
        bl(i,0) = xt-q(i,0)
        xt = 3./14.*q(i,1)+11./14.*q(i,2)-4./7.*dm(i,2)
        if (s_mono_kim) then
          xt = min(xt,max(q(i,1),q(i,2)))
          xt = max(xt,min(q(i,1),q(i,2)))
        else
          xt = max(0.,xt)
        endif
        br(i,1) = xt-q(i,1)
        bl(i,2) = xt-q(i,2)
      end do
      do j = 0, 2
        help_k = ilast-ifirst+1
        call pert_ppm( help_k,q(ifirst,j),bl(ifirst,j),br(ifirst,j),1 )
      end do
    endif
    if (je+1 .eq. npy) then
      do i = ifirst, ilast
        bl(i,npy-2) = al(i,npy-2)-q(i,npy-2)
        xt = 0.5*((2.*dya(i,npy-1)+dya(i,npy-2))*(q(i,npy-1)+q(i,npy))-dya(i,npy-1)*(q(i,npy-2)+q(i,npy+1)))/(dya(i,npy-1)+dya(i,&
&npy-2))
        if (edge_mono_kim) then
          if (i .gt. (-2) .and. i .lt. 1 .or. i .gt. npx-3 .and. i .lt. npx) then
            xt = min(xt,max(q(i,npy-1),q(i,npy),q(i-1,npy-1),q(i-1,npy)))
            xt = max(xt,min(q(i,npy-1),q(i,npy),q(i-1,npy-1),q(i-1,npy)))
          else if (i .lt. 3 .and. i .gt. 0 .or. i .gt. npx-1 .and. i .lt. npx+2) then
            xt = min(xt,max(q(i,npy-1),q(i,npy),q(i+1,npy-1),q(i+1,npy)))
            xt = max(xt,min(q(i,npy-1),q(i,npy),q(i+1,npy-1),q(i+1,npy)))
          else
            xt = max(0.,xt)
          endif
        else
          xt = max(0.,xt)
        endif
        br(i,npy-1) = xt-q(i,npy-1)
        bl(i,npy) = xt-q(i,npy)
        xt = 3./14.*q(i,npy)+11./14.*q(i,npy+1)-4./7.*dm(i,npy+1)
        if (s_mono_kim) then
          xt = min(xt,max(q(i,npy),q(i,npy+1)))
          xt = max(xt,min(q(i,npy),q(i,npy+1)))
        else
          xt = max(0.,xt)
        endif
        br(i,npy) = xt-q(i,npy)
        xt = 3./14.*q(i,npy-1)+11./14.*q(i,npy-2)+4./7.*dm(i,npy-2)
        if (s_mono_kim) then
          xt = min(xt,max(q(i,npy-2),q(i,npy-1)))
          xt = max(xt,min(q(i,npy-2),q(i,npy-1)))
        else
          xt = max(0.,xt)
        endif
        br(i,npy-2) = xt-q(i,npy-2)
        bl(i,npy-1) = xt-q(i,npy-1)
      end do
      do j = npy, npy-2, -1
        do i = ifirst, ilast
          bl(i,npy-2) = al(i,npy-2)-q(i,npy-2)
          xt = 0.5*((2.*dya(i,npy-1)+dya(i,npy-2))*(q(i,npy-1)+q(i,npy))-dya(i,npy-1)*(q(i,npy-2)+q(i,npy+1)))/(dya(i,npy-1)+dya(i,&
&npy-2))
          if (edge_mono_kim) then
            if (i .gt. (-2) .and. i .lt. 1 .or. i .gt. npx-3 .and. i .lt. npx) then
              xt = min(xt,max(q(i,npy-1),q(i,npy),q(i-1,npy-1),q(i-1,npy)))
              xt = max(xt,min(q(i,npy-1),q(i,npy),q(i-1,npy-1),q(i-1,npy)))
            else if (i .lt. 3 .and. i .gt. 0 .or. i .gt. npx-1 .and. i .lt. npx+2) then
              xt = min(xt,max(q(i,npy-1),q(i,npy),q(i+1,npy-1),q(i+1,npy)))
              xt = max(xt,min(q(i,npy-1),q(i,npy),q(i+1,npy-1),q(i+1,npy)))
            else
              xt = max(0.,xt)
            endif
          else
            xt = max(0.,xt)
          endif
          br(i,npy-1) = xt-q(i,npy-1)
          bl(i,npy) = xt-q(i,npy)
          xt = 3./14.*q(i,npy)+11./14.*q(i,npy+1)-4./7.*dm(i,npy+1)
          if (s_mono_kim) then
            xt = min(xt,max(q(i,npy),q(i,npy+1)))
            xt = max(xt,min(q(i,npy),q(i,npy+1)))
          else
            xt = max(0.,xt)
          endif
          br(i,npy) = xt-q(i,npy)
          xt = 3./14.*q(i,npy-1)+11./14.*q(i,npy-2)+4./7.*dm(i,npy-2)
          if (s_mono_kim) then
            xt = min(xt,max(q(i,npy-2),q(i,npy-1)))
            xt = max(xt,min(q(i,npy-2),q(i,npy-1)))
          else
            xt = max(0.,xt)
          endif
          br(i,npy-2) = xt-q(i,npy-2)
          bl(i,npy-1) = xt-q(i,npy-1)
        end do
        do j2 = npy-2, j-1
          help_l = ilast-ifirst+1
          call pert_ppm( help_l,q(ifirst,j2),bl(ifirst,j2),br(ifirst,j2),1 )
        end do
        help_l = ilast-ifirst+1
        call adpert_ppm( help_l,q(ifirst,j),adq(ifirst,j),bl(ifirst,j),adbl(ifirst,j),br(ifirst,j),adbr(ifirst,j),1 )
      end do
      do i = ifirst, ilast
        adxt = 0.
        xt = 3./14.*q(i,npy-1)+11./14.*q(i,npy-2)+4./7.*dm(i,npy-2)
        adq(i,npy-1) = adq(i,npy-1)-adbl(i,npy-1)
        adxt = adxt+adbl(i,npy-1)
        adbl(i,npy-1) = 0.
        adq(i,npy-2) = adq(i,npy-2)-adbr(i,npy-2)
        adxt = adxt+adbr(i,npy-2)
        adbr(i,npy-2) = 0.
        if (s_mono_kim) then
          xt = min(xt,max(q(i,npy-2),q(i,npy-1)))
          xth = min(q(i,npy-2),q(i,npy-1))
          adxth = adxt*(0.5-sign(0.5,xt-xth))
          adq(i,npy-2) = adq(i,npy-2)+adxth*(0.5+sign(0.5,q(i,npy-1)-q(i,npy-2)))
          adq(i,npy-1) = adq(i,npy-1)+adxth*(0.5-sign(0.5,q(i,npy-1)-q(i,npy-2)))
          adxt = adxt*(0.5+sign(0.5,xt-xth))
          xt = 3./14.*q(i,npy-1)+11./14.*q(i,npy-2)+4./7.*dm(i,npy-2)
          xti = max(q(i,npy-2),q(i,npy-1))
          adxti = adxt*(0.5-sign(0.5,xti-xt))
          adq(i,npy-2) = adq(i,npy-2)+adxti*(0.5+sign(0.5,q(i,npy-2)-q(i,npy-1)))
          adq(i,npy-1) = adq(i,npy-1)+adxti*(0.5-sign(0.5,q(i,npy-2)-q(i,npy-1)))
          adxt = adxt*(0.5+sign(0.5,xti-xt))
        else
          adxt = adxt*(0.5-sign(0.5,0.-xt))
        endif
        addm(i,npy-2) = addm(i,npy-2)+0.57142857*adxt
        adq(i,npy-2) = adq(i,npy-2)+0.78571429*adxt
        adq(i,npy-1) = adq(i,npy-1)+0.21428571*adxt
        adxt = 0.
        adq(i,npy) = adq(i,npy)-adbr(i,npy)
        adxt = adxt+adbr(i,npy)
        adbr(i,npy) = 0.
        xt = 3./14.*q(i,npy)+11./14.*q(i,npy+1)-4./7.*dm(i,npy+1)
        if (s_mono_kim) then
          xt = min(xt,max(q(i,npy),q(i,npy+1)))
          xtj = min(q(i,npy),q(i,npy+1))
          adxtj = adxt*(0.5-sign(0.5,xt-xtj))
          adq(i,npy+1) = adq(i,npy+1)+adxtj*(0.5-sign(0.5,q(i,npy+1)-q(i,npy)))
          adq(i,npy) = adq(i,npy)+adxtj*(0.5+sign(0.5,q(i,npy+1)-q(i,npy)))
          adxt = adxt*(0.5+sign(0.5,xt-xtj))
          xt = 3./14.*q(i,npy)+11./14.*q(i,npy+1)-4./7.*dm(i,npy+1)
          xtk = max(q(i,npy),q(i,npy+1))
          adxtk = adxt*(0.5-sign(0.5,xtk-xt))
          adq(i,npy+1) = adq(i,npy+1)+adxtk*(0.5-sign(0.5,q(i,npy)-q(i,npy+1)))
          adq(i,npy) = adq(i,npy)+adxtk*(0.5+sign(0.5,q(i,npy)-q(i,npy+1)))
          adxt = adxt*(0.5+sign(0.5,xtk-xt))
        else
          adxt = adxt*(0.5-sign(0.5,0.-xt))
        endif
        addm(i,npy+1) = addm(i,npy+1)-0.57142857*adxt
        adq(i,npy+1) = adq(i,npy+1)+0.78571429*adxt
        adq(i,npy) = adq(i,npy)+0.21428571*adxt
        adxt = 0.
        adq(i,npy) = adq(i,npy)-adbl(i,npy)
        adxt = adxt+adbl(i,npy)
        adbl(i,npy) = 0.
        adq(i,npy-1) = adq(i,npy-1)-adbr(i,npy-1)
        adxt = adxt+adbr(i,npy-1)
        adbr(i,npy-1) = 0.
        xt = 0.5*((2.*dya(i,npy-1)+dya(i,npy-2))*(q(i,npy-1)+q(i,npy))-dya(i,npy-1)*(q(i,npy-2)+q(i,npy+1)))/(dya(i,npy-1)+dya(i,&
&npy-2))
        if (edge_mono_kim) then
          if (i .gt. (-2) .and. i .lt. 1 .or. i .gt. npx-3 .and. i .lt. npx) then
            xt = min(xt,max(q(i,npy-1),q(i,npy),q(i-1,npy-1),q(i-1,npy)))
            xts = min(q(i,npy-1),q(i,npy))
            xtt = min(xts,q(i-1,npy-1))
            xtu = min(xtt,q(i-1,npy))
            adxtu = adxt*(0.5-sign(0.5,xt-xtu))
            adq(i-1,npy) = adq(i-1,npy)+adxtu*(0.5-sign(0.5,q(i-1,npy)-xtt))
            adxtt = adxtu*(0.5+sign(0.5,q(i-1,npy)-xtt))
            adq(i-1,npy-1) = adq(i-1,npy-1)+adxtt*(0.5-sign(0.5,q(i-1,npy-1)-xts))
            adxts = adxtt*(0.5+sign(0.5,q(i-1,npy-1)-xts))
            adq(i,npy-1) = adq(i,npy-1)+adxts*(0.5+sign(0.5,q(i,npy)-q(i,npy-1)))
            adq(i,npy) = adq(i,npy)+adxts*(0.5-sign(0.5,q(i,npy)-q(i,npy-1)))
            adxt = adxt*(0.5+sign(0.5,xt-xtu))
            xt = 0.5*((2.*dya(i,npy-1)+dya(i,npy-2))*(q(i,npy-1)+q(i,npy))-dya(i,npy-1)*(q(i,npy-2)+q(i,npy+1)))/(dya(i,npy-1)+&
&dya(i,npy-2))
            xtv = max(q(i,npy-1),q(i,npy))
            xtw = max(xtv,q(i-1,npy-1))
            xtx = max(xtw,q(i-1,npy))
            adxtx = adxt*(0.5-sign(0.5,xtx-xt))
            adq(i-1,npy) = adq(i-1,npy)+adxtx*(0.5-sign(0.5,xtw-q(i-1,npy)))
            adxtw = adxtx*(0.5+sign(0.5,xtw-q(i-1,npy)))
            adq(i-1,npy-1) = adq(i-1,npy-1)+adxtw*(0.5-sign(0.5,xtv-q(i-1,npy-1)))
            adxtv = adxtw*(0.5+sign(0.5,xtv-q(i-1,npy-1)))
            adq(i,npy-1) = adq(i,npy-1)+adxtv*(0.5+sign(0.5,q(i,npy-1)-q(i,npy)))
            adq(i,npy) = adq(i,npy)+adxtv*(0.5-sign(0.5,q(i,npy-1)-q(i,npy)))
            adxt = adxt*(0.5+sign(0.5,xtx-xt))
          else if (i .lt. 3 .and. i .gt. 0 .or. i .gt. npx-1 .and. i .lt. npx+2) then
            xt = min(xt,max(q(i,npy-1),q(i,npy),q(i+1,npy-1),q(i+1,npy)))
            xtl = min(q(i,npy-1),q(i,npy))
            xtm = min(xtl,q(i+1,npy-1))
            xtn = min(xtm,q(i+1,npy))
            adxtn = adxt*(0.5-sign(0.5,xt-xtn))
            adq(i+1,npy) = adq(i+1,npy)+adxtn*(0.5-sign(0.5,q(i+1,npy)-xtm))
            adxtm = adxtn*(0.5+sign(0.5,q(i+1,npy)-xtm))
            adq(i+1,npy-1) = adq(i+1,npy-1)+adxtm*(0.5-sign(0.5,q(i+1,npy-1)-xtl))
            adxtl = adxtm*(0.5+sign(0.5,q(i+1,npy-1)-xtl))
            adq(i,npy-1) = adq(i,npy-1)+adxtl*(0.5+sign(0.5,q(i,npy)-q(i,npy-1)))
            adq(i,npy) = adq(i,npy)+adxtl*(0.5-sign(0.5,q(i,npy)-q(i,npy-1)))
            adxt = adxt*(0.5+sign(0.5,xt-xtn))
            xt = 0.5*((2.*dya(i,npy-1)+dya(i,npy-2))*(q(i,npy-1)+q(i,npy))-dya(i,npy-1)*(q(i,npy-2)+q(i,npy+1)))/(dya(i,npy-1)+&
&dya(i,npy-2))
            xto = max(q(i,npy-1),q(i,npy))
            xtq = max(xto,q(i+1,npy-1))
            xtr = max(xtq,q(i+1,npy))
            adxtr = adxt*(0.5-sign(0.5,xtr-xt))
            adq(i+1,npy) = adq(i+1,npy)+adxtr*(0.5-sign(0.5,xtq-q(i+1,npy)))
            adxtq = adxtr*(0.5+sign(0.5,xtq-q(i+1,npy)))
            adq(i+1,npy-1) = adq(i+1,npy-1)+adxtq*(0.5-sign(0.5,xto-q(i+1,npy-1)))
            adxto = adxtq*(0.5+sign(0.5,xto-q(i+1,npy-1)))
            adq(i,npy-1) = adq(i,npy-1)+adxto*(0.5+sign(0.5,q(i,npy-1)-q(i,npy)))
            adq(i,npy) = adq(i,npy)+adxto*(0.5-sign(0.5,q(i,npy-1)-q(i,npy)))
            adxt = adxt*(0.5+sign(0.5,xtr-xt))
          else
            adxt = adxt*(0.5-sign(0.5,0.-xt))
          endif
        else
          adxt = adxt*(0.5-sign(0.5,0.-xt))
        endif
        adq(i,npy-2) = adq(i,npy-2)-adxt*(0.5*dya(i,npy-1)/(dya(i,npy-1)+dya(i,npy-2)))
        adq(i,npy-1) = adq(i,npy-1)+adxt*(0.5*(2.*dya(i,npy-1)+dya(i,npy-2))/(dya(i,npy-1)+dya(i,npy-2)))
        adq(i,npy+1) = adq(i,npy+1)-adxt*(0.5*dya(i,npy-1)/(dya(i,npy-1)+dya(i,npy-2)))
        adq(i,npy) = adq(i,npy)+adxt*(0.5*(2.*dya(i,npy-1)+dya(i,npy-2))/(dya(i,npy-1)+dya(i,npy-2)))
        adxt = 0.
        adal(i,npy-2) = adal(i,npy-2)+adbl(i,npy-2)
        adq(i,npy-2) = adq(i,npy-2)-adbl(i,npy-2)
        adbl(i,npy-2) = 0.
      end do
    endif
    if (jord .eq. 11) then
      do j = js3, je3
        do i = ifirst, ilast
          xt = 2.*dm(i,j)
          bl(i,j) = -sign(min(abs(xt),abs(al(i,j)-q(i,j))),xt)
          br(i,j) = sign(min(abs(xt),abs(al(i,j+1)-q(i,j))),xt)
        end do
      end do
    else if (jord .eq. 12) then
      do j = js3, je3
        do i = ifirst, ilast
          pmp = -(2.*dq(i,j))
          lac = pmp+1.5*dq(i,j+1)
          bl(i,j) = min(max(0.,pmp,lac),max(al(i,j)-q(i,j),min(0.,pmp,lac)))
          pmp = 2.*dq(i,j-1)
          lac = pmp-1.5*dq(i,j-2)
          br(i,j) = min(max(0.,pmp,lac),max(al(i,j+1)-q(i,j),min(0.,pmp,lac)))
        end do
      end do
    else
      do j = js3, je3
        do i = ifirst, ilast
          bl(i,j) = al(i,j)-q(i,j)
          br(i,j) = al(i,j+1)-q(i,j)
        end do
      end do
    endif
    if (jord .ne. 11) then
      do j = js3, je3
        help_j = ilast-ifirst+1
        call pert_ppm( help_j,q(ifirst,j),bl(ifirst,j),br(ifirst,j),0 )
      end do
    endif
    if (js .eq. 1) then
      do i = ifirst, ilast
        br(i,2) = al(i,3)-q(i,2)
        xt = 0.5*((2.*dya(i,1)+dya(i,2))*(q(i,0)+q(i,1))-dya(i,1)*(q(i,-1)+q(i,2)))/(dya(i,1)+dya(i,2))
        if (edge_mono_kim) then
          if (i .gt. (-2) .and. i .lt. 1 .or. i .gt. npx-3 .and. i .lt. npx) then
            xt = min(xt,max(q(i,0),q(i,1),q(i-1,0),q(i-1,1)))
            xt = max(xt,min(q(i,0),q(i,1),q(i-1,0),q(i-1,1)))
          else if (i .lt. 3 .and. i .gt. 0 .or. i .gt. npx-1 .and. i .lt. npx+2) then
            xt = min(xt,max(q(i,0),q(i,1),q(i+1,0),q(i+1,1)))
            xt = max(xt,min(q(i,0),q(i,1),q(i+1,0),q(i+1,1)))
          else
            xt = max(0.,xt)
          endif
        else
          xt = max(0.,xt)
        endif
        bl(i,1) = xt-q(i,1)
        br(i,0) = xt-q(i,0)
        xt = 4./7.*dm(i,-1)+11./14.*q(i,-1)+3./14.*q(i,0)
        if (s_mono_kim) then
          xt = min(xt,max(q(i,-1),q(i,0)))
          xt = max(xt,min(q(i,-1),q(i,0)))
        else
          xt = max(0.,xt)
        endif
        bl(i,0) = xt-q(i,0)
        xt = 3./14.*q(i,1)+11./14.*q(i,2)-4./7.*dm(i,2)
        if (s_mono_kim) then
          xt = min(xt,max(q(i,1),q(i,2)))
          xt = max(xt,min(q(i,1),q(i,2)))
        else
          xt = max(0.,xt)
        endif
        br(i,1) = xt-q(i,1)
        bl(i,2) = xt-q(i,2)
      end do
      do j = 2, 0, -1
        do i = ifirst, ilast
          br(i,2) = al(i,3)-q(i,2)
          xt = 0.5*((2.*dya(i,1)+dya(i,2))*(q(i,0)+q(i,1))-dya(i,1)*(q(i,-1)+q(i,2)))/(dya(i,1)+dya(i,2))
          if (edge_mono_kim) then
            if (i .gt. (-2) .and. i .lt. 1 .or. i .gt. npx-3 .and. i .lt. npx) then
              xt = min(xt,max(q(i,0),q(i,1),q(i-1,0),q(i-1,1)))
              xt = max(xt,min(q(i,0),q(i,1),q(i-1,0),q(i-1,1)))
            else if (i .lt. 3 .and. i .gt. 0 .or. i .gt. npx-1 .and. i .lt. npx+2) then
              xt = min(xt,max(q(i,0),q(i,1),q(i+1,0),q(i+1,1)))
              xt = max(xt,min(q(i,0),q(i,1),q(i+1,0),q(i+1,1)))
            else
              xt = max(0.,xt)
            endif
          else
            xt = max(0.,xt)
          endif
          bl(i,1) = xt-q(i,1)
          br(i,0) = xt-q(i,0)
          xt = 4./7.*dm(i,-1)+11./14.*q(i,-1)+3./14.*q(i,0)
          if (s_mono_kim) then
            xt = min(xt,max(q(i,-1),q(i,0)))
            xt = max(xt,min(q(i,-1),q(i,0)))
          else
            xt = max(0.,xt)
          endif
          bl(i,0) = xt-q(i,0)
          xt = 3./14.*q(i,1)+11./14.*q(i,2)-4./7.*dm(i,2)
          if (s_mono_kim) then
            xt = min(xt,max(q(i,1),q(i,2)))
            xt = max(xt,min(q(i,1),q(i,2)))
          else
            xt = max(0.,xt)
          endif
          br(i,1) = xt-q(i,1)
          bl(i,2) = xt-q(i,2)
        end do
        do j3 = 0, j-1
          help_k = ilast-ifirst+1
          call pert_ppm( help_k,q(ifirst,j3),bl(ifirst,j3),br(ifirst,j3),1 )
        end do
        help_k = ilast-ifirst+1
        call adpert_ppm( help_k,q(ifirst,j),adq(ifirst,j),bl(ifirst,j),adbl(ifirst,j),br(ifirst,j),adbr(ifirst,j),1 )
      end do
      do i = ifirst, ilast
        adxt = 0.
        xt = 3./14.*q(i,1)+11./14.*q(i,2)-4./7.*dm(i,2)
        adq(i,2) = adq(i,2)-adbl(i,2)
        adxt = adxt+adbl(i,2)
        adbl(i,2) = 0.
        adq(i,1) = adq(i,1)-adbr(i,1)
        adxt = adxt+adbr(i,1)
        adbr(i,1) = 0.
        if (s_mono_kim) then
          xt = min(xt,max(q(i,1),q(i,2)))
          xty = min(q(i,1),q(i,2))
          adxty = adxt*(0.5-sign(0.5,xt-xty))
          adq(i,2) = adq(i,2)+adxty*(0.5-sign(0.5,q(i,2)-q(i,1)))
          adq(i,1) = adq(i,1)+adxty*(0.5+sign(0.5,q(i,2)-q(i,1)))
          adxt = adxt*(0.5+sign(0.5,xt-xty))
          xt = 3./14.*q(i,1)+11./14.*q(i,2)-4./7.*dm(i,2)
          xtz = max(q(i,1),q(i,2))
          adxtz = adxt*(0.5-sign(0.5,xtz-xt))
          adq(i,2) = adq(i,2)+adxtz*(0.5-sign(0.5,q(i,1)-q(i,2)))
          adq(i,1) = adq(i,1)+adxtz*(0.5+sign(0.5,q(i,1)-q(i,2)))
          adxt = adxt*(0.5+sign(0.5,xtz-xt))
        else
          adxt = adxt*(0.5-sign(0.5,0.-xt))
        endif
        addm(i,2) = addm(i,2)-0.57142857*adxt
        adq(i,2) = adq(i,2)+0.78571429*adxt
        adq(i,1) = adq(i,1)+0.21428571*adxt
        adxt = 0.
        adq(i,0) = adq(i,0)-adbl(i,0)
        adxt = adxt+adbl(i,0)
        adbl(i,0) = 0.
        xt = 4./7.*dm(i,-1)+11./14.*q(i,-1)+3./14.*q(i,0)
        if (s_mono_kim) then
          xt = min(xt,max(q(i,-1),q(i,0)))
          xtza = min(q(i,-1),q(i,0))
          adxtza = adxt*(0.5-sign(0.5,xt-xtza))
          adq(i,-1) = adq(i,-1)+adxtza*(0.5+sign(0.5,q(i,0)-q(i,-1)))
          adq(i,0) = adq(i,0)+adxtza*(0.5-sign(0.5,q(i,0)-q(i,-1)))
          adxt = adxt*(0.5+sign(0.5,xt-xtza))
          xt = 4./7.*dm(i,-1)+11./14.*q(i,-1)+3./14.*q(i,0)
          xtzb = max(q(i,-1),q(i,0))
          adxtzb = adxt*(0.5-sign(0.5,xtzb-xt))
          adq(i,-1) = adq(i,-1)+adxtzb*(0.5+sign(0.5,q(i,-1)-q(i,0)))
          adq(i,0) = adq(i,0)+adxtzb*(0.5-sign(0.5,q(i,-1)-q(i,0)))
          adxt = adxt*(0.5+sign(0.5,xtzb-xt))
        else
          adxt = adxt*(0.5-sign(0.5,0.-xt))
        endif
        addm(i,-1) = addm(i,-1)+0.57142857*adxt
        adq(i,-1) = adq(i,-1)+0.78571429*adxt
        adq(i,0) = adq(i,0)+0.21428571*adxt
        adxt = 0.
        adq(i,0) = adq(i,0)-adbr(i,0)
        adxt = adxt+adbr(i,0)
        adbr(i,0) = 0.
        adq(i,1) = adq(i,1)-adbl(i,1)
        adxt = adxt+adbl(i,1)
        adbl(i,1) = 0.
        xt = 0.5*((2.*dya(i,1)+dya(i,2))*(q(i,0)+q(i,1))-dya(i,1)*(q(i,-1)+q(i,2)))/(dya(i,1)+dya(i,2))
        if (edge_mono_kim) then
          if (i .gt. (-2) .and. i .lt. 1 .or. i .gt. npx-3 .and. i .lt. npx) then
            xt = min(xt,max(q(i,0),q(i,1),q(i-1,0),q(i-1,1)))
            xtzi = min(q(i,0),q(i,1))
            xtzj = min(xtzi,q(i-1,0))
            xtzk = min(xtzj,q(i-1,1))
            adxtzk = adxt*(0.5-sign(0.5,xt-xtzk))
            adq(i-1,1) = adq(i-1,1)+adxtzk*(0.5-sign(0.5,q(i-1,1)-xtzj))
            adxtzj = adxtzk*(0.5+sign(0.5,q(i-1,1)-xtzj))
            adq(i-1,0) = adq(i-1,0)+adxtzj*(0.5-sign(0.5,q(i-1,0)-xtzi))
            adxtzi = adxtzj*(0.5+sign(0.5,q(i-1,0)-xtzi))
            adq(i,1) = adq(i,1)+adxtzi*(0.5-sign(0.5,q(i,1)-q(i,0)))
            adq(i,0) = adq(i,0)+adxtzi*(0.5+sign(0.5,q(i,1)-q(i,0)))
            adxt = adxt*(0.5+sign(0.5,xt-xtzk))
            xt = 0.5*((2.*dya(i,1)+dya(i,2))*(q(i,0)+q(i,1))-dya(i,1)*(q(i,-1)+q(i,2)))/(dya(i,1)+dya(i,2))
            xtzl = max(q(i,0),q(i,1))
            xtzm = max(xtzl,q(i-1,0))
            xtzn = max(xtzm,q(i-1,1))
            adxtzn = adxt*(0.5-sign(0.5,xtzn-xt))
            adq(i-1,1) = adq(i-1,1)+adxtzn*(0.5-sign(0.5,xtzm-q(i-1,1)))
            adxtzm = adxtzn*(0.5+sign(0.5,xtzm-q(i-1,1)))
            adq(i-1,0) = adq(i-1,0)+adxtzm*(0.5-sign(0.5,xtzl-q(i-1,0)))
            adxtzl = adxtzm*(0.5+sign(0.5,xtzl-q(i-1,0)))
            adq(i,1) = adq(i,1)+adxtzl*(0.5-sign(0.5,q(i,0)-q(i,1)))
            adq(i,0) = adq(i,0)+adxtzl*(0.5+sign(0.5,q(i,0)-q(i,1)))
            adxt = adxt*(0.5+sign(0.5,xtzn-xt))
          else if (i .lt. 3 .and. i .gt. 0 .or. i .gt. npx-1 .and. i .lt. npx+2) then
            xt = min(xt,max(q(i,0),q(i,1),q(i+1,0),q(i+1,1)))
            xtzc = min(q(i,0),q(i,1))
            xtzd = min(xtzc,q(i+1,0))
            xtze = min(xtzd,q(i+1,1))
            adxtze = adxt*(0.5-sign(0.5,xt-xtze))
            adq(i+1,1) = adq(i+1,1)+adxtze*(0.5-sign(0.5,q(i+1,1)-xtzd))
            adxtzd = adxtze*(0.5+sign(0.5,q(i+1,1)-xtzd))
            adq(i+1,0) = adq(i+1,0)+adxtzd*(0.5-sign(0.5,q(i+1,0)-xtzc))
            adxtzc = adxtzd*(0.5+sign(0.5,q(i+1,0)-xtzc))
            adq(i,1) = adq(i,1)+adxtzc*(0.5-sign(0.5,q(i,1)-q(i,0)))
            adq(i,0) = adq(i,0)+adxtzc*(0.5+sign(0.5,q(i,1)-q(i,0)))
            adxt = adxt*(0.5+sign(0.5,xt-xtze))
            xt = 0.5*((2.*dya(i,1)+dya(i,2))*(q(i,0)+q(i,1))-dya(i,1)*(q(i,-1)+q(i,2)))/(dya(i,1)+dya(i,2))
            xtzf = max(q(i,0),q(i,1))
            xtzg = max(xtzf,q(i+1,0))
            xtzh = max(xtzg,q(i+1,1))
            adxtzh = adxt*(0.5-sign(0.5,xtzh-xt))
            adq(i+1,1) = adq(i+1,1)+adxtzh*(0.5-sign(0.5,xtzg-q(i+1,1)))
            adxtzg = adxtzh*(0.5+sign(0.5,xtzg-q(i+1,1)))
            adq(i+1,0) = adq(i+1,0)+adxtzg*(0.5-sign(0.5,xtzf-q(i+1,0)))
            adxtzf = adxtzg*(0.5+sign(0.5,xtzf-q(i+1,0)))
            adq(i,1) = adq(i,1)+adxtzf*(0.5-sign(0.5,q(i,0)-q(i,1)))
            adq(i,0) = adq(i,0)+adxtzf*(0.5+sign(0.5,q(i,0)-q(i,1)))
            adxt = adxt*(0.5+sign(0.5,xtzh-xt))
          else
            adxt = adxt*(0.5-sign(0.5,0.-xt))
          endif
        else
          adxt = adxt*(0.5-sign(0.5,0.-xt))
        endif
        adq(i,-1) = adq(i,-1)-adxt*(0.5*dya(i,1)/(dya(i,1)+dya(i,2)))
        adq(i,2) = adq(i,2)-adxt*(0.5*dya(i,1)/(dya(i,1)+dya(i,2)))
        adq(i,1) = adq(i,1)+adxt*(0.5*(2.*dya(i,1)+dya(i,2))/(dya(i,1)+dya(i,2)))
        adq(i,0) = adq(i,0)+adxt*(0.5*(2.*dya(i,1)+dya(i,2))/(dya(i,1)+dya(i,2)))
        adxt = 0.
        adal(i,3) = adal(i,3)+adbr(i,2)
        adq(i,2) = adq(i,2)-adbr(i,2)
        adbr(i,2) = 0.
      end do
    endif
    if (jord .eq. 11) then
      do j = js3, je3
        do i = ifirst, ilast
          xt = 2.*dm(i,j)
          bl(i,j) = -sign(min(abs(xt),abs(al(i,j)-q(i,j))),xt)
          br(i,j) = sign(min(abs(xt),abs(al(i,j+1)-q(i,j))),xt)
        end do
      end do
    else if (jord .eq. 12) then
      do j = js3, je3
        do i = ifirst, ilast
          pmp = -(2.*dq(i,j))
          lac = pmp+1.5*dq(i,j+1)
          bl(i,j) = min(max(0.,pmp,lac),max(al(i,j)-q(i,j),min(0.,pmp,lac)))
          pmp = 2.*dq(i,j-1)
          lac = pmp-1.5*dq(i,j-2)
          br(i,j) = min(max(0.,pmp,lac),max(al(i,j+1)-q(i,j),min(0.,pmp,lac)))
        end do
      end do
    else
      do j = js3, je3
        do i = ifirst, ilast
          bl(i,j) = al(i,j)-q(i,j)
          br(i,j) = al(i,j+1)-q(i,j)
        end do
      end do
    endif
    if (jord .ne. 11) then
      do j = je3, js3, -1
        if (jord .eq. 11) then
          do ja4 = js3, je3
            do i = ifirst, ilast
              xt = 2.*dm(i,ja4)
              bl(i,ja4) = -sign(min(abs(xt),abs(al(i,ja4)-q(i,ja4))),xt)
              br(i,ja4) = sign(min(abs(xt),abs(al(i,ja4+1)-q(i,ja4))),xt)
            end do
          end do
        else if (jord .eq. 12) then
          do ja4 = js3, je3
            do i = ifirst, ilast
              pmp = -(2.*dq(i,ja4))
              lac = pmp+1.5*dq(i,ja4+1)
              bl(i,ja4) = min(max(0.,pmp,lac),max(al(i,ja4)-q(i,ja4),min(0.,pmp,lac)))
              pmp = 2.*dq(i,ja4-1)
              lac = pmp-1.5*dq(i,ja4-2)
              br(i,ja4) = min(max(0.,pmp,lac),max(al(i,ja4+1)-q(i,ja4),min(0.,pmp,lac)))
            end do
          end do
        else
          do ja4 = js3, je3
            do i = ifirst, ilast
              bl(i,ja4) = al(i,ja4)-q(i,ja4)
              br(i,ja4) = al(i,ja4+1)-q(i,ja4)
            end do
          end do
        endif
        do j4 = js3, j-1
          help_j = ilast-ifirst+1
          call pert_ppm( help_j,q(ifirst,j4),bl(ifirst,j4),br(ifirst,j4),0 )
        end do
        help_j = ilast-ifirst+1
        call adpert_ppm( help_j,q(ifirst,j),adq(ifirst,j),bl(ifirst,j),adbl(ifirst,j),br(ifirst,j),adbr(ifirst,j),0 )
      end do
    endif
    if (jord .eq. 11) then
      do j = js3, je3
        adxt = 0.
        do i = ifirst, ilast
          adxt = 0.
          xt = 2.*dm(i,j)
          brt = al(i,j+1)-q(i,j)
          adbrt = adbr(i,j)*sign(1.,min(abs(xt),abs(brt)))*sign(1.,xt)
          adbru = adbrt*(0.5-sign(0.5,abs(brt)-abs(xt)))*sign(1.,brt)
          adxt = adxt+adbrt*(0.5+sign(0.5,abs(brt)-abs(xt)))*sign(1.,xt)
          adal(i,j+1) = adal(i,j+1)+adbru
          adq(i,j) = adq(i,j)-adbru
          adbr(i,j) = 0.
          blt = al(i,j)-q(i,j)
          adblt = -(adbl(i,j)*sign(1.,min(abs(xt),abs(blt)))*sign(1.,xt))
          adblu = adblt*(0.5-sign(0.5,abs(blt)-abs(xt)))*sign(1.,blt)
          adxt = adxt+adblt*(0.5+sign(0.5,abs(blt)-abs(xt)))*sign(1.,xt)
          adal(i,j) = adal(i,j)+adblu
          adq(i,j) = adq(i,j)-adblu
          adbl(i,j) = 0.
          addm(i,j) = addm(i,j)+2*adxt
          adxt = 0.
        end do
      end do
    else if (jord .eq. 12) then
      do j = js3, je3
        adlac = 0.
        adpmp = 0.
        do i = ifirst, ilast
          adlac = 0.
          adpmp = 0.
          pmp = 2.*dq(i,j-1)
          lac = pmp-1.5*dq(i,j-2)
          brm = max(0.,pmp)
          bro = max(brm,lac)
          brq = min(0.,pmp)
          brr = min(brq,lac)
          brp = max(al(i,j+1)-q(i,j),brr)
          adbrp = adbr(i,j)*(0.5+sign(0.5,brp-bro))
          adbrq = adbr(i,j)*(0.5-sign(0.5,brp-bro))
          adal(i,j+1) = adal(i,j+1)+adbrq*(0.5+sign(0.5,al(i,j+1)-q(i,j)-brr))
          adbrs = adbrq*(0.5-sign(0.5,al(i,j+1)-q(i,j)-brr))
          adq(i,j) = adq(i,j)-adbrq*(0.5+sign(0.5,al(i,j+1)-q(i,j)-brr))
          adbrr = adbrs*(0.5+sign(0.5,lac-brq))
          adlac = adlac+adbrs*(0.5-sign(0.5,lac-brq))
          adpmp = adpmp+adbrr*(0.5-sign(0.5,pmp-0.))
          adbro = adbrp*(0.5+sign(0.5,brm-lac))
          adlac = adlac+adbrp*(0.5-sign(0.5,brm-lac))
          adpmp = adpmp+adbro*(0.5-sign(0.5,0.-pmp))
          adbr(i,j) = 0.
          addq(i,j-2) = addq(i,j-2)-1.5*adlac
          adpmp = adpmp+adlac
          adlac = 0.
          addq(i,j-1) = addq(i,j-1)+2*adpmp
          adpmp = 0.
          pmp = -(2.*dq(i,j))
          lac = pmp+1.5*dq(i,j+1)
          blm = max(0.,pmp)
          blo = max(blm,lac)
          blq = min(0.,pmp)
          blr = min(blq,lac)
          blp = max(al(i,j)-q(i,j),blr)
          adblp = adbl(i,j)*(0.5+sign(0.5,blp-blo))
          adblq = adbl(i,j)*(0.5-sign(0.5,blp-blo))
          adal(i,j) = adal(i,j)+adblq*(0.5+sign(0.5,al(i,j)-q(i,j)-blr))
          adbls = adblq*(0.5-sign(0.5,al(i,j)-q(i,j)-blr))
          adq(i,j) = adq(i,j)-adblq*(0.5+sign(0.5,al(i,j)-q(i,j)-blr))
          adblr = adbls*(0.5+sign(0.5,lac-blq))
          adlac = adlac+adbls*(0.5-sign(0.5,lac-blq))
          adpmp = adpmp+adblr*(0.5-sign(0.5,pmp-0.))
          adblo = adblp*(0.5+sign(0.5,blm-lac))
          adlac = adlac+adblp*(0.5-sign(0.5,blm-lac))
          adpmp = adpmp+adblo*(0.5-sign(0.5,0.-pmp))
          adbl(i,j) = 0.
          addq(i,j+1) = addq(i,j+1)+1.5*adlac
          adpmp = adpmp+adlac
          adlac = 0.
          addq(i,j) = addq(i,j)-2*adpmp
          adpmp = 0.
        end do
      end do
      do j = js-3, je+2
        do i = ifirst, ilast
          adq(i,j+1) = adq(i,j+1)+addq(i,j)
          adq(i,j) = adq(i,j)-addq(i,j)
          addq(i,j) = 0.
        end do
      end do
    else
      do j = js3, je3
        do i = ifirst, ilast
          adal(i,j+1) = adal(i,j+1)+adbr(i,j)
          adq(i,j) = adq(i,j)-adbr(i,j)
          adbr(i,j) = 0.
          adal(i,j) = adal(i,j)+adbl(i,j)
          adq(i,j) = adq(i,j)-adbl(i,j)
          adbl(i,j) = 0.
        end do
      end do
    endif
    do j = js3, min(npy-2,je+2)
      do i = ifirst, ilast
        addm(i,j-1) = addm(i,j-1)+adal(i,j)*r3
        addm(i,j) = addm(i,j)-adal(i,j)*r3
        adq(i,j-1) = adq(i,j-1)+0.5*adal(i,j)
        adq(i,j) = adq(i,j)+0.5*adal(i,j)
        adal(i,j) = 0.
      end do
    end do
  else
    if (jord .eq. 11) then
      do j = js-1, je+1
        do i = ifirst, ilast
          xt = 2.*dm(i,j)
          bl(i,j) = -sign(min(abs(xt),abs(al(i,j)-q(i,j))),xt)
          br(i,j) = sign(min(abs(xt),abs(al(i,j+1)-q(i,j))),xt)
        end do
      end do
    else if (jord .eq. 12) then
      do j = js-1, je+1
        do i = ifirst, ilast
          pmp = -(2.*dq(i,j))
          lac = pmp+1.5*dq(i,j+1)
          bl(i,j) = min(max(0.,pmp,lac),max(al(i,j)-q(i,j),min(0.,pmp,lac)))
          pmp = 2.*dq(i,j-1)
          lac = pmp-1.5*dq(i,j-2)
          br(i,j) = min(max(0.,pmp,lac),max(al(i,j+1)-q(i,j),min(0.,pmp,lac)))
        end do
      end do
    else
      do j = js-1, je+1
        do i = ifirst, ilast
          bl(i,j) = al(i,j)-q(i,j)
          br(i,j) = al(i,j+1)-q(i,j)
        end do
      end do
    endif
    if (jord .ne. 11) then
      do j = je+1, js-1, -1
        if (jord .eq. 11) then
          do ja1 = js-1, je+1
            do i = ifirst, ilast
              xt = 2.*dm(i,ja1)
              bl(i,ja1) = -sign(min(abs(xt),abs(al(i,ja1)-q(i,ja1))),xt)
              br(i,ja1) = sign(min(abs(xt),abs(al(i,ja1+1)-q(i,ja1))),xt)
            end do
          end do
        else if (jord .eq. 12) then
          do ja1 = js-1, je+1
            do i = ifirst, ilast
              pmp = -(2.*dq(i,ja1))
              lac = pmp+1.5*dq(i,ja1+1)
              bl(i,ja1) = min(max(0.,pmp,lac),max(al(i,ja1)-q(i,ja1),min(0.,pmp,lac)))
              pmp = 2.*dq(i,ja1-1)
              lac = pmp-1.5*dq(i,ja1-2)
              br(i,ja1) = min(max(0.,pmp,lac),max(al(i,ja1+1)-q(i,ja1),min(0.,pmp,lac)))
            end do
          end do
        else
          do ja1 = js-1, je+1
            do i = ifirst, ilast
              bl(i,ja1) = al(i,ja1)-q(i,ja1)
              br(i,ja1) = al(i,ja1+1)-q(i,ja1)
            end do
          end do
        endif
        do j1 = js-1, j-1
          help_m = ilast-ifirst+1
          call pert_ppm( help_m,q(ifirst,j1),bl(ifirst,j1),br(ifirst,j1),0 )
        end do
        help_m = ilast-ifirst+1
        call adpert_ppm( help_m,q(ifirst,j),adq(ifirst,j),bl(ifirst,j),adbl(ifirst,j),br(ifirst,j),adbr(ifirst,j),0 )
      end do
    endif
    if (jord .eq. 11) then
      do j = js-1, je+1
        adxt = 0.
        do i = ifirst, ilast
          adxt = 0.
          xt = 2.*dm(i,j)
          brn = al(i,j+1)-q(i,j)
          adbrm = adbr(i,j)*sign(1.,min(abs(xt),abs(brn)))*sign(1.,xt)
          adbrn = adbrm*(0.5-sign(0.5,abs(brn)-abs(xt)))*sign(1.,brn)
          adxt = adxt+adbrm*(0.5+sign(0.5,abs(brn)-abs(xt)))*sign(1.,xt)
          adal(i,j+1) = adal(i,j+1)+adbrn
          adq(i,j) = adq(i,j)-adbrn
          adbr(i,j) = 0.
          bln = al(i,j)-q(i,j)
          adblm = -(adbl(i,j)*sign(1.,min(abs(xt),abs(bln)))*sign(1.,xt))
          adbln = adblm*(0.5-sign(0.5,abs(bln)-abs(xt)))*sign(1.,bln)
          adxt = adxt+adblm*(0.5+sign(0.5,abs(bln)-abs(xt)))*sign(1.,xt)
          adal(i,j) = adal(i,j)+adbln
          adq(i,j) = adq(i,j)-adbln
          adbl(i,j) = 0.
          addm(i,j) = addm(i,j)+2*adxt
          adxt = 0.
        end do
      end do
    else if (jord .eq. 12) then
      do j = js-1, je+1
        adlac = 0.
        adpmp = 0.
        do i = ifirst, ilast
          adlac = 0.
          adpmp = 0.
          pmp = 2.*dq(i,j-1)
          lac = pmp-1.5*dq(i,j-2)
          brh = max(0.,pmp)
          bri = max(brh,lac)
          brk = min(0.,pmp)
          brl = min(brk,lac)
          brj = max(al(i,j+1)-q(i,j),brl)
          adbri = adbr(i,j)*(0.5+sign(0.5,brj-bri))
          adbrj = adbr(i,j)*(0.5-sign(0.5,brj-bri))
          adal(i,j+1) = adal(i,j+1)+adbrj*(0.5+sign(0.5,al(i,j+1)-q(i,j)-brl))
          adbrl = adbrj*(0.5-sign(0.5,al(i,j+1)-q(i,j)-brl))
          adq(i,j) = adq(i,j)-adbrj*(0.5+sign(0.5,al(i,j+1)-q(i,j)-brl))
          adbrk = adbrl*(0.5+sign(0.5,lac-brk))
          adlac = adlac+adbrl*(0.5-sign(0.5,lac-brk))
          adpmp = adpmp+adbrk*(0.5-sign(0.5,pmp-0.))
          adbrh = adbri*(0.5+sign(0.5,brh-lac))
          adlac = adlac+adbri*(0.5-sign(0.5,brh-lac))
          adpmp = adpmp+adbrh*(0.5-sign(0.5,0.-pmp))
          adbr(i,j) = 0.
          addq(i,j-2) = addq(i,j-2)-1.5*adlac
          adpmp = adpmp+adlac
          adlac = 0.
          addq(i,j-1) = addq(i,j-1)+2*adpmp
          adpmp = 0.
          pmp = -(2.*dq(i,j))
          lac = pmp+1.5*dq(i,j+1)
          blh = max(0.,pmp)
          bli = max(blh,lac)
          blk = min(0.,pmp)
          bll = min(blk,lac)
          blj = max(al(i,j)-q(i,j),bll)
          adbli = adbl(i,j)*(0.5+sign(0.5,blj-bli))
          adblj = adbl(i,j)*(0.5-sign(0.5,blj-bli))
          adal(i,j) = adal(i,j)+adblj*(0.5+sign(0.5,al(i,j)-q(i,j)-bll))
          adbll = adblj*(0.5-sign(0.5,al(i,j)-q(i,j)-bll))
          adq(i,j) = adq(i,j)-adblj*(0.5+sign(0.5,al(i,j)-q(i,j)-bll))
          adblk = adbll*(0.5+sign(0.5,lac-blk))
          adlac = adlac+adbll*(0.5-sign(0.5,lac-blk))
          adpmp = adpmp+adblk*(0.5-sign(0.5,pmp-0.))
          adblh = adbli*(0.5+sign(0.5,blh-lac))
          adlac = adlac+adbli*(0.5-sign(0.5,blh-lac))
          adpmp = adpmp+adblh*(0.5-sign(0.5,0.-pmp))
          adbl(i,j) = 0.
          addq(i,j+1) = addq(i,j+1)+1.5*adlac
          adpmp = adpmp+adlac
          adlac = 0.
          addq(i,j) = addq(i,j)-2*adpmp
          adpmp = 0.
        end do
      end do
      do j = js-3, je+2
        do i = ifirst, ilast
          adq(i,j+1) = adq(i,j+1)+addq(i,j)
          adq(i,j) = adq(i,j)-addq(i,j)
          addq(i,j) = 0.
        end do
      end do
    else
      do j = js-1, je+1
        do i = ifirst, ilast
          adal(i,j+1) = adal(i,j+1)+adbr(i,j)
          adq(i,j) = adq(i,j)-adbr(i,j)
          adbr(i,j) = 0.
          adal(i,j) = adal(i,j)+adbl(i,j)
          adq(i,j) = adq(i,j)-adbl(i,j)
          adbl(i,j) = 0.
        end do
      end do
    endif
    do j = js-1, je+2
      do i = ifirst, ilast
        addm(i,j-1) = addm(i,j-1)+adal(i,j)*r3
        addm(i,j) = addm(i,j)-adal(i,j)*r3
        adq(i,j-1) = adq(i,j-1)+0.5*adal(i,j)
        adq(i,j) = adq(i,j)+0.5*adal(i,j)
        adal(i,j) = 0.
      end do
    end do
  endif
  do j = js-2, je+2
    adxt = 0.
    do i = ifirst, ilast
      adxt = 0.
      xt = 0.25*(q(i,j+1)-q(i,j-1))
      dmh = abs(xt)
      dmi = max(q(i,j-1),q(i,j))
      dmk = max(dmi,q(i,j+1))-q(i,j)
      dml = min(q(i,j-1),q(i,j))
      dmn = q(i,j)-min(dml,q(i,j+1))
      dmo = min(dmh,dmk)
      addmp = addm(i,j)*sign(1.,min(dmo,dmn))*sign(1.,xt)
      addmn = addmp*(0.5-sign(0.5,dmn-dmo))
      addmo = addmp*(0.5+sign(0.5,dmn-dmo))
      addmh = addmo*(0.5+sign(0.5,dmk-dmh))
      addmk = addmo*(0.5-sign(0.5,dmk-dmh))
      addmm = -addmn
      adq(i,j) = adq(i,j)+addmn
      addml = addmm*(0.5+sign(0.5,q(i,j+1)-dml))
      adq(i,j+1) = adq(i,j+1)+addmm*(0.5-sign(0.5,q(i,j+1)-dml))
      adq(i,j-1) = adq(i,j-1)+addml*(0.5+sign(0.5,q(i,j)-q(i,j-1)))
      adq(i,j) = adq(i,j)+addml*(0.5-sign(0.5,q(i,j)-q(i,j-1)))
      adq(i,j) = adq(i,j)-addmk
      addmi = addmk*(0.5+sign(0.5,dmi-q(i,j+1)))
      adq(i,j+1) = adq(i,j+1)+addmk*(0.5-sign(0.5,dmi-q(i,j+1)))
      adq(i,j-1) = adq(i,j-1)+addmi*(0.5+sign(0.5,q(i,j-1)-q(i,j)))
      adq(i,j) = adq(i,j)+addmi*(0.5-sign(0.5,q(i,j-1)-q(i,j)))
      adxt = adxt+addmh*sign(1.,xt)
      addm(i,j) = 0.
      adq(i,j-1) = adq(i,j-1)-0.25*adxt
      adq(i,j+1) = adq(i,j+1)+0.25*adxt
      adxt = 0.
    end do
  end do
endif

end subroutine adfyppm


subroutine adpert_ppm( im, a0, ada0, al, adal, ar, adar, iv )
!******************************************************************
!******************************************************************
!** This routine was generated by Automatic differentiation.     **
!** FastOpt: Transformation of Algorithm in Fortran, TAF 1.9.22  **
!******************************************************************
!******************************************************************
!==============================================
! all entries are defined explicitly
!==============================================
implicit none

!==============================================
! declare parameters
!==============================================
real, parameter :: r12 = 1./12.

!==============================================
! declare arguments
!==============================================
integer, intent(in) :: im
real, intent(in) :: a0(im)
real, intent(inout) :: ada0(im)
real, intent(inout) :: adal(im)
real, intent(inout) :: adar(im)
real, intent(inout) :: al(im)
real, intent(inout) :: ar(im)
integer, intent(in) :: iv

!==============================================
! declare local variables
!==============================================
real :: a4
real :: a6da
real :: ada4
real :: ada6da
real :: adda1
real :: adda2
real :: adfmin
real :: da1
real :: da2
real :: fmin
integer :: i

!----------------------------------------------
! RESET LOCAL ADJOINT VARIABLES
!----------------------------------------------
ada4 = 0.
ada6da = 0.
adda1 = 0.
adda2 = 0.
adfmin = 0.

!----------------------------------------------
! ROUTINE BODY
!----------------------------------------------
if (iv .eq. 0) then
  do i = 1, im
    ada4 = 0.
    adda1 = 0.
    adfmin = 0.
    a4 = -(3.*(ar(i)+al(i)))
    da1 = ar(i)-al(i)
    if (abs(da1) .lt. (-a4)) then
      fmin = a0(i)+0.25/a4*da1**2+a4*r12
      if (fmin .lt. 0.) then
        if (ar(i) .gt. 0. .and. al(i) .gt. 0.) then
          adal(i) = 0.
          adar(i) = 0.
        else if (da1 .gt. 0.) then
          adal(i) = adal(i)-2*adar(i)
          adar(i) = 0.
        else
          adar(i) = adar(i)-2*adal(i)
          adal(i) = 0.
        endif
      endif
      ada0(i) = ada0(i)+adfmin
      ada4 = ada4+adfmin*((-(0.25/(a4*a4)*da1**2))+r12)
      adda1 = adda1+2*adfmin*0.25/a4*da1
      adfmin = 0.
    endif
    adal(i) = adal(i)-adda1
    adar(i) = adar(i)+adda1
    adda1 = 0.
    adal(i) = adal(i)-3*ada4
    adar(i) = adar(i)-3*ada4
    ada4 = 0.
  end do
else
  do i = 1, im
    ada6da = 0.
    adda1 = 0.
    adda2 = 0.
    if (al(i)*ar(i) .lt. 0.) then
      da1 = al(i)-ar(i)
      da2 = da1**2
      a6da = 3.*(al(i)+ar(i))*da1
      if (a6da .lt. (-da2)) then
        adal(i) = adal(i)-2*adar(i)
        adar(i) = 0.
      else if (a6da .gt. da2) then
        adar(i) = adar(i)-2*adal(i)
        adal(i) = 0.
      endif
      adal(i) = adal(i)+3*ada6da*da1
      adar(i) = adar(i)+3*ada6da*da1
      adda1 = adda1+3*ada6da*(al(i)+ar(i))
      ada6da = 0.
      adda1 = adda1+2*adda2*da1
      adda2 = 0.
      adal(i) = adal(i)+adda1
      adar(i) = adar(i)-adda1
      adda1 = 0.
    else
      adar(i) = 0.
      adal(i) = 0.
    endif
  end do
endif

end subroutine adpert_ppm


subroutine adxmist_2d( q, adq, dm, addm, ng, iord, ifirst, ilast, jfirst, jlast )
!******************************************************************
!******************************************************************
!** This routine was generated by Automatic differentiation.     **
!** FastOpt: Transformation of Algorithm in Fortran, TAF 1.9.22  **
!******************************************************************
!******************************************************************
!==============================================
! all entries are defined explicitly
!==============================================
implicit none

!==============================================
! declare arguments
!==============================================
integer, intent(in) :: ifirst
integer, intent(in) :: ilast
integer, intent(in) :: jfirst
integer, intent(in) :: jlast
integer, intent(in) :: ng
real, intent(inout) :: addm(ifirst-ng:ilast+ng,jfirst:jlast)
real, intent(inout) :: adq(ifirst-ng:ilast+ng,jfirst:jlast)
real, intent(inout) :: dm(ifirst-ng:ilast+ng,jfirst:jlast)
integer, intent(in) :: iord
real, intent(in) :: q(ifirst-ng:ilast+ng,jfirst:jlast)

!==============================================
! declare local variables
!==============================================
real :: addmh
real :: addmi
real :: addmj
real :: adqmax
real :: adqmaxi
real :: adqmin
real :: adqminh
real :: adqmini
real :: dmh
real :: dmi
integer :: i
integer :: j
real :: qmax
real :: qmaxi
real :: qmin
real :: qmini

!----------------------------------------------
! RESET LOCAL ADJOINT VARIABLES
!----------------------------------------------
adqmax = 0.
adqmin = 0.

!----------------------------------------------
! ROUTINE BODY
!----------------------------------------------
do j = jfirst, jlast
  do i = ifirst-ng+1, ilast+ng-1
    dm(i,j) = 0.25*(q(i+1,j)-q(i-1,j))
  end do
end do
if (iord .gt. 0) then
  do j = jfirst, jlast
    adqmax = 0.
    adqmin = 0.
    do i = ifirst-ng+1, ilast+ng-1
      adqmax = 0.
      adqmin = 0.
      qmax = max(max(q(i-1,j),q(i,j)),q(i+1,j))-q(i,j)
      qmin = q(i,j)-min(min(q(i-1,j),q(i,j)),q(i+1,j))
      dmh = abs(dm(i,j))
      dmi = min(dmh,qmin)
      addmj = addm(i,j)*sign(1.,min(dmi,qmax))*sign(1.,dm(i,j))
      addmi = addmj*(0.5+sign(0.5,qmax-dmi))
      adqmax = adqmax+addmj*(0.5-sign(0.5,qmax-dmi))
      addmh = addmi*(0.5+sign(0.5,qmin-dmh))
      adqmin = adqmin+addmi*(0.5-sign(0.5,qmin-dmh))
      addm(i,j) = addmh*sign(1.,dm(i,j))
      qmini = min(q(i-1,j),q(i,j))
      adq(i,j) = adq(i,j)+adqmin
      adqminh = -adqmin
      adq(i+1,j) = adq(i+1,j)+adqminh*(0.5-sign(0.5,q(i+1,j)-qmini))
      adqmini = adqminh*(0.5+sign(0.5,q(i+1,j)-qmini))
      adq(i-1,j) = adq(i-1,j)+adqmini*(0.5+sign(0.5,q(i,j)-q(i-1,j)))
      adq(i,j) = adq(i,j)+adqmini*(0.5-sign(0.5,q(i,j)-q(i-1,j)))
      adqmin = 0.
      qmaxi = max(q(i-1,j),q(i,j))
      adq(i,j) = adq(i,j)-adqmax
      adq(i+1,j) = adq(i+1,j)+adqmax*(0.5-sign(0.5,qmaxi-q(i+1,j)))
      adqmaxi = adqmax*(0.5+sign(0.5,qmaxi-q(i+1,j)))
      adq(i-1,j) = adq(i-1,j)+adqmaxi*(0.5+sign(0.5,q(i-1,j)-q(i,j)))
      adq(i,j) = adq(i,j)+adqmaxi*(0.5-sign(0.5,q(i-1,j)-q(i,j)))
      adqmax = 0.
    end do
  end do
endif
do j = jfirst, jlast
  do i = ifirst-ng+1, ilast+ng-1
    adq(i-1,j) = adq(i-1,j)-0.25*addm(i,j)
    adq(i+1,j) = adq(i+1,j)+0.25*addm(i,j)
    addm(i,j) = 0.
  end do
end do

end subroutine adxmist_2d


subroutine adxtp( adfx, q, adq, c, adc, iord, ifirst, ilast, jfirst, jlast, npx, npy, uniform_ppm )
!******************************************************************
!******************************************************************
!** This routine was generated by Automatic differentiation.     **
!** FastOpt: Transformation of Algorithm in Fortran, TAF 1.9.22  **
!******************************************************************
!******************************************************************
!==============================================
! all entries are defined explicitly
!==============================================
implicit none

!==============================================
! declare arguments
!==============================================
integer, intent(in) :: jfirst
integer, intent(in) :: jlast
real, intent(inout) :: adc(is:ie+1,jfirst:jlast)
integer, intent(in) :: ifirst
integer, intent(in) :: ilast
real, intent(inout) :: adfx(ifirst:ilast+1,jfirst:jlast)
real, intent(inout) :: adq(isd:ied,jfirst:jlast)
real, intent(in) :: c(is:ie+1,jfirst:jlast)
integer, intent(in) :: iord
integer, intent(in) :: npx
integer, intent(in) :: npy
real, intent(in) :: q(isd:ied,jfirst:jlast)
logical, intent(in) :: uniform_ppm

!==============================================
! declare local variables
!==============================================
real :: addm(ifirst-ng:ilast+ng,jfirst:jlast)
real :: dm(ifirst-ng:ilast+ng,jfirst:jlast)
integer :: i
integer :: iu
integer :: j

!----------------------------------------------
! RESET LOCAL ADJOINT VARIABLES
!----------------------------------------------
addm(:,:) = 0.

!----------------------------------------------
! ROUTINE BODY
!----------------------------------------------
if (iord .eq. 1) then
  do j = jfirst, jlast
    do i = ifirst, ilast+1
      iu = floor(real(i)-c(i,j))
      adq(iu,j) = adq(iu,j)+adfx(i,j)
      adfx(i,j) = 0.
    end do
  end do
else if (abs(iord) .eq. 2) then
  call xmist_2d( q,dm,ng,iord,ifirst,ilast,jfirst,jlast )
  do j = jfirst, jlast
    do i = ifirst, ilast+1
      iu = floor(real(i)-c(i,j))
      adc(i,j) = adc(i,j)-adfx(i,j)*dm(iu,j)
      addm(iu,j) = addm(iu,j)+adfx(i,j)*(sign(1.,c(i,j))-c(i,j))
      adq(iu,j) = adq(iu,j)+adfx(i,j)
      adfx(i,j) = 0.
    end do
  end do
  call adxmist_2d( q,adq,dm,addm,ng,iord,ifirst,ilast,jfirst,jlast )
else
  call adfxppm( c,adc,q,adq,adfx,iord,ifirst,ilast,jfirst,jlast,npx,npy,uniform_ppm )
endif

end subroutine adxtp


subroutine adymist( q, adq, dm, addm, ng, jord, ifirst, ilast, jfirst, jlast )
!******************************************************************
!******************************************************************
!** This routine was generated by Automatic differentiation.     **
!** FastOpt: Transformation of Algorithm in Fortran, TAF 1.9.22  **
!******************************************************************
!******************************************************************
!==============================================
! all entries are defined explicitly
!==============================================
implicit none

!==============================================
! declare arguments
!==============================================
integer, intent(in) :: ifirst
integer, intent(in) :: ilast
integer, intent(in) :: jfirst
integer, intent(in) :: jlast
integer, intent(in) :: ng
real, intent(inout) :: addm(ifirst:ilast,jfirst-ng:jlast+ng)
real, intent(inout) :: adq(ifirst:ilast,jfirst-ng:jlast+ng)
real, intent(inout) :: dm(ifirst:ilast,jfirst-ng:jlast+ng)
integer, intent(in) :: jord
real, intent(in) :: q(ifirst:ilast,jfirst-ng:jlast+ng)

!==============================================
! declare local variables
!==============================================
real :: addmh
real :: addmi
real :: addmj
real :: adqmax
real :: adqmaxi
real :: adqmin
real :: adqminh
real :: adqmini
real :: dmh
real :: dmi
integer :: i
integer :: j
real :: qmax
real :: qmaxi
real :: qmin
real :: qmini

!----------------------------------------------
! RESET LOCAL ADJOINT VARIABLES
!----------------------------------------------
adqmax = 0.
adqmin = 0.

!----------------------------------------------
! ROUTINE BODY
!----------------------------------------------
do j = jfirst-ng+1, jlast+ng-1
  do i = ifirst, ilast
    dm(i,j) = 0.25*(q(i,j+1)-q(i,j-1))
  end do
end do
if (jord .gt. 0) then
  do j = jfirst-ng+1, jlast+ng-1
    adqmax = 0.
    adqmin = 0.
    do i = ifirst, ilast
      adqmax = 0.
      adqmin = 0.
      qmax = max(max(q(i,j-1),q(i,j)),q(i,j+1))-q(i,j)
      qmin = q(i,j)-min(min(q(i,j-1),q(i,j)),q(i,j+1))
      dmh = abs(dm(i,j))
      dmi = min(dmh,qmin)
      addmj = addm(i,j)*sign(1.,min(dmi,qmax))*sign(1.,dm(i,j))
      addmi = addmj*(0.5+sign(0.5,qmax-dmi))
      adqmax = adqmax+addmj*(0.5-sign(0.5,qmax-dmi))
      addmh = addmi*(0.5+sign(0.5,qmin-dmh))
      adqmin = adqmin+addmi*(0.5-sign(0.5,qmin-dmh))
      addm(i,j) = addmh*sign(1.,dm(i,j))
      qmini = min(q(i,j-1),q(i,j))
      adq(i,j) = adq(i,j)+adqmin
      adqminh = -adqmin
      adq(i,j+1) = adq(i,j+1)+adqminh*(0.5-sign(0.5,q(i,j+1)-qmini))
      adqmini = adqminh*(0.5+sign(0.5,q(i,j+1)-qmini))
      adq(i,j-1) = adq(i,j-1)+adqmini*(0.5+sign(0.5,q(i,j)-q(i,j-1)))
      adq(i,j) = adq(i,j)+adqmini*(0.5-sign(0.5,q(i,j)-q(i,j-1)))
      adqmin = 0.
      qmaxi = max(q(i,j-1),q(i,j))
      adq(i,j) = adq(i,j)-adqmax
      adq(i,j+1) = adq(i,j+1)+adqmax*(0.5-sign(0.5,qmaxi-q(i,j+1)))
      adqmaxi = adqmax*(0.5+sign(0.5,qmaxi-q(i,j+1)))
      adq(i,j-1) = adq(i,j-1)+adqmaxi*(0.5+sign(0.5,q(i,j-1)-q(i,j)))
      adq(i,j) = adq(i,j)+adqmaxi*(0.5-sign(0.5,q(i,j-1)-q(i,j)))
      adqmax = 0.
    end do
  end do
endif
do j = jfirst-ng+1, jlast+ng-1
  do i = ifirst, ilast
    adq(i,j-1) = adq(i,j-1)-0.25*addm(i,j)
    adq(i,j+1) = adq(i,j+1)+0.25*addm(i,j)
    addm(i,j) = 0.
  end do
end do

end subroutine adymist


subroutine adytp( adfy, q, adq, c, adc, jord, ifirst, ilast, jfirst, jlast, npx, npy, uniform_ppm )
!******************************************************************
!******************************************************************
!** This routine was generated by Automatic differentiation.     **
!** FastOpt: Transformation of Algorithm in Fortran, TAF 1.9.22  **
!******************************************************************
!******************************************************************
!==============================================
! all entries are defined explicitly
!==============================================
implicit none

!==============================================
! declare arguments
!==============================================
real, intent(inout) :: adc(isd:ied,js:je+1)
integer, intent(in) :: ifirst
integer, intent(in) :: ilast
integer, intent(in) :: jfirst
integer, intent(in) :: jlast
real, intent(inout) :: adfy(ifirst:ilast,jfirst:jlast+1)
real, intent(inout) :: adq(ifirst:ilast,jfirst-ng:jlast+ng)
real, intent(in) :: c(isd:ied,js:je+1)
integer, intent(in) :: jord
integer, intent(in) :: npx
integer, intent(in) :: npy
real, intent(in) :: q(ifirst:ilast,jfirst-ng:jlast+ng)
logical, intent(in) :: uniform_ppm

!==============================================
! declare local variables
!==============================================
real :: addm(ifirst:ilast,jfirst-ng:jlast+ng)
real :: dm(ifirst:ilast,jfirst-ng:jlast+ng)
integer :: i
integer :: j
integer :: jt

!----------------------------------------------
! RESET LOCAL ADJOINT VARIABLES
!----------------------------------------------
addm(:,:) = 0.

!----------------------------------------------
! ROUTINE BODY
!----------------------------------------------
if (jord .eq. 1) then
  do j = jfirst, jlast+1
    do i = ifirst, ilast
      jt = floor(real(j)-c(i,j))
      adq(i,jt) = adq(i,jt)+adfy(i,j)
      adfy(i,j) = 0.
    end do
  end do
else if (abs(jord) .eq. 2) then
  call ymist( q,dm,ng,jord,ifirst,ilast,jfirst,jlast )
  do j = jfirst, jlast+1
    do i = ifirst, ilast
      jt = floor(real(j)-c(i,j))
      adc(i,j) = adc(i,j)-adfy(i,j)*dm(i,jt)
      addm(i,jt) = addm(i,jt)+adfy(i,j)*(sign(1.,c(i,j))-c(i,j))
      adq(i,jt) = adq(i,jt)+adfy(i,j)
      adfy(i,j) = 0.
    end do
  end do
  call adymist( q,adq,dm,addm,ng,jord,ifirst,ilast,jfirst,jlast )
else
  call adfyppm( c,adc,q,adq,adfy,jord,ifirst,ilast,jfirst,jlast,npx,npy,uniform_ppm,dm,addm )
endif

end subroutine adytp


end module     adtpcore


